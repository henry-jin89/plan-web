<!DOCTYPE html>

<html lang="zh-CN">



<head>

    <meta charset="UTF-8">

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="config.js"></script>

    <title>月度日程 - 智能计划管理系统</title>

    <link rel="stylesheet" href="style.css">

    <style>

        .calendar-container {

            background: rgba(255, 255, 255, 0.9);

            border-radius: 16px;

            padding: 20px;

            margin-bottom: 24px;

            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);

        }



        .calendar-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            margin-bottom: 20px;

        }



        .calendar-nav {

            display: flex;

            align-items: center;

            gap: 12px;

        }



        .calendar-nav button {

            padding: 8px 12px;

            border: 1px solid #ddd;

            background: white;

            border-radius: 6px;

            cursor: pointer;

            transition: all 0.3s ease;

        }



        .calendar-nav button:hover {

            background: var(--theme-color-light);

            border-color: var(--theme-color);

        }



        .calendar-month-year {

            font-size: 1.5em;

            font-weight: 600;

            color: var(--theme-color);

        }



        .calendar-grid {

            display: grid;

            grid-template-columns: repeat(7, 1fr);

            gap: 1px;

            background: #e0e0e0;

            border-radius: 8px;

            overflow: hidden;

        }



        .calendar-weekday {

            background: var(--theme-color);

            color: white;

            padding: 12px;

            text-align: center;

            font-weight: 600;

            font-size: 0.9em;

        }



        .calendar-day {

            background: white;

            min-height: 90px;

            padding: 8px;

            cursor: pointer;

            transition: all 0.3s ease;

            position: relative;

            display: flex;

            flex-direction: column;

            border: 1px solid rgba(0,0,0,0.05);

        }



        .calendar-day:hover {

            background: rgba(25, 118, 210, 0.05);

        }



        .calendar-day.other-month {

            background: #f5f5f5;

            color: #999;

        }



        .calendar-day.today {

            background: var(--theme-color-light);

            border: 2px solid var(--theme-color);

        }



        .calendar-day.has-events {

            background: rgba(76, 175, 80, 0.1);

        }



        .day-number {

            font-weight: 600;

            margin-bottom: 6px;

            font-size: 1em;

            color: #333;

        }



        .day-events {

            flex: 1;

            display: flex;

            flex-direction: column;

            gap: 1px;

            overflow: hidden;

        }



        .event-dot {

            width: 6px;

            height: 6px;

            border-radius: 50%;

            background: var(--theme-color);

        }



        .event-preview {

            font-size: 0.75em;

            padding: 2px 6px;

            background: rgba(25, 118, 210, 0.1);

            border-radius: 4px;

            color: var(--theme-color);

            overflow: hidden;

            text-overflow: ellipsis;

            white-space: nowrap;

            margin-bottom: 2px;

            font-weight: 500;

            line-height: 1.2;

            max-width: 100%;

        }



        .schedule-panel {

            display: grid;

            grid-template-columns: 300px 1fr;

            gap: 20px;

            margin-bottom: 24px;

        }



        .schedule-sidebar {

            background: rgba(255, 255, 255, 0.9);

            border-radius: 12px;

            padding: 16px;

            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

        }



        .schedule-main {

            background: rgba(255, 255, 255, 0.9);

            border-radius: 12px;

            padding: 20px;

            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

        }



        .event-form {

            display: flex;

            flex-direction: column;

            gap: 12px;

        }



        .event-form input,

        .event-form textarea,

        .event-form select {

            width: 100%;

            padding: 8px;

            border: 1px solid #ddd;

            border-radius: 6px;

            box-sizing: border-box;

        }



        .event-list {

            max-height: 400px;

            overflow-y: auto;

        }



        .event-item {

            display: flex;

            align-items: center;

            gap: 8px;

            padding: 8px;

            background: rgba(255, 255, 255, 0.8);

            border-radius: 6px;

            margin-bottom: 6px;

            border-left: 3px solid var(--theme-color);

            transition: all 0.3s ease;

        }



        .event-item:hover {

            background: rgba(25, 118, 210, 0.1);

            transform: translateX(4px);

        }



        .event-time {

            font-size: 0.8em;

            color: var(--theme-color);

            font-weight: 600;

            min-width: 40px;

        }



        .event-title {

            flex: 1;

            font-size: 0.9em;

            color: #333;

        }



        .event-delete {

            background: none;

            border: none;

            color: #f44336;

            cursor: pointer;

            padding: 2px;

            border-radius: 3px;

            transition: all 0.3s ease;

            opacity: 0.6;

        }



        .event-delete:hover {

            background: #ffebee;

            opacity: 1;

        }



        /* 选中状态样式 */

        .calendar-day.selected {

            background: rgba(25, 118, 210, 0.1);

            border: 2px solid var(--theme-color) !important;

            transform: scale(1.02);

        }

        

        /* 改善今天的显示 */

        .calendar-day.today {

            background: linear-gradient(135deg, var(--theme-color-light), rgba(25, 118, 210, 0.1));

            border: 2px solid var(--theme-color);

            font-weight: 600;

        }

        

        /* 改善事件预览的样式 */

        .calendar-day.has-events {

            background: rgba(76, 175, 80, 0.05);

            border-left: 3px solid #4caf50;

        }

        

        /* 悬停效果增强 */

        .calendar-day:hover {

            background: rgba(25, 118, 210, 0.08);

            transform: translateY(-1px);

            box-shadow: 0 2px 8px rgba(0,0,0,0.1);

        }

        

        /* 改善字体显示 */

        body {

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;

            -webkit-font-smoothing: antialiased;

            -moz-osx-font-smoothing: grayscale;

        }

        

        @media (max-width: 768px) {

            .schedule-panel {

                grid-template-columns: 1fr;

            }

            

            .calendar-day {

                min-height: 70px;

                padding: 6px;

            }

            

            .calendar-weekday {

                padding: 10px 8px;

                font-size: 0.85em;

            }

            

            .event-preview {

                font-size: 0.7em;

                padding: 1px 4px;

            }

            

            .page-header {

                flex-direction: column;

                gap: 12px;

                text-align: center;

            }

            

            .calendar-header {

                flex-direction: column;

                gap: 12px;

                text-align: center;

            }

            

            .calendar-header > div {

                flex-wrap: wrap;

                justify-content: center;

            }

            

            .calendar-header button {

                font-size: 0.8em;

                padding: 6px 10px;

            }

        }

        

        /* 列表视图样式 */

        .list-view-modal {

            position: fixed;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background: rgba(0, 0, 0, 0.5);

            display: flex;

            justify-content: center;

            align-items: center;

            z-index: 1000;

        }

        

        .list-view-content {

            background: white;

            border-radius: 12px;

            width: 90%;

            max-width: 800px;

            max-height: 80vh;

            display: flex;

            flex-direction: column;

            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);

        }

        

        .list-view-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 20px;

            border-bottom: 1px solid #eee;

        }

        

        .list-view-header h3 {

            margin: 0;

            color: var(--theme-color);

        }

        

        .close-modal {

            background: none;

            border: none;

            font-size: 24px;

            cursor: pointer;

            color: #666;

            padding: 0;

            width: 32px;

            height: 32px;

            display: flex;

            align-items: center;

            justify-content: center;

            border-radius: 50%;

            transition: all 0.3s ease;

        }

        

        .close-modal:hover {

            background: #f5f5f5;

            color: #333;

        }

        

        .list-view-controls {

            display: flex;

            gap: 12px;

            padding: 16px 20px;

            border-bottom: 1px solid #eee;

            flex-wrap: wrap;

        }

        

        .list-view-controls select,

        .list-view-controls input {

            padding: 8px 12px;

            border: 1px solid #ddd;

            border-radius: 6px;

            font-size: 14px;

        }

        

        .list-view-controls input {

            flex: 1;

            min-width: 200px;

        }

        

        .list-view-body {

            flex: 1;

            overflow-y: auto;

            padding: 20px;

        }

        

        .no-events {

            text-align: center;

            padding: 40px;

            color: #666;

        }

        

        .list-date-header {

            font-weight: 600;

            color: var(--theme-color);

            margin: 20px 0 10px 0;

            padding-bottom: 8px;

            border-bottom: 2px solid var(--theme-color-light);

            font-size: 1.1em;

        }

        

        .list-date-header:first-child {

            margin-top: 0;

        }

        

        .list-event-item {

            display: flex;

            align-items: flex-start;

            gap: 16px;

            padding: 12px;

            background: rgba(255, 255, 255, 0.8);

            border-radius: 8px;

            margin-bottom: 8px;

            border-left: 3px solid var(--theme-color);

            transition: all 0.3s ease;

        }

        

        .list-event-item:hover {

            background: rgba(25, 118, 210, 0.05);

            transform: translateX(4px);

        }

        

        .list-event-time {

            font-weight: 600;

            color: var(--theme-color);

            min-width: 60px;

            font-size: 0.9em;

        }

        

        .list-event-content {

            flex: 1;

        }

        

        .list-event-title {

            font-weight: 600;

            color: #333;

            margin-bottom: 4px;

        }

        

        .list-event-category {

            font-size: 0.8em;

            color: #666;

            margin-bottom: 4px;

        }

        

        .list-event-description {

            font-size: 0.85em;

            color: #888;

            line-height: 1.4;

        }

        

        .list-event-actions {

            display: flex;

            gap: 8px;

        }

        

        .list-event-actions button {

            background: none;

            border: none;

            cursor: pointer;

            padding: 4px;

            border-radius: 4px;

            transition: all 0.3s ease;

            font-size: 16px;

        }

        

        .list-event-actions button:hover {

            background: rgba(0, 0, 0, 0.1);

        }

        

        @media (max-width: 768px) {

            .list-view-content {

                width: 95%;

                max-height: 90vh;

            }

            

            .list-view-controls {

                flex-direction: column;

            }

            

            .list-view-controls input {

                min-width: auto;

            }

            

            .list-event-item {

                flex-direction: column;

                gap: 8px;

            }

            

            .list-event-time {

                min-width: auto;

            }

        }



        /* 备份管理器样式 */

        .backup-manager-modal {

            position: fixed;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background: rgba(0, 0, 0, 0.5);

            display: flex;

            justify-content: center;

            align-items: center;

            z-index: 1000;

        }



        .backup-manager-content {

            background: white;

            border-radius: 12px;

            width: 90%;

            max-width: 700px;

            max-height: 80vh;

            display: flex;

            flex-direction: column;

            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);

        }



        .backup-manager-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 20px;

            border-bottom: 1px solid #eee;

        }



        .backup-manager-body {

            flex: 1;

            overflow-y: auto;

            padding: 20px;

        }



        .backup-info {

            margin-bottom: 20px;

        }



        .protection-status {

            background: rgba(76, 175, 80, 0.1);

            border-radius: 8px;

            padding: 16px;

            margin-top: 12px;

        }



        .status-item {

            display: flex;

            align-items: center;

            gap: 12px;

            margin-bottom: 8px;

        }



        .status-item:last-child {

            margin-bottom: 0;

        }



        .status-icon {

            font-size: 16px;

            width: 24px;

        }



        .status-ok {

            color: #4caf50;

            font-weight: 600;

            margin-left: auto;

        }



        .backup-actions {

            display: flex;

            gap: 12px;

            margin-bottom: 24px;

            flex-wrap: wrap;

        }



        .backup-list h4 {

            margin: 0 0 16px 0;

            color: var(--theme-color);

        }



        .backup-item {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 12px;

            background: rgba(255, 255, 255, 0.8);

            border-radius: 8px;

            margin-bottom: 8px;

            border-left: 3px solid var(--theme-color);

            transition: all 0.3s ease;

        }



        .backup-item:hover {

            background: rgba(25, 118, 210, 0.05);

            transform: translateX(4px);

        }



        .backup-info-item {

            flex: 1;

        }



        .backup-time {

            font-weight: 600;

            color: #333;

            margin-bottom: 4px;

        }



        .backup-details {

            font-size: 0.85em;

            color: #666;

        }



        .backup-actions-item {

            display: flex;

            gap: 8px;

        }



        .btn-small {

            padding: 4px 8px;

            font-size: 0.8em;

            border: 1px solid #ddd;

            background: white;

            border-radius: 4px;

            cursor: pointer;

            transition: all 0.3s ease;

        }



        .btn-small:hover {

            background: var(--theme-color-light);

            border-color: var(--theme-color);

        }



        .btn-small.btn-danger {

            color: #f44336;

            border-color: #f44336;

        }



        .btn-small.btn-danger:hover {

            background: #ffebee;

            border-color: #f44336;

        }



        .no-backups {

            text-align: center;

            padding: 40px;

            color: #666;

            font-style: italic;

        }



        @media (max-width: 768px) {

            .backup-manager-content {

                width: 95%;

                max-height: 90vh;

            }



            .backup-actions {

                flex-direction: column;

            }



            .backup-item {

                flex-direction: column;

                align-items: flex-start;

                gap: 12px;

            }



            .backup-actions-item {

                align-self: stretch;

                justify-content: space-around;

            }

        }



        /* 数据恢复帮助界面样式 */

        .recovery-help-modal {

            position: fixed;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background: rgba(0, 0, 0, 0.6);

            display: flex;

            justify-content: center;

            align-items: center;

            z-index: 1001;

        }



        .recovery-help-content {

            background: white;

            border-radius: 12px;

            width: 90%;

            max-width: 600px;

            max-height: 80vh;

            display: flex;

            flex-direction: column;

            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);

        }



        .recovery-help-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 20px;

            border-bottom: 1px solid #eee;

            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);

            color: white;

            border-radius: 12px 12px 0 0;

        }



        .recovery-help-header h3 {

            margin: 0;

        }



        .recovery-help-body {

            padding: 24px;

            overflow-y: auto;

        }



        .recovery-options {

            display: flex;

            flex-direction: column;

            gap: 16px;

            margin-top: 16px;

        }



        .recovery-option {

            display: flex;

            align-items: center;

            gap: 16px;

            padding: 16px;

            background: rgba(76, 175, 80, 0.05);

            border-radius: 8px;

            border-left: 4px solid #4caf50;

            transition: all 0.3s ease;

        }



        .recovery-option:hover {

            background: rgba(76, 175, 80, 0.1);

            transform: translateX(4px);

        }



        .recovery-icon {

            font-size: 24px;

            min-width: 40px;

            text-align: center;

        }



        .recovery-text {

            flex: 1;

        }



        .recovery-text h4 {

            margin: 0 0 8px 0;

            color: var(--theme-color);

            font-size: 1.1em;

        }



        .recovery-text p {

            margin: 0;

            color: #666;

            font-size: 0.9em;

            line-height: 1.4;

        }



        @media (max-width: 768px) {

            .recovery-help-content {

                width: 95%;

                max-height: 90vh;

            }



            .recovery-option {

                flex-direction: column;

                text-align: center;

                gap: 12px;

            }



            .recovery-icon {

                min-width: auto;

            }

        }



        /* 同步状态样式 */

        #sync-data-btn {

            transition: all 0.3s ease;

        }



        #sync-data-btn.sync-enabled {

            background-color: #4caf50 !important;

            color: white;

        }



        #sync-data-btn.sync-warning {

            background-color: #ff9800 !important;

            color: white;

        }

        

        /* 保存按钮闪烁动画 */

        @keyframes pulse {

            0% {

                transform: scale(1);

                opacity: 1;

            }

            50% {

                transform: scale(1.05);

                opacity: 0.8;

            }

            100% {

                transform: scale(1);

                opacity: 1;

            }

        }

        

        /* 保存按钮特殊样式 */

        #force-save-btn {

            transition: all 0.3s ease;

            font-weight: 600;

        }

        

        #force-save-btn:hover {

            background: #45a049 !important;

            transform: translateY(-1px);

            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);

        }

    </style>

</head>



<body>

    <div class="container">

        <!-- 页面头部 -->

        <div class="page-header">

            <a href="index.html" class="back-to-home">← 返回主页</a>

            <h1 class="page-title">📅 月度日程管理</h1>

            <div style="display: flex; gap: 8px;">

                <a href="month_plan.html" class="btn-main" style="font-size: 0.9em;">月计划</a>

                <button type="button" id="today-btn" class="btn-main">📍 今天</button>

            </div>

        </div>



        <!-- 日历视图 -->

        <div class="calendar-container">

            <div class="calendar-header">

                <div class="calendar-nav">

                    <button type="button" id="prev-month">← 上月</button>

                    <button type="button" id="today-nav">今天</button>

                    <button type="button" id="next-month">下月 →</button>

                </div>

                <div class="calendar-month-year" id="calendar-title">2024年1月</div>

                <div style="display: flex; gap: 8px;">

                    <button type="button" id="calendar-view-btn" class="btn-main">📋 列表视图</button>

                    <button type="button" id="one-click-fix-btn" class="btn-main" style="background: #ff9800; color: white;">🔧 一键修复</button>

                    <button type="button" id="sync-settings-btn" class="btn-main">⚙️ 同步设置</button>

                    <button type="button" id="force-save-btn" class="btn-main" style="background: #4caf50; color: white;">💾 保存</button>
                    <button type="button" id="reset-help-btn" class="btn-main" style="background: #2196f3; color: white; display: none;">🔄 重置助手</button>

                </div>

            </div>



            <div class="calendar-grid" id="calendar-grid">

                <!-- 星期标题 -->

                <div class="calendar-weekday">日</div>

                <div class="calendar-weekday">一</div>

                <div class="calendar-weekday">二</div>

                <div class="calendar-weekday">三</div>

                <div class="calendar-weekday">四</div>

                <div class="calendar-weekday">五</div>

                <div class="calendar-weekday">六</div>

                <!-- 日期格子将动态生成 -->

            </div>

        </div>



        <!-- 日程管理面板 -->

        <div class="schedule-panel">

            <!-- 侧边栏 -->

            <div class="schedule-sidebar">

                <h3 style="margin: 0 0 16px 0; color: var(--theme-color);">➕ 添加日程</h3>

                

                <div class="event-form">

                    <input type="text" id="event-title" placeholder="日程标题">

                    <input type="date" id="event-date">

                    <input type="time" id="event-time">

                    <select id="event-category">

                        <option value="work">💼 工作</option>

                        <option value="personal">👤 个人</option>

                        <option value="health">🏃 健康</option>

                        <option value="learning">📚 学习</option>

                        <option value="social">👥 社交</option>

                        <option value="other">📋 其他</option>

                    </select>

                    <textarea id="event-description" placeholder="备注说明..." rows="3"></textarea>

                    <button type="button" id="add-event-btn" class="btn-main" style="width: 100%;">添加日程</button>

                </div>



                <div style="margin-top: 24px;">

                    <h4 style="margin: 0 0 12px 0; color: var(--theme-color);">📊 统计信息</h4>

                    <div style="background: rgba(25,118,210,0.05); padding: 12px; border-radius: 8px;">

                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">

                            <span>本月日程:</span>

                            <span id="month-events-count" style="font-weight: 600; color: var(--theme-color);">0</span>

                        </div>

                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">

                            <span>今日日程:</span>

                            <span id="today-events-count" style="font-weight: 600; color: #4caf50;">0</span>

                        </div>

                        <div style="display: flex; justify-content: space-between;">

                            <span>本周日程:</span>

                            <span id="week-events-count" style="font-weight: 600; color: #ff9800;">0</span>

                        </div>

                    </div>

                </div>

            </div>



            <!-- 主内容区 -->

            <div class="schedule-main">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">

                    <h3 style="margin: 0; color: var(--theme-color);" id="selected-date-title">选择日期查看日程</h3>

                    <div style="display: flex; gap: 8px;">

                        <button type="button" id="clear-day-btn" class="btn-danger" style="display: none;">清空当日</button>

                        <button type="button" id="copy-day-btn" class="btn-main" style="display: none;">复制日程</button>

                    </div>

                </div>



                <div id="selected-day-events" class="event-list">

                    <div style="text-align: center; padding: 40px; color: #666;">

                        <div style="font-size: 3em; margin-bottom: 16px;">📅</div>

                        <p>点击日历上的日期查看当天的日程安排</p>

                    </div>

                </div>

            </div>

        </div>



        <!-- 快捷操作 -->

        <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; margin-bottom: 24px;">

            <h4 style="margin: 0 0 12px 0; color: var(--theme-color);">⚡ 快捷操作</h4>

            <div style="display: flex; gap: 8px; flex-wrap: wrap;">

                <button type="button" class="quick-add-btn" data-title="团队会议" data-time="10:00">🤝 团队会议</button>

                <button type="button" class="quick-add-btn" data-title="午餐时间" data-time="12:00">🍽️ 午餐时间</button>

                <button type="button" class="quick-add-btn" data-title="健身锻炼" data-time="18:00">💪 健身锻炼</button>

                <button type="button" class="quick-add-btn" data-title="学习时间" data-time="20:00">📚 学习时间</button>

                <button type="button" class="quick-add-btn" data-title="家庭时间" data-time="19:00">👨‍👩‍👧‍👦 家庭时间</button>

            </div>

        </div>

    </div>

    




    <script src="common.js"></script>

    <script>

        // 月度日程管理

        let currentCalendarMonth = new Date();

        let selectedDate = null;

        let monthlyEvents = loadAndCleanData();

        // 安全的数据加载函数
        function loadAndCleanData() {
            try {
                const rawData = localStorage.getItem('monthlyEvents');
                if (!rawData) {
                    console.log('🔄 没有找到本地数据，初始化为空对象');
                    return {};
                }
                
                // 尝试解析JSON
                let parsedData;
                try {
                    parsedData = JSON.parse(rawData);
                } catch (parseError) {
                    console.error('❌ JSON解析失败，尝试修复:', parseError);
                    // 尝试修复常见的JSON问题
                    const fixedJson = rawData.replace(/[\x00-\x1F\x7F-\x9F]/g, '')
                                           .replace(/\uFEFF/g, '')
                                           .replace(/Â+/g, '');
                    try {
                        parsedData = JSON.parse(fixedJson);
                        console.log('✅ JSON修复成功');
                    } catch (fixError) {
                        console.error('❌ JSON修复失败，使用空对象:', fixError);
                        return {};
                    }
                }
                
                // 清理和验证数据
                const cleanedData = cleanupEventData(parsedData || {});
                console.log('✅ 数据加载和清理完成');
                return cleanedData;
                
            } catch (error) {
                console.error('❌ 数据加载失败:', error);
                return {};
            }
        }

        // 数据清理和验证函数 - 增强版本
        function sanitizeText(text) {
            if (typeof text !== 'string') {
                return String(text || '');
            }
            
            // 处理各种编码问题
            let cleaned = text;
            
            // 第一轮：处理常见的UTF-8编码问题
            cleaned = cleaned.replace(/Â+/g, '') // 移除多余的Â字符
                           .replace(/Ã¢â‚¬â„¢/g, "'") // 修复智能引号
                           .replace(/Ã¢â‚¬Â/g, '–') // 修复破折号
                           .replace(/Ã¢â‚¬Å"/g, '"') // 修复左双引号
                           .replace(/Ã¢â‚¬Â/g, '"') // 修复右双引号
                           .replace(/Ã¢â‚¬â€œ/g, '—') // 修复长破折号
                           .replace(/[\u00C2\u00A0]/g, ' ') // 替换不间断空格
                           .replace(/[\x00-\x1F\x7F-\x9F]/g, '') // 移除控制字符
                           .replace(/\uFEFF/g, '') // 移除BOM
                           .replace(/\u200B/g, '') // 移除零宽空格
                           .replace(/\u00A0/g, ' ') // 替换不间断空格为普通空格
                           .replace(/\u2028/g, '') // 移除行分隔符
                           .replace(/\u2029/g, ''); // 移除段落分隔符
            
            // 第二轮：处理可能的双重编码问题
            try {
                // 尝试解码可能的双重编码
                if (cleaned.includes('Â') || cleaned.includes('\u00C2')) {
                    // 将字符串转换为字节数组，然后重新解码
                    const bytes = [];
                    for (let i = 0; i < cleaned.length; i++) {
                        const code = cleaned.charCodeAt(i);
                        if (code <= 0xFF) {
                            bytes.push(code);
                        } else {
                            // 对于非ASCII字符，保持原样
                            bytes.push(code);
                        }
                    }
                    
                    // 重新构建字符串，跳过问题字符
                    let rebuilt = '';
                    for (let i = 0; i < bytes.length; i++) {
                        const byte = bytes[i];
                        if (byte === 0xC2 && i + 1 < bytes.length && bytes[i + 1] >= 0x80 && bytes[i + 1] <= 0xBF) {
                            // 跳过UTF-8的Â字符序列
                            i++; // 跳过下一个字节
                            continue;
                        } else if (byte >= 32 && byte <= 126) {
                            // 只保留可打印的ASCII字符
                            rebuilt += String.fromCharCode(byte);
                        } else if (byte > 127) {
                            // 保留非ASCII字符（可能是正常的中文等）
                            rebuilt += String.fromCharCode(byte);
                        }
                    }
                    cleaned = rebuilt;
                }
            } catch (error) {
                console.warn('字符解码失败，使用基础清理:', error);
            }
            
            // 第三轮：最终清理
            cleaned = cleaned.replace(/\s+/g, ' ') // 合并多个空格
                           .trim();
            
            // 如果清理后为空或只有特殊字符，返回空字符串
            if (!cleaned || /^[\s\u00A0\u200B\uFEFF\u2028\u2029]*$/.test(cleaned)) {
                return '';
            }
            
            return cleaned;
        }

        function cleanupEventData(events) {
            const cleaned = {};
            
            if (!events || typeof events !== 'object') {
                console.warn('⚠️ 无效的事件数据格式，返回空对象');
                return {};
            }
            
            for (const [date, eventList] of Object.entries(events)) {
                // 验证日期格式
                if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                    console.warn('⚠️ 跳过无效日期格式:', date);
                    continue;
                }
                
                if (!Array.isArray(eventList)) {
                    console.warn('⚠️ 跳过非数组事件列表:', date);
                    continue;
                }
                
                const validEvents = eventList.filter(event => {
                    if (!event || typeof event !== 'object') {
                        console.warn('⚠️ 跳过无效事件对象:', event);
                        return false;
                    }
                    
                    const hasTitle = event.title && typeof event.title === 'string';
                    const hasTime = event.time && typeof event.time === 'string';
                    
                    if (!hasTitle || !hasTime) {
                        console.warn('⚠️ 跳过缺少必需字段的事件:', event);
                        return false;
                    }
                    
                    return true;
                }).map(event => {
                    const cleanedTitle = sanitizeText(event.title);
                    const cleanedTime = sanitizeText(event.time);
                    
                    // 如果清理后的标题或时间为空，跳过此事件
                    if (!cleanedTitle || !cleanedTime) {
                        console.warn('⚠️ 清理后标题或时间为空，跳过事件');
                        return null;
                    }
                    
                    return {
                        title: cleanedTitle,
                        time: cleanedTime,
                        category: sanitizeText(event.category || 'other') || 'other',
                        description: sanitizeText(event.description || ''),
                        createdAt: event.createdAt || new Date().toISOString()
                    };
                }).filter(event => event !== null); // 移除null值
                
                if (validEvents.length > 0) {
                    cleaned[date] = validEvents;
                }
            }
            
            console.log(`✅ 数据清理完成，有效日期: ${Object.keys(cleaned).length}`);
            return cleaned;
        }

        function validateAndCleanData() {
            try {
                monthlyEvents = cleanupEventData(monthlyEvents);
                localStorage.setItem('monthlyEvents', JSON.stringify(monthlyEvents));
                console.log('✅ 数据已清理和验证');
            } catch (error) {
                console.error('❌ 数据清理失败:', error);
                // 如果数据严重损坏，尝试恢复备份
                initDataRecovery();
            }
        }



        document.addEventListener('DOMContentLoaded', function() {

            // 立即强制清理所有损坏数据

            emergencyDataCleanup();

            // 执行专门的15号等损坏数据清理
            setTimeout(() => {
                if (typeof forceCleanSpecificDates === 'function') {
                    forceCleanSpecificDates();
                }
            }, 500);

            initMonthlySchedule();

        });

        

        // 紧急数据清理 - 页面加载时立即执行

        function emergencyDataCleanup() {

            try {

                console.log('🚨 执行紧急数据清理...');

                

                const rawData = localStorage.getItem('monthlyEvents');

                if (!rawData) {

                    console.log('💡 没有数据需要清理');

                    return;

                }

                

                // 检查是否包含任何编码问题

                const hasEncodingIssues = rawData.includes('Â') || 

                                        rawData.includes('\u00C2') ||

                                        rawData.includes('Ã¢') ||

                                        rawData.includes('â€') ||

                                        rawData.includes('â„¢') ||

                                        rawData.includes('Å"');

                

                if (hasEncodingIssues) {

                    console.log('🚨 检测到严重编码问题，执行强制清理...');

                    

                    // 暴力清理所有可能的编码问题

                    let cleanedJson = rawData

                        // 移除所有Â相关字符

                        .replace(/Â+/g, '')

                        .replace(/[\u00C2]/g, '')

                        

                        // 移除复杂的UTF-8编码错误

                        .replace(/Ã¢â‚¬â„¢/g, "'")

                        .replace(/Ã¢â‚¬Â/g, '–')

                        .replace(/Ã¢â‚¬Å"/g, '"')

                        .replace(/Ã¢â‚¬â€œ/g, '—')

                        .replace(/Ã¢â‚¬/g, '')

                        .replace(/â€™/g, "'")

                        .replace(/â€œ/g, '"')

                        .replace(/â€/g, '"')

                        .replace(/â„¢/g, '')

                        .replace(/Å"/g, '"')

                        .replace(/Â®/g, '')

                        

                        // 移除所有控制字符和特殊字符

                        .replace(/[\x00-\x1F\x7F-\x9F]/g, '')

                        .replace(/\uFEFF/g, '')

                        .replace(/\u200B/g, '')

                        .replace(/\u00A0/g, ' ')

                        .replace(/\u2028/g, '')

                        .replace(/\u2029/g, '')

                        

                        // 清理可能的双字节问题

                        .replace(/[\u0080-\u009F]/g, '')

                        .replace(/[\u00A0-\u00FF]/g, function(match) {

                            // 只保留常见的有用字符

                            const code = match.charCodeAt(0);

                            if (code === 0x00A0) return ' '; // 不间断空格转为普通空格

                            if (code >= 0x00C0 && code <= 0x00FF) return ''; // 移除扩展拉丁字符

                            return match;

                        });

                    

                    try {

                        // 尝试解析清理后的JSON

                        const parsedData = JSON.parse(cleanedJson);

                        

                        // 深度清理解析后的数据

                        const deepCleanedData = {};

                        

                        for (const [date, events] of Object.entries(parsedData)) {

                            if (Array.isArray(events)) {

                                const cleanedEvents = events.map(event => {

                                    if (event && typeof event === 'object') {

                                        return {

                                            title: deepCleanText(event.title || ''),

                                            time: deepCleanText(event.time || ''),

                                            category: deepCleanText(event.category || 'other'),

                                            description: deepCleanText(event.description || ''),

                                            createdAt: event.createdAt || new Date().toISOString()

                                        };

                                    }

                                    return null;

                                }).filter(event => event && event.title && event.time);

                                

                                if (cleanedEvents.length > 0) {

                                    deepCleanedData[date] = cleanedEvents;

                                }

                            }

                        }

                        

                        // 保存清理后的数据

                        const finalJson = JSON.stringify(deepCleanedData);

                        localStorage.setItem('monthlyEvents', finalJson);

                        

                        // 更新内存中的数据

                        monthlyEvents = deepCleanedData;

                        

                        console.log('✅ 紧急数据清理完成，清理了编码问题');

                        

                        // 显示清理结果

                        const eventCount = Object.values(deepCleanedData).reduce((total, events) => total + events.length, 0);

                        console.log(`📊 清理结果: ${Object.keys(deepCleanedData).length} 天，${eventCount} 个事件`);

                        

                    } catch (parseError) {

                        console.error('❌ 清理后仍无法解析JSON，重置数据:', parseError);

                        localStorage.removeItem('monthlyEvents');

                        monthlyEvents = {};

                        

                        alert('检测到严重的数据损坏，已重置为空数据。请重新添加您的日程。');

                    }

                } else {

                    console.log('✅ 数据检查通过，无需紧急清理');

                }

            } catch (error) {

                console.error('❌ 紧急数据清理失败:', error);

            }

        }

        

        // 深度文本清理函数

        function deepCleanText(text) {

            if (typeof text !== 'string') {

                return String(text || '');

            }

            

            let cleaned = text;

            

            // 暴力清理所有可能的编码问题

            cleaned = cleaned

                .replace(/Â+/g, '')

                .replace(/[\u00C2]/g, '')

                .replace(/Ã¢â‚¬â„¢/g, "'")

                .replace(/Ã¢â‚¬Â/g, '–')

                .replace(/Ã¢â‚¬Å"/g, '"')

                .replace(/Ã¢â‚¬â€œ/g, '—')

                .replace(/Ã¢â‚¬/g, '')

                .replace(/â€™/g, "'")

                .replace(/â€œ/g, '"')

                .replace(/â€/g, '"')

                .replace(/â„¢/g, '')

                .replace(/Å"/g, '"')

                .replace(/Â®/g, '')

                .replace(/[\x00-\x1F\x7F-\x9F]/g, '')

                .replace(/\uFEFF/g, '')

                .replace(/\u200B/g, '')

                .replace(/\u00A0/g, ' ')

                .replace(/\u2028/g, '')

                .replace(/\u2029/g, '')

                .replace(/[\u0080-\u009F]/g, '')

                .replace(/\s+/g, ' ')

                .trim();

            

            // 如果清理后为空或只有特殊字符，返回空字符串

            if (!cleaned || /^[\s\u00A0\u200B\uFEFF\u2028\u2029]*$/.test(cleaned)) {

                return '';

            }

            

            return cleaned;

        }

        

        // 监听页面可见性变化，重新加载数据

        document.addEventListener('visibilitychange', function() {

            if (!document.hidden) {

                console.log('🔄 页面重新可见，检查数据一致性');

                reloadAndValidateData();

            }

        });

        

        // 监听窗口焦点变化

        window.addEventListener('focus', function() {

            console.log('🔄 窗口获得焦点，检查数据一致性');

            reloadAndValidateData();

        });

        

        // 立即修复现有损坏数据

        function repairCorruptedData() {

            try {

                console.log('🔧 开始修复损坏的数据...');

                

                const rawData = localStorage.getItem('monthlyEvents');

                if (!rawData) {

                    console.log('💡 没有数据需要修复');

                    return;

                }

                

                // 检查是否包含损坏的字符

                if (rawData.includes('Â') || rawData.includes('\u00C2')) {

                    console.log('🚨 检测到损坏的数据，开始修复...');

                    

                    // 深度清理JSON字符串

                    let cleanedJson = rawData;

                    

                    // 修复常见的编码问题

                    cleanedJson = cleanedJson.replace(/Â+/g, '') // 移除Â字符

                                           .replace(/[\u00C2]/g, '') // 移除C2字符

                                           .replace(/[\x00-\x1F\x7F-\x9F]/g, '') // 移除控制字符

                                           .replace(/\uFEFF/g, '') // 移除BOM

                                           .replace(/\u200B/g, '') // 移除零宽空格

                                           .replace(/\u00A0/g, ' ') // 替换不间断空格

                                           .replace(/\u2028/g, '') // 移除行分隔符

                                           .replace(/\u2029/g, ''); // 移除段落分隔符

                    

                    // 尝试解析修复后的JSON

                    try {

                        const parsedData = JSON.parse(cleanedJson);

                        const repairedData = cleanupEventData(parsedData);

                        

                        // 保存修复后的数据

                        const repairedJson = JSON.stringify(repairedData);

                        localStorage.setItem('monthlyEvents', repairedJson);

                        

                        // 更新内存中的数据

                        monthlyEvents = repairedData;

                        

                        console.log('✅ 数据修复成功');

                        MessageUtils.success('检测到数据问题已自动修复');

                        

                        return true;

                    } catch (parseError) {

                        console.error('❌ 修复后的JSON仍然无效:', parseError);

                        

                        // 如果修复失败，清空数据

                        localStorage.removeItem('monthlyEvents');

                        monthlyEvents = {};

                        

                        MessageUtils.warning('数据损坏严重，已重置为空');

                        return false;

                    }

                } else {

                    console.log('✅ 数据完整，无需修复');

                    return true;

                }

            } catch (error) {

                console.error('❌ 数据修复过程出错:', error);

                return false;

            }

        }

        

        // 强制修复数据（用户手动触发）

        function forceRepairData() {

            if (confirm('这将强制修复所有数据问题，可能会丢失部分损坏的数据。\n\n是否继续？')) {

                try {

                    console.log('🔧 用户触发强制数据修复...');

                    

                    // 1. 执行紧急数据清理

                    emergencyDataCleanup();

                    

                    // 2. 修复localStorage中的数据

                    const repaired = repairCorruptedData();

                    

                    // 3. 强制重新加载数据

                    monthlyEvents = loadAndCleanData();

                    

                    // 4. 强制保存清理后的数据

                    saveEvents();

                    

                    // 5. 重新渲染所有视图

                    renderCalendar();

                    updateEventStats();

                    

                    // 6. 如果有选中的日期，更新显示

                    if (selectedDate) {

                        displaySelectedDayEvents(selectedDate);

                    }

                    

                    // 7. 清理所有可能的缓存和备份

                    try {

                        sessionStorage.clear(); // 清理所有sessionStorage

                        

                        // 清理所有可能损坏的localStorage项

                        const keysToCheck = [

                            'monthlyEventsTemp', 

                            'monthlyEventsBackup',

                            'backup_main', 

                            'backup_secondary', 

                            'backup_tertiary',

                            'monthlyBackups'

                        ];

                        

                        keysToCheck.forEach(key => {

                            const data = localStorage.getItem(key);

                            if (data && (data.includes('Â') || data.includes('\u00C2') || data.includes('Ã¢'))) {

                                localStorage.removeItem(key);

                                console.log(`🗑️ 清理损坏的数据: ${key}`);

                            }

                        });

                        

                        // 清理IndexedDB

                        if ('indexedDB' in window) {

                            try {

                                const deleteReq = indexedDB.deleteDatabase('PlanManagerDB');

                                deleteReq.onsuccess = () => console.log('🗑️ IndexedDB已清理');

                                deleteReq.onerror = () => console.warn('⚠️ IndexedDB清理失败');

                            } catch (idbError) {

                                console.warn('⚠️ IndexedDB清理出错:', idbError);

                            }

                        }

                        

                        // 清理Cache API

                        if ('caches' in window) {

                            caches.delete('schedule-backup-v1').catch(error => {

                                console.warn('⚠️ Cache清理失败:', error);

                            });

                        }

                        

                    } catch (cleanError) {

                        console.warn('清理缓存时出错:', cleanError);

                    }

                    

                    // 8. 强制重新渲染（确保清理生效）

                    setTimeout(() => {

                        renderCalendar();

                        updateEventStats();

                        if (selectedDate) {

                            displaySelectedDayEvents(selectedDate);

                        }

                    }, 100);

                    

                    MessageUtils.success('数据修复完成！页面将自动刷新以确保修复生效。');

                    console.log('✅ 强制数据修复完成');

                    

                    // 延迟刷新页面确保修复生效

                    setTimeout(() => {

                        window.location.reload();

                    }, 2000);

                    

                } catch (error) {

                    console.error('❌ 强制修复失败:', error);

                    MessageUtils.error('修复失败，建议清空浏览器数据后重新开始');

                }

            }

        }

        

        // 重新加载和验证数据

        function reloadAndValidateData() {

            try {

                console.log('🔄 重新加载和验证数据...');

                

                // 首先尝试修复损坏的数据

                const repaired = repairCorruptedData();

                

                if (repaired) {

                    const currentDataString = JSON.stringify(monthlyEvents);

                    let newData = loadAndCleanData();

                    

                    // 应用本地删除记录

                    const deletedEvents = JSON.parse(localStorage.getItem('deletedEvents') || '[]');

                    if (deletedEvents.length > 0) {

                        console.log('🗑️ 重新应用删除记录...');

                        

                        for (const deletion of deletedEvents) {

                            const { date, event: deletedEvent } = deletion;

                            

                            if (newData[date]) {

                                newData[date] = newData[date].filter(event => {

                                    const isMatch = event.title === deletedEvent.title && 

                                                  event.time === deletedEvent.time;

                                    

                                    if (isMatch) {

                                        console.log(`🗑️ 重新删除恢复的事件: ${date} - ${event.title}`);

                                    }

                                    

                                    return !isMatch;

                                });

                                

                                // 如果该日期没有事件了，删除整个日期条目

                                if (newData[date].length === 0) {

                                    delete newData[date];

                                }

                            }

                        }

                    }

                    

                    const newDataString = JSON.stringify(newData);

                    

                    // 如果数据发生变化，重新渲染

                    if (currentDataString !== newDataString) {

                        console.log('📊 检测到数据变化，重新渲染视图');

                        monthlyEvents = newData;

                        

                        // 保存应用删除记录后的数据

                        saveEvents();

                        

                        renderCalendar();

                        updateEventStats();

                        

                        // 如果有选中的日期，更新显示

                        if (selectedDate) {

                            displaySelectedDayEvents(selectedDate);

                        }

                        

                        MessageUtils.info('数据已更新并应用删除记录');

                    } else {

                        console.log('✅ 数据一致，无需更新');

                    }

                }

            } catch (error) {

                console.error('❌ 数据重新加载失败:', error);

            }

        }



        function initMonthlySchedule() {

            // 设置今天为默认选择日期

            const today = DateUtils.getToday();

            document.getElementById('event-date').value = today;

            

            // 立即修复任何损坏的数据

            repairCorruptedData();

            

            // 验证和清理现有数据

            validateAndCleanData();

            

            // 渲染日历

            renderCalendar();

            updateEventStats();

            

            // 设置事件监听器

            setupEventListeners();

        }



        function setupEventListeners() {

            // 日历导航

            document.getElementById('prev-month').addEventListener('click', () => navigateMonth(-1));

            document.getElementById('next-month').addEventListener('click', () => navigateMonth(1));

            document.getElementById('today-nav').addEventListener('click', goToToday);

            document.getElementById('today-btn').addEventListener('click', goToToday);

            

            // 添加日程

            document.getElementById('add-event-btn').addEventListener('click', addEvent);

            

            // 快捷添加按钮

            document.querySelectorAll('.quick-add-btn').forEach(btn => {

                btn.addEventListener('click', function() {

                    const title = this.getAttribute('data-title');

                    const time = this.getAttribute('data-time');

                    quickAddEvent(title, time);

                });

            });

            

            // 其他功能按钮

            document.getElementById('calendar-view-btn')?.addEventListener('click', showListView);

            document.getElementById('one-click-fix-btn')?.addEventListener('click', oneClickFixAll);

            document.getElementById('sync-settings-btn')?.addEventListener('click', openSyncSettings);

            document.getElementById('force-save-btn')?.addEventListener('click', forceSaveData);

            document.getElementById('clear-day-btn')?.addEventListener('click', clearDayEvents);

            document.getElementById('copy-day-btn')?.addEventListener('click', copyDayEvents);
            document.getElementById('reset-help-btn')?.addEventListener('click', resetRecoveryHelp);

            


        }



        function renderCalendar() {

            const year = currentCalendarMonth.getFullYear();

            const month = currentCalendarMonth.getMonth();

            

            // 更新标题

            document.getElementById('calendar-title').textContent = `${year}年${month + 1}月`;

            

            // 清除现有日期格子（保留星期标题）

            const grid = document.getElementById('calendar-grid');

            const weekdays = grid.querySelectorAll('.calendar-weekday');

            grid.innerHTML = '';

            weekdays.forEach(day => grid.appendChild(day));

            

            // 获取月份第一天和最后一天

            const firstDay = new Date(year, month, 1);

            const lastDay = new Date(year, month + 1, 0);

            const startDate = new Date(firstDay);

            startDate.setDate(startDate.getDate() - firstDay.getDay());

            

            // 生成日历格子

            for (let i = 0; i < 42; i++) {

                const date = new Date(startDate);

                date.setDate(startDate.getDate() + i);

                

                const dayElement = createDayElement(date, month);

                grid.appendChild(dayElement);

            }

        }



        function createDayElement(date, currentMonth) {

            const dayElement = document.createElement('div');

            dayElement.className = 'calendar-day';

            

            const dateKey = DateUtils.formatDate(date);

            const isCurrentMonth = date.getMonth() === currentMonth;

            const isToday = dateKey === DateUtils.getToday();

            const dayEvents = monthlyEvents[dateKey] || [];

            

            // 设置样式

            if (!isCurrentMonth) {

                dayElement.classList.add('other-month');

            }

            if (isToday) {

                dayElement.classList.add('today');

            }

            if (dayEvents.length > 0) {

                dayElement.classList.add('has-events');

            }

            

            // 创建日期元素

            const dayNumber = document.createElement('div');

            dayNumber.className = 'day-number';

            dayNumber.textContent = date.getDate();

            dayElement.appendChild(dayNumber);

            

            // 创建事件预览

            const dayEventsContainer = document.createElement('div');

            dayEventsContainer.className = 'day-events';

            

            // 显示最多3个事件预览

            dayEvents.slice(0, 3).forEach(event => {

                const eventPreview = document.createElement('div');

                eventPreview.className = 'event-preview';

                // 确保数据安全性和正确显示，处理同步后的数据格式问题

                const timeText = sanitizeText(event.time || '');

                const titleText = sanitizeText(event.title || '');

                const displayText = `${timeText} ${titleText}`.trim();

                // 防止XSS攻击和显示异常，使用textContent

                eventPreview.textContent = displayText;

                eventPreview.title = displayText;

                dayEventsContainer.appendChild(eventPreview);

            });

            

            // 如果事件超过3个，显示更多提示

            if (dayEvents.length > 3) {

                const moreEvents = document.createElement('div');

                moreEvents.className = 'event-preview';

                moreEvents.textContent = `+${dayEvents.length - 3} 更多`;

                moreEvents.style.background = 'rgba(255,152,0,0.2)';

                moreEvents.style.color = '#ff9800';

                dayEventsContainer.appendChild(moreEvents);

            }

            

            dayElement.appendChild(dayEventsContainer);

            

            // 添加点击事件

            dayElement.addEventListener('click', () => selectDate(dateKey, dayElement));

            

            return dayElement;

        }



        function selectDate(dateKey, dayElement) {

            // 移除之前选中的样式

            document.querySelectorAll('.calendar-day.selected').forEach(el => {

                el.classList.remove('selected');

            });

            

            // 添加选中样式

            dayElement.classList.add('selected');

            dayElement.style.border = '2px solid var(--theme-color)';

            

            selectedDate = dateKey;

            

            // 更新事件显示

            displaySelectedDayEvents(dateKey);

            

            // 设置表单日期

            document.getElementById('event-date').value = dateKey;

        }



        function displaySelectedDayEvents(dateKey) {

            const events = monthlyEvents[dateKey] || [];

            const container = document.getElementById('selected-day-events');

            const titleEl = document.getElementById('selected-date-title');

            

            // 更新标题

            const date = new Date(dateKey);

            titleEl.textContent = `${date.getMonth() + 1}月${date.getDate()}日 (${DateUtils.getWeekdayName(date)})`;

            

            // 显示/隐藏操作按钮

            const clearBtn = document.getElementById('clear-day-btn');

            const copyBtn = document.getElementById('copy-day-btn');

            if (events.length > 0) {

                clearBtn.style.display = 'inline-block';

                copyBtn.style.display = 'inline-block';

            } else {

                clearBtn.style.display = 'none';

                copyBtn.style.display = 'none';

            }

            

            // 清空并重新填充事件列表

            container.innerHTML = '';

            

            if (events.length === 0) {

                container.innerHTML = `

                    <div style="text-align: center; padding: 40px; color: #666;">

                        <div style="font-size: 2em; margin-bottom: 12px;">📅</div>

                        <p>当天暂无日程安排</p>

                        <button class="btn-main" onclick="focusAddEvent()">添加日程</button>

                    </div>

                `;

                return;

            }

            

            // 数据清理和排序

            const cleanEvents = events.filter(event => event && event.time && event.title)

                                    .map(event => ({

                                        ...event,

                                        time: sanitizeText(event.time),

                                        title: sanitizeText(event.title),

                                        description: sanitizeText(event.description || '')

                                    }));

            

            // 按时间排序

            cleanEvents.sort((a, b) => a.time.localeCompare(b.time));

            

            cleanEvents.forEach((event, index) => {

                const eventItem = document.createElement('div');

                eventItem.className = 'event-item';

                

                // 创建时间元素

                const timeDiv = document.createElement('div');

                timeDiv.className = 'event-time';

                timeDiv.textContent = event.time;

                

                // 创建标题元素

                const titleDiv = document.createElement('div');

                titleDiv.className = 'event-title';

                titleDiv.textContent = event.title;

                

                // 创建删除按钮

                const deleteBtn = document.createElement('button');

                deleteBtn.className = 'event-delete';

                deleteBtn.textContent = '×';

                deleteBtn.title = '删除';

                deleteBtn.onclick = () => deleteEvent(dateKey, index);

                

                eventItem.appendChild(timeDiv);

                eventItem.appendChild(titleDiv);

                eventItem.appendChild(deleteBtn);

                container.appendChild(eventItem);

            });

        }



        function addEvent() {

            const rawTitle = document.getElementById('event-title').value || '';

            const date = document.getElementById('event-date').value;

            const rawTime = document.getElementById('event-time').value || '';

            const category = document.getElementById('event-category').value || 'other';

            const rawDescription = document.getElementById('event-description').value || '';

            

            // 清理输入数据

            const title = sanitizeText(rawTitle);

            const time = sanitizeText(rawTime);

            const description = sanitizeText(rawDescription);

            

            // 验证必需字段

            if (!title) {

                MessageUtils.error('请输入日程标题');

                document.getElementById('event-title').focus();

                return;

            }

            

            if (!date) {

                MessageUtils.error('请选择日期');

                document.getElementById('event-date').focus();

                return;

            }

            

            if (!time) {

                MessageUtils.error('请选择时间');

                document.getElementById('event-time').focus();

                return;

            }

            

            // 验证日期格式

            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {

                MessageUtils.error('日期格式不正确');

                return;

            }

            

            // 验证时间格式

            if (!/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(time)) {

                MessageUtils.error('时间格式不正确');

                return;

            }

            

            // 创建事件对象

            const event = {

                title: title,

                time: time,

                category: category,

                description: description,

                createdAt: new Date().toISOString()

            };

            

            console.log('🔄 添加事件:', event);

            

            // 添加到数据中

            if (!monthlyEvents[date]) {

                monthlyEvents[date] = [];

            }

            

            monthlyEvents[date].push(event);

            

            // 保存数据

            saveEvents();

            

            // 清空表单

            document.getElementById('event-title').value = '';

            document.getElementById('event-time').value = '';

            document.getElementById('event-description').value = '';

            

            // 重新渲染

            renderCalendar();

            updateEventStats();

            

            // 如果是当前选择的日期，更新显示

            if (selectedDate === date) {

                displaySelectedDayEvents(date);

            }

            

            MessageUtils.success('日程添加成功！');

            console.log('✅ 事件添加完成');

        }



        function quickAddEvent(title, time) {

            const date = document.getElementById('event-date').value || DateUtils.getToday();

            

            document.getElementById('event-title').value = title;

            document.getElementById('event-time').value = time;

            

            // 自动添加

            addEvent();

        }



        function deleteEvent(date, index) {

            if (confirm('确定要删除这个日程吗？')) {

                try {

                    console.log(`🗑️ 删除事件: ${date}[${index}]`);

                    

                    // 检查数据有效性

                    if (!monthlyEvents[date] || !Array.isArray(monthlyEvents[date])) {

                        console.error('❌ 无效的日期数据:', date);

                        MessageUtils.error('删除失败：数据无效');

                        return;

                    }

                    

                    if (index < 0 || index >= monthlyEvents[date].length) {

                        console.error('❌ 无效的事件索引:', index);

                        MessageUtils.error('删除失败：事件不存在');

                        return;

                    }

                    

                    // 记录删除的事件

                    const deletedEvent = monthlyEvents[date][index];

                    console.log('删除的事件:', deletedEvent);

                    

                    // 删除事件

                monthlyEvents[date].splice(index, 1);

                

                // 如果日期没有事件了，删除整个日期条目

                if (monthlyEvents[date].length === 0) {

                    delete monthlyEvents[date];

                        console.log(`🗑️ 删除整个日期: ${date}`);

                }

                

                    // 强制保存数据

                saveEvents();

                    

                    // 验证保存是否成功

                    const savedData = JSON.parse(localStorage.getItem('monthlyEvents') || '{}');

                    if (savedData[date]) {

                        const eventStillExists = savedData[date].some(event => 

                            event.title === deletedEvent.title && 

                            event.time === deletedEvent.time

                        );

                        

                        if (eventStillExists) {

                            console.error('❌ 删除验证失败，事件仍然存在');

                            MessageUtils.error('删除失败：数据保存异常');

                            return;

                        }

                    }

                    

                    console.log('✅ 删除验证通过');

                    

                    // 重新渲染界面

                renderCalendar();

                updateEventStats();

                

                if (selectedDate === date) {

                    displaySelectedDayEvents(date);

                }

                    

                    // 记录删除操作到删除日志

                    recordDeletion(date, deletedEvent);

                

                MessageUtils.success('日程已删除');

                    

                } catch (error) {

                    console.error('❌ 删除操作失败:', error);

                    MessageUtils.error('删除失败，请重试');

                }

            }

        }

        

        // 记录删除操作

        function recordDeletion(date, event) {

            try {

                const deletions = JSON.parse(localStorage.getItem('deletedEvents') || '[]');

                deletions.push({

                    date: date,

                    event: event,

                    deletedAt: new Date().toISOString(),

                    userAgent: navigator.userAgent

                });

                

                // 只保留最近100个删除记录

                if (deletions.length > 100) {

                    deletions.splice(0, deletions.length - 100);

                }

                

                localStorage.setItem('deletedEvents', JSON.stringify(deletions));

                console.log('📝 删除记录已保存');

            } catch (error) {

                console.warn('⚠️ 删除记录保存失败:', error);

            }

        }



        function clearDayEvents() {

            if (selectedDate && confirm('确定要清空当天所有日程吗？')) {

                try {

                    console.log(`🗑️ 清空当天所有日程: ${selectedDate}`);

                    

                    // 记录被清空的所有事件

                    if (monthlyEvents[selectedDate]) {

                        const eventsToDelete = monthlyEvents[selectedDate];

                        

                        // 将所有事件添加到删除记录

                        for (const event of eventsToDelete) {

                            recordDeletion(selectedDate, event);

                        }

                        

                        console.log(`📝 记录了 ${eventsToDelete.length} 个删除的事件`);

                    }

                    

                delete monthlyEvents[selectedDate];

                saveEvents();

                renderCalendar();

                updateEventStats();

                displaySelectedDayEvents(selectedDate);

                    

                MessageUtils.success('当天日程已清空');

                    

                } catch (error) {

                    console.error('❌ 清空日程失败:', error);

                    MessageUtils.error('清空失败，请重试');

                }

            }

        }

        

        // 清理删除记录（用于调试和维护）

        function clearDeletionRecords() {

            try {

                localStorage.removeItem('deletedEvents');

                console.log('🧹 删除记录已清理');

                MessageUtils.success('删除记录已清理');

            } catch (error) {

                console.error('❌ 清理删除记录失败:', error);

                MessageUtils.error('清理失败');

            }

        }

        

        // 查看删除记录（用于调试）

        function viewDeletionRecords() {

            try {

                const deletions = JSON.parse(localStorage.getItem('deletedEvents') || '[]');

                console.log('📝 删除记录:', deletions);

                alert(`删除记录数量: ${deletions.length} 个\n\n详细信息请查看控制台。`);

            } catch (error) {

                console.error('❌ 查看删除记录失败:', error);

            }

        }

        

        // 彻底清除15号等损坏数据的专门函数
        function forceCleanSpecificDates() {
            try {
                console.log('🧹 开始彻底清除损坏数据...');
                
                let foundCorruptedData = false;
                const corruptedDates = [];
                
                // 检查所有日期的损坏数据
                for (const [date, events] of Object.entries(monthlyEvents)) {
                    if (Array.isArray(events)) {
                        for (let i = events.length - 1; i >= 0; i--) {
                            const event = events[i];
                            if (event && event.title) {
                                // 检查是否包含编码错误字符（根据截图中的内容）
                                if (event.title.includes('¥€') || 
                                    event.title.includes('®®') || 
                                    event.title.includes('Â') || 
                                    event.title.includes('\u00C2') ||
                                    event.title.includes('â€') ||
                                    event.title.includes('Ã¢') ||
                                    event.title.includes('¥') ||
                                    event.title.includes('€') ||
                                    event.title.includes('@¥') ||
                                    event.title.includes('/4') ||
                                    event.title.includes('/"') ||
                                    event.title.match(/[¥€®@]/g) ||
                                    /[^\x20-\x7E\u4e00-\u9fff]/g.test(event.title)) {
                                    
                                    console.log(`🗑️ 发现损坏事件: ${date} - ${event.title}`);
                                    foundCorruptedData = true;
                                    if (!corruptedDates.includes(date)) {
                                        corruptedDates.push(date);
                                    }
                                    
                                    // 记录删除操作
                                    recordDeletion(date, event);
                                    
                                    // 删除损坏的事件
                                    events.splice(i, 1);
                                }
                            }
                        }
                        
                        // 如果该日期没有事件了，删除整个日期条目
                        if (events.length === 0) {
                            delete monthlyEvents[date];
                            console.log(`🗑️ 删除空日期: ${date}`);
                        }
                    }
                }
                
                if (foundCorruptedData) {
                    console.log(`🧹 清理了 ${corruptedDates.length} 个日期的损坏数据:`, corruptedDates);
                    
                    // 立即保存清理后的数据
                    saveEvents();
                    
                    // 重新渲染界面
                    renderCalendar();
                    updateEventStats();
                    
                    if (selectedDate) {
                        displaySelectedDayEvents(selectedDate);
                    }
                    
                    MessageUtils.success(`已清理 ${corruptedDates.length} 个日期的损坏数据！`);
                    return true;
                } else {
                    console.log('✅ 未发现损坏数据，数据状态正常');
                    return false;
                }
                
            } catch (error) {
                console.error('❌ 清理损坏数据失败:', error);
                MessageUtils.error('清理失败: ' + error.message);
                return false;
            }
        }

        // 一键修复所有15号等损坏数据问题
        async function oneClickFixAll() {
            try {
                const confirmed = confirm(
                    '🔧 一键修复功能\n\n' +
                    '将执行以下操作：\n' +
                    '1. 彻底清理所有损坏数据（包括15号的编码错误）\n' +
                    '2. 强制保存正确数据到本地\n' +
                    '3. 推送到云端覆盖错误数据\n' +
                    '4. 防止损坏数据重新出现\n\n' +
                    '是否立即执行？'
                );
                
                if (!confirmed) {
                    return;
                }
                
                MessageUtils.info('正在执行一键修复...');
                
                // 步骤1：彻底清理损坏数据
                console.log('🧹 步骤1：清理损坏数据');
                const hadCorruption = forceCleanSpecificDates();
                
                // 步骤2：执行紧急数据清理
                console.log('🧹 步骤2：紧急数据清理');
                emergencyDataCleanup();
                
                // 步骤3：再次执行专门清理
                console.log('🧹 步骤3：专门清理');
                forceCleanSpecificDates();
                
                // 步骤4：强制保存到云端
                console.log('☁️ 步骤4：强制保存到云端');
                
                // 如果有同步服务，强制上传
                if (window.syncService) {
                    const status = window.syncService.getSyncStatus();
                    
                    if (status.enabled) {
                        try {
                            await window.syncService.manualSync();
                            MessageUtils.success('✅ 一键修复完成！数据已清理并同步到云端');
                        } catch (syncError) {
                            console.error('❌ 云端同步失败:', syncError);
                            MessageUtils.warning('本地修复完成，但云端同步失败: ' + syncError.message);
                        }
                    } else {
                        MessageUtils.success('✅ 一键修复完成！（同步未启用，仅修复本地数据）');
                    }
                } else {
                    MessageUtils.success('✅ 一键修复完成！（无同步服务，仅修复本地数据）');
                }
                
                // 步骤5：重新渲染界面
                console.log('🎨 步骤5：重新渲染界面');
                renderCalendar();
                updateEventStats();
                
                if (selectedDate) {
                    displaySelectedDayEvents(selectedDate);
                }
                
                // 步骤6：清理删除记录（防止冲突）
                console.log('🧹 步骤6：清理删除记录');
                try {
                    const deletions = JSON.parse(localStorage.getItem('deletedEvents') || '[]');
                    if (deletions.length > 50) {
                        // 只保留最近50个删除记录
                        const recentDeletions = deletions.slice(-50);
                        localStorage.setItem('deletedEvents', JSON.stringify(recentDeletions));
                        console.log('🧹 删除记录已优化，保留最近50个');
                    }
                } catch (error) {
                    console.warn('⚠️ 删除记录清理失败:', error);
                }
                
                console.log('✅ 一键修复完成');
                
            } catch (error) {
                console.error('❌ 一键修复失败:', error);
                MessageUtils.error('修复失败: ' + error.message);
            }
        }

        // 强制保存数据到云端（覆盖同步数据）

        async function forceSaveData() {

            try {

                console.log('💾 开始强制保存数据...');

                // 在保存前先进行最后一次清理
                const hadCorruptedData = forceCleanSpecificDates();

                const confirmed = confirm(

                    '将强制保存当前数据到云端，覆盖云端的错误数据。\n\n' +

                    '这将确保15号等日期的错误内容被彻底清除。\n\n' +

                    '是否继续？'

                );

                

                if (!confirmed) {

                    return;

                }

                

                // 1. 首先清理当前数据

                console.log('🧹 清理当前数据...');

                emergencyDataCleanup();

                

                // 2. 验证数据清洁度

                const cleanedEvents = cleanupEventData(monthlyEvents);

                monthlyEvents = cleanedEvents;

                

                // 3. 强制本地保存

                console.log('💾 强制本地保存...');

                saveEvents();

                

                // 4. 如果有同步服务，强制上传

                if (window.syncService) {

                    const status = window.syncService.getSyncStatus();

                    

                    if (status.enabled) {

                        try {

                            console.log('☁️ 强制同步到云端...');

                            

                            // 显示保存进度

                            MessageUtils.info('正在保存数据到云端...');

                            

                            // 执行强制同步

                            await window.syncService.manualSync();

                            

                            // 再次验证本地数据（防止同步覆盖）

                            setTimeout(() => {

                                const afterSyncData = JSON.parse(localStorage.getItem('monthlyEvents') || '{}');

                                const hasCorruptedData = JSON.stringify(afterSyncData).includes('Â');

                                

                                if (hasCorruptedData) {

                                    console.log('⚠️ 检测到同步后仍有损坏数据，重新强制保存...');

                                    

                                    // 恢复清洁数据

                                    monthlyEvents = cleanedEvents;

                                    saveEvents();

                                    

                                    // 重新渲染

                                    renderCalendar();

                                    updateEventStats();

                                    

                                    MessageUtils.warning('云端数据已更新，但检测到残留问题已自动修复');

                                } else {

                                    console.log('✅ 同步验证通过，数据保存成功');

                                    MessageUtils.success('数据已成功保存到云端！');

                                }

                            }, 1000);

                            

                        } catch (syncError) {

                            console.error('❌ 云端同步失败:', syncError);

                            MessageUtils.warning('本地保存成功，但云端同步失败: ' + syncError.message);

                        }

                    } else {

                        console.log('💡 同步未启用，仅保存到本地');

                        MessageUtils.success('数据已保存到本地！');

                    }

                } else {

                    console.log('💡 无同步服务，仅保存到本地');

                    MessageUtils.success('数据已保存到本地！');

                }

                

                // 5. 重新渲染界面

                renderCalendar();

                updateEventStats();

                

                if (selectedDate) {

                    displaySelectedDayEvents(selectedDate);

                }

                

                // 6. 更新保存时间显示

                updateSaveTimeDisplay();

                

                console.log('✅ 强制保存完成');

                

            } catch (error) {

                console.error('❌ 强制保存失败:', error);

                MessageUtils.error('保存失败: ' + error.message);

            }

        }

        

        // 更新保存时间显示

        function updateSaveTimeDisplay() {

            const now = new Date();

            const timeStr = now.toLocaleTimeString('zh-CN');

            

            const saveBtn = document.getElementById('force-save-btn');

            if (saveBtn) {

                saveBtn.innerHTML = `💾 保存 (${timeStr})`;

                

                // 3秒后恢复原始文本

                setTimeout(() => {

                    saveBtn.innerHTML = '💾 保存';

                }, 3000);

            }

        }



        function copyDayEvents() {

            if (selectedDate) {

                const events = monthlyEvents[selectedDate] || [];

                if (events.length === 0) {

                    MessageUtils.warning('当天没有日程可复制');

                    return;

                }

                

                const eventsText = events.map(e => `${e.time} ${e.title}`).join('\n');

                navigator.clipboard.writeText(eventsText).then(() => {

                    MessageUtils.success('日程已复制到剪贴板');

                }).catch(() => {

                    MessageUtils.error('复制失败');

                });

            }

        }



        function navigateMonth(months) {

            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + months);

            renderCalendar();

            updateEventStats();

        }



        function goToToday() {

            currentCalendarMonth = new Date();

            renderCalendar();

            updateEventStats();

            

            // 自动选择今天

            const today = DateUtils.getToday();

            const todayElement = Array.from(document.querySelectorAll('.calendar-day')).find(el => {

                return el.classList.contains('today');

            });

            

            if (todayElement) {

                selectDate(today, todayElement);

            }

        }



        function updateEventStats() {

            const currentMonth = currentCalendarMonth.getMonth();

            const currentYear = currentCalendarMonth.getFullYear();

            const today = DateUtils.getToday();

            

            let monthCount = 0;

            let todayCount = 0;

            let weekCount = 0;

            

            Object.entries(monthlyEvents).forEach(([date, events]) => {

                const eventDate = new Date(date);

                

                // 统计本月事件

                if (eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear) {

                    monthCount += events.length;

                }

                

                // 统计今日事件

                if (date === today) {

                    todayCount = events.length;

                }

                

                // 统计本周事件（简化计算）

                const daysDiff = Math.abs((new Date(today) - eventDate) / (1000 * 60 * 60 * 24));

                if (daysDiff <= 7) {

                    weekCount += events.length;

                }

            });

            

            document.getElementById('month-events-count').textContent = monthCount;

            document.getElementById('today-events-count').textContent = todayCount;

            document.getElementById('week-events-count').textContent = weekCount;

        }



        function saveEvents() {

            try {

                // 数据清理和验证

                const cleanedEvents = cleanupEventData(monthlyEvents);

                

                // 使用自定义JSON序列化，确保字符编码正确

                const jsonString = safeJsonStringify(cleanedEvents);

                

                if (!jsonString) {

                    console.error('❌ JSON序列化失败');

                    MessageUtils.error('数据序列化失败，保存失败');

                    return;

                }

                

                // 验证JSON字符串是否有效且不含问题字符

                try {

                    const testParse = JSON.parse(jsonString);

                    

                    // 检查是否包含问题字符

                    if (jsonString.includes('Â') || jsonString.includes('\u00C2')) {

                        console.error('❌ JSON包含编码问题字符');

                        MessageUtils.error('数据包含编码问题，保存失败');

                        return;

                    }

                    

                } catch (validateError) {

                    console.error('❌ JSON验证失败:', validateError);

                    MessageUtils.error('数据格式错误，保存失败');

                    return;

                }

                

                // 主要存储

                localStorage.setItem('monthlyEvents', jsonString);

                monthlyEvents = cleanedEvents;

                

                // 验证保存是否成功

                const savedData = localStorage.getItem('monthlyEvents');

                if (savedData !== jsonString) {

                    console.warn('⚠️ 保存验证失败，数据可能不一致');

                    

                    // 尝试重新保存

                    try {

                        localStorage.setItem('monthlyEvents', jsonString);

                        console.log('✅ 重新保存成功');

                    } catch (retryError) {

                        console.error('❌ 重新保存失败:', retryError);

                        MessageUtils.error('数据保存失败，请重试');

                        return;

                    }

                }

                

                console.log('✅ 数据保存成功');

                

                // 创建多重备份（异步执行，不影响用户体验）

                createMultipleBackups();

                

            } catch (error) {

                console.error('❌ 保存失败:', error);

                MessageUtils.error('数据保存失败，请重试');

            }

        }

        

        // 安全的JSON序列化函数

        function safeJsonStringify(data) {

            try {

                // 使用自定义替换器确保字符安全

                return JSON.stringify(data, function(key, value) {

                    if (typeof value === 'string') {

                        // 对字符串值进行清理

                        return sanitizeText(value);

                    }

                    return value;

                }, 0);

            } catch (error) {

                console.error('❌ JSON序列化失败:', error);

                return null;

            }

        }



        // 创建多重备份

        async function createMultipleBackups() {

            try {

                const dataStr = JSON.stringify(monthlyEvents);

                const timestamp = new Date().toISOString();

                

                // 1. 保存到 sessionStorage

                sessionStorage.setItem('monthlyEventsTemp', dataStr);

                sessionStorage.setItem('monthlyEventsBackup', dataStr);

                sessionStorage.setItem('monthlyEventsBackupTime', timestamp);

                

                // 2. 异步保存到 IndexedDB

                saveToIndexedDB(monthlyEvents).catch(error => {

                    console.warn('IndexedDB保存失败:', error);

                });

                

                // 3. 保存到多个localStorage键

                const backupKeys = ['backup_main', 'backup_secondary', 'backup_tertiary'];

                backupKeys.forEach((key, index) => {

                    try {

                        const backupData = {

                            timestamp: timestamp,

                            data: monthlyEvents,

                            source: 'monthly_schedule',

                            backupIndex: index

                        };

                        localStorage.setItem(key, JSON.stringify(backupData));

                    } catch (error) {

                        console.warn(`${key}保存失败:`, error);

                    }

                });

                

                // 4. 尝试保存到 Cache API

                if ('caches' in window) {

                    try {

                        const cache = await caches.open('schedule-backup-v1');

                        const response = new Response(dataStr, {

                            headers: { 'Content-Type': 'application/json' }

                        });

                        await cache.put('/schedule-backup', response);

                    } catch (error) {

                        console.warn('Cache保存失败:', error);

                    }

                }

                

            } catch (error) {

                console.warn('多重备份失败:', error);

            }

        }



        function focusAddEvent() {

            document.getElementById('event-title').focus();

        }



        function exportCalendar() {

            try {

                const data = {

                    version: '1.0',

                    exportDate: new Date().toISOString(),

                    events: monthlyEvents,

                    totalEvents: Object.values(monthlyEvents).reduce((total, events) => total + events.length, 0)

                };

                

                const jsonString = JSON.stringify(data, null, 2);

                const blob = new Blob([jsonString], { type: 'application/json' });

                const url = URL.createObjectURL(blob);

                

                const a = document.createElement('a');

                a.href = url;

                a.download = `月度日程_${new Date().toISOString().split('T')[0]}.json`;

                document.body.appendChild(a);

                a.click();

                document.body.removeChild(a);

                URL.revokeObjectURL(url);

                

                MessageUtils.success('日程数据已导出！');

            } catch (error) {

                console.error('导出失败:', error);

                MessageUtils.error('导出失败，请重试');

            }

        }



        // 数据导入功能

        function importCalendar() {

            document.getElementById('import-file-input').click();

        }



        function handleFileImport(event) {

            const file = event.target.files[0];

            if (!file) return;

            

            const reader = new FileReader();

            reader.onload = function(e) {

                try {

                    const data = JSON.parse(e.target.result);

                    

                    // 验证数据格式

                    if (!data.events || typeof data.events !== 'object') {

                        throw new Error('无效的数据格式');

                    }

                    

                    if (confirm('导入数据将覆盖现有数据，是否继续？')) {

                        monthlyEvents = data.events;

                        saveEvents();

                        renderCalendar();

                        updateEventStats();

                        

                        const totalEvents = Object.values(monthlyEvents).reduce((total, events) => total + events.length, 0);

                        MessageUtils.success(`数据导入成功！共导入 ${totalEvents} 个事件`);

                    }

                } catch (error) {

                    console.error('导入失败:', error);

                    MessageUtils.error('导入失败：文件格式不正确');

                }

            };

            

            reader.readAsText(file);

            event.target.value = ''; // 清空文件选择

        }



        // 云端同步功能 - 重定向到真正的同步系统

        async function syncData() {

            // 重定向到新的手动同步功能

            await manualSyncData();

        }



        // 执行完整备份策略

        async function performFullBackup() {

            return new Promise((resolve, reject) => {

                setTimeout(async () => {

                    try {

                        const dataStr = JSON.stringify(monthlyEvents);

                        const timestamp = new Date().toISOString();

                        

                        // 1. 保存到 sessionStorage（临时）

                        sessionStorage.setItem('monthlyEventsBackup', dataStr);

                        sessionStorage.setItem('monthlyEventsBackupTime', timestamp);

                        

                        // 2. 保存到 IndexedDB（持久化）

                        await saveToIndexedDB(monthlyEvents);

                        

                        // 3. 保存到多个localStorage键（分散风险）

                        const backupKeys = ['backup_main', 'backup_secondary', 'backup_tertiary'];

                        backupKeys.forEach((key, index) => {

                            const backupData = {

                                timestamp: timestamp,

                                data: monthlyEvents,

                                source: 'monthly_schedule',

                                backupIndex: index

                            };

                            localStorage.setItem(key, JSON.stringify(backupData));

                        });

                        

                        // 4. 尝试保存到其他可用存储

                        try {

                            // 使用 Cache API 作为额外备份

                            if ('caches' in window) {

                                const cache = await caches.open('schedule-backup-v1');

                                const response = new Response(dataStr, {

                                    headers: { 'Content-Type': 'application/json' }

                                });

                                await cache.put('/schedule-backup', response);

                            }

                        } catch (cacheError) {

                            console.warn('Cache备份失败:', cacheError);

                        }

                        

                        resolve();

                    } catch (error) {

                        reject(error);

                    }

                }, 800);

            });

        }



        // 自动下载备份文件

        async function createDownloadBackup() {

            return new Promise((resolve) => {

                try {

                    const data = {

                        version: '1.0',

                        exportDate: new Date().toISOString(),

                        events: monthlyEvents,

                        totalEvents: Object.values(monthlyEvents).reduce((total, events) => total + events.length, 0),

                        autoBackup: true

                    };

                    

                    const jsonString = JSON.stringify(data, null, 2);

                    const blob = new Blob([jsonString], { type: 'application/json' });

                    const url = URL.createObjectURL(blob);

                    

                    // 静默下载（不显示下载对话框）

                    const a = document.createElement('a');

                    a.href = url;

                    a.download = `自动备份_${new Date().toISOString().split('T')[0]}.json`;

                    a.style.display = 'none';

                    document.body.appendChild(a);

                    a.click();

                    document.body.removeChild(a);

                    URL.revokeObjectURL(url);

                    

                    resolve();

                } catch (error) {

                    console.warn('下载备份失败:', error);

                    resolve();

                }

            });

        }



        // IndexedDB 持久化存储

        function saveToIndexedDB(data) {

            return new Promise((resolve, reject) => {

                const request = indexedDB.open('PlanManagerDB', 1);

                

                request.onerror = () => reject(request.error);

                

                request.onsuccess = () => {

                    const db = request.result;

                    const transaction = db.transaction(['schedules'], 'readwrite');

                    const store = transaction.objectStore('schedules');

                    

                    const saveRequest = store.put({

                        id: 'monthly_events',

                        data: data,

                        timestamp: new Date().toISOString()

                    });

                    

                    saveRequest.onsuccess = () => resolve();

                    saveRequest.onerror = () => reject(saveRequest.error);

                };

                

                request.onupgradeneeded = (event) => {

                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('schedules')) {

                        db.createObjectStore('schedules', { keyPath: 'id' });

                    }

                };

            });

        }



        // 从 IndexedDB 恢复数据

        function loadFromIndexedDB() {

            return new Promise((resolve, reject) => {

                const request = indexedDB.open('PlanManagerDB', 1);

                

                request.onerror = () => reject(request.error);

                

                request.onsuccess = () => {

                    const db = request.result;

                    const transaction = db.transaction(['schedules'], 'readonly');

                    const store = transaction.objectStore('schedules');

                    

                    const getRequest = store.get('monthly_events');

                    

                    getRequest.onsuccess = () => {

                        if (getRequest.result) {

                            resolve(getRequest.result.data);

                        } else {

                            resolve(null);

                        }

                    };

                    

                    getRequest.onerror = () => reject(getRequest.error);

                };

                

                request.onupgradeneeded = (event) => {

                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('schedules')) {

                        db.createObjectStore('schedules', { keyPath: 'id' });

                    }

                };

            });

        }



        // 创建本地备份

        function createLocalBackup() {

            const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

            const newBackup = {

                id: Date.now(),

                timestamp: new Date().toISOString(),

                data: monthlyEvents,

                eventCount: Object.values(monthlyEvents).reduce((total, events) => total + events.length, 0)

            };

            

            backups.unshift(newBackup);

            

            // 只保留最近10个备份

            if (backups.length > 10) {

                backups.splice(10);

            }

            

            localStorage.setItem('monthlyBackups', JSON.stringify(backups));

        }



        // 全面数据恢复机制

        async function initDataRecovery() {

            try {

                const localData = JSON.parse(localStorage.getItem('monthlyEvents') || '{}');

                const hasLocalData = Object.keys(localData).length > 0;

                

                if (hasLocalData) {

                    // 如果本地数据存在，直接使用

                    monthlyEvents = localData;

                    return;

                }

                

                // 本地数据为空，尝试从各种备份源恢复

                console.log('本地数据为空，开始尝试数据恢复...');

                

                let recoveredData = null;

                let recoverySource = '';

                

                // 1. 尝试从 IndexedDB 恢复

                try {

                    const indexedData = await loadFromIndexedDB();

                    if (indexedData && Object.keys(indexedData).length > 0) {

                        recoveredData = indexedData;

                        recoverySource = 'IndexedDB';

                    }

                } catch (error) {

                    console.warn('IndexedDB恢复失败:', error);

                }

                

                // 2. 尝试从 sessionStorage 恢复

                if (!recoveredData) {

                    try {

                        const sessionData = sessionStorage.getItem('monthlyEventsBackup');

                        if (sessionData) {

                            const parsedData = JSON.parse(sessionData);

                            if (Object.keys(parsedData).length > 0) {

                                recoveredData = parsedData;

                                recoverySource = 'SessionStorage';

                            }

                        }

                    } catch (error) {

                        console.warn('SessionStorage恢复失败:', error);

                    }

                }

                

                // 3. 尝试从多重localStorage备份恢复

                if (!recoveredData) {

                    const backupKeys = ['backup_main', 'backup_secondary', 'backup_tertiary'];

                    for (const key of backupKeys) {

                        try {

                            const backupStr = localStorage.getItem(key);

                            if (backupStr) {

                                const backupData = JSON.parse(backupStr);

                                if (backupData.data && Object.keys(backupData.data).length > 0) {

                                    recoveredData = backupData.data;

                                    recoverySource = `LocalStorage(${key})`;

                                    break;

                                }

                            }

                        } catch (error) {

                            console.warn(`${key}恢复失败:`, error);

                        }

                    }

                }

                

                // 4. 尝试从 Cache API 恢复

                if (!recoveredData) {

                    try {

                        if ('caches' in window) {

                            const cache = await caches.open('schedule-backup-v1');

                            const response = await cache.match('/schedule-backup');

                            if (response) {

                                const cacheData = await response.json();

                                if (Object.keys(cacheData).length > 0) {

                                    recoveredData = cacheData;

                                    recoverySource = 'Cache API';

                                }

                            }

                        }

                    } catch (error) {

                        console.warn('Cache API恢复失败:', error);

                    }

                }

                

                // 5. 尝试从本地备份历史恢复

                if (!recoveredData) {

                    try {

                        const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

                        if (backups.length > 0) {

                            // 使用最新的备份

                            const latestBackup = backups[0];

                            if (latestBackup.data && Object.keys(latestBackup.data).length > 0) {

                                recoveredData = latestBackup.data;

                                recoverySource = '本地备份历史';

                            }

                        }

                    } catch (error) {

                        console.warn('备份历史恢复失败:', error);

                    }

                }

                

                // 如果找到了恢复数据，询问用户是否恢复

                if (recoveredData) {

                    const eventCount = Object.values(recoveredData).reduce((total, events) => total + events.length, 0);

                    const shouldRestore = confirm(`发现备份数据！\n\n数据源: ${recoverySource}\n事件数量: ${eventCount} 个\n\n是否恢复这些数据？`);

                    

                    if (shouldRestore) {

                        monthlyEvents = recoveredData;

                        saveEvents();

                        renderCalendar();

                        updateEventStats();

                        MessageUtils.success(`数据已从${recoverySource}恢复！共恢复 ${eventCount} 个事件`);

                    }

                } else {

                    // 没有找到任何备份数据

                    console.log('未找到任何备份数据');

                    showDataRecoveryHelp();

                }

                

            } catch (error) {

                console.error('数据恢复过程出错:', error);

                showDataRecoveryHelp();

            }

        }



        // 显示数据恢复帮助信息

        function showDataRecoveryHelp() {
            // 检查是否已经关闭过恢复助手
            const helpDismissed = localStorage.getItem('recoveryHelpDismissed');
            if (helpDismissed === 'true') {
                console.log('💡 用户已关闭过恢复助手，不再显示');
                return;
            }
            
            // 检查是否是首次访问
            const firstVisit = !localStorage.getItem('monthlyScheduleVisited');
            if (firstVisit) {
                localStorage.setItem('monthlyScheduleVisited', 'true');
                console.log('💡 首次访问，不显示恢复助手');
                return;
            }

            const helpModal = document.createElement('div');

            helpModal.className = 'recovery-help-modal';

            helpModal.innerHTML = `

                <div class="recovery-help-content">

                    <div class="recovery-help-header">

                        <h3>🔍 数据恢复助手</h3>

                        <button class="close-modal" onclick="closeRecoveryHelp()">&times;</button>

                    </div>

                    <div class="recovery-help-body">

                        <p><strong>未检测到备份数据，但您可以尝试以下方法恢复：</strong></p>

                        <div class="recovery-options">

                            <div class="recovery-option">

                                <span class="recovery-icon">📁</span>

                                <div class="recovery-text">

                                    <h4>从文件恢复</h4>

                                    <p>如果您之前导出过数据文件，可以点击"导入"按钮选择文件恢复</p>

                                </div>

                                <button onclick="importCalendar(); closeRecoveryHelp();" class="btn-main">导入文件</button>

                            </div>

                            <div class="recovery-option">

                                <span class="recovery-icon">🔄</span>

                                <div class="recovery-text">

                                    <h4>重新同步</h4>

                                    <p>尝试重新同步，可能会找到其他存储位置的数据</p>

                                </div>

                                <button onclick="syncData(); closeRecoveryHelp();" class="btn-main">立即同步</button>

                            </div>

                            <div class="recovery-option">

                                <span class="recovery-icon">💡</span>

                                <div class="recovery-text">

                                    <h4>预防建议</h4>

                                    <p>建议定期点击"同步"按钮创建备份，并导出重要数据到本地文件</p>

                                </div>

                                <button onclick="dismissRecoveryHelp();" class="btn-main">知道了，不再显示</button>

                            </div>

                        </div>
                        
                        <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee;">
                            <label style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9em; color: #666; cursor: pointer;">
                                <input type="checkbox" id="dontShowAgain" />
                                <span>不再显示此助手</span>
                            </label>
                        </div>

                    </div>

                </div>

            `;

            document.body.appendChild(helpModal);

        }



        function closeRecoveryHelp() {
            const modal = document.querySelector('.recovery-help-modal');
            if (modal) {
                // 检查是否勾选了"不再显示"
                const dontShowAgain = document.getElementById('dontShowAgain');
                if (dontShowAgain && dontShowAgain.checked) {
                    localStorage.setItem('recoveryHelpDismissed', 'true');
                    console.log('💡 用户选择不再显示恢复助手');
                }
                modal.remove();
            }
        }
        
        // 永久关闭恢复助手
        function dismissRecoveryHelp() {
            localStorage.setItem('recoveryHelpDismissed', 'true');
            console.log('💡 用户永久关闭恢复助手');
            closeRecoveryHelp();
            
            // 显示重置按钮
            const resetBtn = document.getElementById('reset-help-btn');
            if (resetBtn) {
                resetBtn.style.display = 'inline-block';
                resetBtn.title = '重新启用数据恢复助手';
            }
        }
        
        // 重置恢复助手设置
        function resetRecoveryHelp() {
            if (confirm('确定要重新启用数据恢复助手吗？\n\n重新启用后，当检测不到数据时会显示恢复助手。')) {
                localStorage.removeItem('recoveryHelpDismissed');
                localStorage.removeItem('monthlyScheduleVisited');
                console.log('💡 恢复助手设置已重置');
                
                // 隐藏重置按钮
                const resetBtn = document.getElementById('reset-help-btn');
                if (resetBtn) {
                    resetBtn.style.display = 'none';
                }
                
                alert('恢复助手已重新启用！\n\n下次打开页面时，如果没有数据将会显示恢复助手。');
            }
        }
        
        // 检查重置按钮的可见性
        function checkResetButtonVisibility() {
            const helpDismissed = localStorage.getItem('recoveryHelpDismissed');
            const resetBtn = document.getElementById('reset-help-btn');
            
            if (resetBtn) {
                if (helpDismissed === 'true') {
                    resetBtn.style.display = 'inline-block';
                    resetBtn.title = '重新启用数据恢复助手';
                } else {
                    resetBtn.style.display = 'none';
                }
            }
        }



        // 处理同步后的数据
        function handleSyncedData() {
            try {
                console.log('🔄 处理同步后的数据...');
                
                // 获取本地删除记录
                const deletedEvents = JSON.parse(localStorage.getItem('deletedEvents') || '[]');
                console.log('📝 本地删除记录:', deletedEvents.length, '个');
                
                // 重新加载数据
                const rawData = localStorage.getItem('monthlyEvents');
                if (rawData) {
                    const parsedData = JSON.parse(rawData);
                    let cleanedData = cleanupEventData(parsedData);
                    
                    // 特别检查并清理损坏数据（如15号的编码错误）
                    monthlyEvents = cleanedData;
                    const hadCorruption = forceCleanSpecificDates();
                    cleanedData = monthlyEvents; // 获取清理后的数据
                    
                    // 检测是否仍有损坏数据（特别是15号）
                    let hasCorruptedData = false;
                    const corruptedDates = [];
                    
                    for (const [date, events] of Object.entries(cleanedData)) {
                        if (Array.isArray(events)) {
                            for (const event of events) {
                                if (event.title && (event.title.includes('Â') || event.title.includes('\u00C2'))) {
                                    hasCorruptedData = true;
                                    if (!corruptedDates.includes(date)) {
                                        corruptedDates.push(date);
                                    }
                                }
                            }
                        }
                    }
                    
                    // 应用本地删除记录，确保删除的事件不会因为同步而恢复
                    if (deletedEvents.length > 0) {
                        console.log('🗑️ 应用本地删除记录...');
                        
                        for (const deletion of deletedEvents) {
                            const { date, event: deletedEvent } = deletion;
                            
                            if (cleanedData[date]) {
                                // 查找并移除匹配的事件
                                cleanedData[date] = cleanedData[date].filter(event => {
                                    const isMatch = event.title === deletedEvent.title && 
                                                  event.time === deletedEvent.time;
                                    
                                    if (isMatch) {
                                        console.log(`🗑️ 重新应用删除: ${date} - ${event.title}`);
                                    }
                                    
                                    return !isMatch;
                                });
                                
                                // 如果该日期没有事件了，删除整个日期条目
                                if (cleanedData[date].length === 0) {
                                    delete cleanedData[date];
                                }
                            }
                        }
                        
                        console.log('✅ 删除记录应用完成');
                    }
                    
                    monthlyEvents = cleanedData;
                    
                    // 保存应用删除记录后的数据
                    saveEvents();
                    
                    // 重新渲染视图
                    renderCalendar();
                    updateEventStats();
                    
                    // 如果有选中的日期，更新显示
                    if (selectedDate) {
                        displaySelectedDayEvents(selectedDate);
                    }
                    
                    // 如果检测到损坏数据，提示用户强制保存
                    if (hasCorruptedData) {
                        console.log('🚨 检测到同步后仍有损坏数据:', corruptedDates);
                        
                        setTimeout(() => {
                            const shouldForceSave = confirm(
                                `检测到同步后仍有损坏数据！\n\n` +
                                `受影响的日期: ${corruptedDates.join(', ')}\n\n` +
                                `建议点击"💾 保存"按钮强制保存正确数据到云端，\n` +
                                `这将彻底解决15号等日期的错误显示问题。\n\n` +
                                `是否现在强制保存？`
                            );
                            
                            if (shouldForceSave) {
                                forceSaveData();
                            } else {
                                MessageUtils.warning('检测到数据问题，建议手动点击"💾 保存"按钮');
                                // 高亮保存按钮
                                highlightSaveButton();
                            }
                        }, 1000);
                    }
                    
                    console.log('✅ 同步数据已处理和清理');
                }
            } catch (error) {
                console.error('❌ 处理同步数据失败:', error);
                MessageUtils.error('同步数据处理失败，请刷新页面重试');
            }
        }
        
        // 高亮保存按钮
        function highlightSaveButton() {
            const saveBtn = document.getElementById('force-save-btn');
            if (saveBtn) {
                // 添加闪烁效果
                saveBtn.style.animation = 'pulse 1s infinite';
                saveBtn.style.boxShadow = '0 0 10px #4caf50';
                
                // 5秒后移除效果
                setTimeout(() => {
                    saveBtn.style.animation = '';
                    saveBtn.style.boxShadow = '';
                }, 5000);
            }
        }

        // 修改初始化函数

        function initMonthlySchedule() {

            // 设置今天为默认选择日期

            const today = DateUtils.getToday();

            document.getElementById('event-date').value = today;

            

            // 尝试数据恢复

            initDataRecovery();

            

            // 初始化同步系统

            initSyncSystem();

            

            // 渲染日历

            renderCalendar();

            updateEventStats();

            

            // 设置事件监听器

            setupEventListeners();
            
            // 检查是否需要显示重置助手按钮
            checkResetButtonVisibility();

            

            // 定期自动备份（每5分钟）

            setInterval(createLocalBackup, 5 * 60 * 1000);

        }



        function showListView() {

            // 创建列表视图模态框

            const modal = document.createElement('div');

            modal.className = 'list-view-modal';

            modal.innerHTML = `

                <div class="list-view-content">

                    <div class="list-view-header">

                        <h3>📋 列表视图</h3>

                        <button class="close-modal" onclick="closeListView()">&times;</button>

                    </div>

                    <div class="list-view-controls">

                        <select id="list-filter-month">

                            <option value="all">全部月份</option>

                        </select>

                        <select id="list-filter-category">

                            <option value="all">全部分类</option>

                            <option value="work">💼 工作</option>

                            <option value="personal">👤 个人</option>

                            <option value="health">🏃 健康</option>

                            <option value="learning">📚 学习</option>

                            <option value="social">👥 社交</option>

                            <option value="other">📋 其他</option>

                        </select>

                        <input type="text" id="list-search" placeholder="搜索事件..." />

                    </div>

                    <div class="list-view-body" id="list-view-events">

                        <!-- 事件列表将在这里显示 -->

                    </div>

                </div>

            `;

            

            document.body.appendChild(modal);

            

            // 填充月份选项

            populateMonthFilter();

            

            // 显示所有事件

            renderListView();

            

            // 绑定筛选事件

            document.getElementById('list-filter-month').addEventListener('change', renderListView);

            document.getElementById('list-filter-category').addEventListener('change', renderListView);

            document.getElementById('list-search').addEventListener('input', renderListView);

        }



        // 列表视图相关函数

        function populateMonthFilter() {

            const monthFilter = document.getElementById('list-filter-month');

            const months = new Set();

            

            Object.keys(monthlyEvents).forEach(dateKey => {

                const date = new Date(dateKey);

                const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;

                months.add(monthKey);

            });

            

            Array.from(months).sort().forEach(monthKey => {

                const [year, month] = monthKey.split('-');

                const option = document.createElement('option');

                option.value = monthKey;

                option.textContent = `${year}年${month}月`;

                monthFilter.appendChild(option);

            });

        }



        function renderListView() {

            const container = document.getElementById('list-view-events');

            const monthFilter = document.getElementById('list-filter-month').value;

            const categoryFilter = document.getElementById('list-filter-category').value;

            const searchTerm = document.getElementById('list-search').value.toLowerCase();

            

            // 收集所有事件

            const allEvents = [];

            Object.entries(monthlyEvents).forEach(([date, events]) => {

                events.forEach(event => {

                    allEvents.push({ ...event, date });

                });

            });

            

            // 筛选事件

            let filteredEvents = allEvents.filter(event => {

                const eventDate = new Date(event.date);

                const eventMonthKey = `${eventDate.getFullYear()}-${eventDate.getMonth() + 1}`;

                

                // 月份筛选

                if (monthFilter !== 'all' && eventMonthKey !== monthFilter) {

                    return false;

                }

                

                // 分类筛选

                if (categoryFilter !== 'all' && event.category !== categoryFilter) {

                    return false;

                }

                

                // 搜索筛选

                if (searchTerm && !event.title.toLowerCase().includes(searchTerm) && !event.description.toLowerCase().includes(searchTerm)) {

                    return false;

                }

                

                return true;

            });

            

            // 按日期和时间排序

            filteredEvents.sort((a, b) => {

                const dateCompare = new Date(a.date) - new Date(b.date);

                if (dateCompare !== 0) return dateCompare;

                return a.time.localeCompare(b.time);

            });

            

            // 渲染事件列表

            if (filteredEvents.length === 0) {

                container.innerHTML = `

                    <div class="no-events">

                        <div style="font-size: 2em; margin-bottom: 12px;">📅</div>

                        <p>未找到符合条件的事件</p>

                    </div>

                `;

                return;

            }

            

            container.innerHTML = '';

            let currentDate = '';

            

            filteredEvents.forEach((event, index) => {

                const eventDate = new Date(event.date);

                const dateStr = `${eventDate.getMonth() + 1}月${eventDate.getDate()}日 (${DateUtils.getWeekdayName(eventDate)})`;

                

                // 日期分组

                if (dateStr !== currentDate) {

                    currentDate = dateStr;

                    const dateHeader = document.createElement('div');

                    dateHeader.className = 'list-date-header';

                    dateHeader.textContent = dateStr;

                    container.appendChild(dateHeader);

                }

                

                // 事件项

                const eventItem = document.createElement('div');

                eventItem.className = 'list-event-item';

                eventItem.innerHTML = `

                    <div class="list-event-time">${event.time}</div>

                    <div class="list-event-content">

                        <div class="list-event-title">${event.title}</div>

                        <div class="list-event-category">${getCategoryIcon(event.category)} ${getCategoryName(event.category)}</div>

                        ${event.description ? `<div class="list-event-description">${event.description}</div>` : ''}

                    </div>

                    <div class="list-event-actions">

                        <button onclick="editEventFromList('${event.date}', ${getEventIndex(event.date, event)})" title="编辑">✏️</button>

                        <button onclick="deleteEventFromList('${event.date}', ${getEventIndex(event.date, event)})" title="删除">🗑️</button>

                    </div>

                `;

                container.appendChild(eventItem);

            });

        }



        function getCategoryIcon(category) {

            const icons = {

                work: '💼',

                personal: '👤',

                health: '🏃',

                learning: '📚',

                social: '👥',

                other: '📋'

            };

            return icons[category] || '📋';

        }



        function getCategoryName(category) {

            const names = {

                work: '工作',

                personal: '个人',

                health: '健康',

                learning: '学习',

                social: '社交',

                other: '其他'

            };

            return names[category] || '其他';

        }



        function getEventIndex(date, targetEvent) {

            const events = monthlyEvents[date] || [];

            return events.findIndex(event => 

                event.title === targetEvent.title && 

                event.time === targetEvent.time && 

                event.createdAt === targetEvent.createdAt

            );

        }



        function editEventFromList(date, index) {

            const event = monthlyEvents[date][index];

            if (!event) return;

            

            // 填充表单

            document.getElementById('event-title').value = event.title;

            document.getElementById('event-date').value = date;

            document.getElementById('event-time').value = event.time;

            document.getElementById('event-category').value = event.category;

            document.getElementById('event-description').value = event.description || '';

            

            // 删除原事件

            monthlyEvents[date].splice(index, 1);

            if (monthlyEvents[date].length === 0) {

                delete monthlyEvents[date];

            }

            

            saveEvents();

            renderCalendar();

            updateEventStats();

            

            // 关闭列表视图

            closeListView();

            

            // 聚焦到表单

            document.getElementById('event-title').focus();

            

            MessageUtils.info('事件已加载到表单中，修改后点击添加即可保存');

        }



        function deleteEventFromList(date, index) {

            if (confirm('确定要删除这个事件吗？')) {

                monthlyEvents[date].splice(index, 1);

                

                if (monthlyEvents[date].length === 0) {

                    delete monthlyEvents[date];

                }

                

                saveEvents();

                renderCalendar();

                updateEventStats();

                renderListView(); // 重新渲染列表

                

                MessageUtils.success('事件已删除');

            }

        }



        function closeListView() {

            const modal = document.querySelector('.list-view-modal');

            if (modal) {

                modal.remove();

            }

        }



        // 备份管理器

        function showBackupManager() {

            const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

            

            const modal = document.createElement('div');

            modal.className = 'backup-manager-modal';

            modal.innerHTML = `

                <div class="backup-manager-content">

                    <div class="backup-manager-header">

                        <h3>🗄️ 备份管理</h3>

                        <button class="close-modal" onclick="closeBackupManager()">&times;</button>

                    </div>

                    <div class="backup-manager-body">

                        <div class="backup-info">

                            <p><strong>数据保护状态:</strong></p>

                            <div class="protection-status">

                                <div class="status-item">

                                    <span class="status-icon">💾</span>

                                    <span>本地存储: localStorage</span>

                                    <span class="status-ok">✓</span>

                                </div>

                                <div class="status-item">

                                    <span class="status-icon">🗃️</span>

                                    <span>持久化存储: IndexedDB</span>

                                    <span class="status-ok">✓</span>

                                </div>

                                <div class="status-item">

                                    <span class="status-icon">📦</span>

                                    <span>自动备份: 每5分钟</span>

                                    <span class="status-ok">✓</span>

                                </div>

                            </div>

                        </div>

                        <div class="backup-actions">

                            <button onclick="createManualBackup()" class="btn-main">📁 立即备份</button>

                            <button onclick="downloadAllBackups()" class="btn-main">💾 下载全部备份</button>

                            <button onclick="clearOldBackups()" class="btn-danger">🗑️ 清理旧备份</button>

                        </div>

                        <div class="backup-list">

                            <h4>备份历史 (最近10个)</h4>

                            <div id="backup-list-container">

                                ${renderBackupList(backups)}

                            </div>

                        </div>

                    </div>

                </div>

            `;

            

            document.body.appendChild(modal);

        }



        function renderBackupList(backups) {

            if (backups.length === 0) {

                return '<div class="no-backups">暂无备份记录</div>';

            }

            

            return backups.map(backup => {

                const date = new Date(backup.timestamp);

                const timeStr = date.toLocaleString('zh-CN');

                const sizeKB = Math.round(JSON.stringify(backup.data).length / 1024);

                

                return `

                    <div class="backup-item">

                        <div class="backup-info-item">

                            <div class="backup-time">${timeStr}</div>

                            <div class="backup-details">

                                ${backup.eventCount} 个事件 • ${sizeKB} KB

                            </div>

                        </div>

                        <div class="backup-actions-item">

                            <button onclick="restoreBackup(${backup.id})" class="btn-small">恢复</button>

                            <button onclick="downloadBackup(${backup.id})" class="btn-small">下载</button>

                            <button onclick="deleteBackup(${backup.id})" class="btn-small btn-danger">删除</button>

                        </div>

                    </div>

                `;

            }).join('');

        }



        function createManualBackup() {

            createLocalBackup();

            MessageUtils.success('手动备份已创建！');

            

            // 刷新备份列表

            const container = document.getElementById('backup-list-container');

            if (container) {

                const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

                container.innerHTML = renderBackupList(backups);

            }

        }



        function restoreBackup(backupId) {

            const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

            const backup = backups.find(b => b.id === backupId);

            

            if (!backup) {

                MessageUtils.error('备份不存在');

                return;

            }

            

            if (confirm(`确定要恢复 ${new Date(backup.timestamp).toLocaleString('zh-CN')} 的备份吗？当前数据将被覆盖。`)) {

                monthlyEvents = backup.data;

                saveEvents();

                renderCalendar();

                updateEventStats();

                

                closeBackupManager();

                MessageUtils.success('数据已从备份中恢复！');

            }

        }



        function downloadBackup(backupId) {

            const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

            const backup = backups.find(b => b.id === backupId);

            

            if (!backup) {

                MessageUtils.error('备份不存在');

                return;

            }

            

            const exportData = {

                version: '1.0',

                exportDate: backup.timestamp,

                events: backup.data,

                totalEvents: backup.eventCount,

                backupId: backup.id

            };

            

            const jsonString = JSON.stringify(exportData, null, 2);

            const blob = new Blob([jsonString], { type: 'application/json' });

            const url = URL.createObjectURL(blob);

            

            const a = document.createElement('a');

            a.href = url;

            a.download = `备份_${new Date(backup.timestamp).toISOString().split('T')[0]}.json`;

            document.body.appendChild(a);

            a.click();

            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            

            MessageUtils.success('备份已下载！');

        }



        function deleteBackup(backupId) {

            if (confirm('确定要删除这个备份吗？')) {

                let backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

                backups = backups.filter(b => b.id !== backupId);

                localStorage.setItem('monthlyBackups', JSON.stringify(backups));

                

                // 刷新备份列表

                const container = document.getElementById('backup-list-container');

                if (container) {

                    container.innerHTML = renderBackupList(backups);

                }

                

                MessageUtils.success('备份已删除');

            }

        }



        function downloadAllBackups() {

            const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

            

            if (backups.length === 0) {

                MessageUtils.warning('没有可下载的备份');

                return;

            }

            

            const allData = {

                version: '1.0',

                exportDate: new Date().toISOString(),

                backupCount: backups.length,

                backups: backups

            };

            

            const jsonString = JSON.stringify(allData, null, 2);

            const blob = new Blob([jsonString], { type: 'application/json' });

            const url = URL.createObjectURL(blob);

            

            const a = document.createElement('a');

            a.href = url;

            a.download = `全部备份_${new Date().toISOString().split('T')[0]}.json`;

            document.body.appendChild(a);

            a.click();

            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            

            MessageUtils.success('全部备份已下载！');

        }



        function clearOldBackups() {

            if (confirm('确定要清理旧备份吗？将只保留最近3个备份。')) {

                let backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

                backups = backups.slice(0, 3);

                localStorage.setItem('monthlyBackups', JSON.stringify(backups));

                

                // 刷新备份列表

                const container = document.getElementById('backup-list-container');

                if (container) {

                    container.innerHTML = renderBackupList(backups);

                }

                

                MessageUtils.success('旧备份已清理');

            }

        }



        function closeBackupManager() {

            const modal = document.querySelector('.backup-manager-modal');

            if (modal) {

                modal.remove();

            }

        }



        // 真正的云端同步功能 - 集成现有同步系统

        function openSyncSettings() {

            // 打开同步设置页面

            window.open('sync-settings.html', '_blank');

        }



        // 手动同步数据

        async function manualSyncData() {

            if (!window.syncService) {

                MessageUtils.error('同步服务未加载，请刷新页面重试');

                return;

            }



            const status = window.syncService.getSyncStatus();

            if (!status.enabled) {

                const shouldOpenSettings = confirm('同步功能尚未启用。\n\n是否打开同步设置页面进行配置？');

                if (shouldOpenSettings) {

                    openSyncSettings();

                }

                return;

            }



            try {

                MessageUtils.info('正在同步数据...');

                await window.syncService.manualSync();

                

                // 处理同步后的数据

                handleSyncedData();

                

                MessageUtils.success('数据同步成功！');

                updateSyncStatusDisplay();

            } catch (error) {

                console.error('同步失败:', error);

                MessageUtils.error('同步失败: ' + error.message);

            }

        }









        // 同步状态显示和控制

        function updateSyncStatusDisplay() {

            if (!window.syncService) return;

            

            const status = window.syncService.getSyncStatus();

            const syncBtn = document.getElementById('sync-data-btn');

            

            if (status.enabled) {

                if (status.online) {

                    syncBtn.innerHTML = '☁️ 同步 ✅';

                    syncBtn.style.backgroundColor = '#4caf50';

                } else {

                    syncBtn.innerHTML = '☁️ 同步 ⚠️';

                    syncBtn.style.backgroundColor = '#ff9800';

                }

            } else {

                syncBtn.innerHTML = '☁️ 同步';

                syncBtn.style.backgroundColor = '';

            }

        }



        // 初始化同步系统

        function initSyncSystem() {

            // 等待同步服务加载完成

            setTimeout(() => {

                if (window.syncService) {

                    console.log('✅ 同步服务已加载');

                    

                    // 更新同步状态显示

                    updateSyncStatusDisplay();

                    

                    // 监听同步事件

                    window.addEventListener('sync-complete', function(event) {

                        console.log('同步完成:', event.detail);

                        updateSyncStatusDisplay();

                        

                        // 处理同步后的数据

                        handleSyncedData();

                        

                        MessageUtils.success('数据同步完成');

                    });

                    

                    window.addEventListener('sync-error', function(event) {

                        console.error('同步错误:', event.detail);

                        updateSyncStatusDisplay();

                    });

                    

                    // 监听数据变化，触发自动同步

                    setupDataChangeSync();

                    

                } else {

                    console.warn('⚠️ 同步服务未加载');

                }

            }, 1000);

        }



        // 设置数据变化同步

        function setupDataChangeSync() {

            // 重写saveEvents函数，在保存时触发同步

            const originalSaveEvents = saveEvents;

            saveEvents = function() {

                // 调用原始保存函数

                originalSaveEvents.call(this);

                

                // 触发数据变化事件

                if (window.syncService && window.syncService.getSyncStatus().enabled) {

                    // 防抖同步，避免频繁同步

                    clearTimeout(window.syncTimeout);

                    window.syncTimeout = setTimeout(() => {

                        window.syncService.manualSync().catch(error => {

                            console.error('自动同步失败:', error);

                        });

                    }, 3000); // 3秒后同步

                }

            };

        }



        // 页面加载时检查是否有分享链接参数

        window.addEventListener('DOMContentLoaded', function() {

            const urlParams = new URLSearchParams(window.location.search);

            const importData = urlParams.get('import');

            

            if (importData) {

                try {

                    const jsonString = decodeURIComponent(escape(atob(importData)));

                    const data = JSON.parse(jsonString);

                    

                    if (data.events && confirm(`检测到分享的备份数据！\n\n备份时间: ${new Date(data.exportDate).toLocaleString()}\n事件数量: ${data.totalEvents} 个\n\n是否导入这些数据？`)) {

                        monthlyEvents = data.events;

                        saveEvents();

                        renderCalendar();

                        updateEventStats();

                        

                        MessageUtils.success(`已导入 ${data.totalEvents} 个事件！`);

                        

                        // 清除URL参数

                        window.history.replaceState({}, document.title, window.location.pathname);

                    }

                } catch (error) {

                    console.error('导入分享数据失败:', error);

                }

            }

        });

    </script>

    <!-- 同步服务系统 -->
    <script src="sync-service.js"></script>
    <script src="sync-providers.js"></script>
    <script src="universal-auto-sync.js"></script>

</body>



</html>


