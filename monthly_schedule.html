<!DOCTYPE html>

<html lang="zh-CN">



<head>

    <meta charset="UTF-8">

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <script src="config.js"></script>
    
    <!-- Firebaseé…ç½® -->
    <script src="firebase-config.js"></script>
    
    <!-- åŒæ­¥ä¿®å¤å·¥å…· -->
    <script src="sync-fix.js"></script>

    <!-- LeanCloud äº‘ç«¯åŒæ­¥ - å¿…é¡»å…ˆåŠ è½½ -->
    <script src="leancloud-config.js"></script>
    <script src="leancloud-sync.js"></script>

    <title>æœˆåº¦æ—¥ç¨‹ - æ™ºèƒ½è®¡åˆ’ç®¡ç†ç³»ç»Ÿ</title>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ai-assistant-styles.css">

    <style>

        .calendar-container {

            background: rgba(255, 255, 255, 0.9);

            border-radius: 16px;

            padding: 20px;

            margin-bottom: 24px;

            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);

        }



        .calendar-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            margin-bottom: 20px;

        }



        .calendar-nav {

            display: flex;

            align-items: center;

            gap: 12px;

        }



        .calendar-nav button {

            padding: 8px 12px;

            border: 1px solid #ddd;

            background: white;

            border-radius: 6px;

            cursor: pointer;

            transition: all 0.3s ease;

        }



        .calendar-nav button:hover {

            background: var(--theme-color-light);

            border-color: var(--theme-color);

        }



        .calendar-month-year {

            font-size: 1.5em;

            font-weight: 600;

            color: var(--theme-color);

        }



        .calendar-grid {

            display: grid;

            grid-template-columns: repeat(7, 1fr);

            gap: 1px;

            background: #e0e0e0;

            border-radius: 8px;

            overflow: hidden;

        }



        .calendar-weekday {

            background: var(--theme-color);

            color: white;

            padding: 12px;

            text-align: center;

            font-weight: 600;

            font-size: 0.9em;

        }



        .calendar-day {

            background: white;

            min-height: 90px;

            padding: 8px;

            cursor: pointer;

            transition: all 0.3s ease;

            position: relative;

            display: flex;

            flex-direction: column;

            border: 1px solid rgba(0,0,0,0.05);

        }



        .calendar-day:hover {

            background: rgba(25, 118, 210, 0.05);

        }



        .calendar-day.other-month {

            background: #f5f5f5;

            color: #999;

        }



        .calendar-day.today {

            background: var(--theme-color-light);

            border: 2px solid var(--theme-color);

        }



        .calendar-day.has-events {

            background: rgba(76, 175, 80, 0.1);

        }



        .day-number {

            font-weight: 600;

            margin-bottom: 6px;

            font-size: 1em;

            color: #333;

        }



        .day-events {

            flex: 1;

            display: flex;

            flex-direction: column;

            gap: 1px;

            overflow: hidden;

        }



        .event-dot {

            width: 6px;

            height: 6px;

            border-radius: 50%;

            background: var(--theme-color);

        }



        .event-preview {

            font-size: 0.75em;

            padding: 2px 6px;

            background: rgba(25, 118, 210, 0.1);

            border-radius: 4px;

            color: var(--theme-color);

            overflow: hidden;

            text-overflow: ellipsis;

            white-space: nowrap;

            margin-bottom: 2px;

            font-weight: 500;

            line-height: 1.2;

            max-width: 100%;

        }



        .schedule-panel {

            display: grid;

            grid-template-columns: 300px 1fr;

            gap: 20px;

            margin-bottom: 24px;

        }



        .schedule-sidebar {

            background: rgba(255, 255, 255, 0.9);

            border-radius: 12px;

            padding: 16px;

            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

        }



        .schedule-main {

            background: rgba(255, 255, 255, 0.9);

            border-radius: 12px;

            padding: 20px;

            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

        }



        .event-form {

            display: flex;

            flex-direction: column;

            gap: 12px;

        }



        .event-form input,

        .event-form textarea,

        .event-form select {

            width: 100%;

            padding: 8px;

            border: 1px solid #ddd;

            border-radius: 6px;

            box-sizing: border-box;

        }



        .event-list {

            max-height: 400px;

            overflow-y: auto;

        }



        .event-item {

            display: flex;

            align-items: center;

            gap: 8px;

            padding: 8px;

            background: rgba(255, 255, 255, 0.8);

            border-radius: 6px;

            margin-bottom: 6px;

            border-left: 3px solid var(--theme-color);

            transition: all 0.3s ease;

        }



        .event-item:hover {

            background: rgba(25, 118, 210, 0.1);

            transform: translateX(4px);

        }



        .event-time {

            font-size: 0.8em;

            color: var(--theme-color);

            font-weight: 600;

            min-width: 40px;

        }



        .event-title {

            flex: 1;

            font-size: 0.9em;

            color: #333;

        }



        .event-delete {

            background: none;

            border: none;

            color: #f44336;

            cursor: pointer;

            padding: 2px;

            border-radius: 3px;

            transition: all 0.3s ease;

            opacity: 0.6;

        }



        .event-delete:hover {

            background: #ffebee;

            opacity: 1;

        }



        /* é€‰ä¸­çŠ¶æ€æ ·å¼ */

        .calendar-day.selected {

            background: rgba(25, 118, 210, 0.1);

            border: 2px solid var(--theme-color) !important;

            transform: scale(1.02);

        }

        

        /* æ”¹å–„ä»Šå¤©çš„æ˜¾ç¤º */

        .calendar-day.today {

            background: linear-gradient(135deg, var(--theme-color-light), rgba(25, 118, 210, 0.1));

            border: 2px solid var(--theme-color);

            font-weight: 600;

        }

        

        /* æ”¹å–„äº‹ä»¶é¢„è§ˆçš„æ ·å¼ */

        .calendar-day.has-events {

            background: rgba(76, 175, 80, 0.05);

            border-left: 3px solid #4caf50;

        }

        

        /* æ‚¬åœæ•ˆæœå¢å¼º */

        .calendar-day:hover {

            background: rgba(25, 118, 210, 0.08);

            transform: translateY(-1px);

            box-shadow: 0 2px 8px rgba(0,0,0,0.1);

        }

        

        /* æ”¹å–„å­—ä½“æ˜¾ç¤º */

        body {

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;

            -webkit-font-smoothing: antialiased;

            -moz-osx-font-smoothing: grayscale;

        }

        

        @media (max-width: 768px) {

            .schedule-panel {

                grid-template-columns: 1fr;

            }

            

            .calendar-day {

                min-height: 70px;

                padding: 6px;

            }

            

            .calendar-weekday {

                padding: 10px 8px;

                font-size: 0.85em;

            }

            

            .event-preview {

                font-size: 0.7em;

                padding: 1px 4px;

            }

            

            .page-header {

                flex-direction: column;

                gap: 12px;

                text-align: center;

            }

            

            .calendar-header {

                flex-direction: column;

                gap: 12px;

                text-align: center;

            }

            

            .calendar-header > div {

                flex-wrap: wrap;

                justify-content: center;

            }

            

            .calendar-header button {

                font-size: 0.8em;

                padding: 6px 10px;

            }

        }

        

        /* åˆ—è¡¨è§†å›¾æ ·å¼ */

        .list-view-modal {

            position: fixed;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background: rgba(0, 0, 0, 0.5);

            display: flex;

            justify-content: center;

            align-items: center;

            z-index: 1000;

        }

        

        .list-view-content {

            background: white;

            border-radius: 12px;

            width: 90%;

            max-width: 800px;

            max-height: 80vh;

            display: flex;

            flex-direction: column;

            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);

        }

        

        .list-view-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 20px;

            border-bottom: 1px solid #eee;

        }

        

        .list-view-header h3 {

            margin: 0;

            color: var(--theme-color);

        }

        

        .close-modal {

            background: none;

            border: none;

            font-size: 24px;

            cursor: pointer;

            color: #666;

            padding: 0;

            width: 32px;

            height: 32px;

            display: flex;

            align-items: center;

            justify-content: center;

            border-radius: 50%;

            transition: all 0.3s ease;

        }

        

        .close-modal:hover {

            background: #f5f5f5;

            color: #333;

        }

        

        .list-view-controls {

            display: flex;

            gap: 12px;

            padding: 16px 20px;

            border-bottom: 1px solid #eee;

            flex-wrap: wrap;

        }

        

        .list-view-controls select,

        .list-view-controls input {

            padding: 8px 12px;

            border: 1px solid #ddd;

            border-radius: 6px;

            font-size: 14px;

        }

        

        .list-view-controls input {

            flex: 1;

            min-width: 200px;

        }

        

        .list-view-body {

            flex: 1;

            overflow-y: auto;

            padding: 20px;

        }

        

        .no-events {

            text-align: center;

            padding: 40px;

            color: #666;

        }

        

        .list-date-header {

            font-weight: 600;

            color: var(--theme-color);

            margin: 20px 0 10px 0;

            padding-bottom: 8px;

            border-bottom: 2px solid var(--theme-color-light);

            font-size: 1.1em;

        }

        

        .list-date-header:first-child {

            margin-top: 0;

        }

        

        .list-event-item {

            display: flex;

            align-items: flex-start;

            gap: 16px;

            padding: 12px;

            background: rgba(255, 255, 255, 0.8);

            border-radius: 8px;

            margin-bottom: 8px;

            border-left: 3px solid var(--theme-color);

            transition: all 0.3s ease;

        }

        

        .list-event-item:hover {

            background: rgba(25, 118, 210, 0.05);

            transform: translateX(4px);

        }

        

        .list-event-time {

            font-weight: 600;

            color: var(--theme-color);

            min-width: 60px;

            font-size: 0.9em;

        }

        

        .list-event-content {

            flex: 1;

        }

        

        .list-event-title {

            font-weight: 600;

            color: #333;

            margin-bottom: 4px;

        }

        

        .list-event-category {

            font-size: 0.8em;

            color: #666;

            margin-bottom: 4px;

        }

        

        .list-event-description {

            font-size: 0.85em;

            color: #888;

            line-height: 1.4;

        }

        

        .list-event-actions {

            display: flex;

            gap: 8px;

        }

        

        .list-event-actions button {

            background: none;

            border: none;

            cursor: pointer;

            padding: 4px;

            border-radius: 4px;

            transition: all 0.3s ease;

            font-size: 16px;

        }

        

        .list-event-actions button:hover {

            background: rgba(0, 0, 0, 0.1);

        }

        

        @media (max-width: 768px) {

            .list-view-content {

                width: 95%;

                max-height: 90vh;

            }

            

            .list-view-controls {

                flex-direction: column;

            }

            

            .list-view-controls input {

                min-width: auto;

            }

            

            .list-event-item {

                flex-direction: column;

                gap: 8px;

            }

            

            .list-event-time {

                min-width: auto;

            }

        }



        /* å¤‡ä»½ç®¡ç†å™¨æ ·å¼ */

        .backup-manager-modal {

            position: fixed;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background: rgba(0, 0, 0, 0.5);

            display: flex;

            justify-content: center;

            align-items: center;

            z-index: 1000;

        }



        .backup-manager-content {

            background: white;

            border-radius: 12px;

            width: 90%;

            max-width: 700px;

            max-height: 80vh;

            display: flex;

            flex-direction: column;

            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);

        }



        .backup-manager-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 20px;

            border-bottom: 1px solid #eee;

        }



        .backup-manager-body {

            flex: 1;

            overflow-y: auto;

            padding: 20px;

        }



        .backup-info {

            margin-bottom: 20px;

        }



        .protection-status {

            background: rgba(76, 175, 80, 0.1);

            border-radius: 8px;

            padding: 16px;

            margin-top: 12px;

        }



        .status-item {

            display: flex;

            align-items: center;

            gap: 12px;

            margin-bottom: 8px;

        }



        .status-item:last-child {

            margin-bottom: 0;

        }



        .status-icon {

            font-size: 16px;

            width: 24px;

        }



        .status-ok {

            color: #4caf50;

            font-weight: 600;

            margin-left: auto;

        }



        .backup-actions {

            display: flex;

            gap: 12px;

            margin-bottom: 24px;

            flex-wrap: wrap;

        }



        .backup-list h4 {

            margin: 0 0 16px 0;

            color: var(--theme-color);

        }



        .backup-item {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 12px;

            background: rgba(255, 255, 255, 0.8);

            border-radius: 8px;

            margin-bottom: 8px;

            border-left: 3px solid var(--theme-color);

            transition: all 0.3s ease;

        }



        .backup-item:hover {

            background: rgba(25, 118, 210, 0.05);

            transform: translateX(4px);

        }



        .backup-info-item {

            flex: 1;

        }



        .backup-time {

            font-weight: 600;

            color: #333;

            margin-bottom: 4px;

        }



        .backup-details {

            font-size: 0.85em;

            color: #666;

        }



        .backup-actions-item {

            display: flex;

            gap: 8px;

        }



        .btn-small {

            padding: 4px 8px;

            font-size: 0.8em;

            border: 1px solid #ddd;

            background: white;

            border-radius: 4px;

            cursor: pointer;

            transition: all 0.3s ease;

        }



        .btn-small:hover {

            background: var(--theme-color-light);

            border-color: var(--theme-color);

        }



        .btn-small.btn-danger {

            color: #f44336;

            border-color: #f44336;

        }



        .btn-small.btn-danger:hover {

            background: #ffebee;

            border-color: #f44336;

        }



        .no-backups {

            text-align: center;

            padding: 40px;

            color: #666;

            font-style: italic;

        }



        @media (max-width: 768px) {

            .backup-manager-content {

                width: 95%;

                max-height: 90vh;

            }



            .backup-actions {

                flex-direction: column;

            }



            .backup-item {

                flex-direction: column;

                align-items: flex-start;

                gap: 12px;

            }



            .backup-actions-item {

                align-self: stretch;

                justify-content: space-around;

            }

        }



        /* æ•°æ®æ¢å¤å¸®åŠ©ç•Œé¢æ ·å¼ */

        .recovery-help-modal {

            position: fixed;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background: rgba(0, 0, 0, 0.6);

            display: flex;

            justify-content: center;

            align-items: center;

            z-index: 1001;

        }



        .recovery-help-content {

            background: white;

            border-radius: 12px;

            width: 90%;

            max-width: 600px;

            max-height: 80vh;

            display: flex;

            flex-direction: column;

            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);

        }



        .recovery-help-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 20px;

            border-bottom: 1px solid #eee;

            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);

            color: white;

            border-radius: 12px 12px 0 0;

        }



        .recovery-help-header h3 {

            margin: 0;

        }



        .recovery-help-body {

            padding: 24px;

            overflow-y: auto;

        }



        .recovery-options {

            display: flex;

            flex-direction: column;

            gap: 16px;

            margin-top: 16px;

        }



        .recovery-option {

            display: flex;

            align-items: center;

            gap: 16px;

            padding: 16px;

            background: rgba(76, 175, 80, 0.05);

            border-radius: 8px;

            border-left: 4px solid #4caf50;

            transition: all 0.3s ease;

        }



        .recovery-option:hover {

            background: rgba(76, 175, 80, 0.1);

            transform: translateX(4px);

        }



        .recovery-icon {

            font-size: 24px;

            min-width: 40px;

            text-align: center;

        }



        .recovery-text {

            flex: 1;

        }



        .recovery-text h4 {

            margin: 0 0 8px 0;

            color: var(--theme-color);

            font-size: 1.1em;

        }



        .recovery-text p {

            margin: 0;

            color: #666;

            font-size: 0.9em;

            line-height: 1.4;

        }



        @media (max-width: 768px) {

            .recovery-help-content {

                width: 95%;

                max-height: 90vh;

            }



            .recovery-option {

                flex-direction: column;

                text-align: center;

                gap: 12px;

            }



            .recovery-icon {

                min-width: auto;

            }

        }



        /* åŒæ­¥çŠ¶æ€æ ·å¼ */

        #sync-data-btn {

            transition: all 0.3s ease;

        }



        #sync-data-btn.sync-enabled {

            background-color: #4caf50 !important;

            color: white;

        }



        #sync-data-btn.sync-warning {

            background-color: #ff9800 !important;

            color: white;

        }

        

        /* ä¿å­˜æŒ‰é’®é—ªçƒåŠ¨ç”» */

        @keyframes pulse {

            0% {

                transform: scale(1);

                opacity: 1;

            }

            50% {

                transform: scale(1.05);

                opacity: 0.8;

            }

            100% {

                transform: scale(1);

                opacity: 1;

            }

        }

        

        /* ä¿å­˜æŒ‰é’®ç‰¹æ®Šæ ·å¼ */

        #force-save-btn {

            transition: all 0.3s ease;

            font-weight: 600;

        }

        

        #force-save-btn:hover {

            background: #45a049 !important;

            transform: translateY(-1px);

            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);

        }

    </style>

</head>



<body>

    <div class="container">

        <!-- é¡µé¢å¤´éƒ¨ -->

        <div class="page-header">

            <a href="index.html" class="back-to-home">â† è¿”å›ä¸»é¡µ</a>

            <h1 class="page-title">ğŸ“… æœˆåº¦æ—¥ç¨‹ç®¡ç†</h1>

            <div style="display: flex; gap: 8px;">

                <a href="month_plan.html" class="btn-main" style="font-size: 0.9em;">æœˆè®¡åˆ’</a>

                <button type="button" id="today-btn" class="btn-main">ğŸ“ ä»Šå¤©</button>

            </div>

        </div>

        <!-- AIæ™ºèƒ½åˆ†æåŒºåŸŸ - æ”¾åœ¨æœ€é¡¶éƒ¨ -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">
                <div style="flex: 1;">
                    <h3 style="color: white; margin: 0 0 8px 0; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                        ğŸ¤– AI æ™ºèƒ½åˆ†æ
                        <span style="font-size: 0.5em; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px;">Gemini 2.5 Pro</span>
                    </h3>
                    <p style="color: rgba(255,255,255,0.95); margin: 0; font-size: 1em; line-height: 1.6;">
                        è®© AI åˆ†ææ‚¨çš„æœˆåº¦æ—¥ç¨‹ï¼Œæä¾›æ—¶é—´ç®¡ç†å»ºè®®å’Œæ—¥ç¨‹ä¼˜åŒ–æ–¹æ¡ˆ
                    </p>
                </div>
                <button type="button" onclick="startAIAnalysis()" style="background: white; color: #667eea; border: none; padding: 16px 40px; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; white-space: nowrap;">
                    ğŸš€ å¼€å§‹åˆ†æ
                </button>
            </div>
        </div>



        <!-- æ—¥å†è§†å›¾ -->

        <div class="calendar-container">

            <div class="calendar-header">

                <div class="calendar-nav">

                    <button type="button" id="prev-month">â† ä¸Šæœˆ</button>

                    <button type="button" id="today-nav">ä»Šå¤©</button>

                    <button type="button" id="next-month">ä¸‹æœˆ â†’</button>

                </div>

                <div class="calendar-month-year" id="calendar-title">2024å¹´1æœˆ</div>

                <div style="display: flex; gap: 8px;">

                    <button type="button" id="calendar-view-btn" class="btn-main">ğŸ“‹ åˆ—è¡¨è§†å›¾</button>

                    <button type="button" id="one-click-fix-btn" class="btn-main" style="background: #ff9800; color: white;">ğŸ”§ ä¸€é”®ä¿®å¤</button>

                    <button type="button" id="sync-settings-btn" class="btn-main">âš™ï¸ åŒæ­¥è®¾ç½®</button>

                    <button type="button" id="force-save-btn" class="btn-main" style="background: #4caf50; color: white;">ğŸ’¾ ä¿å­˜</button>
                    <button type="button" id="cloud-restore-btn" class="btn-main" style="background: #2196f3; color: white;">â˜ï¸ äº‘ç«¯æ¢å¤</button>
                    <button type="button" id="reset-help-btn" class="btn-main" style="background: #2196f3; color: white; display: none;">ğŸ”„ é‡ç½®åŠ©æ‰‹</button>

                </div>

            </div>



            <div class="calendar-grid" id="calendar-grid">

                <!-- æ˜ŸæœŸæ ‡é¢˜ -->

                <div class="calendar-weekday">æ—¥</div>

                <div class="calendar-weekday">ä¸€</div>

                <div class="calendar-weekday">äºŒ</div>

                <div class="calendar-weekday">ä¸‰</div>

                <div class="calendar-weekday">å››</div>

                <div class="calendar-weekday">äº”</div>

                <div class="calendar-weekday">å…­</div>

                <!-- æ—¥æœŸæ ¼å­å°†åŠ¨æ€ç”Ÿæˆ -->

            </div>

        </div>



        <!-- æ—¥ç¨‹ç®¡ç†é¢æ¿ -->

        <div class="schedule-panel">

            <!-- ä¾§è¾¹æ  -->

            <div class="schedule-sidebar">

                <h3 style="margin: 0 0 16px 0; color: var(--theme-color);">â• æ·»åŠ æ—¥ç¨‹</h3>

                

                <div class="event-form">

                    <input type="text" id="event-title" placeholder="æ—¥ç¨‹æ ‡é¢˜">

                    <input type="date" id="event-date">

                    <input type="time" id="event-time">

                    <select id="event-category">

                        <option value="work">ğŸ’¼ å·¥ä½œ</option>

                        <option value="personal">ğŸ‘¤ ä¸ªäºº</option>

                        <option value="health">ğŸƒ å¥åº·</option>

                        <option value="learning">ğŸ“š å­¦ä¹ </option>

                        <option value="social">ğŸ‘¥ ç¤¾äº¤</option>

                        <option value="other">ğŸ“‹ å…¶ä»–</option>

                    </select>

                    <textarea id="event-description" placeholder="å¤‡æ³¨è¯´æ˜..." rows="3"></textarea>

                    <button type="button" id="add-event-btn" class="btn-main" style="width: 100%;">æ·»åŠ æ—¥ç¨‹</button>

                </div>



                <div style="margin-top: 24px;">

                    <h4 style="margin: 0 0 12px 0; color: var(--theme-color);">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h4>

                    <div style="background: rgba(25,118,210,0.05); padding: 12px; border-radius: 8px;">

                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">

                            <span>æœ¬æœˆæ—¥ç¨‹:</span>

                            <span id="month-events-count" style="font-weight: 600; color: var(--theme-color);">0</span>

                        </div>

                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">

                            <span>ä»Šæ—¥æ—¥ç¨‹:</span>

                            <span id="today-events-count" style="font-weight: 600; color: #4caf50;">0</span>

                        </div>

                        <div style="display: flex; justify-content: space-between;">

                            <span>æœ¬å‘¨æ—¥ç¨‹:</span>

                            <span id="week-events-count" style="font-weight: 600; color: #ff9800;">0</span>

                        </div>

                    </div>

                </div>

            </div>



            <!-- ä¸»å†…å®¹åŒº -->

            <div class="schedule-main">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">

                    <h3 style="margin: 0; color: var(--theme-color);" id="selected-date-title">é€‰æ‹©æ—¥æœŸæŸ¥çœ‹æ—¥ç¨‹</h3>

                    <div style="display: flex; gap: 8px;">

                        <button type="button" id="clear-day-btn" class="btn-danger" style="display: none;">æ¸…ç©ºå½“æ—¥</button>

                        <button type="button" id="copy-day-btn" class="btn-main" style="display: none;">å¤åˆ¶æ—¥ç¨‹</button>

                    </div>

                </div>



                <div id="selected-day-events" class="event-list">

                    <div style="text-align: center; padding: 40px; color: #666;">

                        <div style="font-size: 3em; margin-bottom: 16px;">ğŸ“…</div>

                        <p>ç‚¹å‡»æ—¥å†ä¸Šçš„æ—¥æœŸæŸ¥çœ‹å½“å¤©çš„æ—¥ç¨‹å®‰æ’</p>

                    </div>

                </div>

            </div>

        </div>



        <!-- å¿«æ·æ“ä½œ -->

        <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; margin-bottom: 24px;">

            <h4 style="margin: 0 0 12px 0; color: var(--theme-color);">âš¡ å¿«æ·æ“ä½œ</h4>

            <div style="display: flex; gap: 8px; flex-wrap: wrap;">

                <button type="button" class="quick-add-btn" data-title="å›¢é˜Ÿä¼šè®®" data-time="10:00">ğŸ¤ å›¢é˜Ÿä¼šè®®</button>

                <button type="button" class="quick-add-btn" data-title="åˆé¤æ—¶é—´" data-time="12:00">ğŸ½ï¸ åˆé¤æ—¶é—´</button>

                <button type="button" class="quick-add-btn" data-title="å¥èº«é”»ç‚¼" data-time="18:00">ğŸ’ª å¥èº«é”»ç‚¼</button>

                <button type="button" class="quick-add-btn" data-title="å­¦ä¹ æ—¶é—´" data-time="20:00">ğŸ“š å­¦ä¹ æ—¶é—´</button>

                <button type="button" class="quick-add-btn" data-title="å®¶åº­æ—¶é—´" data-time="19:00">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­æ—¶é—´</button>

            </div>

        </div>

    </div>

    




    <script src="common.js"></script>

    <script>

        // æœˆåº¦æ—¥ç¨‹ç®¡ç†

        let currentCalendarMonth = new Date();

        let selectedDate = null;

        let monthlyEvents = loadAndCleanData();

        // å®‰å…¨çš„æ•°æ®åŠ è½½å‡½æ•°ï¼ˆæ”¯æŒä»äº‘åŒæ­¥é”®æ¢å¤ï¼‰
        function loadAndCleanData() {
            try {
                // ä¼˜å…ˆä½¿ç”¨æœ¬åœ° monthlyEventsï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°è¯•ä»äº‘åŒæ­¥é”®æ¢å¤
                let rawData = localStorage.getItem('monthlyEvents');
                if (!rawData) {
                    const cloudData = localStorage.getItem('planData_monthlyEvents');
                    if (cloudData) {
                        console.log('â˜ï¸ ä»äº‘åŒæ­¥é”®æ¢å¤ monthlyEvents æ•°æ®');
                        rawData = cloudData;
                        // å°†äº‘ç«¯æ•°æ®å†™å›æœ¬åœ°ä¸»é”®ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
                        try {
                            localStorage.setItem('monthlyEvents', rawData);
                        } catch (e) {
                            console.warn('âš ï¸ å°†äº‘ç«¯æ•°æ®å†™å› monthlyEvents å¤±è´¥:', e);
                        }
                    }
                }
                if (!rawData) {
                    console.log('ğŸ”„ æ²¡æœ‰æ‰¾åˆ°æœ¬åœ°æ•°æ®ï¼Œåˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡');
                    return {};
                }
                
                // å°è¯•è§£æJSON
                let parsedData;
                try {
                    parsedData = JSON.parse(rawData);
                } catch (parseError) {
                    console.error('âŒ JSONè§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤:', parseError);
                    // å°è¯•ä¿®å¤å¸¸è§çš„JSONé—®é¢˜
                    const fixedJson = rawData.replace(/[\x00-\x1F\x7F-\x9F]/g, '')
                                           .replace(/\uFEFF/g, '')
                                           .replace(/Ã‚+/g, '');
                    try {
                        parsedData = JSON.parse(fixedJson);
                        console.log('âœ… JSONä¿®å¤æˆåŠŸ');
                    } catch (fixError) {
                        console.error('âŒ JSONä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨ç©ºå¯¹è±¡:', fixError);
                        return {};
                    }
                }
                
                // æ¸…ç†å’ŒéªŒè¯æ•°æ®
                const cleanedData = cleanupEventData(parsedData || {});
                console.log('âœ… æ•°æ®åŠ è½½å’Œæ¸…ç†å®Œæˆ');
                return cleanedData;
                
            } catch (error) {
                console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', error);
                return {};
            }
        }

        // å¼ºåˆ¶ä»äº‘ç«¯æ¢å¤æ•°æ®ï¼ˆé€‚ç”¨äºæ¸…é™¤æµè§ˆå™¨æ•°æ®åï¼‰
        async function forceRestoreFromCloud() {
            if (!window.syncService) {
                MessageUtils.error('åŒæ­¥æœåŠ¡æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            const confirmed = confirm(
                'â˜ï¸ å¼ºåˆ¶äº‘ç«¯æ¢å¤\n\n' +
                'æ­¤åŠŸèƒ½å°†ä»äº‘ç«¯å¼ºåˆ¶æ¢å¤æ‰€æœ‰æœˆåº¦æ•°æ®ï¼Œé€‚ç”¨äºï¼š\n' +
                'â€¢ æ¸…é™¤äº†æµè§ˆå™¨æ•°æ®å\n' +
                'â€¢ æœ¬åœ°æ•°æ®ä¸¢å¤±æˆ–æŸå\n' +
                'â€¢ éœ€è¦æ¢å¤ä¹‹å‰çš„äº‘ç«¯å¤‡ä»½\n\n' +
                'âš ï¸ æ³¨æ„ï¼šè¿™å°†è¦†ç›–å½“å‰æœ¬åœ°æ•°æ®ï¼\n\n' +
                'ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
            );

            if (!confirmed) return;

            try {
                MessageUtils.info('ğŸ”„ æ­£åœ¨ä»äº‘ç«¯å¼ºåˆ¶æ¢å¤æ•°æ®...');
                
                // è°ƒç”¨ LeanCloud çš„å¼ºåˆ¶æ¢å¤åŠŸèƒ½
                if (window.syncService.restoreFromCloud) {
                    await window.syncService.restoreFromCloud(true); // true = å¼ºåˆ¶æ¢å¤
                } else {
                    // å¦‚æœæ²¡æœ‰ restoreFromCloud æ–¹æ³•ï¼Œä½¿ç”¨ manualSync ä½œä¸ºæ›¿ä»£
                    await window.syncService.manualSync();
                }
                
                // é‡æ–°åŠ è½½æ•°æ®å¹¶æ›´æ–°ç•Œé¢
                monthlyEvents = loadAndCleanData();
                renderCalendar();
                updateEventStats();
                
                if (selectedDate) {
                    displaySelectedDayEvents(selectedDate);
                }
                
                MessageUtils.success('âœ… äº‘ç«¯æ•°æ®æ¢å¤å®Œæˆï¼');
                
            } catch (error) {
                console.error('âŒ äº‘ç«¯æ¢å¤å¤±è´¥:', error);
                MessageUtils.error('äº‘ç«¯æ¢å¤å¤±è´¥: ' + error.message);
            }
        }

        // æ•°æ®æ¸…ç†å’ŒéªŒè¯å‡½æ•° - å¢å¼ºç‰ˆæœ¬
        function sanitizeText(text) {
            if (typeof text !== 'string') {
                return String(text || '');
            }
            
            // å¤„ç†å„ç§ç¼–ç é—®é¢˜
            let cleaned = text;
            
            // ç¬¬ä¸€è½®ï¼šå¤„ç†å¸¸è§çš„UTF-8ç¼–ç é—®é¢˜
            cleaned = cleaned.replace(/Ã‚+/g, '') // ç§»é™¤å¤šä½™çš„Ã‚å­—ç¬¦
                           .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€Â¢/g, "'") // ä¿®å¤æ™ºèƒ½å¼•å·
                           .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã‚/g, 'â€“') // ä¿®å¤ç ´æŠ˜å·
                           .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã…"/g, '"') // ä¿®å¤å·¦åŒå¼•å·
                           .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã‚/g, '"') // ä¿®å¤å³åŒå¼•å·
                           .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Å“/g, 'â€”') // ä¿®å¤é•¿ç ´æŠ˜å·
                           .replace(/[\u00C2\u00A0]/g, ' ') // æ›¿æ¢ä¸é—´æ–­ç©ºæ ¼
                           .replace(/[\x00-\x1F\x7F-\x9F]/g, '') // ç§»é™¤æ§åˆ¶å­—ç¬¦
                           .replace(/\uFEFF/g, '') // ç§»é™¤BOM
                           .replace(/\u200B/g, '') // ç§»é™¤é›¶å®½ç©ºæ ¼
                           .replace(/\u00A0/g, ' ') // æ›¿æ¢ä¸é—´æ–­ç©ºæ ¼ä¸ºæ™®é€šç©ºæ ¼
                           .replace(/\u2028/g, '') // ç§»é™¤è¡Œåˆ†éš”ç¬¦
                           .replace(/\u2029/g, ''); // ç§»é™¤æ®µè½åˆ†éš”ç¬¦
            
            // ç¬¬äºŒè½®ï¼šå¤„ç†å¯èƒ½çš„åŒé‡ç¼–ç é—®é¢˜
            try {
                // å°è¯•è§£ç å¯èƒ½çš„åŒé‡ç¼–ç 
                if (cleaned.includes('Ã‚') || cleaned.includes('\u00C2')) {
                    // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ï¼Œç„¶åé‡æ–°è§£ç 
                    const bytes = [];
                    for (let i = 0; i < cleaned.length; i++) {
                        const code = cleaned.charCodeAt(i);
                        if (code <= 0xFF) {
                            bytes.push(code);
                        } else {
                            // å¯¹äºéASCIIå­—ç¬¦ï¼Œä¿æŒåŸæ ·
                            bytes.push(code);
                        }
                    }
                    
                    // é‡æ–°æ„å»ºå­—ç¬¦ä¸²ï¼Œè·³è¿‡é—®é¢˜å­—ç¬¦
                    let rebuilt = '';
                    for (let i = 0; i < bytes.length; i++) {
                        const byte = bytes[i];
                        if (byte === 0xC2 && i + 1 < bytes.length && bytes[i + 1] >= 0x80 && bytes[i + 1] <= 0xBF) {
                            // è·³è¿‡UTF-8çš„Ã‚å­—ç¬¦åºåˆ—
                            i++; // è·³è¿‡ä¸‹ä¸€ä¸ªå­—èŠ‚
                            continue;
                        } else if (byte >= 32 && byte <= 126) {
                            // åªä¿ç•™å¯æ‰“å°çš„ASCIIå­—ç¬¦
                            rebuilt += String.fromCharCode(byte);
                        } else if (byte > 127) {
                            // ä¿ç•™éASCIIå­—ç¬¦ï¼ˆå¯èƒ½æ˜¯æ­£å¸¸çš„ä¸­æ–‡ç­‰ï¼‰
                            rebuilt += String.fromCharCode(byte);
                        }
                    }
                    cleaned = rebuilt;
                }
            } catch (error) {
                console.warn('å­—ç¬¦è§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ¸…ç†:', error);
            }
            
            // ç¬¬ä¸‰è½®ï¼šæœ€ç»ˆæ¸…ç†
            cleaned = cleaned.replace(/\s+/g, ' ') // åˆå¹¶å¤šä¸ªç©ºæ ¼
                           .trim();
            
            // å¦‚æœæ¸…ç†åä¸ºç©ºæˆ–åªæœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
            if (!cleaned || /^[\s\u00A0\u200B\uFEFF\u2028\u2029]*$/.test(cleaned)) {
                return '';
            }
            
            return cleaned;
        }

        function cleanupEventData(events) {
            const cleaned = {};
            
            if (!events || typeof events !== 'object') {
                console.warn('âš ï¸ æ— æ•ˆçš„äº‹ä»¶æ•°æ®æ ¼å¼ï¼Œè¿”å›ç©ºå¯¹è±¡');
                return {};
            }
            
            for (const [date, eventList] of Object.entries(events)) {
                // éªŒè¯æ—¥æœŸæ ¼å¼
                if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                    console.warn('âš ï¸ è·³è¿‡æ— æ•ˆæ—¥æœŸæ ¼å¼:', date);
                    continue;
                }
                
                if (!Array.isArray(eventList)) {
                    console.warn('âš ï¸ è·³è¿‡éæ•°ç»„äº‹ä»¶åˆ—è¡¨:', date);
                    continue;
                }
                
                const validEvents = eventList.filter(event => {
                    if (!event || typeof event !== 'object') {
                        console.warn('âš ï¸ è·³è¿‡æ— æ•ˆäº‹ä»¶å¯¹è±¡:', event);
                        return false;
                    }
                    
                    const hasTitle = event.title && typeof event.title === 'string';
                    const hasTime = event.time && typeof event.time === 'string';
                    
                    if (!hasTitle || !hasTime) {
                        console.warn('âš ï¸ è·³è¿‡ç¼ºå°‘å¿…éœ€å­—æ®µçš„äº‹ä»¶:', event);
                        return false;
                    }
                    
                    return true;
                }).map(event => {
                    const cleanedTitle = sanitizeText(event.title);
                    const cleanedTime = sanitizeText(event.time);
                    
                    // å¦‚æœæ¸…ç†åçš„æ ‡é¢˜æˆ–æ—¶é—´ä¸ºç©ºï¼Œè·³è¿‡æ­¤äº‹ä»¶
                    if (!cleanedTitle || !cleanedTime) {
                        console.warn('âš ï¸ æ¸…ç†åæ ‡é¢˜æˆ–æ—¶é—´ä¸ºç©ºï¼Œè·³è¿‡äº‹ä»¶');
                        return null;
                    }
                    
                    return {
                        title: cleanedTitle,
                        time: cleanedTime,
                        category: sanitizeText(event.category || 'other') || 'other',
                        description: sanitizeText(event.description || ''),
                        createdAt: event.createdAt || new Date().toISOString()
                    };
                }).filter(event => event !== null); // ç§»é™¤nullå€¼
                
                if (validEvents.length > 0) {
                    cleaned[date] = validEvents;
                }
            }
            
            console.log(`âœ… æ•°æ®æ¸…ç†å®Œæˆï¼Œæœ‰æ•ˆæ—¥æœŸ: ${Object.keys(cleaned).length}`);
            return cleaned;
        }

        function validateAndCleanData() {
            try {
                monthlyEvents = cleanupEventData(monthlyEvents);
                const jsonForValidate = JSON.stringify(monthlyEvents);
                // åŒæ­¥å†™å…¥æœ¬åœ°é”®å’Œäº‘åŒæ­¥é”®
                localStorage.setItem('monthlyEvents', jsonForValidate);
                localStorage.setItem('planData_monthlyEvents', jsonForValidate);
                console.log('âœ… æ•°æ®å·²æ¸…ç†å’ŒéªŒè¯');
            } catch (error) {
                console.error('âŒ æ•°æ®æ¸…ç†å¤±è´¥:', error);
                // å¦‚æœæ•°æ®ä¸¥é‡æŸåï¼Œå°è¯•æ¢å¤å¤‡ä»½
                initDataRecovery();
            }
        }



        document.addEventListener('DOMContentLoaded', function() {

            // ç«‹å³å¼ºåˆ¶æ¸…ç†æ‰€æœ‰æŸåæ•°æ®

            emergencyDataCleanup();

            // æ‰§è¡Œä¸“é—¨çš„15å·ç­‰æŸåæ•°æ®æ¸…ç†
            setTimeout(() => {
                if (typeof forceCleanSpecificDates === 'function') {
                    forceCleanSpecificDates();
                }
            }, 500);

            // ğŸ”„ ç­‰å¾…åŒæ­¥æœåŠ¡å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–æœˆåº¦æ—¥ç¨‹
            waitForSyncServiceThenInit();

            // ğŸ›¡ï¸ é¡µé¢åŠ è½½åç«‹å³éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼ˆç‰¹åˆ«é’ˆå¯¹æ‰‹æœºç«¯åˆ·æ–°é—®é¢˜ï¼‰
            setTimeout(() => {
                const currentData = localStorage.getItem('monthlyEvents');
                const cloudData = localStorage.getItem('planData_monthlyEvents');
                
                if (!currentData && cloudData) {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°æœ¬åœ°æ•°æ®ä¸¢å¤±ï¼Œä»äº‘åŒæ­¥é”®æ¢å¤...');
                    localStorage.setItem('monthlyEvents', cloudData);
                    monthlyEvents = loadAndCleanData();
                    renderCalendar();
                    updateEventStats();
                    MessageUtils.info('å·²è‡ªåŠ¨ä»äº‘ç«¯æ¢å¤æ•°æ®');
                } else if (currentData) {
                    console.log('âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡');
                } else {
                    console.log('ğŸ’¡ æ²¡æœ‰å‘ç°æœ¬åœ°æ•°æ®');
                }
            }, 100);

        });

        // ğŸ”„ ç­‰å¾…åŒæ­¥æœåŠ¡åŠ è½½å®Œæˆååˆå§‹åŒ–
        function waitForSyncServiceThenInit() {
            let attempts = 0;
            const maxAttempts = 20; // æœ€å¤šç­‰å¾…10ç§’

            function checkSyncService() {
                attempts++;
                
                if (window.syncService) {
                    console.log('âœ… åŒæ­¥æœåŠ¡å·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–æœˆåº¦æ—¥ç¨‹');
                    initMonthlySchedule();
                } else if (attempts < maxAttempts) {
                    console.log(`â³ ç­‰å¾…åŒæ­¥æœåŠ¡åŠ è½½... (${attempts}/${maxAttempts})`);
                    setTimeout(checkSyncService, 500);
                } else {
                    console.warn('âš ï¸ åŒæ­¥æœåŠ¡åŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼åˆå§‹åŒ–');
                    initMonthlySchedule();
                }
            }

            checkSyncService();
        }

        // ğŸ›¡ï¸ é¡µé¢å¸è½½ä¿æŠ¤ - ç¡®ä¿æ•°æ®åœ¨é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', function(e) {
            if (Object.keys(monthlyEvents).length > 0) {
                try {
                    // å¼ºåˆ¶ä¿å­˜å½“å‰æ•°æ®åˆ°æœ¬åœ°å’Œäº‘åŒæ­¥é”®
                    const jsonString = JSON.stringify(monthlyEvents);
                    localStorage.setItem('monthlyEvents', jsonString);
                    localStorage.setItem('planData_monthlyEvents', jsonString);
                    console.log('ğŸ›¡ï¸ é¡µé¢å¸è½½å‰å¼ºåˆ¶ä¿å­˜æ•°æ®');
                } catch (error) {
                    console.error('âŒ é¡µé¢å¸è½½ä¿å­˜å¤±è´¥:', error);
                }
            }
        });

        // ğŸ”„ é¡µé¢éšè—æ—¶ä¿å­˜æ•°æ®ï¼ˆç§»åŠ¨ç«¯ç‰¹åˆ«é‡è¦ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && Object.keys(monthlyEvents).length > 0) {
                try {
                    const jsonString = JSON.stringify(monthlyEvents);
                    localStorage.setItem('monthlyEvents', jsonString);
                    localStorage.setItem('planData_monthlyEvents', jsonString);
                    console.log('ğŸ“± é¡µé¢éšè—æ—¶ä¿å­˜æ•°æ®');
                    
                    // å¦‚æœåŒæ­¥æœåŠ¡å¯ç”¨ï¼Œç«‹å³åŒæ­¥
                    if (window.syncService && window.syncService.getSyncStatus().enabled) {
                        window.syncService.manualSync().catch(error => {
                            console.warn('âš ï¸ é¡µé¢éšè—æ—¶åŒæ­¥å¤±è´¥:', error);
                        });
                    }
                } catch (error) {
                    console.error('âŒ é¡µé¢éšè—ä¿å­˜å¤±è´¥:', error);
                }
            }
        });

        

        // ç´§æ€¥æ•°æ®æ¸…ç† - é¡µé¢åŠ è½½æ—¶ç«‹å³æ‰§è¡Œ

        function emergencyDataCleanup() {

            try {

                console.log('ğŸš¨ æ‰§è¡Œç´§æ€¥æ•°æ®æ¸…ç†...');

                

                const rawData = localStorage.getItem('monthlyEvents');

                if (!rawData) {

                    console.log('ğŸ’¡ æ²¡æœ‰æ•°æ®éœ€è¦æ¸…ç†');

                    return;

                }

                

                // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•ç¼–ç é—®é¢˜

                const hasEncodingIssues = rawData.includes('Ã‚') || 

                                        rawData.includes('\u00C2') ||

                                        rawData.includes('ÃƒÂ¢') ||

                                        rawData.includes('Ã¢â‚¬') ||

                                        rawData.includes('Ã¢â€Â¢') ||

                                        rawData.includes('Ã…"');

                

                if (hasEncodingIssues) {

                    console.log('ğŸš¨ æ£€æµ‹åˆ°ä¸¥é‡ç¼–ç é—®é¢˜ï¼Œæ‰§è¡Œå¼ºåˆ¶æ¸…ç†...');

                    

                    // æš´åŠ›æ¸…ç†æ‰€æœ‰å¯èƒ½çš„ç¼–ç é—®é¢˜

                    let cleanedJson = rawData

                        // ç§»é™¤æ‰€æœ‰Ã‚ç›¸å…³å­—ç¬¦

                        .replace(/Ã‚+/g, '')

                        .replace(/[\u00C2]/g, '')

                        

                        // ç§»é™¤å¤æ‚çš„UTF-8ç¼–ç é”™è¯¯

                        .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€Â¢/g, "'")

                        .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã‚/g, 'â€“')

                        .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã…"/g, '"')

                        .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Å“/g, 'â€”')

                        .replace(/ÃƒÂ¢Ã¢â€šÂ¬/g, '')

                        .replace(/Ã¢â‚¬â„¢/g, "'")

                        .replace(/Ã¢â‚¬Å“/g, '"')

                        .replace(/Ã¢â‚¬/g, '"')

                        .replace(/Ã¢â€Â¢/g, '')

                        .replace(/Ã…"/g, '"')

                        .replace(/Ã‚Â®/g, '')

                        

                        // ç§»é™¤æ‰€æœ‰æ§åˆ¶å­—ç¬¦å’Œç‰¹æ®Šå­—ç¬¦

                        .replace(/[\x00-\x1F\x7F-\x9F]/g, '')

                        .replace(/\uFEFF/g, '')

                        .replace(/\u200B/g, '')

                        .replace(/\u00A0/g, ' ')

                        .replace(/\u2028/g, '')

                        .replace(/\u2029/g, '')

                        

                        // æ¸…ç†å¯èƒ½çš„åŒå­—èŠ‚é—®é¢˜

                        .replace(/[\u0080-\u009F]/g, '')

                        .replace(/[\u00A0-\u00FF]/g, function(match) {

                            // åªä¿ç•™å¸¸è§çš„æœ‰ç”¨å­—ç¬¦

                            const code = match.charCodeAt(0);

                            if (code === 0x00A0) return ' '; // ä¸é—´æ–­ç©ºæ ¼è½¬ä¸ºæ™®é€šç©ºæ ¼

                            if (code >= 0x00C0 && code <= 0x00FF) return ''; // ç§»é™¤æ‰©å±•æ‹‰ä¸å­—ç¬¦

                            return match;

                        });

                    

                    try {

                        // å°è¯•è§£ææ¸…ç†åçš„JSON

                        const parsedData = JSON.parse(cleanedJson);

                        

                        // æ·±åº¦æ¸…ç†è§£æåçš„æ•°æ®

                        const deepCleanedData = {};

                        

                        for (const [date, events] of Object.entries(parsedData)) {

                            if (Array.isArray(events)) {

                                const cleanedEvents = events.map(event => {

                                    if (event && typeof event === 'object') {

                                        return {

                                            title: deepCleanText(event.title || ''),

                                            time: deepCleanText(event.time || ''),

                                            category: deepCleanText(event.category || 'other'),

                                            description: deepCleanText(event.description || ''),

                                            createdAt: event.createdAt || new Date().toISOString()

                                        };

                                    }

                                    return null;

                                }).filter(event => event && event.title && event.time);

                                

                                if (cleanedEvents.length > 0) {

                                    deepCleanedData[date] = cleanedEvents;

                                }

                            }

                        }

                        

                        // ä¿å­˜æ¸…ç†åçš„æ•°æ®

                        const finalJson = JSON.stringify(deepCleanedData);

                        // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°é”®å’Œäº‘åŒæ­¥é”®
                        localStorage.setItem('monthlyEvents', finalJson);
                        localStorage.setItem('planData_monthlyEvents', finalJson);

                        

                        // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®

                        monthlyEvents = deepCleanedData;

                        

                        console.log('âœ… ç´§æ€¥æ•°æ®æ¸…ç†å®Œæˆï¼Œæ¸…ç†äº†ç¼–ç é—®é¢˜');

                        

                        // æ˜¾ç¤ºæ¸…ç†ç»“æœ

                        const eventCount = Object.values(deepCleanedData).reduce((total, events) => total + events.length, 0);

                        console.log(`ğŸ“Š æ¸…ç†ç»“æœ: ${Object.keys(deepCleanedData).length} å¤©ï¼Œ${eventCount} ä¸ªäº‹ä»¶`);

                        

                    } catch (parseError) {

                        console.error('âŒ æ¸…ç†åä»æ— æ³•è§£æJSONï¼Œé‡ç½®æ•°æ®:', parseError);

                        localStorage.removeItem('monthlyEvents');

                        monthlyEvents = {};

                        

                        alert('æ£€æµ‹åˆ°ä¸¥é‡çš„æ•°æ®æŸåï¼Œå·²é‡ç½®ä¸ºç©ºæ•°æ®ã€‚è¯·é‡æ–°æ·»åŠ æ‚¨çš„æ—¥ç¨‹ã€‚');

                    }

                } else {

                    console.log('âœ… æ•°æ®æ£€æŸ¥é€šè¿‡ï¼Œæ— éœ€ç´§æ€¥æ¸…ç†');

                }

            } catch (error) {

                console.error('âŒ ç´§æ€¥æ•°æ®æ¸…ç†å¤±è´¥:', error);

            }

        }

        

        // æ·±åº¦æ–‡æœ¬æ¸…ç†å‡½æ•°

        function deepCleanText(text) {

            if (typeof text !== 'string') {

                return String(text || '');

            }

            

            let cleaned = text;

            

            // æš´åŠ›æ¸…ç†æ‰€æœ‰å¯èƒ½çš„ç¼–ç é—®é¢˜

            cleaned = cleaned

                .replace(/Ã‚+/g, '')

                .replace(/[\u00C2]/g, '')

                .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€Â¢/g, "'")

                .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã‚/g, 'â€“')

                .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã…"/g, '"')

                .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Å“/g, 'â€”')

                .replace(/ÃƒÂ¢Ã¢â€šÂ¬/g, '')

                .replace(/Ã¢â‚¬â„¢/g, "'")

                .replace(/Ã¢â‚¬Å“/g, '"')

                .replace(/Ã¢â‚¬/g, '"')

                .replace(/Ã¢â€Â¢/g, '')

                .replace(/Ã…"/g, '"')

                .replace(/Ã‚Â®/g, '')

                .replace(/[\x00-\x1F\x7F-\x9F]/g, '')

                .replace(/\uFEFF/g, '')

                .replace(/\u200B/g, '')

                .replace(/\u00A0/g, ' ')

                .replace(/\u2028/g, '')

                .replace(/\u2029/g, '')

                .replace(/[\u0080-\u009F]/g, '')

                .replace(/\s+/g, ' ')

                .trim();

            

            // å¦‚æœæ¸…ç†åä¸ºç©ºæˆ–åªæœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²

            if (!cleaned || /^[\s\u00A0\u200B\uFEFF\u2028\u2029]*$/.test(cleaned)) {

                return '';

            }

            

            return cleaned;

        }

        

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œé‡æ–°åŠ è½½æ•°æ®

        document.addEventListener('visibilitychange', function() {

            if (!document.hidden) {

                console.log('ğŸ”„ é¡µé¢é‡æ–°å¯è§ï¼Œæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§');

                reloadAndValidateData();

            }

        });

        

        // ç›‘å¬çª—å£ç„¦ç‚¹å˜åŒ–

        window.addEventListener('focus', function() {

            console.log('ğŸ”„ çª—å£è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§');

            reloadAndValidateData();

        });

        

        // ç«‹å³ä¿®å¤ç°æœ‰æŸåæ•°æ®

        function repairCorruptedData() {

            try {

                console.log('ğŸ”§ å¼€å§‹ä¿®å¤æŸåçš„æ•°æ®...');

                

                const rawData = localStorage.getItem('monthlyEvents');

                if (!rawData) {

                    console.log('ğŸ’¡ æ²¡æœ‰æ•°æ®éœ€è¦ä¿®å¤');

                    return;

                }

                

                // æ£€æŸ¥æ˜¯å¦åŒ…å«æŸåçš„å­—ç¬¦

                if (rawData.includes('Ã‚') || rawData.includes('\u00C2')) {

                    console.log('ğŸš¨ æ£€æµ‹åˆ°æŸåçš„æ•°æ®ï¼Œå¼€å§‹ä¿®å¤...');

                    

                    // æ·±åº¦æ¸…ç†JSONå­—ç¬¦ä¸²

                    let cleanedJson = rawData;

                    

                    // ä¿®å¤å¸¸è§çš„ç¼–ç é—®é¢˜

                    cleanedJson = cleanedJson.replace(/Ã‚+/g, '') // ç§»é™¤Ã‚å­—ç¬¦

                                           .replace(/[\u00C2]/g, '') // ç§»é™¤C2å­—ç¬¦

                                           .replace(/[\x00-\x1F\x7F-\x9F]/g, '') // ç§»é™¤æ§åˆ¶å­—ç¬¦

                                           .replace(/\uFEFF/g, '') // ç§»é™¤BOM

                                           .replace(/\u200B/g, '') // ç§»é™¤é›¶å®½ç©ºæ ¼

                                           .replace(/\u00A0/g, ' ') // æ›¿æ¢ä¸é—´æ–­ç©ºæ ¼

                                           .replace(/\u2028/g, '') // ç§»é™¤è¡Œåˆ†éš”ç¬¦

                                           .replace(/\u2029/g, ''); // ç§»é™¤æ®µè½åˆ†éš”ç¬¦

                    

                    // å°è¯•è§£æä¿®å¤åçš„JSON

                    try {

                        const parsedData = JSON.parse(cleanedJson);

                        const repairedData = cleanupEventData(parsedData);

                        

                        // ä¿å­˜ä¿®å¤åçš„æ•°æ®

                        const repairedJson = JSON.stringify(repairedData);

                        // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°é”®å’Œäº‘åŒæ­¥é”®
                        localStorage.setItem('monthlyEvents', repairedJson);
                        localStorage.setItem('planData_monthlyEvents', repairedJson);

                        

                        // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®

                        monthlyEvents = repairedData;

                        

                        console.log('âœ… æ•°æ®ä¿®å¤æˆåŠŸ');

                        MessageUtils.success('æ£€æµ‹åˆ°æ•°æ®é—®é¢˜å·²è‡ªåŠ¨ä¿®å¤');

                        

                        return true;

                    } catch (parseError) {

                        console.error('âŒ ä¿®å¤åçš„JSONä»ç„¶æ— æ•ˆ:', parseError);

                        

                        // å¦‚æœä¿®å¤å¤±è´¥ï¼Œæ¸…ç©ºæ•°æ®

                        localStorage.removeItem('monthlyEvents');

                        monthlyEvents = {};

                        

                        MessageUtils.warning('æ•°æ®æŸåä¸¥é‡ï¼Œå·²é‡ç½®ä¸ºç©º');

                        return false;

                    }

                } else {

                    console.log('âœ… æ•°æ®å®Œæ•´ï¼Œæ— éœ€ä¿®å¤');

                    return true;

                }

            } catch (error) {

                console.error('âŒ æ•°æ®ä¿®å¤è¿‡ç¨‹å‡ºé”™:', error);

                return false;

            }

        }

        

        // å¼ºåˆ¶ä¿®å¤æ•°æ®ï¼ˆç”¨æˆ·æ‰‹åŠ¨è§¦å‘ï¼‰

        function forceRepairData() {

            if (confirm('è¿™å°†å¼ºåˆ¶ä¿®å¤æ‰€æœ‰æ•°æ®é—®é¢˜ï¼Œå¯èƒ½ä¼šä¸¢å¤±éƒ¨åˆ†æŸåçš„æ•°æ®ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')) {

                try {

                    console.log('ğŸ”§ ç”¨æˆ·è§¦å‘å¼ºåˆ¶æ•°æ®ä¿®å¤...');

                    

                    // 1. æ‰§è¡Œç´§æ€¥æ•°æ®æ¸…ç†

                    emergencyDataCleanup();

                    

                    // 2. ä¿®å¤localStorageä¸­çš„æ•°æ®

                    const repaired = repairCorruptedData();

                    

                    // 3. å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®

                    monthlyEvents = loadAndCleanData();

                    

                    // 4. å¼ºåˆ¶ä¿å­˜æ¸…ç†åçš„æ•°æ®

                    saveEvents();

                    

                    // 5. é‡æ–°æ¸²æŸ“æ‰€æœ‰è§†å›¾

                    renderCalendar();

                    updateEventStats();

                    

                    // 6. å¦‚æœæœ‰é€‰ä¸­çš„æ—¥æœŸï¼Œæ›´æ–°æ˜¾ç¤º

                    if (selectedDate) {

                        displaySelectedDayEvents(selectedDate);

                    }

                    

                    // 7. æ¸…ç†æ‰€æœ‰å¯èƒ½çš„ç¼“å­˜å’Œå¤‡ä»½

                    try {

                        sessionStorage.clear(); // æ¸…ç†æ‰€æœ‰sessionStorage

                        

                        // æ¸…ç†æ‰€æœ‰å¯èƒ½æŸåçš„localStorageé¡¹

                        const keysToCheck = [

                            'monthlyEventsTemp', 

                            'monthlyEventsBackup',

                            'backup_main', 

                            'backup_secondary', 

                            'backup_tertiary',

                            'monthlyBackups'

                        ];

                        

                        keysToCheck.forEach(key => {

                            const data = localStorage.getItem(key);

                            if (data && (data.includes('Ã‚') || data.includes('\u00C2') || data.includes('ÃƒÂ¢'))) {

                                localStorage.removeItem(key);

                                console.log(`ğŸ—‘ï¸ æ¸…ç†æŸåçš„æ•°æ®: ${key}`);

                            }

                        });

                        

                        // æ¸…ç†IndexedDB

                        if ('indexedDB' in window) {

                            try {

                                const deleteReq = indexedDB.deleteDatabase('PlanManagerDB');

                                deleteReq.onsuccess = () => console.log('ğŸ—‘ï¸ IndexedDBå·²æ¸…ç†');

                                deleteReq.onerror = () => console.warn('âš ï¸ IndexedDBæ¸…ç†å¤±è´¥');

                            } catch (idbError) {

                                console.warn('âš ï¸ IndexedDBæ¸…ç†å‡ºé”™:', idbError);

                            }

                        }

                        

                        // æ¸…ç†Cache API

                        if ('caches' in window) {

                            caches.delete('schedule-backup-v1').catch(error => {

                                console.warn('âš ï¸ Cacheæ¸…ç†å¤±è´¥:', error);

                            });

                        }

                        

                    } catch (cleanError) {

                        console.warn('æ¸…ç†ç¼“å­˜æ—¶å‡ºé”™:', cleanError);

                    }

                    

                    // 8. å¼ºåˆ¶é‡æ–°æ¸²æŸ“ï¼ˆç¡®ä¿æ¸…ç†ç”Ÿæ•ˆï¼‰

                    setTimeout(() => {

                        renderCalendar();

                        updateEventStats();

                        if (selectedDate) {

                            displaySelectedDayEvents(selectedDate);

                        }

                    }, 100);

                    

                    MessageUtils.success('æ•°æ®ä¿®å¤å®Œæˆï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥ç¡®ä¿ä¿®å¤ç”Ÿæ•ˆã€‚');

                    console.log('âœ… å¼ºåˆ¶æ•°æ®ä¿®å¤å®Œæˆ');

                    

                    // å»¶è¿Ÿåˆ·æ–°é¡µé¢ç¡®ä¿ä¿®å¤ç”Ÿæ•ˆ

                    setTimeout(() => {

                        window.location.reload();

                    }, 2000);

                    

                } catch (error) {

                    console.error('âŒ å¼ºåˆ¶ä¿®å¤å¤±è´¥:', error);

                    MessageUtils.error('ä¿®å¤å¤±è´¥ï¼Œå»ºè®®æ¸…ç©ºæµè§ˆå™¨æ•°æ®åé‡æ–°å¼€å§‹');

                }

            }

        }

        

        // é‡æ–°åŠ è½½å’ŒéªŒè¯æ•°æ®

        function reloadAndValidateData() {

            try {

                console.log('ğŸ”„ é‡æ–°åŠ è½½å’ŒéªŒè¯æ•°æ®...');

                

                // é¦–å…ˆå°è¯•ä¿®å¤æŸåçš„æ•°æ®

                const repaired = repairCorruptedData();

                

                if (repaired) {

                    const currentDataString = JSON.stringify(monthlyEvents);

                    let newData = loadAndCleanData();

                    

                    // åº”ç”¨æœ¬åœ°åˆ é™¤è®°å½•

                    const deletedEvents = JSON.parse(localStorage.getItem('deletedEvents') || '[]');

                    if (deletedEvents.length > 0) {

                        console.log('ğŸ—‘ï¸ é‡æ–°åº”ç”¨åˆ é™¤è®°å½•...');

                        

                        for (const deletion of deletedEvents) {

                            const { date, event: deletedEvent } = deletion;

                            

                            if (newData[date]) {

                                newData[date] = newData[date].filter(event => {

                                    const isMatch = event.title === deletedEvent.title && 

                                                  event.time === deletedEvent.time;

                                    

                                    if (isMatch) {

                                        console.log(`ğŸ—‘ï¸ é‡æ–°åˆ é™¤æ¢å¤çš„äº‹ä»¶: ${date} - ${event.title}`);

                                    }

                                    

                                    return !isMatch;

                                });

                                

                                // å¦‚æœè¯¥æ—¥æœŸæ²¡æœ‰äº‹ä»¶äº†ï¼Œåˆ é™¤æ•´ä¸ªæ—¥æœŸæ¡ç›®

                                if (newData[date].length === 0) {

                                    delete newData[date];

                                }

                            }

                        }

                    }

                    

                    const newDataString = JSON.stringify(newData);

                    

                    // å¦‚æœæ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°æ¸²æŸ“

                    if (currentDataString !== newDataString) {

                        console.log('ğŸ“Š æ£€æµ‹åˆ°æ•°æ®å˜åŒ–ï¼Œé‡æ–°æ¸²æŸ“è§†å›¾');

                        monthlyEvents = newData;

                        

                        // ä¿å­˜åº”ç”¨åˆ é™¤è®°å½•åçš„æ•°æ®

                        saveEvents();

                        

                        renderCalendar();

                        updateEventStats();

                        

                        // å¦‚æœæœ‰é€‰ä¸­çš„æ—¥æœŸï¼Œæ›´æ–°æ˜¾ç¤º

                        if (selectedDate) {

                            displaySelectedDayEvents(selectedDate);

                        }

                        

                        MessageUtils.info('æ•°æ®å·²æ›´æ–°å¹¶åº”ç”¨åˆ é™¤è®°å½•');

                    } else {

                        console.log('âœ… æ•°æ®ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°');

                    }

                }

            } catch (error) {

                console.error('âŒ æ•°æ®é‡æ–°åŠ è½½å¤±è´¥:', error);

            }

        }



        function initMonthlySchedule() {

            // è®¾ç½®ä»Šå¤©ä¸ºé»˜è®¤é€‰æ‹©æ—¥æœŸ

            const today = DateUtils.getToday();

            document.getElementById('event-date').value = today;

            

            // ç«‹å³ä¿®å¤ä»»ä½•æŸåçš„æ•°æ®

            repairCorruptedData();

            

            // éªŒè¯å’Œæ¸…ç†ç°æœ‰æ•°æ®

            validateAndCleanData();

            

            // æ¸²æŸ“æ—¥å†

            renderCalendar();

            updateEventStats();

            

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨

            setupEventListeners();

        }



        function setupEventListeners() {

            // æ—¥å†å¯¼èˆª

            document.getElementById('prev-month').addEventListener('click', () => navigateMonth(-1));

            document.getElementById('next-month').addEventListener('click', () => navigateMonth(1));

            document.getElementById('today-nav').addEventListener('click', goToToday);

            document.getElementById('today-btn').addEventListener('click', goToToday);

            

            // æ·»åŠ æ—¥ç¨‹

            document.getElementById('add-event-btn').addEventListener('click', addEvent);

            

            // å¿«æ·æ·»åŠ æŒ‰é’®

            document.querySelectorAll('.quick-add-btn').forEach(btn => {

                btn.addEventListener('click', function() {

                    const title = this.getAttribute('data-title');

                    const time = this.getAttribute('data-time');

                    quickAddEvent(title, time);

                });

            });

            

            // å…¶ä»–åŠŸèƒ½æŒ‰é’®

            document.getElementById('calendar-view-btn')?.addEventListener('click', showListView);

            document.getElementById('one-click-fix-btn')?.addEventListener('click', oneClickFixAll);

            document.getElementById('sync-settings-btn')?.addEventListener('click', openSyncSettings);

            document.getElementById('force-save-btn')?.addEventListener('click', forceSaveData);

            document.getElementById('clear-day-btn')?.addEventListener('click', clearDayEvents);

            document.getElementById('copy-day-btn')?.addEventListener('click', copyDayEvents);
            document.getElementById('cloud-restore-btn')?.addEventListener('click', forceRestoreFromCloud);
            document.getElementById('reset-help-btn')?.addEventListener('click', resetRecoveryHelp);

            


        }



        function renderCalendar() {

            const year = currentCalendarMonth.getFullYear();

            const month = currentCalendarMonth.getMonth();

            

            // æ›´æ–°æ ‡é¢˜

            document.getElementById('calendar-title').textContent = `${year}å¹´${month + 1}æœˆ`;

            

            // æ¸…é™¤ç°æœ‰æ—¥æœŸæ ¼å­ï¼ˆä¿ç•™æ˜ŸæœŸæ ‡é¢˜ï¼‰

            const grid = document.getElementById('calendar-grid');

            const weekdays = grid.querySelectorAll('.calendar-weekday');

            grid.innerHTML = '';

            weekdays.forEach(day => grid.appendChild(day));

            

            // è·å–æœˆä»½ç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©

            const firstDay = new Date(year, month, 1);

            const lastDay = new Date(year, month + 1, 0);

            const startDate = new Date(firstDay);

            startDate.setDate(startDate.getDate() - firstDay.getDay());

            

            // ç”Ÿæˆæ—¥å†æ ¼å­

            for (let i = 0; i < 42; i++) {

                const date = new Date(startDate);

                date.setDate(startDate.getDate() + i);

                

                const dayElement = createDayElement(date, month);

                grid.appendChild(dayElement);

            }

        }



        function createDayElement(date, currentMonth) {

            const dayElement = document.createElement('div');

            dayElement.className = 'calendar-day';

            

            const dateKey = DateUtils.formatDate(date);

            const isCurrentMonth = date.getMonth() === currentMonth;

            const isToday = dateKey === DateUtils.getToday();

            const dayEvents = monthlyEvents[dateKey] || [];

            

            // è®¾ç½®æ ·å¼

            if (!isCurrentMonth) {

                dayElement.classList.add('other-month');

            }

            if (isToday) {

                dayElement.classList.add('today');

            }

            if (dayEvents.length > 0) {

                dayElement.classList.add('has-events');

            }

            

            // åˆ›å»ºæ—¥æœŸå…ƒç´ 

            const dayNumber = document.createElement('div');

            dayNumber.className = 'day-number';

            dayNumber.textContent = date.getDate();

            dayElement.appendChild(dayNumber);

            

            // åˆ›å»ºäº‹ä»¶é¢„è§ˆ

            const dayEventsContainer = document.createElement('div');

            dayEventsContainer.className = 'day-events';

            

            // æ˜¾ç¤ºæœ€å¤š3ä¸ªäº‹ä»¶é¢„è§ˆ

            dayEvents.slice(0, 3).forEach(event => {

                const eventPreview = document.createElement('div');

                eventPreview.className = 'event-preview';

                // ç¡®ä¿æ•°æ®å®‰å…¨æ€§å’Œæ­£ç¡®æ˜¾ç¤ºï¼Œå¤„ç†åŒæ­¥åçš„æ•°æ®æ ¼å¼é—®é¢˜

                const timeText = sanitizeText(event.time || '');

                const titleText = sanitizeText(event.title || '');

                const displayText = `${timeText} ${titleText}`.trim();

                // é˜²æ­¢XSSæ”»å‡»å’Œæ˜¾ç¤ºå¼‚å¸¸ï¼Œä½¿ç”¨textContent

                eventPreview.textContent = displayText;

                eventPreview.title = displayText;

                dayEventsContainer.appendChild(eventPreview);

            });

            

            // å¦‚æœäº‹ä»¶è¶…è¿‡3ä¸ªï¼Œæ˜¾ç¤ºæ›´å¤šæç¤º

            if (dayEvents.length > 3) {

                const moreEvents = document.createElement('div');

                moreEvents.className = 'event-preview';

                moreEvents.textContent = `+${dayEvents.length - 3} æ›´å¤š`;

                moreEvents.style.background = 'rgba(255,152,0,0.2)';

                moreEvents.style.color = '#ff9800';

                dayEventsContainer.appendChild(moreEvents);

            }

            

            dayElement.appendChild(dayEventsContainer);

            

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶

            dayElement.addEventListener('click', () => selectDate(dateKey, dayElement));

            

            return dayElement;

        }



        function selectDate(dateKey, dayElement) {

            // ç§»é™¤ä¹‹å‰é€‰ä¸­çš„æ ·å¼

            document.querySelectorAll('.calendar-day.selected').forEach(el => {

                el.classList.remove('selected');

            });

            

            // æ·»åŠ é€‰ä¸­æ ·å¼

            dayElement.classList.add('selected');

            dayElement.style.border = '2px solid var(--theme-color)';

            

            selectedDate = dateKey;

            

            // æ›´æ–°äº‹ä»¶æ˜¾ç¤º

            displaySelectedDayEvents(dateKey);

            

            // è®¾ç½®è¡¨å•æ—¥æœŸ

            document.getElementById('event-date').value = dateKey;

        }



        function displaySelectedDayEvents(dateKey) {

            const events = monthlyEvents[dateKey] || [];

            const container = document.getElementById('selected-day-events');

            const titleEl = document.getElementById('selected-date-title');

            

            // æ›´æ–°æ ‡é¢˜

            const date = new Date(dateKey);

            titleEl.textContent = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ (${DateUtils.getWeekdayName(date)})`;

            

            // æ˜¾ç¤º/éšè—æ“ä½œæŒ‰é’®

            const clearBtn = document.getElementById('clear-day-btn');

            const copyBtn = document.getElementById('copy-day-btn');

            if (events.length > 0) {

                clearBtn.style.display = 'inline-block';

                copyBtn.style.display = 'inline-block';

            } else {

                clearBtn.style.display = 'none';

                copyBtn.style.display = 'none';

            }

            

            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……äº‹ä»¶åˆ—è¡¨

            container.innerHTML = '';

            

            if (events.length === 0) {

                container.innerHTML = `

                    <div style="text-align: center; padding: 40px; color: #666;">

                        <div style="font-size: 2em; margin-bottom: 12px;">ğŸ“…</div>

                        <p>å½“å¤©æš‚æ— æ—¥ç¨‹å®‰æ’</p>

                        <button class="btn-main" onclick="focusAddEvent()">æ·»åŠ æ—¥ç¨‹</button>

                    </div>

                `;

                return;

            }

            

            // æ•°æ®æ¸…ç†å’Œæ’åº

            const cleanEvents = events.filter(event => event && event.time && event.title)

                                    .map(event => ({

                                        ...event,

                                        time: sanitizeText(event.time),

                                        title: sanitizeText(event.title),

                                        description: sanitizeText(event.description || '')

                                    }));

            

            // æŒ‰æ—¶é—´æ’åº

            cleanEvents.sort((a, b) => a.time.localeCompare(b.time));

            

            cleanEvents.forEach((event, index) => {

                const eventItem = document.createElement('div');

                eventItem.className = 'event-item';

                

                // åˆ›å»ºæ—¶é—´å…ƒç´ 

                const timeDiv = document.createElement('div');

                timeDiv.className = 'event-time';

                timeDiv.textContent = event.time;

                

                // åˆ›å»ºæ ‡é¢˜å…ƒç´ 

                const titleDiv = document.createElement('div');

                titleDiv.className = 'event-title';

                titleDiv.textContent = event.title;

                

                // åˆ›å»ºåˆ é™¤æŒ‰é’®

                const deleteBtn = document.createElement('button');

                deleteBtn.className = 'event-delete';

                deleteBtn.textContent = 'Ã—';

                deleteBtn.title = 'åˆ é™¤';

                deleteBtn.onclick = () => deleteEvent(dateKey, index);

                

                eventItem.appendChild(timeDiv);

                eventItem.appendChild(titleDiv);

                eventItem.appendChild(deleteBtn);

                container.appendChild(eventItem);

            });

        }



        function addEvent() {

            const rawTitle = document.getElementById('event-title').value || '';

            const date = document.getElementById('event-date').value;

            const rawTime = document.getElementById('event-time').value || '';

            const category = document.getElementById('event-category').value || 'other';

            const rawDescription = document.getElementById('event-description').value || '';

            

            // æ¸…ç†è¾“å…¥æ•°æ®

            const title = sanitizeText(rawTitle);

            const time = sanitizeText(rawTime);

            const description = sanitizeText(rawDescription);

            

            // éªŒè¯å¿…éœ€å­—æ®µ

            if (!title) {

                MessageUtils.error('è¯·è¾“å…¥æ—¥ç¨‹æ ‡é¢˜');

                document.getElementById('event-title').focus();

                return;

            }

            

            if (!date) {

                MessageUtils.error('è¯·é€‰æ‹©æ—¥æœŸ');

                document.getElementById('event-date').focus();

                return;

            }

            

            if (!time) {

                MessageUtils.error('è¯·é€‰æ‹©æ—¶é—´');

                document.getElementById('event-time').focus();

                return;

            }

            

            // éªŒè¯æ—¥æœŸæ ¼å¼

            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {

                MessageUtils.error('æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®');

                return;

            }

            

            // éªŒè¯æ—¶é—´æ ¼å¼

            if (!/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(time)) {

                MessageUtils.error('æ—¶é—´æ ¼å¼ä¸æ­£ç¡®');

                return;

            }

            

            // åˆ›å»ºäº‹ä»¶å¯¹è±¡

            const event = {

                title: title,

                time: time,

                category: category,

                description: description,

                createdAt: new Date().toISOString()

            };

            

            console.log('ğŸ”„ æ·»åŠ äº‹ä»¶:', event);

            

            // æ·»åŠ åˆ°æ•°æ®ä¸­

            if (!monthlyEvents[date]) {

                monthlyEvents[date] = [];

            }

            

            monthlyEvents[date].push(event);

            

            // ä¿å­˜æ•°æ®

            saveEvents();

            

            // æ¸…ç©ºè¡¨å•

            document.getElementById('event-title').value = '';

            document.getElementById('event-time').value = '';

            document.getElementById('event-description').value = '';

            

            // é‡æ–°æ¸²æŸ“

            renderCalendar();

            updateEventStats();

            

            // å¦‚æœæ˜¯å½“å‰é€‰æ‹©çš„æ—¥æœŸï¼Œæ›´æ–°æ˜¾ç¤º

            if (selectedDate === date) {

                displaySelectedDayEvents(date);

            }

            

            MessageUtils.success('æ—¥ç¨‹æ·»åŠ æˆåŠŸï¼');

            console.log('âœ… äº‹ä»¶æ·»åŠ å®Œæˆ');

        }



        function quickAddEvent(title, time) {

            const date = document.getElementById('event-date').value || DateUtils.getToday();

            

            document.getElementById('event-title').value = title;

            document.getElementById('event-time').value = time;

            

            // è‡ªåŠ¨æ·»åŠ 

            addEvent();

        }



        function deleteEvent(date, index) {

            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ—¥ç¨‹å—ï¼Ÿ')) {

                try {

                    console.log(`ğŸ—‘ï¸ åˆ é™¤äº‹ä»¶: ${date}[${index}]`);

                    

                    // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§

                    if (!monthlyEvents[date] || !Array.isArray(monthlyEvents[date])) {

                        console.error('âŒ æ— æ•ˆçš„æ—¥æœŸæ•°æ®:', date);

                        MessageUtils.error('åˆ é™¤å¤±è´¥ï¼šæ•°æ®æ— æ•ˆ');

                        return;

                    }

                    

                    if (index < 0 || index >= monthlyEvents[date].length) {

                        console.error('âŒ æ— æ•ˆçš„äº‹ä»¶ç´¢å¼•:', index);

                        MessageUtils.error('åˆ é™¤å¤±è´¥ï¼šäº‹ä»¶ä¸å­˜åœ¨');

                        return;

                    }

                    

                    // è®°å½•åˆ é™¤çš„äº‹ä»¶

                    const deletedEvent = monthlyEvents[date][index];

                    console.log('åˆ é™¤çš„äº‹ä»¶:', deletedEvent);

                    

                    // åˆ é™¤äº‹ä»¶

                monthlyEvents[date].splice(index, 1);

                

                // å¦‚æœæ—¥æœŸæ²¡æœ‰äº‹ä»¶äº†ï¼Œåˆ é™¤æ•´ä¸ªæ—¥æœŸæ¡ç›®

                if (monthlyEvents[date].length === 0) {

                    delete monthlyEvents[date];

                        console.log(`ğŸ—‘ï¸ åˆ é™¤æ•´ä¸ªæ—¥æœŸ: ${date}`);

                }

                

                    // å¼ºåˆ¶ä¿å­˜æ•°æ®

                saveEvents();

                    

                    // éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ

                    const savedData = JSON.parse(localStorage.getItem('monthlyEvents') || '{}');

                    if (savedData[date]) {

                        const eventStillExists = savedData[date].some(event => 

                            event.title === deletedEvent.title && 

                            event.time === deletedEvent.time

                        );

                        

                        if (eventStillExists) {

                            console.error('âŒ åˆ é™¤éªŒè¯å¤±è´¥ï¼Œäº‹ä»¶ä»ç„¶å­˜åœ¨');

                            MessageUtils.error('åˆ é™¤å¤±è´¥ï¼šæ•°æ®ä¿å­˜å¼‚å¸¸');

                            return;

                        }

                    }

                    

                    console.log('âœ… åˆ é™¤éªŒè¯é€šè¿‡');

                    

                    // é‡æ–°æ¸²æŸ“ç•Œé¢

                renderCalendar();

                updateEventStats();

                

                if (selectedDate === date) {

                    displaySelectedDayEvents(date);

                }

                    

                    // è®°å½•åˆ é™¤æ“ä½œåˆ°åˆ é™¤æ—¥å¿—

                    recordDeletion(date, deletedEvent);

                

                MessageUtils.success('æ—¥ç¨‹å·²åˆ é™¤');

                    

                } catch (error) {

                    console.error('âŒ åˆ é™¤æ“ä½œå¤±è´¥:', error);

                    MessageUtils.error('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');

                }

            }

        }

        

        // è®°å½•åˆ é™¤æ“ä½œ

        function recordDeletion(date, event) {

            try {

                const deletions = JSON.parse(localStorage.getItem('deletedEvents') || '[]');

                deletions.push({

                    date: date,

                    event: event,

                    deletedAt: new Date().toISOString(),

                    userAgent: navigator.userAgent

                });

                

                // åªä¿ç•™æœ€è¿‘100ä¸ªåˆ é™¤è®°å½•

                if (deletions.length > 100) {

                    deletions.splice(0, deletions.length - 100);

                }

                

                localStorage.setItem('deletedEvents', JSON.stringify(deletions));

                console.log('ğŸ“ åˆ é™¤è®°å½•å·²ä¿å­˜');

            } catch (error) {

                console.warn('âš ï¸ åˆ é™¤è®°å½•ä¿å­˜å¤±è´¥:', error);

            }

        }



        function clearDayEvents() {

            if (selectedDate && confirm('ç¡®å®šè¦æ¸…ç©ºå½“å¤©æ‰€æœ‰æ—¥ç¨‹å—ï¼Ÿ')) {

                try {

                    console.log(`ğŸ—‘ï¸ æ¸…ç©ºå½“å¤©æ‰€æœ‰æ—¥ç¨‹: ${selectedDate}`);

                    

                    // è®°å½•è¢«æ¸…ç©ºçš„æ‰€æœ‰äº‹ä»¶

                    if (monthlyEvents[selectedDate]) {

                        const eventsToDelete = monthlyEvents[selectedDate];

                        

                        // å°†æ‰€æœ‰äº‹ä»¶æ·»åŠ åˆ°åˆ é™¤è®°å½•

                        for (const event of eventsToDelete) {

                            recordDeletion(selectedDate, event);

                        }

                        

                        console.log(`ğŸ“ è®°å½•äº† ${eventsToDelete.length} ä¸ªåˆ é™¤çš„äº‹ä»¶`);

                    }

                    

                delete monthlyEvents[selectedDate];

                saveEvents();

                renderCalendar();

                updateEventStats();

                displaySelectedDayEvents(selectedDate);

                    

                MessageUtils.success('å½“å¤©æ—¥ç¨‹å·²æ¸…ç©º');

                    

                } catch (error) {

                    console.error('âŒ æ¸…ç©ºæ—¥ç¨‹å¤±è´¥:', error);

                    MessageUtils.error('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•');

                }

            }

        }

        

        // æ¸…ç†åˆ é™¤è®°å½•ï¼ˆç”¨äºè°ƒè¯•å’Œç»´æŠ¤ï¼‰

        function clearDeletionRecords() {

            try {

                localStorage.removeItem('deletedEvents');

                console.log('ğŸ§¹ åˆ é™¤è®°å½•å·²æ¸…ç†');

                MessageUtils.success('åˆ é™¤è®°å½•å·²æ¸…ç†');

            } catch (error) {

                console.error('âŒ æ¸…ç†åˆ é™¤è®°å½•å¤±è´¥:', error);

                MessageUtils.error('æ¸…ç†å¤±è´¥');

            }

        }

        

        // æŸ¥çœ‹åˆ é™¤è®°å½•ï¼ˆç”¨äºè°ƒè¯•ï¼‰

        function viewDeletionRecords() {

            try {

                const deletions = JSON.parse(localStorage.getItem('deletedEvents') || '[]');

                console.log('ğŸ“ åˆ é™¤è®°å½•:', deletions);

                alert(`åˆ é™¤è®°å½•æ•°é‡: ${deletions.length} ä¸ª\n\nè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚`);

            } catch (error) {

                console.error('âŒ æŸ¥çœ‹åˆ é™¤è®°å½•å¤±è´¥:', error);

            }

        }

        

        // å½»åº•æ¸…é™¤15å·ç­‰æŸåæ•°æ®çš„ä¸“é—¨å‡½æ•°
        function forceCleanSpecificDates() {
            try {
                console.log('ğŸ§¹ å¼€å§‹å½»åº•æ¸…é™¤æŸåæ•°æ®...');
                
                let foundCorruptedData = false;
                const corruptedDates = [];
                
                // æ£€æŸ¥æ‰€æœ‰æ—¥æœŸçš„æŸåæ•°æ®
                for (const [date, events] of Object.entries(monthlyEvents)) {
                    if (Array.isArray(events)) {
                        for (let i = events.length - 1; i >= 0; i--) {
                            const event = events[i];
                            if (event && event.title) {
                                // æ£€æŸ¥æ˜¯å¦åŒ…å«ç¼–ç é”™è¯¯å­—ç¬¦ï¼ˆæ ¹æ®æˆªå›¾ä¸­çš„å†…å®¹ï¼‰
                                if (event.title.includes('Â¥â‚¬') || 
                                    event.title.includes('Â®Â®') || 
                                    event.title.includes('Ã‚') || 
                                    event.title.includes('\u00C2') ||
                                    event.title.includes('Ã¢â‚¬') ||
                                    event.title.includes('ÃƒÂ¢') ||
                                    event.title.includes('Â¥') ||
                                    event.title.includes('â‚¬') ||
                                    event.title.includes('@Â¥') ||
                                    event.title.includes('/4') ||
                                    event.title.includes('/"') ||
                                    event.title.match(/[Â¥â‚¬Â®@]/g) ||
                                    /[^\x20-\x7E\u4e00-\u9fff]/g.test(event.title)) {
                                    
                                    console.log(`ğŸ—‘ï¸ å‘ç°æŸåäº‹ä»¶: ${date} - ${event.title}`);
                                    foundCorruptedData = true;
                                    if (!corruptedDates.includes(date)) {
                                        corruptedDates.push(date);
                                    }
                                    
                                    // è®°å½•åˆ é™¤æ“ä½œ
                                    recordDeletion(date, event);
                                    
                                    // åˆ é™¤æŸåçš„äº‹ä»¶
                                    events.splice(i, 1);
                                }
                            }
                        }
                        
                        // å¦‚æœè¯¥æ—¥æœŸæ²¡æœ‰äº‹ä»¶äº†ï¼Œåˆ é™¤æ•´ä¸ªæ—¥æœŸæ¡ç›®
                        if (events.length === 0) {
                            delete monthlyEvents[date];
                            console.log(`ğŸ—‘ï¸ åˆ é™¤ç©ºæ—¥æœŸ: ${date}`);
                        }
                    }
                }
                
                if (foundCorruptedData) {
                    console.log(`ğŸ§¹ æ¸…ç†äº† ${corruptedDates.length} ä¸ªæ—¥æœŸçš„æŸåæ•°æ®:`, corruptedDates);
                    
                    // ç«‹å³ä¿å­˜æ¸…ç†åçš„æ•°æ®
                    saveEvents();
                    
                    // é‡æ–°æ¸²æŸ“ç•Œé¢
                    renderCalendar();
                    updateEventStats();
                    
                    if (selectedDate) {
                        displaySelectedDayEvents(selectedDate);
                    }
                    
                    MessageUtils.success(`å·²æ¸…ç† ${corruptedDates.length} ä¸ªæ—¥æœŸçš„æŸåæ•°æ®ï¼`);
                    return true;
                } else {
                    console.log('âœ… æœªå‘ç°æŸåæ•°æ®ï¼Œæ•°æ®çŠ¶æ€æ­£å¸¸');
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ æ¸…ç†æŸåæ•°æ®å¤±è´¥:', error);
                MessageUtils.error('æ¸…ç†å¤±è´¥: ' + error.message);
                return false;
            }
        }

        // ä¸€é”®ä¿®å¤æ‰€æœ‰15å·ç­‰æŸåæ•°æ®é—®é¢˜
        async function oneClickFixAll() {
            try {
                const confirmed = confirm(
                    'ğŸ”§ ä¸€é”®ä¿®å¤åŠŸèƒ½\n\n' +
                    'å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n' +
                    '1. å½»åº•æ¸…ç†æ‰€æœ‰æŸåæ•°æ®ï¼ˆåŒ…æ‹¬15å·çš„ç¼–ç é”™è¯¯ï¼‰\n' +
                    '2. å¼ºåˆ¶ä¿å­˜æ­£ç¡®æ•°æ®åˆ°æœ¬åœ°\n' +
                    '3. æ¨é€åˆ°äº‘ç«¯è¦†ç›–é”™è¯¯æ•°æ®\n' +
                    '4. é˜²æ­¢æŸåæ•°æ®é‡æ–°å‡ºç°\n\n' +
                    'æ˜¯å¦ç«‹å³æ‰§è¡Œï¼Ÿ'
                );
                
                if (!confirmed) {
                    return;
                }
                
                MessageUtils.info('æ­£åœ¨æ‰§è¡Œä¸€é”®ä¿®å¤...');
                
                // æ­¥éª¤1ï¼šå½»åº•æ¸…ç†æŸåæ•°æ®
                console.log('ğŸ§¹ æ­¥éª¤1ï¼šæ¸…ç†æŸåæ•°æ®');
                const hadCorruption = forceCleanSpecificDates();
                
                // æ­¥éª¤2ï¼šæ‰§è¡Œç´§æ€¥æ•°æ®æ¸…ç†
                console.log('ğŸ§¹ æ­¥éª¤2ï¼šç´§æ€¥æ•°æ®æ¸…ç†');
                emergencyDataCleanup();
                
                // æ­¥éª¤3ï¼šå†æ¬¡æ‰§è¡Œä¸“é—¨æ¸…ç†
                console.log('ğŸ§¹ æ­¥éª¤3ï¼šä¸“é—¨æ¸…ç†');
                forceCleanSpecificDates();
                
                // æ­¥éª¤4ï¼šå¼ºåˆ¶ä¿å­˜åˆ°äº‘ç«¯
                console.log('â˜ï¸ æ­¥éª¤4ï¼šå¼ºåˆ¶ä¿å­˜åˆ°äº‘ç«¯');
                
                // å¦‚æœæœ‰åŒæ­¥æœåŠ¡ï¼Œå¼ºåˆ¶ä¸Šä¼ 
                if (window.syncService) {
                    const status = window.syncService.getSyncStatus();
                    
                    if (status.enabled) {
                        try {
                            await window.syncService.manualSync();
                            MessageUtils.success('âœ… ä¸€é”®ä¿®å¤å®Œæˆï¼æ•°æ®å·²æ¸…ç†å¹¶åŒæ­¥åˆ°äº‘ç«¯');
                        } catch (syncError) {
                            console.error('âŒ äº‘ç«¯åŒæ­¥å¤±è´¥:', syncError);
                            MessageUtils.warning('æœ¬åœ°ä¿®å¤å®Œæˆï¼Œä½†äº‘ç«¯åŒæ­¥å¤±è´¥: ' + syncError.message);
                        }
                    } else {
                        MessageUtils.success('âœ… ä¸€é”®ä¿®å¤å®Œæˆï¼ï¼ˆåŒæ­¥æœªå¯ç”¨ï¼Œä»…ä¿®å¤æœ¬åœ°æ•°æ®ï¼‰');
                    }
                } else {
                    MessageUtils.success('âœ… ä¸€é”®ä¿®å¤å®Œæˆï¼ï¼ˆæ— åŒæ­¥æœåŠ¡ï¼Œä»…ä¿®å¤æœ¬åœ°æ•°æ®ï¼‰');
                }
                
                // æ­¥éª¤5ï¼šé‡æ–°æ¸²æŸ“ç•Œé¢
                console.log('ğŸ¨ æ­¥éª¤5ï¼šé‡æ–°æ¸²æŸ“ç•Œé¢');
                renderCalendar();
                updateEventStats();
                
                if (selectedDate) {
                    displaySelectedDayEvents(selectedDate);
                }
                
                // æ­¥éª¤6ï¼šæ¸…ç†åˆ é™¤è®°å½•ï¼ˆé˜²æ­¢å†²çªï¼‰
                console.log('ğŸ§¹ æ­¥éª¤6ï¼šæ¸…ç†åˆ é™¤è®°å½•');
                try {
                    const deletions = JSON.parse(localStorage.getItem('deletedEvents') || '[]');
                    if (deletions.length > 50) {
                        // åªä¿ç•™æœ€è¿‘50ä¸ªåˆ é™¤è®°å½•
                        const recentDeletions = deletions.slice(-50);
                        localStorage.setItem('deletedEvents', JSON.stringify(recentDeletions));
                        console.log('ğŸ§¹ åˆ é™¤è®°å½•å·²ä¼˜åŒ–ï¼Œä¿ç•™æœ€è¿‘50ä¸ª');
                    }
                } catch (error) {
                    console.warn('âš ï¸ åˆ é™¤è®°å½•æ¸…ç†å¤±è´¥:', error);
                }
                
                console.log('âœ… ä¸€é”®ä¿®å¤å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ ä¸€é”®ä¿®å¤å¤±è´¥:', error);
                MessageUtils.error('ä¿®å¤å¤±è´¥: ' + error.message);
            }
        }

        // å¼ºåˆ¶ä¿å­˜æ•°æ®åˆ°äº‘ç«¯ï¼ˆè¦†ç›–åŒæ­¥æ•°æ®ï¼‰

        async function forceSaveData() {

            try {

                console.log('ğŸ’¾ å¼€å§‹å¼ºåˆ¶ä¿å­˜æ•°æ®...');

                // åœ¨ä¿å­˜å‰å…ˆè¿›è¡Œæœ€åä¸€æ¬¡æ¸…ç†
                const hadCorruptedData = forceCleanSpecificDates();

                // æ£€æµ‹æ˜¯å¦æœ‰äº‘åŒæ­¥æœåŠ¡
                const hasCloudSync = window.syncService && window.syncService.getSyncStatus().enabled;
                
                // æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                if (hadCorruptedData) {
                    // æ£€æµ‹åˆ°æŸåæ•°æ®æ—¶çš„ç‰¹æ®Šæç¤º
                    const confirmed = confirm(
                        'âš ï¸ æ£€æµ‹åˆ°æ•°æ®ç¼–ç é”™è¯¯ï¼Œå°†è‡ªåŠ¨æ¸…ç†ï¼\n\n' +
                        (hasCloudSync ? 'æ¸…ç†åä¼šåŒæ­¥åˆ°äº‘ç«¯ã€‚' : 'æ¸…ç†åä¼šä¿å­˜åˆ°æœ¬åœ°ã€‚') + '\n\n' +
                        'æ˜¯å¦ç»§ç»­ï¼Ÿ'
                    );
                    
                    if (!confirmed) {
                        return;
                    }
                } else {
                    // ç›´æ¥ä¿å­˜ï¼Œä¸æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼ˆé™¤éç”¨æˆ·è®¾ç½®äº†æ€»æ˜¯ç¡®è®¤ï¼‰
                    const alwaysConfirm = localStorage.getItem('alwaysConfirmSave') === 'true';
                    
                    if (alwaysConfirm) {
                        const confirmed = confirm(
                            'ğŸ’¾ ä¿å­˜æ•°æ®\n\n' +
                            (hasCloudSync ? 'å°†å¼ºåˆ¶ä¿å­˜å½“å‰æ•°æ®åˆ°äº‘ç«¯ã€‚' : 'å°†ä¿å­˜æ•°æ®åˆ°æœ¬åœ°ã€‚') + '\n\n' +
                            'æ˜¯å¦ç»§ç»­ï¼Ÿ'
                        );
                        
                        if (!confirmed) {
                            return;
                        }
                    } else {
                        // ç›´æ¥ä¿å­˜ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
                        MessageUtils.info('æ­£åœ¨ä¿å­˜æ•°æ®...');
                    }
                }

                // 1. é¦–å…ˆæ¸…ç†å½“å‰æ•°æ®

                console.log('ğŸ§¹ æ¸…ç†å½“å‰æ•°æ®...');

                emergencyDataCleanup();

                

                // 2. éªŒè¯æ•°æ®æ¸…æ´åº¦

                const cleanedEvents = cleanupEventData(monthlyEvents);

                monthlyEvents = cleanedEvents;

                

                // 3. å¼ºåˆ¶æœ¬åœ°ä¿å­˜

                console.log('ğŸ’¾ å¼ºåˆ¶æœ¬åœ°ä¿å­˜...');

                saveEvents();

                

                // 4. å¦‚æœæœ‰åŒæ­¥æœåŠ¡ï¼Œå¼ºåˆ¶ä¸Šä¼ 

                if (window.syncService) {

                    const status = window.syncService.getSyncStatus();

                    

                    if (status.enabled) {

                        try {

                            console.log('â˜ï¸ å¼ºåˆ¶åŒæ­¥åˆ°äº‘ç«¯...');

                            

                            // æ˜¾ç¤ºä¿å­˜è¿›åº¦

                            MessageUtils.info('æ­£åœ¨ä¿å­˜æ•°æ®åˆ°äº‘ç«¯...');

                            

                            // æ‰§è¡Œå¼ºåˆ¶åŒæ­¥

                            await window.syncService.manualSync();

                            

                            // å†æ¬¡éªŒè¯åŒæ­¥åçš„æ•°æ®ï¼ˆä»äº‘ç«¯è·å–æœ€æ–°æ•°æ®ï¼‰

                            setTimeout(() => {

                                const afterSyncData = loadAndCleanData();

                                const hasCorruptedData = JSON.stringify(afterSyncData).includes('Ã‚');

                                

                                if (hasCorruptedData) {

                                    console.log('âš ï¸ æ£€æµ‹åˆ°åŒæ­¥åä»æœ‰æŸåæ•°æ®ï¼Œé‡æ–°å¼ºåˆ¶ä¿å­˜...');

                                    

                                    // æ¢å¤æ¸…æ´æ•°æ®

                                    monthlyEvents = cleanedEvents;

                                    saveEvents();

                                    

                                    // é‡æ–°æ¸²æŸ“

                                    renderCalendar();

                                    updateEventStats();

                                    

                                    MessageUtils.warning('äº‘ç«¯æ•°æ®å·²æ›´æ–°ï¼Œä½†æ£€æµ‹åˆ°æ®‹ç•™é—®é¢˜å·²è‡ªåŠ¨ä¿®å¤');

                                } else {

                                    console.log('âœ… åŒæ­¥éªŒè¯é€šè¿‡ï¼Œæ•°æ®ä¿å­˜æˆåŠŸ');

                                    MessageUtils.success('âœ… æ•°æ®å·²ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯ï¼åˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±ã€‚');

                                }

                            }, 1000);

                            

                        } catch (syncError) {

                            console.error('âŒ äº‘ç«¯åŒæ­¥å¤±è´¥:', syncError);

                            MessageUtils.warning('æœ¬åœ°ä¿å­˜æˆåŠŸï¼Œä½†äº‘ç«¯åŒæ­¥å¤±è´¥: ' + syncError.message);

                        }

                    } else {

                        console.log('ğŸ’¡ åŒæ­¥æœªå¯ç”¨ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°');

                        MessageUtils.success('âœ… ä¿å­˜æˆåŠŸï¼');

                    }

                } else {

                    console.log('ğŸ’¡ æ— åŒæ­¥æœåŠ¡ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°');

                    MessageUtils.success('âœ… ä¿å­˜æˆåŠŸï¼');

                }

                

                // 5. é‡æ–°æ¸²æŸ“ç•Œé¢

                renderCalendar();

                updateEventStats();

                

                if (selectedDate) {

                    displaySelectedDayEvents(selectedDate);

                }

                

                // 6. æ›´æ–°ä¿å­˜æ—¶é—´æ˜¾ç¤º

                updateSaveTimeDisplay();

                

                console.log('âœ… å¼ºåˆ¶ä¿å­˜å®Œæˆ');

                

            } catch (error) {

                console.error('âŒ å¼ºåˆ¶ä¿å­˜å¤±è´¥:', error);

                MessageUtils.error('ä¿å­˜å¤±è´¥: ' + error.message);

            }

        }

        

        // æ›´æ–°ä¿å­˜æ—¶é—´æ˜¾ç¤º

        function updateSaveTimeDisplay() {

            const now = new Date();

            const timeStr = now.toLocaleTimeString('zh-CN');

            

            const saveBtn = document.getElementById('force-save-btn');

            if (saveBtn) {

                saveBtn.innerHTML = `ğŸ’¾ ä¿å­˜ (${timeStr})`;

                

                // 3ç§’åæ¢å¤åŸå§‹æ–‡æœ¬

                setTimeout(() => {

                    saveBtn.innerHTML = 'ğŸ’¾ ä¿å­˜';

                }, 3000);

            }

        }



        function copyDayEvents() {

            if (selectedDate) {

                const events = monthlyEvents[selectedDate] || [];

                if (events.length === 0) {

                    MessageUtils.warning('å½“å¤©æ²¡æœ‰æ—¥ç¨‹å¯å¤åˆ¶');

                    return;

                }

                

                const eventsText = events.map(e => `${e.time} ${e.title}`).join('\n');

                navigator.clipboard.writeText(eventsText).then(() => {

                    MessageUtils.success('æ—¥ç¨‹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');

                }).catch(() => {

                    MessageUtils.error('å¤åˆ¶å¤±è´¥');

                });

            }

        }



        function navigateMonth(months) {

            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + months);

            renderCalendar();

            updateEventStats();

        }



        function goToToday() {

            currentCalendarMonth = new Date();

            renderCalendar();

            updateEventStats();

            

            // è‡ªåŠ¨é€‰æ‹©ä»Šå¤©

            const today = DateUtils.getToday();

            const todayElement = Array.from(document.querySelectorAll('.calendar-day')).find(el => {

                return el.classList.contains('today');

            });

            

            if (todayElement) {

                selectDate(today, todayElement);

            }

        }



        function updateEventStats() {

            const currentMonth = currentCalendarMonth.getMonth();

            const currentYear = currentCalendarMonth.getFullYear();

            const today = DateUtils.getToday();

            

            let monthCount = 0;

            let todayCount = 0;

            let weekCount = 0;

            

            Object.entries(monthlyEvents).forEach(([date, events]) => {

                const eventDate = new Date(date);

                

                // ç»Ÿè®¡æœ¬æœˆäº‹ä»¶

                if (eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear) {

                    monthCount += events.length;

                }

                

                // ç»Ÿè®¡ä»Šæ—¥äº‹ä»¶

                if (date === today) {

                    todayCount = events.length;

                }

                

                // ç»Ÿè®¡æœ¬å‘¨äº‹ä»¶ï¼ˆç®€åŒ–è®¡ç®—ï¼‰

                const daysDiff = Math.abs((new Date(today) - eventDate) / (1000 * 60 * 60 * 24));

                if (daysDiff <= 7) {

                    weekCount += events.length;

                }

            });

            

            document.getElementById('month-events-count').textContent = monthCount;

            document.getElementById('today-events-count').textContent = todayCount;

            document.getElementById('week-events-count').textContent = weekCount;

        }



        function saveEvents() {

            try {

                // æ•°æ®æ¸…ç†å’ŒéªŒè¯

                const cleanedEvents = cleanupEventData(monthlyEvents);

                

                // ä½¿ç”¨è‡ªå®šä¹‰JSONåºåˆ—åŒ–ï¼Œç¡®ä¿å­—ç¬¦ç¼–ç æ­£ç¡®

                const jsonString = safeJsonStringify(cleanedEvents);

                

                if (!jsonString) {

                    console.error('âŒ JSONåºåˆ—åŒ–å¤±è´¥');

                    MessageUtils.error('æ•°æ®åºåˆ—åŒ–å¤±è´¥ï¼Œä¿å­˜å¤±è´¥');

                    return;

                }

                

                // éªŒè¯JSONå­—ç¬¦ä¸²æ˜¯å¦æœ‰æ•ˆä¸”ä¸å«é—®é¢˜å­—ç¬¦

                try {

                    const testParse = JSON.parse(jsonString);

                    

                    // æ£€æŸ¥æ˜¯å¦åŒ…å«é—®é¢˜å­—ç¬¦

                    if (jsonString.includes('Ã‚') || jsonString.includes('\u00C2')) {

                        console.error('âŒ JSONåŒ…å«ç¼–ç é—®é¢˜å­—ç¬¦');

                        MessageUtils.error('æ•°æ®åŒ…å«ç¼–ç é—®é¢˜ï¼Œä¿å­˜å¤±è´¥');

                        return;

                    }

                    

                } catch (validateError) {

                    console.error('âŒ JSONéªŒè¯å¤±è´¥:', validateError);

                    MessageUtils.error('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œä¿å­˜å¤±è´¥');

                    return;

                }

                

                // ä¸»è¦å­˜å‚¨ï¼ˆåŒæ—¶å†™å…¥æœ¬åœ°é”®å’Œäº‘åŒæ­¥é”®ï¼‰

                localStorage.setItem('monthlyEvents', jsonString);
                localStorage.setItem('planData_monthlyEvents', jsonString);

                monthlyEvents = cleanedEvents;

                

                // éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ

                const savedData = localStorage.getItem('monthlyEvents');

                if (savedData !== jsonString) {

                    console.warn('âš ï¸ ä¿å­˜éªŒè¯å¤±è´¥ï¼Œæ•°æ®å¯èƒ½ä¸ä¸€è‡´');

                    

                    // å°è¯•é‡æ–°ä¿å­˜

                    try {

                        // é‡æ–°ä¿å­˜åˆ°æœ¬åœ°é”®å’Œäº‘åŒæ­¥é”®
                        localStorage.setItem('monthlyEvents', jsonString);
                        localStorage.setItem('planData_monthlyEvents', jsonString);

                        console.log('âœ… é‡æ–°ä¿å­˜æˆåŠŸ');

                    } catch (retryError) {

                        console.error('âŒ é‡æ–°ä¿å­˜å¤±è´¥:', retryError);

                        MessageUtils.error('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');

                        return;

                    }

                }

                

                console.log('âœ… æ•°æ®ä¿å­˜æˆåŠŸ');

                // ğŸ”„ ç«‹å³è§¦å‘äº‘ç«¯åŒæ­¥ï¼ˆç‰¹åˆ«é‡è¦ï¼šç¡®ä¿æ‰‹æœºç«¯æ•°æ®åŠæ—¶ä¸Šä¼ ï¼‰
                if (window.syncService && window.syncService.getSyncStatus().enabled) {
                    console.log('ğŸš€ ç«‹å³è§¦å‘äº‘ç«¯åŒæ­¥...');
                    
                    // å–æ¶ˆä¹‹å‰çš„é˜²æŠ–å®šæ—¶å™¨ï¼Œç«‹å³åŒæ­¥
                    if (window.syncTimeout) {
                        clearTimeout(window.syncTimeout);
                    }
                    
                    // ç«‹å³æ‰§è¡ŒåŒæ­¥ï¼Œä¸ç­‰å¾…é˜²æŠ–
                    window.syncService.manualSync().then(() => {
                        console.log('âœ… ç«‹å³åŒæ­¥å®Œæˆ');
                        MessageUtils.success('âœ… æ•°æ®å·²ä¿å­˜å¹¶åŒæ­¥å®Œæˆï¼å¯ä»¥æ”¾å¿ƒåˆ·æ–°é¡µé¢ã€‚');
                    }).catch(error => {
                        console.warn('âš ï¸ ç«‹å³åŒæ­¥å¤±è´¥ï¼Œå°†åœ¨åå°é‡è¯•:', error);
                        // åŒæ­¥å¤±è´¥æ—¶è®¾ç½®é‡è¯•
                        window.syncTimeout = setTimeout(() => {
                            window.syncService.manualSync().catch(retryError => {
                                console.error('âŒ é‡è¯•åŒæ­¥ä¹Ÿå¤±è´¥:', retryError);
                            });
                        }, 1000);
                    });
                } else {
                    console.log('ğŸ’¡ åŒæ­¥æœåŠ¡æœªå¯ç”¨æˆ–ä¸å¯ç”¨');
                }

                // åˆ›å»ºå¤šé‡å¤‡ä»½ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒï¼‰

                createMultipleBackups();

                

            } catch (error) {

                console.error('âŒ ä¿å­˜å¤±è´¥:', error);

                MessageUtils.error('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');

            }

        }

        

        // å®‰å…¨çš„JSONåºåˆ—åŒ–å‡½æ•°

        function safeJsonStringify(data) {

            try {

                // ä½¿ç”¨è‡ªå®šä¹‰æ›¿æ¢å™¨ç¡®ä¿å­—ç¬¦å®‰å…¨

                return JSON.stringify(data, function(key, value) {

                    if (typeof value === 'string') {

                        // å¯¹å­—ç¬¦ä¸²å€¼è¿›è¡Œæ¸…ç†

                        return sanitizeText(value);

                    }

                    return value;

                }, 0);

            } catch (error) {

                console.error('âŒ JSONåºåˆ—åŒ–å¤±è´¥:', error);

                return null;

            }

        }



        // åˆ›å»ºå¤šé‡å¤‡ä»½

        async function createMultipleBackups() {

            try {

                const dataStr = JSON.stringify(monthlyEvents);

                const timestamp = new Date().toISOString();

                

                // 1. ä¿å­˜åˆ° sessionStorage

                sessionStorage.setItem('monthlyEventsTemp', dataStr);

                sessionStorage.setItem('monthlyEventsBackup', dataStr);

                sessionStorage.setItem('monthlyEventsBackupTime', timestamp);

                

                // 2. å¼‚æ­¥ä¿å­˜åˆ° IndexedDB

                saveToIndexedDB(monthlyEvents).catch(error => {

                    console.warn('IndexedDBä¿å­˜å¤±è´¥:', error);

                });

                

                // 3. ä¿å­˜åˆ°å¤šä¸ªlocalStorageé”®

                const backupKeys = ['backup_main', 'backup_secondary', 'backup_tertiary'];

                backupKeys.forEach((key, index) => {

                    try {

                        const backupData = {

                            timestamp: timestamp,

                            data: monthlyEvents,

                            source: 'monthly_schedule',

                            backupIndex: index

                        };

                        localStorage.setItem(key, JSON.stringify(backupData));

                    } catch (error) {

                        console.warn(`${key}ä¿å­˜å¤±è´¥:`, error);

                    }

                });

                

                // 4. å°è¯•ä¿å­˜åˆ° Cache API

                if ('caches' in window) {

                    try {

                        const cache = await caches.open('schedule-backup-v1');

                        const response = new Response(dataStr, {

                            headers: { 'Content-Type': 'application/json' }

                        });

                        await cache.put('/schedule-backup', response);

                    } catch (error) {

                        console.warn('Cacheä¿å­˜å¤±è´¥:', error);

                    }

                }

                

            } catch (error) {

                console.warn('å¤šé‡å¤‡ä»½å¤±è´¥:', error);

            }

        }



        function focusAddEvent() {

            document.getElementById('event-title').focus();

        }



        function exportCalendar() {

            try {

                const data = {

                    version: '1.0',

                    exportDate: new Date().toISOString(),

                    events: monthlyEvents,

                    totalEvents: Object.values(monthlyEvents).reduce((total, events) => total + events.length, 0)

                };

                

                const jsonString = JSON.stringify(data, null, 2);

                const blob = new Blob([jsonString], { type: 'application/json' });

                const url = URL.createObjectURL(blob);

                

                const a = document.createElement('a');

                a.href = url;

                a.download = `æœˆåº¦æ—¥ç¨‹_${new Date().toISOString().split('T')[0]}.json`;

                document.body.appendChild(a);

                a.click();

                document.body.removeChild(a);

                URL.revokeObjectURL(url);

                

                MessageUtils.success('æ—¥ç¨‹æ•°æ®å·²å¯¼å‡ºï¼');

            } catch (error) {

                console.error('å¯¼å‡ºå¤±è´¥:', error);

                MessageUtils.error('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');

            }

        }



        // æ•°æ®å¯¼å…¥åŠŸèƒ½

        function importCalendar() {

            document.getElementById('import-file-input').click();

        }



        function handleFileImport(event) {

            const file = event.target.files[0];

            if (!file) return;

            

            const reader = new FileReader();

            reader.onload = function(e) {

                try {

                    const data = JSON.parse(e.target.result);

                    

                    // éªŒè¯æ•°æ®æ ¼å¼

                    if (!data.events || typeof data.events !== 'object') {

                        throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');

                    }

                    

                    if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {

                        monthlyEvents = data.events;

                        saveEvents();

                        renderCalendar();

                        updateEventStats();

                        

                        const totalEvents = Object.values(monthlyEvents).reduce((total, events) => total + events.length, 0);

                        MessageUtils.success(`æ•°æ®å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${totalEvents} ä¸ªäº‹ä»¶`);

                    }

                } catch (error) {

                    console.error('å¯¼å…¥å¤±è´¥:', error);

                    MessageUtils.error('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');

                }

            };

            

            reader.readAsText(file);

            event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©

        }



        // äº‘ç«¯åŒæ­¥åŠŸèƒ½ - é‡å®šå‘åˆ°çœŸæ­£çš„åŒæ­¥ç³»ç»Ÿ

        async function syncData() {

            // é‡å®šå‘åˆ°æ–°çš„æ‰‹åŠ¨åŒæ­¥åŠŸèƒ½

            await manualSyncData();

        }



        // æ‰§è¡Œå®Œæ•´å¤‡ä»½ç­–ç•¥

        async function performFullBackup() {

            return new Promise((resolve, reject) => {

                setTimeout(async () => {

                    try {

                        const dataStr = JSON.stringify(monthlyEvents);

                        const timestamp = new Date().toISOString();

                        

                        // 1. ä¿å­˜åˆ° sessionStorageï¼ˆä¸´æ—¶ï¼‰

                        sessionStorage.setItem('monthlyEventsBackup', dataStr);

                        sessionStorage.setItem('monthlyEventsBackupTime', timestamp);

                        

                        // 2. ä¿å­˜åˆ° IndexedDBï¼ˆæŒä¹…åŒ–ï¼‰

                        await saveToIndexedDB(monthlyEvents);

                        

                        // 3. ä¿å­˜åˆ°å¤šä¸ªlocalStorageé”®ï¼ˆåˆ†æ•£é£é™©ï¼‰

                        const backupKeys = ['backup_main', 'backup_secondary', 'backup_tertiary'];

                        backupKeys.forEach((key, index) => {

                            const backupData = {

                                timestamp: timestamp,

                                data: monthlyEvents,

                                source: 'monthly_schedule',

                                backupIndex: index

                            };

                            localStorage.setItem(key, JSON.stringify(backupData));

                        });

                        

                        // 4. å°è¯•ä¿å­˜åˆ°å…¶ä»–å¯ç”¨å­˜å‚¨

                        try {

                            // ä½¿ç”¨ Cache API ä½œä¸ºé¢å¤–å¤‡ä»½

                            if ('caches' in window) {

                                const cache = await caches.open('schedule-backup-v1');

                                const response = new Response(dataStr, {

                                    headers: { 'Content-Type': 'application/json' }

                                });

                                await cache.put('/schedule-backup', response);

                            }

                        } catch (cacheError) {

                            console.warn('Cacheå¤‡ä»½å¤±è´¥:', cacheError);

                        }

                        

                        resolve();

                    } catch (error) {

                        reject(error);

                    }

                }, 800);

            });

        }



        // è‡ªåŠ¨ä¸‹è½½å¤‡ä»½æ–‡ä»¶

        async function createDownloadBackup() {

            return new Promise((resolve) => {

                try {

                    const data = {

                        version: '1.0',

                        exportDate: new Date().toISOString(),

                        events: monthlyEvents,

                        totalEvents: Object.values(monthlyEvents).reduce((total, events) => total + events.length, 0),

                        autoBackup: true

                    };

                    

                    const jsonString = JSON.stringify(data, null, 2);

                    const blob = new Blob([jsonString], { type: 'application/json' });

                    const url = URL.createObjectURL(blob);

                    

                    // é™é»˜ä¸‹è½½ï¼ˆä¸æ˜¾ç¤ºä¸‹è½½å¯¹è¯æ¡†ï¼‰

                    const a = document.createElement('a');

                    a.href = url;

                    a.download = `è‡ªåŠ¨å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;

                    a.style.display = 'none';

                    document.body.appendChild(a);

                    a.click();

                    document.body.removeChild(a);

                    URL.revokeObjectURL(url);

                    

                    resolve();

                } catch (error) {

                    console.warn('ä¸‹è½½å¤‡ä»½å¤±è´¥:', error);

                    resolve();

                }

            });

        }



        // IndexedDB æŒä¹…åŒ–å­˜å‚¨

        function saveToIndexedDB(data) {

            return new Promise((resolve, reject) => {

                const request = indexedDB.open('PlanManagerDB', 1);

                

                request.onerror = () => reject(request.error);

                

                request.onsuccess = () => {

                    const db = request.result;

                    const transaction = db.transaction(['schedules'], 'readwrite');

                    const store = transaction.objectStore('schedules');

                    

                    const saveRequest = store.put({

                        id: 'monthly_events',

                        data: data,

                        timestamp: new Date().toISOString()

                    });

                    

                    saveRequest.onsuccess = () => resolve();

                    saveRequest.onerror = () => reject(saveRequest.error);

                };

                

                request.onupgradeneeded = (event) => {

                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('schedules')) {

                        db.createObjectStore('schedules', { keyPath: 'id' });

                    }

                };

            });

        }



        // ä» IndexedDB æ¢å¤æ•°æ®

        function loadFromIndexedDB() {

            return new Promise((resolve, reject) => {

                const request = indexedDB.open('PlanManagerDB', 1);

                

                request.onerror = () => reject(request.error);

                

                request.onsuccess = () => {

                    const db = request.result;

                    const transaction = db.transaction(['schedules'], 'readonly');

                    const store = transaction.objectStore('schedules');

                    

                    const getRequest = store.get('monthly_events');

                    

                    getRequest.onsuccess = () => {

                        if (getRequest.result) {

                            resolve(getRequest.result.data);

                        } else {

                            resolve(null);

                        }

                    };

                    

                    getRequest.onerror = () => reject(getRequest.error);

                };

                

                request.onupgradeneeded = (event) => {

                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('schedules')) {

                        db.createObjectStore('schedules', { keyPath: 'id' });

                    }

                };

            });

        }



        // åˆ›å»ºæœ¬åœ°å¤‡ä»½

        function createLocalBackup() {

            const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

            const newBackup = {

                id: Date.now(),

                timestamp: new Date().toISOString(),

                data: monthlyEvents,

                eventCount: Object.values(monthlyEvents).reduce((total, events) => total + events.length, 0)

            };

            

            backups.unshift(newBackup);

            

            // åªä¿ç•™æœ€è¿‘10ä¸ªå¤‡ä»½

            if (backups.length > 10) {

                backups.splice(10);

            }

            

            localStorage.setItem('monthlyBackups', JSON.stringify(backups));

        }



        // å…¨é¢æ•°æ®æ¢å¤æœºåˆ¶

        async function initDataRecovery() {

            try {

                // ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åŠ è½½å‡½æ•°ï¼Œæ”¯æŒä»äº‘åŒæ­¥é”®æ¢å¤
                const localData = loadAndCleanData();

                const hasLocalData = Object.keys(localData).length > 0;

                

                if (hasLocalData) {

                    // å¦‚æœåŠ è½½åˆ°æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨ï¼ˆå¯èƒ½æ¥è‡ªæœ¬åœ°æˆ–äº‘ç«¯ï¼‰

                    monthlyEvents = localData;
                    console.log('âœ… ä»æœ¬åœ°æˆ–äº‘ç«¯åŠ è½½åˆ°æœˆåº¦æ•°æ®');

                    return;

                }

                

                // æœ¬åœ°æ•°æ®ä¸ºç©ºï¼Œå°è¯•ä»å„ç§å¤‡ä»½æºæ¢å¤

                console.log('æœ¬åœ°æ•°æ®ä¸ºç©ºï¼Œå¼€å§‹å°è¯•æ•°æ®æ¢å¤...');

                

                let recoveredData = null;

                let recoverySource = '';

                

                // 1. å°è¯•ä» IndexedDB æ¢å¤

                try {

                    const indexedData = await loadFromIndexedDB();

                    if (indexedData && Object.keys(indexedData).length > 0) {

                        recoveredData = indexedData;

                        recoverySource = 'IndexedDB';

                    }

                } catch (error) {

                    console.warn('IndexedDBæ¢å¤å¤±è´¥:', error);

                }

                

                // 2. å°è¯•ä» sessionStorage æ¢å¤

                if (!recoveredData) {

                    try {

                        const sessionData = sessionStorage.getItem('monthlyEventsBackup');

                        if (sessionData) {

                            const parsedData = JSON.parse(sessionData);

                            if (Object.keys(parsedData).length > 0) {

                                recoveredData = parsedData;

                                recoverySource = 'SessionStorage';

                            }

                        }

                    } catch (error) {

                        console.warn('SessionStorageæ¢å¤å¤±è´¥:', error);

                    }

                }

                

                // 3. å°è¯•ä»å¤šé‡localStorageå¤‡ä»½æ¢å¤

                if (!recoveredData) {

                    const backupKeys = ['backup_main', 'backup_secondary', 'backup_tertiary'];

                    for (const key of backupKeys) {

                        try {

                            const backupStr = localStorage.getItem(key);

                            if (backupStr) {

                                const backupData = JSON.parse(backupStr);

                                if (backupData.data && Object.keys(backupData.data).length > 0) {

                                    recoveredData = backupData.data;

                                    recoverySource = `LocalStorage(${key})`;

                                    break;

                                }

                            }

                        } catch (error) {

                            console.warn(`${key}æ¢å¤å¤±è´¥:`, error);

                        }

                    }

                }

                

                // 4. å°è¯•ä» Cache API æ¢å¤

                if (!recoveredData) {

                    try {

                        if ('caches' in window) {

                            const cache = await caches.open('schedule-backup-v1');

                            const response = await cache.match('/schedule-backup');

                            if (response) {

                                const cacheData = await response.json();

                                if (Object.keys(cacheData).length > 0) {

                                    recoveredData = cacheData;

                                    recoverySource = 'Cache API';

                                }

                            }

                        }

                    } catch (error) {

                        console.warn('Cache APIæ¢å¤å¤±è´¥:', error);

                    }

                }

                

                // 5. å°è¯•ä»æœ¬åœ°å¤‡ä»½å†å²æ¢å¤

                if (!recoveredData) {

                    try {

                        const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

                        if (backups.length > 0) {

                            // ä½¿ç”¨æœ€æ–°çš„å¤‡ä»½

                            const latestBackup = backups[0];

                            if (latestBackup.data && Object.keys(latestBackup.data).length > 0) {

                                recoveredData = latestBackup.data;

                                recoverySource = 'æœ¬åœ°å¤‡ä»½å†å²';

                            }

                        }

                    } catch (error) {

                        console.warn('å¤‡ä»½å†å²æ¢å¤å¤±è´¥:', error);

                    }

                }

                

                // å¦‚æœæ‰¾åˆ°äº†æ¢å¤æ•°æ®ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦æ¢å¤

                if (recoveredData) {

                    const eventCount = Object.values(recoveredData).reduce((total, events) => total + events.length, 0);

                    const shouldRestore = confirm(`å‘ç°å¤‡ä»½æ•°æ®ï¼\n\næ•°æ®æº: ${recoverySource}\näº‹ä»¶æ•°é‡: ${eventCount} ä¸ª\n\næ˜¯å¦æ¢å¤è¿™äº›æ•°æ®ï¼Ÿ`);

                    

                    if (shouldRestore) {

                        monthlyEvents = recoveredData;

                        saveEvents();

                        renderCalendar();

                        updateEventStats();

                        MessageUtils.success(`æ•°æ®å·²ä»${recoverySource}æ¢å¤ï¼å…±æ¢å¤ ${eventCount} ä¸ªäº‹ä»¶`);

                    }

                } else {

                    // æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¤‡ä»½æ•°æ®

                    console.log('æœªæ‰¾åˆ°ä»»ä½•å¤‡ä»½æ•°æ®');

                    showDataRecoveryHelp();

                }

                

            } catch (error) {

                console.error('æ•°æ®æ¢å¤è¿‡ç¨‹å‡ºé”™:', error);

                showDataRecoveryHelp();

            }

        }



        // æ˜¾ç¤ºæ•°æ®æ¢å¤å¸®åŠ©ä¿¡æ¯

        function showDataRecoveryHelp() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»å…³é—­è¿‡æ¢å¤åŠ©æ‰‹
            const helpDismissed = localStorage.getItem('recoveryHelpDismissed');
            if (helpDismissed === 'true') {
                console.log('ğŸ’¡ ç”¨æˆ·å·²å…³é—­è¿‡æ¢å¤åŠ©æ‰‹ï¼Œä¸å†æ˜¾ç¤º');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡è®¿é—®
            const firstVisit = !localStorage.getItem('monthlyScheduleVisited');
            if (firstVisit) {
                localStorage.setItem('monthlyScheduleVisited', 'true');
                console.log('ğŸ’¡ é¦–æ¬¡è®¿é—®ï¼Œä¸æ˜¾ç¤ºæ¢å¤åŠ©æ‰‹');
                return;
            }

            const helpModal = document.createElement('div');

            helpModal.className = 'recovery-help-modal';

            helpModal.innerHTML = `

                <div class="recovery-help-content">

                    <div class="recovery-help-header">

                        <h3>ğŸ” æ•°æ®æ¢å¤åŠ©æ‰‹</h3>

                        <button class="close-modal" onclick="closeRecoveryHelp()">&times;</button>

                    </div>

                    <div class="recovery-help-body">

                        <p><strong>æœªæ£€æµ‹åˆ°å¤‡ä»½æ•°æ®ï¼Œä½†æ‚¨å¯ä»¥å°è¯•ä»¥ä¸‹æ–¹æ³•æ¢å¤ï¼š</strong></p>

                        <div class="recovery-options">

                            <div class="recovery-option">

                                <span class="recovery-icon">ğŸ“</span>

                                <div class="recovery-text">

                                    <h4>ä»æ–‡ä»¶æ¢å¤</h4>

                                    <p>å¦‚æœæ‚¨ä¹‹å‰å¯¼å‡ºè¿‡æ•°æ®æ–‡ä»¶ï¼Œå¯ä»¥ç‚¹å‡»"å¯¼å…¥"æŒ‰é’®é€‰æ‹©æ–‡ä»¶æ¢å¤</p>

                                </div>

                                <button onclick="importCalendar(); closeRecoveryHelp();" class="btn-main">å¯¼å…¥æ–‡ä»¶</button>

                            </div>

                            <div class="recovery-option">

                                <span class="recovery-icon">ğŸ”„</span>

                                <div class="recovery-text">

                                    <h4>é‡æ–°åŒæ­¥</h4>

                                    <p>å°è¯•é‡æ–°åŒæ­¥ï¼Œå¯èƒ½ä¼šæ‰¾åˆ°å…¶ä»–å­˜å‚¨ä½ç½®çš„æ•°æ®</p>

                                </div>

                                <button onclick="syncData(); closeRecoveryHelp();" class="btn-main">ç«‹å³åŒæ­¥</button>

                            </div>

                            <div class="recovery-option">

                                <span class="recovery-icon">ğŸ’¡</span>

                                <div class="recovery-text">

                                    <h4>é¢„é˜²å»ºè®®</h4>

                                    <p>å»ºè®®å®šæœŸç‚¹å‡»"åŒæ­¥"æŒ‰é’®åˆ›å»ºå¤‡ä»½ï¼Œå¹¶å¯¼å‡ºé‡è¦æ•°æ®åˆ°æœ¬åœ°æ–‡ä»¶</p>

                                </div>

                                <button onclick="dismissRecoveryHelp();" class="btn-main">çŸ¥é“äº†ï¼Œä¸å†æ˜¾ç¤º</button>

                            </div>

                        </div>
                        
                        <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee;">
                            <label style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9em; color: #666; cursor: pointer;">
                                <input type="checkbox" id="dontShowAgain" />
                                <span>ä¸å†æ˜¾ç¤ºæ­¤åŠ©æ‰‹</span>
                            </label>
                        </div>

                    </div>

                </div>

            `;

            document.body.appendChild(helpModal);

        }



        function closeRecoveryHelp() {
            const modal = document.querySelector('.recovery-help-modal');
            if (modal) {
                // æ£€æŸ¥æ˜¯å¦å‹¾é€‰äº†"ä¸å†æ˜¾ç¤º"
                const dontShowAgain = document.getElementById('dontShowAgain');
                if (dontShowAgain && dontShowAgain.checked) {
                    localStorage.setItem('recoveryHelpDismissed', 'true');
                    console.log('ğŸ’¡ ç”¨æˆ·é€‰æ‹©ä¸å†æ˜¾ç¤ºæ¢å¤åŠ©æ‰‹');
                }
                modal.remove();
            }
        }
        
        // æ°¸ä¹…å…³é—­æ¢å¤åŠ©æ‰‹
        function dismissRecoveryHelp() {
            localStorage.setItem('recoveryHelpDismissed', 'true');
            console.log('ğŸ’¡ ç”¨æˆ·æ°¸ä¹…å…³é—­æ¢å¤åŠ©æ‰‹');
            closeRecoveryHelp();
            
            // æ˜¾ç¤ºé‡ç½®æŒ‰é’®
            const resetBtn = document.getElementById('reset-help-btn');
            if (resetBtn) {
                resetBtn.style.display = 'inline-block';
                resetBtn.title = 'é‡æ–°å¯ç”¨æ•°æ®æ¢å¤åŠ©æ‰‹';
            }
        }
        
        // é‡ç½®æ¢å¤åŠ©æ‰‹è®¾ç½®
        function resetRecoveryHelp() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¯ç”¨æ•°æ®æ¢å¤åŠ©æ‰‹å—ï¼Ÿ\n\né‡æ–°å¯ç”¨åï¼Œå½“æ£€æµ‹ä¸åˆ°æ•°æ®æ—¶ä¼šæ˜¾ç¤ºæ¢å¤åŠ©æ‰‹ã€‚')) {
                localStorage.removeItem('recoveryHelpDismissed');
                localStorage.removeItem('monthlyScheduleVisited');
                console.log('ğŸ’¡ æ¢å¤åŠ©æ‰‹è®¾ç½®å·²é‡ç½®');
                
                // éšè—é‡ç½®æŒ‰é’®
                const resetBtn = document.getElementById('reset-help-btn');
                if (resetBtn) {
                    resetBtn.style.display = 'none';
                }
                
                alert('æ¢å¤åŠ©æ‰‹å·²é‡æ–°å¯ç”¨ï¼\n\nä¸‹æ¬¡æ‰“å¼€é¡µé¢æ—¶ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å°†ä¼šæ˜¾ç¤ºæ¢å¤åŠ©æ‰‹ã€‚');
            }
        }
        
        // æ£€æŸ¥é‡ç½®æŒ‰é’®çš„å¯è§æ€§
        function checkResetButtonVisibility() {
            const helpDismissed = localStorage.getItem('recoveryHelpDismissed');
            const resetBtn = document.getElementById('reset-help-btn');
            
            if (resetBtn) {
                if (helpDismissed === 'true') {
                    resetBtn.style.display = 'inline-block';
                    resetBtn.title = 'é‡æ–°å¯ç”¨æ•°æ®æ¢å¤åŠ©æ‰‹';
                } else {
                    resetBtn.style.display = 'none';
                }
            }
        }



        // å¤„ç†åŒæ­¥åçš„æ•°æ®
        function handleSyncedData() {
            try {
                console.log('ğŸ”„ å¤„ç†åŒæ­¥åçš„æ•°æ®...');
                
                // è·å–æœ¬åœ°åˆ é™¤è®°å½•
                const deletedEvents = JSON.parse(localStorage.getItem('deletedEvents') || '[]');
                console.log('ğŸ“ æœ¬åœ°åˆ é™¤è®°å½•:', deletedEvents.length, 'ä¸ª');
                
                // é‡æ–°åŠ è½½æ•°æ®ï¼ˆä¼˜å…ˆä»äº‘åŒæ­¥æ•°æ®åŠ è½½æœ€æ–°æ•°æ®ï¼‰
                let cleanedData = loadAndCleanData();
                if (Object.keys(cleanedData).length > 0) {
                    
                    // ç‰¹åˆ«æ£€æŸ¥å¹¶æ¸…ç†æŸåæ•°æ®ï¼ˆå¦‚15å·çš„ç¼–ç é”™è¯¯ï¼‰
                    monthlyEvents = cleanedData;
                    const hadCorruption = forceCleanSpecificDates();
                    cleanedData = monthlyEvents; // è·å–æ¸…ç†åçš„æ•°æ®
                    
                    // æ£€æµ‹æ˜¯å¦ä»æœ‰æŸåæ•°æ®ï¼ˆç‰¹åˆ«æ˜¯15å·ï¼‰
                    let hasCorruptedData = false;
                    const corruptedDates = [];
                    
                    for (const [date, events] of Object.entries(cleanedData)) {
                        if (Array.isArray(events)) {
                            for (const event of events) {
                                if (event.title && (event.title.includes('Ã‚') || event.title.includes('\u00C2'))) {
                                    hasCorruptedData = true;
                                    if (!corruptedDates.includes(date)) {
                                        corruptedDates.push(date);
                                    }
                                }
                            }
                        }
                    }
                    
                    // åº”ç”¨æœ¬åœ°åˆ é™¤è®°å½•ï¼Œç¡®ä¿åˆ é™¤çš„äº‹ä»¶ä¸ä¼šå› ä¸ºåŒæ­¥è€Œæ¢å¤
                    if (deletedEvents.length > 0) {
                        console.log('ğŸ—‘ï¸ åº”ç”¨æœ¬åœ°åˆ é™¤è®°å½•...');
                        
                        for (const deletion of deletedEvents) {
                            const { date, event: deletedEvent } = deletion;
                            
                            if (cleanedData[date]) {
                                // æŸ¥æ‰¾å¹¶ç§»é™¤åŒ¹é…çš„äº‹ä»¶
                                cleanedData[date] = cleanedData[date].filter(event => {
                                    const isMatch = event.title === deletedEvent.title && 
                                                  event.time === deletedEvent.time;
                                    
                                    if (isMatch) {
                                        console.log(`ğŸ—‘ï¸ é‡æ–°åº”ç”¨åˆ é™¤: ${date} - ${event.title}`);
                                    }
                                    
                                    return !isMatch;
                                });
                                
                                // å¦‚æœè¯¥æ—¥æœŸæ²¡æœ‰äº‹ä»¶äº†ï¼Œåˆ é™¤æ•´ä¸ªæ—¥æœŸæ¡ç›®
                                if (cleanedData[date].length === 0) {
                                    delete cleanedData[date];
                                }
                            }
                        }
                        
                        console.log('âœ… åˆ é™¤è®°å½•åº”ç”¨å®Œæˆ');
                    }
                    
                    monthlyEvents = cleanedData;
                    
                    // åªæœ‰åº”ç”¨äº†åˆ é™¤è®°å½•æ—¶æ‰éœ€è¦ä¿å­˜æ•°æ®
                    if (deletedEvents.length > 0) {
                        console.log('ğŸ’¾ ä¿å­˜åº”ç”¨åˆ é™¤è®°å½•åçš„æ•°æ®...');
                        saveEvents();
                    } else {
                        console.log('âœ… æ— åˆ é™¤è®°å½•éœ€è¦åº”ç”¨ï¼Œè·³è¿‡ä¿å­˜');
                    }
                    
                    // é‡æ–°æ¸²æŸ“è§†å›¾
                    renderCalendar();
                    updateEventStats();
                    
                    // å¦‚æœæœ‰é€‰ä¸­çš„æ—¥æœŸï¼Œæ›´æ–°æ˜¾ç¤º
                    if (selectedDate) {
                        displaySelectedDayEvents(selectedDate);
                    }
                    
                    // å¦‚æœæ£€æµ‹åˆ°æŸåæ•°æ®ï¼Œæç¤ºç”¨æˆ·å¼ºåˆ¶ä¿å­˜
                    if (hasCorruptedData) {
                        console.log('ğŸš¨ æ£€æµ‹åˆ°åŒæ­¥åä»æœ‰æŸåæ•°æ®:', corruptedDates);
                        
                        setTimeout(() => {
                            const shouldForceSave = confirm(
                                `æ£€æµ‹åˆ°åŒæ­¥åä»æœ‰æŸåæ•°æ®ï¼\n\n` +
                                `å—å½±å“çš„æ—¥æœŸ: ${corruptedDates.join(', ')}\n\n` +
                                `å»ºè®®ç‚¹å‡»"ğŸ’¾ ä¿å­˜"æŒ‰é’®å¼ºåˆ¶ä¿å­˜æ­£ç¡®æ•°æ®åˆ°äº‘ç«¯ï¼Œ\n` +
                                `è¿™å°†å½»åº•è§£å†³15å·ç­‰æ—¥æœŸçš„é”™è¯¯æ˜¾ç¤ºé—®é¢˜ã€‚\n\n` +
                                `æ˜¯å¦ç°åœ¨å¼ºåˆ¶ä¿å­˜ï¼Ÿ`
                            );
                            
                            if (shouldForceSave) {
                                forceSaveData();
                            } else {
                                MessageUtils.warning('æ£€æµ‹åˆ°æ•°æ®é—®é¢˜ï¼Œå»ºè®®æ‰‹åŠ¨ç‚¹å‡»"ğŸ’¾ ä¿å­˜"æŒ‰é’®');
                                // é«˜äº®ä¿å­˜æŒ‰é’®
                                highlightSaveButton();
                            }
                        }, 1000);
                    }
                    
                    console.log('âœ… åŒæ­¥æ•°æ®å·²å¤„ç†å’Œæ¸…ç†');
                }
            } catch (error) {
                console.error('âŒ å¤„ç†åŒæ­¥æ•°æ®å¤±è´¥:', error);
                MessageUtils.error('åŒæ­¥æ•°æ®å¤„ç†å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
        
        // é«˜äº®ä¿å­˜æŒ‰é’®
        function highlightSaveButton() {
            const saveBtn = document.getElementById('force-save-btn');
            if (saveBtn) {
                // æ·»åŠ é—ªçƒæ•ˆæœ
                saveBtn.style.animation = 'pulse 1s infinite';
                saveBtn.style.boxShadow = '0 0 10px #4caf50';
                
                // 5ç§’åç§»é™¤æ•ˆæœ
                setTimeout(() => {
                    saveBtn.style.animation = '';
                    saveBtn.style.boxShadow = '';
                }, 5000);
            }
        }

        // ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°

        function initMonthlySchedule() {

            // è®¾ç½®ä»Šå¤©ä¸ºé»˜è®¤é€‰æ‹©æ—¥æœŸ

            const today = DateUtils.getToday();

            document.getElementById('event-date').value = today;

            

            // å°è¯•æ•°æ®æ¢å¤

            initDataRecovery();

            

            // åˆå§‹åŒ–åŒæ­¥ç³»ç»Ÿ

            initSyncSystem();

            

            // æ¸²æŸ“æ—¥å†

            renderCalendar();

            updateEventStats();

            

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨

            setupEventListeners();
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºé‡ç½®åŠ©æ‰‹æŒ‰é’®
            checkResetButtonVisibility();

            

            // å®šæœŸè‡ªåŠ¨å¤‡ä»½ï¼ˆæ¯5åˆ†é’Ÿï¼‰

            setInterval(createLocalBackup, 5 * 60 * 1000);

        }



        function showListView() {

            // åˆ›å»ºåˆ—è¡¨è§†å›¾æ¨¡æ€æ¡†

            const modal = document.createElement('div');

            modal.className = 'list-view-modal';

            modal.innerHTML = `

                <div class="list-view-content">

                    <div class="list-view-header">

                        <h3>ğŸ“‹ åˆ—è¡¨è§†å›¾</h3>

                        <button class="close-modal" onclick="closeListView()">&times;</button>

                    </div>

                    <div class="list-view-controls">

                        <select id="list-filter-month">

                            <option value="all">å…¨éƒ¨æœˆä»½</option>

                        </select>

                        <select id="list-filter-category">

                            <option value="all">å…¨éƒ¨åˆ†ç±»</option>

                            <option value="work">ğŸ’¼ å·¥ä½œ</option>

                            <option value="personal">ğŸ‘¤ ä¸ªäºº</option>

                            <option value="health">ğŸƒ å¥åº·</option>

                            <option value="learning">ğŸ“š å­¦ä¹ </option>

                            <option value="social">ğŸ‘¥ ç¤¾äº¤</option>

                            <option value="other">ğŸ“‹ å…¶ä»–</option>

                        </select>

                        <input type="text" id="list-search" placeholder="æœç´¢äº‹ä»¶..." />

                    </div>

                    <div class="list-view-body" id="list-view-events">

                        <!-- äº‹ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->

                    </div>

                </div>

            `;

            

            document.body.appendChild(modal);

            

            // å¡«å……æœˆä»½é€‰é¡¹

            populateMonthFilter();

            

            // æ˜¾ç¤ºæ‰€æœ‰äº‹ä»¶

            renderListView();

            

            // ç»‘å®šç­›é€‰äº‹ä»¶

            document.getElementById('list-filter-month').addEventListener('change', renderListView);

            document.getElementById('list-filter-category').addEventListener('change', renderListView);

            document.getElementById('list-search').addEventListener('input', renderListView);

        }



        // åˆ—è¡¨è§†å›¾ç›¸å…³å‡½æ•°

        function populateMonthFilter() {

            const monthFilter = document.getElementById('list-filter-month');

            const months = new Set();

            

            Object.keys(monthlyEvents).forEach(dateKey => {

                const date = new Date(dateKey);

                const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;

                months.add(monthKey);

            });

            

            Array.from(months).sort().forEach(monthKey => {

                const [year, month] = monthKey.split('-');

                const option = document.createElement('option');

                option.value = monthKey;

                option.textContent = `${year}å¹´${month}æœˆ`;

                monthFilter.appendChild(option);

            });

        }



        function renderListView() {

            const container = document.getElementById('list-view-events');

            const monthFilter = document.getElementById('list-filter-month').value;

            const categoryFilter = document.getElementById('list-filter-category').value;

            const searchTerm = document.getElementById('list-search').value.toLowerCase();

            

            // æ”¶é›†æ‰€æœ‰äº‹ä»¶

            const allEvents = [];

            Object.entries(monthlyEvents).forEach(([date, events]) => {

                events.forEach(event => {

                    allEvents.push({ ...event, date });

                });

            });

            

            // ç­›é€‰äº‹ä»¶

            let filteredEvents = allEvents.filter(event => {

                const eventDate = new Date(event.date);

                const eventMonthKey = `${eventDate.getFullYear()}-${eventDate.getMonth() + 1}`;

                

                // æœˆä»½ç­›é€‰

                if (monthFilter !== 'all' && eventMonthKey !== monthFilter) {

                    return false;

                }

                

                // åˆ†ç±»ç­›é€‰

                if (categoryFilter !== 'all' && event.category !== categoryFilter) {

                    return false;

                }

                

                // æœç´¢ç­›é€‰

                if (searchTerm && !event.title.toLowerCase().includes(searchTerm) && !event.description.toLowerCase().includes(searchTerm)) {

                    return false;

                }

                

                return true;

            });

            

            // æŒ‰æ—¥æœŸå’Œæ—¶é—´æ’åº

            filteredEvents.sort((a, b) => {

                const dateCompare = new Date(a.date) - new Date(b.date);

                if (dateCompare !== 0) return dateCompare;

                return a.time.localeCompare(b.time);

            });

            

            // æ¸²æŸ“äº‹ä»¶åˆ—è¡¨

            if (filteredEvents.length === 0) {

                container.innerHTML = `

                    <div class="no-events">

                        <div style="font-size: 2em; margin-bottom: 12px;">ğŸ“…</div>

                        <p>æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„äº‹ä»¶</p>

                    </div>

                `;

                return;

            }

            

            container.innerHTML = '';

            let currentDate = '';

            

            filteredEvents.forEach((event, index) => {

                const eventDate = new Date(event.date);

                const dateStr = `${eventDate.getMonth() + 1}æœˆ${eventDate.getDate()}æ—¥ (${DateUtils.getWeekdayName(eventDate)})`;

                

                // æ—¥æœŸåˆ†ç»„

                if (dateStr !== currentDate) {

                    currentDate = dateStr;

                    const dateHeader = document.createElement('div');

                    dateHeader.className = 'list-date-header';

                    dateHeader.textContent = dateStr;

                    container.appendChild(dateHeader);

                }

                

                // äº‹ä»¶é¡¹

                const eventItem = document.createElement('div');

                eventItem.className = 'list-event-item';

                eventItem.innerHTML = `

                    <div class="list-event-time">${event.time}</div>

                    <div class="list-event-content">

                        <div class="list-event-title">${event.title}</div>

                        <div class="list-event-category">${getCategoryIcon(event.category)} ${getCategoryName(event.category)}</div>

                        ${event.description ? `<div class="list-event-description">${event.description}</div>` : ''}

                    </div>

                    <div class="list-event-actions">

                        <button onclick="editEventFromList('${event.date}', ${getEventIndex(event.date, event)})" title="ç¼–è¾‘">âœï¸</button>

                        <button onclick="deleteEventFromList('${event.date}', ${getEventIndex(event.date, event)})" title="åˆ é™¤">ğŸ—‘ï¸</button>

                    </div>

                `;

                container.appendChild(eventItem);

            });

        }



        function getCategoryIcon(category) {

            const icons = {

                work: 'ğŸ’¼',

                personal: 'ğŸ‘¤',

                health: 'ğŸƒ',

                learning: 'ğŸ“š',

                social: 'ğŸ‘¥',

                other: 'ğŸ“‹'

            };

            return icons[category] || 'ğŸ“‹';

        }



        function getCategoryName(category) {

            const names = {

                work: 'å·¥ä½œ',

                personal: 'ä¸ªäºº',

                health: 'å¥åº·',

                learning: 'å­¦ä¹ ',

                social: 'ç¤¾äº¤',

                other: 'å…¶ä»–'

            };

            return names[category] || 'å…¶ä»–';

        }



        function getEventIndex(date, targetEvent) {

            const events = monthlyEvents[date] || [];

            return events.findIndex(event => 

                event.title === targetEvent.title && 

                event.time === targetEvent.time && 

                event.createdAt === targetEvent.createdAt

            );

        }



        function editEventFromList(date, index) {

            const event = monthlyEvents[date][index];

            if (!event) return;

            

            // å¡«å……è¡¨å•

            document.getElementById('event-title').value = event.title;

            document.getElementById('event-date').value = date;

            document.getElementById('event-time').value = event.time;

            document.getElementById('event-category').value = event.category;

            document.getElementById('event-description').value = event.description || '';

            

            // åˆ é™¤åŸäº‹ä»¶

            monthlyEvents[date].splice(index, 1);

            if (monthlyEvents[date].length === 0) {

                delete monthlyEvents[date];

            }

            

            saveEvents();

            renderCalendar();

            updateEventStats();

            

            // å…³é—­åˆ—è¡¨è§†å›¾

            closeListView();

            

            // èšç„¦åˆ°è¡¨å•

            document.getElementById('event-title').focus();

            

            MessageUtils.info('äº‹ä»¶å·²åŠ è½½åˆ°è¡¨å•ä¸­ï¼Œä¿®æ”¹åç‚¹å‡»æ·»åŠ å³å¯ä¿å­˜');

        }



        function deleteEventFromList(date, index) {

            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº‹ä»¶å—ï¼Ÿ')) {

                monthlyEvents[date].splice(index, 1);

                

                if (monthlyEvents[date].length === 0) {

                    delete monthlyEvents[date];

                }

                

                saveEvents();

                renderCalendar();

                updateEventStats();

                renderListView(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨

                

                MessageUtils.success('äº‹ä»¶å·²åˆ é™¤');

            }

        }



        function closeListView() {

            const modal = document.querySelector('.list-view-modal');

            if (modal) {

                modal.remove();

            }

        }



        // å¤‡ä»½ç®¡ç†å™¨

        function showBackupManager() {

            const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

            

            const modal = document.createElement('div');

            modal.className = 'backup-manager-modal';

            modal.innerHTML = `

                <div class="backup-manager-content">

                    <div class="backup-manager-header">

                        <h3>ğŸ—„ï¸ å¤‡ä»½ç®¡ç†</h3>

                        <button class="close-modal" onclick="closeBackupManager()">&times;</button>

                    </div>

                    <div class="backup-manager-body">

                        <div class="backup-info">

                            <p><strong>æ•°æ®ä¿æŠ¤çŠ¶æ€:</strong></p>

                            <div class="protection-status">

                                <div class="status-item">

                                    <span class="status-icon">ğŸ’¾</span>

                                    <span>æœ¬åœ°å­˜å‚¨: localStorage</span>

                                    <span class="status-ok">âœ“</span>

                                </div>

                                <div class="status-item">

                                    <span class="status-icon">ğŸ—ƒï¸</span>

                                    <span>æŒä¹…åŒ–å­˜å‚¨: IndexedDB</span>

                                    <span class="status-ok">âœ“</span>

                                </div>

                                <div class="status-item">

                                    <span class="status-icon">ğŸ“¦</span>

                                    <span>è‡ªåŠ¨å¤‡ä»½: æ¯5åˆ†é’Ÿ</span>

                                    <span class="status-ok">âœ“</span>

                                </div>

                            </div>

                        </div>

                        <div class="backup-actions">

                            <button onclick="createManualBackup()" class="btn-main">ğŸ“ ç«‹å³å¤‡ä»½</button>

                            <button onclick="downloadAllBackups()" class="btn-main">ğŸ’¾ ä¸‹è½½å…¨éƒ¨å¤‡ä»½</button>

                            <button onclick="clearOldBackups()" class="btn-danger">ğŸ—‘ï¸ æ¸…ç†æ—§å¤‡ä»½</button>

                        </div>

                        <div class="backup-list">

                            <h4>å¤‡ä»½å†å² (æœ€è¿‘10ä¸ª)</h4>

                            <div id="backup-list-container">

                                ${renderBackupList(backups)}

                            </div>

                        </div>

                    </div>

                </div>

            `;

            

            document.body.appendChild(modal);

        }



        function renderBackupList(backups) {

            if (backups.length === 0) {

                return '<div class="no-backups">æš‚æ— å¤‡ä»½è®°å½•</div>';

            }

            

            return backups.map(backup => {

                const date = new Date(backup.timestamp);

                const timeStr = date.toLocaleString('zh-CN');

                const sizeKB = Math.round(JSON.stringify(backup.data).length / 1024);

                

                return `

                    <div class="backup-item">

                        <div class="backup-info-item">

                            <div class="backup-time">${timeStr}</div>

                            <div class="backup-details">

                                ${backup.eventCount} ä¸ªäº‹ä»¶ â€¢ ${sizeKB} KB

                            </div>

                        </div>

                        <div class="backup-actions-item">

                            <button onclick="restoreBackup(${backup.id})" class="btn-small">æ¢å¤</button>

                            <button onclick="downloadBackup(${backup.id})" class="btn-small">ä¸‹è½½</button>

                            <button onclick="deleteBackup(${backup.id})" class="btn-small btn-danger">åˆ é™¤</button>

                        </div>

                    </div>

                `;

            }).join('');

        }



        function createManualBackup() {

            createLocalBackup();

            MessageUtils.success('æ‰‹åŠ¨å¤‡ä»½å·²åˆ›å»ºï¼');

            

            // åˆ·æ–°å¤‡ä»½åˆ—è¡¨

            const container = document.getElementById('backup-list-container');

            if (container) {

                const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

                container.innerHTML = renderBackupList(backups);

            }

        }



        function restoreBackup(backupId) {

            const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

            const backup = backups.find(b => b.id === backupId);

            

            if (!backup) {

                MessageUtils.error('å¤‡ä»½ä¸å­˜åœ¨');

                return;

            }

            

            if (confirm(`ç¡®å®šè¦æ¢å¤ ${new Date(backup.timestamp).toLocaleString('zh-CN')} çš„å¤‡ä»½å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ã€‚`)) {

                monthlyEvents = backup.data;

                saveEvents();

                renderCalendar();

                updateEventStats();

                

                closeBackupManager();

                MessageUtils.success('æ•°æ®å·²ä»å¤‡ä»½ä¸­æ¢å¤ï¼');

            }

        }



        function downloadBackup(backupId) {

            const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

            const backup = backups.find(b => b.id === backupId);

            

            if (!backup) {

                MessageUtils.error('å¤‡ä»½ä¸å­˜åœ¨');

                return;

            }

            

            const exportData = {

                version: '1.0',

                exportDate: backup.timestamp,

                events: backup.data,

                totalEvents: backup.eventCount,

                backupId: backup.id

            };

            

            const jsonString = JSON.stringify(exportData, null, 2);

            const blob = new Blob([jsonString], { type: 'application/json' });

            const url = URL.createObjectURL(blob);

            

            const a = document.createElement('a');

            a.href = url;

            a.download = `å¤‡ä»½_${new Date(backup.timestamp).toISOString().split('T')[0]}.json`;

            document.body.appendChild(a);

            a.click();

            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            

            MessageUtils.success('å¤‡ä»½å·²ä¸‹è½½ï¼');

        }



        function deleteBackup(backupId) {

            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤‡ä»½å—ï¼Ÿ')) {

                let backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

                backups = backups.filter(b => b.id !== backupId);

                localStorage.setItem('monthlyBackups', JSON.stringify(backups));

                

                // åˆ·æ–°å¤‡ä»½åˆ—è¡¨

                const container = document.getElementById('backup-list-container');

                if (container) {

                    container.innerHTML = renderBackupList(backups);

                }

                

                MessageUtils.success('å¤‡ä»½å·²åˆ é™¤');

            }

        }



        function downloadAllBackups() {

            const backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

            

            if (backups.length === 0) {

                MessageUtils.warning('æ²¡æœ‰å¯ä¸‹è½½çš„å¤‡ä»½');

                return;

            }

            

            const allData = {

                version: '1.0',

                exportDate: new Date().toISOString(),

                backupCount: backups.length,

                backups: backups

            };

            

            const jsonString = JSON.stringify(allData, null, 2);

            const blob = new Blob([jsonString], { type: 'application/json' });

            const url = URL.createObjectURL(blob);

            

            const a = document.createElement('a');

            a.href = url;

            a.download = `å…¨éƒ¨å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;

            document.body.appendChild(a);

            a.click();

            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            

            MessageUtils.success('å…¨éƒ¨å¤‡ä»½å·²ä¸‹è½½ï¼');

        }



        function clearOldBackups() {

            if (confirm('ç¡®å®šè¦æ¸…ç†æ—§å¤‡ä»½å—ï¼Ÿå°†åªä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½ã€‚')) {

                let backups = JSON.parse(localStorage.getItem('monthlyBackups') || '[]');

                backups = backups.slice(0, 3);

                localStorage.setItem('monthlyBackups', JSON.stringify(backups));

                

                // åˆ·æ–°å¤‡ä»½åˆ—è¡¨

                const container = document.getElementById('backup-list-container');

                if (container) {

                    container.innerHTML = renderBackupList(backups);

                }

                

                MessageUtils.success('æ—§å¤‡ä»½å·²æ¸…ç†');

            }

        }



        function closeBackupManager() {

            const modal = document.querySelector('.backup-manager-modal');

            if (modal) {

                modal.remove();

            }

        }



        // çœŸæ­£çš„äº‘ç«¯åŒæ­¥åŠŸèƒ½ - é›†æˆç°æœ‰åŒæ­¥ç³»ç»Ÿ

        function openSyncSettings() {

            // æ‰“å¼€åŒæ­¥è®¾ç½®é¡µé¢

            window.open('sync-settings.html', '_blank');

        }



        // æ‰‹åŠ¨åŒæ­¥æ•°æ®

        async function manualSyncData() {

            if (!window.syncService) {

                MessageUtils.error('åŒæ­¥æœåŠ¡æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');

                return;

            }



            const status = window.syncService.getSyncStatus();

            if (!status.enabled) {

                const shouldOpenSettings = confirm('åŒæ­¥åŠŸèƒ½å°šæœªå¯ç”¨ã€‚\n\næ˜¯å¦æ‰“å¼€åŒæ­¥è®¾ç½®é¡µé¢è¿›è¡Œé…ç½®ï¼Ÿ');

                if (shouldOpenSettings) {

                    openSyncSettings();

                }

                return;

            }



            try {

                MessageUtils.info('æ­£åœ¨åŒæ­¥æ•°æ®...');

                await window.syncService.manualSync();

                

                // å¤„ç†åŒæ­¥åçš„æ•°æ®

                handleSyncedData();

                

                MessageUtils.success('æ•°æ®åŒæ­¥æˆåŠŸï¼');

                updateSyncStatusDisplay();

            } catch (error) {

                console.error('åŒæ­¥å¤±è´¥:', error);

                MessageUtils.error('åŒæ­¥å¤±è´¥: ' + error.message);

            }

        }









        // åŒæ­¥çŠ¶æ€æ˜¾ç¤ºå’Œæ§åˆ¶

        function updateSyncStatusDisplay() {

            if (!window.syncService) return;

            

            const status = window.syncService.getSyncStatus();

            const syncBtn = document.getElementById('sync-data-btn');

            

            // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨ï¼Œé¿å…DOMå…ƒç´ ä¸å­˜åœ¨æ—¶çš„é”™è¯¯
            if (!syncBtn) {
                console.log('ğŸ’¡ sync-data-btn å…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°');
                return;
            }

            if (status.enabled) {

                if (status.online) {

                    syncBtn.innerHTML = 'â˜ï¸ åŒæ­¥ âœ…';

                    syncBtn.style.backgroundColor = '#4caf50';

                } else {

                    syncBtn.innerHTML = 'â˜ï¸ åŒæ­¥ âš ï¸';

                    syncBtn.style.backgroundColor = '#ff9800';

                }

            } else {

                syncBtn.innerHTML = 'â˜ï¸ åŒæ­¥';

                syncBtn.style.backgroundColor = '';

            }

        }



        // åˆå§‹åŒ–åŒæ­¥ç³»ç»Ÿ

        function initSyncSystem() {

            // ç­‰å¾…åŒæ­¥æœåŠ¡åŠ è½½å®Œæˆ

            setTimeout(() => {

                if (window.syncService) {

                    console.log('âœ… åŒæ­¥æœåŠ¡å·²åŠ è½½');

                    

                    // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º

                    updateSyncStatusDisplay();

                    

                    // ç›‘å¬åŒæ­¥äº‹ä»¶

                    window.addEventListener('sync-complete', function(event) {

                        console.log('åŒæ­¥å®Œæˆ:', event.detail);

                        updateSyncStatusDisplay();

                        

                        // å¤„ç†åŒæ­¥åçš„æ•°æ®

                        handleSyncedData();

                        

                        MessageUtils.success('æ•°æ®åŒæ­¥å®Œæˆ');

                    });

                    

                    window.addEventListener('sync-error', function(event) {

                        console.error('åŒæ­¥é”™è¯¯:', event.detail);

                        updateSyncStatusDisplay();

                    });

                    // ç›‘å¬äº‘ç«¯æ•°æ®æ¢å¤å®Œæˆäº‹ä»¶
                    window.addEventListener('data-restored', function(event) {
                        console.log('ğŸ‰ æ£€æµ‹åˆ°æ•°æ®æ¢å¤å®Œæˆ:', event.detail);
                        
                        // é‡æ–°åŠ è½½æœˆåº¦æ•°æ®å¹¶æ¸²æŸ“ç•Œé¢
                        monthlyEvents = loadAndCleanData();
                        renderCalendar();
                        updateEventStats();
                        
                        if (selectedDate) {
                            displaySelectedDayEvents(selectedDate);
                        }
                        
                        MessageUtils.success(`âœ… å·²ä»äº‘ç«¯æ¢å¤ ${event.detail.count} æ¡æœˆåº¦æ•°æ®ï¼`);
                    });

                    

                    // ç›‘å¬æ•°æ®å˜åŒ–ï¼Œè§¦å‘è‡ªåŠ¨åŒæ­¥

                    setupDataChangeSync();

                    // ğŸ”„ å¯åŠ¨æ—¶ä¸»åŠ¨ä»äº‘ç«¯æ‹‰å–æœ€æ–°æ•°æ®
                    setTimeout(() => {
                        console.log('ğŸ”„ å¯åŠ¨æ—¶æ£€æŸ¥äº‘ç«¯æœ€æ–°æ•°æ®...');
                        window.syncService.manualSync().then(() => {
                            console.log('âœ… å¯åŠ¨åŒæ­¥å®Œæˆ');
                            // åŒæ­¥å®Œæˆåé‡æ–°æ¸²æŸ“ç•Œé¢ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°æ•°æ®
                            renderCalendar();
                            if (selectedDate) {
                                displaySelectedDayEvents(selectedDate);
                            }
                        }).catch(error => {
                            console.warn('âš ï¸ å¯åŠ¨æ—¶äº‘ç«¯åŒæ­¥å¤±è´¥:', error);
                            // åŒæ­¥å¤±è´¥ä¸å½±å“æ­£å¸¸ä½¿ç”¨ï¼Œç»§ç»­ä½¿ç”¨æœ¬åœ°æ•°æ®
                        });
                    }, 2000); // ç­‰å¾…2ç§’ç¡®ä¿åŒæ­¥æœåŠ¡å®Œå…¨åˆå§‹åŒ–

                    

                } else {

                    console.warn('âš ï¸ åŒæ­¥æœåŠ¡æœªåŠ è½½');

                }

            }, 1000);

        }



        // è®¾ç½®æ•°æ®å˜åŒ–åŒæ­¥

        function setupDataChangeSync() {

            // é‡å†™saveEventså‡½æ•°ï¼Œåœ¨ä¿å­˜æ—¶è§¦å‘åŒæ­¥

            const originalSaveEvents = saveEvents;

            saveEvents = function() {

                // è°ƒç”¨åŸå§‹ä¿å­˜å‡½æ•°

                originalSaveEvents.call(this);

                

                // è§¦å‘æ•°æ®å˜åŒ–äº‹ä»¶

                if (window.syncService && window.syncService.getSyncStatus().enabled) {

                    // é˜²æŠ–åŒæ­¥ï¼Œé¿å…é¢‘ç¹åŒæ­¥

                    clearTimeout(window.syncTimeout);

                    window.syncTimeout = setTimeout(() => {

                        window.syncService.manualSync().catch(error => {

                            console.error('è‡ªåŠ¨åŒæ­¥å¤±è´¥:', error);

                        });

                    }, 3000); // 3ç§’ååŒæ­¥

                }

            };

        }



        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰åˆ†äº«é“¾æ¥å‚æ•°

        window.addEventListener('DOMContentLoaded', function() {

            const urlParams = new URLSearchParams(window.location.search);

            const importData = urlParams.get('import');

            

            if (importData) {

                try {

                    const jsonString = decodeURIComponent(escape(atob(importData)));

                    const data = JSON.parse(jsonString);

                    

                    if (data.events && confirm(`æ£€æµ‹åˆ°åˆ†äº«çš„å¤‡ä»½æ•°æ®ï¼\n\nå¤‡ä»½æ—¶é—´: ${new Date(data.exportDate).toLocaleString()}\näº‹ä»¶æ•°é‡: ${data.totalEvents} ä¸ª\n\næ˜¯å¦å¯¼å…¥è¿™äº›æ•°æ®ï¼Ÿ`)) {

                        monthlyEvents = data.events;

                        saveEvents();

                        renderCalendar();

                        updateEventStats();

                        

                        MessageUtils.success(`å·²å¯¼å…¥ ${data.totalEvents} ä¸ªäº‹ä»¶ï¼`);

                        

                        // æ¸…é™¤URLå‚æ•°

                        window.history.replaceState({}, document.title, window.location.pathname);

                    }

                } catch (error) {

                    console.error('å¯¼å…¥åˆ†äº«æ•°æ®å¤±è´¥:', error);

                }

            }

        });

    </script>

    <!-- åŒæ­¥æœåŠ¡ç³»ç»Ÿ -->
    <script src="universal-auto-sync.js"></script>

    <script src="add-ai-to-all-pages.js"></script>
    <script src="ai-fix-universal.js"></script>  <!-- AIåˆ†æåŠŸèƒ½ä¿®å¤ -->
</body>



</html>


