<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script src="config.js"></script>
    
    <!-- Firebaseé…ç½® -->
    <script src="firebase-config.js"></script>
    
    <!-- åŒæ­¥ä¿®å¤å·¥å…· -->
    <script src="sync-fix.js"></script>
    
    <!-- Firebaseæ•°æ®åº“åŒæ­¥ -->
    <script src="firebase-database-sync.js"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ˜Š å¿ƒæƒ…è®°å½• - æƒ…æ„Ÿç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .mood-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .mood-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #ff9800;
        }

        .mood-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .mood-item {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .mood-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .mood-item.selected {
            border-color: #ff9800;
            background: linear-gradient(135deg, #fff3e0, #ffcc02);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255,152,0,0.3);
        }

        .mood-emoji {
            font-size: 2.5em;
            display: block;
            margin-bottom: 8px;
        }

        .mood-label {
            font-size: 0.9em;
            font-weight: 600;
            color: #333;
        }

        .mood-value {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
        }

        .mood-history {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .mood-chart {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e0e0e0;
        }

        .mood-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: #ff9800;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
        }

        .mood-note {
            width: 100%;
            min-height: 100px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            margin-top: 12px;
        }

        .mood-note:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255,152,0,0.1);
        }

        .quick-moods {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }

        .quick-mood-btn {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffcc02;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-mood-btn:hover {
            background: #ff9800;
            color: white;
        }

        .insights-panel {
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border-left: 4px solid #4caf50;
        }

        .mood-timeline {
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
        }

        .timeline-emoji {
            font-size: 1.5em;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-time {
            font-size: 0.8em;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="page-header">
            <a href="day_plan.html" class="back-to-home">â† è¿”å›æ—¥è®¡åˆ’</a>
            <h1 class="page-title">ğŸ˜Š å¿ƒæƒ…è®°å½•</h1>
            <div style="display: flex; gap: 8px;">
                <button type="button" id="save-mood-btn" class="btn-main">ğŸ’¾ ä¿å­˜è®°å½•</button>
                <button type="button" id="export-mood-btn" class="btn-main">ğŸ“Š å¯¼å‡ºæ•°æ®</button>
            </div>
        </div>

        <div class="mood-container">
            <!-- å½“å‰å¿ƒæƒ…é€‰æ‹© -->
            <div class="mood-card">
                <h3 style="color: #ff9800; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    ğŸ˜Š ä»Šå¤©çš„å¿ƒæƒ…å¦‚ä½•ï¼Ÿ
                </h3>
                
                <div class="mood-selector">
                    <div class="mood-item" data-mood="terrible" data-value="1">
                        <span class="mood-emoji">ğŸ˜­</span>
                        <div class="mood-label">éå¸¸ç³Ÿç³•</div>
                        <div class="mood-value">1åˆ†</div>
                    </div>
                    <div class="mood-item" data-mood="bad" data-value="2">
                        <span class="mood-emoji">ğŸ˜¢</span>
                        <div class="mood-label">ä¸å¤ªå¥½</div>
                        <div class="mood-value">2åˆ†</div>
                    </div>
                    <div class="mood-item" data-mood="poor" data-value="3">
                        <span class="mood-emoji">ğŸ˜•</span>
                        <div class="mood-label">æœ‰ç‚¹ä½è½</div>
                        <div class="mood-value">3åˆ†</div>
                    </div>
                    <div class="mood-item" data-mood="neutral" data-value="4">
                        <span class="mood-emoji">ğŸ˜</span>
                        <div class="mood-label">ä¸€èˆ¬èˆ¬</div>
                        <div class="mood-value">4åˆ†</div>
                    </div>
                    <div class="mood-item" data-mood="okay" data-value="5">
                        <span class="mood-emoji">ğŸ™‚</span>
                        <div class="mood-label">è¿˜å¯ä»¥</div>
                        <div class="mood-value">5åˆ†</div>
                    </div>
                    <div class="mood-item" data-mood="good" data-value="6">
                        <span class="mood-emoji">ğŸ˜Š</span>
                        <div class="mood-label">ä¸é”™</div>
                        <div class="mood-value">6åˆ†</div>
                    </div>
                    <div class="mood-item" data-mood="great" data-value="7">
                        <span class="mood-emoji">ğŸ˜„</span>
                        <div class="mood-label">å¾ˆå¥½</div>
                        <div class="mood-value">7åˆ†</div>
                    </div>
                    <div class="mood-item" data-mood="excellent" data-value="8">
                        <span class="mood-emoji">ğŸ¤—</span>
                        <div class="mood-label">å¾ˆæ£’</div>
                        <div class="mood-value">8åˆ†</div>
                    </div>
                    <div class="mood-item" data-mood="amazing" data-value="9">
                        <span class="mood-emoji">ğŸ˜†</span>
                        <div class="mood-label">è¶…æ£’</div>
                        <div class="mood-value">9åˆ†</div>
                    </div>
                    <div class="mood-item" data-mood="euphoric" data-value="10">
                        <span class="mood-emoji">ğŸ¥³</span>
                        <div class="mood-label">è¶…çº§æ£’</div>
                        <div class="mood-value">10åˆ†</div>
                    </div>
                </div>

                <!-- å¿ƒæƒ…åŸå› å¿«æ·é€‰æ‹© -->
                <div style="margin-top: 16px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">æ˜¯ä»€ä¹ˆå½±å“äº†ä½ çš„å¿ƒæƒ…ï¼Ÿ</label>
                    <div class="quick-moods">
                        <button class="quick-mood-btn" onclick="addMoodReason('å·¥ä½œé¡ºåˆ©')">ğŸ’¼ å·¥ä½œé¡ºåˆ©</button>
                        <button class="quick-mood-btn" onclick="addMoodReason('å­¦ä¹ è¿›æ­¥')">ğŸ“š å­¦ä¹ è¿›æ­¥</button>
                        <button class="quick-mood-btn" onclick="addMoodReason('è¿åŠ¨å¥èº«')">ğŸƒ è¿åŠ¨å¥èº«</button>
                        <button class="quick-mood-btn" onclick="addMoodReason('ç¤¾äº¤æ„‰å¿«')">ğŸ‘¥ ç¤¾äº¤æ„‰å¿«</button>
                        <button class="quick-mood-btn" onclick="addMoodReason('ä¼‘æ¯å……è¶³')">ğŸ˜´ ä¼‘æ¯å……è¶³</button>
                        <button class="quick-mood-btn" onclick="addMoodReason('å¤©æ°”ä¸é”™')">â˜€ï¸ å¤©æ°”ä¸é”™</button>
                        <button class="quick-mood-btn" onclick="addMoodReason('å‹åŠ›å¤§')">ğŸ˜° å‹åŠ›å¤§</button>
                        <button class="quick-mood-btn" onclick="addMoodReason('èº«ä½“ä¸é€‚')">ğŸ¤’ èº«ä½“ä¸é€‚</button>
                        <button class="quick-mood-btn" onclick="addMoodReason('å·¥ä½œå›°éš¾')">ğŸ˜¤ å·¥ä½œå›°éš¾</button>
                        <button class="quick-mood-btn" onclick="addMoodReason('äººé™…å†²çª')">ğŸ˜  äººé™…å†²çª</button>
                    </div>
                </div>

                <!-- å¿ƒæƒ…è®°å½•æ–‡æœ¬ -->
                <textarea id="mood-note" class="mood-note" 
                    placeholder="è¯¦ç»†è®°å½•ä¸€ä¸‹ä½ çš„å¿ƒæƒ…å’Œæ„Ÿå—...

ä¾‹å¦‚ï¼š
â€¢ ä»Šå¤©å¿ƒæƒ…å¾ˆå¥½ï¼Œå› ä¸º...
â€¢ æ„Ÿåˆ°æœ‰ç‚¹æ²®ä¸§ï¼Œä¸»è¦åŸå› æ˜¯...
â€¢ å¯¹äº...æ„Ÿåˆ°å¾ˆå…´å¥‹
â€¢ åœ¨...æ–¹é¢æ„Ÿåˆ°ç„¦è™‘"></textarea>

                <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" onclick="addMoodTemplate('å¼€å¿ƒåŸå› ')" style="background: #e8f5e9; color: #2e7d32; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 0.85em;">ğŸ˜Š å¼€å¿ƒåŸå› </button>
                    <button type="button" onclick="addMoodTemplate('å›°æ‰°é—®é¢˜')" style="background: #ffebee; color: #d32f2f; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 0.85em;">ğŸ˜° å›°æ‰°é—®é¢˜</button>
                    <button type="button" onclick="addMoodTemplate('æœŸå¾…äº‹æƒ…')" style="background: #e3f2fd; color: #1976d2; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 0.85em;">ğŸ¯ æœŸå¾…äº‹æƒ…</button>
                    <button type="button" onclick="addMoodTemplate('æ„Ÿæ¿€çš„äº‹')" style="background: #f3e5f5; color: #7b1fa2; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 0.85em;">ğŸ™ æ„Ÿæ¿€çš„äº‹</button>
                </div>
            </div>

            <!-- å¿ƒæƒ…åˆ†æ -->
            <div class="mood-history">
                <h3 style="color: #ff9800; margin-bottom: 16px;">ğŸ“Š å¿ƒæƒ…åˆ†æ</h3>
                
                <div class="mood-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="average-mood">0</div>
                        <div class="stat-label">å¹³å‡å¿ƒæƒ…</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="mood-trend">0</div>
                        <div class="stat-label">å¿ƒæƒ…è¶‹åŠ¿</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="best-mood">0</div>
                        <div class="stat-label">æœ€ä½³å¿ƒæƒ…</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="records-count">0</div>
                        <div class="stat-label">è®°å½•å¤©æ•°</div>
                    </div>
                </div>

                <div class="mood-chart">
                    <canvas id="mood-chart-canvas" width="400" height="200"></canvas>
                </div>

                <!-- æ™ºèƒ½æ´å¯Ÿ -->
                <div class="insights-panel">
                    <h4 style="color: #2e7d32; margin-bottom: 12px;">ğŸ§  æ™ºèƒ½æ´å¯Ÿ</h4>
                    <div id="mood-insights">
                        <div style="margin-bottom: 8px;">ğŸ’¡ æ ¹æ®è®°å½•ï¼Œæ‚¨çš„å¿ƒæƒ…åœ¨å·¥ä½œæ—¥è¡¨ç°æ›´ç¨³å®š</div>
                        <div style="margin-bottom: 8px;">ğŸ“ˆ æœ€è¿‘ä¸€å‘¨å¿ƒæƒ…å‘ˆä¸Šå‡è¶‹åŠ¿</div>
                        <div style="margin-bottom: 8px;">ğŸŒŸ è¿åŠ¨å’Œç¤¾äº¤æ´»åŠ¨å¯¹æ‚¨çš„å¿ƒæƒ…æœ‰ç§¯æå½±å“</div>
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘è®°å½• -->
            <div class="mood-card">
                <h3 style="color: #ff9800; margin-bottom: 16px;">ğŸ“ æœ€è¿‘è®°å½•</h3>
                <div class="mood-timeline" id="mood-timeline">
                    <!-- åŠ¨æ€åŠ è½½æœ€è¿‘çš„å¿ƒæƒ…è®°å½• -->
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let currentMoodData = {
            date: new Date().toISOString().split('T')[0],
            mood: null,
            value: 0,
            note: '',
            timestamp: new Date().toISOString()
        };

        // åˆå§‹åŒ–å¿ƒæƒ…è¿½è¸ªå™¨
        document.addEventListener('DOMContentLoaded', function() {
            initMoodTracker();
        });

        function initMoodTracker() {
            // ç»‘å®šå¿ƒæƒ…é€‰æ‹©å™¨
            const moodItems = document.querySelectorAll('.mood-item');
            moodItems.forEach(item => {
                item.addEventListener('click', function() {
                    selectMood(this);
                });
            });

            // ç»‘å®šæ–‡æœ¬æ¡†
            const moodNote = document.getElementById('mood-note');
            moodNote.addEventListener('input', function() {
                currentMoodData.note = this.value;
                autoSaveMood();
            });

            // åŠ è½½ä»Šæ—¥å·²æœ‰è®°å½•
            loadTodayMood();
            
            // æ›´æ–°ç»Ÿè®¡
            updateMoodStats();
            
            // åŠ è½½æœ€è¿‘è®°å½•
            loadRecentMoods();
            
            // ç»˜åˆ¶å›¾è¡¨
            drawMoodChart();
        }

        function selectMood(element) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.mood-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰é¡¹
            element.classList.add('selected');
            
            // æ›´æ–°æ•°æ®
            currentMoodData.mood = element.dataset.mood;
            currentMoodData.value = parseInt(element.dataset.value);
            currentMoodData.timestamp = new Date().toISOString();
            
            // è‡ªåŠ¨ä¿å­˜
            autoSaveMood();
            
            // æ›´æ–°æ´å¯Ÿ
            updateMoodInsights();
            
            MessageUtils.success(`å¿ƒæƒ…è®°å½•ï¼š${element.querySelector('.mood-label').textContent}`);
        }

        function addMoodReason(reason) {
            const moodNote = document.getElementById('mood-note');
            const currentValue = moodNote.value.trim();
            const newValue = currentValue ? currentValue + '\nâ€¢ ' + reason : 'â€¢ ' + reason;
            moodNote.value = newValue;
            currentMoodData.note = newValue;
            autoSaveMood();
        }

        function addMoodTemplate(type) {
            const templates = {
                'å¼€å¿ƒåŸå› ': 'ğŸ˜Š ä»Šå¤©å¼€å¿ƒçš„åŸå› ï¼š\nâ€¢ \nâ€¢ \nâ€¢ ',
                'å›°æ‰°é—®é¢˜': 'ğŸ˜° è®©æˆ‘å›°æ‰°çš„é—®é¢˜ï¼š\nâ€¢ é—®é¢˜ï¼š\nâ€¢ å½±å“ï¼š\nâ€¢ åº”å¯¹æ–¹å¼ï¼š',
                'æœŸå¾…äº‹æƒ…': 'ğŸ¯ æœŸå¾…çš„äº‹æƒ…ï¼š\nâ€¢ \nâ€¢ \nâ€¢ ',
                'æ„Ÿæ¿€çš„äº‹': 'ğŸ™ æ„Ÿæ¿€çš„äº‹æƒ…ï¼š\nâ€¢ \nâ€¢ \nâ€¢ '
            };
            
            const template = templates[type];
            if (template) {
                const moodNote = document.getElementById('mood-note');
                const currentValue = moodNote.value.trim();
                const newValue = currentValue ? currentValue + '\n\n' + template : template;
                moodNote.value = newValue;
                currentMoodData.note = newValue;
                moodNote.focus();
                autoSaveMood();
            }
        }

        function autoSaveMood() {
            if (currentMoodData.mood || currentMoodData.note) {
                const moodHistory = getMoodHistory();
                const todayIndex = moodHistory.findIndex(record => record.date === currentMoodData.date);
                
                if (todayIndex >= 0) {
                    moodHistory[todayIndex] = { ...currentMoodData };
                } else {
                    moodHistory.unshift({ ...currentMoodData });
                }
                
                // åªä¿ç•™æœ€è¿‘90å¤©çš„è®°å½•
                moodHistory.splice(90);
                
                localStorage.setItem('mood_history', JSON.stringify(moodHistory));
                
                // æ›´æ–°ç»Ÿè®¡
                updateMoodStats();
            }
        }

        function loadTodayMood() {
            const moodHistory = getMoodHistory();
            const todayRecord = moodHistory.find(record => record.date === currentMoodData.date);
            
            if (todayRecord) {
                currentMoodData = { ...todayRecord };
                
                // æ¢å¤å¿ƒæƒ…é€‰æ‹©
                if (todayRecord.mood) {
                    const moodItem = document.querySelector(`[data-mood="${todayRecord.mood}"]`);
                    if (moodItem) {
                        moodItem.classList.add('selected');
                    }
                }
                
                // æ¢å¤æ–‡æœ¬å†…å®¹
                if (todayRecord.note) {
                    document.getElementById('mood-note').value = todayRecord.note;
                }
            }
        }

        function getMoodHistory() {
            try {
                const stored = localStorage.getItem('mood_history');
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('è¯»å–å¿ƒæƒ…å†å²å¤±è´¥:', error);
                return [];
            }
        }

        function updateMoodStats() {
            const moodHistory = getMoodHistory().filter(record => record.value > 0);
            
            if (moodHistory.length === 0) {
                document.getElementById('average-mood').textContent = '0';
                document.getElementById('mood-trend').textContent = '0';
                document.getElementById('best-mood').textContent = '0';
                document.getElementById('records-count').textContent = '0';
                return;
            }
            
            // å¹³å‡å¿ƒæƒ…
            const average = moodHistory.reduce((sum, record) => sum + record.value, 0) / moodHistory.length;
            document.getElementById('average-mood').textContent = average.toFixed(1);
            
            // å¿ƒæƒ…è¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤© vs ä¹‹å‰7å¤©ï¼‰
            const recent7 = moodHistory.slice(0, 7);
            const previous7 = moodHistory.slice(7, 14);
            
            if (recent7.length > 0 && previous7.length > 0) {
                const recentAvg = recent7.reduce((sum, r) => sum + r.value, 0) / recent7.length;
                const previousAvg = previous7.reduce((sum, r) => sum + r.value, 0) / previous7.length;
                const trend = ((recentAvg - previousAvg) / previousAvg * 100).toFixed(1);
                document.getElementById('mood-trend').textContent = trend > 0 ? '+' + trend + '%' : trend + '%';
            } else {
                document.getElementById('mood-trend').textContent = '0%';
            }
            
            // æœ€ä½³å¿ƒæƒ…
            const bestMood = Math.max(...moodHistory.map(record => record.value));
            document.getElementById('best-mood').textContent = bestMood;
            
            // è®°å½•å¤©æ•°
            document.getElementById('records-count').textContent = moodHistory.length;
        }

        function updateMoodInsights() {
            const moodHistory = getMoodHistory().filter(record => record.value > 0);
            const insightsContainer = document.getElementById('mood-insights');
            
            if (moodHistory.length < 3) {
                insightsContainer.innerHTML = '<div>ğŸ’¡ ç»§ç»­è®°å½•å‡ å¤©åï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–çš„å¿ƒæƒ…æ´å¯Ÿ</div>';
                return;
            }
            
            let insights = [];
            
            // åˆ†æå¿ƒæƒ…å¹³å‡å€¼
            const average = moodHistory.reduce((sum, record) => sum + record.value, 0) / moodHistory.length;
            if (average >= 7) {
                insights.push('ğŸŒŸ æ‚¨çš„æ•´ä½“å¿ƒæƒ…çŠ¶æ€å¾ˆå¥½ï¼Œç»§ç»­ä¿æŒï¼');
            } else if (average >= 5) {
                insights.push('ğŸ˜Š æ‚¨çš„å¿ƒæƒ…çŠ¶æ€æ€»ä½“è‰¯å¥½ï¼Œå¶å°”å¯ä»¥å°è¯•ä¸€äº›è®©è‡ªå·±æ›´å¼€å¿ƒçš„æ´»åŠ¨');
            } else {
                insights.push('ğŸ’ª å»ºè®®å…³æ³¨å¿ƒç†å¥åº·ï¼Œå°è¯•æ”¾æ¾æ´»åŠ¨æˆ–å¯»æ±‚æ”¯æŒ');
            }
            
            // åˆ†ææœ€è¿‘è¶‹åŠ¿
            const recent5 = moodHistory.slice(0, 5);
            if (recent5.length >= 3) {
                const trend = recent5[0].value - recent5[recent5.length - 1].value;
                if (trend > 1) {
                    insights.push('ğŸ“ˆ æœ€è¿‘å¿ƒæƒ…å‘ˆä¸Šå‡è¶‹åŠ¿ï¼Œå¾ˆæ£’ï¼');
                } else if (trend < -1) {
                    insights.push('ğŸ“‰ æœ€è¿‘å¿ƒæƒ…æœ‰æ‰€ä¸‹é™ï¼Œæ³¨æ„è°ƒèŠ‚å’Œä¼‘æ¯');
                }
            }
            
            // åˆ†æè®°å½•å†…å®¹
            const allNotes = moodHistory.map(r => r.note).join(' ').toLowerCase();
            if (allNotes.includes('å·¥ä½œ')) {
                insights.push('ğŸ’¼ å·¥ä½œå¯¹æ‚¨çš„å¿ƒæƒ…å½±å“è¾ƒå¤§ï¼Œæ³¨æ„å·¥ä½œç”Ÿæ´»å¹³è¡¡');
            }
            if (allNotes.includes('è¿åŠ¨') || allNotes.includes('é”»ç‚¼')) {
                insights.push('ğŸƒ è¿åŠ¨å¯¹æ‚¨çš„å¿ƒæƒ…æœ‰ç§¯æå½±å“ï¼Œå»ºè®®ç»§ç»­ä¿æŒ');
            }
            if (allNotes.includes('æœ‹å‹') || allNotes.includes('ç¤¾äº¤')) {
                insights.push('ğŸ‘¥ ç¤¾äº¤æ´»åŠ¨å¯¹æ‚¨çš„å¿ƒæƒ…å¾ˆé‡è¦');
            }
            
            // æ˜¾ç¤ºæ´å¯Ÿ
            insightsContainer.innerHTML = insights.map(insight => 
                `<div style="margin-bottom: 8px;">${insight}</div>`
            ).join('');
        }

        function loadRecentMoods() {
            const moodHistory = getMoodHistory().slice(0, 7); // æ˜¾ç¤ºæœ€è¿‘7å¤©
            const timeline = document.getElementById('mood-timeline');
            
            if (moodHistory.length === 0) {
                timeline.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">è¿˜æ²¡æœ‰å¿ƒæƒ…è®°å½•ï¼Œå¼€å§‹è®°å½•æ‚¨çš„å¿ƒæƒ…å§ï¼</div>';
                return;
            }
            
            const moodEmojis = {
                'terrible': 'ğŸ˜­', 'bad': 'ğŸ˜¢', 'poor': 'ğŸ˜•', 'neutral': 'ğŸ˜', 'okay': 'ğŸ™‚',
                'good': 'ğŸ˜Š', 'great': 'ğŸ˜„', 'excellent': 'ğŸ¤—', 'amazing': 'ğŸ˜†', 'euphoric': 'ğŸ¥³'
            };
            
            timeline.innerHTML = moodHistory.map(record => {
                const date = new Date(record.date);
                const emoji = moodEmojis[record.mood] || 'ğŸ˜';
                const note = record.note ? record.note.substring(0, 100) + (record.note.length > 100 ? '...' : '') : 'æ— å¤‡æ³¨';
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-emoji">${emoji}</div>
                        <div class="timeline-content">
                            <div style="font-weight: 600; margin-bottom: 4px;">
                                ${date.toLocaleDateString('zh-CN')} - ${record.value}/10åˆ†
                            </div>
                            <div style="color: #666; font-size: 0.9em;">${note}</div>
                        </div>
                        <div class="timeline-time">
                            ${new Date(record.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function drawMoodChart() {
            const canvas = document.getElementById('mood-chart-canvas');
            const ctx = canvas.getContext('2d');
            const moodHistory = getMoodHistory().slice(0, 30).reverse(); // æœ€è¿‘30å¤©ï¼Œå€’åºæ˜¾ç¤º
            
            if (moodHistory.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // è®¾ç½®å›¾è¡¨å‚æ•°
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const maxValue = 10;
            const minValue = 0;
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            // æ°´å¹³ç½‘æ ¼çº¿
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                // Yè½´æ ‡ç­¾
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(maxValue - (maxValue / 5) * i, padding - 5, y + 4);
            }
            
            // ç»˜åˆ¶å¿ƒæƒ…æ›²çº¿
            if (moodHistory.length > 1) {
                ctx.strokeStyle = '#ff9800';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                moodHistory.forEach((record, index) => {
                    const x = padding + (chartWidth / (moodHistory.length - 1)) * index;
                    const y = padding + chartHeight - ((record.value / maxValue) * chartHeight);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // ç»˜åˆ¶æ•°æ®ç‚¹
                ctx.fillStyle = '#ff9800';
                moodHistory.forEach((record, index) => {
                    const x = padding + (chartWidth / (moodHistory.length - 1)) * index;
                    const y = padding + chartHeight - ((record.value / maxValue) * chartHeight);
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }
        }

        // ä¿å­˜æŒ‰é’®
        document.getElementById('save-mood-btn')?.addEventListener('click', function() {
            if (!currentMoodData.mood) {
                MessageUtils.warning('è¯·å…ˆé€‰æ‹©æ‚¨çš„å¿ƒæƒ…');
                return;
            }
            
            autoSaveMood();
            updateMoodStats();
            loadRecentMoods();
            drawMoodChart();
            updateMoodInsights();
            
            MessageUtils.success('å¿ƒæƒ…è®°å½•ä¿å­˜æˆåŠŸï¼');
        });

        // å¯¼å‡ºæŒ‰é’®
        document.getElementById('export-mood-btn')?.addEventListener('click', function() {
            const moodHistory = getMoodHistory();
            
            if (moodHistory.length === 0) {
                MessageUtils.warning('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            const csvContent = "æ—¥æœŸ,å¿ƒæƒ…è¯„åˆ†,å¿ƒæƒ…æè¿°,å¤‡æ³¨\n" + 
                moodHistory.map(record => {
                    const moodLabels = {
                        'terrible': 'éå¸¸ç³Ÿç³•', 'bad': 'ä¸å¤ªå¥½', 'poor': 'æœ‰ç‚¹ä½è½', 'neutral': 'ä¸€èˆ¬èˆ¬', 'okay': 'è¿˜å¯ä»¥',
                        'good': 'ä¸é”™', 'great': 'å¾ˆå¥½', 'excellent': 'å¾ˆæ£’', 'amazing': 'è¶…æ£’', 'euphoric': 'è¶…çº§æ£’'
                    };
                    const note = record.note ? record.note.replace(/\n/g, ' ').replace(/,/g, 'ï¼Œ') : '';
                    return `${record.date},${record.value},${moodLabels[record.mood] || ''},${note}`;
                }).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mood_tracker_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            MessageUtils.success('å¿ƒæƒ…æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
        });
    </script>
    <!-- åŒæ­¥æœåŠ¡ -->
    <script src="sync-service.js"></script>
    <script src="sync-providers.js"></script>
    <!-- é€šç”¨è‡ªåŠ¨åŒæ­¥åŠŸèƒ½ -->
    <script src="universal-auto-sync.js"></script>
</body>

</html>

