<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ç™»å½• - è®¡åˆ’ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- LeanCloud äº‘åŒæ­¥æ”¯æŒ -->
    <script src="leancloud-config.js"></script>
    <script src="leancloud-sync.js"></script>

    <style>
        /* å±€éƒ¨æ ·å¼ï¼Œé…åˆå…¨å±€ style.css ä½¿ç”¨ */
        body.login-page {
            background: linear-gradient(180deg, #f5f7fa 0%, #e8eef8 100%);
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .auth-container {
            width: 100%;
            max-width: 440px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(18, 38, 63, 0.12);
            padding: 32px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-header h1 {
            margin: 0 0 8px 0;
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .auth-header p {
            margin: 0;
            color: #6b7280;
            font-size: 0.95rem;
        }

        .auth-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 24px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .auth-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .auth-tab:not(.active) {
            color: #6b7280;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            color: #374151;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .input-wrapper {
            position: relative;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="tel"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 0.95rem;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .input-icon {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            cursor: pointer;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.8rem;
            margin-top: 6px;
            display: none;
        }

        .success-message {
            color: #10b981;
            font-size: 0.8rem;
            margin-top: 6px;
            display: none;
        }

        .code-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .code-row input {
            flex: 1;
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f8fafc;
            color: #667eea;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
            border-color: #667eea;
        }

        .btn-link {
            background: none;
            border: none;
            color: #667eea;
            padding: 0;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .row-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .muted {
            color: #7b8794;
            font-size: 0.85rem;
        }

        .hint {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #556;
        }

        .alert {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .alert.success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert.info {
            background: #f0f9ff;
            color: #1e40af;
            border: 1px solid #bae6fd;
        }

        .password-strength {
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .strength-meter {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
        }

        .strength-weak .strength-fill {
            width: 33%;
            background: #ef4444;
        }

        .strength-medium .strength-fill {
            width: 66%;
            background: #f59e0b;
        }

        .strength-strong .strength-fill {
            width: 100%;
            background: #10b981;
        }

        /* éªŒè¯ç æ˜¾ç¤ºä¸è¾“å…¥æ ·å¼ */
        .code-display {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .code-box {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            background: #f3f6ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #2b4db7;
            font-size: 1.1rem;
            border: 1px solid rgba(43, 77, 183, 0.08);
        }

        .code-inputs {
            display: flex;
            gap: 8px;
        }

        .code-inputs input {
            width: 42px;
            height: 42px;
            text-align: center;
            font-size: 1.05rem;
            border-radius: 8px;
            border: 1px solid #e1e8f0;
            outline: none;
        }
    </style>
</head>

<body class="login-page">
    <div class="auth-container" role="main" aria-labelledby="auth-title">
        <div class="auth-header">
            <h1 id="auth-title">è®¡åˆ’ç®¡ç†å™¨</h1>
            <p>æ™ºèƒ½åŒ–å¤šå±‚çº§è®¡åˆ’ç®¡ç†ç³»ç»Ÿ</p>
        </div>

        <!-- æ ‡ç­¾åˆ‡æ¢ -->
        <div class="auth-tabs">
            <div class="auth-tab active" data-tab="login">
                <i class="fas fa-sign-in-alt"></i> ç™»å½•
            </div>
            <div class="auth-tab" data-tab="register">
                <i class="fas fa-user-plus"></i> æ³¨å†Œ
            </div>
            <div class="auth-tab" data-tab="forgot">
                <i class="fas fa-key"></i> æ‰¾å›å¯†ç 
            </div>
        </div>

        <!-- ç™»å½•è¡¨å• -->
        <div class="form-section active" id="login-section">
            <div class="form-group">
                <label for="login-email">é‚®ç®±åœ°å€</label>
                <div class="input-wrapper">
                    <input id="login-email" type="email" autocomplete="email" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" required />
                    <i class="fas fa-envelope input-icon"></i>
                </div>
                <div class="error-message" id="login-email-error"></div>
            </div>

            <div class="form-group">
                <label for="login-password">å¯†ç </label>
                <div class="input-wrapper">
                    <input id="login-password" type="password" autocomplete="current-password" placeholder="è¯·è¾“å…¥å¯†ç "
                        required />
                    <i class="fas fa-eye-slash input-icon" id="login-toggle-password"></i>
                </div>
                <div class="error-message" id="login-password-error"></div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="remember-me"> è®°ä½æˆ‘
                </label>
            </div>

            <button id="login-btn" class="btn" type="button">
                <span class="btn-text">ç™»å½•</span>
                <span class="loading" style="display:none;"></span>
            </button>

            <div id="login-alert" class="alert"></div>
        </div>

        <!-- æ³¨å†Œè¡¨å• -->
        <div class="form-section" id="register-section">
            <div class="form-group">
                <label for="register-email">é‚®ç®±åœ°å€</label>
                <div class="input-wrapper">
                    <input id="register-email" type="email" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" required />
                    <i class="fas fa-envelope input-icon"></i>
                </div>
                <div class="error-message" id="register-email-error"></div>
                <div class="success-message" id="register-email-success"></div>
            </div>

            <div class="form-group">
                <label for="register-username">ç”¨æˆ·å</label>
                <div class="input-wrapper">
                    <input id="register-username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-20ä¸ªå­—ç¬¦ï¼‰" required />
                    <i class="fas fa-user input-icon"></i>
                </div>
                <div class="error-message" id="register-username-error"></div>
                <div class="success-message" id="register-username-success"></div>
            </div>

            <div class="form-group">
                <label for="register-password">å¯†ç </label>
                <div class="input-wrapper">
                    <input id="register-password" type="password" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰" required />
                    <i class="fas fa-eye-slash input-icon" id="register-toggle-password"></i>
                </div>
                <div class="password-strength" id="password-strength">
                    <div class="strength-meter">
                        <div class="strength-fill"></div>
                    </div>
                    <span class="strength-text"></span>
                </div>
                <div class="error-message" id="register-password-error"></div>
            </div>

            <div class="form-group">
                <label for="register-confirm-password">ç¡®è®¤å¯†ç </label>
                <div class="input-wrapper">
                    <input id="register-confirm-password" type="password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required />
                    <i class="fas fa-eye-slash input-icon" id="register-toggle-confirm"></i>
                </div>
                <div class="error-message" id="register-confirm-error"></div>
                <div class="success-message" id="register-confirm-success"></div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="agree-terms" required>
                    æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="#" class="btn-link">ç”¨æˆ·åè®®</a> å’Œ <a href="#" class="btn-link">éšç§æ”¿ç­–</a>
                </label>
                <div class="error-message" id="terms-error"></div>
            </div>

            <button id="register-btn" class="btn" type="button" disabled>
                <span class="btn-text">æ³¨å†Œè´¦å·</span>
                <span class="loading" style="display:none;"></span>
            </button>

            <div id="register-alert" class="alert"></div>
        </div>

        <!-- æ‰¾å›å¯†ç è¡¨å• -->
        <div class="form-section" id="forgot-section">
            <div class="form-group">
                <label for="forgot-email">é‚®ç®±åœ°å€</label>
                <div class="input-wrapper">
                    <input id="forgot-email" type="email" placeholder="è¯·è¾“å…¥æ³¨å†Œæ—¶çš„é‚®ç®±åœ°å€" required />
                    <i class="fas fa-envelope input-icon"></i>
                </div>
                <div class="error-message" id="forgot-email-error"></div>
            </div>

            <div class="form-group" id="verification-section" style="display:none;">
                <label for="verification-code">éªŒè¯ç </label>
                <div class="input-wrapper">
                    <input id="verification-code" type="text" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " maxlength="6" />
                    <button type="button" class="btn-link" id="resend-code">é‡æ–°å‘é€</button>
                </div>
                <div class="error-message" id="verification-error"></div>
                <div class="success-message" id="verification-success"></div>
            </div>

            <div class="form-group" id="new-password-section" style="display:none;">
                <label for="new-password">æ–°å¯†ç </label>
                <div class="input-wrapper">
                    <input id="new-password" type="password" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰" />
                    <i class="fas fa-eye-slash input-icon" id="new-toggle-password"></i>
                </div>
                <div class="password-strength" id="new-password-strength">
                    <div class="strength-meter">
                        <div class="strength-fill"></div>
                    </div>
                    <span class="strength-text"></span>
                </div>
                <div class="error-message" id="new-password-error"></div>
            </div>

            <div class="form-group" id="confirm-new-password-section" style="display:none;">
                <label for="confirm-new-password">ç¡®è®¤æ–°å¯†ç </label>
                <div class="input-wrapper">
                    <input id="confirm-new-password" type="password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " />
                    <i class="fas fa-eye-slash input-icon" id="confirm-new-toggle-password"></i>
                </div>
                <div class="error-message" id="confirm-new-password-error"></div>
            </div>

            <button id="forgot-btn" class="btn" type="button">
                <span class="btn-text">å‘é€éªŒè¯ç </span>
                <span class="loading" style="display:none;"></span>
            </button>

            <div id="forgot-alert" class="alert"></div>
        </div>
    </div>

    <!-- æ‰‹æœºç«¯è°ƒè¯•é¢æ¿ -->
    <div id="debug-panel"
        style="display:none; position:fixed; bottom:10px; left:10px; right:10px; background:#f8f9fa; border:1px solid #ddd; border-radius:8px; padding:10px; font-size:12px; max-height:300px; overflow-y:auto; z-index:9999;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <strong>ğŸ” è°ƒè¯•ä¿¡æ¯</strong>
            <div>
                <button id="test-cloud-btn"
                    style="background:#5352ed; color:white; border:none; border-radius:4px; padding:2px 6px; font-size:10px; margin-right:2px;">æµ‹è¯•äº‘ç«¯</button>
                <button id="sync-users-btn"
                    style="background:#ff6b35; color:white; border:none; border-radius:4px; padding:2px 6px; font-size:10px; margin-right:2px;">åŒæ­¥ç”¨æˆ·</button>
                <button id="clear-data-btn"
                    style="background:#ff4757; color:white; border:none; border-radius:4px; padding:2px 6px; font-size:10px; margin-right:2px;">æ¸…é™¤æ•°æ®</button>
                <button id="emergency-recovery-btn"
                    style="background:#f39c12; color:white; border:none; border-radius:4px; padding:2px 6px; font-size:10px; margin-right:2px;">ğŸ†˜ç´§æ€¥æ¢å¤</button>
                <button onclick="document.getElementById('debug-panel').style.display='none'"
                    style="background:#333; color:white; border:none; border-radius:4px; padding:2px 8px; font-size:10px;">å…³é—­</button>
            </div>
        </div>
        <div id="debug-content"></div>
    </div>

    <script>
        // å®Œå–„çš„ç™»å½•æ³¨å†Œç³»ç»Ÿ
        (function () {
            // è°ƒè¯•å·¥å…·
            const debugUtils = {
                logs: [],
                addLog: function (message, type = 'info') {
                    const timestamp = new Date().toLocaleTimeString();
                    this.logs.push({ timestamp, message, type });
                    console.log(`${timestamp} [${type.toUpperCase()}] ${message}`);
                    this.updateDebugPanel();
                },

                updateDebugPanel: function () {
                    const debugContent = document.getElementById('debug-content');
                    if (debugContent) {
                        debugContent.innerHTML = this.logs.slice(-10).map(log =>
                            `<div style="margin:2px 0; color:${log.type === 'error' ? '#ff4757' : log.type === 'success' ? '#2ed573' : '#57606f'}">
                                ${log.timestamp} ${log.message}
                            </div>`
                        ).join('');
                    }
                },

                showDebugPanel: function () {
                    document.getElementById('debug-panel').style.display = 'block';
                },

                isMobile: function () {
                    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                }
            };

            // è°ƒè¯•é¢æ¿æ˜¾ç¤ºæ§åˆ¶ï¼ˆä¸å†è‡ªåŠ¨æ˜¾ç¤ºï¼‰
            // åªåœ¨URLåŒ…å«debug=trueæˆ–åŒå‡»æ ‡é¢˜æ—¶æ˜¾ç¤º
            const urlParams = new URLSearchParams(window.location.search);
            const showDebug = urlParams.get('debug') === 'true';

            if (showDebug) {
                setTimeout(() => debugUtils.showDebugPanel(), 1000);
                debugUtils.addLog(debugUtils.isMobile() ? 'ğŸ“± ç§»åŠ¨ç«¯è°ƒè¯•æ¨¡å¼' : 'ğŸ’» æ¡Œé¢ç«¯è°ƒè¯•æ¨¡å¼');
            }

            // åŒå‡»é¡µé¢æ ‡é¢˜æ˜¾ç¤º/éšè—è°ƒè¯•é¢æ¿
            document.querySelector('h1')?.addEventListener('dblclick', function () {
                const panel = document.getElementById('debug-panel');
                if (panel.style.display === 'none') {
                    debugUtils.showDebugPanel();
                    debugUtils.addLog('ğŸ”§ è°ƒè¯•é¢æ¿å·²æ‰‹åŠ¨å¯ç”¨');
                } else {
                    panel.style.display = 'none';
                }
            });

            // å…ƒç´ é€‰æ‹©å™¨
            const elements = {
                // æ ‡ç­¾
                tabs: document.querySelectorAll('.auth-tab'),
                sections: document.querySelectorAll('.form-section'),

                // ç™»å½•è¡¨å•
                loginEmail: document.getElementById('login-email'),
                loginPassword: document.getElementById('login-password'),
                loginBtn: document.getElementById('login-btn'),
                loginAlert: document.getElementById('login-alert'),
                loginTogglePassword: document.getElementById('login-toggle-password'),
                rememberMe: document.getElementById('remember-me'),

                // æ³¨å†Œè¡¨å•
                registerEmail: document.getElementById('register-email'),
                registerUsername: document.getElementById('register-username'),
                registerPassword: document.getElementById('register-password'),
                registerConfirmPassword: document.getElementById('register-confirm-password'),
                registerBtn: document.getElementById('register-btn'),
                registerAlert: document.getElementById('register-alert'),
                agreeTerms: document.getElementById('agree-terms'),

                // æ‰¾å›å¯†ç è¡¨å•
                forgotEmail: document.getElementById('forgot-email'),
                forgotBtn: document.getElementById('forgot-btn'),
                forgotAlert: document.getElementById('forgot-alert'),
                verificationCode: document.getElementById('verification-code'),
                newPassword: document.getElementById('new-password'),
                confirmNewPassword: document.getElementById('confirm-new-password'),

                // å…¶ä»–å…ƒç´ 
                verificationSection: document.getElementById('verification-section'),
                newPasswordSection: document.getElementById('new-password-section'),
                confirmNewPasswordSection: document.getElementById('confirm-new-password-section'),
                resendCode: document.getElementById('resend-code')
            };

            // äº‘åŒæ­¥å·¥å…·å‡½æ•°  
            const cloudUtils = {
                // ä¿å­˜ç”¨æˆ·åˆ°äº‘ç«¯ï¼ˆä¿®å¤ç‰ˆï¼‰
                async saveUserToCloud(email, userData) {
                    console.log('ğŸ’¾ å¼€å§‹ä¿å­˜ç”¨æˆ·åˆ°äº‘ç«¯:', email);
                    try {
                        if (!window.leanCloudSync) {
                            console.warn('âš ï¸ LeanCloudæœªåˆå§‹åŒ–');
                            return null;
                        }

                        console.log('ğŸ“Š LeanCloudçŠ¶æ€æ£€æŸ¥:', {
                            exists: !!window.leanCloudSync,
                            isInitialized: window.leanCloudSync.isInitialized,
                            isEnabled: window.leanCloudSync.isEnabled,
                            initError: window.leanCloudSync.initError
                        });

                        if (window.leanCloudSync.isEnabled) {
                            // LeanCloudåŒæ­¥ç³»ç»Ÿé€šè¿‡ç›‘å¬localStorageå˜åŒ–è‡ªåŠ¨åŒæ­¥
                            // æˆ‘ä»¬éœ€è¦ä½¿ç”¨å®ƒç›‘å¬çš„é”®åæ ¼å¼
                            const cloudKey = `planData_user_${email}`;
                            console.log('ğŸ”‘ ä½¿ç”¨äº‘ç«¯é”®å:', cloudKey);

                            // ç›´æ¥ä¿å­˜åˆ°localStorageï¼ŒLeanCloudä¼šè‡ªåŠ¨ç›‘å¬å¹¶åŒæ­¥
                            localStorage.setItem(cloudKey, JSON.stringify(userData));

                            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©LeanCloudå¤„ç†åŒæ­¥
                            await new Promise(resolve => setTimeout(resolve, 1000));

                            console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜å¹¶è§¦å‘äº‘ç«¯åŒæ­¥:', email);
                            return true;
                        } else {
                            console.warn('âš ï¸ LeanCloudæœªå¯ç”¨æˆ–åˆå§‹åŒ–å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('âŒ äº‘ç«¯ä¿å­˜å¤±è´¥:', error);
                    }
                    return null;
                },

                // ä»äº‘ç«¯åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ˆä¿®å¤ç‰ˆï¼‰
                async loadUserFromCloud(email) {
                    console.log('ğŸ“¥ å¼€å§‹ä»äº‘ç«¯åŠ è½½ç”¨æˆ·:', email);
                    try {
                        if (!window.leanCloudSync) {
                            console.warn('âš ï¸ LeanCloudæœªåˆå§‹åŒ–');
                            return null;
                        }

                        if (window.leanCloudSync.isEnabled) {
                            const cloudKey = `planData_user_${email}`;
                            console.log('ğŸ”‘ ä½¿ç”¨äº‘ç«¯é”®å:', cloudKey);

                            // å…ˆå°è¯•ä»æœ¬åœ°localStorageè¯»å–ï¼ˆå¯èƒ½å·²è¢«LeanCloudåŒæ­¥ï¼‰
                            let result = null;
                            const localData = localStorage.getItem(cloudKey);

                            if (localData) {
                                try {
                                    result = JSON.parse(localData);
                                    console.log('ğŸ“± ä»æœ¬åœ°ç¼“å­˜è·å–ç”¨æˆ·æ•°æ®');
                                } catch (e) {
                                    console.warn('âš ï¸ æœ¬åœ°æ•°æ®è§£æå¤±è´¥:', e);
                                }
                            }

                            // å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œå°è¯•å¼ºåˆ¶ä»äº‘ç«¯æ¢å¤
                            if (!result && window.leanCloudSync.forceRestore) {
                                console.log('ğŸ”„ å¼ºåˆ¶ä»äº‘ç«¯æ¢å¤æ•°æ®...');
                                await window.leanCloudSync.forceRestore();

                                // æ¢å¤åå†æ¬¡å°è¯•è¯»å–
                                const updatedLocalData = localStorage.getItem(cloudKey);
                                if (updatedLocalData) {
                                    try {
                                        result = JSON.parse(updatedLocalData);
                                        console.log('â˜ï¸ ä»äº‘ç«¯æ¢å¤ç”¨æˆ·æ•°æ®æˆåŠŸ');
                                    } catch (e) {
                                        console.warn('âš ï¸ äº‘ç«¯æ•°æ®è§£æå¤±è´¥:', e);
                                    }
                                }
                            }

                            // 3. [æ–°å¢] å¦‚æœæ ‡å‡†æ¢å¤ä»æœªæ‰¾åˆ°ï¼Œå°è¯•ç›´æ¥æŸ¥è¯¢äº‘ç«¯ (Fallback)
                            if (!result) {
                                debugUtils?.addLog('âš ï¸ æ ‡å‡†æ¢å¤æœªæ‰¾åˆ°ï¼Œå°è¯•ç›´æ¥æŸ¥è¯¢äº‘ç«¯...', 'info');
                                console.log('âš ï¸ æ ‡å‡†æ¢å¤æœªæ‰¾åˆ°ï¼Œå°è¯•ç›´æ¥æŸ¥è¯¢äº‘ç«¯...');
                                try {
                                    // ç¡®ä¿ AV å¯¹è±¡å­˜åœ¨
                                    if (typeof AV !== 'undefined' && window.leanCloudSync.sharedUserId) {
                                        const query = new AV.Query('PlanData');
                                        query.equalTo('userId', window.leanCloudSync.sharedUserId);
                                        const planObject = await query.first();

                                        if (planObject) {
                                            const cloudData = planObject.get('data');
                                            if (cloudData && cloudData[cloudKey]) {
                                                const userDataStr = cloudData[cloudKey];
                                                try {
                                                    result = JSON.parse(userDataStr);
                                                    console.log('âœ… ç›´æ¥æŸ¥è¯¢æ‰¾åˆ°ç”¨æˆ·:', email);
                                                    debugUtils?.addLog('âœ… ç›´æ¥æŸ¥è¯¢æ‰¾åˆ°ç”¨æˆ·æ•°æ®', 'success');

                                                    // ç«‹å³ä¿å­˜åˆ°æœ¬åœ°
                                                    localStorage.setItem(cloudKey, userDataStr);
                                                } catch (e) {
                                                    console.warn('âš ï¸ ç”¨æˆ·æ•°æ®è§£æå¤±è´¥:', e);
                                                }
                                            } else {
                                                console.log('â„¹ï¸ äº‘ç«¯æ•°æ®å¯¹è±¡ä¸­æœªæ‰¾åˆ°è¯¥ç”¨æˆ·Key');
                                            }
                                        } else {
                                            console.log('â„¹ï¸ äº‘ç«¯æœªæ‰¾åˆ°PlanDataå¯¹è±¡');
                                        }
                                    }
                                } catch (e) {
                                    console.warn('âš ï¸ ç›´æ¥æŸ¥è¯¢è¿‡ç¨‹å‡ºé”™:', e);
                                    debugUtils?.addLog(`âš ï¸ ç›´æ¥æŸ¥è¯¢å‡ºé”™: ${e.message}`, 'error');
                                }
                            }

                            console.log('â˜ï¸ äº‘ç«¯æŸ¥è¯¢åŸå§‹ç»“æœ:', result);

                            if (result) {
                                console.log('âœ… ä»äº‘ç«¯åŠ è½½ç”¨æˆ·ä¿¡æ¯æˆåŠŸ:', email);
                                console.log('ğŸ“„ ç”¨æˆ·æ•°æ®:', {
                                    username: result.username,
                                    registeredAt: result.registeredAt,
                                    hasPassword: !!result.password
                                });
                                return result;
                            } else {
                                console.log('â„¹ï¸ äº‘ç«¯æœªæ‰¾åˆ°ç”¨æˆ·æ•°æ®:', email);
                            }
                        } else {
                            console.warn('âš ï¸ LeanCloudæœªå¯ç”¨ï¼Œæ— æ³•æŸ¥è¯¢äº‘ç«¯æ•°æ®');
                        }
                    } catch (error) {
                        console.error('âŒ äº‘ç«¯åŠ è½½å¤±è´¥:', error);
                    }
                    return null;
                },

                // åŒæ­¥æ‰€æœ‰æœ¬åœ°ç”¨æˆ·åˆ°äº‘ç«¯
                async syncAllUsersToCloud() {
                    try {
                        const localUsers = JSON.parse(localStorage.getItem('registered_users') || '{}');
                        const syncPromises = Object.entries(localUsers).map(([email, userData]) => {
                            return this.saveUserToCloud(email, userData);
                        });
                        await Promise.all(syncPromises);
                        console.log('âœ… æ‰€æœ‰æœ¬åœ°ç”¨æˆ·å·²åŒæ­¥åˆ°äº‘ç«¯');
                    } catch (error) {
                        console.warn('âš ï¸ ç”¨æˆ·åŒæ­¥å¤±è´¥:', error);
                    }
                }
            };

            // å·¥å…·å‡½æ•°
            const utils = {
                showAlert: function (alertEl, message, type = 'info') {
                    alertEl.className = `alert ${type}`;
                    alertEl.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}`;
                    alertEl.style.display = 'flex';
                    setTimeout(() => { alertEl.style.display = 'none'; }, 5000);
                },

                showFieldError: function (field, message) {
                    field.classList.add('error');
                    const errorEl = field.parentNode.parentNode.querySelector('.error-message');
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.style.display = 'block';
                    }
                },

                clearFieldError: function (field) {
                    field.classList.remove('error');
                    const errorEl = field.parentNode.parentNode.querySelector('.error-message');
                    if (errorEl) errorEl.style.display = 'none';
                },

                showFieldSuccess: function (field, message) {
                    field.classList.remove('error');
                    const successEl = field.parentNode.parentNode.querySelector('.success-message');
                    if (successEl) {
                        successEl.textContent = message;
                        successEl.style.display = 'block';
                    }
                },

                validateEmail: function (email) {
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                },

                validatePassword: function (password) {
                    return password.length >= 8;
                },

                validateUsername: function (username) {
                    return username.length >= 3 && username.length <= 20 && /^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(username);
                },

                checkPasswordStrength: function (password) {
                    let score = 0;
                    let feedback = [];

                    if (password.length >= 8) score += 1;
                    else feedback.push('è‡³å°‘8ä¸ªå­—ç¬¦');

                    if (/[a-z]/.test(password)) score += 1;
                    else feedback.push('åŒ…å«å°å†™å­—æ¯');

                    if (/[A-Z]/.test(password)) score += 1;
                    else feedback.push('åŒ…å«å¤§å†™å­—æ¯');

                    if (/[0-9]/.test(password)) score += 1;
                    else feedback.push('åŒ…å«æ•°å­—');

                    if (/[^a-zA-Z0-9]/.test(password)) score += 1;
                    else feedback.push('åŒ…å«ç‰¹æ®Šå­—ç¬¦');

                    let strength = 'weak';
                    let text = 'å¼±';
                    if (score >= 4) { strength = 'strong'; text = 'å¼º'; }
                    else if (score >= 3) { strength = 'medium'; text = 'ä¸­'; }

                    return { strength, text, feedback: feedback.slice(0, 2) };
                },

                setLoading: function (btn, loading) {
                    const textEl = btn.querySelector('.btn-text');
                    const loadingEl = btn.querySelector('.loading');

                    if (loading) {
                        btn.disabled = true;
                        textEl.style.display = 'none';
                        loadingEl.style.display = 'inline-block';
                    } else {
                        btn.disabled = false;
                        textEl.style.display = 'inline';
                        loadingEl.style.display = 'none';
                    }
                },

                redirectAfterAuth: function (email) {
                    const token = btoa(email + ':' + Date.now());
                    try {
                        localStorage.setItem('auth_token', token);
                        localStorage.setItem('auth_user', email);
                    } catch (e) {
                        console.warn('localStorage å†™å…¥å¤±è´¥', e);
                    }

                    try {
                        const params = new URLSearchParams(window.location.search);
                        const redirect = params.get('redirect');
                        const target = redirect ? window.location.origin + redirect : window.location.origin + '/plan-web/index.html';
                        window.location.replace(target);
                    } catch (e) {
                        window.location.replace('index.html');
                    }
                }
            };

            // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;

                    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
                    elements.tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // æ›´æ–°è¡¨å•æ˜¾ç¤º
                    elements.sections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === `${targetTab}-section`) {
                            section.classList.add('active');
                        }
                    });
                });
            });

            // å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢
            function togglePasswordVisibility(passwordField, iconEl) {
                const isPassword = passwordField.type === 'password';
                passwordField.type = isPassword ? 'text' : 'password';
                iconEl.className = isPassword ? 'fas fa-eye input-icon' : 'fas fa-eye-slash input-icon';
            }

            elements.loginTogglePassword?.addEventListener('click', () => {
                togglePasswordVisibility(elements.loginPassword, elements.loginTogglePassword);
            });

            document.getElementById('register-toggle-password')?.addEventListener('click', function () {
                togglePasswordVisibility(elements.registerPassword, this);
            });

            document.getElementById('register-toggle-confirm')?.addEventListener('click', function () {
                togglePasswordVisibility(elements.registerConfirmPassword, this);
            });

            // å¯†ç å¼ºåº¦æ£€æµ‹
            function updatePasswordStrength(password, strengthEl) {
                const result = utils.checkPasswordStrength(password);
                strengthEl.className = `password-strength strength-${result.strength}`;
                strengthEl.querySelector('.strength-text').textContent =
                    `å¯†ç å¼ºåº¦: ${result.text}${result.feedback.length ? ' - å»ºè®®: ' + result.feedback.join(', ') : ''}`;
            }

            elements.registerPassword?.addEventListener('input', function () {
                updatePasswordStrength(this.value, document.getElementById('password-strength'));
                validateRegisterForm();
            });

            // å®æ—¶éªŒè¯
            function validateRegisterForm() {
                let isValid = true;

                // éªŒè¯é‚®ç®±
                if (elements.registerEmail.value && !utils.validateEmail(elements.registerEmail.value)) {
                    utils.showFieldError(elements.registerEmail, 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                    isValid = false;
                } else if (elements.registerEmail.value) {
                    utils.clearFieldError(elements.registerEmail);
                    utils.showFieldSuccess(elements.registerEmail, 'é‚®ç®±æ ¼å¼æ­£ç¡®');
                }

                // éªŒè¯ç”¨æˆ·å
                if (elements.registerUsername.value && !utils.validateUsername(elements.registerUsername.value)) {
                    utils.showFieldError(elements.registerUsername, 'ç”¨æˆ·åé•¿åº¦3-20å­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡');
                    isValid = false;
                } else if (elements.registerUsername.value) {
                    utils.clearFieldError(elements.registerUsername);
                    utils.showFieldSuccess(elements.registerUsername, 'ç”¨æˆ·åæ ¼å¼æ­£ç¡®');
                }

                // éªŒè¯å¯†ç ç¡®è®¤
                if (elements.registerConfirmPassword.value && elements.registerPassword.value !== elements.registerConfirmPassword.value) {
                    utils.showFieldError(elements.registerConfirmPassword, 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                    isValid = false;
                } else if (elements.registerConfirmPassword.value && elements.registerPassword.value === elements.registerConfirmPassword.value) {
                    utils.clearFieldError(elements.registerConfirmPassword);
                    utils.showFieldSuccess(elements.registerConfirmPassword, 'å¯†ç ç¡®è®¤æ­£ç¡®');
                }

                // æ›´æ–°æ³¨å†ŒæŒ‰é’®çŠ¶æ€
                const allFieldsFilled = elements.registerEmail.value && elements.registerUsername.value &&
                    elements.registerPassword.value && elements.registerConfirmPassword.value &&
                    elements.agreeTerms.checked;
                elements.registerBtn.disabled = !(isValid && allFieldsFilled);
            }

            // æ·»åŠ å®æ—¶éªŒè¯äº‹ä»¶ç›‘å¬å™¨
            [elements.registerEmail, elements.registerUsername, elements.registerConfirmPassword].forEach(el => {
                el?.addEventListener('input', validateRegisterForm);
                el?.addEventListener('blur', validateRegisterForm);
            });

            elements.agreeTerms?.addEventListener('change', validateRegisterForm);

            // ç™»å½•åŠŸèƒ½
            elements.loginBtn?.addEventListener('click', async function () {
                const email = elements.loginEmail.value.trim();
                const password = elements.loginPassword.value;

                debugUtils.addLog(`ğŸ” å¼€å§‹ç™»å½•æµç¨‹: ${email}`);

                if (!email || !password) {
                    debugUtils.addLog('âŒ é‚®ç®±æˆ–å¯†ç ä¸ºç©º', 'error');
                    utils.showAlert(elements.loginAlert, 'è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
                    return;
                }

                if (!utils.validateEmail(email)) {
                    debugUtils.addLog('âŒ é‚®ç®±æ ¼å¼æ— æ•ˆ', 'error');
                    utils.showAlert(elements.loginAlert, 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
                    return;
                }

                const loginBtn = this; // ä¿å­˜thiså¼•ç”¨
                utils.setLoading(loginBtn, true);

                try {
                    // éªŒè¯ç™»å½•ï¼ˆæœ¬åœ°+äº‘ç«¯ï¼‰
                    let userFound = false;
                    let userData = null;

                    debugUtils.addLog('ğŸ” æ£€æŸ¥æœ¬åœ°å­˜å‚¨...');
                    // 1. å…ˆæ£€æŸ¥æœ¬åœ°å­˜å‚¨
                    const savedUsers = JSON.parse(localStorage.getItem('registered_users') || '{}');
                    debugUtils.addLog(`ğŸ“± æœ¬åœ°å·²ä¿å­˜ç”¨æˆ·æ•°é‡: ${Object.keys(savedUsers).length}`);

                    if (savedUsers[email]) {
                        debugUtils.addLog('ğŸ‘¤ æ‰¾åˆ°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯');
                        if (savedUsers[email].password === password) {
                            userFound = true;
                            userData = savedUsers[email];
                            debugUtils.addLog('âœ… æœ¬åœ°ç™»å½•æˆåŠŸ', 'success');
                        } else {
                            debugUtils.addLog('âŒ æœ¬åœ°å¯†ç ä¸åŒ¹é…', 'error');
                        }
                    } else {
                        debugUtils.addLog(`â„¹ï¸ æœ¬åœ°æœªæ‰¾åˆ°ç”¨æˆ·: ${email}`);
                    }

                    // 2. å¦‚æœæœ¬åœ°æ²¡æ‰¾åˆ°ï¼Œå°è¯•ä»äº‘ç«¯åŠ è½½
                    if (!userFound) {
                        debugUtils.addLog('â˜ï¸ å°è¯•ä»äº‘ç«¯åŠ è½½ç”¨æˆ·ä¿¡æ¯...');

                        // æ£€æŸ¥LeanCloudçŠ¶æ€
                        if (window.leanCloudSync) {
                            debugUtils.addLog(`ğŸ“¡ LeanCloudçŠ¶æ€: åˆå§‹åŒ–=${window.leanCloudSync.isInitialized}, å¯ç”¨=${window.leanCloudSync.isEnabled}`);
                            if (window.leanCloudSync.initError) {
                                debugUtils.addLog(`âŒ LeanCloudåˆå§‹åŒ–é”™è¯¯: ${window.leanCloudSync.initError}`, 'error');
                            }
                        } else {
                            debugUtils.addLog('âš ï¸ LeanCloudæœªåŠ è½½', 'error');
                        }

                        try {
                            const cloudUserData = await cloudUtils.loadUserFromCloud(email);
                            debugUtils.addLog(`â˜ï¸ äº‘ç«¯æŸ¥è¯¢ç»“æœ: ${cloudUserData ? 'æ‰¾åˆ°ç”¨æˆ·' : 'æœªæ‰¾åˆ°ç”¨æˆ·'}`);

                            if (cloudUserData) {
                                if (cloudUserData.password === password) {
                                    userFound = true;
                                    userData = cloudUserData;

                                    // å°†äº‘ç«¯ç”¨æˆ·ä¿¡æ¯åŒæ­¥åˆ°æœ¬åœ°
                                    savedUsers[email] = cloudUserData;
                                    localStorage.setItem('registered_users', JSON.stringify(savedUsers));
                                    debugUtils.addLog('âœ… äº‘ç«¯ç™»å½•æˆåŠŸï¼Œå·²åŒæ­¥åˆ°æœ¬åœ°', 'success');
                                } else {
                                    debugUtils.addLog('âŒ äº‘ç«¯å¯†ç ä¸åŒ¹é…', 'error');
                                }
                            }
                        } catch (error) {
                            debugUtils.addLog(`âŒ äº‘ç«¯ç™»å½•å¤±è´¥: ${error.message}`, 'error');
                        }
                    }

                    // 3. æ˜¾ç¤ºç»“æœ
                    utils.setLoading(loginBtn, false);

                    if (userFound) {
                        debugUtils.addLog('ğŸ‰ ç™»å½•æˆåŠŸï¼', 'success');
                        utils.showAlert(elements.loginAlert, 'ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
                        setTimeout(() => utils.redirectAfterAuth(email), 1000);
                    } else {
                        debugUtils.addLog('âŒ ç™»å½•å¤±è´¥ - ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
                        debugUtils.addLog('ğŸ’¡ è§£å†³æ–¹æ¡ˆ: 1)æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡® 2)ç‚¹å‡»"ğŸ†˜ç´§æ€¥æ¢å¤"æŒ‰é’® 3)ç‚¹å‡»"åŒæ­¥ç”¨æˆ·"æŒ‰é’®', 'info');
                        utils.showAlert(elements.loginAlert, 'ç™»å½•å¤±è´¥ï¼å¦‚æœåˆ é™¤äº†æµè§ˆå™¨æ•°æ®ï¼Œè¯·åŒå‡»é¡µé¢æ ‡é¢˜æ‰“å¼€è°ƒè¯•é¢æ¿ï¼Œç„¶åç‚¹å‡»"ğŸ†˜ç´§æ€¥æ¢å¤"æŒ‰é’®', 'error');

                        // è‡ªåŠ¨æ˜¾ç¤ºè°ƒè¯•é¢æ¿ï¼Œæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨ç´§æ€¥æ¢å¤
                        debugUtils.showDebugPanel();
                    }

                } catch (error) {
                    debugUtils.addLog(`ğŸ’¥ ç™»å½•è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                    utils.setLoading(loginBtn, false);
                    utils.showAlert(elements.loginAlert, 'ç™»å½•è¿‡ç¨‹å‡ºé”™ï¼Œè¯·é‡è¯•', 'error');
                }
            });

            // æ³¨å†ŒåŠŸèƒ½
            elements.registerBtn?.addEventListener('click', async function () {
                if (this.disabled) return;

                const email = elements.registerEmail.value.trim();
                const username = elements.registerUsername.value.trim();
                const password = elements.registerPassword.value;

                utils.setLoading(this, true);

                // æ¨¡æ‹Ÿæ³¨å†Œè¯·æ±‚
                setTimeout(async () => {
                    utils.setLoading(this, false);

                    // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œï¼ˆæœ¬åœ°+äº‘ç«¯ï¼‰
                    const savedUsers = JSON.parse(localStorage.getItem('registered_users') || '{}');
                    let emailExists = false;

                    // 1. æ£€æŸ¥æœ¬åœ°å­˜å‚¨
                    if (savedUsers[email]) {
                        emailExists = true;
                        console.log('é‚®ç®±å·²åœ¨æœ¬åœ°æ³¨å†Œ');
                    }

                    // 2. æ£€æŸ¥äº‘ç«¯å­˜å‚¨
                    if (!emailExists) {
                        const cloudUserData = await cloudUtils.loadUserFromCloud(email);
                        if (cloudUserData) {
                            emailExists = true;
                            console.log('é‚®ç®±å·²åœ¨äº‘ç«¯æ³¨å†Œ');
                            // åŒæ­¥äº‘ç«¯ç”¨æˆ·åˆ°æœ¬åœ°
                            savedUsers[email] = cloudUserData;
                            localStorage.setItem('registered_users', JSON.stringify(savedUsers));
                        }
                    }

                    if (emailExists) {
                        utils.showAlert(elements.registerAlert, 'è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•', 'error');
                        return;
                    }

                    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°å’Œäº‘ç«¯
                    const newUserData = {
                        username: username,
                        password: password,
                        registeredAt: new Date().toISOString(),
                        deviceRegistered: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop'
                    };

                    // ä¿å­˜åˆ°æœ¬åœ°
                    savedUsers[email] = newUserData;
                    localStorage.setItem('registered_users', JSON.stringify(savedUsers));

                    // ä¿å­˜åˆ°äº‘ç«¯
                    await cloudUtils.saveUserToCloud(email, newUserData);

                    utils.showAlert(elements.registerAlert, 'æ³¨å†ŒæˆåŠŸï¼Œæ­£åœ¨ç™»å½•...', 'success');
                    setTimeout(() => utils.redirectAfterAuth(email), 1000);
                }, 2000);
            });

            // æ‰¾å›å¯†ç åŠŸèƒ½
            let forgotStep = 1; // 1: è¾“å…¥é‚®ç®±, 2: è¾“å…¥éªŒè¯ç , 3: è®¾ç½®æ–°å¯†ç 

            elements.forgotBtn?.addEventListener('click', function () {
                if (forgotStep === 1) {
                    // å‘é€éªŒè¯ç 
                    const email = elements.forgotEmail.value.trim();
                    if (!email || !utils.validateEmail(email)) {
                        utils.showAlert(elements.forgotAlert, 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
                        return;
                    }

                    utils.setLoading(this, true);

                    setTimeout(() => {
                        utils.setLoading(this, false);

                        // ç”ŸæˆéªŒè¯ç ï¼ˆæ¼”ç¤ºç”¨ï¼‰
                        const code = Math.floor(100000 + Math.random() * 900000);
                        localStorage.setItem('reset_code', code);
                        localStorage.setItem('reset_email', email);

                        utils.showAlert(elements.forgotAlert, `éªŒè¯ç å·²å‘é€åˆ° ${email}ï¼ˆæ¼”ç¤ºç : ${code}ï¼‰`, 'success');

                        // æ˜¾ç¤ºéªŒè¯ç è¾“å…¥æ¡†
                        elements.verificationSection.style.display = 'block';
                        this.querySelector('.btn-text').textContent = 'éªŒè¯å¹¶ç»§ç»­';
                        forgotStep = 2;
                    }, 1500);

                } else if (forgotStep === 2) {
                    // éªŒè¯éªŒè¯ç 
                    const code = elements.verificationCode.value.trim();
                    const savedCode = localStorage.getItem('reset_code');

                    if (code !== savedCode) {
                        utils.showAlert(elements.forgotAlert, 'éªŒè¯ç é”™è¯¯', 'error');
                        return;
                    }

                    utils.showAlert(elements.forgotAlert, 'éªŒè¯æˆåŠŸï¼Œè¯·è®¾ç½®æ–°å¯†ç ', 'success');

                    // æ˜¾ç¤ºå¯†ç è®¾ç½®åŒºåŸŸ
                    elements.newPasswordSection.style.display = 'block';
                    elements.confirmNewPasswordSection.style.display = 'block';
                    this.querySelector('.btn-text').textContent = 'é‡ç½®å¯†ç ';
                    forgotStep = 3;

                } else if (forgotStep === 3) {
                    // é‡ç½®å¯†ç 
                    const newPassword = elements.newPassword.value;
                    const confirmPassword = elements.confirmNewPassword.value;

                    if (!utils.validatePassword(newPassword)) {
                        utils.showAlert(elements.forgotAlert, 'å¯†ç é•¿åº¦è‡³å°‘8ä½', 'error');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        utils.showAlert(elements.forgotAlert, 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                        return;
                    }

                    utils.setLoading(this, true);

                    setTimeout(async () => {
                        utils.setLoading(this, false);

                        // æ›´æ–°å¯†ç ï¼ˆæœ¬åœ°+äº‘ç«¯ï¼‰
                        const email = localStorage.getItem('reset_email');
                        const savedUsers = JSON.parse(localStorage.getItem('registered_users') || '{}');

                        if (savedUsers[email]) {
                            // æ›´æ–°æœ¬åœ°å¯†ç 
                            savedUsers[email].password = newPassword;
                            savedUsers[email].passwordResetAt = new Date().toISOString();
                            localStorage.setItem('registered_users', JSON.stringify(savedUsers));

                            // æ›´æ–°äº‘ç«¯å¯†ç 
                            await cloudUtils.saveUserToCloud(email, savedUsers[email]);
                            console.log('âœ… å¯†ç å·²æ›´æ–°åˆ°æœ¬åœ°å’Œäº‘ç«¯');
                        } else {
                            // å°è¯•ä»äº‘ç«¯åŠ è½½ç”¨æˆ·å¹¶æ›´æ–°
                            const cloudUserData = await cloudUtils.loadUserFromCloud(email);
                            if (cloudUserData) {
                                cloudUserData.password = newPassword;
                                cloudUserData.passwordResetAt = new Date().toISOString();

                                // åŒæ­¥åˆ°æœ¬åœ°å’Œäº‘ç«¯
                                savedUsers[email] = cloudUserData;
                                localStorage.setItem('registered_users', JSON.stringify(savedUsers));
                                await cloudUtils.saveUserToCloud(email, cloudUserData);
                                console.log('âœ… ä»äº‘ç«¯æ›´æ–°å¯†ç å¹¶åŒæ­¥åˆ°æœ¬åœ°');
                            }
                        }

                        // æ¸…ç†ä¸´æ—¶æ•°æ®
                        localStorage.removeItem('reset_code');
                        localStorage.removeItem('reset_email');

                        utils.showAlert(elements.forgotAlert, 'å¯†ç é‡ç½®æˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•', 'success');

                        // 3ç§’ååˆ‡æ¢åˆ°ç™»å½•é¡µé¢
                        setTimeout(() => {
                            elements.tabs[0].click();
                        }, 2000);
                    }, 1500);
                }
            });

            // é‡æ–°å‘é€éªŒè¯ç 
            elements.resendCode?.addEventListener('click', function () {
                const code = Math.floor(100000 + Math.random() * 900000);
                localStorage.setItem('reset_code', code);
                utils.showAlert(elements.forgotAlert, `æ–°éªŒè¯ç å·²å‘é€ï¼ˆæ¼”ç¤ºç : ${code}ï¼‰`, 'info');
            });

            // å›è½¦å¿«æ·é”®æ”¯æŒ
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    const activeSection = document.querySelector('.form-section.active');
                    if (activeSection) {
                        const btn = activeSection.querySelector('.btn:not(:disabled)');
                        btn?.click();
                    }
                }
            });

            // æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®
            function clearAllLocalData() {
                debugUtils.addLog('ğŸ—‘ï¸ å¼€å§‹æ¸…é™¤æœ¬åœ°æ•°æ®...');

                try {
                    const keysToRemove = [
                        'registered_users',
                        'auth_token',
                        'auth_user'
                    ];

                    // æ¸…é™¤æ³¨å†Œç”¨æˆ·æ•°æ®
                    keysToRemove.forEach(key => {
                        if (localStorage.getItem(key)) {
                            localStorage.removeItem(key);
                            debugUtils.addLog(`ğŸ—‘ï¸ å·²æ¸…é™¤: ${key}`);
                        }
                    });

                    // æ¸…é™¤æ‰€æœ‰planData_user_å¼€å¤´çš„äº‘ç«¯ç”¨æˆ·æ•°æ®
                    const allKeys = Object.keys(localStorage);
                    const userDataKeys = allKeys.filter(key => key.startsWith('planData_user_'));
                    userDataKeys.forEach(key => {
                        localStorage.removeItem(key);
                        debugUtils.addLog(`ğŸ—‘ï¸ å·²æ¸…é™¤äº‘ç«¯æ•°æ®: ${key}`);
                    });

                    debugUtils.addLog('âœ… æœ¬åœ°æ•°æ®æ¸…é™¤å®Œæˆï¼', 'success');
                    debugUtils.addLog('ğŸ’¡ ç°åœ¨å¯ä»¥é‡æ–°æ³¨å†Œäº†', 'info');

                    // 3ç§’åæç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        if (confirm('æ•°æ®å·²æ¸…é™¤å®Œæˆï¼æ˜¯å¦åˆ·æ–°é¡µé¢å¼€å§‹é‡æ–°æ³¨å†Œï¼Ÿ')) {
                            window.location.reload();
                        }
                    }, 1000);

                } catch (error) {
                    debugUtils.addLog(`âŒ æ¸…é™¤æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                }
            }

            // æ‰‹åŠ¨åŒæ­¥æ‰€æœ‰ç”¨æˆ·åˆ°äº‘ç«¯
            async function manualSyncUsers() {
                debugUtils.addLog('ğŸ”„ å¼€å§‹æ‰‹åŠ¨åŒæ­¥æœ¬åœ°ç”¨æˆ·åˆ°äº‘ç«¯...');

                try {
                    const localUsers = JSON.parse(localStorage.getItem('registered_users') || '{}');
                    const userEmails = Object.keys(localUsers);

                    debugUtils.addLog(`ğŸ“Š å‘ç°æœ¬åœ°ç”¨æˆ·: ${userEmails.length}ä¸ª`);

                    if (userEmails.length === 0) {
                        debugUtils.addLog('â„¹ï¸ æ²¡æœ‰æœ¬åœ°ç”¨æˆ·éœ€è¦åŒæ­¥');
                        return;
                    }

                    // é€ä¸ªåŒæ­¥ç”¨æˆ·
                    for (const email of userEmails) {
                        const userData = localUsers[email];
                        debugUtils.addLog(`ğŸ“¤ åŒæ­¥ç”¨æˆ·: ${email}`);

                        const result = await cloudUtils.saveUserToCloud(email, userData);
                        if (result) {
                            debugUtils.addLog(`âœ… ${email} åŒæ­¥æˆåŠŸ`, 'success');
                        } else {
                            debugUtils.addLog(`âŒ ${email} åŒæ­¥å¤±è´¥`, 'error');
                        }

                        // æ·»åŠ å°å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }

                    debugUtils.addLog('ğŸ‰ ç”¨æˆ·åŒæ­¥å®Œæˆï¼', 'success');

                } catch (error) {
                    debugUtils.addLog(`âŒ æ‰‹åŠ¨åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
                }
            }

            // æµ‹è¯•äº‘ç«¯è¿æ¥
            async function testCloudConnection() {
                debugUtils.addLog('ğŸ§ª å¼€å§‹æµ‹è¯•äº‘ç«¯è¿æ¥...');

                try {
                    // 1. æ£€æŸ¥LeanCloudçŠ¶æ€
                    if (!window.leanCloudSync) {
                        debugUtils.addLog('âŒ LeanCloudè„šæœ¬æœªåŠ è½½', 'error');
                        return;
                    }

                    debugUtils.addLog(`ğŸ“Š LeanCloudçŠ¶æ€: åˆå§‹åŒ–=${window.leanCloudSync.isInitialized}, å¯ç”¨=${window.leanCloudSync.isEnabled}`);

                    // 2. æµ‹è¯•ä¿å­˜æ•°æ®
                    const testData = {
                        test: true,
                        timestamp: new Date().toISOString(),
                        device: debugUtils.isMobile() ? 'mobile' : 'desktop'
                    };

                    debugUtils.addLog('ğŸ“¤ æµ‹è¯•ä¿å­˜æ•°æ®åˆ°äº‘ç«¯...');
                    const saveResult = await cloudUtils.saveUserToCloud('test@example.com', testData);

                    if (saveResult) {
                        debugUtils.addLog('âœ… ä¿å­˜æµ‹è¯•æˆåŠŸ', 'success');

                        // 3. æµ‹è¯•è¯»å–æ•°æ®
                        debugUtils.addLog('ğŸ“¥ æµ‹è¯•ä»äº‘ç«¯è¯»å–æ•°æ®...');
                        const loadResult = await cloudUtils.loadUserFromCloud('test@example.com');

                        if (loadResult && loadResult.test) {
                            debugUtils.addLog('âœ… è¯»å–æµ‹è¯•æˆåŠŸ', 'success');
                            debugUtils.addLog('ğŸ‰ äº‘ç«¯è¿æ¥æµ‹è¯•å®Œæˆï¼ŒåŠŸèƒ½æ­£å¸¸ï¼', 'success');
                        } else {
                            debugUtils.addLog('âŒ è¯»å–æµ‹è¯•å¤±è´¥', 'error');
                        }
                    } else {
                        debugUtils.addLog('âŒ ä¿å­˜æµ‹è¯•å¤±è´¥', 'error');
                    }

                } catch (error) {
                    debugUtils.addLog(`âŒ äº‘ç«¯è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }

            // ç´§æ€¥æ¢å¤è®¿é—®åŠŸèƒ½
            function emergencyRecovery() {
                debugUtils.addLog('ğŸ†˜ å¯åŠ¨ç´§æ€¥æ¢å¤æ¨¡å¼...');

                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value.trim();

                if (!email || !password) {
                    debugUtils.addLog('âŒ è¯·å…ˆè¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
                    return;
                }

                try {
                    // åˆ›å»ºä¸´æ—¶ç”¨æˆ·æ•°æ®
                    const tempUserData = {
                        email: email,
                        password: password, // å®é™…åº”ç”¨ä¸­åº”è¯¥åŠ å¯†
                        createdAt: new Date().toISOString(),
                        loginCount: 1,
                        lastLogin: new Date().toISOString(),
                        isEmergencyRecovery: true
                    };

                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    const localUsers = JSON.parse(localStorage.getItem('users') || '[]');

                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    const existingIndex = localUsers.findIndex(u => u.email === email);
                    if (existingIndex >= 0) {
                        localUsers[existingIndex] = tempUserData;
                        debugUtils.addLog('âœ… æ›´æ–°ç°æœ‰ç”¨æˆ·æ•°æ®', 'success');
                    } else {
                        localUsers.push(tempUserData);
                        debugUtils.addLog('âœ… åˆ›å»ºæ–°ç”¨æˆ·æ•°æ®', 'success');
                    }

                    localStorage.setItem('users', JSON.stringify(localUsers));

                    // è®¾ç½®å½“å‰ç™»å½•ç”¨æˆ·
                    localStorage.setItem('currentUser', JSON.stringify({
                        email: email,
                        loginTime: new Date().toISOString(),
                        isEmergencyRecovery: true
                    }));

                    debugUtils.addLog('ğŸ‰ ç´§æ€¥æ¢å¤æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');

                    // è·³è½¬åˆ°ä¸»é¡µé¢
                    setTimeout(() => {
                        const urlParams = new URLSearchParams(window.location.search);
                        const redirect = urlParams.get('redirect') || 'index.html';
                        window.location.href = redirect;
                    }, 1500);

                } catch (error) {
                    debugUtils.addLog(`âŒ ç´§æ€¥æ¢å¤å¤±è´¥: ${error.message}`, 'error');
                }
            }

            // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–äº‘åŒæ­¥
            function initializeCloudSync() {
                debugUtils.addLog('ğŸš€ åˆå§‹åŒ–äº‘åŒæ­¥ç³»ç»Ÿ...');

                // ç­‰å¾…LeanCloudåŠ è½½å®Œæˆ
                const checkLeanCloud = setInterval(() => {
                    if (window.leanCloudSync && window.leanCloudSync.isEnabled) {
                        clearInterval(checkLeanCloud);
                        debugUtils.addLog('âœ… LeanCloudå·²è¿æ¥ï¼Œå¼€å§‹åŒæ­¥ç”¨æˆ·æ•°æ®...', 'success');

                        // å»¶è¿ŸåŒæ­¥ï¼Œé¿å…é˜»å¡é¡µé¢åŠ è½½
                        setTimeout(() => {
                            cloudUtils.syncAllUsersToCloud().then(() => {
                                debugUtils.addLog('âœ… ç”¨æˆ·æ•°æ®äº‘åŒæ­¥å®Œæˆ', 'success');
                            }).catch(err => {
                                debugUtils.addLog(`âš ï¸ ç”¨æˆ·æ•°æ®äº‘åŒæ­¥å¤±è´¥: ${err.message}`, 'error');
                            });
                        }, 2000);
                    } else if (window.leanCloudSync && window.leanCloudSync.initError) {
                        clearInterval(checkLeanCloud);
                        debugUtils.addLog(`âš ï¸ LeanCloudåˆå§‹åŒ–å¤±è´¥: ${window.leanCloudSync.initError}`, 'error');
                        debugUtils.addLog('â„¹ï¸ å°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼Œè·¨è®¾å¤‡åŠŸèƒ½å—é™', 'error');
                    }
                }, 500);

                // 10ç§’ååœæ­¢æ£€æŸ¥
                setTimeout(() => clearInterval(checkLeanCloud), 10000);
            }

            // ç»‘å®šè°ƒè¯•æŒ‰é’®äº‹ä»¶
            document.getElementById('test-cloud-btn')?.addEventListener('click', testCloudConnection);
            document.getElementById('sync-users-btn')?.addEventListener('click', manualSyncUsers);
            document.getElementById('clear-data-btn')?.addEventListener('click', clearAllLocalData);
            document.getElementById('emergency-recovery-btn')?.addEventListener('click', emergencyRecovery);

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeCloudSync);
            } else {
                initializeCloudSync();
            }

            debugUtils.addLog('âœ… å¢å¼ºçš„ç™»å½•æ³¨å†Œç³»ç»Ÿå·²åŠ è½½ï¼ˆæ”¯æŒè·¨è®¾å¤‡åŒæ­¥ï¼‰', 'success');
        })();
    </script>
</body>

</html>