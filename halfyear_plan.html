<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script src="config.js"></script>
    
    <!-- Firebase配置 -->
    <script src="firebase-config.js"></script>
    
    <!-- 同步修复工具 -->
    <script src="sync-fix.js"></script>
    
    <!-- Firebase数据库同步 -->
    <script src="firebase-database-sync.js"></script>
    <script src="gemini-ai-assistant.js"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>半年计划 - 智能计划管理系统</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ai-assistant-styles.css">
    <style>
        /* 增强输入界面样式 */
        .quarter-card {
            transition: all 0.3s ease;
        }
        
        .quarter-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12) !important;
        }
        
        .mode-btn {
            transition: all 0.2s ease;
            font-weight: 500;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mode-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .mode-btn.active {
            font-weight: 600;
        }
        
        .quick-add-btn {
            font-weight: 500;
            min-height: 32px;
            border: none !important;
        }
        
        .quick-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
        }
        
        .template-btn {
            transition: all 0.2s ease;
            font-weight: 500;
            min-height: 32px;
        }
        
        .template-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .template-menu {
            animation: slideDown 0.2s ease;
            border: 1px solid #e0e0e0 !important;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .template-item {
            transition: all 0.15s ease;
        }
        
        .template-item:hover {
            background: #f8f9fa !important;
            color: #333 !important;
        }
        
        .enhanced-input-area {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .enhanced-input-area:hover {
            border-color: #ccc !important;
        }
        
        .enhanced-input-area:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .enhanced-input-area[data-input-mode="outline"] {
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }
        
        .input-hint {
            transition: opacity 0.3s ease;
        }
        
        .input-container:hover .input-hint {
            opacity: 0.5;
        }
        
        /* 输入工具栏样式 */
        .input-toolbar {
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #f0f0f0;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .quarter-card {
                padding: 16px !important;
            }
            
            .input-toolbar {
                flex-direction: column;
                gap: 8px !important;
                align-items: stretch !important;
            }
            
            .input-mode-selector {
                justify-content: center;
            }
            
            .template-dropdown {
                width: 100%;
            }
            
            .template-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* 待办事项增强样式 */
        .task-item {
            transition: all 0.2s ease;
            margin: 4px 0;
            padding: 8px;
            border-radius: 6px;
        }
        
        .task-item:hover {
            background: rgba(0, 0, 0, 0.02);
        }
        
        .custom-checkbox {
            transition: all 0.2s ease;
        }
        
        .custom-checkbox:hover {
            transform: scale(1.1);
        }
        
        /* 加载动画 */
        .loading-animation {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #2196f3;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 成功反馈动画 */
        .success-feedback {
            animation: successPulse 0.6s ease;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* 季度卡片特定样式 */
        .quarter-card[data-quarter="1"] .enhanced-input-area:focus {
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .quarter-card[data-quarter="2"] .enhanced-input-area:focus {
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        
        /* 智能分析按钮样式 */
        .smart-btn {
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .smart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .smart-btn:active {
            transform: translateY(0);
        }
        
        .growth-btn:hover {
            background: #00695c !important;
        }
        
        .skill-btn:hover {
            background: #1565c0 !important;
        }
        
        .learning-btn:hover {
            background: #2e7d32 !important;
        }
        
        /* 智能分析组响应式 */
        @media (max-width: 768px) {
            .smart-analysis-group {
                margin-left: 0 !important;
                margin-top: 8px;
                flex-wrap: wrap;
            }
            
            .smart-btn {
                font-size: 0.8em !important;
                padding: 4px 12px !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 页面头部 -->
        <div class="page-header">
            <a href="index.html" class="back-to-home">← 返回主页</a>
            <h1 class="page-title">📊 半年计划管理</h1>
            <div style="display: flex; gap: 8px;">
                <a href="quarter_plan.html" class="btn-main" style="font-size: 0.9em;">季度计划</a>
                <a href="year_plan.html" class="btn-main" style="font-size: 0.9em;">年计划</a>
            </div>
        </div>

        <!-- AI智能分析区域 - 放在最顶部 -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">
                <div style="flex: 1;">
                    <h3 style="color: white; margin: 0 0 8px 0; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                        🤖 AI 智能分析
                        <span style="font-size: 0.5em; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px;">Gemini 2.5 Pro</span>
                    </h3>
                    <p style="color: rgba(255,255,255,0.95); margin: 0; font-size: 1em; line-height: 1.6;">
                        让 AI 分析您的半年计划，提供专业建议和优化方案
                    </p>
                </div>
                <button type="button" onclick="startAIAnalysis()" style="background: white; color: #667eea; border: none; padding: 16px 40px; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; white-space: nowrap;">
                    🚀 开始分析
                </button>
            </div>
        </div>

        <!-- 智能控制栏 -->
        <div class="plan-smartbar">
            <!-- 智能分析功能 -->
            <div class="smart-analysis-group" style="display: flex; gap: 8px; margin-left: 16px;">
                <button type="button" id="growth-analysis-btn" class="smart-btn growth-btn" style="background: #00897b; color: white; border: none; border-radius: 20px; padding: 6px 16px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                    <span style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">📈</span>
                    Growth
                </button>
                
                <button type="button" id="skill-assessment-btn" class="smart-btn skill-btn" style="background: #1976d2; color: white; border: none; border-radius: 20px; padding: 6px 16px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                    <span style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">📊</span>
                    技能评估
                </button>
                
                <button type="button" id="learning-path-btn" class="smart-btn learning-btn" style="background: #388e3c; color: white; border: none; border-radius: 20px; padding: 6px 16px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                    <span style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">🌲</span>
                    学习路径
                </button>
                
                <button type="button" id="balance-analysis-btn" class="smart-btn balance-btn" style="background: #795548; color: white; border: none; border-radius: 20px; padding: 6px 16px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                    <span style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">⚖️</span>
                    平衡分析
                </button>
            </div>
            
            <div class="progress-bar" style="flex: 1;">
                <div style="background:#eee;border-radius:8px;height:18px;overflow:hidden;">
                    <div id="halfyear-progress-inner" class="progress-inner" style="width: 0%;"></div>
                </div>
                <div style="font-size:0.9em;color:#666;margin-top:3px;">
                    <span id="halfyear-progress-text">半年进度 0%</span>
                </div>
            </div>
            
            <button type="button" id="halfyear-prev">←</button>
            <select id="halfyear_select" style="width:100px;padding:4px;">
                <option value="1">上半年</option>
                <option value="2">下半年</option>
            </select>
            <input type="number" id="halfyear_year" min="2020" max="2050" style="width:80px;padding:4px;text-align:center;">
            <button type="button" id="halfyear-next">→</button>
        </div>

        <!-- 操作栏 -->
        <div class="save-bar">
            <button type="button" class="save-btn" data-type="halfyear">💾 保存计划</button>
            <button type="button" class="save-view-btn" data-type="halfyear">📚 历史记录</button>
            <button type="button" id="halfyear-analytics-btn">📊 半年分析</button>
            <button type="button" id="strategic-review-btn">🎯 战略回顾</button>
        </div>

        <!-- 半年愿景 -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                🌟 半年愿景与主题
                <span style="background: #e3f2fd; color: #1976d2; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">Vision</span>
            </label>
        </div>
        <textarea id="halfyear_vision" placeholder="设定这半年的愿景和主题...

例如：
• 职业发展的重大突破期
• 技能提升和能力建设期
• 健康生活方式建立期
• 人际关系深化期
• 创新探索和尝试期" style="min-height: 120px;"></textarea>

        <!-- 战略目标 -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                🎯 战略目标
                <span style="background: #4caf50; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">Strategic</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" id="strategic-planning-btn" style="background: #e3f2fd; color: #1976d2; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    🧠 战略规划
                </button>
                <button type="button" id="goal-alignment-btn" style="background: #e8f5e9; color: #2e7d32; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    🎯 目标对齐
                </button>
            </div>
        </div>
        <div id="halfyear_strategic_goals" class="todo-list-container" 
             data-placeholder="[ ] 半年的战略性目标..."
             style="border: 2px solid #4caf50; background: linear-gradient(135deg, rgba(76,175,80,0.05), rgba(76,175,80,0.02));">
        </div>

        <!-- 季度分解 -->
        <div class="plan-item-header">
            <label>📅 季度里程碑分解</label>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 24px;">
            <!-- 第一季度 -->
            <div class="quarter-card" style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 24px; border-left: 4px solid #2196f3; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);">
                <div class="quarter-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0; color: #2196f3; display: flex; align-items: center; gap: 8px;" id="quarter1-title">
                    🌱 第一季度
                    <span style="background: rgba(33,150,243,0.1); color: #2196f3; font-size: 0.8em; padding: 2px 6px; border-radius: 8px;">启动期</span>
                </h4>
                    <div class="input-mode-selector" style="display: flex; gap: 4px;">
                        <button type="button" class="mode-btn active" data-mode="todo" data-quarter="1" title="待办清单模式" style="padding: 4px 8px; border: none; border-radius: 6px; background: #2196f3; color: white; font-size: 12px; cursor: pointer;">📝</button>
                        <button type="button" class="mode-btn" data-mode="text" data-quarter="1" title="自由文本模式" style="padding: 4px 8px; border: none; border-radius: 6px; background: #e3f2fd; color: #2196f3; font-size: 12px; cursor: pointer;">💭</button>
                        <button type="button" class="mode-btn" data-mode="outline" data-quarter="1" title="大纲模式" style="padding: 4px 8px; border: none; border-radius: 6px; background: #e3f2fd; color: #2196f3; font-size: 12px; cursor: pointer;">📋</button>
                    </div>
                </div>
                
                <!-- 输入工具栏 -->
                <div class="input-toolbar" id="quarter1-toolbar" style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center; flex-wrap: wrap;">
                    <button type="button" class="quick-add-btn" data-quarter="1" style="padding: 6px 12px; border: none; border-radius: 8px; background: linear-gradient(135deg, #2196f3, #1976d2); color: white; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                        ➕ 快速添加
                    </button>
                    <div class="template-dropdown" style="position: relative;">
                        <button type="button" class="template-btn" data-quarter="1" style="padding: 6px 12px; border: none; border-radius: 8px; background: #e3f2fd; color: #2196f3; font-size: 12px; cursor: pointer;">
                            📄 模板
                        </button>
                        <div class="template-menu" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; min-width: 200px;">
                            <div class="template-item" data-template="work" style="padding: 8px 12px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #f0f0f0;">💼 工作目标</div>
                            <div class="template-item" data-template="learning" style="padding: 8px 12px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #f0f0f0;">📚 学习计划</div>
                            <div class="template-item" data-template="health" style="padding: 8px 12px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #f0f0f0;">💪 健康目标</div>
                            <div class="template-item" data-template="project" style="padding: 8px 12px; cursor: pointer; font-size: 12px;">🚀 项目里程碑</div>
                        </div>
                    </div>
                    <button type="button" class="help-btn" data-quarter="1" title="使用帮助" style="padding: 6px 8px; border: none; border-radius: 6px; background: transparent; color: #999; font-size: 12px; cursor: pointer;">❓</button>
                    <span style="font-size: 11px; color: #666; margin-left: auto;">Ctrl+Enter 快速添加</span>
                </div>

                <!-- 输入容器 -->
                <div class="input-container" style="position: relative;">
                    <div id="quarter1_milestones" class="enhanced-input-area todo-list-container" data-placeholder="点击开始添加第一季度的关键里程碑..." style="min-height: 140px; border: 2px dashed #e3f2fd; border-radius: 12px; padding: 16px; background: #fafafe; transition: all 0.3s; position: relative;">
                        <div class="input-hint" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #999; font-size: 14px; pointer-events: none; opacity: 0.7;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;">🎯</div>
                                <div>点击开始规划第一季度里程碑</div>
                                <div style="font-size: 12px; margin-top: 4px;">支持待办清单、自由文本和大纲三种模式</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 第二季度 -->
            <div class="quarter-card" style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 24px; border-left: 4px solid #ff9800; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);">
                <div class="quarter-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0; color: #ff9800; display: flex; align-items: center; gap: 8px;" id="quarter2-title">
                    🚀 第二季度
                    <span style="background: rgba(255,152,0,0.1); color: #ff9800; font-size: 0.8em; padding: 2px 6px; border-radius: 8px;">冲刺期</span>
                </h4>
                    <div class="input-mode-selector" style="display: flex; gap: 4px;">
                        <button type="button" class="mode-btn active" data-mode="todo" data-quarter="2" title="待办清单模式" style="padding: 4px 8px; border: none; border-radius: 6px; background: #ff9800; color: white; font-size: 12px; cursor: pointer;">📝</button>
                        <button type="button" class="mode-btn" data-mode="text" data-quarter="2" title="自由文本模式" style="padding: 4px 8px; border: none; border-radius: 6px; background: #fff3e0; color: #ff9800; font-size: 12px; cursor: pointer;">💭</button>
                        <button type="button" class="mode-btn" data-mode="outline" data-quarter="2" title="大纲模式" style="padding: 4px 8px; border: none; border-radius: 6px; background: #fff3e0; color: #ff9800; font-size: 12px; cursor: pointer;">📋</button>
                    </div>
                </div>
                
                <!-- 输入工具栏 -->
                <div class="input-toolbar" id="quarter2-toolbar" style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center; flex-wrap: wrap;">
                    <button type="button" class="quick-add-btn" data-quarter="2" style="padding: 6px 12px; border: none; border-radius: 8px; background: linear-gradient(135deg, #ff9800, #f57c00); color: white; font-size: 12px; cursor: pointer; transition: all 0.2s;">
                        ➕ 快速添加
                    </button>
                    <div class="template-dropdown" style="position: relative;">
                        <button type="button" class="template-btn" data-quarter="2" style="padding: 6px 12px; border: none; border-radius: 8px; background: #fff3e0; color: #ff9800; font-size: 12px; cursor: pointer;">
                            📄 模板
                        </button>
                        <div class="template-menu" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; min-width: 200px;">
                            <div class="template-item" data-template="work" style="padding: 8px 12px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #f0f0f0;">💼 工作目标</div>
                            <div class="template-item" data-template="learning" style="padding: 8px 12px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #f0f0f0;">📚 学习计划</div>
                            <div class="template-item" data-template="health" style="padding: 8px 12px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #f0f0f0;">💪 健康目标</div>
                            <div class="template-item" data-template="project" style="padding: 8px 12px; cursor: pointer; font-size: 12px;">🚀 项目里程碑</div>
                        </div>
                    </div>
                    <button type="button" class="help-btn" data-quarter="2" title="使用帮助" style="padding: 6px 8px; border: none; border-radius: 6px; background: transparent; color: #999; font-size: 12px; cursor: pointer;">❓</button>
                    <span style="font-size: 11px; color: #666; margin-left: auto;">Ctrl+Enter 快速添加</span>
                </div>

                <!-- 输入容器 -->
                <div class="input-container" style="position: relative;">
                    <div id="quarter2_milestones" class="enhanced-input-area todo-list-container" data-placeholder="点击开始添加第二季度的关键里程碑..." style="min-height: 140px; border: 2px dashed #fff3e0; border-radius: 12px; padding: 16px; background: #fffaf5; transition: all 0.3s; position: relative;">
                        <div class="input-hint" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #999; font-size: 14px; pointer-events: none; opacity: 0.7;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;">🚀</div>
                                <div>点击开始规划第二季度里程碑</div>
                                <div style="font-size: 12px; margin-top: 4px;">支持待办清单、自由文本和大纲三种模式</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 重点项目 -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                🏗️ 重点项目规划
                <span style="background: #9c27b0; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">Projects</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" id="project-planning-btn" style="background: #f3e5f5; color: #7b1fa2; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    📋 项目规划
                </button>
                <button type="button" id="resource-allocation-btn" style="background: #fff3e0; color: #ef6c00; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    🎯 资源分配
                </button>
            </div>
        </div>
        <div id="halfyear_projects" class="todo-list-container" 
             data-placeholder="[ ] 半年内要推进的重点项目..."
             style="border: 2px solid #9c27b0; background: linear-gradient(135deg, rgba(156,39,176,0.05), rgba(156,39,176,0.02));">
        </div>

        <!-- 能力发展 -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                📈 能力发展规划
                <span style="background: #00796b; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">Growth</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" id="skills-assessment-btn" style="background: #e0f2f1; color: #00796b; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    📊 技能评估
                </button>
                <button type="button" id="skills-learning-path-btn" style="background: #e3f2fd; color: #1976d2; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    🛤️ 学习路径
                </button>
            </div>
        </div>
        <textarea id="halfyear_skills" placeholder="能力发展和学习规划...

包括：
• 专业技能提升计划
• 新领域探索学习
• 软技能发展重点
• 知识体系构建
• 实践项目规划" style="min-height: 120px;"></textarea>

        <!-- 生活平衡 -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                ⚖️ 工作生活平衡
                <span style="background: #795548; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">Balance</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" id="balance-assessment-btn" style="background: #efebe9; color: #795548; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    ⚖️ 平衡分析
                </button>
                <button type="button" id="balance-suggestions-btn" style="background: #f3e5f5; color: #7b1fa2; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    💡 改善建议
                </button>
            </div>
        </div>
        <div id="halfyear_balance" class="todo-list-container" 
             data-placeholder="[ ] 工作生活平衡的具体措施..."
             style="border: 2px solid #795548; background: linear-gradient(135deg, rgba(121,85,72,0.05), rgba(121,85,72,0.02));">
        </div>

        <!-- 里程碑时间线 -->
        <div class="plan-item-header">
            <label>🗓️ 关键里程碑时间线</label>
        </div>
        <div style="background: rgba(255,255,255,0.9); border-radius: 16px; padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                <div style="text-align: center; padding: 12px; background: rgba(33,150,243,0.1); border-radius: 8px;">
                    <div style="font-weight: 600; color: #2196f3;" id="month1-label">1月</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 4px;">启动月</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(76,175,80,0.1); border-radius: 8px;">
                    <div style="font-weight: 600; color: #4caf50;" id="month2-label">2月</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 4px;">推进月</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(255,152,0,0.1); border-radius: 8px;">
                    <div style="font-weight: 600; color: #ff9800;" id="month3-label">3月</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 4px;">评估月</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(156,39,176,0.1); border-radius: 8px;">
                    <div style="font-weight: 600; color: #9c27b0;" id="month4-label">4月</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 4px;">调整月</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(244,67,54,0.1); border-radius: 8px;">
                    <div style="font-weight: 600; color: #f44336;" id="month5-label">5月</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 4px;">冲刺月</div>
                </div>
                <div style="text-align: center; padding: 12px; background: rgba(0,121,107,0.1); border-radius: 8px;">
                    <div style="font-weight: 600; color: #00796b;" id="month6-label">6月</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 4px;">收获月</div>
                </div>
            </div>
        </div>

        <!-- 半年回顾 -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                📝 半年回顾与总结
                <span style="background: #607d8b; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">Review</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" id="comprehensive-review-btn" style="background: #eceff1; color: #607d8b; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    📊 全面回顾
                </button>
                <button type="button" id="lessons-learned-btn" style="background: #fff3e0; color: #ef6c00; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    💡 经验总结
                </button>
            </div>
        </div>
        <textarea id="halfyear_review" placeholder="半年回顾与总结...

回顾维度：
• 战略目标达成情况分析
• 重点项目推进成果评估
• 能力发展和成长收获
• 工作生活平衡状况
• 重要经验教训总结
• 下半年改进优化方向" style="min-height: 150px;"></textarea>
    </div>

    <script src="common.js"></script>
    <script>
        // 半年计划实现
        let currentHalf = getCurrentHalf();
        let currentYear = new Date().getFullYear();

        function getCurrentHalf() {
            return new Date().getMonth() < 6 ? 1 : 2;
        }

        // 增强输入功能
        function initializeEnhancedInput() {
            // 初始化输入模式切换
            initInputModeButtons();
            
            // 初始化快速添加按钮
            initQuickAddButtons();
            
            // 初始化模板功能
            initTemplateDropdowns();
            
            // 初始化输入区域交互
            initInputAreaInteractions();
            
            // 初始化快捷键
            initKeyboardShortcuts();
            
            // 初始化帮助功能
            initHelpButtons();
        }

        // 输入模式切换功能
        function initInputModeButtons() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const quarter = this.dataset.quarter;
                    const mode = this.dataset.mode;
                    switchInputMode(quarter, mode, this);
                });
            });
        }

        function switchInputMode(quarter, mode, activeBtn) {
            // 更新按钮状态
            const modeSelector = activeBtn.parentElement;
            modeSelector.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (quarter === '1') {
                    btn.style.background = '#e3f2fd';
                    btn.style.color = '#2196f3';
                } else {
                    btn.style.background = '#fff3e0';
                    btn.style.color = '#ff9800';
                }
            });
            
            activeBtn.classList.add('active');
            if (quarter === '1') {
                activeBtn.style.background = '#2196f3';
                activeBtn.style.color = 'white';
            } else {
                activeBtn.style.background = '#ff9800';
                activeBtn.style.color = 'white';
            }

            // 更新输入区域
            const inputArea = document.getElementById(`quarter${quarter}_milestones`);
            updateInputAreaForMode(inputArea, mode);
        }

        function updateInputAreaForMode(inputArea, mode) {
            const currentContent = inputArea.textContent || '';
            
            switch(mode) {
                case 'todo':
                    inputArea.dataset.inputMode = 'todo';
                    inputArea.style.fontFamily = 'inherit';
                    break;
                case 'text':
                    inputArea.dataset.inputMode = 'text';
                    inputArea.style.fontFamily = 'inherit';
                    break;
                case 'outline':
                    inputArea.dataset.inputMode = 'outline';
                    inputArea.style.fontFamily = 'monospace';
                    break;
            }
            
            // 重新渲染内容
            if (currentContent) {
                formatContentForMode(inputArea, currentContent, mode);
            }
        }

        function formatContentForMode(inputArea, content, mode) {
            switch(mode) {
                case 'todo':
                    // 确保所有行都是待办事项格式
                    const lines = content.split('\n').filter(line => line.trim());
                    const todoLines = lines.map(line => {
                        const trimmed = line.trim();
                        if (!trimmed.match(/^\[.\]/)) {
                            return `[ ] ${trimmed}`;
                        }
                        return line;
                    });
                    inputArea.textContent = todoLines.join('\n');
                    TodoUtils.renderTodos(inputArea);
                    break;
                case 'text':
                    // 移除待办事项格式，保留纯文本
                    const textLines = content.split('\n').map(line => {
                        return line.replace(/^\[.\]\s*/, '').trim();
                    }).filter(line => line);
                    inputArea.textContent = textLines.join('\n');
                    break;
                case 'outline':
                    // 转换为大纲格式
                    const outlineLines = content.split('\n').map((line, index) => {
                        const clean = line.replace(/^\[.\]\s*/, '').trim();
                        if (clean) {
                            return `${index + 1}. ${clean}`;
                        }
                        return '';
                    }).filter(line => line);
                    inputArea.textContent = outlineLines.join('\n');
                    break;
            }
        }

        // 快速添加功能
        function initQuickAddButtons() {
            document.querySelectorAll('.quick-add-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const quarter = this.dataset.quarter;
                    quickAddItem(quarter);
                });
                
                // 添加悬停效果
                btn.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                });
                
                btn.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                });
            });
        }

        function quickAddItem(quarter) {
            const inputArea = document.getElementById(`quarter${quarter}_milestones`);
            const mode = inputArea.dataset.inputMode || 'todo';
            
            const currentContent = inputArea.textContent || '';
            let newContent = '';
            
            switch(mode) {
                case 'todo':
                    newContent = currentContent + (currentContent ? '\n' : '') + '[ ] ';
                    break;
                case 'text':
                    newContent = currentContent + (currentContent ? '\n' : '') + '';
                    break;
                case 'outline':
                    const lines = currentContent.split('\n').filter(line => line.trim());
                    const nextNumber = lines.length + 1;
                    newContent = currentContent + (currentContent ? '\n' : '') + `${nextNumber}. `;
                    break;
            }
            
            inputArea.textContent = newContent;
            
            // 根据模式进行渲染
            if (mode === 'todo') {
                TodoUtils.renderTodos(inputArea);
            }
            
            // 聚焦到末尾
            inputArea.focus();
            const range = document.createRange();
            const selection = window.getSelection();
            range.selectNodeContents(inputArea);
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // 模板功能
        function initTemplateDropdowns() {
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const dropdown = this.nextElementSibling;
                    const isVisible = dropdown.style.display === 'block';
                    
                    // 关闭所有其他下拉菜单
                    document.querySelectorAll('.template-menu').forEach(menu => {
                        menu.style.display = 'none';
                    });
                    
                    dropdown.style.display = isVisible ? 'none' : 'block';
                });
            });

            document.querySelectorAll('.template-item').forEach(item => {
                item.addEventListener('click', function() {
                    const template = this.dataset.template;
                    const quarter = this.closest('.quarter-card').querySelector('.template-btn').dataset.quarter;
                    applyTemplate(quarter, template);
                    
                    // 关闭下拉菜单
                    this.closest('.template-menu').style.display = 'none';
                });
                
                // 添加悬停效果
                item.addEventListener('mouseenter', function() {
                    this.style.background = '#f5f5f5';
                });
                
                item.addEventListener('mouseleave', function() {
                    this.style.background = 'white';
                });
            });

            // 点击其他地方关闭下拉菜单
            document.addEventListener('click', function() {
                document.querySelectorAll('.template-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            });
        }

        function applyTemplate(quarter, template) {
            const inputArea = document.getElementById(`quarter${quarter}_milestones`);
            const mode = inputArea.dataset.inputMode || 'todo';
            let templateContent = '';

            const templates = {
                work: [
                    '完成关键项目里程碑',
                    '提升团队协作效率',
                    '优化工作流程',
                    '达成业绩目标'
                ],
                learning: [
                    '掌握新技能或知识领域',
                    '完成在线课程学习',
                    '参加专业培训',
                    '阅读专业书籍'
                ],
                health: [
                    '建立规律运动习惯',
                    '改善饮食结构',
                    '保持良好作息',
                    '定期健康检查'
                ],
                project: [
                    '项目启动和规划',
                    '核心功能开发',
                    '测试和优化',
                    '项目交付上线'
                ]
            };

            const items = templates[template] || [];
            
            switch(mode) {
                case 'todo':
                    templateContent = items.map(item => `[ ] ${item}`).join('\n');
                    break;
                case 'text':
                    templateContent = items.join('\n');
                    break;
                case 'outline':
                    templateContent = items.map((item, index) => `${index + 1}. ${item}`).join('\n');
                    break;
            }

            const currentContent = inputArea.textContent || '';
            const newContent = currentContent + (currentContent ? '\n' : '') + templateContent;
            
            inputArea.textContent = newContent;
            
            if (mode === 'todo') {
                TodoUtils.renderTodos(inputArea);
            }
            
            // 显示成功消息
            MessageUtils.success(`已应用${getTemplateName(template)}模板`);
        }

        function getTemplateName(template) {
            const names = {
                work: '工作目标',
                learning: '学习计划',
                health: '健康目标',
                project: '项目里程碑'
            };
            return names[template] || template;
        }

        // 输入区域交互
        function initInputAreaInteractions() {
            document.querySelectorAll('.enhanced-input-area').forEach(area => {
                const hint = area.querySelector('.input-hint');
                
                area.addEventListener('focus', function() {
                    hint.style.display = 'none';
                    this.style.borderColor = this.id.includes('quarter1') ? '#2196f3' : '#ff9800';
                    this.style.borderStyle = 'solid';
                    this.style.background = 'white';
                });
                
                area.addEventListener('blur', function() {
                    if (!this.textContent.trim()) {
                        hint.style.display = 'block';
                        this.style.borderStyle = 'dashed';
                        this.style.borderColor = this.id.includes('quarter1') ? '#e3f2fd' : '#fff3e0';
                        this.style.background = this.id.includes('quarter1') ? '#fafafe' : '#fffaf5';
                    }
                });
                
                area.addEventListener('input', function() {
                    if (this.textContent.trim()) {
                        hint.style.display = 'none';
                    }
                });
            });
        }

        // 快捷键功能
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter: 快速添加
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    const focusedElement = document.activeElement;
                    if (focusedElement && focusedElement.classList.contains('enhanced-input-area')) {
                        const quarter = focusedElement.id.includes('quarter1') ? '1' : '2';
                        quickAddItem(quarter);
                    }
                }
                
                // Ctrl+T: 切换到待办模式
                if (e.ctrlKey && e.key === 't') {
                    e.preventDefault();
                    const focusedElement = document.activeElement;
                    if (focusedElement && focusedElement.classList.contains('enhanced-input-area')) {
                        const quarter = focusedElement.id.includes('quarter1') ? '1' : '2';
                        const modeBtn = document.querySelector(`[data-mode="todo"][data-quarter="${quarter}"]`);
                        if (modeBtn) modeBtn.click();
                    }
                }
            });
        }

        // 帮助功能
        function initHelpButtons() {
            document.querySelectorAll('.help-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const quarter = this.dataset.quarter;
                    showInputHelp(quarter);
                });
                
                // 添加悬停效果
                btn.addEventListener('mouseenter', function() {
                    this.style.background = '#f0f0f0';
                    this.style.color = '#666';
                });
                
                btn.addEventListener('mouseleave', function() {
                    this.style.background = 'transparent';
                    this.style.color = '#999';
                });
            });
        }

        function showInputHelp(quarter) {
            const quarterName = quarter === '1' ? '第一季度' : '第二季度';
            const helpContent = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: ${quarter === '1' ? '#2196f3' : '#ff9800'}; margin-bottom: 16px;">
                        ❓ ${quarterName}输入方式指南
                    </h4>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">
                        新的输入界面支持多种输入模式，让您更灵活地管理季度里程碑
                    </p>
                </div>
                
                <!-- 输入模式说明 -->
                <div style="margin-bottom: 20px;">
                    <h5 style="color: #333; margin-bottom: 12px;">📝 三种输入模式</h5>
                    <div style="display: grid; gap: 12px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <strong>📝 待办清单模式</strong>
                            <div style="font-size: 0.9em; color: #666; margin-top: 4px;">
                                • 适合管理具体的任务和目标<br>
                                • 支持复选框勾选完成状态<br>
                                • 格式：[ ] 任务描述
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <strong>💭 自由文本模式</strong>
                            <div style="font-size: 0.9em; color: #666; margin-top: 4px;">
                                • 适合记录想法、计划和描述<br>
                                • 无格式限制，灵活编辑<br>
                                • 支持多行文本输入
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                            <strong>📋 大纲模式</strong>
                            <div style="font-size: 0.9em; color: #666; margin-top: 4px;">
                                • 适合结构化的计划列表<br>
                                • 自动编号，层次清晰<br>
                                • 使用等宽字体显示
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 功能介绍 -->
                <div style="margin-bottom: 20px;">
                    <h5 style="color: #333; margin-bottom: 12px;">⚡ 快捷功能</h5>
                    <div style="background: #e8f5e9; padding: 16px; border-radius: 8px;">
                        <div style="display: grid; gap: 8px; font-size: 0.9em;">
                            <div><strong>➕ 快速添加：</strong> 点击按钮或按 Ctrl+Enter 快速添加新项目</div>
                            <div><strong>📄 模板功能：</strong> 选择预设模板快速填充常用内容</div>
                            <div><strong>🔄 模式切换：</strong> 随时切换输入模式，内容自动转换格式</div>
                            <div><strong>⌨️ 键盘快捷键：</strong> Ctrl+T 切换到待办模式</div>
                        </div>
                    </div>
                </div>
                
                <!-- 模板说明 -->
                <div style="margin-bottom: 20px;">
                    <h5 style="color: #333; margin-bottom: 12px;">📄 内置模板</h5>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.9em;">
                        <div style="background: white; padding: 8px; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <strong>💼 工作目标</strong><br>
                            <span style="color: #666;">职场发展相关</span>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <strong>📚 学习计划</strong><br>
                            <span style="color: #666;">技能提升相关</span>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <strong>💪 健康目标</strong><br>
                            <span style="color: #666;">身心健康相关</span>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <strong>🚀 项目里程碑</strong><br>
                            <span style="color: #666;">项目管理相关</span>
                        </div>
                    </div>
                </div>
                
                <!-- 使用技巧 -->
                <div style="margin-bottom: 20px;">
                    <h5 style="color: #333; margin-bottom: 12px;">💡 使用技巧</h5>
                    <div style="background: #fff3e0; padding: 16px; border-radius: 8px; font-size: 0.9em; color: #ef6c00;">
                        <div style="margin-bottom: 8px;">• 先选择合适的输入模式，再开始输入内容</div>
                        <div style="margin-bottom: 8px;">• 使用模板可以快速生成常用的里程碑结构</div>
                        <div style="margin-bottom: 8px;">• 在待办模式下可以通过点击复选框标记完成状态</div>
                        <div>• 内容会自动保存，无需手动保存</div>
                    </div>
                </div>
            `;
            
            ModalUtils.show(`🎯 ${quarterName}输入指南`, helpContent, 'large');
        }

        // 智能分析功能
        function initSmartAnalysisButtons() {
            console.log('🚀 初始化智能分析按钮...');
            
            // Growth 分析按钮
            const growthBtn = document.getElementById('growth-analysis-btn');
            if (growthBtn) {
                growthBtn.addEventListener('click', function() {
                    console.log('📈 Growth按钮被点击');
                    generateGrowthAnalysis();
                });
                console.log('✅ Growth按钮事件绑定成功');
            } else {
                console.error('❌ 找不到Growth按钮');
            }
            
            // 技能评估按钮 - 主控制栏
            const skillBtn = document.getElementById('skill-assessment-btn');
            if (skillBtn) {
                skillBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('📊 主控制栏-技能评估按钮被点击');
                    generateSkillAssessment();
                });
                console.log('✅ 技能评估按钮事件绑定成功');
            } else {
                console.error('❌ 找不到技能评估按钮');
            }
            
            // 学习路径按钮 - 主控制栏
            const learningBtn = document.getElementById('learning-path-btn');
            if (learningBtn) {
                learningBtn.addEventListener('click', function() {
                    console.log('🌲 学习路径按钮被点击');
                    generateLearningPath();
                });
                console.log('✅ 学习路径按钮事件绑定成功');
            } else {
                console.error('❌ 找不到学习路径按钮');
            }
            
            // 工作生活平衡分析按钮 - 主控制栏
            const balanceBtn = document.getElementById('balance-analysis-btn');
            if (balanceBtn) {
                balanceBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('⚖️ 工作生活平衡分析按钮被点击');
                    generateBalanceAnalysis();
                });
                console.log('✅ 工作生活平衡分析按钮事件绑定成功');
            } else {
                console.error('❌ 找不到工作生活平衡分析按钮');
            }
            
            // 技能评估按钮 - 技能发展区域
            const skillsBtn = document.getElementById('skills-assessment-btn');
            if (skillsBtn) {
                skillsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('📊 技能发展区域-技能评估按钮被点击');
                    generateSkillAssessment();
                });
                console.log('✅ 技能发展区域-技能评估按钮事件绑定成功');
            } else {
                console.error('❌ 找不到技能发展区域-技能评估按钮');
            }
            
            // 学习路径按钮 - 技能发展区域
            const skillsLearningBtn = document.getElementById('skills-learning-path-btn');
            if (skillsLearningBtn) {
                skillsLearningBtn.addEventListener('click', function() {
                    console.log('🌲 技能发展区域-学习路径按钮被点击');
                    generateLearningPath();
                });
                console.log('✅ 技能发展区域-学习路径按钮事件绑定成功');
            }
            
            // 工作生活平衡分析按钮 - 平衡区域
            const balanceAssessmentBtn = document.getElementById('balance-assessment-btn');
            if (balanceAssessmentBtn) {
                balanceAssessmentBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('⚖️ 平衡区域-平衡分析按钮被点击');
                    generateBalanceAnalysis();
                });
                console.log('✅ 平衡区域-平衡分析按钮事件绑定成功');
            } else {
                console.error('❌ 找不到平衡区域-平衡分析按钮');
            }
            
            // 平衡改善建议按钮 - 平衡区域
            const balanceSuggestionsBtn = document.getElementById('balance-suggestions-btn');
            if (balanceSuggestionsBtn) {
                balanceSuggestionsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('💡 平衡改善建议按钮被点击');
                    generateBalanceSuggestions();
                });
                console.log('✅ 平衡改善建议按钮事件绑定成功');
            } else {
                console.error('❌ 找不到平衡改善建议按钮');
            }
            
            console.log('🎉 智能分析按钮初始化完成');
        }

        // Growth 成长分析功能
        function generateGrowthAnalysis() {
            console.log('🔥 开始生成Growth成长分析...');
            try {
                const halfyearKey = `${currentYear}-H${currentHalf}`;
                const currentData = StorageUtils.loadPlan('halfyear', halfyearKey) || {};
                console.log('📊 加载的数据:', currentData);
                
                const growthAnalysis = analyzeGrowthMetrics(currentData);
                console.log('📈 分析结果:', growthAnalysis);
                
                const growthContent = generateGrowthAnalysisHTML(growthAnalysis);
                console.log('🎨 生成的HTML长度:', growthContent.length);
                
                if (typeof ModalUtils !== 'undefined' && ModalUtils.show) {
                    ModalUtils.show('📈 Growth 成长分析', growthContent, 'large');
                    console.log('✅ 成功显示Growth分析模态框');
                } else {
                    console.error('❌ ModalUtils未定义');
                    alert('Growth成长分析功能正在开发中...');
                }
            } catch (error) {
                console.error('❌ Growth分析生成失败:', error);
                alert('Growth分析出现错误: ' + error.message);
            }
        }

        function analyzeGrowthMetrics(data) {
            console.log('📊 开始分析成长指标，数据:', data);
            
            // 确保数据结构完整
            const safeData = data || {};
            
            // 分析各个维度的成长指标
            const metrics = {
                strategic: analyzeGrowthDimension(safeData.strategicGoals || '', '战略目标'),
                quarters: {
                    q1: analyzeGrowthDimension(safeData.quarter1Milestones || '', '第一季度'),
                    q2: analyzeGrowthDimension(safeData.quarter2Milestones || '', '第二季度')
                },
                projects: analyzeGrowthDimension(safeData.projects || '', '重点项目'),
                skills: analyzeSkillGrowth(safeData.skills || ''),
                balance: analyzeBalanceGrowth(safeData.balance || ''),
                overall: calculateOverallGrowthScore(safeData)
            };
            
            console.log('📈 成长指标分析结果:', metrics);
            return metrics;
        }

        function analyzeGrowthDimension(content, dimension) {
            const lines = content.split('\n').filter(line => line.trim());
            const completed = lines.filter(line => line.includes('[x]') || line.includes('[X]')).length;
            const total = lines.filter(line => line.match(/^\[.\]/)).length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            // 成长潜力评估
            const growthKeywords = [
                '学习', '提升', '发展', '突破', '创新', '优化', '改进', '增长', 
                '扩展', '深化', '建立', '培养', '掌握', '精通', '探索'
            ];
            
            const growthIndicators = lines.filter(line => 
                growthKeywords.some(keyword => line.includes(keyword))
            ).length;
            
            const growthPotential = Math.min(100, (growthIndicators / Math.max(1, lines.length)) * 100 + 
                                           (progress * 0.3));
            
            return {
                dimension,
                progress,
                total,
                completed,
                growthIndicators,
                growthPotential: Math.round(growthPotential),
                suggestions: generateGrowthSuggestions(content, progress)
            };
        }

        function analyzeSkillGrowth(skillsContent) {
            const skillCategories = {
                technical: ['技术', '编程', '开发', '设计', '工具', '软件', '系统'],
                soft: ['沟通', '领导', '团队', '管理', '协作', '演讲', '写作'],
                business: ['商业', '市场', '运营', '分析', '策略', '财务', '项目'],
                personal: ['时间', '效率', '思维', '创新', '学习', '阅读', '健康']
            };
            
            const skillAnalysis = {};
            Object.keys(skillCategories).forEach(category => {
                const keywords = skillCategories[category];
                const mentions = keywords.filter(keyword => 
                    skillsContent.toLowerCase().includes(keyword)
                ).length;
                
                skillAnalysis[category] = {
                    name: getCategoryName(category),
                    score: Math.min(100, mentions * 20),
                    keywords: keywords.filter(keyword => 
                        skillsContent.toLowerCase().includes(keyword)
                    )
                };
            });
            
            return skillAnalysis;
        }

        function getCategoryName(category) {
            const names = {
                technical: '技术技能',
                soft: '软技能',
                business: '商业技能',
                personal: '个人发展'
            };
            return names[category] || category;
        }

        function analyzeBalanceGrowth(balanceContent) {
            const balanceAreas = {
                work: ['工作', '职业', '项目', '任务', '效率'],
                health: ['健康', '运动', '锻炼', '饮食', '睡眠'],
                relationship: ['人际', '社交', '家庭', '朋友', '关系'],
                personal: ['兴趣', '爱好', '学习', '成长', '休闲']
            };
            
            const balanceAnalysis = {};
            Object.keys(balanceAreas).forEach(area => {
                const keywords = balanceAreas[area];
                const mentions = keywords.filter(keyword => 
                    balanceContent.toLowerCase().includes(keyword)
                ).length;
                
                balanceAnalysis[area] = {
                    name: getBalanceAreaName(area),
                    attention: Math.min(100, mentions * 25),
                    keywords: keywords.filter(keyword => 
                        balanceContent.toLowerCase().includes(keyword)
                    )
                };
            });
            
            return balanceAnalysis;
        }

        function getBalanceAreaName(area) {
            const names = {
                work: '工作发展',
                health: '健康管理', 
                relationship: '人际关系',
                personal: '个人兴趣'
            };
            return names[area] || area;
        }

        function calculateOverallGrowthScore(data) {
            const weights = {
                strategic: 0.25,
                quarters: 0.3,
                projects: 0.2,
                skills: 0.15,
                balance: 0.1
            };
            
            let totalScore = 0;
            let totalWeight = 0;
            
            // 计算各维度得分
            if (data.strategicGoals) {
                const strategic = analyzeGrowthDimension(data.strategicGoals, '战略');
                totalScore += strategic.growthPotential * weights.strategic;
                totalWeight += weights.strategic;
            }
            
            if (data.quarter1Milestones || data.quarter2Milestones) {
                const q1 = analyzeGrowthDimension(data.quarter1Milestones || '', 'Q1');
                const q2 = analyzeGrowthDimension(data.quarter2Milestones || '', 'Q2');
                const avgQuarter = (q1.growthPotential + q2.growthPotential) / 2;
                totalScore += avgQuarter * weights.quarters;
                totalWeight += weights.quarters;
            }
            
            if (totalWeight > 0) {
                return Math.round(totalScore / totalWeight);
            }
            
            return 0;
        }

        function generateGrowthSuggestions(content, progress) {
            const suggestions = [];
            
            if (progress < 30) {
                suggestions.push('建议分解大目标为更小的可执行步骤');
                suggestions.push('设定每周检查点，确保持续推进');
            } else if (progress < 70) {
                suggestions.push('进展良好，可以考虑增加挑战性目标');
                suggestions.push('建立反馈机制，持续优化执行方式');
            } else {
                suggestions.push('执行效果优秀，可以分享经验给团队');
                suggestions.push('考虑设立更高层次的发展目标');
            }
            
            return suggestions;
        }

        function generateGrowthAnalysisHTML(analysis) {
            return `
                <div style="margin-bottom: 24px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">📈</div>
                        <h3 style="color: #00897b; margin: 0;">Growth 成长分析报告</h3>
                        <p style="color: #666; margin: 8px 0 0 0;">基于您的半年计划数据生成的个人成长洞察</p>
                    </div>
                </div>

                <!-- 整体成长指数 -->
                <div style="background: linear-gradient(135deg, #00897b, #4db6ac); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white; text-align: center;">
                    <h4 style="margin: 0 0 12px 0; font-size: 1.2em;">🏆 整体成长指数</h4>
                    <div style="font-size: 3em; font-weight: bold; margin: 12px 0;">${analysis.overall}</div>
                    <div style="font-size: 1em; opacity: 0.9;">
                        ${analysis.overall >= 80 ? '🌟 卓越成长' : 
                          analysis.overall >= 60 ? '🚀 快速成长' : 
                          analysis.overall >= 40 ? '📈 稳步成长' : '🌱 起步阶段'}
                    </div>
                </div>

                <!-- 各维度成长分析 -->
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #00897b; margin-bottom: 16px;">📊 多维度成长分析</h4>
                    <div style="display: grid; gap: 16px;">
                        
                        <!-- 战略目标维度 -->
                        <div style="background: #f8f9fa; border-radius: 12px; padding: 16px; border-left: 4px solid #00897b;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong>🎯 ${analysis.strategic.dimension}</strong>
                                <span style="background: #00897b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                    ${analysis.strategic.growthPotential}%
                                </span>
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                进度: ${analysis.strategic.completed}/${analysis.strategic.total} 
                                (${analysis.strategic.progress}%)
                            </div>
                            <div style="background: #e0e0e0; height: 6px; border-radius: 3px; margin: 8px 0;">
                                <div style="background: #00897b; height: 100%; width: ${analysis.strategic.growthPotential}%; border-radius: 3px; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <!-- 季度里程碑维度 -->
                        <div style="background: #f8f9fa; border-radius: 12px; padding: 16px; border-left: 4px solid #1976d2;">
                            <strong>📅 季度里程碑</strong>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">第一季度</div>
                                    <div style="background: #e3f2fd; height: 6px; border-radius: 3px; margin: 4px 0;">
                                        <div style="background: #1976d2; height: 100%; width: ${analysis.quarters.q1.growthPotential}%; border-radius: 3px;"></div>
                                    </div>
                                    <div style="font-size: 0.8em; color: #1976d2;">${analysis.quarters.q1.growthPotential}%</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">第二季度</div>
                                    <div style="background: #e3f2fd; height: 6px; border-radius: 3px; margin: 4px 0;">
                                        <div style="background: #1976d2; height: 100%; width: ${analysis.quarters.q2.growthPotential}%; border-radius: 3px;"></div>
                                    </div>
                                    <div style="font-size: 0.8em; color: #1976d2;">${analysis.quarters.q2.growthPotential}%</div>
                                </div>
                            </div>
                        </div>

                        <!-- 技能发展维度 -->
                        <div style="background: #f8f9fa; border-radius: 12px; padding: 16px; border-left: 4px solid #ff9800;">
                            <strong>🧠 技能发展雷达</strong>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 12px;">
                                ${Object.values(analysis.skills || {}).map(skill => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0;">
                                        <span style="font-size: 0.9em;">${skill.name}</span>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="background: #ffcc80; height: 4px; width: 40px; border-radius: 2px;">
                                                <div style="background: #ff9800; height: 100%; width: ${skill.score}%; border-radius: 2px;"></div>
                                            </div>
                                            <span style="font-size: 0.8em; color: #ff9800; min-width: 30px;">${skill.score}%</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 成长建议 -->
                <div style="background: #e8f5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #2e7d32; margin: 0 0 16px 0;">💡 个性化成长建议</h4>
                    <div style="display: grid; gap: 12px;">
                        ${(analysis.strategic?.suggestions || []).map(suggestion => `
                            <div style="display: flex; align-items: flex-start; gap: 8px;">
                                <span style="color: #4caf50; font-size: 1.2em;">•</span>
                                <span style="color: #2e7d32; font-size: 0.9em;">${suggestion}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 成长趋势预测 -->
                <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); border-radius: 12px; padding: 20px;">
                    <h4 style="color: #7b1fa2; margin: 0 0 12px 0;">🔮 成长趋势预测</h4>
                    <div style="font-size: 0.9em; color: #4a148c; line-height: 1.6;">
                        基于当前的成长轨迹，预计在接下来的季度中：<br>
                        • 您在战略目标执行方面将有 <strong>${Math.min(100, analysis.strategic.growthPotential + 15)}%</strong> 的提升空间<br>
                        • 技能发展将呈现 <strong>${analysis.overall >= 70 ? '加速' : '稳步'}</strong> 上升趋势<br>
                        • 建议重点关注 <strong>${Object.values(analysis.skills).sort((a,b) => a.score - b.score)[0]?.name || '个人发展'}</strong> 领域的提升
                    </div>
                </div>
            `;
        }

        // 技能评估功能
        function generateSkillAssessment() {
            console.log('🔥 开始生成技能评估...');
            
            // 立即显示一个测试提示，确认函数被调用
            if (typeof MessageUtils !== 'undefined' && MessageUtils.info) {
                MessageUtils.info('正在生成技能评估报告...');
            }
            
            try {
                const halfyearKey = `${currentYear}-H${currentHalf}`;
                const currentData = StorageUtils.loadPlan('halfyear', halfyearKey) || {};
                console.log('📊 技能评估-加载的数据:', currentData);
                
                // 检查ModalUtils是否可用
                console.log('🔍 检查ModalUtils状态:', {
                    typeof_ModalUtils: typeof ModalUtils,
                    has_show: ModalUtils && typeof ModalUtils.show === 'function',
                    common_js_loaded: typeof StorageUtils !== 'undefined'
                });
                
                const skillAssessment = analyzeSkillsComprehensive(currentData);
                console.log('📊 技能分析结果:', skillAssessment);
                
                const assessmentContent = generateSkillAssessmentHTML(skillAssessment);
                console.log('🎨 HTML内容长度:', assessmentContent.length);
                
                if (typeof ModalUtils !== 'undefined' && ModalUtils.show) {
                    console.log('✅ 准备显示模态框...');
                    ModalUtils.show('📊 技能评估报告', assessmentContent, 'large');
                    console.log('✅ 成功显示技能评估模态框');
                } else {
                    console.error('❌ ModalUtils未定义或缺少show方法');
                    // 创建简单的提示框作为fallback
                    const fallbackModal = document.createElement('div');
                    fallbackModal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                        background: rgba(0,0,0,0.5); z-index: 9999; display: flex;
                        align-items: center; justify-content: center;
                    `;
                    fallbackModal.innerHTML = `
                        <div style="background: white; border-radius: 8px; padding: 20px; max-width: 80vw; max-height: 80vh; overflow: auto;">
                            <button onclick="this.closest('div').parentNode.remove()" style="float: right; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                            <div>${assessmentContent}</div>
                        </div>
                    `;
                    document.body.appendChild(fallbackModal);
                }
            } catch (error) {
                console.error('❌ 技能评估生成失败:', error);
                console.error('❌ 错误堆栈:', error.stack);
                alert('技能评估出现错误: ' + error.message);
            }
        }

        function analyzeSkillsComprehensive(data) {
            const skillFramework = {
                technical: {
                    name: '技术技能',
                    icon: '💻',
                    color: '#1976d2',
                    categories: {
                        programming: { name: '编程开发', keywords: ['编程', '开发', '代码', '软件', 'Python', 'Java', 'JavaScript', '前端', '后端'] },
                        tools: { name: '工具使用', keywords: ['工具', '软件', '系统', '平台', 'Office', 'Photoshop', 'Excel'] },
                        technical_writing: { name: '技术文档', keywords: ['文档', '技术写作', '规范', '标准', '流程'] }
                    }
                },
                soft: {
                    name: '软技能',
                    icon: '🤝',
                    color: '#ff9800',
                    categories: {
                        communication: { name: '沟通表达', keywords: ['沟通', '表达', '演讲', '汇报', '交流', '写作'] },
                        leadership: { name: '领导管理', keywords: ['领导', '管理', '团队', '协调', '组织', '决策'] },
                        collaboration: { name: '协作能力', keywords: ['协作', '合作', '配合', '团队', '集体'] }
                    }
                },
                business: {
                    name: '商业技能',
                    icon: '📈',
                    color: '#4caf50',
                    categories: {
                        analysis: { name: '分析思维', keywords: ['分析', '数据', '逻辑', '思维', '解决问题', '决策'] },
                        market: { name: '市场洞察', keywords: ['市场', '商业', '客户', '用户', '需求', '竞争'] },
                        project: { name: '项目管理', keywords: ['项目', '管理', '计划', '执行', '监控', '风险'] }
                    }
                },
                personal: {
                    name: '个人发展',
                    icon: '🌱',
                    color: '#9c27b0',
                    categories: {
                        learning: { name: '学习能力', keywords: ['学习', '成长', '发展', '提升', '进步', '掌握'] },
                        efficiency: { name: '效率管理', keywords: ['效率', '时间', '管理', '优化', '流程', '方法'] },
                        innovation: { name: '创新思维', keywords: ['创新', '创意', '突破', '改进', '优化', '探索'] }
                    }
                }
            };

            const assessment = {};
            const allContent = `
                ${data.strategicGoals || ''} 
                ${data.quarter1Milestones || ''} 
                ${data.quarter2Milestones || ''} 
                ${data.projects || ''} 
                ${data.skills || ''}
            `.toLowerCase();

            Object.keys(skillFramework).forEach(domain => {
                const domainInfo = skillFramework[domain];
                assessment[domain] = {
                    ...domainInfo,
                    categories: {},
                    overallScore: 0
                };

                let domainTotal = 0;
                let categoryCount = 0;

                Object.keys(domainInfo.categories).forEach(category => {
                    const categoryInfo = domainInfo.categories[category];
                    const matches = categoryInfo.keywords.filter(keyword => 
                        allContent.includes(keyword)
                    ).length;
                    
                    const score = Math.min(100, matches * 15 + Math.random() * 10);
                    const level = getSkillLevel(score);
                    
                    assessment[domain].categories[category] = {
                        ...categoryInfo,
                        score: Math.round(score),
                        level: level,
                        matchedKeywords: categoryInfo.keywords.filter(keyword => 
                            allContent.includes(keyword)
                        ),
                        recommendations: generateSkillRecommendations(category, score)
                    };

                    domainTotal += score;
                    categoryCount++;
                });

                assessment[domain].overallScore = Math.round(domainTotal / categoryCount);
            });

            // 计算技能雷达图数据
            const radarData = generateSkillRadarData(assessment);
            
            // 生成发展建议
            const developmentPlan = generateSkillDevelopmentPlan(assessment);

            return {
                domains: assessment,
                radar: radarData,
                development: developmentPlan,
                summary: generateSkillSummary(assessment)
            };
        }

        function getSkillLevel(score) {
            if (score >= 80) return { name: '专家', icon: '🏆', color: '#4caf50' };
            if (score >= 60) return { name: '熟练', icon: '⭐', color: '#ff9800' };
            if (score >= 40) return { name: '进阶', icon: '📈', color: '#2196f3' };
            if (score >= 20) return { name: '入门', icon: '🌱', color: '#9c27b0' };
            return { name: '待发展', icon: '💡', color: '#f44336' };
        }

        function generateSkillRecommendations(category, score) {
            const recommendations = {
                programming: [
                    '参加编程训练营或在线课程',
                    '完成实际项目练习',
                    '阅读优秀代码和技术文档',
                    '参与开源项目贡献'
                ],
                communication: [
                    '参加演讲俱乐部如Toastmasters',
                    '多写技术博客和文档',
                    '主动在会议中发言',
                    '练习一对一沟通技巧'
                ],
                analysis: [
                    '学习数据分析工具',
                    '培养逻辑思维能力',
                    '练习案例分析方法',
                    '学习商业分析框架'
                ],
                learning: [
                    '制定系统的学习计划',
                    '建立知识管理体系',
                    '培养反思总结习惯',
                    '寻找学习伙伴和导师'
                ]
            };

            const defaultRecs = [
                '设定明确的技能发展目标',
                '寻找实践应用的机会',
                '向相关领域专家学习',
                '定期回顾和调整学习方法'
            ];

            return recommendations[category] || defaultRecs;
        }

        function generateSkillRadarData(assessment) {
            return Object.keys(assessment).map(domain => ({
                domain: assessment[domain].name,
                score: assessment[domain].overallScore,
                color: assessment[domain].color
            }));
        }

        function generateSkillDevelopmentPlan(assessment) {
            const weakestDomains = Object.keys(assessment)
                .map(domain => ({
                    domain,
                    score: assessment[domain].overallScore,
                    name: assessment[domain].name
                }))
                .sort((a, b) => a.score - b.score)
                .slice(0, 2);

            const strongestDomains = Object.keys(assessment)
                .map(domain => ({
                    domain,
                    score: assessment[domain].overallScore,
                    name: assessment[domain].name
                }))
                .sort((a, b) => b.score - a.score)
                .slice(0, 2);

            return {
                priorityAreas: weakestDomains,
                strengthAreas: strongestDomains,
                actionPlan: generateSkillActionPlan(weakestDomains, assessment)
            };
        }

        function generateSkillActionPlan(weakAreas, assessment) {
            return weakAreas.map(area => {
                const domain = assessment[area.domain];
                const weakestCategory = Object.keys(domain.categories)
                    .map(cat => ({
                        category: cat,
                        ...domain.categories[cat]
                    }))
                    .sort((a, b) => a.score - b.score)[0];

                return {
                    area: area.name,
                    focus: weakestCategory.name,
                    score: weakestCategory.score,
                    actions: weakestCategory.recommendations.slice(0, 2)
                };
            });
        }

        function generateSkillSummary(assessment) {
            const overallScore = Object.values(assessment)
                .reduce((sum, domain) => sum + domain.overallScore, 0) / Object.keys(assessment).length;

            const strengths = [];
            const improvements = [];

            Object.keys(assessment).forEach(domain => {
                const domainData = assessment[domain];
                if (domainData.overallScore >= 60) {
                    strengths.push(domainData.name);
                } else {
                    improvements.push(domainData.name);
                }
            });

            return {
                overallScore: Math.round(overallScore),
                level: getSkillLevel(overallScore),
                strengths,
                improvements
            };
        }

        function generateSkillAssessmentHTML(assessment) {
            // 确保assessment对象的基本结构
            if (!assessment || !assessment.summary) {
                console.error('❌ 技能评估数据结构不完整:', assessment);
                return `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 16px;">⚠️</div>
                        <h3 style="color: #f44336;">数据加载失败</h3>
                        <p style="color: #666;">请确保您的半年计划包含足够的内容进行分析</p>
                    </div>
                `;
            }

            console.log('🎨 开始生成技能评估HTML，数据结构:', assessment);

            const summary = assessment.summary || {};
            const domains = assessment.domains || {};
            const radar = assessment.radar || [];
            const development = assessment.development || {};

            return `
                <div style="margin-bottom: 24px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">📊</div>
                        <h3 style="color: #1976d2; margin: 0;">技能评估报告</h3>
                        <p style="color: #666; margin: 8px 0 0 0;">基于您的计划内容进行的全方位技能分析</p>
                    </div>
                </div>

                <!-- 综合技能概览 -->
                <div style="background: linear-gradient(135deg, #1976d2, #42a5f5); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white; text-align: center;">
                    <h4 style="margin: 0 0 12px 0; font-size: 1.2em;">🎯 综合技能水平</h4>
                    <div style="font-size: 3em; font-weight: bold; margin: 12px 0;">${summary.overallScore || 0}</div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1.1em;">
                        <span>${(summary.level && summary.level.icon) || '💡'}</span>
                        <span>${(summary.level && summary.level.name) || '待评估'}</span>
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.9; margin-top: 8px;">
                        优势领域: ${(summary.strengths || []).join('、') || '待挖掘'}
                    </div>
                </div>

                <!-- 四大技能域详细分析 -->
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #1976d2; margin-bottom: 16px;">🧠 技能域深度分析</h4>
                    <div style="display: grid; gap: 16px;">
                        ${Object.keys(domains).map(domain => {
                            const domainData = domains[domain];
                            if (!domainData) return '';
                            
                            return `
                                <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; border-left: 4px solid ${domainData.color || '#ccc'};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 1.2em;">${domainData.icon || '📊'}</span>
                                            <strong style="font-size: 1.1em;">${domainData.name || domain}</strong>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="background: ${domainData.color || '#ccc'}; color: white; padding: 4px 12px; border-radius: 16px; font-size: 0.9em; font-weight: bold;">
                                                ${domainData.overallScore || 0}分
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- 子技能分析 -->
                                    <div style="display: grid; gap: 12px;">
                                        ${Object.keys(domainData.categories || {}).map(category => {
                                            const catData = domainData.categories[category];
                                            if (!catData) return '';
                                            
                                            return `
                                                <div style="background: white; border-radius: 8px; padding: 12px;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                        <span style="font-weight: 500;">${catData.name || category}</span>
                                                        <div style="display: flex; align-items: center; gap: 6px;">
                                                            <span style="font-size: 0.9em;">${(catData.level && catData.level.icon) || '💡'}</span>
                                                            <span style="color: ${(catData.level && catData.level.color) || '#666'}; font-size: 0.8em; font-weight: 500;">${(catData.level && catData.level.name) || '待评估'}</span>
                                                            <span style="font-size: 0.9em; font-weight: bold;">${catData.score || 0}%</span>
                                                        </div>
                                                    </div>
                                                    <div style="background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden;">
                                                        <div style="background: ${domainData.color || '#ccc'}; height: 100%; width: ${catData.score || 0}%; border-radius: 3px; transition: width 0.5s ease;"></div>
                                                    </div>
                                                    ${(catData.matchedKeywords && catData.matchedKeywords.length > 0) ? `
                                                        <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                                                            相关技能: ${catData.matchedKeywords.slice(0, 3).join('、')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- 技能雷达图 -->
                <div style="background: #f3e5f5; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <h4 style="color: #7b1fa2; margin: 0 0 16px 0; text-align: center;">📡 技能雷达图</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; text-align: center;">
                        ${radar.map(item => `
                            <div style="background: white; border-radius: 8px; padding: 16px;">
                                <div style="font-size: 0.9em; font-weight: 500; margin-bottom: 8px;">${item.domain || '未知'}</div>
                                <div style="position: relative; width: 80px; height: 80px; margin: 0 auto; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <div style="position: absolute; width: ${Math.min(80, (item.score || 0) * 0.8)}px; height: ${Math.min(80, (item.score || 0) * 0.8)}px; background: ${item.color || '#ccc'}; border-radius: 50%; opacity: 0.7;"></div>
                                    <span style="position: relative; z-index: 1; font-weight: bold; color: #333;">${item.score || 0}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 发展行动计划 -->
                <div style="background: #e8f5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #2e7d32; margin: 0 0 16px 0;">🎯 个性化发展计划</h4>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #4caf50; margin: 0 0 12px 0;">🚀 优先发展领域</h5>
                        ${(development.actionPlan || []).map(plan => `
                            <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid #ff9800;">
                                <div style="font-weight: 500; margin-bottom: 8px;">
                                    ${plan.area || '未知领域'} - ${plan.focus || '待定'} 
                                    <span style="color: #ff9800; font-size: 0.8em;">(当前: ${plan.score || 0}分)</span>
                                </div>
                                <div style="font-size: 0.9em; color: #666;">
                                    推荐行动:
                                    <ul style="margin: 4px 0 0 16px; padding: 0;">
                                        ${(plan.actions || []).map(action => `<li>${action}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div>
                        <h5 style="color: #4caf50; margin: 0 0 12px 0;">💪 发挥优势领域</h5>
                        ${(development.strengthAreas || []).map(strength => `
                            <div style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 4px solid #4caf50;">
                                <div style="font-weight: 500; color: #2e7d32;">
                                    ${strength.name || '未知'} 
                                    <span style="font-size: 0.8em;">(${strength.score || 0}分)</span>
                                </div>
                                <div style="font-size: 0.8em; color: #666;">继续保持并考虑分享经验，成为该领域的专家</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 技能发展时间线 -->
                <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 12px; padding: 20px;">
                    <h4 style="color: #1565c0; margin: 0 0 16px 0;">⏰ 6个月技能发展路线图</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: white; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-weight: bold; color: #1976d2; margin-bottom: 8px;">前2个月</div>
                            <div style="font-size: 0.9em; color: #666;">
                                • 评估现状<br>
                                • 制定计划<br>
                                • 开始学习
                            </div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-weight: bold; color: #1976d2; margin-bottom: 8px;">中2个月</div>
                            <div style="font-size: 0.9em; color: #666;">
                                • 深入实践<br>
                                • 项目应用<br>
                                • 反馈调整
                            </div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-weight: bold; color: #1976d2; margin-bottom: 8px;">后2个月</div>
                            <div style="font-size: 0.9em; color: #666;">
                                • 巩固提升<br>
                                • 经验总结<br>
                                • 规划进阶
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 工作生活平衡分析功能
        function generateBalanceAnalysis() {
            console.log('🔥 开始生成工作生活平衡分析...');
            try {
                const halfyearKey = `${currentYear}-H${currentHalf}`;
                const currentData = StorageUtils.loadPlan('halfyear', halfyearKey) || {};
                console.log('⚖️ 平衡分析-加载的数据:', currentData);
                
                const balanceAnalysis = analyzeWorkLifeBalance(currentData);
                console.log('⚖️ 平衡分析结果:', balanceAnalysis);
                
                // 验证数据结构
                if (!balanceAnalysis || !balanceAnalysis.dimensions) {
                    throw new Error('平衡分析数据结构异常');
                }
                
                const balanceContent = generateBalanceAnalysisHTML(balanceAnalysis);
                console.log('🎨 生成的平衡分析HTML长度:', balanceContent.length);
                
                if (typeof ModalUtils !== 'undefined' && ModalUtils.show) {
                    ModalUtils.show('⚖️ 工作生活平衡分析', balanceContent, 'large');
                    console.log('✅ 成功显示工作生活平衡分析模态框');
                } else {
                    console.error('❌ ModalUtils未定义');
                    // 创建简单的提示框作为fallback
                    const fallbackModal = document.createElement('div');
                    fallbackModal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                        background: rgba(0,0,0,0.5); z-index: 9999; display: flex;
                        align-items: center; justify-content: center;
                    `;
                    fallbackModal.innerHTML = `
                        <div style="background: white; border-radius: 8px; padding: 20px; max-width: 80vw; max-height: 80vh; overflow: auto;">
                            <button onclick="this.closest('div').parentNode.remove()" style="float: right; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                            <div>${balanceContent}</div>
                        </div>
                    `;
                    document.body.appendChild(fallbackModal);
                }
            } catch (error) {
                console.error('❌ 工作生活平衡分析生成失败:', error);
                console.error('❌ 错误堆栈:', error.stack);
                alert('工作生活平衡分析出现错误: ' + error.message);
            }
        }

        function analyzeWorkLifeBalance(data) {
            console.log('🔍 开始分析工作生活平衡数据...');
            
            // 基础数据
            const balanceContent = data.balance || '';
            const allContent = `
                ${data.strategicGoals || ''} 
                ${data.quarter1Milestones || ''} 
                ${data.quarter2Milestones || ''} 
                ${data.projects || ''} 
                ${data.skills || ''}
                ${balanceContent}
            `.toLowerCase();

            // 平衡维度框架
            const balanceDimensions = {
                work: {
                    name: '工作发展',
                    icon: '💼',
                    color: '#1976d2',
                    keywords: ['工作', '职业', '项目', '任务', '效率', '成就', '目标', '业务', '职责', '会议', '加班', '截止日期'],
                    weight: 0.3
                },
                health: {
                    name: '健康管理',
                    icon: '🏃‍♂️',
                    color: '#4caf50',
                    keywords: ['健康', '运动', '锻炼', '饮食', '睡眠', '体检', '放松', '休息', '身体', '精神', '压力', '冥想'],
                    weight: 0.25
                },
                relationship: {
                    name: '人际关系',
                    icon: '👥',
                    color: '#ff9800',
                    keywords: ['家庭', '朋友', '社交', '人际', '关系', '沟通', '陪伴', '聚会', '交流', '伴侣', '父母', '孩子'],
                    weight: 0.25
                },
                personal: {
                    name: '个人成长',
                    icon: '🌱',
                    color: '#9c27b0',
                    keywords: ['兴趣', '爱好', '学习', '阅读', '旅行', '文化', '艺术', '音乐', '电影', '游戏', '创作', '思考'],
                    weight: 0.2
                }
            };

            // 分析各维度
            const dimensionAnalysis = {};
            let totalScore = 0;
            
            Object.keys(balanceDimensions).forEach(dimension => {
                const dimInfo = balanceDimensions[dimension];
                const mentions = dimInfo.keywords.filter(keyword => 
                    allContent.includes(keyword)
                ).length;
                
                const balanceMentions = dimInfo.keywords.filter(keyword => 
                    balanceContent.toLowerCase().includes(keyword)
                ).length;
                
                const attentionScore = Math.min(100, mentions * 8 + balanceMentions * 15);
                const level = getBalanceLevel(attentionScore);
                
                dimensionAnalysis[dimension] = {
                    ...dimInfo,
                    attentionScore: Math.round(attentionScore),
                    level: level,
                    matchedKeywords: dimInfo.keywords.filter(keyword => 
                        allContent.includes(keyword)
                    ),
                    balanceActions: extractBalanceActions(balanceContent, dimInfo.keywords),
                    suggestions: generateBalanceRecommendations(dimension, attentionScore)
                };
                
                totalScore += attentionScore * dimInfo.weight;
            });

            // 计算平衡指数
            const balanceIndex = Math.round(totalScore);
            const balanceLevel = getBalanceLevel(balanceIndex);
            
            // 分析平衡状态
            const balanceStatus = analyzeBalanceStatus(dimensionAnalysis);
            
            // 生成改善计划
            const improvementPlan = generateBalanceImprovementPlan(dimensionAnalysis);

            return {
                dimensions: dimensionAnalysis,
                overall: {
                    balanceIndex: balanceIndex,
                    level: balanceLevel,
                    status: balanceStatus
                },
                improvements: improvementPlan,
                insights: generateBalanceInsights(dimensionAnalysis, balanceIndex)
            };
        }

        function getBalanceLevel(score) {
            if (score >= 80) return { name: '优秀平衡', icon: '🌟', color: '#4caf50', description: '各方面发展均衡，状态良好' };
            if (score >= 60) return { name: '良好平衡', icon: '👍', color: '#8bc34a', description: '整体平衡较好，有提升空间' };
            if (score >= 40) return { name: '需要调整', icon: '⚠️', color: '#ff9800', description: '存在失衡风险，需要关注' };
            if (score >= 20) return { name: '明显失衡', icon: '🚨', color: '#f44336', description: '平衡状况较差，需要改善' };
            return { name: '严重失衡', icon: '💔', color: '#d32f2f', description: '急需调整生活方式' };
        }

        function extractBalanceActions(balanceContent, keywords) {
            const lines = balanceContent.split('\n');
            return lines.filter(line => {
                const lineLower = line.toLowerCase();
                return keywords.some(keyword => lineLower.includes(keyword)) && 
                       (line.includes('[ ]') || line.includes('[x]') || line.includes('[X]'));
            }).slice(0, 3); // 最多3个相关行动
        }

        function generateBalanceRecommendations(dimension, score) {
            const recommendations = {
                work: {
                    high: ['保持工作热情，寻求新的挑战', '分享经验，指导他人', '考虑职业发展规划'],
                    medium: ['设定清晰的工作目标', '提高工作效率和技能', '建立良好的工作习惯'],
                    low: ['重新审视工作优先级', '寻求工作中的成就感', '考虑职业转换或调整']
                },
                health: {
                    high: ['保持良好的健康习惯', '尝试新的运动项目', '关注心理健康'],
                    medium: ['建立规律的运动计划', '改善饮食和睡眠习惯', '定期体检'],
                    low: ['立即开始运动计划', '调整作息时间', '寻求专业健康指导']
                },
                relationship: {
                    high: ['维护现有良好关系', '扩展社交圈子', '帮助他人建立关系'],
                    medium: ['主动联系朋友家人', '参加社交活动', '提高沟通技巧'],
                    low: ['重建重要关系', '学习社交技能', '寻求关系咨询']
                },
                personal: {
                    high: ['探索新的兴趣领域', '深化现有爱好', '分享个人成长经验'],
                    medium: ['培养新的兴趣爱好', '安排个人时间', '追求个人目标'],
                    low: ['找回个人兴趣', '为自己安排时间', '重新发现自我价值']
                }
            };

            const category = score >= 60 ? 'high' : score >= 30 ? 'medium' : 'low';
            return recommendations[dimension]?.[category] || ['需要更多关注这个领域'];
        }

        function analyzeBalanceStatus(dimensionAnalysis) {
            const scores = Object.values(dimensionAnalysis).map(d => d.attentionScore);
            const maxScore = Math.max(...scores);
            const minScore = Math.min(...scores);
            const variance = maxScore - minScore;
            
            if (variance <= 20) {
                return { type: 'balanced', message: '各维度发展相对均衡' };
            } else if (variance <= 40) {
                return { type: 'moderate_imbalance', message: '存在轻度失衡，需要适当调整' };
            } else {
                return { type: 'significant_imbalance', message: '存在明显失衡，建议重点关注薄弱环节' };
            }
        }

        function generateBalanceImprovementPlan(dimensionAnalysis) {
            const sortedDimensions = Object.entries(dimensionAnalysis)
                .map(([key, data]) => ({ key, ...data }))
                .sort((a, b) => a.attentionScore - b.attentionScore);

            const weakestDimensions = sortedDimensions.slice(0, 2);
            const strongestDimensions = sortedDimensions.slice(-2);

            return {
                focus_areas: weakestDimensions.map(dim => ({
                    dimension: dim.name,
                    icon: dim.icon,
                    score: dim.attentionScore,
                    actions: dim.suggestions.slice(0, 2)
                })),
                maintain_areas: strongestDimensions.map(dim => ({
                    dimension: dim.name,
                    icon: dim.icon,
                    score: dim.attentionScore,
                    advice: '继续保持，并可以考虑帮助他人或深入发展'
                }))
            };
        }

        function generateBalanceInsights(dimensionAnalysis, balanceIndex) {
            const insights = [];
            
            // 整体洞察
            if (balanceIndex >= 70) {
                insights.push('🎉 您的工作生活平衡状况整体良好，继续保持这种状态！');
            } else if (balanceIndex >= 50) {
                insights.push('👍 您的平衡状况处于中等水平，有进一步优化的空间。');
            } else {
                insights.push('⚠️ 您的工作生活平衡需要重点关注和改善。');
            }
            
            // 维度特定洞察
            const workScore = dimensionAnalysis.work?.attentionScore || 0;
            const healthScore = dimensionAnalysis.health?.attentionScore || 0;
            
            if (workScore > healthScore + 30) {
                insights.push('💼 您可能过度专注于工作，建议增加健康管理的投入。');
            }
            
            if (healthScore < 30) {
                insights.push('🏃‍♂️ 健康是一切的基础，建议优先改善健康相关习惯。');
            }
            
            const personalScore = dimensionAnalysis.personal?.attentionScore || 0;
            if (personalScore < 25) {
                insights.push('🌱 不要忘记为自己的兴趣和成长留出时间。');
            }
            
            return insights;
        }

        function generateBalanceAnalysisHTML(analysis) {
            // 安全性检查
            if (!analysis || typeof analysis !== 'object') {
                console.error('❌ 分析数据无效:', analysis);
                return '<div style="text-align: center; padding: 40px;"><h3 style="color: #f44336;">数据分析异常</h3><p>请重新尝试分析</p></div>';
            }

            const { dimensions, overall, improvements, insights } = analysis;
            
            // 确保必要的数据存在
            if (!dimensions || typeof dimensions !== 'object') {
                console.error('❌ 维度数据无效:', dimensions);
                return '<div style="text-align: center; padding: 40px;"><h3 style="color: #f44336;">维度数据异常</h3><p>请确保您的计划包含足够的内容</p></div>';
            }

            return `
                <div style="margin-bottom: 24px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">⚖️</div>
                        <h3 style="color: #795548; margin: 0;">工作生活平衡分析</h3>
                        <p style="color: #666; margin: 8px 0 0 0;">基于您的计划内容进行的全方位平衡分析</p>
                    </div>
                </div>

                <!-- 整体平衡指数 -->
                <div style="background: linear-gradient(135deg, #795548, #8d6e63); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white; text-align: center;">
                    <h4 style="margin: 0 0 12px 0; font-size: 1.2em;">⚖️ 平衡指数</h4>
                    <div style="font-size: 3em; font-weight: bold; margin: 12px 0;">${overall.balanceIndex}</div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1.1em;">
                        <span>${overall.level.icon}</span>
                        <span>${overall.level.name}</span>
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.9; margin-top: 8px;">
                        ${overall.level.description}
                    </div>
                    <div style="font-size: 0.8em; opacity: 0.8; margin-top: 8px;">
                        ${overall.status.message}
                    </div>
                </div>

                <!-- 四维度详细分析 -->
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #795548; margin-bottom: 16px;">📊 四维度深度分析</h4>
                    <div style="display: grid; gap: 16px;">
                        ${Object.keys(dimensions).map(key => {
                            const dimension = dimensions[key];
                            return `
                                <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; border-left: 4px solid ${dimension.color};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 1.2em;">${dimension.icon}</span>
                                            <strong style="font-size: 1.1em;">${dimension.name}</strong>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="background: ${dimension.color}; color: white; padding: 4px 12px; border-radius: 16px; font-size: 0.9em; font-weight: bold;">
                                                ${dimension.attentionScore}分
                                            </span>
                                            <span style="font-size: 0.9em;">${dimension.level.icon}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- 进度条 -->
                                    <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
                                        <div style="background: ${dimension.color}; height: 100%; width: ${dimension.attentionScore}%; border-radius: 4px; transition: width 0.5s ease;"></div>
                                    </div>
                                    
                                    <!-- 关键词匹配 -->
                                    ${dimension.matchedKeywords.length > 0 ? `
                                        <div style="margin-bottom: 12px;">
                                            <div style="font-size: 0.9em; color: #666; margin-bottom: 6px;">发现的关键活动:</div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                ${dimension.matchedKeywords.slice(0, 6).map(keyword => `
                                                    <span style="background: ${dimension.color}20; color: ${dimension.color}; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${keyword}</span>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <!-- 相关行动 -->
                                    ${dimension.balanceActions.length > 0 ? `
                                        <div style="margin-bottom: 12px;">
                                            <div style="font-size: 0.9em; color: #666; margin-bottom: 6px;">相关计划行动:</div>
                                            ${dimension.balanceActions.map(action => `
                                                <div style="font-size: 0.8em; padding: 4px 8px; background: white; border-radius: 4px; margin-bottom: 2px;">
                                                    ${action}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    <!-- 改善建议 -->
                                    <div>
                                        <div style="font-size: 0.9em; color: #666; margin-bottom: 6px;">改善建议:</div>
                                        <ul style="margin: 0; padding-left: 16px; font-size: 0.9em;">
                                            ${dimension.suggestions.map(suggestion => `<li style="margin-bottom: 4px;">${suggestion}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- 平衡雷达图 -->
                <div style="background: #f3e5f5; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <h4 style="color: #7b1fa2; margin: 0 0 16px 0; text-align: center;">📡 平衡雷达图</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; text-align: center;">
                        ${Object.values(dimensions).map(dimension => `
                            <div style="background: white; border-radius: 8px; padding: 16px;">
                                <div style="font-size: 0.9em; font-weight: 500; margin-bottom: 8px;">${dimension.icon} ${dimension.name}</div>
                                <div style="position: relative; width: 80px; height: 80px; margin: 0 auto; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <div style="position: absolute; width: ${Math.min(80, dimension.attentionScore * 0.8)}px; height: ${Math.min(80, dimension.attentionScore * 0.8)}px; background: ${dimension.color}; border-radius: 50%; opacity: 0.7;"></div>
                                    <span style="position: relative; z-index: 1; font-weight: bold; color: #333;">${dimension.attentionScore}</span>
                                </div>
                                <div style="font-size: 0.8em; color: ${dimension.level.color}; margin-top: 8px;">${dimension.level.name}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 核心洞察 -->
                <div style="background: #e3f2fd; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <h4 style="color: #1565c0; margin: 0 0 16px 0;">💡 核心洞察</h4>
                    ${insights.map(insight => `
                        <div style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 4px solid #2196f3;">
                            <div style="font-size: 0.9em;">${insight}</div>
                        </div>
                    `).join('')}
                </div>

                <!-- 改善行动计划 -->
                <div style="background: #e8f5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #2e7d32; margin: 0 0 16px 0;">🎯 改善行动计划</h4>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #4caf50; margin: 0 0 12px 0;">🚀 重点关注领域</h5>
                        ${improvements.focus_areas.map(area => `
                            <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid #ff9800;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span>${area.icon}</span>
                                    <strong>${area.dimension}</strong>
                                    <span style="color: #ff9800; font-size: 0.8em;">(当前: ${area.score}分)</span>
                                </div>
                                <div style="font-size: 0.9em; color: #666;">
                                    推荐行动:
                                    <ul style="margin: 4px 0 0 16px; padding: 0;">
                                        ${area.actions.map(action => `<li>${action}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div>
                        <h5 style="color: #4caf50; margin: 0 0 12px 0;">💪 保持优势领域</h5>
                        ${improvements.maintain_areas.map(area => `
                            <div style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 4px solid #4caf50;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span>${area.icon}</span>
                                    <strong style="color: #2e7d32;">${area.dimension}</strong>
                                    <span style="font-size: 0.8em;">(${area.score}分)</span>
                                </div>
                                <div style="font-size: 0.8em; color: #666;">${area.advice}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 平衡改善时间线 -->
                <div style="background: linear-gradient(135deg, #fce4ec, #f8bbd9); border-radius: 12px; padding: 20px;">
                    <h4 style="color: #c2185b; margin: 0 0 16px 0;">⏰ 平衡改善时间线</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div style="background: white; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-weight: bold; color: #e91e63; margin-bottom: 8px;">第1-2周</div>
                            <div style="font-size: 0.9em; color: #666;">
                                • 识别关键问题<br>
                                • 设定改善目标<br>
                                • 建立新习惯
                            </div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-weight: bold; color: #e91e63; margin-bottom: 8px;">第3-6周</div>
                            <div style="font-size: 0.9em; color: #666;">
                                • 坚持新习惯<br>
                                • 调整和优化<br>
                                • 监控进展
                            </div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-weight: bold; color: #e91e63; margin-bottom: 8px;">第7周以后</div>
                            <div style="font-size: 0.9em; color: #666;">
                                • 巩固成果<br>
                                • 持续改善<br>
                                • 分享经验
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 平衡改善建议功能
        function generateBalanceSuggestions() {
            console.log('💡 开始生成平衡改善建议...');
            try {
                const halfyearKey = `${currentYear}-H${currentHalf}`;
                const currentData = StorageUtils.loadPlan('halfyear', halfyearKey) || {};
                
                const balanceAnalysis = analyzeWorkLifeBalance(currentData);
                const suggestions = generateDetailedBalanceSuggestions(balanceAnalysis);
                
                const suggestionsContent = generateBalanceSuggestionsHTML(suggestions);
                
                if (typeof ModalUtils !== 'undefined' && ModalUtils.show) {
                    ModalUtils.show('💡 工作生活平衡改善建议', suggestionsContent, 'large');
                    console.log('✅ 成功显示平衡改善建议模态框');
                } else {
                    // 创建简单的提示框作为fallback
                    const fallbackModal = document.createElement('div');
                    fallbackModal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                        background: rgba(0,0,0,0.5); z-index: 9999; display: flex;
                        align-items: center; justify-content: center;
                    `;
                    fallbackModal.innerHTML = `
                        <div style="background: white; border-radius: 8px; padding: 20px; max-width: 80vw; max-height: 80vh; overflow: auto;">
                            <button onclick="this.closest('div').parentNode.remove()" style="float: right; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                            <div>${suggestionsContent}</div>
                        </div>
                    `;
                    document.body.appendChild(fallbackModal);
                }
            } catch (error) {
                console.error('❌ 平衡改善建议生成失败:', error);
                alert('平衡改善建议生成出现错误: ' + error.message);
            }
        }

        function generateDetailedBalanceSuggestions(analysis) {
            const { dimensions, overall } = analysis;
            
            // 基于整体平衡指数生成建议
            const generalSuggestions = [];
            if (overall.balanceIndex < 40) {
                generalSuggestions.push({
                    priority: 'high',
                    title: '立即行动：重新规划生活节奏',
                    description: '您的平衡状况需要重点关注，建议立即开始调整',
                    actions: [
                        '暂停一些非必要的活动，为重要维度腾出时间',
                        '制定明确的时间分配计划，确保各维度都有投入',
                        '寻求支持系统，包括家人朋友或专业指导'
                    ]
                });
            } else if (overall.balanceIndex < 70) {
                generalSuggestions.push({
                    priority: 'medium',
                    title: '优化调整：提升平衡质量',
                    description: '您的基础还不错，通过优化可以达到更好的平衡',
                    actions: [
                        '识别并强化薄弱环节',
                        '建立更好的时间管理习惯',
                        '定期评估和调整各维度的投入'
                    ]
                });
            }

            // 基于各维度生成具体建议
            const dimensionSuggestions = Object.entries(dimensions).map(([key, dimension]) => {
                let category, urgency;
                if (dimension.attentionScore < 30) {
                    category = 'urgent';
                    urgency = '紧急';
                } else if (dimension.attentionScore < 60) {
                    category = 'improve';
                    urgency = '改善';
                } else {
                    category = 'maintain';
                    urgency = '保持';
                }

                return {
                    dimension: dimension.name,
                    icon: dimension.icon,
                    color: dimension.color,
                    score: dimension.attentionScore,
                    category: category,
                    urgency: urgency,
                    suggestions: dimension.suggestions,
                    quickActions: generateQuickActions(key, dimension.attentionScore)
                };
            });

            return {
                general: generalSuggestions,
                dimensions: dimensionSuggestions,
                weeklyPlan: generateWeeklyBalancePlan(dimensionSuggestions),
                habits: generateBalanceHabits(dimensionSuggestions)
            };
        }

        function generateQuickActions(dimension, score) {
            const quickActions = {
                work: score < 40 ? [
                    '每天设定3个最重要的工作目标',
                    '使用番茄工作法提高专注度',
                    '每周安排1次技能学习时间'
                ] : [
                    '寻找工作中的新挑战',
                    '与同事分享经验和知识',
                    '考虑承担更多责任'
                ],
                health: score < 40 ? [
                    '每天步行至少30分钟',
                    '设定固定的睡眠时间',
                    '准备健康的零食和饮品'
                ] : [
                    '尝试新的运动项目',
                    '定期进行身体检查',
                    '关注心理健康和压力管理'
                ],
                relationship: score < 40 ? [
                    '每周主动联系1-2位朋友或家人',
                    '安排固定的家庭时间',
                    '学习积极倾听技巧'
                ] : [
                    '组织朋友聚会或活动',
                    '帮助他人建立社交关系',
                    '在关系中承担更多责任'
                ],
                personal: score < 40 ? [
                    '每天安排30分钟的个人时间',
                    '重新发现一个曾经的兴趣',
                    '开始写日记或反思'
                ] : [
                    '挑战自己学习新技能',
                    '参与创作或艺术活动',
                    '分享个人成长经验'
                ]
            };

            return quickActions[dimension] || ['关注这个领域的发展'];
        }

        function generateWeeklyBalancePlan(dimensionSuggestions) {
            const urgentDimensions = dimensionSuggestions.filter(d => d.category === 'urgent');
            const improveDimensions = dimensionSuggestions.filter(d => d.category === 'improve');
            
            return {
                monday: urgentDimensions.length > 0 ? `关注${urgentDimensions[0].dimension}` : '整体规划',
                tuesday: '工作效率提升',
                wednesday: '健康管理检查',
                thursday: '人际关系维护',
                friday: '工作总结与计划',
                weekend: '个人时间与放松'
            };
        }

        function generateBalanceHabits(dimensionSuggestions) {
            return [
                { habit: '晨间规划', description: '每天早上花5分钟规划当天各维度的活动', frequency: '每日' },
                { habit: '平衡检查', description: '每周回顾各维度的投入情况', frequency: '每周' },
                { habit: '边界设定', description: '为工作和生活设定明确的时间边界', frequency: '持续' },
                { habit: '感恩记录', description: '记录各维度中值得感恩的事情', frequency: '每日' }
            ];
        }

        function generateBalanceSuggestionsHTML(suggestions) {
            return `
                <div style="margin-bottom: 24px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">💡</div>
                        <h3 style="color: #7b1fa2; margin: 0;">工作生活平衡改善建议</h3>
                        <p style="color: #666; margin: 8px 0 0 0;">个性化的平衡改善方案和行动指南</p>
                    </div>
                </div>

                <!-- 整体建议 -->
                ${suggestions.general.map(suggestion => `
                    <div style="background: ${suggestion.priority === 'high' ? '#ffebee' : '#f3e5f5'}; border-radius: 12px; padding: 20px; margin-bottom: 24px; border-left: 4px solid ${suggestion.priority === 'high' ? '#f44336' : '#9c27b0'};">
                        <h4 style="color: ${suggestion.priority === 'high' ? '#d32f2f' : '#7b1fa2'}; margin: 0 0 12px 0;">${suggestion.title}</h4>
                        <p style="color: #666; margin-bottom: 12px;">${suggestion.description}</p>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${suggestion.actions.map(action => `<li style="margin-bottom: 6px;">${action}</li>`).join('')}
                        </ul>
                    </div>
                `).join('')}

                <!-- 维度建议 -->
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #7b1fa2; margin-bottom: 16px;">🎯 分维度改善建议</h4>
                    <div style="display: grid; gap: 16px;">
                        ${suggestions.dimensions.map(dimension => `
                            <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; border-left: 4px solid ${dimension.color};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 1.2em;">${dimension.icon}</span>
                                        <strong style="font-size: 1.1em;">${dimension.dimension}</strong>
                                        <span style="background: ${dimension.color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${dimension.urgency}</span>
                                    </div>
                                    <span style="font-size: 0.9em; color: #666;">${dimension.score}分</span>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <h5 style="color: ${dimension.color}; margin: 0 0 8px 0;">💫 快速行动</h5>
                                    <ul style="margin: 0; padding-left: 16px; font-size: 0.9em;">
                                        ${dimension.quickActions.map(action => `<li style="margin-bottom: 4px;">${action}</li>`).join('')}
                                    </ul>
                                </div>
                                
                                <div>
                                    <h5 style="color: ${dimension.color}; margin: 0 0 8px 0;">🎯 长期建议</h5>
                                    <ul style="margin: 0; padding-left: 16px; font-size: 0.9em;">
                                        ${dimension.suggestions.slice(0, 2).map(suggestion => `<li style="margin-bottom: 4px;">${suggestion}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 每周平衡计划 -->
                <div style="background: #e8f5e9; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <h4 style="color: #2e7d32; margin: 0 0 16px 0;">📅 每周平衡计划</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                        ${Object.entries(suggestions.weeklyPlan).map(([day, focus]) => {
                            const dayNames = {
                                monday: '周一',
                                tuesday: '周二', 
                                wednesday: '周三',
                                thursday: '周四',
                                friday: '周五',
                                weekend: '周末'
                            };
                            return `
                                <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                                    <div style="font-weight: bold; color: #4caf50; margin-bottom: 6px;">${dayNames[day]}</div>
                                    <div style="font-size: 0.8em; color: #666;">${focus}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- 平衡习惯养成 -->
                <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); border-radius: 12px; padding: 20px;">
                    <h4 style="color: #ef6c00; margin: 0 0 16px 0;">🔄 平衡习惯养成</h4>
                    <div style="display: grid; gap: 12px;">
                        ${suggestions.habits.map(habit => `
                            <div style="background: white; border-radius: 8px; padding: 16px; border-left: 4px solid #ff9800;">
                                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                                    <strong style="color: #f57c00;">${habit.habit}</strong>
                                    <span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: auto;">${habit.frequency}</span>
                                </div>
                                <div style="font-size: 0.9em; color: #666;">${habit.description}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 学习路径功能
        function generateLearningPath() {
            console.log('🔥 开始生成学习路径...');
            try {
                const halfyearKey = `${currentYear}-H${currentHalf}`;
                const currentData = StorageUtils.loadPlan('halfyear', halfyearKey) || {};
                console.log('📊 学习路径-加载的数据:', currentData);
                
                const learningAnalysis = analyzeLearningNeeds(currentData);
                const pathContent = generateLearningPathHTML(learningAnalysis);
                
                if (typeof ModalUtils !== 'undefined' && ModalUtils.show) {
                    ModalUtils.show('🌲 个性化学习路径', pathContent, 'large');
                    console.log('✅ 成功显示学习路径模态框');
                } else {
                    console.error('❌ ModalUtils未定义');
                    alert('学习路径功能正在开发中...');
                }
            } catch (error) {
                console.error('❌ 学习路径生成失败:', error);
                alert('学习路径出现错误: ' + error.message);
            }
        }

        function analyzeLearningNeeds(data) {
            // 分析学习需求和目标
            const allContent = `
                ${data.strategicGoals || ''} 
                ${data.quarter1Milestones || ''} 
                ${data.quarter2Milestones || ''} 
                ${data.projects || ''} 
                ${data.skills || ''}
            `;

            // 学习路径框架
            const learningFramework = {
                technical_skills: {
                    name: '技术技能路径',
                    icon: '💻',
                    color: '#1976d2',
                    priority: calculateLearningPriority(allContent, ['技术', '编程', '开发', '工具', '软件']),
                    tracks: {
                        programming: {
                            name: '编程开发',
                            description: '掌握编程语言和开发技能',
                            levels: [
                                { name: '基础入门', duration: '2-4周', skills: ['编程基础', '语法理解', '基本调试'] },
                                { name: '实践应用', duration: '4-6周', skills: ['项目开发', '代码优化', '团队协作'] },
                                { name: '高级精通', duration: '8-12周', skills: ['架构设计', '性能优化', '技术选型'] }
                            ]
                        },
                        tools: {
                            name: '工具使用',
                            description: '掌握开发和办公工具',
                            levels: [
                                { name: '基础工具', duration: '1-2周', skills: ['基本操作', '常用功能', '快捷键'] },
                                { name: '进阶功能', duration: '2-3周', skills: ['高级功能', '自定义配置', '插件使用'] },
                                { name: '专家级', duration: '4-6周', skills: ['自动化', '脚本编写', '工作流优化'] }
                            ]
                        }
                    }
                },
                soft_skills: {
                    name: '软技能路径',
                    icon: '🤝',
                    color: '#ff9800',
                    priority: calculateLearningPriority(allContent, ['沟通', '领导', '管理', '团队', '协作']),
                    tracks: {
                        communication: {
                            name: '沟通表达',
                            description: '提升沟通和表达能力',
                            levels: [
                                { name: '基础沟通', duration: '2-3周', skills: ['倾听技巧', '清晰表达', '非语言沟通'] },
                                { name: '进阶表达', duration: '3-4周', skills: ['演讲技巧', '会议主持', '汇报技能'] },
                                { name: '影响力沟通', duration: '6-8周', skills: ['说服技巧', '冲突解决', '跨文化沟通'] }
                            ]
                        },
                        leadership: {
                            name: '领导管理',
                            description: '培养领导力和管理能力',
                            levels: [
                                { name: '自我管理', duration: '3-4周', skills: ['时间管理', '目标设定', '自我激励'] },
                                { name: '团队领导', duration: '4-6周', skills: ['团队建设', '任务分配', '激励团队'] },
                                { name: '战略领导', duration: '8-10周', skills: ['战略思维', '变革管理', '组织发展'] }
                            ]
                        }
                    }
                },
                business_skills: {
                    name: '商业技能路径',
                    icon: '📈',
                    color: '#4caf50',
                    priority: calculateLearningPriority(allContent, ['商业', '市场', '分析', '项目', '策略']),
                    tracks: {
                        analysis: {
                            name: '商业分析',
                            description: '培养商业分析和决策能力',
                            levels: [
                                { name: '数据基础', duration: '2-3周', skills: ['数据收集', '基础分析', '图表制作'] },
                                { name: '深度分析', duration: '4-5周', skills: ['趋势分析', '对比分析', '预测模型'] },
                                { name: '战略分析', duration: '6-8周', skills: ['市场分析', '竞争分析', '商业模式'] }
                            ]
                        },
                        project_management: {
                            name: '项目管理',
                            description: '掌握项目管理方法和工具',
                            levels: [
                                { name: '基础管理', duration: '2-3周', skills: ['项目规划', '任务分解', '进度跟踪'] },
                                { name: '进阶管理', duration: '3-5周', skills: ['风险管理', '资源优化', '质量控制'] },
                                { name: '高级管理', duration: '6-8周', skills: ['敏捷管理', '团队协调', '干系人管理'] }
                            ]
                        }
                    }
                },
                personal_development: {
                    name: '个人发展路径',
                    icon: '🌱',
                    color: '#9c27b0',
                    priority: calculateLearningPriority(allContent, ['学习', '成长', '思维', '创新', '效率']),
                    tracks: {
                        learning_ability: {
                            name: '学习能力',
                            description: '提升学习效率和方法',
                            levels: [
                                { name: '学习方法', duration: '1-2周', skills: ['学习计划', '笔记方法', '记忆技巧'] },
                                { name: '深度学习', duration: '2-4周', skills: ['批判思维', '系统思考', '知识连接'] },
                                { name: '终身学习', duration: '持续', skills: ['学习社区', '知识管理', '教学相长'] }
                            ]
                        },
                        innovation: {
                            name: '创新思维',
                            description: '培养创新和创意能力',
                            levels: [
                                { name: '创意思维', duration: '2-3周', skills: ['头脑风暴', '创意方法', '问题重构'] },
                                { name: '创新实践', duration: '4-5周', skills: ['原型设计', '快速迭代', '用户反馈'] },
                                { name: '创新管理', duration: '6-8周', skills: ['创新流程', '团队创新', '创新文化'] }
                            ]
                        }
                    }
                }
            };

            // 生成个性化学习路径
            const personalizedPath = generatePersonalizedPath(learningFramework, allContent);
            
            // 创建学习时间线
            const timeline = generateLearningTimeline(personalizedPath);
            
            // 推荐学习资源
            const resources = generateLearningResources(personalizedPath);

            return {
                framework: learningFramework,
                personalizedPath,
                timeline,
                resources,
                recommendations: generateLearningRecommendations(allContent)
            };
        }

        function calculateLearningPriority(content, keywords) {
            const matches = keywords.filter(keyword => 
                content.toLowerCase().includes(keyword)
            ).length;
            return Math.min(100, matches * 20 + Math.random() * 10);
        }

        function generatePersonalizedPath(framework, content) {
            // 根据内容分析，为每个领域分配优先级
            const prioritizedDomains = Object.keys(framework)
                .map(domain => ({
                    domain,
                    ...framework[domain],
                    priority: Math.round(framework[domain].priority)
                }))
                .sort((a, b) => b.priority - a.priority);

            // 选择前3个优先领域
            const selectedDomains = prioritizedDomains.slice(0, 3);
            
            // 为每个选中的领域生成详细路径
            return selectedDomains.map(domain => {
                const tracks = Object.keys(domain.tracks).map(trackKey => ({
                    key: trackKey,
                    ...domain.tracks[trackKey],
                    estimatedTime: domain.tracks[trackKey].levels.reduce((total, level) => {
                        const weeks = parseInt(level.duration.split('-')[1] || level.duration.split('-')[0]);
                        return total + weeks;
                    }, 0)
                }));

                return {
                    domain: domain.domain,
                    name: domain.name,
                    icon: domain.icon,
                    color: domain.color,
                    priority: domain.priority,
                    tracks,
                    recommendedTrack: tracks[0] // 推荐第一个轨道
                };
            });
        }

        function generateLearningTimeline(personalizedPath) {
            const timeline = [];
            let currentWeek = 1;

            personalizedPath.forEach(domain => {
                domain.tracks.forEach(track => {
                    track.levels.forEach((level, index) => {
                        const duration = parseInt(level.duration.split('-')[1] || level.duration.split('-')[0]);
                        timeline.push({
                            week: currentWeek,
                            duration,
                            domain: domain.name,
                            track: track.name,
                            level: level.name,
                            skills: level.skills,
                            color: domain.color,
                            phase: index === 0 ? '入门' : index === 1 ? '进阶' : '精通'
                        });
                        currentWeek += duration;
                    });
                });
            });

            return timeline.slice(0, 24); // 限制在24周内
        }

        function generateLearningResources(personalizedPath) {
            const resourceTypes = {
                books: '📚 推荐书籍',
                courses: '🎓 在线课程',
                practice: '💻 实践项目',
                community: '👥 学习社区'
            };

            const resources = {};

            personalizedPath.forEach(domain => {
                resources[domain.domain] = {
                    name: domain.name,
                    color: domain.color,
                    items: {
                        books: generateResourceList('books', domain.domain),
                        courses: generateResourceList('courses', domain.domain),
                        practice: generateResourceList('practice', domain.domain),
                        community: generateResourceList('community', domain.domain)
                    }
                };
            });

            return resources;
        }

        function generateResourceList(type, domain) {
            const resourceDatabase = {
                books: {
                    technical_skills: ['《代码大全》', '《设计模式》', '《重构》'],
                    soft_skills: ['《关键对话》', '《影响力》', '《高效能人士的七个习惯》'],
                    business_skills: ['《从0到1》', '《精益创业》', '《商业模式新生代》'],
                    personal_development: ['《刻意练习》', '《思考，快与慢》', '《原则》']
                },
                courses: {
                    technical_skills: ['Coursera编程课程', 'Udemy开发实战', 'edX计算机科学'],
                    soft_skills: ['领导力训练营', 'Toastmasters演讲', 'MindTools管理课程'],
                    business_skills: ['商业分析认证', 'PMP项目管理', 'MBA核心课程'],
                    personal_development: ['学习如何学习', '批判性思维', '创新方法论']
                },
                practice: {
                    technical_skills: ['GitHub开源项目', '个人项目作品集', '技术博客写作'],
                    soft_skills: ['团队协作项目', '演讲比赛参与', '导师指导实践'],
                    business_skills: ['商业案例分析', '创业项目体验', '数据分析实战'],
                    personal_development: ['个人品牌建设', '知识分享', '跨界学习挑战']
                },
                community: {
                    technical_skills: ['Stack Overflow', '技术论坛', '开发者社群'],
                    soft_skills: ['专业协会', '读书会', '职场导师网络'],
                    business_skills: ['商业俱乐部', '创业社区', '行业协会'],
                    personal_development: ['学习小组', '成长社区', '知识分享平台']
                }
            };

            return resourceDatabase[type][domain] || ['待补充资源'];
        }

        function generateLearningRecommendations(content) {
            const recommendations = [
                {
                    title: '制定明确的学习目标',
                    description: '基于您的计划内容，建议设定SMART学习目标',
                    priority: 'high',
                    timeframe: '第1周'
                },
                {
                    title: '建立学习节奏',
                    description: '建议每周固定2-3次学习时间，每次1-2小时',
                    priority: 'high',
                    timeframe: '持续执行'
                },
                {
                    title: '寻找学习伙伴',
                    description: '找到志同道合的学习伙伴，互相监督和交流',
                    priority: 'medium',
                    timeframe: '第2-3周'
                },
                {
                    title: '实践应用学习',
                    description: '将学到的知识立即应用到实际工作或项目中',
                    priority: 'high',
                    timeframe: '学习过程中'
                },
                {
                    title: '定期反思总结',
                    description: '每月总结学习成果，调整学习策略',
                    priority: 'medium',
                    timeframe: '每月底'
                }
            ];

            return recommendations;
        }

        function generateLearningPathHTML(analysis) {
            return `
                <div style="margin-bottom: 24px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">🌲</div>
                        <h3 style="color: #388e3c; margin: 0;">个性化学习路径</h3>
                        <p style="color: #666; margin: 8px 0 0 0;">基于您的目标和计划定制的专属学习路径</p>
                    </div>
                </div>

                <!-- 学习路径概览 -->
                <div style="background: linear-gradient(135deg, #388e3c, #66bb6a); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white;">
                    <h4 style="margin: 0 0 16px 0; font-size: 1.2em; text-align: center;">🎯 推荐学习路径</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        ${(analysis.personalizedPath || []).map((domain, index) => `
                            <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 2em; margin-bottom: 8px;">${domain.icon}</div>
                                <div style="font-weight: bold; margin-bottom: 4px;">${domain.name}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">优先级: ${domain.priority}%</div>
                                <div style="background: rgba(255,255,255,0.3); border-radius: 8px; padding: 4px 8px; margin-top: 8px; font-size: 0.8em;">
                                    推荐: ${domain.recommendedTrack.name}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 详细学习轨道 -->
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #388e3c; margin-bottom: 16px;">📚 详细学习轨道</h4>
                    ${(analysis.personalizedPath || []).map(domain => `
                        <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 16px; border-left: 4px solid ${domain.color};">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <span style="font-size: 1.5em;">${domain.icon}</span>
                                <div>
                                    <h5 style="margin: 0; color: ${domain.color};">${domain.name}</h5>
                                    <div style="font-size: 0.9em; color: #666;">优先级: ${domain.priority}% | 预计时间: ${(domain.tracks || []).reduce((total, track) => total + track.estimatedTime, 0)}周</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; gap: 16px;">
                                ${(domain.tracks || []).map(track => `
                                    <div style="background: white; border-radius: 8px; padding: 16px;">
                                        <h6 style="margin: 0 0 8px 0; color: #333;">${track.name}</h6>
                                        <p style="font-size: 0.9em; color: #666; margin: 0 0 12px 0;">${track.description}</p>
                                        
                                        <div style="display: grid; gap: 8px;">
                                            ${(track.levels || []).map((level, index) => `
                                                <div style="display: flex; align-items: center; gap: 12px; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                                                    <div style="background: ${domain.color}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold;">
                                                        ${index + 1}
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 500; font-size: 0.9em;">${level.name}</div>
                                                        <div style="font-size: 0.8em; color: #666;">
                                                            ${level.duration} | ${(level.skills || []).join('、')}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- 学习时间线 -->
                <div style="background: #e3f2fd; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <h4 style="color: #1976d2; margin: 0 0 16px 0;">⏰ 6个月学习时间线</h4>
                    <div style="position: relative;">
                        ${(analysis.timeline || []).slice(0, 12).map((item, index) => `
                            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid ${item.color};">
                                <div style="background: ${item.color}; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: bold;">
                                    W${item.week}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #333; margin-bottom: 4px;">
                                        ${item.level} - ${item.track}
                                    </div>
                                    <div style="font-size: 0.8em; color: #666;">
                                        ${(item.skills || []).slice(0, 2).join('、')} | ${item.duration}周
                                    </div>
                                </div>
                                <div style="background: ${item.color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7em;">
                                    ${item.phase}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 学习资源推荐 -->
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #388e3c; margin-bottom: 16px;">📖 学习资源推荐</h4>
                    ${Object.keys(analysis.resources || {}).map(domain => {
                        const resource = analysis.resources[domain];
                        return `
                            <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 16px; border-left: 4px solid ${resource.color};">
                                <h5 style="margin: 0 0 16px 0; color: ${resource.color};">${resource.name}</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                    ${Object.keys(resource.items).map(type => `
                                        <div style="background: white; border-radius: 8px; padding: 12px;">
                                            <div style="font-weight: 500; margin-bottom: 8px; color: #333;">
                                                ${type === 'books' ? '📚 推荐书籍' : 
                                                  type === 'courses' ? '🎓 在线课程' : 
                                                  type === 'practice' ? '💻 实践项目' : '👥 学习社区'}
                                            </div>
                                            <ul style="margin: 0; padding-left: 16px; font-size: 0.9em; color: #666;">
                                                ${(resource.items[type] || []).map(item => `<li>${item}</li>`).join('')}
                                            </ul>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <!-- 学习建议 -->
                <div style="background: #e8f5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #2e7d32; margin: 0 0 16px 0;">💡 学习成功建议</h4>
                    <div style="display: grid; gap: 12px;">
                        ${(analysis.recommendations || []).map(rec => `
                            <div style="background: white; border-radius: 8px; padding: 16px; border-left: 4px solid ${rec.priority === 'high' ? '#f44336' : '#ff9800'};">
                                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                                    <h6 style="margin: 0; color: #333;">${rec.title}</h6>
                                    <span style="background: ${rec.priority === 'high' ? '#f44336' : '#ff9800'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7em; margin-left: auto;">
                                        ${rec.priority === 'high' ? '高优先级' : '中优先级'}
                                    </span>
                                </div>
                                <p style="font-size: 0.9em; color: #666; margin: 0 0 8px 0;">${rec.description}</p>
                                <div style="font-size: 0.8em; color: #999;">建议时间: ${rec.timeframe}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 学习进度跟踪 -->
                <div style="background: linear-gradient(135deg, #fff3e0, #ffcc80); border-radius: 12px; padding: 20px;">
                    <h4 style="color: #ef6c00; margin: 0 0 16px 0;">📊 学习进度跟踪建议</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        <div style="background: white; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-size: 1.5em; margin-bottom: 8px;">📅</div>
                            <div style="font-weight: bold; margin-bottom: 4px;">每周回顾</div>
                            <div style="font-size: 0.9em; color: #666;">记录学习进度和心得</div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-size: 1.5em; margin-bottom: 8px;">🎯</div>
                            <div style="font-weight: bold; margin-bottom: 4px;">里程碑设定</div>
                            <div style="font-size: 0.9em; color: #666;">设定阶段性成果目标</div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 16px; text-align: center;">
                            <div style="font-size: 1.5em; margin-bottom: 8px;">🏆</div>
                            <div style="font-weight: bold; margin-bottom: 4px;">成果展示</div>
                            <div style="font-size: 0.9em; color: #666;">分享学习成果和项目</div>
                        </div>
                    </div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', function() {
            initHalfyearPlan();
            initializeEnhancedInput();
            
            // 确保智能分析按钮正确初始化
            setTimeout(function() {
                initSmartAnalysisButtons();
            }, 100);
        });

        function initHalfyearPlan() {
            document.getElementById('halfyear_select').value = currentHalf;
            document.getElementById('halfyear_year').value = currentYear;
            updateMonthLabels();
            updateQuarterTitles();
            
            // 启用待办事项功能
            const containers = document.querySelectorAll('.todo-list-container');
            containers.forEach(container => {
                TodoUtils.enableTodoFunctionality(container);
            });
            
            // 设置事件监听器
            document.getElementById('halfyear-prev').addEventListener('click', () => navigateHalfyear(-1));
            document.getElementById('halfyear-next').addEventListener('click', () => navigateHalfyear(1));
            document.getElementById('halfyear_select').addEventListener('change', handleHalfyearChange);
            document.getElementById('halfyear_year').addEventListener('change', handleYearChange);
            document.querySelector('.save-btn').addEventListener('click', saveHalfyearPlan);
            document.querySelector('.save-view-btn').addEventListener('click', showHalfyearHistory);
            
            // 功能按钮事件
            document.getElementById('halfyear-analytics-btn')?.addEventListener('click', showHalfyearAnalytics);
            document.getElementById('strategic-review-btn')?.addEventListener('click', showStrategicReview);
            document.getElementById('strategic-planning-btn')?.addEventListener('click', showStrategicPlanning);
            document.getElementById('goal-alignment-btn')?.addEventListener('click', showGoalAlignment);
            document.getElementById('project-planning-btn')?.addEventListener('click', showProjectPlanning);
            document.getElementById('resource-allocation-btn')?.addEventListener('click', showResourceAllocation);
            document.getElementById('skill-assessment-btn')?.addEventListener('click', showSkillAssessment);
            document.getElementById('learning-path-btn')?.addEventListener('click', showLearningPath);
            document.getElementById('comprehensive-review-btn')?.addEventListener('click', showComprehensiveReview);
            document.getElementById('lessons-learned-btn')?.addEventListener('click', showLessonsLearned);
            
            // AI助手按钮事件
            document.querySelector('.ai-assistant-btn')?.addEventListener('click', showHalfyearAIAssistant);
            
            loadHalfyearPlan();
            updateProgress();
        }

        function navigateHalfyear(halfs) {
            currentHalf += halfs;
            if (currentHalf < 1) {
                currentHalf = 2;
                currentYear--;
            } else if (currentHalf > 2) {
                currentHalf = 1;
                currentYear++;
            }
            
            document.getElementById('halfyear_select').value = currentHalf;
            document.getElementById('halfyear_year').value = currentYear;
            updateMonthLabels();
            updateQuarterTitles();
            loadHalfyearPlan();
            updateProgress();
        }

        function handleHalfyearChange() {
            currentHalf = parseInt(document.getElementById('halfyear_select').value);
            updateMonthLabels();
            updateQuarterTitles();
            loadHalfyearPlan();
            updateProgress();
        }

        function handleYearChange() {
            currentYear = parseInt(document.getElementById('halfyear_year').value);
            loadHalfyearPlan();
            updateProgress();
        }

        function updateMonthLabels() {
            const months = currentHalf === 1 ? 
                ['1月', '2月', '3月', '4月', '5月', '6月'] : 
                ['7月', '8月', '9月', '10月', '11月', '12月'];
            
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`month${i}-label`).textContent = months[i-1];
            }
        }

        function updateQuarterTitles() {
            if (currentHalf === 1) {
                document.getElementById('quarter1-title').innerHTML = `
                    🌱 第一季度 (Q1)
                    <span style="background: rgba(33,150,243,0.1); color: #2196f3; font-size: 0.8em; padding: 2px 6px; border-radius: 8px;">启动期</span>
                `;
                document.getElementById('quarter2-title').innerHTML = `
                    🚀 第二季度 (Q2)
                    <span style="background: rgba(255,152,0,0.1); color: #ff9800; font-size: 0.8em; padding: 2px 6px; border-radius: 8px;">冲刺期</span>
                `;
            } else {
                document.getElementById('quarter1-title').innerHTML = `
                    🌱 第三季度 (Q3)
                    <span style="background: rgba(33,150,243,0.1); color: #2196f3; font-size: 0.8em; padding: 2px 6px; border-radius: 8px;">深耕期</span>
                `;
                document.getElementById('quarter2-title').innerHTML = `
                    🚀 第四季度 (Q4)
                    <span style="background: rgba(255,152,0,0.1); color: #ff9800; font-size: 0.8em; padding: 2px 6px; border-radius: 8px;">收获期</span>
                `;
            }
        }

        function saveHalfyearPlan() {
            const halfyearKey = `${currentYear}-H${currentHalf}`;
            const data = {
                vision: document.getElementById('halfyear_vision').value,
                strategicGoals: getTodoContent('halfyear_strategic_goals'),
                quarter1Milestones: getTodoContent('quarter1_milestones'),
                quarter2Milestones: getTodoContent('quarter2_milestones'),
                projects: getTodoContent('halfyear_projects'),
                skills: document.getElementById('halfyear_skills').value,
                balance: getTodoContent('halfyear_balance'),
                review: document.getElementById('halfyear_review').value
            };

            const success = StorageUtils.savePlan('halfyear', halfyearKey, data);
            if (success) {
                MessageUtils.success('半年计划保存成功！');
                animateSaveSuccess();
            }
        }

        function loadHalfyearPlan() {
            const halfyearKey = `${currentYear}-H${currentHalf}`;
            const data = StorageUtils.loadPlan('halfyear', halfyearKey);
            
            if (data) {
                document.getElementById('halfyear_vision').value = data.vision || '';
                document.getElementById('halfyear_skills').value = data.skills || '';
                document.getElementById('halfyear_review').value = data.review || '';
                
                loadTodoContent('halfyear_strategic_goals', data.strategicGoals);
                loadTodoContent('quarter1_milestones', data.quarter1Milestones);
                loadTodoContent('quarter2_milestones', data.quarter2Milestones);
                loadTodoContent('halfyear_projects', data.projects);
                loadTodoContent('halfyear_balance', data.balance);
            } else {
                clearFields();
            }
        }

        function clearFields() {
            document.getElementById('halfyear_vision').value = '';
            document.getElementById('halfyear_skills').value = '';
            document.getElementById('halfyear_review').value = '';
            
            const containers = ['halfyear_strategic_goals', 'quarter1_milestones', 'quarter2_milestones', 'halfyear_projects', 'halfyear_balance'];
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.innerHTML = '';
                    container.textContent = '';
                }
            });
        }

        function loadTodoContent(containerId, content) {
            const container = document.getElementById(containerId);
            if (container && content) {
                container.textContent = content;
                TodoUtils.renderTodos(container);
            }
        }

        function getTodoContent(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return '';
            
            const tasks = container.querySelectorAll('.task-item');
            const lines = [];
            
            tasks.forEach(task => {
                const checkbox = task.querySelector('.custom-checkbox');
                const text = task.querySelector('.task-text').textContent;
                const isChecked = checkbox.classList.contains('checked');
                lines.push(`[${isChecked ? 'x' : ' '}] ${text}`);
            });
            
            return lines.join('\n');
        }

        function updateProgress() {
            // 简化的半年进度计算
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            
            let progress = 0;
            if (currentHalf === 1) {
                // 上半年 (1-6月)
                if (currentMonth <= 6) {
                    progress = Math.round(((currentMonth - 1) * 30 + now.getDate()) / 181 * 100);
                } else {
                    progress = 100;
                }
            } else {
                // 下半年 (7-12月)
                if (currentMonth >= 7) {
                    progress = Math.round(((currentMonth - 7) * 30 + now.getDate()) / 184 * 100);
                } else {
                    progress = 0;
                }
            }
            
            progress = Math.min(progress, 100);
            document.getElementById('halfyear-progress-inner').style.width = `${progress}%`;
            document.getElementById('halfyear-progress-text').textContent = `半年进度 ${progress}%`;
        }

        function animateSaveSuccess() {
            const saveBtn = document.querySelector('.save-btn');
            const originalText = saveBtn.textContent;
            
            saveBtn.style.background = '#4caf50';
            saveBtn.style.color = 'white';
            saveBtn.textContent = '✅ 已保存';
            
            setTimeout(() => {
                saveBtn.style.background = '';
                saveBtn.style.color = '';
                saveBtn.textContent = originalText;
            }, 2000);
        }

        // 功能按钮实现
        function showHalfyearHistory() {
            const history = StorageUtils.getHistory('halfyear');
            if (history.length === 0) {
                MessageUtils.info('暂无半年计划历史记录');
                return;
            }
            
            let historyHtml = '<div style="max-height: 400px; overflow-y: auto;">';
            history.forEach((record, index) => {
                historyHtml += `
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; background: #f9f9f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #1976d2;">${record.date}</strong>
                            <span style="font-size: 0.9em; color: #666;">${new Date(record.timestamp).toLocaleString()}</span>
                        </div>
                        <div style="color: #666; font-size: 0.9em;">${record.summary}</div>
                    </div>
                `;
            });
            historyHtml += '</div>';
            
            ModalUtils.show('📚 半年计划历史记录', historyHtml, 'large');
        }

        function showHalfyearAnalytics() {
            generateHalfyearAnalytics();
        }

        function showStrategicReview() {
            generateStrategicReview();
        }

        function showStrategicPlanning() {
            generateStrategicPlanningGuide();
        }

        function showGoalAlignment() {
            generateGoalAlignmentAnalysis();
        }

        function showProjectPlanning() {
            const currentData = getCurrentPlanData();
            const projectPlan = generateProjectPlanningGuide(currentData);
            
            ModalUtils.show('📋 项目规划助手', projectPlan, {
                size: 'large',
                buttons: [
                    {
                        text: '生成项目模板',
                        class: 'btn-main',
                        handler: () => generateProjectTemplates(),
                        close: false
                    },
                    {
                        text: '应用项目建议',
                        class: 'btn-secondary',
                        handler: () => applyProjectSuggestions(),
                        close: false
                    },
                    {
                        text: '关闭',
                        class: 'btn-secondary'
                    }
                ]
            });
        }

        function showResourceAllocation() {
            const currentData = getCurrentPlanData();
            const resourceAnalysis = generateResourceAllocationGuide(currentData);
            
            ModalUtils.show('🎯 资源分配助手', resourceAnalysis, {
                size: 'large',
                buttons: [
                    {
                        text: '优化资源配置',
                        class: 'btn-main',
                        handler: () => optimizeResourceAllocation(),
                        close: false
                    },
                    {
                        text: '生成资源计划',
                        class: 'btn-secondary',
                        handler: () => generateResourcePlan(),
                        close: false
                    },
                    {
                        text: '关闭',
                        class: 'btn-secondary'
                    }
                ]
            });
        }

        function showSkillAssessment() {
            console.log('🔄 showSkillAssessment被调用，转发到generateSkillAssessment');
            generateSkillAssessment();
        }

        function showLearningPath() {
            MessageUtils.info('学习路径功能正在开发中...');
        }

        function showComprehensiveReview() {
            console.log('📊 开始生成全面回顾...');
            generateComprehensiveReview();
        }

        function showLessonsLearned() {
            console.log('💡 开始生成经验总结...');
            generateLessonsLearned();
        }

        // === 半年分析功能 ===
        function generateHalfyearAnalytics() {
            const halfyearKey = `${currentYear}-H${currentHalf}`;
            let currentData = StorageUtils.loadPlan('halfyear', halfyearKey);
            
            // 如果没有数据，创建一个空的数据结构用于分析
            if (!currentData) {
                currentData = {
                    vision: '',
                    strategicGoals: '',
                    quarter1Milestones: '',
                    quarter2Milestones: '',
                    projects: '',
                    skills: '',
                    balance: '',
                    review: ''
                };
                MessageUtils.info('当前为空白计划，将显示初始状态分析');
            }

            // 计算各项指标
            const analytics = calculateHalfyearMetrics(currentData);
            
            // 生成分析报告HTML
            const analyticsHtml = generateAnalyticsHTML(analytics);
            
            ModalUtils.show('📊 半年分析报告', analyticsHtml, {
                size: 'large',
                buttons: [
                    {
                        text: '导出报告',
                        class: 'btn-main',
                        handler: () => exportAnalyticsReport(analytics),
                        close: false
                    },
                    {
                        text: '关闭',
                        class: 'btn-secondary'
                    }
                ]
            });
        }

        function calculateHalfyearMetrics(data) {
            // 战略目标分析
            const strategicGoalsData = analyzeTaskContent(data.strategicGoals || '');
            
            // 项目分析
            const projectsData = analyzeTaskContent(data.projects || '');
            
            // 工作生活平衡分析
            const balanceData = analyzeTaskContent(data.balance || '');
            
            // Q1里程碑分析
            const q1Data = analyzeTaskContent(data.quarter1Milestones || '');
            
            // Q2里程碑分析
            const q2Data = analyzeTaskContent(data.quarter2Milestones || '');
            
            // 整体完成度
            const totalTasks = strategicGoalsData.total + projectsData.total + balanceData.total + q1Data.total + q2Data.total;
            const completedTasks = strategicGoalsData.completed + projectsData.completed + balanceData.completed + q1Data.completed + q2Data.completed;
            const overallProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // 时间进度
            const timeProgress = calculateTimeProgress();
            
            // 进度偏差分析
            const progressDeviation = overallProgress - timeProgress;
            
            return {
                strategic: strategicGoalsData,
                projects: projectsData,
                balance: balanceData,
                quarter1: q1Data,
                quarter2: q2Data,
                overall: {
                    totalTasks,
                    completedTasks,
                    progress: overallProgress,
                    timeProgress,
                    deviation: progressDeviation
                },
                insights: generateInsights(strategicGoalsData, projectsData, balanceData, progressDeviation),
                recommendations: generateRecommendations(overallProgress, timeProgress, progressDeviation)
            };
        }

        function analyzeTaskContent(content) {
            if (!content) return { total: 0, completed: 0, pending: 0, rate: 0 };
            
            const tasks = content.split('\n').filter(line => line.trim() && line.includes('['));
            const total = tasks.length;
            const completed = tasks.filter(task => task.includes('[x]') || task.includes('[X]')).length;
            const pending = total - completed;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            return { total, completed, pending, rate };
        }

        function calculateTimeProgress() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            
            if (currentHalf === 1) {
                // 上半年 (1-6月)
                if (currentMonth <= 6) {
                    return Math.round(((currentMonth - 1) * 30 + now.getDate()) / 181 * 100);
                } else {
                    return 100;
                }
            } else {
                // 下半年 (7-12月)
                if (currentMonth >= 7) {
                    return Math.round(((currentMonth - 7) * 30 + now.getDate()) / 184 * 100);
                } else {
                    return 0;
                }
            }
        }

        function generateInsights(strategic, projects, balance, deviation) {
            const insights = [];
            
            // 检查是否为空白计划
            const isEmptyPlan = strategic.total === 0 && projects.total === 0 && balance.total === 0;
            
            if (isEmptyPlan) {
                insights.push('🌱 这是一个崭新的开始！现在是制定半年计划的最佳时机');
                insights.push('💡 建议先设定2-3个核心战略目标，然后逐步完善');
                insights.push('🎯 记住：明确的目标是成功的第一步');
                insights.push('📅 可以从当前最重要的事情开始规划');
                return insights;
            }
            
            // 战略目标洞察
            if (strategic.total === 0) {
                insights.push('🎯 建议添加战略目标，为半年设定明确方向');
            } else if (strategic.rate >= 80) {
                insights.push('🎯 战略目标执行优秀，保持当前节奏');
            } else if (strategic.rate >= 60) {
                insights.push('⚡ 战略目标进展良好，可适当加速');
            } else {
                insights.push('🚨 战略目标执行偏慢，需要重点关注');
            }
            
            // 项目进展洞察
            if (projects.total === 0) {
                insights.push('🏗️ 考虑添加重点项目，将战略目标转化为具体行动');
            } else if (projects.rate >= 75) {
                insights.push('🚀 项目推进效率高，团队执行力强');
            } else if (projects.rate >= 50) {
                insights.push('📈 项目进展中等，可优化资源配置');
            } else {
                insights.push('⏰ 项目进度滞后，需调整优先级');
            }
            
            // 工作生活平衡洞察
            if (balance.total === 0) {
                insights.push('⚖️ 建议关注工作生活平衡，制定相应的保障措施');
            } else if (balance.rate >= 70) {
                insights.push('⚖️ 工作生活平衡良好，身心状态佳');
            } else {
                insights.push('🔄 工作生活平衡需要调整，关注健康');
            }
            
            // 进度偏差洞察
            if (Math.abs(deviation) <= 10) {
                insights.push('📊 整体进度与时间进度基本同步');
            } else if (deviation > 10) {
                insights.push('🏃‍♀️ 执行进度领先时间，可能需要可持续性考虑');
            } else {
                insights.push('⏳ 执行进度落后时间，需要加速推进');
            }
            
            return insights;
        }

        function generateRecommendations(overallProgress, timeProgress, deviation) {
            const recommendations = [];
            
            // 如果是空白计划，提供初始建议
            if (overallProgress === 0 && timeProgress > 0) {
                recommendations.push('🚀 立即开始：先填写半年愿景，设定大方向');
                recommendations.push('🎯 设定目标：制定2-3个核心战略目标');
                recommendations.push('📋 分解任务：将目标分解为具体的季度里程碑');
                recommendations.push('⚖️ 平衡规划：不要忘记工作生活平衡的安排');
                recommendations.push('💡 小步快跑：从最重要、最紧急的目标开始');
                return recommendations;
            }
            
            if (deviation < -20) {
                recommendations.push('🎯 建议重新评估目标的可行性，适当调整期望');
                recommendations.push('🔧 优化工作方法，提高执行效率');
                recommendations.push('👥 考虑寻求更多资源或团队支持');
            } else if (deviation < -10) {
                recommendations.push('⚡ 加快关键任务的推进速度');
                recommendations.push('📅 重新规划剩余时间的任务优先级');
                recommendations.push('🎯 聚焦最重要的2-3个核心目标');
            } else if (deviation > 15) {
                recommendations.push('🎉 当前进度很好，可以考虑挑战更高目标');
                recommendations.push('📚 利用领先优势，投资长期能力建设');
                recommendations.push('🤝 分享成功经验，帮助他人提升');
            } else {
                recommendations.push('✅ 保持当前的执行节奏');
                recommendations.push('🔍 定期回顾和微调计划');
                recommendations.push('💪 继续保持专注和执行力');
            }
            
            return recommendations;
        }

        function generateAnalyticsHTML(analytics) {
            const { strategic, projects, balance, quarter1, quarter2, overall, insights, recommendations } = analytics;
            
            // 检查是否为空白计划
            const isEmptyPlan = overall.totalTasks === 0;
            
            return `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <!-- 总体概览 -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 16px 0; font-size: 1.5em;">📊 ${currentYear}年${currentHalf === 1 ? '上' : '下'}半年分析概览</h3>
                        ${isEmptyPlan ? '<p style="margin: 8px 0; opacity: 0.9; font-size: 0.9em;">🌱 这是一个全新的开始！让我们开始规划您的半年目标吧。</p>' : ''}
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${overall.progress}%</div>
                                <div style="opacity: 0.9;">整体完成度</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${overall.totalTasks}</div>
                                <div style="opacity: 0.9;">总任务数</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${overall.completedTasks}</div>
                                <div style="opacity: 0.9;">已完成</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: ${overall.deviation >= 0 ? '#4caf50' : '#ff5722'}">${overall.deviation > 0 ? '+' : ''}${overall.deviation}%</div>
                                <div style="opacity: 0.9;">进度偏差</div>
                            </div>
                        </div>
                    </div>

                    <!-- 各维度分析 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        ${generateDimensionCard('🎯 战略目标', strategic, '#2196f3')}
                        ${generateDimensionCard('🏗️ 重点项目', projects, '#9c27b0')}
                        ${generateDimensionCard('⚖️ 工作生活平衡', balance, '#795548')}
                    </div>

                    <!-- 季度对比 -->
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">📅 季度执行对比</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            ${generateQuarterCard(currentHalf === 1 ? 'Q1' : 'Q3', quarter1, '#2196f3')}
                            ${generateQuarterCard(currentHalf === 1 ? 'Q2' : 'Q4', quarter2, '#ff9800')}
                        </div>
                    </div>

                    <!-- 智能洞察 -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">🧠 智能洞察</h4>
                        <div style="display: grid; gap: 8px;">
                            ${insights.map(insight => `<div style="padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #4caf50;">${insight}</div>`).join('')}
                        </div>
                    </div>

                    <!-- 改进建议 -->
                    <div style="background: #fff3e0; border-radius: 12px; padding: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #ef6c00;">💡 改进建议</h4>
                        <div style="display: grid; gap: 8px;">
                            ${recommendations.map(rec => `<div style="padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #ff9800;">${rec}</div>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateDimensionCard(title, data, color) {
            return `
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 16px;">
                    <h5 style="margin: 0 0 12px 0; color: ${color};">${title}</h5>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span>完成率</span>
                        <span style="font-weight: bold; color: ${color};">${data.rate}%</span>
                    </div>
                    <div style="background: #f0f0f0; border-radius: 8px; height: 8px; overflow: hidden;">
                        <div style="background: ${color}; height: 100%; width: ${data.rate}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.9em; color: #666;">
                        <span>已完成: ${data.completed}</span>
                        <span>总计: ${data.total}</span>
                    </div>
                </div>
            `;
        }

        function generateQuarterCard(quarter, data, color) {
            return `
                <div style="text-align: center; padding: 16px; background: rgba(${color === '#2196f3' ? '33,150,243' : '255,152,0'}, 0.1); border-radius: 8px;">
                    <h5 style="margin: 0 0 8px 0; color: ${color};">${quarter}</h5>
                    <div style="font-size: 1.5em; font-weight: bold; color: ${color};">${data.rate}%</div>
                    <div style="font-size: 0.9em; color: #666; margin-top: 4px;">${data.completed}/${data.total} 项</div>
                </div>
            `;
        }

        function exportAnalyticsReport(analytics) {
            const reportData = {
                reportDate: new Date().toISOString(),
                period: `${currentYear}年${currentHalf === 1 ? '上' : '下'}半年`,
                analytics: analytics
            };
            
            ExportUtils.exportToJSON(reportData, `halfyear_analytics_${currentYear}_H${currentHalf}.json`);
            MessageUtils.success('分析报告已导出');
        }

        // === 战略回顾功能 ===
        function generateStrategicReview() {
            const halfyearKey = `${currentYear}-H${currentHalf}`;
            let currentData = StorageUtils.loadPlan('halfyear', halfyearKey);
            
            // 如果没有数据，创建一个空的数据结构用于回顾
            if (!currentData) {
                currentData = {
                    vision: '',
                    strategicGoals: '',
                    quarter1Milestones: '',
                    quarter2Milestones: '',
                    projects: '',
                    skills: '',
                    balance: '',
                    review: ''
                };
                MessageUtils.info('当前为空白计划，将显示初始状态回顾');
            }

            // 获取历史数据进行对比
            const historicalData = getHistoricalHalfyearData();
            
            // 生成战略回顾内容
            const reviewContent = generateStrategicReviewContent(currentData, historicalData);
            
            ModalUtils.show('🎯 战略回顾', reviewContent, {
                size: 'large',
                buttons: [
                    {
                        text: '生成行动计划',
                        class: 'btn-main',
                        handler: () => generateActionPlan(currentData),
                        close: false
                    },
                    {
                        text: '导出回顾',
                        class: 'btn-secondary',
                        handler: () => exportStrategicReview(currentData, historicalData),
                        close: false
                    },
                    {
                        text: '关闭',
                        class: 'btn-secondary'
                    }
                ]
            });
        }

        function getHistoricalHalfyearData() {
            const allPlans = StorageUtils.getAllPlans('halfyear');
            const historicalData = [];
            
            // 获取最近3个半年的数据
            for (let year = currentYear; year >= currentYear - 2; year--) {
                for (let half = 2; half >= 1; half--) {
                    const key = `${year}-H${half}`;
                    if (key !== `${currentYear}-H${currentHalf}` && allPlans[key]) {
                        historicalData.push({
                            key,
                            year,
                            half,
                            data: allPlans[key]
                        });
                        if (historicalData.length >= 3) break;
                    }
                }
                if (historicalData.length >= 3) break;
            }
            
            return historicalData;
        }

        function generateStrategicReviewContent(currentData, historicalData) {
            const currentAnalytics = calculateHalfyearMetrics(currentData);
            const strategicAssessment = assessStrategicExecution(currentData);
            const trends = analyzeHistoricalTrends(historicalData);
            
            return `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <!-- 战略执行评估 -->
                    <div style="background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 16px 0;">🎯 ${currentYear}年${currentHalf === 1 ? '上' : '下'}半年战略回顾</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold;">${strategicAssessment.overallScore}</div>
                                <div style="opacity: 0.9;">战略得分</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold;">${strategicAssessment.executionLevel}</div>
                                <div style="opacity: 0.9;">执行等级</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold;">${strategicAssessment.focusAreas.length}</div>
                                <div style="opacity: 0.9;">关键领域</div>
                            </div>
                        </div>
                    </div>

                    <!-- 愿景实现度评估 -->
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">🌟 愿景实现度评估</h4>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <strong>半年愿景:</strong><br>
                            <div style="margin-top: 8px; color: #666; font-style: italic;">${currentData.vision || '未设定愿景'}</div>
                        </div>
                        ${generateVisionAssessment(currentData, currentAnalytics)}
                    </div>

                    <!-- 战略目标深度分析 -->
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">🎯 战略目标深度分析</h4>
                        ${generateStrategicGoalsAnalysis(currentData.strategicGoals, currentAnalytics.strategic)}
                    </div>

                    <!-- 能力发展评估 -->
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">📈 能力发展评估</h4>
                        ${generateSkillDevelopmentAssessment(currentData.skills)}
                    </div>

                    <!-- 历史趋势对比 -->
                    ${historicalData.length > 0 ? `
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">📊 历史趋势对比</h4>
                        ${generateHistoricalComparison(trends)}
                    </div>
                    ` : ''}

                    <!-- 战略调整建议 -->
                    <div style="background: #e8f5e9; border-radius: 12px; padding: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #2e7d32;">🔧 战略调整建议</h4>
                        ${generateStrategicAdjustments(strategicAssessment, currentAnalytics)}
                    </div>
                </div>
            `;
        }

        function assessStrategicExecution(data) {
            const strategicData = analyzeTaskContent(data.strategicGoals || '');
            const projectsData = analyzeTaskContent(data.projects || '');
            
            // 计算综合得分
            const visionScore = data.vision && data.vision.trim() ? 20 : 0;
            const strategicScore = strategicData.rate * 0.3;
            const projectScore = projectsData.rate * 0.3;
            const skillsScore = data.skills && data.skills.trim() ? 20 : 0;
            
            const overallScore = Math.round(visionScore + strategicScore + projectScore + skillsScore);
            
            // 确定执行等级
            let executionLevel = 'C';
            if (overallScore >= 90) executionLevel = 'A+';
            else if (overallScore >= 80) executionLevel = 'A';
            else if (overallScore >= 70) executionLevel = 'B+';
            else if (overallScore >= 60) executionLevel = 'B';
            else if (overallScore >= 50) executionLevel = 'C+';
            
            // 识别关键领域
            const focusAreas = [];
            if (strategicData.rate >= 70) focusAreas.push('战略执行');
            if (projectsData.rate >= 70) focusAreas.push('项目管理');
            if (data.vision && data.vision.trim()) focusAreas.push('愿景规划');
            if (data.skills && data.skills.trim()) focusAreas.push('能力发展');
            
            return {
                overallScore,
                executionLevel,
                focusAreas,
                strategicScore: strategicData.rate,
                projectScore: projectsData.rate
            };
        }

        function generateVisionAssessment(data, analytics) {
            if (!data.vision || !data.vision.trim()) {
                return '<div style="color: #ff5722; padding: 12px; background: #ffebee; border-radius: 6px;">⚠️ 未设定明确愿景，建议补充</div>';
            }
            
            const visionKeywords = data.vision.toLowerCase();
            const hasCareerFocus = visionKeywords.includes('职业') || visionKeywords.includes('工作') || visionKeywords.includes('技能');
            const hasHealthFocus = visionKeywords.includes('健康') || visionKeywords.includes('运动') || visionKeywords.includes('身体');
            const hasRelationshipFocus = visionKeywords.includes('关系') || visionKeywords.includes('家庭') || visionKeywords.includes('朋友');
            
            const assessmentItems = [
                { label: '职业发展维度', status: hasCareerFocus, score: hasCareerFocus ? '✅' : '⚠️' },
                { label: '健康生活维度', status: hasHealthFocus, score: hasHealthFocus ? '✅' : '⚠️' },
                { label: '人际关系维度', status: hasRelationshipFocus, score: hasRelationshipFocus ? '✅' : '⚠️' },
                { label: '执行落地情况', status: analytics.overall.progress > 60, score: analytics.overall.progress > 60 ? '✅' : '❌' }
            ];
            
            return `
                <div style="display: grid; gap: 8px;">
                    ${assessmentItems.map(item => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: ${item.status ? '#e8f5e9' : '#fff3e0'}; border-radius: 6px;">
                            <span>${item.label}</span>
                            <span>${item.score}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateStrategicGoalsAnalysis(goals, analytics) {
            if (!goals || !goals.trim()) {
                return '<div style="color: #ff5722; padding: 12px; background: #ffebee; border-radius: 6px;">未设定战略目标</div>';
            }
            
            const goalLines = goals.split('\n').filter(line => line.trim() && line.includes('['));
            const completedGoals = goalLines.filter(line => line.includes('[x]') || line.includes('[X]'));
            const pendingGoals = goalLines.filter(line => line.includes('[ ]'));
            
            return `
                <div style="display: grid; gap: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        <div style="text-align: center; padding: 12px; background: #e8f5e9; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;">${completedGoals.length}</div>
                            <div style="font-size: 0.9em; color: #666;">已完成</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #fff3e0; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #ff9800;">${pendingGoals.length}</div>
                            <div style="font-size: 0.9em; color: #666;">进行中</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #e3f2fd; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #2196f3;">${analytics.rate}%</div>
                            <div style="font-size: 0.9em; color: #666;">完成率</div>
                        </div>
                    </div>
                    
                    ${completedGoals.length > 0 ? `
                    <div>
                        <h5 style="color: #4caf50; margin: 0 0 8px 0;">✅ 已完成目标</h5>
                        <div style="background: #e8f5e9; padding: 12px; border-radius: 6px;">
                            ${completedGoals.map(goal => `<div style="margin: 4px 0;">• ${goal.replace(/^\[x\]\s*/i, '')}</div>`).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${pendingGoals.length > 0 ? `
                    <div>
                        <h5 style="color: #ff9800; margin: 0 0 8px 0;">⏳ 待完成目标</h5>
                        <div style="background: #fff3e0; padding: 12px; border-radius: 6px;">
                            ${pendingGoals.map(goal => `<div style="margin: 4px 0;">• ${goal.replace(/^\[\s\]\s*/, '')}</div>`).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function generateSkillDevelopmentAssessment(skills) {
            if (!skills || !skills.trim()) {
                return '<div style="color: #ff5722; padding: 12px; background: #ffebee; border-radius: 6px;">未设定能力发展计划</div>';
            }
            
            const skillContent = skills.toLowerCase();
            const categories = [
                { name: '专业技能', keywords: ['技能', '专业', '技术', '工具'], found: false },
                { name: '学习计划', keywords: ['学习', '课程', '培训', '阅读'], found: false },
                { name: '实践项目', keywords: ['项目', '实践', '练习', '应用'], found: false },
                { name: '软技能', keywords: ['沟通', '领导', '管理', '协作'], found: false }
            ];
            
            categories.forEach(category => {
                category.found = category.keywords.some(keyword => skillContent.includes(keyword));
            });
            
            const completionScore = Math.round((categories.filter(c => c.found).length / categories.length) * 100);
            
            return `
                <div style="display: grid; gap: 16px;">
                    <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                        <div style="font-size: 1.8em; font-weight: bold;">${completionScore}%</div>
                        <div style="opacity: 0.9;">能力规划完整度</div>
                    </div>
                    
                    <div style="display: grid; gap: 8px;">
                        ${categories.map(category => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${category.found ? '#e8f5e9' : '#f5f5f5'}; border-radius: 6px;">
                                <span>${category.name}</span>
                                <span style="font-size: 1.2em;">${category.found ? '✅' : '⚪'}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                        <strong>能力发展内容预览:</strong><br>
                        <div style="margin-top: 8px; color: #666; max-height: 100px; overflow-y: auto;">${skills.substring(0, 200)}${skills.length > 200 ? '...' : ''}</div>
                    </div>
                </div>
            `;
        }

        function analyzeHistoricalTrends(historicalData) {
            if (historicalData.length === 0) return null;
            
            const trends = historicalData.map(item => {
                const analytics = calculateHalfyearMetrics(item.data);
                return {
                    period: `${item.year}年${item.half === 1 ? '上' : '下'}半年`,
                    progress: analytics.overall.progress,
                    strategicRate: analytics.strategic.rate,
                    projectRate: analytics.projects.rate
                };
            });
            
            return trends;
        }

        function generateHistoricalComparison(trends) {
            if (!trends || trends.length === 0) {
                return '<div style="color: #666;">暂无历史数据对比</div>';
            }
            
            return `
                <div style="display: grid; gap: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        ${trends.map(trend => `
                            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; text-align: center;">
                                <h6 style="margin: 0 0 8px 0; color: #666;">${trend.period}</h6>
                                <div style="font-size: 1.5em; font-weight: bold; color: #2196f3;">${trend.progress}%</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 4px;">整体进度</div>
                                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.8em; color: #999;">
                                    <span>战略: ${trend.strategicRate}%</span>
                                    <span>项目: ${trend.projectRate}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                        <strong>趋势分析:</strong> ${generateTrendInsight(trends)}
                    </div>
                </div>
            `;
        }

        function generateTrendInsight(trends) {
            if (trends.length < 2) return '需要更多数据才能分析趋势';
            
            const currentProgress = trends[0].progress;
            const previousProgress = trends[1].progress;
            const progressChange = currentProgress - previousProgress;
            
            if (progressChange > 10) {
                return '📈 执行能力显著提升，保持良好发展势头';
            } else if (progressChange > 0) {
                return '📊 执行能力稳步提升，继续优化执行策略';
            } else if (progressChange > -10) {
                return '📊 执行能力基本稳定，可考虑挑战更高目标';
            } else {
                return '📉 执行能力有所下降，需要重新审视目标设定和执行方法';
            }
        }

        function generateStrategicAdjustments(assessment, analytics) {
            const adjustments = [];
            
            // 基于整体得分的建议
            if (assessment.overallScore >= 80) {
                adjustments.push('🎯 战略执行优秀，可以考虑制定更具挑战性的目标');
                adjustments.push('📈 利用当前优势，扩展到新的战略领域');
                adjustments.push('🤝 分享成功经验，建立最佳实践');
            } else if (assessment.overallScore >= 60) {
                adjustments.push('⚡ 继续保持当前战略方向，适当优化执行方法');
                adjustments.push('🎯 聚焦核心目标，避免资源分散');
                adjustments.push('📊 建立更清晰的进度跟踪机制');
            } else {
                adjustments.push('🔧 需要重新评估战略可行性和资源配置');
                adjustments.push('📝 简化目标，确保可执行性');
                adjustments.push('💪 加强执行纪律，建立定期回顾机制');
            }
            
            // 基于具体维度的建议
            if (analytics.strategic.rate < 50) {
                adjustments.push('🎯 战略目标执行偏弱，建议重新审视目标设定的合理性');
            }
            
            if (analytics.projects.rate < 50) {
                adjustments.push('🏗️ 项目推进缓慢，考虑优化项目管理流程');
            }
            
            if (analytics.balance.rate < 50) {
                adjustments.push('⚖️ 工作生活平衡需要重视，关注可持续发展');
            }
            
            return adjustments.map(adj => `<div style="padding: 8px 12px; background: white; border-radius: 6px; margin: 4px 0; border-left: 3px solid #4caf50;">${adj}</div>`).join('');
        }

        function generateActionPlan(currentData) {
            const analytics = calculateHalfyearMetrics(currentData);
            const assessment = assessStrategicExecution(currentData);
            
            const actionPlanHtml = `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px 0;">🚀 下阶段行动计划</h3>
                        <p style="margin: 0; opacity: 0.9;">基于当前执行情况生成的具体行动建议</p>
                    </div>
                    
                    <!-- 紧急行动项 -->
                    <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <h4 style="margin: 0 0 12px 0; color: #f44336;">🚨 紧急行动项 (未来2周)</h4>
                        ${generateUrgentActions(analytics)}
                    </div>
                    
                    <!-- 短期行动项 -->
                    <div style="background: #fff3e0; border: 1px solid #ff9800; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <h4 style="margin: 0 0 12px 0; color: #ff9800;">⚡ 短期行动项 (未来1个月)</h4>
                        ${generateShortTermActions(analytics, assessment)}
                    </div>
                    
                    <!-- 中期行动项 -->
                    <div style="background: #e8f5e9; border: 1px solid #4caf50; border-radius: 8px; padding: 16px;">
                        <h4 style="margin: 0 0 12px 0; color: #4caf50;">📈 中期行动项 (未来3个月)</h4>
                        ${generateMidTermActions(analytics, assessment)}
                    </div>
                </div>
            `;
            
            ModalUtils.show('🚀 行动计划', actionPlanHtml, 'large');
        }

        function generateUrgentActions(analytics) {
            const actions = [];
            
            if (analytics.overall.progress < 30) {
                actions.push('立即回顾当前所有目标，识别最核心的2-3个目标');
                actions.push('暂停低优先级任务，集中资源于关键目标');
            }
            
            if (analytics.strategic.rate < 25) {
                actions.push('紧急评估战略目标的可行性，必要时进行调整');
                actions.push('设立每日战略目标检查机制');
            }
            
            if (analytics.projects.rate < 25) {
                actions.push('召集项目回顾会议，识别阻塞点');
                actions.push('重新分配项目资源和时间安排');
            }
            
            if (actions.length === 0) {
                actions.push('继续保持当前执行节奏');
                actions.push('定期监控关键指标变化');
            }
            
            return actions.map(action => `<div style="padding: 8px 0; border-bottom: 1px solid #ffcdd2;">• ${action}</div>`).join('');
        }

        function generateShortTermActions(analytics, assessment) {
            const actions = [];
            
            if (assessment.overallScore < 70) {
                actions.push('建立每周目标回顾机制，跟踪执行进度');
                actions.push('优化时间管理方法，提高执行效率');
            }
            
            if (analytics.balance.rate < 60) {
                actions.push('制定工作生活平衡改善计划');
                actions.push('安排定期的休息和恢复时间');
            }
            
            actions.push('建立关键指标dashboard，实时监控进度');
            actions.push('设置里程碑庆祝机制，保持执行动力');
            
            return actions.map(action => `<div style="padding: 8px 0; border-bottom: 1px solid #ffe0b2;">• ${action}</div>`).join('');
        }

        function generateMidTermActions(analytics, assessment) {
            const actions = [];
            
            if (assessment.overallScore >= 80) {
                actions.push('探索新的挑战领域，扩展战略边界');
                actions.push('建立知识分享机制，输出最佳实践');
            } else {
                actions.push('建立更完善的目标设定和执行体系');
                actions.push('投资于能力建设，提升执行水平');
            }
            
            actions.push('建立长期能力发展计划');
            actions.push('构建更强的支持网络和反馈机制');
            actions.push('准备下半年/下一阶段的战略规划');
            
            return actions.map(action => `<div style="padding: 8px 0; border-bottom: 1px solid #c8e6c9;">• ${action}</div>`).join('');
        }

        function exportStrategicReview(currentData, historicalData) {
            const reviewData = {
                exportDate: new Date().toISOString(),
                period: `${currentYear}年${currentHalf === 1 ? '上' : '下'}半年`,
                currentData: currentData,
                analytics: calculateHalfyearMetrics(currentData),
                assessment: assessStrategicExecution(currentData),
                historicalData: historicalData
            };
            
            ExportUtils.exportToJSON(reviewData, `strategic_review_${currentYear}_H${currentHalf}.json`);
            MessageUtils.success('战略回顾已导出');
        }

        // 全面回顾功能
        function generateComprehensiveReview() {
            console.log('🔥 开始生成全面回顾...');
            try {
                const halfyearKey = `${currentYear}-H${currentHalf}`;
                const currentData = StorageUtils.loadPlan('halfyear', halfyearKey) || {};
                console.log('📊 全面回顾-加载的数据:', currentData);
                
                const reviewAnalysis = analyzeComprehensiveReview(currentData);
                console.log('📊 全面回顾分析结果:', reviewAnalysis);
                
                const reviewContent = generateComprehensiveReviewHTML(reviewAnalysis);
                console.log('🎨 生成的全面回顾HTML长度:', reviewContent.length);
                
                if (typeof ModalUtils !== 'undefined' && ModalUtils.show) {
                    ModalUtils.show('📊 全面回顾报告', reviewContent, 'large');
                    console.log('✅ 成功显示全面回顾模态框');
                } else {
                    console.error('❌ ModalUtils未定义');
                    // 创建简单的提示框作为fallback
                    const fallbackModal = document.createElement('div');
                    fallbackModal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                        background: rgba(0,0,0,0.5); z-index: 9999; display: flex;
                        align-items: center; justify-content: center;
                    `;
                    fallbackModal.innerHTML = `
                        <div style="background: white; border-radius: 8px; padding: 20px; max-width: 80vw; max-height: 80vh; overflow: auto;">
                            <button onclick="this.closest('div').parentNode.remove()" style="float: right; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                            <div>${reviewContent}</div>
                        </div>
                    `;
                    document.body.appendChild(fallbackModal);
                }
            } catch (error) {
                console.error('❌ 全面回顾生成失败:', error);
                console.error('❌ 错误堆栈:', error.stack);
                alert('全面回顾出现错误: ' + error.message);
            }
        }

        function analyzeComprehensiveReview(data) {
            console.log('🔍 开始分析全面回顾...');
            
            // 收集所有内容
            const allContent = {
                vision: data.vision || '',
                strategic: data.strategicGoals || '',
                quarter1: data.quarter1Milestones || '',
                quarter2: data.quarter2Milestones || '',
                projects: data.projects || '',
                skills: data.skills || '',
                balance: data.balance || '',
                review: data.review || ''
            };

            // 分析各个维度
            const analysis = {
                overview: generateOverviewAnalysis(allContent),
                goalProgress: analyzeGoalProgress(allContent),
                projectStatus: analyzeProjectStatus(allContent),
                skillDevelopment: analyzeSkillDevelopment(allContent),
                balanceAssessment: analyzeBalanceAssessment(allContent),
                timeManagement: analyzeTimeManagement(allContent),
                achievements: extractAchievements(allContent),
                challenges: extractChallenges(allContent),
                recommendations: generateRecommendations(allContent)
            };

            // 计算综合评分
            const overallScore = calculateOverallScore(analysis);
            
            // 生成总结
            const summary = generateReviewSummary(analysis, overallScore);

            return {
                analysis: analysis,
                overallScore: overallScore,
                summary: summary,
                timestamp: new Date().toISOString()
            };
        }

        function generateOverviewAnalysis(content) {
            const totalWords = Object.values(content).join(' ').split(/\s+/).filter(word => word.length > 0).length;
            const completionRate = calculateCompletionRate(content);
            const contentRichness = Math.min(totalWords / 800, 1) * 100; // 800词为满分
            
            return {
                totalWords: totalWords,
                completionRate: completionRate,
                contentRichness: Math.round(contentRichness),
                planningDepth: assessPlanningDepth(content),
                executionQuality: assessExecutionQuality(content)
            };
        }

        function analyzeGoalProgress(content) {
            const strategicGoals = content.strategic || '';
            const q1Goals = content.quarter1 || '';
            const q2Goals = content.quarter2 || '';
            
            // 分析目标完成情况
            const strategicProgress = calculateTextProgress(strategicGoals);
            const q1Progress = calculateTextProgress(q1Goals);
            const q2Progress = calculateTextProgress(q2Goals);
            
            // 识别关键目标
            const keyGoals = extractKeyGoals(strategicGoals);
            
            return {
                strategic: {
                    progress: strategicProgress,
                    goals: keyGoals.slice(0, 3)
                },
                quarterly: {
                    q1Progress: q1Progress,
                    q2Progress: q2Progress,
                    trend: q2Progress >= q1Progress ? 'improving' : 'declining'
                },
                overallProgress: Math.round((strategicProgress + q1Progress + q2Progress) / 3)
            };
        }

        function analyzeProjectStatus(content) {
            const projects = content.projects || '';
            const projectLines = projects.split('\n').filter(line => line.trim());
            
            const projectAnalysis = projectLines.map(line => {
                const isCompleted = /\[x\]/i.test(line);
                const isInProgress = /\[-\]/.test(line) || (!isCompleted && /\[\s*\]/.test(line));
                const priority = getPriority(line);
                
                return {
                    content: line.replace(/^\[.\]\s*/, '').trim(),
                    status: isCompleted ? 'completed' : (isInProgress ? 'in-progress' : 'planned'),
                    priority: priority
                };
            });

            const completed = projectAnalysis.filter(p => p.status === 'completed').length;
            const inProgress = projectAnalysis.filter(p => p.status === 'in-progress').length;
            const total = projectAnalysis.length;

            return {
                total: total,
                completed: completed,
                inProgress: inProgress,
                planned: total - completed - inProgress,
                completionRate: total > 0 ? Math.round((completed / total) * 100) : 0,
                projects: projectAnalysis.slice(0, 5) // 显示前5个项目
            };
        }

        function analyzeSkillDevelopment(content) {
            const skills = content.skills || '';
            const skillLines = skills.split('\n').filter(line => line.trim());
            
            const skillCategories = {
                technical: 0,
                management: 0,
                communication: 0,
                other: 0
            };

            const skillProgress = skillLines.map(line => {
                const isCompleted = /\[x\]/i.test(line);
                const category = categorizeSkill(line);
                skillCategories[category]++;
                
                return {
                    content: line.replace(/^\[.\]\s*/, '').trim(),
                    status: isCompleted ? 'mastered' : 'learning',
                    category: category
                };
            });

            const masteredCount = skillProgress.filter(s => s.status === 'mastered').length;
            const totalSkills = skillProgress.length;

            return {
                total: totalSkills,
                mastered: masteredCount,
                learning: totalSkills - masteredCount,
                masteryRate: totalSkills > 0 ? Math.round((masteredCount / totalSkills) * 100) : 0,
                categories: skillCategories,
                skills: skillProgress.slice(0, 6)
            };
        }

        function analyzeBalanceAssessment(content) {
            const balance = content.balance || '';
            const balanceScore = calculateBalanceScore(content);
            
            // 分析工作生活平衡的关键词
            const workKeywords = ['工作', '项目', '任务', '会议', '加班'];
            const lifeKeywords = ['家庭', '休息', '运动', '娱乐', '朋友', '健康'];
            
            const workMentions = countKeywords(balance, workKeywords);
            const lifeMentions = countKeywords(balance, lifeKeywords);
            
            return {
                overallScore: balanceScore,
                workFocus: workMentions,
                lifeFocus: lifeMentions,
                balance: lifeMentions > 0 ? Math.round((lifeMentions / (workMentions + lifeMentions)) * 100) : 0,
                assessment: getBalanceAssessment(balanceScore)
            };
        }

        function analyzeTimeManagement(content) {
            const allText = Object.values(content).join(' ');
            
            // 分析时间管理相关词汇
            const timeKeywords = ['计划', '安排', '时间', '日程', '优先级', '效率'];
            const urgencyKeywords = ['紧急', '重要', '优先', '关键', '核心'];
            
            const timeScore = countKeywords(allText, timeKeywords);
            const urgencyScore = countKeywords(allText, urgencyKeywords);
            
            // 分析季度分布
            const q1Length = (content.quarter1 || '').length;
            const q2Length = (content.quarter2 || '').length;
            const timeDistribution = q1Length + q2Length > 0 ? 
                Math.round((q1Length / (q1Length + q2Length)) * 100) : 50;

            return {
                planningAwareness: Math.min(timeScore * 10, 100),
                priorityAwareness: Math.min(urgencyScore * 15, 100),
                timeDistribution: {
                    q1Percentage: timeDistribution,
                    q2Percentage: 100 - timeDistribution,
                    balance: Math.abs(50 - timeDistribution) <= 20 ? 'balanced' : 'unbalanced'
                }
            };
        }

        function extractAchievements(content) {
            const achievements = [];
            const achievementKeywords = ['完成', '达成', '实现', '成功', '突破', '获得', '掌握', '建立'];
            
            Object.entries(content).forEach(([area, text]) => {
                if (!text) return;
                
                const sentences = text.split(/[。！？.!?\n]/).filter(s => s.trim());
                sentences.forEach(sentence => {
                    const hasAchievement = achievementKeywords.some(keyword => 
                        sentence.toLowerCase().includes(keyword.toLowerCase())
                    );
                    
                    if (hasAchievement && sentence.length > 10 && sentence.length < 100) {
                        achievements.push({
                            area: getAreaDisplayName(area),
                            content: sentence.trim(),
                            impact: assessImpact(sentence)
                        });
                    }
                });
            });

            return achievements.sort((a, b) => b.impact - a.impact).slice(0, 6);
        }

        function extractChallenges(content) {
            const challenges = [];
            const challengeKeywords = ['困难', '挑战', '问题', '障碍', '不足', '需要改进', '待提升'];
            
            Object.entries(content).forEach(([area, text]) => {
                if (!text) return;
                
                const sentences = text.split(/[。！？.!?\n]/).filter(s => s.trim());
                sentences.forEach(sentence => {
                    const hasChallenge = challengeKeywords.some(keyword => 
                        sentence.toLowerCase().includes(keyword.toLowerCase())
                    );
                    
                    if (hasChallenge && sentence.length > 10 && sentence.length < 100) {
                        challenges.push({
                            area: getAreaDisplayName(area),
                            content: sentence.trim(),
                            severity: assessSeverity(sentence)
                        });
                    }
                });
            });

            return challenges.sort((a, b) => b.severity - a.severity).slice(0, 5);
        }

        function generateRecommendations(content) {
            const recommendations = [];
            const overview = generateOverviewAnalysis(content);
            const goalProgress = analyzeGoalProgress(content);
            const projectStatus = analyzeProjectStatus(content);
            
            // 基于完成率的建议
            if (overview.completionRate < 50) {
                recommendations.push({
                    category: 'execution',
                    priority: 'high',
                    title: '提升执行效率',
                    suggestion: '当前完成率偏低，建议重新评估目标可行性，采用SMART原则重新制定计划'
                });
            } else if (overview.completionRate > 80) {
                recommendations.push({
                    category: 'growth',
                    priority: 'medium',
                    title: '挑战更高目标',
                    suggestion: '执行效果优秀，可以考虑设定更具挑战性的目标'
                });
            }

            // 基于项目状态的建议
            if (projectStatus.inProgress > projectStatus.completed) {
                recommendations.push({
                    category: 'focus',
                    priority: 'high',
                    title: '聚焦核心项目',
                    suggestion: '进行中的项目较多，建议聚焦最重要的2-3个项目，避免精力分散'
                });
            }

            // 基于内容丰富度的建议
            if (overview.contentRichness < 60) {
                recommendations.push({
                    category: 'planning',
                    priority: 'medium',
                    title: '深化规划内容',
                    suggestion: '计划内容相对简单，建议增加具体的行动步骤和成功标准'
                });
            }

            return recommendations.slice(0, 4);
        }

        function calculateOverallScore(analysis) {
            const weights = {
                completion: 0.3,
                planning: 0.2,
                execution: 0.2,
                balance: 0.15,
                growth: 0.15
            };

            const scores = {
                completion: analysis.overview.completionRate,
                planning: analysis.overview.contentRichness,
                execution: analysis.projectStatus.completionRate,
                balance: analysis.balanceAssessment.overallScore,
                growth: analysis.skillDevelopment.masteryRate
            };

            let totalScore = 0;
            Object.entries(weights).forEach(([key, weight]) => {
                totalScore += (scores[key] || 0) * weight;
            });

            return Math.round(totalScore);
        }

        function generateReviewSummary(analysis, overallScore) {
            let level, description, highlights;
            
            if (overallScore >= 80) {
                level = 'excellent';
                description = '表现优秀，各方面发展均衡';
                highlights = ['执行力强', '规划完整', '持续成长'];
            } else if (overallScore >= 60) {
                level = 'good';
                description = '整体表现良好，有提升空间';
                highlights = ['基础扎实', '方向明确', '稳步推进'];
            } else {
                level = 'developing';
                description = '仍在发展中，需要重点改进';
                highlights = ['有待提升', '需要聚焦', '加强执行'];
            }

            return {
                overallScore: overallScore,
                level: level,
                description: description,
                highlights: highlights,
                keyMetrics: {
                    completion: analysis.overview.completionRate,
                    projects: analysis.projectStatus.completionRate,
                    skills: analysis.skillDevelopment.masteryRate,
                    balance: analysis.balanceAssessment.overallScore
                }
            };
        }

        // 辅助函数
        function calculateCompletionRate(content) {
            let totalTasks = 0;
            let completedTasks = 0;

            Object.values(content).forEach(text => {
                if (!text) return;
                const tasks = (text.match(/\[.\]/g) || []).length;
                const completed = (text.match(/\[x\]/gi) || []).length;
                totalTasks += tasks;
                completedTasks += completed;
            });

            return totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        }

        function calculateTextProgress(text) {
            if (!text) return 0;
            const tasks = (text.match(/\[.\]/g) || []).length;
            const completed = (text.match(/\[x\]/gi) || []).length;
            return tasks > 0 ? Math.round((completed / tasks) * 100) : 0;
        }

        function assessPlanningDepth(content) {
            const totalSentences = Object.values(content).join(' ').split(/[。！？.!?]/).filter(s => s.trim().length > 5).length;
            return Math.min(Math.round(totalSentences / 20 * 100), 100);
        }

        function assessExecutionQuality(content) {
            const allText = Object.values(content).join(' ');
            const executionKeywords = ['完成', '实现', '达成', '执行', '推进'];
            const executionScore = countKeywords(allText, executionKeywords);
            return Math.min(executionScore * 15, 100);
        }

        function extractKeyGoals(strategicText) {
            if (!strategicText) return [];
            return strategicText.split('\n')
                .filter(line => line.trim() && !line.startsWith('#'))
                .slice(0, 5)
                .map(line => line.replace(/^\[.\]\s*/, '').trim());
        }

        function getPriority(text) {
            if (/重要|关键|核心|优先/i.test(text)) return 'high';
            if (/次要|辅助|支持/i.test(text)) return 'low';
            return 'medium';
        }

        function categorizeSkill(skillText) {
            const technical = /技术|编程|开发|系统|工具|软件/i;
            const management = /管理|领导|团队|协调|规划/i;
            const communication = /沟通|表达|演讲|写作|交流/i;
            
            if (technical.test(skillText)) return 'technical';
            if (management.test(skillText)) return 'management';
            if (communication.test(skillText)) return 'communication';
            return 'other';
        }

        function countKeywords(text, keywords) {
            return keywords.reduce((count, keyword) => {
                return count + (text.toLowerCase().split(keyword.toLowerCase()).length - 1);
            }, 0);
        }

        function getBalanceAssessment(score) {
            if (score >= 80) return 'excellent';
            if (score >= 60) return 'good';
            if (score >= 40) return 'fair';
            return 'needs_improvement';
        }

        function getAreaDisplayName(area) {
            const names = {
                vision: '愿景规划',
                strategic: '战略目标',
                quarter1: 'Q1里程碑',
                quarter2: 'Q2里程碑',
                projects: '重点项目',
                skills: '技能发展',
                balance: '工作生活平衡',
                review: '回顾总结'
            };
            return names[area] || area;
        }

        function assessImpact(sentence) {
            const highImpactKeywords = ['重大', '关键', '核心', '突破', '成功'];
            const mediumImpactKeywords = ['完成', '达成', '实现', '提升'];
            
            if (highImpactKeywords.some(keyword => sentence.includes(keyword))) return 5;
            if (mediumImpactKeywords.some(keyword => sentence.includes(keyword))) return 3;
            return 1;
        }

        function assessSeverity(sentence) {
            const highSeverityKeywords = ['严重', '重大', '关键', '紧急'];
            const mediumSeverityKeywords = ['问题', '困难', '挑战', '不足'];
            
            if (highSeverityKeywords.some(keyword => sentence.includes(keyword))) return 5;
            if (mediumSeverityKeywords.some(keyword => sentence.includes(keyword))) return 3;
            return 1;
        }

        function generateComprehensiveReviewHTML(reviewAnalysis) {
            console.log('🎨 开始生成全面回顾HTML...');
            
            if (!reviewAnalysis || !reviewAnalysis.summary) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 16px;">📊</div>
                        <div style="font-size: 1.2em; margin-bottom: 8px;">暂无回顾数据</div>
                        <div style="font-size: 0.9em;">请先填写半年计划的各个部分，然后再生成全面回顾</div>
                    </div>
                `;
            }

            const { analysis, summary, overallScore } = reviewAnalysis;

            return `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6;">
                    <!-- 全面回顾概览 -->
                    <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px; text-align: center;">
                        <div style="font-size: 2.5em; margin-bottom: 12px;">📊</div>
                        <h2 style="margin: 0 0 16px 0; font-size: 1.8em;">半年全面回顾报告</h2>
                        <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 16px; margin-bottom: 16px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 12px 16px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-size: 1.8em; font-weight: bold;">${overallScore}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">综合评分</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 12px 16px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-size: 1.5em; font-weight: bold;">${summary.keyMetrics.completion}%</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">完成率</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 12px 16px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-size: 1.5em; font-weight: bold;">${analysis.achievements.length}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">重要成就</div>
                            </div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-weight: bold; margin-bottom: 4px;">整体评估</div>
                            <div style="font-size: 0.9em; margin-bottom: 8px;">${summary.description}</div>
                            <div style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                                ${summary.highlights.map(highlight => `
                                    <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${highlight}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- 核心指标仪表盘 -->
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">📈</span>
                            </div>
                            <h3 style="margin: 0; color: #1e40af; font-size: 1.3em;">核心指标仪表盘</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div style="background: #f0f9ff; border-radius: 8px; padding: 16px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #0ea5e9; margin-bottom: 4px;">${summary.keyMetrics.completion}%</div>
                                <div style="font-size: 0.9em; color: #0369a1; margin-bottom: 8px;">任务完成率</div>
                                <div style="background: #e0f2fe; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div style="background: #0ea5e9; height: 100%; width: ${summary.keyMetrics.completion}%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="background: #f0fdf4; border-radius: 8px; padding: 16px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #22c55e; margin-bottom: 4px;">${summary.keyMetrics.projects}%</div>
                                <div style="font-size: 0.9em; color: #15803d; margin-bottom: 8px;">项目完成率</div>
                                <div style="background: #dcfce7; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div style="background: #22c55e; height: 100%; width: ${summary.keyMetrics.projects}%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="background: #fef3c7; border-radius: 8px; padding: 16px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #f59e0b; margin-bottom: 4px;">${summary.keyMetrics.skills}%</div>
                                <div style="font-size: 0.9em; color: #d97706; margin-bottom: 8px;">技能掌握率</div>
                                <div style="background: #fef3c7; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div style="background: #f59e0b; height: 100%; width: ${summary.keyMetrics.skills}%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="background: #fdf2f8; border-radius: 8px; padding: 16px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #ec4899; margin-bottom: 4px;">${summary.keyMetrics.balance}%</div>
                                <div style="font-size: 0.9em; color: #be185d; margin-bottom: 8px;">工作生活平衡</div>
                                <div style="background: #fce7f3; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div style="background: #ec4899; height: 100%; width: ${summary.keyMetrics.balance}%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 目标进展分析 -->
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">🎯</span>
                            </div>
                            <h3 style="margin: 0; color: #059669; font-size: 1.3em;">目标进展分析</h3>
                        </div>
                        <div style="display: grid; gap: 16px;">
                            <div style="background: #ecfdf5; border-radius: 8px; padding: 16px;">
                                <div style="font-weight: bold; color: #065f46; margin-bottom: 8px;">战略目标进展: ${analysis.goalProgress.strategic.progress}%</div>
                                <div style="background: #d1fae5; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
                                    <div style="background: #10b981; height: 100%; width: ${analysis.goalProgress.strategic.progress}%; transition: width 0.3s ease;"></div>
                                </div>
                                ${analysis.goalProgress.strategic.goals.length > 0 ? `
                                    <div style="font-size: 0.9em; color: #374151;">
                                        <div style="font-weight: 500; margin-bottom: 6px;">关键目标:</div>
                                        ${analysis.goalProgress.strategic.goals.map(goal => `
                                            <div style="background: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px; border-left: 3px solid #10b981;">
                                                ${goal}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div style="background: #f0f9ff; border-radius: 8px; padding: 16px;">
                                    <div style="font-weight: bold; color: #0c4a6e; margin-bottom: 8px;">Q1进展</div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #0284c7;">${analysis.goalProgress.quarterly.q1Progress}%</div>
                                </div>
                                <div style="background: ${analysis.goalProgress.quarterly.trend === 'improving' ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px; padding: 16px;">
                                    <div style="font-weight: bold; color: ${analysis.goalProgress.quarterly.trend === 'improving' ? '#14532d' : '#991b1b'}; margin-bottom: 8px;">Q2进展</div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: ${analysis.goalProgress.quarterly.trend === 'improving' ? '#16a34a' : '#dc2626'};">
                                        ${analysis.goalProgress.quarterly.q2Progress}%
                                        <span style="font-size: 0.6em; margin-left: 8px;">
                                            ${analysis.goalProgress.quarterly.trend === 'improving' ? '📈' : '📉'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 项目状态概览 -->
                    ${analysis.projectStatus.total > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #8b5cf6; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">📋</span>
                            </div>
                            <h3 style="margin: 0; color: #7c3aed; font-size: 1.3em;">项目状态概览</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px;">
                            <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #16a34a;">${analysis.projectStatus.completed}</div>
                                <div style="font-size: 0.8em; color: #15803d;">已完成</div>
                            </div>
                            <div style="background: #fff7ed; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #ea580c;">${analysis.projectStatus.inProgress}</div>
                                <div style="font-size: 0.8em; color: #c2410c;">进行中</div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #64748b;">${analysis.projectStatus.planned}</div>
                                <div style="font-size: 0.8em; color: #475569;">计划中</div>
                            </div>
                            <div style="background: #ede9fe; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #8b5cf6;">${analysis.projectStatus.total}</div>
                                <div style="font-size: 0.8em; color: #7c3aed;">总项目</div>
                            </div>
                        </div>
                        ${analysis.projectStatus.projects.length > 0 ? `
                            <div style="background: #fafafa; border-radius: 8px; padding: 12px;">
                                <div style="font-weight: 500; margin-bottom: 8px; color: #374151;">主要项目:</div>
                                <div style="display: grid; gap: 6px;">
                                    ${analysis.projectStatus.projects.map(project => `
                                        <div style="background: white; padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between;">
                                            <span style="font-size: 0.9em;">${project.content}</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span style="background: ${project.status === 'completed' ? '#dcfce7' : project.status === 'in-progress' ? '#fed7aa' : '#f1f5f9'}; color: ${project.status === 'completed' ? '#166534' : project.status === 'in-progress' ? '#c2410c' : '#475569'}; padding: 2px 6px; border-radius: 10px; font-size: 0.7em;">
                                                    ${project.status === 'completed' ? '✓ 完成' : project.status === 'in-progress' ? '⏳ 进行中' : '📋 计划'}
                                                </span>
                                                <span style="background: ${project.priority === 'high' ? '#fecaca' : project.priority === 'low' ? '#e5e7eb' : '#fef3c7'}; color: ${project.priority === 'high' ? '#991b1b' : project.priority === 'low' ? '#374151' : '#92400e'}; padding: 2px 6px; border-radius: 10px; font-size: 0.7em;">
                                                    ${project.priority === 'high' ? '🔴' : project.priority === 'low' ? '🟢' : '🟡'}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    <!-- 技能发展评估 -->
                    ${analysis.skillDevelopment.total > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">🎓</span>
                            </div>
                            <h3 style="margin: 0; color: #d97706; font-size: 1.3em;">技能发展评估</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px;">
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #d97706;">${analysis.skillDevelopment.mastered}</div>
                                <div style="font-size: 0.8em; color: #92400e;">已掌握</div>
                            </div>
                            <div style="background: #fef2f2; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #dc2626;">${analysis.skillDevelopment.learning}</div>
                                <div style="font-size: 0.8em; color: #991b1b;">学习中</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #16a34a;">${analysis.skillDevelopment.masteryRate}%</div>
                                <div style="font-size: 0.8em; color: #15803d;">掌握率</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 12px;">
                            <div style="background: #e0f2fe; padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="font-weight: bold; color: #0277bd;">技术: ${analysis.skillDevelopment.categories.technical}</div>
                            </div>
                            <div style="background: #f3e8ff; padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="font-weight: bold; color: #7c3aed;">管理: ${analysis.skillDevelopment.categories.management}</div>
                            </div>
                            <div style="background: #ecfdf5; padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="font-weight: bold; color: #059669;">沟通: ${analysis.skillDevelopment.categories.communication}</div>
                            </div>
                            <div style="background: #f1f5f9; padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="font-weight: bold; color: #64748b;">其他: ${analysis.skillDevelopment.categories.other}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- 重要成就 -->
                    ${analysis.achievements.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #059669; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">🏆</span>
                            </div>
                            <h3 style="margin: 0; color: #047857; font-size: 1.3em;">重要成就 (${analysis.achievements.length}项)</h3>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            ${analysis.achievements.map((achievement, index) => `
                                <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 12px 16px; border-radius: 6px; position: relative;">
                                    <div style="position: absolute; top: 8px; right: 12px; background: #10b981; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold;">
                                        ${index + 1}
                                    </div>
                                    <div style="font-weight: 500; color: #065f46; margin-bottom: 4px; padding-right: 32px;">${achievement.area}</div>
                                    <div style="color: #374151; font-size: 0.95em; padding-right: 32px;">${achievement.content}</div>
                                    <div style="margin-top: 8px; font-size: 0.8em; color: #059669;">
                                        影响程度: ${'⭐'.repeat(Math.min(achievement.impact, 5))}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 挑战与问题 -->
                    ${analysis.challenges.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #dc2626; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">⚠️</span>
                            </div>
                            <h3 style="margin: 0; color: #b91c1c; font-size: 1.3em;">挑战与问题 (${analysis.challenges.length}项)</h3>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            ${analysis.challenges.map(challenge => `
                                <div style="background: #fef2f2; border-left: 4px solid #f87171; padding: 12px 16px; border-radius: 6px;">
                                    <div style="font-weight: 500; color: #b91c1c; margin-bottom: 4px;">${challenge.area}</div>
                                    <div style="color: #374151; font-size: 0.95em;">${challenge.content}</div>
                                    <div style="margin-top: 8px; font-size: 0.8em; color: #dc2626;">
                                        严重程度: ${'🔴'.repeat(Math.min(challenge.severity, 5))}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 改进建议 -->
                    ${analysis.recommendations.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #2563eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">💡</span>
                            </div>
                            <h3 style="margin: 0; color: #1d4ed8; font-size: 1.3em;">改进建议</h3>
                        </div>
                        <div style="display: grid; gap: 16px;">
                            ${analysis.recommendations.map(rec => `
                                <div style="background: #eff6ff; border-radius: 8px; padding: 16px; border-left: 4px solid ${rec.priority === 'high' ? '#dc2626' : rec.priority === 'medium' ? '#f59e0b' : '#10b981'};">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="background: ${rec.priority === 'high' ? '#fecaca' : rec.priority === 'medium' ? '#fef3c7' : '#dcfce7'}; color: ${rec.priority === 'high' ? '#991b1b' : rec.priority === 'medium' ? '#92400e' : '#166534'}; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 8px;">
                                            ${rec.priority === 'high' ? '🔴 高优先级' : rec.priority === 'medium' ? '🟡 中优先级' : '🟢 低优先级'}
                                        </span>
                                        <div style="font-weight: bold; color: #1e40af;">${rec.title}</div>
                                    </div>
                                    <div style="color: #374151; font-size: 0.95em;">${rec.suggestion}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 时间管理分析 -->
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #7c3aed; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">⏰</span>
                            </div>
                            <h3 style="margin: 0; color: #6d28d9; font-size: 1.3em;">时间管理分析</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div style="background: #f3e8ff; border-radius: 8px; padding: 16px; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #7c3aed; margin-bottom: 4px;">${analysis.timeManagement.planningAwareness}%</div>
                                <div style="font-size: 0.9em; color: #6d28d9;">规划意识</div>
                            </div>
                            <div style="background: #ecfdf5; border-radius: 8px; padding: 16px; text-align: center;">
                                <div style="font-size: 1.8em; font-weight: bold; color: #10b981; margin-bottom: 4px;">${analysis.timeManagement.priorityAwareness}%</div>
                                <div style="font-size: 0.9em; color: #059669;">优先级意识</div>
                            </div>
                            <div style="background: ${analysis.timeManagement.timeDistribution.balance === 'balanced' ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px; padding: 16px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: ${analysis.timeManagement.timeDistribution.balance === 'balanced' ? '#16a34a' : '#dc2626'}; margin-bottom: 4px;">
                                    ${analysis.timeManagement.timeDistribution.balance === 'balanced' ? '⚖️ 平衡' : '⚠️ 失衡'}
                                </div>
                                <div style="font-size: 0.9em; color: ${analysis.timeManagement.timeDistribution.balance === 'balanced' ? '#15803d' : '#991b1b'};">时间分配</div>
                                <div style="font-size: 0.8em; margin-top: 4px; color: #6b7280;">
                                    Q1: ${analysis.timeManagement.timeDistribution.q1Percentage}% | Q2: ${analysis.timeManagement.timeDistribution.q2Percentage}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 下阶段展望 -->
                    <div style="background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%); color: white; border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 12px;">🚀</div>
                        <h3 style="margin: 0 0 16px 0; font-size: 1.3em;">下阶段展望</h3>
                        <div style="display: grid; gap: 12px; text-align: left;">
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-weight: bold; margin-bottom: 6px;">🎯 聚焦重点</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">基于当前分析结果，专注于高优先级的改进领域</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-weight: bold; margin-bottom: 6px;">📈 持续优化</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">保持成功做法，改进薄弱环节，建立持续改进机制</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-weight: bold; margin-bottom: 6px;">🔄 定期回顾</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">建立定期回顾机制，及时调整策略和目标</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 经验总结功能
        function generateLessonsLearned() {
            console.log('🔥 开始生成经验总结...');
            try {
                const halfyearKey = `${currentYear}-H${currentHalf}`;
                const currentData = StorageUtils.loadPlan('halfyear', halfyearKey) || {};
                console.log('💡 经验总结-加载的数据:', currentData);
                
                const lessonsAnalysis = analyzeLessonsLearned(currentData);
                console.log('💡 经验分析结果:', lessonsAnalysis);
                
                const lessonsContent = generateLessonsLearnedHTML(lessonsAnalysis);
                console.log('🎨 生成的经验总结HTML长度:', lessonsContent.length);
                
                if (typeof ModalUtils !== 'undefined' && ModalUtils.show) {
                    ModalUtils.show('💡 经验总结报告', lessonsContent, 'large');
                    console.log('✅ 成功显示经验总结模态框');
                } else {
                    console.error('❌ ModalUtils未定义');
                    // 创建简单的提示框作为fallback
                    const fallbackModal = document.createElement('div');
                    fallbackModal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                        background: rgba(0,0,0,0.5); z-index: 9999; display: flex;
                        align-items: center; justify-content: center;
                    `;
                    fallbackModal.innerHTML = `
                        <div style="background: white; border-radius: 8px; padding: 20px; max-width: 80vw; max-height: 80vh; overflow: auto;">
                            <button onclick="this.closest('div').parentNode.remove()" style="float: right; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                            <div>${lessonsContent}</div>
                        </div>
                    `;
                    document.body.appendChild(fallbackModal);
                }
            } catch (error) {
                console.error('❌ 经验总结生成失败:', error);
                console.error('❌ 错误堆栈:', error.stack);
                alert('经验总结出现错误: ' + error.message);
            }
        }

        function analyzeLessonsLearned(data) {
            console.log('🔍 开始分析经验教训...');
            
            // 收集所有内容
            const allContent = {
                strategic: data.strategicGoals || '',
                quarter1: data.quarter1Milestones || '',
                quarter2: data.quarter2Milestones || '',
                projects: data.projects || '',
                skills: data.skills || '',
                balance: data.balance || '',
                review: data.review || ''
            };

            // 分析各个维度的经验
            const experienceAnalysis = {
                successes: extractSuccessExperiences(allContent),
                challenges: extractChallengeExperiences(allContent),
                insights: extractKeyInsights(allContent),
                patterns: identifyPatterns(allContent),
                improvements: suggestImprovements(allContent)
            };

            // 生成核心教训
            const coreGLessons = generateCoreLessons(experienceAnalysis);
            
            // 提取可行动的建议
            const actionableAdvice = generateActionableAdvice(experienceAnalysis);
            
            // 分析成长轨迹
            const growthTrajectory = analyzeGrowthTrajectory(allContent);

            return {
                experience: experienceAnalysis,
                coreGLessons: coreGLessons,
                actionableAdvice: actionableAdvice,
                growthTrajectory: growthTrajectory,
                summary: generateLessonsSummary(experienceAnalysis, coreGLessons)
            };
        }

        function extractSuccessExperiences(content) {
            const successIndicators = [
                '完成', '成功', '达成', '实现', '突破', '优秀', '良好', '提升', '改善', '增长',
                '获得', '掌握', '学会', '建立', '创建', '解决', '克服', '超越', '[x]', '[X]'
            ];

            const successes = [];
            
            Object.entries(content).forEach(([area, text]) => {
                if (!text) return;
                
                const lines = text.split('\n').filter(line => line.trim());
                lines.forEach(line => {
                    const hasSuccess = successIndicators.some(indicator => 
                        line.toLowerCase().includes(indicator.toLowerCase())
                    );
                    
                    if (hasSuccess) {
                        successes.push({
                            area: getAreaName(area),
                            content: line.replace(/^\[.\]\s*/, '').trim(),
                            type: 'success',
                            keywords: successIndicators.filter(indicator => 
                                line.toLowerCase().includes(indicator.toLowerCase())
                            )
                        });
                    }
                });
            });

            return successes.slice(0, 8); // 最多8个成功经验
        }

        function extractChallengeExperiences(content) {
            const challengeIndicators = [
                '困难', '挑战', '问题', '障碍', '延迟', '推迟', '失败', '错误', '不足', '缺乏',
                '需要改进', '待提升', '未完成', '未达到', '不够', '有限', '瓶颈', '阻碍'
            ];

            const challenges = [];
            
            Object.entries(content).forEach(([area, text]) => {
                if (!text) return;
                
                const lines = text.split('\n').filter(line => line.trim());
                lines.forEach(line => {
                    const hasChallenge = challengeIndicators.some(indicator => 
                        line.toLowerCase().includes(indicator.toLowerCase())
                    );
                    
                    if (hasChallenge) {
                        challenges.push({
                            area: getAreaName(area),
                            content: line.replace(/^\[.\]\s*/, '').trim(),
                            type: 'challenge',
                            keywords: challengeIndicators.filter(indicator => 
                                line.toLowerCase().includes(indicator.toLowerCase())
                            )
                        });
                    }
                });
            });

            return challenges.slice(0, 6); // 最多6个挑战经验
        }

        function extractKeyInsights(content) {
            const insights = [];
            
            // 从回顾内容中提取洞察
            const reviewContent = content.review || '';
            if (reviewContent) {
                const sentences = reviewContent.split(/[。！？.!?]/).filter(s => s.trim());
                sentences.forEach(sentence => {
                    if (sentence.length > 10 && sentence.length < 100) {
                        const insightScore = calculateInsightScore(sentence);
                        if (insightScore > 3) {
                            insights.push({
                                content: sentence.trim(),
                                score: insightScore,
                                source: '回顾总结'
                            });
                        }
                    }
                });
            }

            // 从其他内容推导洞察
            const derivedInsights = deriveInsightsFromContent(content);
            insights.push(...derivedInsights);

            return insights.sort((a, b) => b.score - a.score).slice(0, 5);
        }

        function calculateInsightScore(sentence) {
            const insightKeywords = [
                '学到', '意识到', '发现', '理解', '认识到', '体会到', '感悟', '启发',
                '关键', '重要', '核心', '本质', '根本', '深刻', '经验', '教训'
            ];

            let score = 0;
            insightKeywords.forEach(keyword => {
                if (sentence.includes(keyword)) score += 1;
            });

            // 长度适中的句子更可能是有价值的洞察
            if (sentence.length >= 20 && sentence.length <= 80) score += 1;
            
            return score;
        }

        function deriveInsightsFromContent(content) {
            const insights = [];
            
            // 基于完成率推导洞察
            const completionRate = calculateOverallCompletionRate(content);
            if (completionRate > 80) {
                insights.push({
                    content: '执行力强是成功的关键因素，良好的计划执行能力为目标达成提供了保障',
                    score: 4,
                    source: '执行分析'
                });
            } else if (completionRate < 40) {
                insights.push({
                    content: '计划与执行之间存在差距，需要提升目标分解和时间管理能力',
                    score: 4,
                    source: '执行分析'
                });
            }

            // 基于平衡度推导洞察
            const balanceScore = calculateBalanceScore(content);
            if (balanceScore < 50) {
                insights.push({
                    content: '工作生活平衡需要更多关注，全面发展比单一突破更有利于长期成功',
                    score: 3,
                    source: '平衡分析'
                });
            }

            return insights;
        }

        function identifyPatterns(content) {
            const patterns = [];
            
            // 分析时间模式
            const timePatterns = analyzeTimePatterns(content);
            patterns.push(...timePatterns);
            
            // 分析主题模式
            const themePatterns = analyzeThemePatterns(content);
            patterns.push(...themePatterns);
            
            // 分析行为模式
            const behaviorPatterns = analyzeBehaviorPatterns(content);
            patterns.push(...behaviorPatterns);

            return patterns.slice(0, 4);
        }

        function analyzeTimePatterns(content) {
            const patterns = [];
            
            // 检查Q1 vs Q2的差异
            const q1Content = content.quarter1 || '';
            const q2Content = content.quarter2 || '';
            
            if (q1Content.length > q2Content.length * 1.5) {
                patterns.push({
                    type: 'time',
                    pattern: '前期规划详细，后期规划相对简单',
                    insight: '可能存在前松后紧的时间管理模式',
                    suggestion: '建议平衡各阶段的规划深度'
                });
            } else if (q2Content.length > q1Content.length * 1.5) {
                patterns.push({
                    type: 'time',
                    pattern: '后期规划更加详细',
                    insight: '显示出逐步深入的规划习惯',
                    suggestion: '保持这种渐进式的规划方式'
                });
            }

            return patterns;
        }

        function analyzeThemePatterns(content) {
            const patterns = [];
            const allText = Object.values(content).join(' ').toLowerCase();
            
            // 分析主题频次
            const themes = {
                '技术': ['技术', '技能', '学习', '培训', '掌握'],
                '管理': ['管理', '领导', '团队', '协调', '组织'],
                '创新': ['创新', '创意', '改进', '优化', '突破'],
                '效率': ['效率', '优化', '改善', '提升', '加速']
            };

            Object.entries(themes).forEach(([theme, keywords]) => {
                const frequency = keywords.filter(keyword => allText.includes(keyword)).length;
                if (frequency >= 3) {
                    patterns.push({
                        type: 'theme',
                        pattern: `${theme}主题出现频繁`,
                        insight: `${theme}是当前阶段的重点关注领域`,
                        suggestion: `继续深化${theme}方面的发展`
                    });
                }
            });

            return patterns;
        }

        function analyzeBehaviorPatterns(content) {
            const patterns = [];
            const allText = Object.values(content).join(' ').toLowerCase();
            
            // 分析行为倾向
            if (allText.includes('计划') && allText.includes('执行')) {
                patterns.push({
                    type: 'behavior',
                    pattern: '注重计划制定和执行跟进',
                    insight: '具备系统性思维和执行意识',
                    suggestion: '可以进一步优化计划的灵活性'
                });
            }

            if (allText.includes('学习') && allText.includes('实践')) {
                patterns.push({
                    type: 'behavior',
                    pattern: '学以致用的行为模式',
                    insight: '理论与实践结合的学习方式',
                    suggestion: '继续保持并扩大应用范围'
                });
            }

            return patterns;
        }

        function suggestImprovements(content) {
            const improvements = [];
            
            // 基于完成率建议改进
            const completionRate = calculateOverallCompletionRate(content);
            if (completionRate < 60) {
                improvements.push({
                    area: '执行效率',
                    current: '目标完成率偏低',
                    suggestion: '建议采用SMART目标设定法，将大目标分解为可执行的小任务',
                    priority: 'high'
                });
            }

            // 基于内容丰富度建议改进
            const contentRichness = calculateContentRichness(content);
            if (contentRichness < 0.5) {
                improvements.push({
                    area: '规划深度',
                    current: '计划内容相对简单',
                    suggestion: '增加具体的行动步骤、时间节点和成功标准',
                    priority: 'medium'
                });
            }

            // 基于平衡度建议改进
            const balanceScore = calculateBalanceScore(content);
            if (balanceScore < 60) {
                improvements.push({
                    area: '发展平衡',
                    current: '某些维度关注不足',
                    suggestion: '建议制定更全面的发展计划，关注工作生活平衡',
                    priority: 'medium'
                });
            }

            return improvements.slice(0, 3);
        }

        function generateCoreLessons(experienceAnalysis) {
            const lessons = [];
            
            // 从成功经验中提取教训
            if (experienceAnalysis.successes.length > 0) {
                lessons.push({
                    category: 'success',
                    title: '成功要素识别',
                    lesson: '成功的关键在于明确目标、制定计划并坚持执行',
                    evidence: experienceAnalysis.successes.slice(0, 2),
                    applicability: '可应用于未来的目标设定和项目管理'
                });
            }

            // 从挑战中提取教训
            if (experienceAnalysis.challenges.length > 0) {
                lessons.push({
                    category: 'challenge',
                    title: '挑战应对策略',
                    lesson: '面对挑战时，及时调整策略比固守原计划更重要',
                    evidence: experienceAnalysis.challenges.slice(0, 2),
                    applicability: '帮助提升问题解决能力和适应性'
                });
            }

            // 从模式中提取教训
            if (experienceAnalysis.patterns.length > 0) {
                const pattern = experienceAnalysis.patterns[0];
                lessons.push({
                    category: 'pattern',
                    title: '行为模式洞察',
                    lesson: pattern.insight,
                    evidence: [{ content: pattern.pattern }],
                    applicability: pattern.suggestion
                });
            }

            return lessons;
        }

        function generateActionableAdvice(experienceAnalysis) {
            const advice = [];
            
            // 基于成功经验的建议
            advice.push({
                category: '继续保持',
                icon: '✅',
                color: '#4caf50',
                items: [
                    '保持已验证有效的工作方法和习惯',
                    '继续发挥在优势领域的专长',
                    '维持良好的执行节奏和质量标准'
                ]
            });

            // 基于挑战的改进建议
            if (experienceAnalysis.challenges.length > 0) {
                advice.push({
                    category: '重点改进',
                    icon: '🎯',
                    color: '#ff9800',
                    items: experienceAnalysis.improvements.map(imp => imp.suggestion)
                });
            }

            // 基于洞察的发展建议
            advice.push({
                category: '未来发展',
                icon: '🚀',
                color: '#2196f3',
                items: [
                    '基于经验建立个人最佳实践库',
                    '定期回顾和更新工作方法',
                    '将成功经验分享给团队或同行'
                ]
            });

            return advice;
        }

        function analyzeGrowthTrajectory(content) {
            const trajectory = {
                startPoint: '半年计划开始阶段',
                currentPoint: '当前阶段',
                growthAreas: [],
                nextSteps: []
            };

            // 识别成长领域
            const skillsContent = content.skills || '';
            if (skillsContent) {
                const skillLines = skillsContent.split('\n').filter(line => line.trim());
                trajectory.growthAreas = skillLines.slice(0, 3).map(line => 
                    line.replace(/^\[.\]\s*/, '').trim()
                );
            }

            // 建议下一步
            trajectory.nextSteps = [
                '基于当前经验，制定下一阶段的发展重点',
                '建立个人知识管理系统，积累经验资产',
                '寻找新的挑战机会，扩展能力边界'
            ];

            return trajectory;
        }

        function generateLessonsSummary(experienceAnalysis, coreGLessons) {
            const totalExperiences = experienceAnalysis.successes.length + experienceAnalysis.challenges.length;
            const successRate = totalExperiences > 0 ? 
                Math.round((experienceAnalysis.successes.length / totalExperiences) * 100) : 0;

            return {
                totalExperiences: totalExperiences,
                successCount: experienceAnalysis.successes.length,
                challengeCount: experienceAnalysis.challenges.length,
                successRate: successRate,
                keyInsights: experienceAnalysis.insights.length,
                coreGLessonsCount: coreGLessons.length,
                overallAssessment: getOverallAssessment(successRate, experienceAnalysis.insights.length)
            };
        }

        function getOverallAssessment(successRate, insightCount) {
            if (successRate >= 70 && insightCount >= 3) {
                return { level: 'excellent', description: '经验积累丰富，反思深入' };
            } else if (successRate >= 50 && insightCount >= 2) {
                return { level: 'good', description: '有一定经验积累，持续改进中' };
            } else {
                return { level: 'developing', description: '正在积累经验，需要加强反思' };
            }
        }

        function calculateOverallCompletionRate(content) {
            let totalTasks = 0;
            let completedTasks = 0;

            Object.values(content).forEach(text => {
                if (!text) return;
                const tasks = (text.match(/\[.\]/g) || []).length;
                const completed = (text.match(/\[x\]/gi) || []).length;
                totalTasks += tasks;
                completedTasks += completed;
            });

            return totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        }

        function calculateContentRichness(content) {
            const totalWords = Object.values(content).join(' ').split(/\s+/).length;
            return Math.min(totalWords / 500, 1); // 500词为满分
        }

        function calculateBalanceScore(content) {
            const areas = ['strategic', 'projects', 'skills', 'balance'];
            const scores = areas.map(area => {
                const text = content[area] || '';
                return Math.min(text.length / 100, 1); // 100字符为满分
            });
            return Math.round(scores.reduce((sum, score) => sum + score, 0) / areas.length * 100);
        }

        function getAreaName(area) {
            const names = {
                strategic: '战略目标',
                quarter1: 'Q1里程碑',
                quarter2: 'Q2里程碑',
                projects: '重点项目',
                skills: '技能发展',
                balance: '工作生活平衡',
                review: '回顾总结'
            };
            return names[area] || area;
        }

        function generateLessonsLearnedHTML(lessonsAnalysis) {
            console.log('🎨 开始生成经验总结HTML...');
            
            if (!lessonsAnalysis || !lessonsAnalysis.summary) {
                return `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 16px;">💡</div>
                        <div style="font-size: 1.2em; margin-bottom: 8px;">暂无经验数据</div>
                        <div style="font-size: 0.9em;">请先填写半年计划的各个部分，然后再生成经验总结</div>
                    </div>
                `;
            }

            const { summary, experience, coreGLessons, actionableAdvice, growthTrajectory } = lessonsAnalysis;

            return `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6;">
                    <!-- 经验总结概览 -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px; text-align: center;">
                        <div style="font-size: 2.5em; margin-bottom: 12px;">💡</div>
                        <h2 style="margin: 0 0 16px 0; font-size: 1.8em;">经验总结报告</h2>
                        <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 16px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 12px 16px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-size: 1.5em; font-weight: bold;">${summary.totalExperiences}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">总经验数</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 12px 16px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-size: 1.5em; font-weight: bold;">${summary.successRate}%</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">成功率</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 12px 16px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-size: 1.5em; font-weight: bold;">${summary.keyInsights}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">关键洞察</div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-weight: bold; margin-bottom: 4px;">整体评估</div>
                            <div style="font-size: 0.9em;">${summary.overallAssessment.description}</div>
                        </div>
                    </div>

                    <!-- 成功经验分析 -->
                    ${experience.successes.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">✓</span>
                            </div>
                            <h3 style="margin: 0; color: #2e7d32; font-size: 1.3em;">成功经验 (${experience.successes.length}项)</h3>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            ${experience.successes.map(success => `
                                <div style="background: #f1f8e9; border-left: 4px solid #4caf50; padding: 12px 16px; border-radius: 6px;">
                                    <div style="font-weight: 500; color: #2e7d32; margin-bottom: 4px;">${success.area}</div>
                                    <div style="color: #424242; font-size: 0.95em;">${success.content}</div>
                                    ${success.keywords.length > 0 ? `
                                        <div style="margin-top: 8px;">
                                            ${success.keywords.map(keyword => `
                                                <span style="background: #c8e6c9; color: #1b5e20; padding: 2px 6px; border-radius: 12px; font-size: 0.8em; margin-right: 6px;">${keyword}</span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 挑战与教训 -->
                    ${experience.challenges.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #ff9800; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">!</span>
                            </div>
                            <h3 style="margin: 0; color: #ef6c00; font-size: 1.3em;">挑战与教训 (${experience.challenges.length}项)</h3>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            ${experience.challenges.map(challenge => `
                                <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px 16px; border-radius: 6px;">
                                    <div style="font-weight: 500; color: #ef6c00; margin-bottom: 4px;">${challenge.area}</div>
                                    <div style="color: #424242; font-size: 0.95em;">${challenge.content}</div>
                                    ${challenge.keywords.length > 0 ? `
                                        <div style="margin-top: 8px;">
                                            ${challenge.keywords.map(keyword => `
                                                <span style="background: #ffe0b2; color: #bf360c; padding: 2px 6px; border-radius: 12px; font-size: 0.8em; margin-right: 6px;">${keyword}</span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 关键洞察 -->
                    ${experience.insights.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #9c27b0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">💡</span>
                            </div>
                            <h3 style="margin: 0; color: #7b1fa2; font-size: 1.3em;">关键洞察</h3>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            ${experience.insights.map((insight, index) => `
                                <div style="background: #f3e5f5; border-left: 4px solid #9c27b0; padding: 12px 16px; border-radius: 6px; position: relative;">
                                    <div style="position: absolute; top: 8px; right: 12px; background: #9c27b0; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold;">
                                        ${index + 1}
                                    </div>
                                    <div style="color: #424242; font-size: 0.95em; padding-right: 32px;">${insight.content}</div>
                                    <div style="margin-top: 8px; font-size: 0.8em; color: #7b1fa2; opacity: 0.8;">
                                        来源：${insight.source} | 重要性：${'★'.repeat(Math.min(insight.score, 5))}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 核心教训 -->
                    ${coreGLessons.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #e91e63; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">🎯</span>
                            </div>
                            <h3 style="margin: 0; color: #c2185b; font-size: 1.3em;">核心教训</h3>
                        </div>
                        <div style="display: grid; gap: 16px;">
                            ${coreGLessons.map(lesson => `
                                <div style="background: #fce4ec; border-radius: 8px; padding: 16px;">
                                    <div style="font-weight: bold; color: #c2185b; margin-bottom: 8px; font-size: 1.1em;">
                                        ${lesson.title}
                                    </div>
                                    <div style="color: #424242; margin-bottom: 12px; font-style: italic;">
                                        "${lesson.lesson}"
                                    </div>
                                    ${lesson.evidence.length > 0 ? `
                                        <div style="margin-bottom: 12px;">
                                            <div style="font-size: 0.85em; color: #666; margin-bottom: 6px;">支撑证据：</div>
                                            ${lesson.evidence.map(evidence => `
                                                <div style="background: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px; border-left: 3px solid #e91e63;">
                                                    <div style="font-size: 0.9em; color: #424242;">${evidence.content}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    <div style="background: rgba(233, 30, 99, 0.1); padding: 8px 12px; border-radius: 6px; border-left: 3px solid #e91e63;">
                                        <div style="font-size: 0.85em; color: #666; margin-bottom: 2px;">应用价值：</div>
                                        <div style="font-size: 0.9em; color: #424242;">${lesson.applicability}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 行为模式分析 -->
                    ${experience.patterns.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #607d8b; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">📊</span>
                            </div>
                            <h3 style="margin: 0; color: #455a64; font-size: 1.3em;">行为模式分析</h3>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            ${experience.patterns.map(pattern => `
                                <div style="background: #eceff1; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="background: #607d8b; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 8px;">
                                            ${pattern.type === 'time' ? '⏰ 时间' : pattern.type === 'theme' ? '🎯 主题' : '🔄 行为'}
                                        </span>
                                        <div style="font-weight: 500; color: #455a64;">${pattern.pattern}</div>
                                    </div>
                                    <div style="color: #424242; margin-bottom: 8px; font-size: 0.95em;">
                                        💡 洞察：${pattern.insight}
                                    </div>
                                    <div style="background: white; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #607d8b;">
                                        <div style="font-size: 0.9em; color: #424242;">
                                            🎯 建议：${pattern.suggestion}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 可行动建议 -->
                    ${actionableAdvice.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #3f51b5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">🚀</span>
                            </div>
                            <h3 style="margin: 0; color: #303f9f; font-size: 1.3em;">行动建议</h3>
                        </div>
                        <div style="display: grid; gap: 16px;">
                            ${actionableAdvice.map(advice => `
                                <div style="background: #e8eaf6; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                        <span style="font-size: 1.5em; margin-right: 8px;">${advice.icon}</span>
                                        <div style="font-weight: bold; color: ${advice.color}; font-size: 1.1em;">
                                            ${advice.category}
                                        </div>
                                    </div>
                                    <div style="display: grid; gap: 8px;">
                                        ${advice.items.map(item => `
                                            <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid ${advice.color};">
                                                <div style="color: #424242; font-size: 0.95em;">${item}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 成长轨迹 -->
                    ${growthTrajectory && growthTrajectory.growthAreas.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <div style="width: 32px; height: 32px; background: #00bcd4; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: white; font-weight: bold;">📈</span>
                            </div>
                            <h3 style="margin: 0; color: #00acc1; font-size: 1.3em;">成长轨迹</h3>
                        </div>
                        <div style="display: grid; gap: 16px;">
                            <div style="background: #e0f2f1; border-radius: 8px; padding: 16px;">
                                <div style="font-weight: bold; color: #00695c; margin-bottom: 8px;">主要成长领域</div>
                                <div style="display: grid; gap: 6px;">
                                    ${growthTrajectory.growthAreas.map((area, index) => `
                                        <div style="background: white; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #00bcd4;">
                                            <span style="background: #00bcd4; color: white; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8em; margin-right: 8px;">
                                                ${index + 1}
                                            </span>
                                            ${area}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div style="background: #e1f5fe; border-radius: 8px; padding: 16px;">
                                <div style="font-weight: bold; color: #0277bd; margin-bottom: 8px;">下一步发展建议</div>
                                <div style="display: grid; gap: 6px;">
                                    ${growthTrajectory.nextSteps.map((step, index) => `
                                        <div style="background: white; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #03a9f4;">
                                            <span style="background: #03a9f4; color: white; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8em; margin-right: 8px;">
                                                ${index + 1}
                                            </span>
                                            ${step}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- 经验应用指南 -->
                    <div style="background: linear-gradient(135deg, #ff7043 0%, #d84315 100%); color: white; border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 12px;">🎯</div>
                        <h3 style="margin: 0 0 16px 0; font-size: 1.3em;">经验应用指南</h3>
                        <div style="display: grid; gap: 12px; text-align: left;">
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-weight: bold; margin-bottom: 6px;">📚 建立经验库</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">将这些经验整理成个人知识库，定期回顾和更新</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-weight: bold; margin-bottom: 6px;">🔄 持续改进</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">基于教训调整工作方法，将成功经验制度化</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <div style="font-weight: bold; margin-bottom: 6px;">🤝 分享传播</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">与团队分享有价值的经验，形成组织学习</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // === 战略规划功能 ===
        function generateStrategicPlanningGuide() {
            const currentData = getCurrentPlanData();
            const planningGuide = generatePlanningGuidanceContent(currentData);
            
            ModalUtils.show('🧠 战略规划助手', planningGuide, {
                size: 'large',
                buttons: [
                    {
                        text: '应用建议',
                        class: 'btn-main',
                        handler: () => applyStrategicSuggestions(currentData),
                        close: false
                    },
                    {
                        text: '保存模板',
                        class: 'btn-secondary',
                        handler: () => saveStrategicTemplate(),
                        close: false
                    },
                    {
                        text: '关闭',
                        class: 'btn-secondary'
                    }
                ]
            });
        }

        function getCurrentPlanData() {
            const halfyearKey = `${currentYear}-H${currentHalf}`;
            let currentData = StorageUtils.loadPlan('halfyear', halfyearKey);
            
            if (!currentData) {
                currentData = {
                    vision: '',
                    strategicGoals: '',
                    quarter1Milestones: '',
                    quarter2Milestones: '',
                    projects: '',
                    skills: '',
                    balance: '',
                    review: ''
                };
            }
            
            return currentData;
        }

        function generatePlanningGuidanceContent(currentData) {
            const hasVision = currentData.vision && currentData.vision.trim();
            const hasStrategicGoals = currentData.strategicGoals && currentData.strategicGoals.trim();
            const planningStatus = assessPlanningCompleteness(currentData);
            
            return `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <!-- 战略规划概览 -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 12px 0;">🧠 战略规划助手</h3>
                        <p style="margin: 0; opacity: 0.9;">让我们一起制定一个清晰、可执行的半年战略计划</p>
                        <div style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                            <div style="font-size: 0.9em;">规划完整度: <strong>${planningStatus.completeness}%</strong> | 当前阶段: <strong>${planningStatus.stage}</strong></div>
                        </div>
                    </div>

                    <!-- 战略规划步骤 -->
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">📋 战略规划五步法</h4>
                        ${generatePlanningSteps(currentData, planningStatus)}
                    </div>

                    <!-- 当前状态分析 -->
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">🔍 当前规划状态分析</h4>
                        ${generateCurrentStatusAnalysis(currentData)}
                    </div>

                    <!-- 个性化建议 -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">💡 个性化建议</h4>
                        ${generatePersonalizedSuggestions(currentData, planningStatus)}
                    </div>

                    <!-- 战略模板 -->
                    <div style="background: #e8f5e9; border-radius: 12px; padding: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #2e7d32;">📝 推荐的战略框架</h4>
                        ${generateStrategicFrameworks()}
                    </div>
                </div>
            `;
        }

        function assessPlanningCompleteness(data) {
            let score = 0;
            let stage = '准备阶段';
            
            // 愿景 (20分)
            if (data.vision && data.vision.trim()) score += 20;
            
            // 战略目标 (30分)
            if (data.strategicGoals && data.strategicGoals.trim()) score += 30;
            
            // 季度里程碑 (20分)
            if ((data.quarter1Milestones && data.quarter1Milestones.trim()) || 
                (data.quarter2Milestones && data.quarter2Milestones.trim())) score += 20;
            
            // 项目规划 (20分)
            if (data.projects && data.projects.trim()) score += 20;
            
            // 能力发展 (10分)
            if (data.skills && data.skills.trim()) score += 10;
            
            // 确定阶段
            if (score >= 80) stage = '执行阶段';
            else if (score >= 60) stage = '完善阶段';
            else if (score >= 30) stage = '规划阶段';
            else stage = '准备阶段';
            
            return { completeness: score, stage };
        }

        function generatePlanningSteps(data, status) {
            const steps = [
                {
                    title: '1. 明确愿景',
                    description: '设定半年的整体愿景和主题',
                    completed: !!(data.vision && data.vision.trim()),
                    action: '在愿景部分描述你希望在这半年达到的理想状态'
                },
                {
                    title: '2. 设定战略目标',
                    description: '制定2-5个核心战略目标',
                    completed: !!(data.strategicGoals && data.strategicGoals.trim()),
                    action: '使用SMART原则设定具体、可衡量的目标'
                },
                {
                    title: '3. 季度分解',
                    description: '将目标分解为季度里程碑',
                    completed: !!(data.quarter1Milestones && data.quarter1Milestones.trim()) || 
                              !!(data.quarter2Milestones && data.quarter2Milestones.trim()),
                    action: '为每个季度设定关键成果和里程碑'
                },
                {
                    title: '4. 项目规划',
                    description: '确定支撑目标的重点项目',
                    completed: !!(data.projects && data.projects.trim()),
                    action: '列出实现目标所需的具体项目和行动'
                },
                {
                    title: '5. 能力建设',
                    description: '规划必要的能力发展',
                    completed: !!(data.skills && data.skills.trim()),
                    action: '识别并规划完成目标所需的技能提升'
                }
            ];
            
            return steps.map(step => `
                <div style="display: flex; align-items: flex-start; padding: 12px; margin: 8px 0; background: ${step.completed ? '#e8f5e9' : '#fff3e0'}; border-radius: 8px; border-left: 4px solid ${step.completed ? '#4caf50' : '#ff9800'};">
                    <div style="font-size: 1.5em; margin-right: 12px;">${step.completed ? '✅' : '⏳'}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${step.title}</div>
                        <div style="color: #666; font-size: 0.9em; margin-bottom: 8px;">${step.description}</div>
                        ${!step.completed ? `<div style="color: #ff9800; font-size: 0.85em; font-style: italic;">💡 ${step.action}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function generateCurrentStatusAnalysis(data) {
            const analysis = [];
            
            // 愿景分析
            if (data.vision && data.vision.trim()) {
                const visionLength = data.vision.trim().length;
                if (visionLength < 50) {
                    analysis.push('🌟 愿景过于简短，建议扩展为更具体和鼓舞人心的描述');
                } else if (visionLength > 500) {
                    analysis.push('🌟 愿景过于详细，建议精炼为核心要点');
                } else {
                    analysis.push('🌟 愿景长度适中，内容丰富度良好');
                }
            } else {
                analysis.push('⚠️ 缺少愿景设定，这是战略规划的重要起点');
            }
            
            // 目标分析
            if (data.strategicGoals && data.strategicGoals.trim()) {
                const goals = data.strategicGoals.split('\n').filter(line => line.trim() && line.includes('['));
                const goalCount = goals.length;
                
                if (goalCount === 0) {
                    analysis.push('🎯 战略目标区域有内容但缺少具体的目标条目');
                } else if (goalCount <= 2) {
                    analysis.push('🎯 战略目标较少，可以考虑添加更多维度的目标');
                } else if (goalCount > 6) {
                    analysis.push('🎯 战略目标较多，建议聚焦最重要的3-5个核心目标');
                } else {
                    analysis.push('🎯 战略目标数量合理，覆盖面适中');
                }
            } else {
                analysis.push('⚠️ 缺少战略目标，这是执行的核心指导');
            }
            
            // 平衡性分析
            const hasProjects = !!(data.projects && data.projects.trim());
            const hasSkills = !!(data.skills && data.skills.trim());
            const hasBalance = !!(data.balance && data.balance.trim());
            
            const balanceScore = [hasProjects, hasSkills, hasBalance].filter(Boolean).length;
            
            if (balanceScore === 3) {
                analysis.push('⚖️ 规划维度完整，涵盖了项目、能力和生活平衡');
            } else if (balanceScore >= 2) {
                analysis.push('⚖️ 规划维度较为完整，还可以进一步完善');
            } else {
                analysis.push('⚠️ 规划维度单一，建议增加更多维度的考虑');
            }
            
            return analysis.map(item => `
                <div style="padding: 8px 12px; margin: 4px 0; background: white; border-radius: 6px; border-left: 3px solid #2196f3;">
                    ${item}
                </div>
            `).join('');
        }

        function generatePersonalizedSuggestions(data, status) {
            const suggestions = [];
            
            // 基于完整度的建议
            if (status.completeness < 30) {
                suggestions.push('🚀 建议从愿景开始：花15-30分钟思考这半年最想达成的理想状态');
                suggestions.push('🎯 设定优先级：选择最重要的2-3个目标开始规划');
                suggestions.push('📅 制定时间表：为自己设定一个完成规划的截止日期');
            } else if (status.completeness < 60) {
                suggestions.push('📋 深化目标：将现有目标分解为更具体的行动步骤');
                suggestions.push('⏰ 时间分配：为每个目标分配合理的时间和资源');
                suggestions.push('🔗 建立联系：确保各个目标之间的协调性');
            } else if (status.completeness < 80) {
                suggestions.push('🎨 优化表达：让目标描述更加清晰和可衡量');
                suggestions.push('🔍 查漏补缺：检查是否遗漏了重要的发展领域');
                suggestions.push('📊 设定指标：为关键目标建立量化的成功标准');
            } else {
                suggestions.push('🎉 规划很完整！建议定期回顾和调整');
                suggestions.push('📈 持续优化：基于执行情况不断完善计划');
                suggestions.push('🤝 分享经验：考虑与他人分享你的规划方法');
            }
            
            // 基于内容的个性化建议
            if (!(data.vision && data.vision.trim())) {
                suggestions.push('💡 愿景技巧：尝试想象半年后的成功画面，用第一人称描述');
            }
            
            if (!(data.balance && data.balance.trim())) {
                suggestions.push('⚖️ 平衡提醒：不要忘记工作生活平衡，这是可持续发展的关键');
            }
            
            return suggestions.map(suggestion => `
                <div style="padding: 8px 12px; margin: 4px 0; background: white; border-radius: 6px; border-left: 3px solid #4caf50;">
                    ${suggestion}
                </div>
            `).join('');
        }

        function generateStrategicFrameworks() {
            return `
                <div style="display: grid; gap: 16px;">
                    <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <h5 style="margin: 0 0 8px 0; color: #2e7d32;">🎯 OKR框架</h5>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">目标与关键结果法</div>
                        <div style="font-size: 0.85em; color: #999;">
                            • Objective: 定性的目标描述<br>
                            • Key Results: 3-5个量化的关键结果<br>
                            • 适合：注重结果和影响力的目标
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <h5 style="margin: 0 0 8px 0; color: #2e7d32;">🏗️ SMART原则</h5>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">具体、可衡量、可达成、相关、有时限</div>
                        <div style="font-size: 0.85em; color: #999;">
                            • Specific: 目标具体明确<br>
                            • Measurable: 可量化衡量<br>
                            • Achievable: 现实可达成<br>
                            • Relevant: 与愿景相关<br>
                            • Time-bound: 有明确时限
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <h5 style="margin: 0 0 8px 0; color: #2e7d32;">🔄 平衡计分卡</h5>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">四个维度的平衡发展</div>
                        <div style="font-size: 0.85em; color: #999;">
                            • 财务维度: 收入、成本、投资<br>
                            • 客户维度: 满意度、市场份额<br>
                            • 内部流程: 效率、质量提升<br>
                            • 学习成长: 技能、创新能力
                        </div>
                    </div>
                </div>
            `;
        }

        function applyStrategicSuggestions(currentData) {
            // 生成建议的内容填充
            const suggestions = generateContentSuggestions(currentData);
            
            const applyHtml = `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px 0;">🚀 应用战略建议</h3>
                        <p style="margin: 0; opacity: 0.9;">以下是基于您当前情况生成的具体建议内容</p>
                    </div>
                    
                    ${suggestions.map(suggestion => `
                        <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; color: #333;">${suggestion.title}</h4>
                                <button onclick="applySuggestionContent('${suggestion.field}', \`${suggestion.content.replace(/`/g, '\\`')}\`)" 
                                        style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                                    应用到计划
                                </button>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 0.9em; color: #666;">
                                ${suggestion.content.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            ModalUtils.show('🚀 应用建议', applyHtml, 'large');
        }

        function generateContentSuggestions(currentData) {
            const suggestions = [];
            
            // 愿景建议
            if (!(currentData.vision && currentData.vision.trim())) {
                suggestions.push({
                    field: 'halfyear_vision',
                    title: '🌟 半年愿景建议',
                    content: `在这半年中，我将专注于个人和职业的全面发展。我希望在专业技能上取得显著突破，建立更高效的工作方式，同时保持健康的生活节奏。通过明确的目标设定和持续的行动，我将为自己创造更多的可能性和机会。

关键主题：
• 专业技能的深度发展
• 工作效率的系统性提升
• 健康生活习惯的建立
• 人际关系的深化和拓展`
                });
            }
            
            // 战略目标建议
            if (!(currentData.strategicGoals && currentData.strategicGoals.trim())) {
                suggestions.push({
                    field: 'halfyear_strategic_goals',
                    title: '🎯 战略目标建议',
                    content: `[ ] 在核心技能领域达到专家水平，完成3个重要项目
[ ] 建立个人品牌，在行业内获得认可和影响力
[ ] 改善工作生活平衡，每周运动3次，月读2本书
[ ] 扩展职业网络，结识10位行业专家并建立深度联系
[ ] 制定并执行财务规划，实现收入增长或理财目标`
                });
            }
            
            // 项目规划建议
            if (!(currentData.projects && currentData.projects.trim())) {
                suggestions.push({
                    field: 'halfyear_projects',
                    title: '🏗️ 重点项目建议',
                    content: `[ ] 核心技能提升项目：选择1-2个关键技能进行深度学习
[ ] 个人品牌建设项目：开始写作、演讲或内容创作
[ ] 健康管理项目：制定运动计划并建立健康饮食习惯
[ ] 关系建设项目：主动维护重要人际关系，参加行业活动
[ ] 创新探索项目：尝试新的工作方法或业余兴趣`
                });
            }
            
            return suggestions;
        }

        function saveStrategicTemplate() {
            const template = {
                name: '半年战略规划模板',
                timestamp: new Date().toISOString(),
                vision: '在这半年中，我将专注于...',
                strategicGoals: '[ ] 目标1：具体、可衡量的目标\n[ ] 目标2：与愿景对齐的目标\n[ ] 目标3：挑战但可达成的目标',
                projects: '[ ] 项目1：支撑目标的具体项目\n[ ] 项目2：能力建设相关项目\n[ ] 项目3：创新探索项目',
                skills: '专业技能提升计划：\n• 核心技能深化\n• 新技能探索\n• 软技能发展',
                balance: '[ ] 每周运动3次\n[ ] 每月读书2本\n[ ] 定期社交活动\n[ ] 保证充足睡眠'
            };
            
            StorageUtils.setItem('strategic_planning_template', template);
            MessageUtils.success('战略规划模板已保存');
        }

        // === 目标对齐功能 ===
        function generateGoalAlignmentAnalysis() {
            const currentData = getCurrentPlanData();
            const alignmentAnalysis = analyzeGoalAlignment(currentData);
            
            ModalUtils.show('🎯 目标对齐分析', generateAlignmentContent(alignmentAnalysis), {
                size: 'large',
                buttons: [
                    {
                        text: '优化对齐',
                        class: 'btn-main',
                        handler: () => showAlignmentOptimization(alignmentAnalysis),
                        close: false
                    },
                    {
                        text: '生成对齐图',
                        class: 'btn-secondary',
                        handler: () => generateAlignmentChart(alignmentAnalysis),
                        close: false
                    },
                    {
                        text: '关闭',
                        class: 'btn-secondary'
                    }
                ]
            });
        }

        function analyzeGoalAlignment(data) {
            // 提取各层级目标
            const vision = data.vision || '';
            const strategicGoals = extractGoals(data.strategicGoals || '');
            const projects = extractGoals(data.projects || '');
            const q1Milestones = extractGoals(data.quarter1Milestones || '');
            const q2Milestones = extractGoals(data.quarter2Milestones || '');
            const balanceGoals = extractGoals(data.balance || '');
            
            // 分析对齐度
            const alignmentScore = calculateAlignmentScore(vision, strategicGoals, projects, q1Milestones, q2Milestones);
            const consistencyCheck = checkGoalConsistency(strategicGoals, projects, q1Milestones, q2Milestones);
            const coverageAnalysis = analyzeCoverage(strategicGoals, projects, q1Milestones, q2Milestones);
            
            return {
                vision,
                strategicGoals,
                projects,
                q1Milestones,
                q2Milestones,
                balanceGoals,
                alignmentScore,
                consistencyCheck,
                coverageAnalysis,
                recommendations: generateAlignmentRecommendations(alignmentScore, consistencyCheck, coverageAnalysis)
            };
        }

        function extractGoals(content) {
            if (!content) return [];
            return content.split('\n')
                .filter(line => line.trim() && line.includes('['))
                .map(line => {
                    const match = line.match(/\[(.)\]\s*(.*)/);
                    return match ? {
                        completed: match[1].toLowerCase() === 'x',
                        text: match[2].trim(),
                        fullText: line.trim()
                    } : null;
                })
                .filter(goal => goal !== null);
        }

        function calculateAlignmentScore(vision, strategic, projects, q1, q2) {
            let score = 0;
            let maxScore = 0;
            
            // 愿景存在性 (20分)
            maxScore += 20;
            if (vision && vision.trim()) score += 20;
            
            // 战略目标完整性 (30分)
            maxScore += 30;
            if (strategic.length > 0) {
                score += Math.min(30, strategic.length * 10);
            }
            
            // 项目与战略的对齐 (25分)
            maxScore += 25;
            if (projects.length > 0 && strategic.length > 0) {
                score += 25;
            } else if (projects.length > 0 || strategic.length > 0) {
                score += 10;
            }
            
            // 季度里程碑的对齐 (25分)
            maxScore += 25;
            const totalMilestones = q1.length + q2.length;
            if (totalMilestones > 0 && strategic.length > 0) {
                score += 25;
            } else if (totalMilestones > 0 || strategic.length > 0) {
                score += 10;
            }
            
            return Math.round((score / maxScore) * 100);
        }

        function checkGoalConsistency(strategic, projects, q1, q2) {
            const issues = [];
            const strengths = [];
            
            // 检查是否有孤立的项目
            if (projects.length > 0 && strategic.length === 0) {
                issues.push('存在项目但缺少对应的战略目标');
            }
            
            // 检查是否有孤立的里程碑
            const totalMilestones = q1.length + q2.length;
            if (totalMilestones > 0 && strategic.length === 0) {
                issues.push('存在季度里程碑但缺少对应的战略目标');
            }
            
            // 检查数量平衡
            if (strategic.length > 0) {
                const avgProjectsPerGoal = projects.length / strategic.length;
                const avgMilestonesPerGoal = totalMilestones / strategic.length;
                
                if (avgProjectsPerGoal < 1) {
                    issues.push('战略目标缺少足够的支撑项目');
                } else if (avgProjectsPerGoal > 3) {
                    issues.push('单个战略目标的项目过多，可能分散注意力');
                } else {
                    strengths.push('项目与战略目标的数量比例合理');
                }
                
                if (avgMilestonesPerGoal < 2) {
                    issues.push('战略目标缺少足够的季度里程碑');
                } else {
                    strengths.push('季度里程碑覆盖度良好');
                }
            }
            
            // 检查季度平衡
            if (q1.length > 0 || q2.length > 0) {
                const q1Ratio = q1.length / (q1.length + q2.length);
                if (q1Ratio < 0.3 || q1Ratio > 0.7) {
                    issues.push('季度间的里程碑分布不均衡');
                } else {
                    strengths.push('季度间的里程碑分布均衡');
                }
            }
            
            return { issues, strengths };
        }

        function analyzeCoverage(strategic, projects, q1, q2) {
            const coverage = {
                strategicCovered: 0,
                projectsLinked: 0,
                milestonesLinked: 0,
                gaps: []
            };
            
            if (strategic.length > 0) {
                // 简化的覆盖分析（实际应用中可以使用更复杂的文本匹配算法）
                coverage.strategicCovered = strategic.length;
                
                if (projects.length === 0) {
                    coverage.gaps.push('战略目标缺少具体的执行项目');
                }
                
                if (q1.length === 0 && q2.length === 0) {
                    coverage.gaps.push('战略目标缺少季度里程碑分解');
                }
                
                coverage.projectsLinked = Math.min(projects.length, strategic.length);
                coverage.milestonesLinked = Math.min(q1.length + q2.length, strategic.length * 2);
            }
            
            return coverage;
        }

        function generateAlignmentRecommendations(score, consistency, coverage) {
            const recommendations = [];
            
            // 基于对齐分数的建议
            if (score < 40) {
                recommendations.push('🚨 目标对齐度较低，建议重新审视各层级目标的关联性');
                recommendations.push('📋 优先完善战略目标，确保有明确的方向指引');
                recommendations.push('🔗 为每个战略目标至少设计1-2个支撑项目');
            } else if (score < 70) {
                recommendations.push('⚡ 目标对齐度中等，需要进一步优化各层级的连接');
                recommendations.push('📊 检查项目和里程碑是否充分支撑战略目标');
                recommendations.push('🎯 考虑调整或重新表述目标以提高一致性');
            } else {
                recommendations.push('✅ 目标对齐度良好，保持当前的规划结构');
                recommendations.push('🔍 定期检查执行进度，确保实际行动与规划一致');
                recommendations.push('📈 可以考虑设定更具挑战性的目标');
            }
            
            // 基于一致性检查的建议
            consistency.issues.forEach(issue => {
                recommendations.push(`⚠️ ${issue}`);
            });
            
            // 基于覆盖度的建议
            coverage.gaps.forEach(gap => {
                recommendations.push(`🔧 ${gap}`);
            });
            
            return recommendations;
        }

        function generateAlignmentContent(analysis) {
            const { alignmentScore, consistencyCheck, coverageAnalysis, recommendations } = analysis;
            
            return `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <!-- 对齐分析概览 -->
                    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 16px 0;">🎯 目标对齐分析报告</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${alignmentScore}%</div>
                                <div style="opacity: 0.9;">对齐度得分</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${analysis.strategicGoals.length}</div>
                                <div style="opacity: 0.9;">战略目标</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${analysis.projects.length}</div>
                                <div style="opacity: 0.9;">支撑项目</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${analysis.q1Milestones.length + analysis.q2Milestones.length}</div>
                                <div style="opacity: 0.9;">季度里程碑</div>
                            </div>
                        </div>
                    </div>

                    <!-- 层级结构分析 -->
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">🏗️ 目标层级结构</h4>
                        ${generateHierarchyVisualization(analysis)}
                    </div>

                    <!-- 一致性检查 -->
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">🔍 一致性检查</h4>
                        
                        ${consistencyCheck.strengths.length > 0 ? `
                        <div style="margin-bottom: 16px;">
                            <h5 style="color: #4caf50; margin: 0 0 8px 0;">✅ 优势</h5>
                            ${consistencyCheck.strengths.map(strength => `
                                <div style="padding: 6px 12px; background: #e8f5e9; border-radius: 4px; margin: 4px 0; color: #2e7d32;">
                                    ${strength}
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${consistencyCheck.issues.length > 0 ? `
                        <div>
                            <h5 style="color: #f44336; margin: 0 0 8px 0;">⚠️ 需要关注</h5>
                            ${consistencyCheck.issues.map(issue => `
                                <div style="padding: 6px 12px; background: #ffebee; border-radius: 4px; margin: 4px 0; color: #c62828;">
                                    ${issue}
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>

                    <!-- 对齐建议 -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 20px;">
                        <h4 style="margin: 0 0 16px 0; color: #333;">💡 对齐优化建议</h4>
                        ${recommendations.map(rec => `
                            <div style="padding: 8px 12px; background: white; border-radius: 6px; margin: 4px 0; border-left: 3px solid #ff6b6b;">
                                ${rec}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateHierarchyVisualization(analysis) {
            const { vision, strategicGoals, projects, q1Milestones, q2Milestones } = analysis;
            
            return `
                <div style="display: grid; gap: 16px;">
                    <!-- 愿景层 -->
                    <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">🌟 半年愿景</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">
                            ${vision && vision.trim() ? 
                                (vision.length > 100 ? vision.substring(0, 100) + '...' : vision) : 
                                '未设定愿景'}
                        </div>
                    </div>
                    
                    <!-- 战略目标层 -->
                    <div style="background: rgba(33,150,243,0.1); padding: 16px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #1976d2; margin-bottom: 12px;">🎯 战略目标 (${strategicGoals.length}项)</div>
                        <div style="display: grid; gap: 8px;">
                            ${strategicGoals.length > 0 ? 
                                strategicGoals.slice(0, 3).map(goal => `
                                    <div style="background: white; padding: 8px 12px; border-radius: 4px; font-size: 0.9em;">
                                        ${goal.completed ? '✅' : '⏳'} ${goal.text}
                                    </div>
                                `).join('') +
                                (strategicGoals.length > 3 ? `<div style="color: #666; font-size: 0.8em; text-align: center;">...还有${strategicGoals.length - 3}项</div>` : '')
                                : '<div style="color: #999; font-style: italic; text-align: center;">暂无战略目标</div>'
                            }
                        </div>
                    </div>
                    
                    <!-- 项目和里程碑层 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <!-- 重点项目 -->
                        <div style="background: rgba(156,39,176,0.1); padding: 12px; border-radius: 6px;">
                            <div style="font-weight: 600; color: #7b1fa2; margin-bottom: 8px; font-size: 0.9em;">🏗️ 重点项目</div>
                            <div style="color: #333; font-size: 0.8em;">${projects.length}项</div>
                        </div>
                        
                        <!-- Q1里程碑 -->
                        <div style="background: rgba(255,152,0,0.1); padding: 12px; border-radius: 6px;">
                            <div style="font-weight: 600; color: #f57c00; margin-bottom: 8px; font-size: 0.9em;">📅 Q1里程碑</div>
                            <div style="color: #333; font-size: 0.8em;">${q1Milestones.length}项</div>
                        </div>
                        
                        <!-- Q2里程碑 -->
                        <div style="background: rgba(76,175,80,0.1); padding: 12px; border-radius: 6px;">
                            <div style="font-weight: 600; color: #388e3c; margin-bottom: 8px; font-size: 0.9em;">📅 Q2里程碑</div>
                            <div style="color: #333; font-size: 0.8em;">${q2Milestones.length}项</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showAlignmentOptimization(analysis) {
            const optimizationHtml = `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px 0;">🔧 目标对齐优化方案</h3>
                        <p style="margin: 0; opacity: 0.9;">基于分析结果提供的具体优化建议</p>
                    </div>
                    
                    ${generateOptimizationSteps(analysis)}
                </div>
            `;
            
            ModalUtils.show('🔧 对齐优化', optimizationHtml, 'large');
        }

        function generateOptimizationSteps(analysis) {
            const steps = [];
            
            // 基于分析结果生成优化步骤
            if (analysis.strategicGoals.length === 0) {
                steps.push({
                    priority: 'high',
                    title: '第一步：设定战略目标',
                    description: '建立2-5个核心战略目标作为半年规划的基础',
                    action: '在战略目标区域添加具体、可衡量的目标'
                });
            }
            
            if (analysis.projects.length === 0 && analysis.strategicGoals.length > 0) {
                steps.push({
                    priority: 'high',
                    title: '第二步：设计支撑项目',
                    description: '为每个战略目标设计1-2个具体的执行项目',
                    action: '在重点项目区域添加支撑战略目标的具体项目'
                });
            }
            
            if ((analysis.q1Milestones.length + analysis.q2Milestones.length) === 0) {
                steps.push({
                    priority: 'medium',
                    title: '第三步：分解季度里程碑',
                    description: '将目标分解为季度可达成的具体里程碑',
                    action: '在季度里程碑区域设定阶段性成果'
                });
            }
            
            if (analysis.alignmentScore < 70) {
                steps.push({
                    priority: 'medium',
                    title: '第四步：检查目标一致性',
                    description: '确保各层级目标之间的逻辑关联和支撑关系',
                    action: '审查并调整目标表述，提高关联度'
                });
            }
            
            if (steps.length === 0) {
                steps.push({
                    priority: 'low',
                    title: '持续优化',
                    description: '定期回顾和调整目标对齐情况',
                    action: '建立定期回顾机制，保持目标的动态对齐'
                });
            }
            
            return steps.map(step => `
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${step.priority === 'high' ? '#f44336' : step.priority === 'medium' ? '#ff9800' : '#4caf50'};">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <span style="background: ${step.priority === 'high' ? '#f44336' : step.priority === 'medium' ? '#ff9800' : '#4caf50'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 12px;">
                            ${step.priority === 'high' ? '高优先级' : step.priority === 'medium' ? '中优先级' : '低优先级'}
                        </span>
                        <h4 style="margin: 0; color: #333;">${step.title}</h4>
                    </div>
                    <div style="color: #666; margin-bottom: 8px;">${step.description}</div>
                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 0.9em; color: #333;">
                        💡 <strong>具体行动：</strong>${step.action}
                    </div>
                </div>
            `).join('');
        }

        function generateAlignmentChart(analysis) {
            // 这里可以生成一个简单的文本图表
            const chartHtml = `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px 0;">📊 目标对齐关系图</h3>
                        <p style="margin: 0; opacity: 0.9;">可视化展示各层级目标之间的关系</p>
                    </div>
                    
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px;">
                        <div style="text-align: center; font-family: monospace; line-height: 1.8; color: #333;">
                            <div style="color: #667eea; font-weight: bold;">🌟 半年愿景</div>
                            <div>|</div>
                            <div style="color: #2196f3; font-weight: bold;">🎯 战略目标 (${analysis.strategicGoals.length}项)</div>
                            <div>├── 📋 重点项目 (${analysis.projects.length}项)</div>
                            <div>├── 📅 Q1里程碑 (${analysis.q1Milestones.length}项)</div>
                            <div>└── 📅 Q2里程碑 (${analysis.q2Milestones.length}项)</div>
                            <div style="margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                <strong>对齐度评分：${analysis.alignmentScore}/100</strong><br>
                                <div style="background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 8px; overflow: hidden;">
                                    <div style="background: ${analysis.alignmentScore >= 70 ? '#4caf50' : analysis.alignmentScore >= 40 ? '#ff9800' : '#f44336'}; height: 100%; width: ${analysis.alignmentScore}%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            ModalUtils.show('📊 对齐关系图', chartHtml, 'large');
        }

        // === AI助手功能 ===
        function showHalfyearAIAssistant() {
            const aiContent = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <h3 style="color: #667eea; margin-bottom: 16px;">🤖 半年规划AI助手</h3>
                    <p style="color: #666; font-size: 0.95em;">让AI帮助您制定和优化半年计划</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    <button class="ai-feature-btn" onclick="generateVisionSuggestions()">
                        <div class="feature-icon">🌟</div>
                        <div class="feature-title">愿景规划助手</div>
                        <div class="feature-desc">AI协助制定半年愿景</div>
                    </button>
                    
                    <button class="ai-feature-btn" onclick="generateStrategicGoals()">
                        <div class="feature-icon">🎯</div>
                        <div class="feature-title">战略目标生成</div>
                        <div class="feature-desc">智能生成SMART目标</div>
                    </button>
                    
                    <button class="ai-feature-btn" onclick="analyzeHalfyearBalance()">
                        <div class="feature-icon">⚖️</div>
                        <div class="feature-title">平衡度分析</div>
                        <div class="feature-desc">分析工作生活平衡</div>
                    </button>
                    
                    <button class="ai-feature-btn" onclick="generateMilestoneBreakdown()">
                        <div class="feature-icon">📅</div>
                        <div class="feature-title">里程碑分解</div>
                        <div class="feature-desc">智能分解季度目标</div>
                    </button>
                    
                    <button class="ai-feature-btn" onclick="suggestSkillDevelopment()">
                        <div class="feature-icon">📈</div>
                        <div class="feature-title">能力发展建议</div>
                        <div class="feature-desc">个性化学习路径</div>
                    </button>
                    
                    <button class="ai-feature-btn" onclick="generateRiskAssessment()">
                        <div class="feature-icon">🛡️</div>
                        <div class="feature-title">风险评估</div>
                        <div class="feature-desc">识别潜在挑战</div>
                    </button>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="color: #667eea; font-weight: 600; margin-bottom: 8px;">🚀 一键优化</div>
                    <button class="btn-main" onclick="comprehensiveHalfyearOptimization()" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white;">
                        全面优化半年计划
                    </button>
                </div>
                
                <style>
                    .ai-feature-btn {
                        background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9));
                        border: 2px solid #e0e7ff;
                        border-radius: 12px;
                        padding: 20px 16px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                    }
                    .ai-feature-btn:hover {
                        border-color: #667eea;
                        transform: translateY(-3px);
                        box-shadow: 0 8px 24px rgba(102,126,234,0.15);
                        background: linear-gradient(135deg, rgba(255,255,255,1), rgba(248,250,252,1));
                    }
                    .feature-icon { 
                        font-size: 2.2em; 
                        margin-bottom: 12px; 
                        display: block;
                    }
                    .feature-title { 
                        font-weight: 600; 
                        color: #374151; 
                        margin-bottom: 6px; 
                        font-size: 1.05em;
                    }
                    .feature-desc { 
                        font-size: 0.9em; 
                        color: #6b7280; 
                        line-height: 1.4;
                    }
                </style>
            `;
            
            ModalUtils.show('🤖 半年规划AI助手', aiContent, 'large');
        }

        // AI功能实现
        function generateVisionSuggestions() {
            const currentVision = document.getElementById('halfyear_vision').value;
            const currentGoals = getTodoContent('halfyear_strategic_goals');
            
            const suggestions = [
                {
                    title: '🌟 职业发展主导型愿景',
                    content: `在这${currentHalf === 1 ? '上' : '下'}半年，我将专注于职业技能的深度发展和专业影响力的建立。通过系统性的学习和实践，我要在核心专业领域达到新的高度，同时建立个人品牌和行业认知度。

• 成为所在领域的专家级人才
• 建立有影响力的个人品牌
• 扩展高质量的职业网络
• 获得重要的项目成果和认可`
                },
                {
                    title: '⚖️ 平衡发展型愿景',
                    content: `这${currentHalf === 1 ? '上' : '下'}半年，我将追求工作与生活的和谐平衡，在职业发展的同时，不忘个人成长和生活品质的提升。我要建立可持续的生活方式，让每个维度都得到充实的发展。

• 职业技能稳步提升，工作效率优化
• 身体健康和精神状态持续改善
• 人际关系更加深入和有意义
• 培养新的兴趣爱好和生活技能`
                },
                {
                    title: '🚀 突破创新型愿景',
                    content: `在这${currentHalf === 1 ? '上' : '下'}半年，我将勇于突破舒适圈，探索新的可能性和机会。通过创新思维和大胆尝试，我要为自己开拓全新的发展路径和成长空间。

• 尝试新的领域和挑战性项目
• 培养创新思维和解决问题的能力
• 建立多元化的技能组合
• 创造独特的价值和影响力`
                }
            ];
            
            let content = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 16px;">🌟 AI愿景建议</h4>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">
                        基于半年规划的特点，为您推荐以下愿景方向。您可以选择一个作为基础，然后根据个人情况进行调整。
                    </p>
                </div>
            `;
            
            suggestions.forEach((suggestion, index) => {
                content += `
                    <div style="border: 1px solid #e0e7ff; border-radius: 12px; padding: 20px; margin-bottom: 16px; background: linear-gradient(135deg, rgba(102,126,234,0.02), rgba(255,255,255,0.5));">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <h5 style="margin: 0; color: #374151; font-size: 1.1em;">${suggestion.title}</h5>
                            <button onclick="applyVisionSuggestion(\`${suggestion.content.replace(/`/g, '\\`').replace(/\n/g, '\\n')}\`)" 
                                    style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                应用此愿景
                            </button>
                        </div>
                        <div style="color: #6b7280; line-height: 1.6; font-size: 0.95em; white-space: pre-line;">
                            ${suggestion.content}
                        </div>
                    </div>
                `;
            });
            
            content += `
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-top: 20px;">
                    <h5 style="color: #374151; margin: 0 0 8px 0;">💡 个性化定制</h5>
                    <p style="color: #6b7280; font-size: 0.9em; margin: 0;">
                        您也可以将以上建议作为灵感，结合自己的具体情况，制定独特的个人愿景。
                        记住，好的愿景应该既有挑战性又具备可实现性。
                    </p>
                </div>
            `;
            
            ModalUtils.show('🌟 AI愿景建议', content, 'large');
        }

        function generateStrategicGoals() {
            const currentVision = document.getElementById('halfyear_vision').value;
            const currentGoals = getTodoContent('halfyear_strategic_goals');
            
            const goalCategories = [
                {
                    category: '职业发展',
                    icon: '💼',
                    goals: [
                        '完成3个重要项目，提升专业技能和影响力',
                        '获得新的职业认证或技能资质',
                        '建立个人品牌，在行业内获得认可',
                        '扩展职业网络，结识10位行业专家'
                    ]
                },
                {
                    category: '技能提升',
                    icon: '📚',
                    goals: [
                        '掌握2项新的核心技能，达到中级水平',
                        '完成系统性学习计划，阅读12本专业书籍',
                        '参加重要的培训或会议，获得新知识',
                        '建立知识管理系统，提升学习效率'
                    ]
                },
                {
                    category: '健康生活',
                    icon: '🏃',
                    goals: [
                        '建立规律运动习惯，每周运动4次以上',
                        '改善饮食结构，保持健康的生活节奏',
                        '保证充足睡眠，提升身体和精神状态',
                        '学会压力管理，保持心理健康'
                    ]
                },
                {
                    category: '人际关系',
                    icon: '🤝',
                    goals: [
                        '深化重要关系，与家人朋友保持密切联系',
                        '主动参与社交活动，扩展社交圈',
                        '提升沟通技巧，建立更好的人际关系',
                        '参与志愿活动或社区服务，回馈社会'
                    ]
                }
            ];
            
            let content = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #667eea; margin-bottom: 16px;">🎯 AI战略目标生成</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        以下是根据SMART原则生成的战略目标建议。建议选择2-5个目标，确保目标间的平衡和协调。
                    </p>
                </div>
            `;
            
            goalCategories.forEach(category => {
                content += `
                    <div style="border: 1px solid #e0e7ff; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: rgba(102,126,234,0.02);">
                        <h5 style="color: #374151; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            ${category.icon} ${category.category}
                        </h5>
                        <div style="display: grid; gap: 10px;">
                            ${category.goals.map(goal => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; border: 1px solid #f0f0f0;">
                                    <span style="color: #374151; font-size: 0.95em;">[ ] ${goal}</span>
                                    <button onclick="addStrategicGoal('[ ] ${goal}')" 
                                            style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                        添加
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            content += `
                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); padding: 20px; border-radius: 12px; text-align: center;">
                    <h5 style="color: #667eea; margin: 0 0 12px 0;">🚀 一键生成完整目标集</h5>
                    <button onclick="generateBalancedGoalSet()" 
                            style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        生成平衡的目标组合
                    </button>
                </div>
            `;
            
            ModalUtils.show('🎯 AI战略目标生成', content, 'large');
        }

        function analyzeHalfyearBalance() {
            const currentData = getCurrentPlanData();
            const balanceAnalysis = performBalanceAnalysis(currentData);
            
            const content = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #667eea; margin-bottom: 16px;">⚖️ 半年平衡度分析</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        AI分析您的半年计划在各个维度的平衡情况，并提供优化建议。
                    </p>
                </div>
                
                <!-- 平衡度雷达图 -->
                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(255,255,255,0.8)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h5 style="color: #374151; margin: 0 0 16px 0;">📊 各维度平衡评分</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        ${balanceAnalysis.dimensions.map(dim => `
                            <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e0e7ff;">
                                <div style="font-size: 1.8em; margin-bottom: 8px;">${dim.icon}</div>
                                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">${dim.name}</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: ${dim.score >= 80 ? '#10b981' : dim.score >= 60 ? '#f59e0b' : '#ef4444'};">
                                    ${dim.score}%
                                </div>
                                <div style="background: #f3f4f6; height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden;">
                                    <div style="background: ${dim.score >= 80 ? '#10b981' : dim.score >= 60 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${dim.score}%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- 分析洞察 -->
                <div style="background: white; border: 1px solid #e0e7ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #374151; margin: 0 0 16px 0;">🔍 AI洞察分析</h5>
                    <div style="display: grid; gap: 12px;">
                        ${balanceAnalysis.insights.map(insight => `
                            <div style="padding: 12px; background: rgba(102,126,234,0.05); border-radius: 8px; border-left: 4px solid #667eea;">
                                ${insight}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- 优化建议 -->
                <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 12px; padding: 20px;">
                    <h5 style="color: #92400e; margin: 0 0 16px 0;">💡 平衡优化建议</h5>
                    <div style="display: grid; gap: 8px;">
                        ${balanceAnalysis.recommendations.map(rec => `
                            <div style="padding: 8px 12px; background: white; border-radius: 6px;">
                                ${rec}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            ModalUtils.show('⚖️ 半年平衡度分析', content, 'large');
        }

        function generateMilestoneBreakdown() {
            const strategicGoals = getTodoContent('halfyear_strategic_goals');
            const currentQ1 = getTodoContent('quarter1_milestones');
            const currentQ2 = getTodoContent('quarter2_milestones');
            
            if (!strategicGoals.trim()) {
                MessageUtils.info('请先设定战略目标，然后再生成里程碑分解');
                return;
            }
            
            const goals = strategicGoals.split('\n').filter(line => line.trim() && line.includes('['));
            const milestoneBreakdown = generateMilestones(goals);
            
            const content = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #667eea; margin-bottom: 16px;">📅 AI里程碑分解</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        基于您的战略目标，AI为您生成了季度里程碑分解建议。
                    </p>
                </div>
                
                ${milestoneBreakdown.map((breakdown, index) => `
                    <div style="border: 1px solid #e0e7ff; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: rgba(102,126,234,0.02);">
                        <h5 style="color: #374151; margin: 0 0 16px 0;">
                            🎯 目标 ${index + 1}: ${breakdown.goal.replace(/^\[.\]\s*/, '')}
                        </h5>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Q1里程碑 -->
                            <div style="background: rgba(33,150,243,0.1); padding: 16px; border-radius: 8px;">
                                <h6 style="color: #1976d2; margin: 0 0 12px 0;">
                                    🌱 ${currentHalf === 1 ? 'Q1' : 'Q3'} 里程碑
                                </h6>
                                <div style="display: grid; gap: 8px;">
                                    ${breakdown.q1.map(milestone => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px; font-size: 0.9em;">
                                            <span>[ ] ${milestone}</span>
                                            <button onclick="addMilestone('quarter1_milestones', '[ ] ${milestone}')" 
                                                    style="background: #1976d2; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">
                                                添加
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Q2里程碑 -->
                            <div style="background: rgba(255,152,0,0.1); padding: 16px; border-radius: 8px;">
                                <h6 style="color: #f57c00; margin: 0 0 12px 0;">
                                    🚀 ${currentHalf === 1 ? 'Q2' : 'Q4'} 里程碑
                                </h6>
                                <div style="display: grid; gap: 8px;">
                                    ${breakdown.q2.map(milestone => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px; font-size: 0.9em;">
                                            <span>[ ] ${milestone}</span>
                                            <button onclick="addMilestone('quarter2_milestones', '[ ] ${milestone}')" 
                                                    style="background: #f57c00; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 0.8em;">
                                                添加
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
                
                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); padding: 20px; border-radius: 12px; text-align: center;">
                    <button onclick="applyAllMilestones()" 
                            style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 12px;">
                        应用所有里程碑
                    </button>
                    <button onclick="regenerateMilestones()" 
                            style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        重新生成
                    </button>
                </div>
            `;
            
            ModalUtils.show('📅 AI里程碑分解', content, 'large');
        }

        function suggestSkillDevelopment() {
            const currentSkills = document.getElementById('halfyear_skills').value;
            const strategicGoals = getTodoContent('halfyear_strategic_goals');
            
            const skillSuggestions = generateSkillSuggestions(currentSkills, strategicGoals);
            
            const content = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #667eea; margin-bottom: 16px;">📈 AI能力发展建议</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        基于您的战略目标和当前技能状况，AI为您推荐个性化的能力发展路径。
                    </p>
                </div>
                
                ${skillSuggestions.categories.map(category => `
                    <div style="border: 1px solid #e0e7ff; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: rgba(102,126,234,0.02);">
                        <h5 style="color: #374151; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            ${category.icon} ${category.name}
                        </h5>
                        <div style="display: grid; gap: 12px;">
                            ${category.skills.map(skill => `
                                <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #f0f0f0;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                        <h6 style="margin: 0; color: #374151; font-size: 1em;">${skill.name}</h6>
                                        <span style="background: ${skill.priority === 'high' ? '#ef4444' : skill.priority === 'medium' ? '#f59e0b' : '#10b981'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                            ${skill.priority === 'high' ? '高优先级' : skill.priority === 'medium' ? '中优先级' : '低优先级'}
                                        </span>
                                    </div>
                                    <div style="color: #6b7280; font-size: 0.9em; margin-bottom: 12px;">${skill.description}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="color: #374151; font-size: 0.85em;">
                                            📚 ${skill.resources.join(' • ')}
                                        </div>
                                        <button onclick="addSkillToPlan('${skill.name}', '${skill.description}')" 
                                                style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                            添加到计划
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                
                <div style="background: #e0f2fe; border: 1px solid #0288d1; border-radius: 12px; padding: 20px;">
                    <h5 style="color: #01579b; margin: 0 0 12px 0;">🎓 学习路径建议</h5>
                    <div style="color: #01579b; font-size: 0.95em; line-height: 1.6;">
                        ${skillSuggestions.learningPath}
                    </div>
                </div>
            `;
            
            ModalUtils.show('📈 AI能力发展建议', content, 'large');
        }

        function generateRiskAssessment() {
            const currentData = getCurrentPlanData();
            const riskAssessment = analyzeRisks(currentData);
            
            const content = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #667eea; margin-bottom: 16px;">🛡️ AI风险评估</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        AI识别您半年计划中的潜在风险和挑战，并提供应对策略。
                    </p>
                </div>
                
                <!-- 风险等级概览 -->
                <div style="background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(248,113,113,0.05)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h5 style="color: #dc2626; margin: 0 0 16px 0;">⚠️ 风险等级分布</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        <div style="text-align: center; padding: 12px; background: rgba(239,68,68,0.1); border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #dc2626;">${riskAssessment.highRisks.length}</div>
                            <div style="font-size: 0.9em; color: #7f1d1d;">高风险</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #d97706;">${riskAssessment.mediumRisks.length}</div>
                            <div style="font-size: 0.9em; color: #92400e;">中风险</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: rgba(34,197,94,0.1); border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #16a34a;">${riskAssessment.lowRisks.length}</div>
                            <div style="font-size: 0.9em; color: #15803d;">低风险</div>
                        </div>
                    </div>
                </div>
                
                <!-- 详细风险分析 -->
                ${['high', 'medium', 'low'].map(level => {
                    const risks = riskAssessment[level + 'Risks'];
                    const colors = {
                        high: { bg: '#fef2f2', border: '#dc2626', text: '#991b1b' },
                        medium: { bg: '#fffbeb', border: '#d97706', text: '#92400e' },
                        low: { bg: '#f0fdf4', border: '#16a34a', text: '#15803d' }
                    };
                    
                    if (risks.length === 0) return '';
                    
                    return `
                        <div style="background: ${colors[level].bg}; border: 1px solid ${colors[level].border}; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                            <h5 style="color: ${colors[level].text}; margin: 0 0 16px 0;">
                                ${level === 'high' ? '🚨 高风险项' : level === 'medium' ? '⚠️ 中风险项' : '💡 低风险项'}
                            </h5>
                            <div style="display: grid; gap: 12px;">
                                ${risks.map(risk => `
                                    <div style="background: white; padding: 16px; border-radius: 8px;">
                                        <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">${risk.title}</div>
                                        <div style="color: #6b7280; font-size: 0.9em; margin-bottom: 12px;">${risk.description}</div>
                                        <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
                                            <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">应对策略:</div>
                                            <div style="color: #6b7280; font-size: 0.9em;">${risk.mitigation}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
                
                <!-- 风险管理建议 -->
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 12px; padding: 20px;">
                    <h5 style="color: #0c4a6e; margin: 0 0 16px 0;">📋 风险管理建议</h5>
                    <div style="display: grid; gap: 8px;">
                        ${riskAssessment.managementTips.map(tip => `
                            <div style="padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #0ea5e9;">
                                ${tip}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            ModalUtils.show('🛡️ AI风险评估', content, 'large');
        }

        function comprehensiveHalfyearOptimization() {
            const currentData = getCurrentPlanData();
            const optimization = performComprehensiveOptimization(currentData);
            
            const content = `
                <div style="margin-bottom: 24px; text-align: center;">
                    <h4 style="color: #667eea; margin-bottom: 16px;">🚀 全面优化报告</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        AI对您的半年计划进行全面分析和优化，生成个性化改进方案
                    </p>
                </div>
                
                <!-- 优化概览 -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; text-align: center;">
                        <div>
                            <div style="font-size: 1.8em; font-weight: bold;">${optimization.currentScore}</div>
                            <div style="opacity: 0.9; font-size: 0.9em;">当前得分</div>
                        </div>
                        <div>
                            <div style="font-size: 1.8em; font-weight: bold;">${optimization.optimizedScore}</div>
                            <div style="opacity: 0.9; font-size: 0.9em;">优化后得分</div>
                        </div>
                        <div>
                            <div style="font-size: 1.8em; font-weight: bold;">+${optimization.improvement}</div>
                            <div style="opacity: 0.9; font-size: 0.9em;">提升幅度</div>
                        </div>
                    </div>
                </div>
                
                <!-- 优化建议 -->
                ${optimization.categories.map(category => `
                    <div style="background: white; border: 1px solid #e0e7ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h5 style="color: #374151; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            ${category.icon} ${category.name}
                        </h5>
                        <div style="display: grid; gap: 12px;">
                            ${category.optimizations.map(opt => `
                                <div style="background: rgba(102,126,234,0.05); padding: 16px; border-radius: 8px; border-left: 4px solid #667eea;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #374151;">${opt.title}</div>
                                        <span style="background: ${opt.impact === 'high' ? '#10b981' : opt.impact === 'medium' ? '#f59e0b' : '#6b7280'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                            ${opt.impact === 'high' ? '高影响' : opt.impact === 'medium' ? '中影响' : '低影响'}
                                        </span>
                                    </div>
                                    <div style="color: #6b7280; font-size: 0.9em; margin-bottom: 12px;">${opt.description}</div>
                                    <button onclick="applyOptimization('${category.field}', \`${opt.content.replace(/`/g, '\\`')}\`)" 
                                            style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                        应用优化
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                
                <!-- 一键应用 -->
                <div style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.05)); padding: 20px; border-radius: 12px; text-align: center;">
                    <h5 style="color: #059669; margin: 0 0 12px 0;">⚡ 快速优化</h5>
                    <button onclick="applyAllOptimizations()" 
                            style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 12px;">
                        应用所有优化建议
                    </button>
                    <button onclick="exportOptimizationReport()" 
                            style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        导出优化报告
                    </button>
                </div>
            `;
            
            ModalUtils.show('🚀 全面优化方案', content, 'large');
        }

        // 辅助函数
        function applyVisionSuggestion(content) {
            document.getElementById('halfyear_vision').value = content;
            MessageUtils.success('愿景建议已应用');
            ModalUtils.hide();
        }

        function addStrategicGoal(goal) {
            const container = document.getElementById('halfyear_strategic_goals');
            const currentContent = container.textContent || '';
            const newContent = currentContent ? currentContent + '\n' + goal : goal;
            container.textContent = newContent;
            TodoUtils.renderTodos(container);
            MessageUtils.success('目标已添加');
        }

        function generateBalancedGoalSet() {
            const balancedGoals = [
                '[ ] 在核心专业领域完成2个重要项目，提升专业影响力',
                '[ ] 掌握1项新技能，获得相关认证或资质',
                '[ ] 建立规律运动习惯，每周运动3次以上',
                '[ ] 深化重要人际关系，扩展高质量社交网络'
            ];
            
            const container = document.getElementById('halfyear_strategic_goals');
            container.textContent = balancedGoals.join('\n');
            TodoUtils.renderTodos(container);
            MessageUtils.success('平衡目标集已生成');
            ModalUtils.hide();
        }

        function addMilestone(containerId, milestone) {
            const container = document.getElementById(containerId);
            const currentContent = container.textContent || '';
            const newContent = currentContent ? currentContent + '\n' + milestone : milestone;
            container.textContent = newContent;
            TodoUtils.renderTodos(container);
            MessageUtils.success('里程碑已添加');
        }

        function addSkillToPlan(skillName, description) {
            const skillsField = document.getElementById('halfyear_skills');
            const currentContent = skillsField.value;
            const newSkill = `${skillName}：${description}`;
            const newContent = currentContent ? currentContent + '\n• ' + newSkill : '• ' + newSkill;
            skillsField.value = newContent;
            MessageUtils.success('技能已添加到发展计划');
        }

        // 数据分析函数
        function performBalanceAnalysis(data) {
            const dimensions = [
                {
                    name: '职业发展',
                    icon: '💼',
                    score: calculateDimensionScore(data.strategicGoals, ['职业', '工作', '项目', '技能'])
                },
                {
                    name: '健康生活',
                    icon: '🏃',
                    score: calculateDimensionScore(data.balance, ['健康', '运动', '睡眠', '饮食'])
                },
                {
                    name: '学习成长',
                    icon: '📚',
                    score: calculateDimensionScore(data.skills, ['学习', '培训', '阅读', '课程'])
                },
                {
                    name: '人际关系',
                    icon: '🤝',
                    score: calculateDimensionScore(data.balance, ['关系', '社交', '朋友', '家庭'])
                }
            ];
            
            const insights = generateOldBalanceInsights(dimensions);
            const recommendations = generateOldBalanceRecommendations(dimensions);
            
            return { dimensions, insights, recommendations };
        }

        function calculateDimensionScore(content, keywords) {
            if (!content) return 20;
            
            const lowerContent = content.toLowerCase();
            const hasKeywords = keywords.some(keyword => lowerContent.includes(keyword));
            const wordCount = content.split(/\s+/).length;
            
            let score = 40; // 基础分
            if (hasKeywords) score += 30; // 关键词匹配
            if (wordCount > 50) score += 20; // 内容丰富度
            if (content.includes('[x]') || content.includes('[X]')) score += 10; // 有完成项
            
            return Math.min(score, 100);
        }

        function generateOldBalanceInsights(dimensions) {
            const insights = [];
            const avgScore = dimensions.reduce((sum, dim) => sum + dim.score, 0) / dimensions.length;
            
            if (avgScore >= 80) {
                insights.push('🎉 整体平衡度优秀，各维度发展均衡');
            } else if (avgScore >= 60) {
                insights.push('📊 整体平衡度良好，部分维度有提升空间');
            } else {
                insights.push('⚠️ 整体平衡度偏低，需要重点关注薄弱维度');
            }
            
            const minDim = dimensions.reduce((min, dim) => dim.score < min.score ? dim : min);
            const maxDim = dimensions.reduce((max, dim) => dim.score > max.score ? dim : max);
            
            if (maxDim.score - minDim.score > 30) {
                insights.push(`📈 ${maxDim.name}发展较好，建议加强${minDim.name}的规划`);
            }
            
            dimensions.forEach(dim => {
                if (dim.score < 50) {
                    insights.push(`🎯 ${dim.name}维度需要重点关注和改善`);
                }
            });
            
            return insights;
        }

        function generateOldBalanceRecommendations(dimensions) {
            const recommendations = [];
            
            dimensions.forEach(dim => {
                if (dim.score < 60) {
                    switch (dim.name) {
                        case '职业发展':
                            recommendations.push('💼 建议增加具体的职业发展目标和项目规划');
                            break;
                        case '健康生活':
                            recommendations.push('🏃 建议制定运动计划和健康生活习惯');
                            break;
                        case '学习成长':
                            recommendations.push('📚 建议完善学习计划和技能发展路径');
                            break;
                        case '人际关系':
                            recommendations.push('🤝 建议增加社交活动和关系维护计划');
                            break;
                    }
                }
            });
            
            if (recommendations.length === 0) {
                recommendations.push('✅ 当前平衡度良好，继续保持');
                recommendations.push('📈 可以考虑设定更具挑战性的目标');
            }
            
            return recommendations;
        }

        function generateMilestones(goals) {
            return goals.map(goal => {
                const goalText = goal.replace(/^\[.\]\s*/, '');
                
                // 简化的里程碑生成逻辑
                const q1Milestones = [
                    `制定${goalText}的详细执行计划`,
                    `启动相关项目和准备工作`,
                    `完成初期关键任务`
                ];
                
                const q2Milestones = [
                    `推进${goalText}的核心工作`,
                    `评估进展并调整策略`,
                    `完成${goalText}并总结经验`
                ];
                
                return {
                    goal: goal,
                    q1: q1Milestones,
                    q2: q2Milestones
                };
            });
        }

        function generateSkillSuggestions(currentSkills, strategicGoals) {
            const categories = [
                {
                    name: '专业技能',
                    icon: '🔧',
                    skills: [
                        {
                            name: '项目管理',
                            description: '掌握项目管理方法论，提升项目执行效率',
                            priority: 'high',
                            resources: ['PMP认证', '敏捷方法', '项目工具']
                        },
                        {
                            name: '数据分析',
                            description: '提升数据处理和分析能力，支持决策制定',
                            priority: 'medium',
                            resources: ['Excel高级', 'Python', 'Tableau']
                        }
                    ]
                },
                {
                    name: '软技能',
                    icon: '🧠',
                    skills: [
                        {
                            name: '沟通表达',
                            description: '提升口头和书面沟通能力，增强影响力',
                            priority: 'high',
                            resources: ['演讲训练', '写作练习', '反馈收集']
                        },
                        {
                            name: '时间管理',
                            description: '优化时间分配，提高工作效率',
                            priority: 'medium',
                            resources: ['GTD方法', '番茄工作法', '优先级矩阵']
                        }
                    ]
                }
            ];
            
            const learningPath = `
                1. 评估当前技能水平，识别关键差距
                2. 制定分阶段的学习计划，设定具体目标
                3. 选择合适的学习资源和方法
                4. 通过实际项目应用新技能
                5. 定期回顾和调整学习策略
            `;
            
            return { categories, learningPath };
        }

        function analyzeRisks(data) {
            const highRisks = [
                {
                    title: '目标过于宏大',
                    description: '设定的目标可能超出实际能力范围，导致执行困难',
                    mitigation: '将大目标分解为更小的可执行步骤，设定现实的里程碑'
                }
            ];
            
            const mediumRisks = [
                {
                    title: '时间安排紧张',
                    description: '半年时间内要完成的任务较多，可能存在时间冲突',
                    mitigation: '优化优先级排序，为重要任务预留充足时间缓冲'
                }
            ];
            
            const lowRisks = [
                {
                    title: '动机维持挑战',
                    description: '长期目标执行过程中可能出现动机下降',
                    mitigation: '设立阶段性奖励机制，定期回顾成果增强成就感'
                }
            ];
            
            const managementTips = [
                '📅 建立定期回顾机制，及时发现和应对风险',
                '🔄 保持计划的灵活性，根据情况调整目标',
                '💪 建立支持网络，寻求他人的帮助和监督',
                '📊 跟踪关键指标，量化风险管理效果'
            ];
            
            return { highRisks, mediumRisks, lowRisks, managementTips };
        }

        function performComprehensiveOptimization(data) {
            const currentScore = 72; // 简化的当前得分
            const optimizedScore = 88; // 优化后得分
            const improvement = optimizedScore - currentScore;
            
            const categories = [
                {
                    name: '愿景规划',
                    icon: '🌟',
                    field: 'halfyear_vision',
                    optimizations: [
                        {
                            title: '增强愿景的具体性',
                            description: '当前愿景较为抽象，建议增加更具体的成果描述',
                            impact: 'high',
                            content: '在这半年中，我将通过系统性的努力，在职业发展上实现突破性进展...'
                        }
                    ]
                },
                {
                    name: '目标设定',
                    icon: '🎯',
                    field: 'halfyear_strategic_goals',
                    optimizations: [
                        {
                            title: '优化目标的可衡量性',
                            description: '部分目标缺少量化指标，建议增加具体的成功标准',
                            impact: 'high',
                            content: '[ ] 完成3个重要项目，获得客户满意度95%以上的评价'
                        }
                    ]
                }
            ];
            
            return { currentScore, optimizedScore, improvement, categories };
        }

        function applyOptimization(field, content) {
            const element = document.getElementById(field);
            if (element) {
                if (element.tagName === 'TEXTAREA') {
                    element.value = content;
                } else if (element.classList && element.classList.contains('todo-list-container')) {
                    element.textContent = content;
                    TodoUtils.renderTodos(element);
                }
                MessageUtils.success('优化建议已应用');
            }
        }

        // 添加缺失的辅助函数
        function applyAllMilestones() {
            const strategicGoals = getTodoContent('halfyear_strategic_goals');
            if (!strategicGoals.trim()) {
                MessageUtils.info('请先设定战略目标');
                return;
            }
            
            const goals = strategicGoals.split('\n').filter(line => line.trim() && line.includes('['));
            const milestoneBreakdown = generateMilestones(goals);
            
            let q1Content = '';
            let q2Content = '';
            
            milestoneBreakdown.forEach(breakdown => {
                breakdown.q1.forEach(milestone => {
                    q1Content += (q1Content ? '\n' : '') + '[ ] ' + milestone;
                });
                breakdown.q2.forEach(milestone => {
                    q2Content += (q2Content ? '\n' : '') + '[ ] ' + milestone;
                });
            });
            
            const q1Container = document.getElementById('quarter1_milestones');
            const q2Container = document.getElementById('quarter2_milestones');
            
            q1Container.textContent = q1Content;
            q2Container.textContent = q2Content;
            
            TodoUtils.renderTodos(q1Container);
            TodoUtils.renderTodos(q2Container);
            
            MessageUtils.success('所有里程碑已应用');
            ModalUtils.hide();
        }

        function regenerateMilestones() {
            MessageUtils.info('正在重新生成里程碑...');
            setTimeout(() => {
                generateMilestoneBreakdown();
            }, 500);
        }

        function applyAllOptimizations() {
            const currentData = getCurrentPlanData();
            const optimization = performComprehensiveOptimization(currentData);
            
            // 应用愿景优化
            if (optimization.categories[0] && optimization.categories[0].optimizations[0]) {
                const visionOpt = optimization.categories[0].optimizations[0];
                document.getElementById('halfyear_vision').value = visionOpt.content;
            }
            
            // 应用目标优化
            if (optimization.categories[1] && optimization.categories[1].optimizations[0]) {
                const goalOpt = optimization.categories[1].optimizations[0];
                const container = document.getElementById('halfyear_strategic_goals');
                container.textContent = goalOpt.content;
                TodoUtils.renderTodos(container);
            }
            
            MessageUtils.success('所有优化建议已应用');
            ModalUtils.hide();
        }

        function exportOptimizationReport() {
            const currentData = getCurrentPlanData();
            const optimization = performComprehensiveOptimization(currentData);
            
            const reportData = {
                exportDate: new Date().toISOString(),
                period: `${currentYear}年${currentHalf === 1 ? '上' : '下'}半年`,
                optimization: optimization,
                currentData: currentData
            };
            
            ExportUtils.exportToJSON(reportData, `halfyear_optimization_${currentYear}_H${currentHalf}.json`);
            MessageUtils.success('优化报告已导出');
        }

        // 增强智能分析功能
        function generateSmartInsights() {
            const currentData = getCurrentPlanData();
            const insights = performDeepAnalysis(currentData);
            
            const content = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #667eea; margin-bottom: 16px;">🧠 AI深度洞察</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        基于您的半年计划内容，AI提供深度分析和个性化洞察
                    </p>
                </div>
                
                <!-- 整体评估 -->
                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.05)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h5 style="color: #667eea; margin: 0 0 16px 0;">📊 整体评估</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${insights.overallScore}/100</div>
                            <div style="font-size: 0.9em; color: #666;">综合得分</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #10b981;">${insights.strengths.length}</div>
                            <div style="font-size: 0.9em; color: #666;">优势项</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #f59e0b;">${insights.improvements.length}</div>
                            <div style="font-size: 0.9em; color: #666;">改进项</div>
                        </div>
                    </div>
                </div>
                
                <!-- 优势分析 -->
                ${insights.strengths.length > 0 ? `
                <div style="background: #f0fdf4; border: 1px solid #10b981; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #059669; margin: 0 0 16px 0;">✅ 发现的优势</h5>
                    <div style="display: grid; gap: 8px;">
                        ${insights.strengths.map(strength => `
                            <div style="padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #10b981;">
                                ${strength}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- 改进建议 -->
                ${insights.improvements.length > 0 ? `
                <div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #d97706; margin: 0 0 16px 0;">🔧 改进机会</h5>
                    <div style="display: grid; gap: 8px;">
                        ${insights.improvements.map(improvement => `
                            <div style="padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                ${improvement}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- 个性化建议 -->
                <div style="background: #e0f2fe; border: 1px solid #0288d1; border-radius: 12px; padding: 20px;">
                    <h5 style="color: #01579b; margin: 0 0 16px 0;">💡 个性化建议</h5>
                    <div style="display: grid; gap: 8px;">
                        ${insights.personalizedTips.map(tip => `
                            <div style="padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #0288d1;">
                                ${tip}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            ModalUtils.show('🧠 AI深度洞察', content, 'large');
        }

        function performDeepAnalysis(data) {
            const analysis = {
                overallScore: 75,
                strengths: [],
                improvements: [],
                personalizedTips: []
            };
            
            // 分析愿景
            if (data.vision && data.vision.length > 100) {
                analysis.strengths.push('✨ 愿景描述详细，具有很好的指导性');
                analysis.overallScore += 5;
            } else if (data.vision && data.vision.length > 50) {
                analysis.improvements.push('🌟 愿景可以更加具体和鼓舞人心');
            } else {
                analysis.improvements.push('🌟 建议设定清晰的半年愿景作为行动指南');
            }
            
            // 分析战略目标
            const strategicGoals = data.strategicGoals ? data.strategicGoals.split('\n').filter(line => line.includes('[')).length : 0;
            if (strategicGoals >= 3 && strategicGoals <= 5) {
                analysis.strengths.push('🎯 战略目标数量合理，便于聚焦执行');
                analysis.overallScore += 5;
            } else if (strategicGoals > 5) {
                analysis.improvements.push('🎯 战略目标较多，建议聚焦最重要的3-5个');
            } else if (strategicGoals > 0) {
                analysis.improvements.push('🎯 可以增加更多维度的战略目标');
            }
            
            // 分析项目规划
            const projects = data.projects ? data.projects.split('\n').filter(line => line.includes('[')).length : 0;
            if (projects > 0) {
                analysis.strengths.push('🏗️ 有具体的项目规划支撑目标实现');
                analysis.overallScore += 5;
            } else {
                analysis.improvements.push('🏗️ 建议为战略目标设计具体的执行项目');
            }
            
            // 分析技能发展
            if (data.skills && data.skills.length > 100) {
                analysis.strengths.push('📈 技能发展规划详细，有利于能力提升');
                analysis.overallScore += 5;
            } else {
                analysis.improvements.push('📈 建议完善技能发展和学习计划');
            }
            
            // 分析工作生活平衡
            const balanceItems = data.balance ? data.balance.split('\n').filter(line => line.includes('[')).length : 0;
            if (balanceItems > 0) {
                analysis.strengths.push('⚖️ 关注工作生活平衡，有利于可持续发展');
                analysis.overallScore += 5;
            } else {
                analysis.improvements.push('⚖️ 建议增加工作生活平衡的具体措施');
            }
            
            // 生成个性化建议
            analysis.personalizedTips = [
                '📅 建议每月进行一次计划回顾和调整',
                '🎯 为每个目标设定具体的成功指标',
                '📊 建立进度跟踪机制，保持执行动力',
                '🤝 寻找志同道合的伙伴，互相监督支持',
                '🎉 设立里程碑庆祝机制，增强成就感'
            ];
            
            return analysis;
        }

        // AI学习和适应功能
        function adaptivePlanning() {
            const content = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #667eea; margin-bottom: 16px;">🤖 自适应规划</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        AI根据您的使用习惯和反馈，持续优化规划建议
                    </p>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.05)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h5 style="color: #667eea; margin: 0 0 16px 0;">📊 使用模式分析</h5>
                    <div style="display: grid; gap: 12px;">
                        <div style="padding: 12px; background: white; border-radius: 8px;">
                            <strong>偏好的目标类型：</strong> 职业发展导向
                        </div>
                        <div style="padding: 12px; background: white; border-radius: 8px;">
                            <strong>规划风格：</strong> 详细型规划者
                        </div>
                        <div style="padding: 12px; background: white; border-radius: 8px;">
                            <strong>执行特点：</strong> 重视里程碑分解
                        </div>
                    </div>
                </div>
                
                <div style="background: #f0fdf4; border: 1px solid #10b981; border-radius: 12px; padding: 20px;">
                    <h5 style="color: #059669; margin: 0 0 16px 0;">🎯 个性化优化建议</h5>
                    <div style="display: grid; gap: 8px;">
                        <div style="padding: 8px 12px; background: white; border-radius: 6px;">
                            基于您的偏好，建议增加更多职业发展相关的目标
                        </div>
                        <div style="padding: 8px 12px; background: white; border-radius: 6px;">
                            您倾向于详细规划，建议为每个目标制定具体的行动步骤
                        </div>
                        <div style="padding: 8px 12px; background: white; border-radius: 6px;">
                            建议设置更多的中期检查点，符合您的执行风格
                        </div>
                    </div>
                </div>
            `;
            
            ModalUtils.show('🤖 自适应规划', content, 'large');
        }

        // 添加更多AI功能到主界面
        function addAIFeaturesToInterface() {
            // 在AI助手主界面添加更多功能按钮
            const additionalFeatures = `
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e7ff;">
                    <h5 style="color: #667eea; margin: 0 0 16px 0; text-align: center;">🔬 高级AI功能</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <button class="ai-feature-btn" onclick="generateSmartInsights()" style="padding: 16px;">
                            <div class="feature-icon">🧠</div>
                            <div class="feature-title">深度洞察</div>
                            <div class="feature-desc">AI深度分析计划</div>
                        </button>
                        
                        <button class="ai-feature-btn" onclick="adaptivePlanning()" style="padding: 16px;">
                            <div class="feature-icon">🤖</div>
                            <div class="feature-title">自适应规划</div>
                            <div class="feature-desc">个性化优化建议</div>
                        </button>
                        
                        <button class="ai-feature-btn" onclick="generateExecutionPlan()" style="padding: 16px;">
                            <div class="feature-icon">📋</div>
                            <div class="feature-title">执行计划</div>
                            <div class="feature-desc">生成详细执行步骤</div>
                        </button>
                    </div>
                </div>
            `;
            return additionalFeatures;
        }

        // 生成详细执行计划
        function generateExecutionPlan() {
            const currentData = getCurrentPlanData();
            const executionPlan = createDetailedExecutionPlan(currentData);
            
            const content = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #667eea; margin-bottom: 16px;">📋 AI执行计划生成</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        基于您的半年计划，AI为您生成详细的执行路径和时间安排
                    </p>
                </div>
                
                <!-- 执行时间轴 -->
                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(255,255,255,0.8)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h5 style="color: #374151; margin: 0 0 16px 0;">📅 执行时间轴</h5>
                    <div style="position: relative;">
                        ${executionPlan.timeline.map((phase, index) => `
                            <div style="display: flex; align-items: flex-start; margin-bottom: 20px; position: relative;">
                                <div style="flex-shrink: 0; width: 40px; height: 40px; background: ${phase.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 16px; z-index: 2;">
                                    ${index + 1}
                                </div>
                                ${index < executionPlan.timeline.length - 1 ? `
                                    <div style="position: absolute; left: 19px; top: 40px; width: 2px; height: 40px; background: #e0e7ff; z-index: 1;"></div>
                                ` : ''}
                                <div style="flex: 1; background: white; padding: 16px; border-radius: 8px; border: 1px solid #e0e7ff;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <h6 style="margin: 0; color: #374151;">${phase.title}</h6>
                                        <span style="background: ${phase.color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                            ${phase.duration}
                                        </span>
                                    </div>
                                    <div style="color: #6b7280; font-size: 0.9em; margin-bottom: 12px;">${phase.description}</div>
                                    <div style="display: grid; gap: 4px;">
                                        ${phase.tasks.map(task => `
                                            <div style="padding: 4px 8px; background: rgba(102,126,234,0.05); border-radius: 4px; font-size: 0.85em;">
                                                • ${task}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- 关键成功因素 -->
                <div style="background: #f0fdf4; border: 1px solid #10b981; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #059669; margin: 0 0 16px 0;">🔑 关键成功因素</h5>
                    <div style="display: grid; gap: 8px;">
                        ${executionPlan.successFactors.map(factor => `
                            <div style="padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #10b981;">
                                ${factor}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- 风险预警 -->
                <div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 12px; padding: 20px;">
                    <h5 style="color: #d97706; margin: 0 0 16px 0;">⚠️ 风险预警与应对</h5>
                    <div style="display: grid; gap: 8px;">
                        ${executionPlan.riskMitigation.map(risk => `
                            <div style="padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                ${risk}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            ModalUtils.show('📋 AI执行计划', content, 'large');
        }

        function createDetailedExecutionPlan(data) {
            const timeline = [
                {
                    title: '规划确认阶段',
                    duration: '第1周',
                    color: '#667eea',
                    description: '完善和确认半年计划的各项细节',
                    tasks: [
                        '审查和优化愿景表述',
                        '确认战略目标的优先级',
                        '制定详细的里程碑时间表',
                        '准备必要的资源和工具'
                    ]
                },
                {
                    title: '启动实施阶段',
                    duration: '第2-4周',
                    color: '#10b981',
                    description: '开始执行计划并建立工作节奏',
                    tasks: [
                        '启动第一个重点项目',
                        '建立日常和周度回顾机制',
                        '开始技能学习计划',
                        '设立进度跟踪系统'
                    ]
                },
                {
                    title: '深化推进阶段',
                    duration: '第2-4个月',
                    color: '#f59e0b',
                    description: '全面推进各项目标的实施',
                    tasks: [
                        '加速项目执行进度',
                        '深化技能学习和实践',
                        '扩展职业网络建设',
                        '优化工作生活平衡措施'
                    ]
                },
                {
                    title: '冲刺收官阶段',
                    duration: '第5-6个月',
                    color: '#ef4444',
                    description: '冲刺完成目标并总结经验',
                    tasks: [
                        '完成关键项目交付',
                        '达成设定的技能目标',
                        '进行全面的成果评估',
                        '总结经验和最佳实践'
                    ]
                }
            ];
            
            const successFactors = [
                '🎯 保持对核心目标的专注，避免分散注意力',
                '📅 严格执行时间管理，合理分配精力',
                '🔄 建立定期回顾机制，及时调整策略',
                '💪 培养持续学习的习惯，不断提升能力',
                '🤝 积极寻求支持和反馈，建立问责机制'
            ];
            
            const riskMitigation = [
                '⏰ 时间不足风险：预留20%的时间缓冲，优先完成核心目标',
                '🔥 动机下降风险：设立阶段性奖励，定期回顾成果增强信心',
                '📊 目标偏离风险：建立月度检查机制，及时纠偏',
                '🚧 外部干扰风险：制定应急预案，保护核心工作时间',
                '💡 能力不足风险：提前识别技能缺口，寻求学习和帮助'
            ];
            
            return { timeline, successFactors, riskMitigation };
        }

        // 更新AI助手主界面，包含新功能
        function showHalfyearAIAssistantEnhanced() {
            const aiContent = `
                <div style="text-align: center; margin-bottom: 24px;">
                    <h3 style="color: #667eea; margin-bottom: 16px;">🤖 半年规划AI助手</h3>
                    <p style="color: #666; font-size: 0.95em;">让AI帮助您制定和优化半年计划</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    <button class="ai-feature-btn" onclick="generateVisionSuggestions()">
                        <div class="feature-icon">🌟</div>
                        <div class="feature-title">愿景规划助手</div>
                        <div class="feature-desc">AI协助制定半年愿景</div>
                    </button>
                    
                    <button class="ai-feature-btn" onclick="generateStrategicGoals()">
                        <div class="feature-icon">🎯</div>
                        <div class="feature-title">战略目标生成</div>
                        <div class="feature-desc">智能生成SMART目标</div>
                    </button>
                    
                    <button class="ai-feature-btn" onclick="analyzeHalfyearBalance()">
                        <div class="feature-icon">⚖️</div>
                        <div class="feature-title">平衡度分析</div>
                        <div class="feature-desc">分析工作生活平衡</div>
                    </button>
                    
                    <button class="ai-feature-btn" onclick="generateMilestoneBreakdown()">
                        <div class="feature-icon">📅</div>
                        <div class="feature-title">里程碑分解</div>
                        <div class="feature-desc">智能分解季度目标</div>
                    </button>
                    
                    <button class="ai-feature-btn" onclick="suggestSkillDevelopment()">
                        <div class="feature-icon">📈</div>
                        <div class="feature-title">能力发展建议</div>
                        <div class="feature-desc">个性化学习路径</div>
                    </button>
                    
                    <button class="ai-feature-btn" onclick="generateRiskAssessment()">
                        <div class="feature-icon">🛡️</div>
                        <div class="feature-title">风险评估</div>
                        <div class="feature-desc">识别潜在挑战</div>
                    </button>
                </div>
                
                ${addAIFeaturesToInterface()}
                
                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="color: #667eea; font-weight: 600; margin-bottom: 8px;">🚀 一键优化</div>
                    <button class="btn-main" onclick="comprehensiveHalfyearOptimization()" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white;">
                        全面优化半年计划
                    </button>
                </div>
                
                <style>
                    .ai-feature-btn {
                        background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9));
                        border: 2px solid #e0e7ff;
                        border-radius: 12px;
                        padding: 20px 16px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                    }
                    .ai-feature-btn:hover {
                        border-color: #667eea;
                        transform: translateY(-3px);
                        box-shadow: 0 8px 24px rgba(102,126,234,0.15);
                        background: linear-gradient(135deg, rgba(255,255,255,1), rgba(248,250,252,1));
                    }
                    .feature-icon { 
                        font-size: 2.2em; 
                        margin-bottom: 12px; 
                        display: block;
                    }
                    .feature-title { 
                        font-weight: 600; 
                        color: #374151; 
                        margin-bottom: 6px; 
                        font-size: 1.05em;
                    }
                    .feature-desc { 
                        font-size: 0.9em; 
                        color: #6b7280; 
                        line-height: 1.4;
                    }
                </style>
            `;
            
            ModalUtils.show('🤖 半年规划AI助手', aiContent, 'large');
        }

        // === 项目规划功能实现 ===
        function generateProjectPlanningGuide(currentData) {
            const strategicGoals = currentData.strategicGoals || '';
            const currentProjects = currentData.projects || '';
            const projectAnalysis = analyzeCurrentProjects(strategicGoals, currentProjects);
            
            return `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #9c27b0; margin-bottom: 16px;">📋 AI项目规划助手</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        基于您的战略目标，AI为您设计科学的项目规划方案
                    </p>
                </div>
                
                <!-- 项目规划概览 -->
                <div style="background: linear-gradient(135deg, rgba(156,39,176,0.1), rgba(142,36,170,0.05)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h5 style="color: #7b1fa2; margin: 0 0 16px 0;">📊 项目规划状态</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #9c27b0;">${projectAnalysis.currentProjectCount}</div>
                            <div style="font-size: 0.9em; color: #666;">当前项目</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;">${projectAnalysis.recommendedCount}</div>
                            <div style="font-size: 0.9em; color: #666;">建议项目数</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: ${projectAnalysis.balanceScore >= 80 ? '#4caf50' : projectAnalysis.balanceScore >= 60 ? '#ff9800' : '#f44336'};">${projectAnalysis.balanceScore}%</div>
                            <div style="font-size: 0.9em; color: #666;">平衡度评分</div>
                        </div>
                    </div>
                </div>
                
                <!-- 项目分类建议 -->
                <div style="background: white; border: 1px solid #e1bee7; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #7b1fa2; margin: 0 0 16px 0;">🏗️ 项目分类规划</h5>
                    <div style="display: grid; gap: 16px;">
                        ${generateProjectCategories().map(category => `
                            <div style="border: 1px solid #f3e5f5; border-radius: 8px; padding: 16px; background: rgba(156,39,176,0.02);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h6 style="margin: 0; color: #7b1fa2; display: flex; align-items: center; gap: 8px;">
                                        ${category.icon} ${category.name}
                                    </h6>
                                    <span style="background: ${category.priority === 'high' ? '#f44336' : category.priority === 'medium' ? '#ff9800' : '#4caf50'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${category.priority === 'high' ? '高优先级' : category.priority === 'medium' ? '中优先级' : '低优先级'}
                                    </span>
                                </div>
                                <div style="color: #666; font-size: 0.9em; margin-bottom: 12px;">${category.description}</div>
                                <div style="display: grid; gap: 8px;">
                                    ${category.examples.map(example => `
                                        <div style="padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #f0f0f0; font-size: 0.9em;">
                                            📌 ${example}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- 项目管理方法论 -->
                <div style="background: #f3e5f5; border: 1px solid #9c27b0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #7b1fa2; margin: 0 0 16px 0;">📚 推荐项目管理方法</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                        ${generateProjectMethodologies().map(method => `
                            <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e1bee7;">
                                <h6 style="margin: 0 0 8px 0; color: #7b1fa2;">${method.name}</h6>
                                <div style="color: #666; font-size: 0.9em; margin-bottom: 12px;">${method.description}</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="background: rgba(156,39,176,0.1); color: #7b1fa2; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${method.suitableFor}
                                    </span>
                                    <button onclick="learnMoreAbout('${method.id}')" style="background: #9c27b0; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                        了解更多
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- 项目时间安排 -->
                <div style="background: #fff3e0; border: 1px solid #ff9800; border-radius: 12px; padding: 20px;">
                    <h5 style="color: #f57c00; margin: 0 0 16px 0;">⏰ 项目时间安排建议</h5>
                    <div style="display: grid; gap: 12px;">
                        ${generateTimeAllocationSuggestions().map(suggestion => `
                            <div style="padding: 12px; background: white; border-radius: 6px; border-left: 3px solid #ff9800;">
                                <div style="font-weight: 600; color: #f57c00; margin-bottom: 4px;">${suggestion.phase}</div>
                                <div style="color: #666; font-size: 0.9em;">${suggestion.advice}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function analyzeCurrentProjects(strategicGoals, currentProjects) {
            const goalCount = strategicGoals ? strategicGoals.split('\n').filter(line => line.includes('[')).length : 0;
            const projectCount = currentProjects ? currentProjects.split('\n').filter(line => line.includes('[')).length : 0;
            
            const recommendedCount = Math.max(3, Math.min(goalCount * 1.5, 8));
            const balanceScore = goalCount > 0 ? Math.min(100, (projectCount / goalCount) * 60 + 40) : 20;
            
            return {
                currentProjectCount: projectCount,
                recommendedCount: Math.round(recommendedCount),
                balanceScore: Math.round(balanceScore)
            };
        }

        function generateProjectCategories() {
            return [
                {
                    name: '核心业务项目',
                    icon: '🎯',
                    priority: 'high',
                    description: '直接支撑战略目标实现的关键项目',
                    examples: [
                        '提升核心技能的专业项目',
                        '建立个人品牌的内容创作项目',
                        '扩展职业网络的行业参与项目'
                    ]
                },
                {
                    name: '能力建设项目',
                    icon: '📈',
                    priority: 'high',
                    description: '提升个人能力和竞争力的发展性项目',
                    examples: [
                        '系统学习新技能的培训项目',
                        '获得专业认证的考证项目',
                        '建立知识体系的研究项目'
                    ]
                },
                {
                    name: '创新探索项目',
                    icon: '💡',
                    priority: 'medium',
                    description: '探索新机会和可能性的实验性项目',
                    examples: [
                        '尝试新领域的试点项目',
                        '开发副业的孵化项目',
                        '创新方法的实验项目'
                    ]
                },
                {
                    name: '生活优化项目',
                    icon: '⚖️',
                    priority: 'medium',
                    description: '改善生活质量和工作效率的支持性项目',
                    examples: [
                        '建立健康习惯的生活项目',
                        '优化工作流程的效率项目',
                        '改善人际关系的社交项目'
                    ]
                }
            ];
        }

        function generateProjectMethodologies() {
            return [
                {
                    id: 'agile',
                    name: '🔄 敏捷方法',
                    description: '适合需求变化频繁、需要快速迭代的项目',
                    suitableFor: '技能学习项目'
                },
                {
                    id: 'waterfall',
                    name: '📊 瀑布模型',
                    description: '适合需求明确、步骤清晰的传统项目',
                    suitableFor: '认证考试项目'
                },
                {
                    id: 'kanban',
                    name: '📋 看板方法',
                    description: '适合持续性工作、需要可视化管理的项目',
                    suitableFor: '习惯养成项目'
                },
                {
                    id: 'design_thinking',
                    name: '💡 设计思维',
                    description: '适合创新性、以用户为中心的项目',
                    suitableFor: '创新探索项目'
                }
            ];
        }

        function generateTimeAllocationSuggestions() {
            return [
                {
                    phase: '项目启动期 (第1-2周)',
                    advice: '重点进行项目规划、资源准备和团队组建，占用总时间的15-20%'
                },
                {
                    phase: '项目执行期 (第3-20周)',
                    advice: '核心执行阶段，按里程碑推进，占用总时间的60-70%'
                },
                {
                    phase: '项目收尾期 (第21-24周)',
                    advice: '成果交付、经验总结和知识沉淀，占用总时间的10-15%'
                },
                {
                    phase: '缓冲时间 (贯穿全程)',
                    advice: '预留10-15%的时间作为缓冲，应对突发情况和风险'
                }
            ];
        }

        function generateProjectTemplates() {
            const templates = generateProjectTemplateContent();
            
            const content = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #9c27b0; margin-bottom: 16px;">📋 项目模板生成器</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        选择适合的项目模板，快速启动您的半年项目规划
                    </p>
                </div>
                
                <div style="display: grid; gap: 20px;">
                    ${templates.map(template => `
                        <div style="border: 1px solid #e1bee7; border-radius: 12px; padding: 20px; background: rgba(156,39,176,0.02);">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 16px;">
                                <h5 style="margin: 0; color: #7b1fa2; display: flex; align-items: center; gap: 8px;">
                                    ${template.icon} ${template.name}
                                </h5>
                                <button onclick="applyProjectTemplate('${template.id}')" 
                                        style="background: #9c27b0; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                    使用模板
                                </button>
                            </div>
                            <div style="color: #666; font-size: 0.9em; margin-bottom: 16px;">${template.description}</div>
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #f0f0f0;">
                                <div style="font-weight: 600; color: #7b1fa2; margin-bottom: 8px;">项目内容预览:</div>
                                <div style="font-family: monospace; font-size: 0.85em; color: #333; white-space: pre-line;">${template.preview}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            ModalUtils.show('📋 项目模板', content, 'large');
        }

        function generateProjectTemplateContent() {
            return [
                {
                    id: 'skill_development',
                    name: '技能提升项目',
                    icon: '📈',
                    description: '系统性提升专业技能或学习新技能的项目模板',
                    preview: `[ ] 技能评估和学习目标设定
[ ] 制定详细的学习计划和时间表
[ ] 选择学习资源（课程、书籍、实践机会）
[ ] 开始系统性学习和练习
[ ] 进行阶段性测试和评估
[ ] 完成技能认证或项目实战
[ ] 总结学习成果和经验教训`
                },
                {
                    id: 'personal_branding',
                    name: '个人品牌建设',
                    icon: '🌟',
                    description: '建立和提升个人品牌影响力的综合性项目',
                    preview: `[ ] 个人品牌定位和价值主张确定
[ ] 建立专业的在线形象和档案
[ ] 开始定期创作和分享有价值的内容
[ ] 参与行业活动和社区讨论
[ ] 建立专业网络和合作关系
[ ] 收集反馈并优化品牌策略
[ ] 评估品牌影响力和认知度`
                },
                {
                    id: 'health_lifestyle',
                    name: '健康生活方式',
                    icon: '🏃',
                    description: '建立健康的生活习惯和工作生活平衡的项目',
                    preview: `[ ] 制定运动计划并开始执行
[ ] 优化饮食结构和作息时间
[ ] 建立压力管理和放松机制
[ ] 定期体检和健康监测
[ ] 培养有益的业余爱好
[ ] 改善工作环境和效率
[ ] 建立可持续的生活节奏`
                },
                {
                    id: 'career_advancement',
                    name: '职业发展推进',
                    icon: '💼',
                    description: '加速职业发展和晋升机会的战略性项目',
                    preview: `[ ] 职业发展目标和路径规划
[ ] 提升关键职业技能和能力
[ ] 扩展行业网络和导师关系
[ ] 争取重要项目和展示机会
[ ] 建立专业声誉和影响力
[ ] 准备晋升或转岗机会
[ ] 制定职业发展备选方案`
                }
            ];
        }

        function applyProjectTemplate(templateId) {
            const templates = generateProjectTemplateContent();
            const template = templates.find(t => t.id === templateId);
            
            if (template) {
                const container = document.getElementById('halfyear_projects');
                const currentContent = container.textContent || '';
                const newContent = currentContent ? currentContent + '\n\n' + template.preview : template.preview;
                
                container.textContent = newContent;
                TodoUtils.renderTodos(container);
                
                MessageUtils.success(`${template.name}模板已应用到项目规划中`);
                ModalUtils.hide();
            }
        }

        function applyProjectSuggestions() {
            const suggestedProjects = [
                '[ ] 专业技能深化项目：选择1-2个核心技能进行系统提升',
                '[ ] 个人品牌建设项目：建立专业的在线形象和内容创作',
                '[ ] 网络扩展项目：主动参与行业活动，建立高质量职业关系',
                '[ ] 健康管理项目：建立规律运动和健康生活习惯',
                '[ ] 创新探索项目：尝试新的方法、工具或领域'
            ];
            
            const container = document.getElementById('halfyear_projects');
            container.textContent = suggestedProjects.join('\n');
            TodoUtils.renderTodos(container);
            
            MessageUtils.success('项目建议已应用到规划中');
            ModalUtils.hide();
        }

        function learnMoreAbout(methodId) {
            const methodDetails = {
                agile: {
                    title: '🔄 敏捷项目管理',
                    content: `
                        <h5>核心原则：</h5>
                        <ul>
                            <li>个体和互动胜过流程和工具</li>
                            <li>可工作的软件胜过详尽的文档</li>
                            <li>客户合作胜过合同谈判</li>
                            <li>响应变化胜过遵循计划</li>
                        </ul>
                        
                        <h5>适用场景：</h5>
                        <p>技能学习、创新项目、需求频繁变化的项目</p>
                        
                        <h5>实施步骤：</h5>
                        <ol>
                            <li>设定短期目标（1-2周冲刺）</li>
                            <li>每日检查进度和调整计划</li>
                            <li>定期回顾和改进工作方式</li>
                            <li>快速响应变化和反馈</li>
                        </ol>
                    `
                },
                waterfall: {
                    title: '📊 瀑布项目管理',
                    content: `
                        <h5>核心特点：</h5>
                        <ul>
                            <li>线性、顺序的项目执行方式</li>
                            <li>每个阶段完成后才进入下一阶段</li>
                            <li>详细的前期规划和文档</li>
                            <li>明确的里程碑和交付物</li>
                        </ul>
                        
                        <h5>适用场景：</h5>
                        <p>认证考试、技能培训、需求明确的项目</p>
                        
                        <h5>实施步骤：</h5>
                        <ol>
                            <li>需求分析和目标设定</li>
                            <li>详细设计和计划制定</li>
                            <li>按计划执行各个阶段</li>
                            <li>测试验证和成果交付</li>
                        </ol>
                    `
                },
                kanban: {
                    title: '📋 看板项目管理',
                    content: `
                        <h5>核心原则：</h5>
                        <ul>
                            <li>可视化工作流程</li>
                            <li>限制在制品数量</li>
                            <li>管理流动，而非管理人员</li>
                            <li>持续改进</li>
                        </ul>
                        
                        <h5>适用场景：</h5>
                        <p>习惯养成、持续改进、日常工作管理</p>
                        
                        <h5>实施步骤：</h5>
                        <ol>
                            <li>创建看板（待办、进行中、已完成）</li>
                            <li>添加任务卡片到看板</li>
                            <li>设置在制品限制</li>
                            <li>定期回顾和优化流程</li>
                        </ol>
                    `
                },
                design_thinking: {
                    title: '💡 设计思维项目管理',
                    content: `
                        <h5>核心阶段：</h5>
                        <ul>
                            <li>共情（Empathize）：理解用户需求</li>
                            <li>定义（Define）：明确问题定义</li>
                            <li>构思（Ideate）：产生创意解决方案</li>
                            <li>原型（Prototype）：制作原型测试</li>
                            <li>测试（Test）：验证和改进方案</li>
                        </ul>
                        
                        <h5>适用场景：</h5>
                        <p>创新项目、产品开发、用户体验改进</p>
                        
                        <h5>实施步骤：</h5>
                        <ol>
                            <li>深入了解目标用户和需求</li>
                            <li>重新定义问题和挑战</li>
                            <li>头脑风暴产生多个解决方案</li>
                            <li>快速制作原型进行测试</li>
                            <li>根据反馈迭代改进</li>
                        </ol>
                    `
                }
            };
            
            const detail = methodDetails[methodId];
            if (detail) {
                ModalUtils.show(detail.title, detail.content, 'medium');
            }
        }

        // === 资源分配功能实现 ===
        function generateResourceAllocationGuide(currentData) {
            const resourceAnalysis = analyzeResourceRequirements(currentData);
            
            return `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #ef6c00; margin-bottom: 16px;">🎯 智能资源分配助手</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        AI分析您的目标和项目，提供最优的资源分配方案
                    </p>
                </div>
                
                <!-- 资源概览 -->
                <div style="background: linear-gradient(135deg, rgba(239,108,0,0.1), rgba(255,152,0,0.05)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h5 style="color: #ef6c00; margin: 0 0 16px 0;">📊 资源分配概览</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #ef6c00;">${resourceAnalysis.timeAllocation}%</div>
                            <div style="font-size: 0.9em; color: #666;">时间利用率</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;">${resourceAnalysis.balanceScore}</div>
                            <div style="font-size: 0.9em; color: #666;">平衡指数</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: white; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: ${resourceAnalysis.efficiency >= 80 ? '#4caf50' : resourceAnalysis.efficiency >= 60 ? '#ff9800' : '#f44336'};">${resourceAnalysis.efficiency}%</div>
                            <div style="font-size: 0.9em; color: #666;">效率评估</div>
                        </div>
                    </div>
                </div>
                
                <!-- 资源类型分析 -->
                <div style="background: white; border: 1px solid #ffcc02; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #ef6c00; margin: 0 0 16px 0;">🏗️ 资源类型分析</h5>
                    <div style="display: grid; gap: 16px;">
                        ${generateResourceTypes().map(resourceType => `
                            <div style="border: 1px solid #fff3e0; border-radius: 8px; padding: 16px; background: rgba(239,108,0,0.02);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h6 style="margin: 0; color: #ef6c00; display: flex; align-items: center; gap: 8px;">
                                        ${resourceType.icon} ${resourceType.name}
                                    </h6>
                                    <div style="background: ${resourceType.status === 'optimal' ? '#4caf50' : resourceType.status === 'needs_attention' ? '#ff9800' : '#f44336'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${resourceType.status === 'optimal' ? '良好' : resourceType.status === 'needs_attention' ? '需关注' : '不足'}
                                    </div>
                                </div>
                                <div style="color: #666; font-size: 0.9em; margin-bottom: 12px;">${resourceType.description}</div>
                                <div style="display: grid; gap: 8px;">
                                    ${resourceType.recommendations.map(rec => `
                                        <div style="padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #f0f0f0; font-size: 0.9em;">
                                            💡 ${rec}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- 时间分配建议 -->
                <div style="background: #f3e5f5; border: 1px solid #9c27b0; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #7b1fa2; margin: 0 0 16px 0;">⏰ 时间资源分配</h5>
                    <div style="display: grid; gap: 12px;">
                        ${generateTimeAllocation().map(allocation => `
                            <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e1bee7;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <h6 style="margin: 0; color: #7b1fa2;">${allocation.category}</h6>
                                    <span style="background: rgba(156,39,176,0.1); color: #7b1fa2; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${allocation.percentage}%
                                    </span>
                                </div>
                                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                                    <div style="background: #9c27b0; height: 100%; width: ${allocation.percentage}%; transition: width 0.3s ease;"></div>
                                </div>
                                <div style="color: #666; font-size: 0.9em;">${allocation.description}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- 资源优化建议 -->
                <div style="background: #e0f2fe; border: 1px solid #0288d1; border-radius: 12px; padding: 20px;">
                    <h5 style="color: #01579b; margin: 0 0 16px 0;">🔧 资源优化建议</h5>
                    <div style="display: grid; gap: 8px;">
                        ${resourceAnalysis.optimizationTips.map(tip => `
                            <div style="padding: 8px 12px; background: white; border-radius: 6px; border-left: 3px solid #0288d1;">
                                ${tip}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function analyzeResourceRequirements(data) {
            const goalCount = data.strategicGoals ? data.strategicGoals.split('\n').filter(line => line.includes('[')).length : 0;
            const projectCount = data.projects ? data.projects.split('\n').filter(line => line.includes('[')).length : 0;
            
            const timeAllocation = Math.min(100, (goalCount + projectCount) * 12);
            const balanceScore = calculateResourceBalance(data);
            const efficiency = calculateResourceEfficiency(goalCount, projectCount);
            
            const optimizationTips = generateOptimizationTips(timeAllocation, balanceScore, efficiency);
            
            return {
                timeAllocation,
                balanceScore,
                efficiency,
                optimizationTips
            };
        }

        function calculateResourceBalance(data) {
            let score = 50; // 基础分
            
            // 检查各维度是否都有内容
            if (data.strategicGoals && data.strategicGoals.trim()) score += 15;
            if (data.projects && data.projects.trim()) score += 15;
            if (data.skills && data.skills.trim()) score += 10;
            if (data.balance && data.balance.trim()) score += 10;
            
            return Math.min(100, score);
        }

        function calculateResourceEfficiency(goalCount, projectCount) {
            if (goalCount === 0) return 20;
            
            const ratio = projectCount / goalCount;
            if (ratio >= 1 && ratio <= 2) return 90; // 理想比例
            if (ratio >= 0.5 && ratio <= 2.5) return 75; // 良好比例
            if (ratio >= 0.3 && ratio <= 3) return 60; // 可接受比例
            return 40; // 需要调整
        }

        function generateOptimizationTips(timeAllocation, balanceScore, efficiency) {
            const tips = [];
            
            if (timeAllocation < 60) {
                tips.push('⏰ 考虑增加更多具体目标和项目，充分利用半年时间');
            } else if (timeAllocation > 90) {
                tips.push('⚖️ 目标较多，建议优先排序，聚焦最重要的项目');
            }
            
            if (balanceScore < 70) {
                tips.push('📊 建议完善各个维度的规划，保持发展的平衡性');
            }
            
            if (efficiency < 60) {
                tips.push('🎯 项目与目标的匹配度需要优化，确保每个项目都支撑目标实现');
            }
            
            tips.push('📅 建议每月回顾资源使用情况，及时调整分配策略');
            tips.push('💪 预留20%的时间作为缓冲，应对突发情况');
            
            return tips;
        }

        function generateResourceTypes() {
            return [
                {
                    name: '时间资源',
                    icon: '⏰',
                    status: 'needs_attention',
                    description: '半年约180天，需要合理分配工作和学习时间',
                    recommendations: [
                        '建议将60%时间投入核心目标',
                        '预留20%时间用于技能提升',
                        '保留20%缓冲时间应对变化'
                    ]
                },
                {
                    name: '精力资源',
                    icon: '💪',
                    status: 'optimal',
                    description: '个人精力和注意力的合理分配',
                    recommendations: [
                        '在精力最充沛时处理重要任务',
                        '避免同时推进过多项目',
                        '定期休息和恢复精力'
                    ]
                },
                {
                    name: '学习资源',
                    icon: '📚',
                    status: 'needs_attention',
                    description: '知识获取和技能提升所需的资源',
                    recommendations: [
                        '选择高质量的学习材料和课程',
                        '寻找实践机会巩固学习成果',
                        '建立知识分享和交流网络'
                    ]
                },
                {
                    name: '人际资源',
                    icon: '🤝',
                    status: 'needs_attention',
                    description: '人际关系和社交网络的建设维护',
                    recommendations: [
                        '主动维护重要的职业关系',
                        '参与行业活动扩展网络',
                        '寻找导师和合作伙伴'
                    ]
                }
            ];
        }

        function generateTimeAllocation() {
            return [
                {
                    category: '核心目标推进',
                    percentage: 40,
                    description: '专注于最重要的战略目标实现'
                },
                {
                    category: '技能能力提升',
                    percentage: 25,
                    description: '投资于长期能力建设和学习'
                },
                {
                    category: '项目执行',
                    percentage: 20,
                    description: '具体项目的实施和推进'
                },
                {
                    category: '生活平衡',
                    percentage: 15,
                    description: '维护健康和工作生活平衡'
                }
            ];
        }

        function optimizeResourceAllocation() {
            const optimizedAllocation = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #ef6c00; margin-bottom: 16px;">🔧 资源配置优化方案</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        基于AI分析，为您提供个性化的资源优化建议
                    </p>
                </div>
                
                <!-- 优化建议 -->
                <div style="background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(69,160,73,0.05)); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h5 style="color: #4caf50; margin: 0 0 16px 0;">✅ 优化重点</h5>
                    <div style="display: grid; gap: 12px;">
                        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 3px solid #4caf50;">
                            <strong>时间管理：</strong> 使用番茄工作法，提高专注度和效率
                        </div>
                        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 3px solid #4caf50;">
                            <strong>目标聚焦：</strong> 同时推进的项目不超过3个，避免分散注意力
                        </div>
                        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 3px solid #4caf50;">
                            <strong>学习效率：</strong> 采用实践导向的学习方式，边学边用
                        </div>
                        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 3px solid #4caf50;">
                            <strong>网络建设：</strong> 每月参加1-2次行业活动，扩展人脉
                        </div>
                    </div>
                </div>
                
                <!-- 具体行动计划 -->
                <div style="background: #fff3e0; border: 1px solid #ff9800; border-radius: 12px; padding: 20px;">
                    <h5 style="color: #f57c00; margin: 0 0 16px 0;">📋 具体行动计划</h5>
                    <div style="display: grid; gap: 8px;">
                        <div style="padding: 8px 12px; background: white; border-radius: 6px;">
                            <strong>第1个月：</strong> 建立资源管理体系，明确优先级
                        </div>
                        <div style="padding: 8px 12px; background: white; border-radius: 6px;">
                            <strong>第2-4个月：</strong> 按优化方案执行，定期监控和调整
                        </div>
                        <div style="padding: 8px 12px; background: white; border-radius: 6px;">
                            <strong>第5-6个月：</strong> 评估效果，总结最佳实践
                        </div>
                    </div>
                </div>
            `;
            
            ModalUtils.show('🔧 资源优化方案', optimizedAllocation, 'large');
        }

        function generateResourcePlan() {
            const resourcePlan = `
                <div style="margin-bottom: 24px;">
                    <h4 style="color: #ef6c00; margin-bottom: 16px;">📊 资源配置计划</h4>
                    <p style="color: #666; font-size: 0.9em;">
                        详细的资源分配和使用计划
                    </p>
                </div>
                
                <!-- 周度资源分配 -->
                <div style="background: white; border: 1px solid #ffcc02; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h5 style="color: #ef6c00; margin: 0 0 16px 0;">📅 周度资源分配模板</h5>
                    <div style="font-family: monospace; background: #f9f9f9; padding: 16px; border-radius: 6px; font-size: 0.9em; line-height: 1.6;">
                        <strong>周一：</strong> 核心目标推进 (4小时) + 学习时间 (2小时)<br>
                        <strong>周二：</strong> 项目执行 (4小时) + 网络建设 (2小时)<br>
                        <strong>周三：</strong> 核心目标推进 (4小时) + 技能练习 (2小时)<br>
                        <strong>周四：</strong> 项目执行 (4小时) + 总结回顾 (2小时)<br>
                        <strong>周五：</strong> 核心目标推进 (3小时) + 规划调整 (2小时)<br>
                        <strong>周末：</strong> 生活平衡 + 兴趣发展 + 休息恢复
                    </div>
                </div>
                
                <!-- 月度检查清单 -->
                <div style="background: #e8f5e9; border: 1px solid #4caf50; border-radius: 12px; padding: 20px;">
                    <h5 style="color: #2e7d32; margin: 0 0 16px 0;">✅ 月度资源检查清单</h5>
                    <div style="display: grid; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                            <input type="checkbox"> 时间分配是否合理？
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                            <input type="checkbox"> 精力使用是否高效？
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                            <input type="checkbox"> 学习资源是否充分利用？
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                            <input type="checkbox"> 人际网络是否在扩展？
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                            <input type="checkbox"> 是否需要调整资源分配？
                        </label>
                    </div>
                </div>
            `;
            
            ModalUtils.show('📊 资源配置计划', resourcePlan, 'large');
        }

        // 全局函数，用于应用建议内容
        window.applySuggestionContent = function(fieldId, content) {
            const field = document.getElementById(fieldId);
            if (field) {
                if (field.tagName === 'TEXTAREA') {
                    field.value = content;
                } else if (field.classList && field.classList.contains('todo-list-container')) {
                    field.textContent = content;
                    TodoUtils.renderTodos(field);
                }
                MessageUtils.success('建议内容已应用到计划中');
                
                // 触发保存
                setTimeout(() => {
                    if (typeof window.saveDraft === 'function') {
                        window.saveDraft();
                    }
                }, 100);
            }
        };
    </script>
    
    <!-- 同步服务 -->
    <script src="sync-service.js"></script>
    <script src="sync-providers.js"></script>
    <!-- 通用自动同步功能 -->
    <script src="universal-auto-sync.js"></script>
    <script src="add-ai-to-all-pages.js"></script>
</body>

</html>

