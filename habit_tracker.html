<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script src="config.js"></script>
    
    <!-- FirebaseÈÖçÁΩÆ -->
    <script src="firebase-config.js"></script>
    
    <!-- ÂêåÊ≠•‰øÆÂ§çÂ∑•ÂÖ∑ -->
    <script src="sync-fix.js"></script>
    
    <!-- FirebaseÊï∞ÊçÆÂ∫ìÂêåÊ≠• -->
    <script src="firebase-database-sync.js"></script>
    <script src="gemini-ai-assistant.js"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êô∫ËÉΩ‰π†ÊÉØËøΩË∏™ - Êô∫ËÉΩËÆ°ÂàíÁÆ°ÁêÜÁ≥ªÁªü</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ai-assistant-styles.css">
    <style>
        .habit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .habit-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .habit-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .habit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .habit-name {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--theme-color);
        }

        .habit-streak {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .habit-progress {
            margin-bottom: 16px;
        }

        .habit-progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .habit-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--theme-color), #1565c0);
            transition: width 0.6s ease;
            border-radius: 4px;
        }

        .habit-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }

        .habit-actions {
            display: flex;
            gap: 8px;
        }

        .habit-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .habit-btn.check {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }

        .habit-btn.check:hover {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
        }

        .habit-btn.skip {
            background: linear-gradient(135deg, #ff9800, #ef6c00);
            color: white;
        }

        .habit-btn.edit {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
        }

        .calendar-view {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 12px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 24px;
            max-height: 32px;
        }

        .calendar-day.completed {
            background: #4caf50;
            color: white;
        }

        .calendar-day.skipped {
            background: #ff9800;
            color: white;
        }

        .calendar-day.missed {
            background: #f44336;
            color: white;
        }

        .calendar-day.today {
            border: 2px solid var(--theme-color);
            background: var(--theme-color-light);
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .stat-value {
            font-size: 1.6em;
            font-weight: bold;
            color: var(--theme-color);
            margin-bottom: 2px;
        }

        .stat-label {
            color: #666;
            font-size: 0.8em;
        }

        /* Êó•ÂéÜÂ∑•ÂÖ∑ÊèêÁ§∫Ê†∑Âºè */
        .calendar-tooltip {
            position: fixed;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 260px;
            max-width: 340px;
            max-height: 380px;
            overflow-y: auto;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.25s ease;
            pointer-events: auto;
            visibility: hidden;
            transform-origin: left center;
        }

        .calendar-tooltip.show {
            opacity: 1;
            transform: scale(1) !important;
        }

        /* ‰∏çÂêå‰ΩçÁΩÆÁöÑÂ∑•ÂÖ∑ÊèêÁ§∫Ê†∑Âºè */
        .calendar-tooltip.position-right {
            transform-origin: left center;
        }

        .calendar-tooltip.position-left {
            transform-origin: right center;
        }

        .calendar-tooltip.position-bottom {
            transform-origin: center top;
        }

        .calendar-tooltip.position-top {
            transform-origin: center bottom;
        }

        /* ÁßªÈô§ÁÆ≠Â§¥ - Âõ†‰∏∫Â∑•ÂÖ∑ÊèêÁ§∫Â∑≤ÁªèÁ¥ßË¥¥ÊòæÁ§∫ */

        .calendar-tooltip h4 {
            margin: 0 0 12px 0;
            color: var(--theme-color);
            font-size: 1em;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tooltip-habit-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .tooltip-habit-item:last-child {
            border-bottom: none;
        }

        .tooltip-habit-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        .tooltip-habit-name {
            flex: 1;
            color: #333;
            font-weight: 500;
        }

        .tooltip-habit-status {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .tooltip-habit-status.completed {
            background: #4caf50;
            color: white;
        }

        .tooltip-habit-status.skipped {
            background: #ff9800;
            color: white;
        }

        .tooltip-habit-status.missed {
            background: #f44336;
            color: white;
        }

        .tooltip-stats {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 0.85em;
        }

        .tooltip-stat {
            text-align: center;
            padding: 6px;
            background: rgba(33, 150, 243, 0.05);
            border-radius: 6px;
        }

        .tooltip-stat-value {
            font-weight: bold;
            color: var(--theme-color);
            font-size: 1.1em;
        }

        .tooltip-stat-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- È°µÈù¢Â§¥ÈÉ® -->
        <div class="page-header">
            <a href="index.html" class="back-to-home">‚Üê ËøîÂõû‰∏ªÈ°µ</a>
            <h1 class="page-title">üìà Êô∫ËÉΩ‰π†ÊÉØËøΩË∏™</h1>
            <div style="display: flex; gap: 8px;">
                <a href="day_plan.html" class="btn-main" style="font-size: 0.9em;">Êó•ËÆ°Âàí</a>
                <button type="button" id="clean-habit-data-btn" class="btn-main" style="background: #ff9800; color: white;">üßπ Ê∏ÖÁêÜÊï∞ÊçÆ</button>
                <button type="button" id="force-save-habit-btn" class="btn-main" style="background: #4caf50; color: white;">üíæ ‰øùÂ≠ò</button>
                <button type="button" id="add-habit-btn" class="btn-main">‚ûï Êñ∞Â¢û‰π†ÊÉØ</button>
            </div>
        </div>

        <!-- AIÊô∫ËÉΩÂàÜÊûêÂå∫Âüü - ÊîæÂú®ÊúÄÈ°∂ÈÉ® -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">
                <div style="flex: 1;">
                    <h3 style="color: white; margin: 0 0 8px 0; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                        ü§ñ AI Êô∫ËÉΩÂàÜÊûê
                        <span style="font-size: 0.5em; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px;">Gemini 2.5 Pro</span>
                    </h3>
                    <p style="color: rgba(255,255,255,0.95); margin: 0; font-size: 1em; line-height: 1.6;">
                        ËÆ© AI ÂàÜÊûêÊÇ®ÁöÑ‰π†ÊÉØËøΩË∏™Êï∞ÊçÆÔºåÊèê‰æõ‰∏ì‰∏öÂª∫ËÆÆÂíå‰ºòÂåñÊñπÊ°à
                    </p>
                </div>
                <button type="button" onclick="startAIAnalysis()" style="background: white; color: #667eea; border: none; padding: 16px 40px; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; white-space: nowrap;">
                    üöÄ ÂºÄÂßãÂàÜÊûê
                </button>
            </div>
        </div>

        <!-- ÁªüËÆ°Ê¶ÇËßà -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-value" id="total-habits">0</div>
                <div class="stat-label">ÊÄª‰π†ÊÉØÊï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="active-streaks">0</div>
                <div class="stat-label">Ê¥ªË∑ÉËøûÁª≠</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completion-rate">0%</div>
                <div class="stat-label">ÂÆåÊàêÁéá</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="longest-streak">0</div>
                <div class="stat-label">ÊúÄÈïøËøûÁª≠</div>
            </div>
        </div>

        <!-- ‰ªäÊó•‰π†ÊÉØ -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                üéØ ‰ªäÊó•‰π†ÊÉØÊâìÂç°
                <span id="today-progress" style="background: #4caf50; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">0/0</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" id="add-habit-btn-2" class="btn-main">‚ûï Êñ∞Â¢û‰π†ÊÉØ</button>
                <button type="button" id="habits-analytics-btn" onclick="showHabitAnalytics()" style="background: #e3f2fd; color: #1976d2; cursor: pointer; border: 1px solid #1976d2; border-radius: 6px; padding: 8px 12px; font-size: 0.9em; transition: all 0.3s ease;">üìä ‰π†ÊÉØÂàÜÊûê</button>
            </div>
        </div>

        <!-- ‰π†ÊÉØÂç°ÁâáÁΩëÊ†º -->
        <div id="habits-grid" class="habit-grid">
            <!-- ‰π†ÊÉØÂç°ÁâáÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
        </div>

        <!-- ÊúàÂ∫¶Êó•ÂéÜËßÜÂõæ -->
        <div class="calendar-view" style="background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; color: var(--theme-color); font-size: 1.1em;">üìÖ ÊúàÂ∫¶Êó•ÂéÜ</h3>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <button type="button" id="cal-prev" style="padding: 3px 6px; border: 1px solid #ddd; background: white; border-radius: 3px; font-size: 0.9em; cursor: pointer;">‚Üê</button>
                    <span id="calendar-month" style="font-weight: 600; min-width: 80px; text-align: center; font-size: 0.9em;"></span>
                    <button type="button" id="cal-next" style="padding: 3px 6px; border: 1px solid #ddd; background: white; border-radius: 3px; font-size: 0.9em; cursor: pointer;">‚Üí</button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 6px;">
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">Êó•</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">‰∏Ä</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">‰∫å</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">‰∏â</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">Âõõ</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">‰∫î</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">ÂÖ≠</div>
            </div>
            
            <div id="calendar-grid" class="calendar-grid">
                <!-- Êó•ÂéÜÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
            </div>

            <!-- Âõæ‰æã -->
            <div style="display: flex; justify-content: center; gap: 16px; margin-top: 12px; font-size: 0.8em;">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 10px; height: 10px; background: #4caf50; border-radius: 50%;"></div>
                    <span>Â∑≤ÂÆåÊàê</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 10px; height: 10px; background: #ff9800; border-radius: 50%;"></div>
                    <span>Â∑≤Ë∑≥Ëøá</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 10px; height: 10px; background: #f44336; border-radius: 50%;"></div>
                    <span>Êú™ÂÆåÊàê</span>
                </div>
            </div>
        </div>

        <!-- ‰π†ÊÉØÊ¥ûÂØü -->
        <div class="plan-item-header">
            <label>üß† Êô∫ËÉΩ‰π†ÊÉØÊ¥ûÂØü</label>
            <button type="button" id="generate-insights-btn" class="btn-main">üîÑ ÁîüÊàêÊ¥ûÂØü</button>
        </div>
        <div id="habit-insights" style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; min-height: 80px; border: 1px solid rgba(0,0,0,0.1);">
            <p style="text-align: center; color: #666; margin: 20px 0; font-size: 0.9em;">ÁÇπÂáª"üìä ‰π†ÊÉØÂàÜÊûê"Êü•ÁúãÊÇ®ÁöÑ‰π†ÊÉØÂàÜÊûêÊä•Âëä</p>
        </div>

        <!-- Êó•ÂéÜÂ∑•ÂÖ∑ÊèêÁ§∫ -->
        <div id="calendar-tooltip" class="calendar-tooltip">
            <div id="tooltip-content"></div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // ÂÖ®Â±ÄÈîôËØØÊçïËé∑
        window.addEventListener('error', function(e) {
            console.error('JavaScript ÈîôËØØ:', e.error);
            console.error('ÈîôËØØ‰ø°ÊÅØ:', e.message);
            console.error('ÈîôËØØ‰ΩçÁΩÆ:', e.filename, e.lineno, e.colno);
        });

        // ‰π†ÊÉØËøΩË∏™Êï∞ÊçÆ
        let habitsData = JSON.parse(localStorage.getItem('habitTrackerData') || '{}');
        console.log('Âä†ËΩΩÁöÑ‰π†ÊÉØÊï∞ÊçÆ:', habitsData);
        let currentCalendarMonth = new Date();

        // ÈªòËÆ§‰π†ÊÉØÊ®°Êùø
        const defaultHabits = [
            { name: 'Êô®Èó¥ÈîªÁÇº', icon: 'üí™', target: 30, unit: 'ÂàÜÈíü' },
            { name: 'ÈòÖËØªÂ≠¶‰π†', icon: 'üìö', target: 1, unit: 'Â∞èÊó∂' },
            { name: 'ÂÜ•ÊÉ≥ÊîæÊùæ', icon: 'üßò', target: 15, unit: 'ÂàÜÈíü' },
            { name: 'ÂñùÊ∞¥', icon: 'üíß', target: 8, unit: 'ÊùØ' },
            { name: 'Êó©Áù°', icon: 'üò¥', target: 1, unit: 'Ê¨°' }
        ];

        // ‰π†ÊÉØÂàÜÊûê‰∏ªÂáΩÊï∞
        function showHabitAnalytics() {
            console.log('ÂºÄÂßãÁîüÊàê‰π†ÊÉØÂàÜÊûê');
            
            const insights = document.getElementById('habit-insights');
            if (!insights) {
                console.error('Êâæ‰∏çÂà∞‰π†ÊÉØÊ¥ûÂØüÂÆπÂô®');
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            insights.innerHTML = `
                <div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); padding: 25px; border-radius: 12px; text-align: center; border-left: 4px solid #2196f3; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: inline-block; animation: spin 1s linear infinite; font-size: 2em; margin-bottom: 10px;">üîÑ</div>
                    <h3 style="color: #1976d2; margin: 0 0 8px 0;">Ê≠£Âú®ÂàÜÊûêÊÇ®ÁöÑ‰π†ÊÉØÊï∞ÊçÆ...</h3>
                    <p style="color: #666; margin: 0; font-size: 0.9em;">ËØ∑Á®çÂÄôÔºåÊ≠£Âú®ÁîüÊàê‰∏™ÊÄßÂåñÂàÜÊûêÊä•Âëä</p>
                </div>
                <style>
                    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                </style>
            `;
            
            // Âª∂ËøüÊâßË°åÂàÜÊûê
            setTimeout(() => {
                generateAnalysisReport();
            }, 800);
        }

        // ÁîüÊàêÂàÜÊûêÊä•Âëä
        function generateAnalysisReport() {
            const insights = document.getElementById('habit-insights');
            const habits = Object.values(habitsData);
            
            if (habits.length === 0) {
                insights.innerHTML = `
                    <div style="background: linear-gradient(135deg, #fff3e0, #fce4ec); padding: 30px; border-radius: 12px; text-align: center; border-left: 4px solid #ff9800; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìã</div>
                        <h3 style="color: #ef6c00; margin: 0 0 12px 0;">ÊöÇÊó†‰π†ÊÉØÊï∞ÊçÆ</h3>
                        <p style="color: #666; margin: 0 0 20px 0; line-height: 1.5;">
                            ÂºÄÂßãÊÇ®ÁöÑ‰π†ÊÉØÂÖªÊàê‰πãÊóÖÔºÅ<br>
                            Ê∑ªÂä†‰π†ÊÉØÂπ∂ÂùöÊåÅÊâìÂç°ÔºåÂç≥ÂèØËé∑ÂæóËØ¶ÁªÜÁöÑÂàÜÊûêÊä•Âëä„ÄÇ
                        </p>
                        <button onclick="document.getElementById('add-habit-btn').click()" 
                                style="background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            ‚ûï Á´ãÂç≥Ê∑ªÂä†‰π†ÊÉØ
                        </button>
                    </div>
                `;
                return;
            }
            
            // ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
            const stats = calculateHabitStatistics(habits);
            
            // ÁîüÊàêÂπ∂ÊòæÁ§∫Êä•Âëä
            insights.innerHTML = generateReportHTML(stats);
            
            console.log('‰π†ÊÉØÂàÜÊûêÊä•ÂëäÁîüÊàêÂÆåÊàê');
        }
        
        // ËÆ°ÁÆó‰π†ÊÉØÁªüËÆ°Êï∞ÊçÆ
        function calculateHabitStatistics(habits) {
            let totalRecords = 0;
            let totalCompleted = 0;
            let bestHabit = null;
            let bestRate = 0;
            let activeStreaks = 0;
            let longestStreak = 0;
            
            habits.forEach(habit => {
                const records = habit.records || {};
                const recordDates = Object.keys(records);
                const completedRecords = Object.values(records).filter(r => r && r.completed);
                
                const recordCount = recordDates.length;
                const completedCount = completedRecords.length;
                const rate = recordCount > 0 ? Math.round((completedCount / recordCount) * 100) : 0;
                
                totalRecords += recordCount;
                totalCompleted += completedCount;
                
                if (rate > bestRate && recordCount > 0) {
                    bestRate = rate;
                    bestHabit = habit;
                }
                
                const streak = calculateStreakForHabit(habit);
                if (streak > 0) activeStreaks++;
                if (streak > longestStreak) longestStreak = streak;
            });
            
            const overallRate = totalRecords > 0 ? Math.round((totalCompleted / totalRecords) * 100) : 0;
            
            return {
                totalHabits: habits.length,
                totalRecords,
                totalCompleted,
                overallRate,
                bestHabit,
                bestRate,
                activeStreaks,
                longestStreak
            };
        }
        
        // ËÆ°ÁÆóÂçï‰∏™‰π†ÊÉØÁöÑËøûÁª≠Â§©Êï∞
        function calculateStreakForHabit(habit) {
            const records = habit.records || {};
            const today = new Date();
            let streak = 0;
            
            for (let i = 0; i < 100; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateKey = DateUtils.formatDate(date);
                
                const record = records[dateKey];
                if (record && record.completed) {
                    streak++;
                } else if (i === 0) {
                    continue;
                } else {
                    break;
                }
            }
            
            return streak;
        }
        
        // ÁîüÊàêÊä•ÂëäHTML
        function generateReportHTML(stats) {
            const currentDate = new Date().toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            
            return `
                <div style="background: linear-gradient(135deg, #f5f5f5, #fafafa); border-radius: 12px; padding: 18px; box-shadow: 0 2px 12px rgba(0,0,0,0.1);">
                    <div style="text-align: center; margin-bottom: 18px; padding-bottom: 16px; border-bottom: 1px solid #e0e0e0;">
                        <h2 style="margin: 0 0 6px 0; color: #1976d2; font-size: 1.3em;">üìä ‰π†ÊÉØÂàÜÊûêÊä•Âëä</h2>
                        <p style="margin: 0; color: #666; font-size: 0.85em;">${currentDate}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(76,175,80,0.05)); padding: 14px; border-radius: 8px; border-left: 3px solid #4caf50; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #2e7d32; margin-bottom: 3px;">${stats.totalHabits}</div>
                            <div style="color: #666; font-size: 0.8em;">ÊÄª‰π†ÊÉØÊï∞</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(25,118,210,0.1), rgba(25,118,210,0.05)); padding: 14px; border-radius: 8px; border-left: 3px solid #1976d2; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #1976d2; margin-bottom: 3px;">${stats.overallRate}%</div>
                            <div style="color: #666; font-size: 0.8em;">ÊÄªÂÆåÊàêÁéá</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(255,152,0,0.1), rgba(255,152,0,0.05)); padding: 14px; border-radius: 8px; border-left: 3px solid #ff9800; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #ef6c00; margin-bottom: 3px;">${stats.activeStreaks}</div>
                            <div style="color: #666; font-size: 0.8em;">Ê¥ªË∑ÉËøûÁª≠</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(156,39,176,0.1), rgba(156,39,176,0.05)); padding: 14px; border-radius: 8px; border-left: 3px solid #9c27b0; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #7b1fa2; margin-bottom: 3px;">${stats.longestStreak}</div>
                            <div style="color: #666; font-size: 0.8em;">ÊúÄÈïøËøûÁª≠</div>
                        </div>
                    </div>
                    
                    ${stats.bestHabit ? `
                    <div style="background: linear-gradient(135deg, rgba(76,175,80,0.08), rgba(139,195,74,0.08)); padding: 18px; border-radius: 10px; margin-bottom: 16px;">
                        <h3 style="margin: 0 0 12px 0; color: #2e7d32; font-size: 1.1em;">üèÜ Ë°®Áé∞ÊúÄ‰Ω≥‰π†ÊÉØ</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 2em;">${stats.bestHabit.icon || 'üìã'}</div>
                            <div>
                                <h4 style="margin: 0 0 4px 0; color: #1b5e20; font-size: 1.1em;">${stats.bestHabit.name}</h4>
                                <div style="background: #4caf50; color: white; display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">
                                    ÂÆåÊàêÁéá: ${stats.bestRate}%
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="background: linear-gradient(135deg, rgba(63,81,181,0.08), rgba(48,63,159,0.08)); padding: 18px; border-radius: 10px;">
                        <h3 style="margin: 0 0 12px 0; color: #3f51b5; font-size: 1.1em;">üí° ‰∏™ÊÄßÂåñÂª∫ËÆÆ</h3>
                        <p style="margin: 0; color: #444; line-height: 1.5; font-size: 0.95em;">${generatePersonalizedAdvice(stats)}</p>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 6px; text-align: center;">
                        <p style="margin: 0; font-size: 0.8em; color: #888;">
                            üìà Âü∫‰∫é ${stats.totalHabits} ‰∏™‰π†ÊÉØÁöÑ ${stats.totalRecords} Êù°ËÆ∞ÂΩï | ‚è∞ ${new Date().toLocaleTimeString()}
                        </p>
                    </div>
                </div>
            `;
        }
        
        // ÁîüÊàê‰∏™ÊÄßÂåñÂª∫ËÆÆ
        function generatePersonalizedAdvice(stats) {
            const rate = stats.overallRate;
            if (rate >= 90) return `üéâ ÊÇ®ÁöÑ‰π†ÊÉØÂÖªÊàêËÉΩÂäõÈùûÂ∏∏Âá∫Ëâ≤ÔºÅÂª∫ËÆÆÊåëÊàòÊõ¥È´òÈöæÂ∫¶ÁöÑ‰π†ÊÉØ„ÄÇ`;
            if (rate >= 80) return `üëè Ë°®Áé∞‰ºòÁßÄÔºÅÂª∫ËÆÆ‰∏ìÊ≥®‰∫é‰øùÊåÅÁé∞Êúâ‰π†ÊÉØÁöÑÁ®≥ÂÆöÊÄß„ÄÇ`;
            if (rate >= 60) return `üëç ‰∏çÈîôÁöÑÂºÄÂßãÔºÅÂª∫ËÆÆ‰∏ìÊ≥®‰∫é2-3‰∏™ÊúÄÈáçË¶ÅÁöÑ‰π†ÊÉØ„ÄÇ`;
            if (rate >= 40) return `üí™ ÁªßÁª≠Âä™ÂäõÔºÅÂª∫ËÆÆ‰ªéÊúÄÂÆπÊòìÁöÑ1‰∏™‰π†ÊÉØÂºÄÂßã„ÄÇ`;
            return `üå± ‰∏á‰∫ãÂºÄÂ§¥ÈöæÔºÅÂª∫ËÆÆÈÄâÊã©‰∏Ä‰∏™ÈùûÂ∏∏ÁÆÄÂçïÁöÑ‰π†ÊÉØÂºÄÂßã„ÄÇ`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM Âä†ËΩΩÂÆåÊàê ===');
            
            // Âü∫Á°ÄDOMÊ£ÄÊü•
            const calendarGrid = document.getElementById('calendar-grid');
            const tooltip = document.getElementById('calendar-tooltip');
            const tooltipContent = document.getElementById('tooltip-content');
            
            console.log('DOMÂÖÉÁ¥†Ê£ÄÊü•:', {
                calendarGrid: !!calendarGrid,
                tooltip: !!tooltip,
                tooltipContent: !!tooltipContent
            });
            
            // Ê£ÄÊü•common.js
            console.log('Ê£ÄÊü• DateUtils:', typeof DateUtils);
            console.log('Ê£ÄÊü• common.js Ê®°Âùó:', {
                DateUtils: typeof DateUtils,
                MessageUtils: typeof MessageUtils,
                ModalUtils: typeof ModalUtils
            });
            
            if (typeof DateUtils === 'undefined') {
                console.error('DateUtils Êú™ÂÆö‰πâÔºÅcommon.js ÂèØËÉΩÊ≤°ÊúâÊ≠£Á°ÆÂä†ËΩΩ');
                alert('ÈîôËØØÔºöcommon.js Ê≤°ÊúâÊ≠£Á°ÆÂä†ËΩΩÔºÅ');
                return;
            }
            
            // ÊâßË°åÊï∞ÊçÆÊ∏ÖÁêÜÊ£ÄÊü•
            setTimeout(() => {
                try {
                    console.log('üßπ ÊâßË°åÂêØÂä®Êó∂Êï∞ÊçÆÊ∏ÖÁêÜÊ£ÄÊü•...');
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÁºñÁ†ÅÈóÆÈ¢ò
                    let needsCleaning = false;
                    for (const [habitId, habit] of Object.entries(habitsData)) {
                        if (habit && habit.name && hasEncodingIssues(habit.name)) {
                            needsCleaning = true;
                            break;
                        }
                    }
                    
                    if (needsCleaning) {
                        console.log('‚ö†Ô∏è Ê£ÄÊµãÂà∞‰π†ÊÉØÊï∞ÊçÆÁºñÁ†ÅÈóÆÈ¢òÔºåËá™Âä®Ê∏ÖÁêÜ...');
                        cleanHabitData();
                    } else {
                        console.log('‚úÖ ‰π†ÊÉØÊï∞ÊçÆÊ£ÄÊü•ÈÄöËøá');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è ÂêØÂä®Êó∂Êï∞ÊçÆÊ∏ÖÁêÜÂ§±Ë¥•:', error);
                }
            }, 500);
            
            // ÂàùÂßãÂåñ
            try {
                initHabitTracker();
                
                // È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê
                console.log('‚úÖ ‰π†ÊÉØËøΩË∏™Âô®ÂàùÂßãÂåñÂÆåÊàê');
                
            } catch (error) {
                console.error('ÂàùÂßãÂåñËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:', error);
                alert('ÂàùÂßãÂåñÂ§±Ë¥•: ' + error.message);
            }
            
            // ÂÖ®Â±ÄÁÇπÂáªÊ£ÄÊµã - Ë∞ÉËØïÁî®
            document.addEventListener('click', function(event) {
                console.log('ÂÖ®Â±ÄÁÇπÂáªÊ£ÄÊµã:', {
                    target: event.target,
                    id: event.target.id,
                    className: event.target.className,
                    tagName: event.target.tagName
                });
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØ‰π†ÊÉØÂàÜÊûêÊåâÈíÆ
                if (event.target.id === 'habits-analytics-btn') {
                    console.log('Ê£ÄÊµãÂà∞‰π†ÊÉØÂàÜÊûêÊåâÈíÆË¢´ÁÇπÂáªÔºÅ');
                }
            });
        });

        // ÊµãËØïÂü∫Á°Ä‰∫§‰∫íÂäüËÉΩ
        function testBasicInteraction() {
            console.log('=== ÊµãËØïÂü∫Á°Ä‰∫§‰∫íÂäüËÉΩ ===');
            
            const calendarGrid = document.getElementById('calendar-grid');
            if (!calendarGrid) {
                console.error('Êâæ‰∏çÂà∞Êó•ÂéÜÁΩëÊ†º');
                return;
            }
            
            const dayElements = calendarGrid.children;
            console.log('Êó•ÂéÜ‰∏≠ÁöÑÊó•ÊúüÂÖÉÁ¥†Êï∞Èáè:', dayElements.length);
            
            if (dayElements.length === 0) {
                console.error('Êó•ÂéÜ‰∏≠Ê≤°ÊúâÊó•ÊúüÂÖÉÁ¥†ÔºÅ');
                return;
            }
            
            // ÊµãËØïÁ¨¨‰∏Ä‰∏™Êó•ÊúüÂÖÉÁ¥†
            const firstDay = dayElements[0];
            console.log('Á¨¨‰∏Ä‰∏™Êó•ÊúüÂÖÉÁ¥†:', firstDay);
            console.log('Á¨¨‰∏Ä‰∏™Êó•ÊúüÂÖÉÁ¥†ÁöÑ‰∫ã‰ª∂Â§ÑÁêÜÂô®:', {
                onmouseenter: typeof firstDay.onmouseenter,
                onmouseleave: typeof firstDay.onmouseleave,
                onclick: typeof firstDay.onclick
            });
            
            // ÊâãÂä®ÊµãËØïÂ∑•ÂÖ∑ÊèêÁ§∫
            testTooltipManually();
        }

        // ÊâãÂä®ÊµãËØïÂ∑•ÂÖ∑ÊèêÁ§∫
        function testTooltipManually() {
            console.log('=== ÊâãÂä®ÊµãËØïÂ∑•ÂÖ∑ÊèêÁ§∫ ===');
            const tooltip = document.getElementById('calendar-tooltip');
            const tooltipContent = document.getElementById('tooltip-content');
            
            if (!tooltip || !tooltipContent) {
                console.error('Â∑•ÂÖ∑ÊèêÁ§∫ÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                return false;
            }
            
            tooltipContent.innerHTML = '<h4>ÊâãÂä®ÊµãËØïÂ∑•ÂÖ∑ÊèêÁ§∫</h4><p>ËøôÊòØ‰∏Ä‰∏™ÊâãÂä®ÊµãËØïÊ∂àÊÅØ</p>';
            tooltip.style.left = '200px';
            tooltip.style.top = '200px';
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
            tooltip.style.transform = 'none';
            tooltip.className = 'calendar-tooltip show';
            
            console.log('ÊâãÂä®Â∑•ÂÖ∑ÊèêÁ§∫Â∫îËØ•ÊòæÁ§∫‰∫Ü');
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
                console.log('ÊâãÂä®Â∑•ÂÖ∑ÊèêÁ§∫Â∑≤ÈöêËóè');
            }, 3000);
            
            return true;
        }

        // ÂÖ®Â±ÄÊµãËØïÂáΩÊï∞ - ÂèØ‰ª•Âú®ÊéßÂà∂Âè∞Áõ¥Êé•Ë∞ÉÁî®
        window.testHoverTooltip = function() {
            console.log('=== Áî®Êà∑ÊâãÂä®ÊµãËØïÂ∑•ÂÖ∑ÊèêÁ§∫ ===');
            const calendarGrid = document.getElementById('calendar-grid');
            const firstDay = calendarGrid.children[0];
            
            if (firstDay && firstDay.onmouseenter) {
                console.log('Ê®°ÊãüÈº†Ê†áËøõÂÖ•Á¨¨‰∏Ä‰∏™Êó•Êúü');
                const fakeEvent = { target: firstDay };
                firstDay.onmouseenter(fakeEvent);
            } else {
                console.error('Á¨¨‰∏Ä‰∏™Êó•ÊúüÂÖÉÁ¥†ÊàñÂÖ∂‰∫ã‰ª∂Â§ÑÁêÜÂô®‰∏çÂ≠òÂú®');
            }
        };

        function initHabitTracker() {
            console.log('=== ÂàùÂßãÂåñ‰π†ÊÉØËøΩË∏™Âô® ===');
            
            // Â¶ÇÊûúÊ≤°Êúâ‰π†ÊÉØÊï∞ÊçÆÔºåÂàùÂßãÂåñÈªòËÆ§‰π†ÊÉØ
            if (Object.keys(habitsData).length === 0) {
                initDefaultHabits();
            }

            renderHabits();
            renderCalendar();
            updateStats();
            setupEventListeners();
            
            // Ê∑ªÂä†ÂÖ®Â±ÄÁÇπÂáª‰∫ã‰ª∂ÔºåÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèÂ∑•ÂÖ∑ÊèêÁ§∫
            document.addEventListener('click', function(e) {
                const tooltip = document.getElementById('calendar-tooltip');
                const calendarGrid = document.getElementById('calendar-grid');
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÊó•ÂéÜÊó•ÊúüÔºå‰∏îÂ∑•ÂÖ∑ÊèêÁ§∫ÊòØÊòæÁ§∫ÁöÑÔºåÂàôÈöêËóèÂÆÉ
                if (tooltip && tooltip.style.visibility === 'visible') {
                    const isClickOnCalendar = calendarGrid && calendarGrid.contains(e.target);
                    const isClickOnTooltip = tooltip.contains(e.target);
                    
                    if (!isClickOnCalendar && !isClickOnTooltip) {
                        hideDayTooltip();
                    }
                }
            });
        }

        function setupEventListeners() {
            document.getElementById('add-habit-btn').addEventListener('click', showAddHabitModal);
            document.getElementById('add-habit-btn-2').addEventListener('click', showAddHabitModal);
            document.getElementById('cal-prev').addEventListener('click', () => navigateCalendar(-1));
            document.getElementById('cal-next').addEventListener('click', () => navigateCalendar(1));
            document.getElementById('generate-insights-btn').addEventListener('click', generateHabitInsights);
            
            // Êñ∞Â¢ûÁöÑÂäüËÉΩÊåâÈíÆ
            document.getElementById('clean-habit-data-btn')?.addEventListener('click', cleanHabitData);
            document.getElementById('force-save-habit-btn')?.addEventListener('click', forceSaveHabitData);
            
            // ‰π†ÊÉØÂàÜÊûêÊåâÈíÆ‰∫ã‰ª∂ÁªëÂÆö - ‰ΩøÁî®Â§öÁßçÊñπÂºèÁ°Æ‰øùÁªëÂÆöÊàêÂäü
            const analyticsBtn = document.getElementById('habits-analytics-btn');
            console.log('Êü•Êâæ‰π†ÊÉØÂàÜÊûêÊåâÈíÆ:', analyticsBtn);
            
            if (analyticsBtn) {
                // ÊñπÊ≥ï1: addEventListener
                analyticsBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('‰π†ÊÉØÂàÜÊûêÊåâÈíÆË¢´ÁÇπÂáª - addEventListener');
                    
                    // Á´ãÂç≥ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                    const insights = document.getElementById('habit-insights');
                    if (insights) {
                        insights.innerHTML = '<div style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #2196f3;"><h3 style="color: #1976d2;">üîÑ Ê≠£Âú®ÂàÜÊûê...</h3><p style="color: #666;">ËØ∑Á®çÂÄôÔºåÊ≠£Âú®ÁîüÊàêÊÇ®ÁöÑ‰π†ÊÉØÂàÜÊûêÊä•Âëä</p></div>';
                    }
                    
                    // Âª∂ËøüÊâßË°åÂàÜÊûê
                    setTimeout(() => {
                        generateHabitInsights();
                    }, 100);
                });
                
                // ÊñπÊ≥ï2: onclick ‰Ωú‰∏∫Â§áÁî®
                analyticsBtn.onclick = function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('‰π†ÊÉØÂàÜÊûêÊåâÈíÆË¢´ÁÇπÂáª - onclick');
                    
                    // Á´ãÂç≥ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                    const insights = document.getElementById('habit-insights');
                    if (insights) {
                        insights.innerHTML = '<div style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #2196f3;"><h3 style="color: #1976d2;">üîÑ Ê≠£Âú®ÂàÜÊûê...</h3><p style="color: #666;">ËØ∑Á®çÂÄôÔºåÊ≠£Âú®ÁîüÊàêÊÇ®ÁöÑ‰π†ÊÉØÂàÜÊûêÊä•Âëä</p></div>';
                    }
                    
                    setTimeout(() => {
                        generateHabitInsights();
                    }, 100);
                };
                
                console.log('‰π†ÊÉØÂàÜÊûêÊåâÈíÆ‰∫ã‰ª∂ÁªëÂÆöÊàêÂäü');
                
                // ÊµãËØïÊåâÈíÆÊòØÂê¶ÂèØËßÅÂíåÂèØÁÇπÂáª
                const style = window.getComputedStyle(analyticsBtn);
                console.log('ÊåâÈíÆÊ†∑ÂºèÊ£ÄÊü•:', {
                    display: style.display,
                    visibility: style.visibility,
                    pointerEvents: style.pointerEvents,
                    disabled: analyticsBtn.disabled
                });
            } else {
                console.error('Êâæ‰∏çÂà∞‰π†ÊÉØÂàÜÊûêÊåâÈíÆ: habits-analytics-btn');
                
                // Â∞ùËØïÂª∂ËøüÊü•Êâæ
                setTimeout(() => {
                    const delayedBtn = document.getElementById('habits-analytics-btn');
                    if (delayedBtn) {
                        console.log('Âª∂ËøüÊâæÂà∞ÊåâÈíÆÔºåÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂');
                        delayedBtn.addEventListener('click', function(event) {
                            event.preventDefault();
                            console.log('Âª∂ËøüÁªëÂÆöÁöÑÊåâÈíÆË¢´ÁÇπÂáª');
                            alert('ÊåâÈíÆÁÇπÂáªÊàêÂäüÔºÅÊ≠£Âú®ÁîüÊàêÂàÜÊûê...');
                            generateHabitInsights();
                        });
                    }
                }, 1000);
            }
        }

        function initDefaultHabits() {
            defaultHabits.forEach((habit, index) => {
                const habitId = `habit_${Date.now()}_${index}`;
                habitsData[habitId] = {
                    ...habit,
                    id: habitId,
                    createdAt: new Date().toISOString(),
                    records: {}
                };
            });
            saveHabitsData();
        }

        function renderHabits() {
            const grid = document.getElementById('habits-grid');
            grid.innerHTML = '';

            const today = DateUtils.getToday();
            let todayCompleted = 0;
            let todayTotal = 0;

            Object.values(habitsData).forEach(habit => {
                todayTotal++;
                const todayRecord = habit.records[today];
                if (todayRecord && todayRecord.completed) {
                    todayCompleted++;
                }

                const card = createHabitCard(habit, today);
                grid.appendChild(card);
            });

            // Êõ¥Êñ∞‰ªäÊó•ËøõÂ∫¶
            document.getElementById('today-progress').textContent = `${todayCompleted}/${todayTotal}`;
        }

        function createHabitCard(habit, today) {
            const card = document.createElement('div');
            card.className = 'habit-card';

            const todayRecord = habit.records[today];
            const isCompleted = todayRecord && todayRecord.completed;
            const streak = calculateStreak(habit);
            const completionRate = calculateCompletionRate(habit);

            // ÂÆâÂÖ®ÁöÑÊñáÊú¨Â§ÑÁêÜÔºåÈò≤Ê≠¢ÁºñÁ†ÅÈóÆÈ¢òÊòæÁ§∫
            const safeIcon = sanitizeHabitText(habit.icon || 'üìã');
            const safeName = sanitizeHabitText(habit.name || '');
            const safeUnit = sanitizeHabitText(habit.unit || 'Ê¨°');
            
            card.innerHTML = `
                <div class="habit-header">
                    <div class="habit-name">${safeIcon} ${safeName}</div>
                    <div class="habit-streak">ËøûÁª≠ ${streak} Â§©</div>
                </div>
                
                <div class="habit-progress">
                    <div class="habit-progress-bar">
                        <div class="habit-progress-fill" style="width: ${completionRate}%"></div>
                    </div>
                    <div class="habit-stats">
                        <span>ÂÆåÊàêÁéá: ${completionRate}%</span>
                        <span>ÁõÆÊ†á: ${habit.target}${safeUnit}</span>
                    </div>
                </div>
                
                <div class="habit-actions">
                    <button class="habit-btn check ${isCompleted ? 'completed' : ''}" 
                            onclick="toggleHabit('${habit.id}', '${today}')" 
                            ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? '‚úÖ Â∑≤ÂÆåÊàê' : '‚úì ÂÆåÊàê'}
                    </button>
                    <button class="habit-btn skip" onclick="skipHabit('${habit.id}', '${today}')">Ë∑≥Ëøá</button>
                    <button class="habit-btn edit" onclick="editHabit('${habit.id}')">ÁºñËæë</button>
                </div>
            `;

            return card;
        }

        function toggleHabit(habitId, date) {
            if (!habitsData[habitId].records[date]) {
                habitsData[habitId].records[date] = {};
            }
            
            habitsData[habitId].records[date].completed = true;
            habitsData[habitId].records[date].timestamp = new Date().toISOString();
            
            saveHabitsData();
            renderHabits();
            renderCalendar();
            updateStats();
            
            MessageUtils.success('‰π†ÊÉØÂ∑≤ÊâìÂç°ÂÆåÊàêÔºÅ');
        }

        function skipHabit(habitId, date) {
            if (!habitsData[habitId].records[date]) {
                habitsData[habitId].records[date] = {};
            }
            
            habitsData[habitId].records[date].skipped = true;
            habitsData[habitId].records[date].timestamp = new Date().toISOString();
            
            saveHabitsData();
            renderHabits();
            renderCalendar();
            updateStats();
            
            MessageUtils.info('Â∑≤Ë∑≥Ëøá‰ªäÊó•‰π†ÊÉØ');
        }

        function calculateStreak(habit) {
            const today = new Date();
            let streak = 0;
            
            for (let i = 0; i < 100; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateKey = DateUtils.formatDate(date);
                
                const record = habit.records[dateKey];
                if (record && record.completed) {
                    streak++;
                } else if (i === 0) {
                    // Â¶ÇÊûú‰ªäÂ§©Ê≤°ÂÆåÊàêÔºå‰ªéÊò®Â§©ÂºÄÂßãÁÆó
                    continue;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function calculateCompletionRate(habit) {
            const records = Object.values(habit.records);
            if (records.length === 0) return 0;
            
            const completed = records.filter(r => r.completed).length;
            return Math.round((completed / records.length) * 100);
        }

        function renderCalendar() {
            console.log('=== ÂºÄÂßãÊ∏≤ÊüìÊó•ÂéÜ ===');
            const grid = document.getElementById('calendar-grid');
            if (!grid) {
                console.error('Êâæ‰∏çÂà∞Êó•ÂéÜÁΩëÊ†ºÂÖÉÁ¥†!');
                return;
            }
            
            grid.innerHTML = '';
            
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            console.log('Ê∏≤ÊüìÊúà‰ªΩ:', year, month + 1);
            
            // Êõ¥Êñ∞Êúà‰ªΩÊ†áÈ¢ò
            document.getElementById('calendar-month').textContent = 
                `${year}Âπ¥${month + 1}Êúà`;
            
            // Ëé∑ÂèñÊúà‰ªΩÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂêé‰∏ÄÂ§©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ÁîüÊàêÊó•ÂéÜÊ†ºÂ≠ê
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = date.getDate();
                
                const dateKey = DateUtils.formatDate(date);
                console.log('ÂàõÂª∫Êó•ÊúüÂÖÉÁ¥†:', date.getDate(), dateKey);
                const isToday = dateKey === DateUtils.getToday();
                const isCurrentMonth = date.getMonth() === month;
                
                if (isToday) {
                    dayElement.classList.add('today');
                }
                
                if (!isCurrentMonth) {
                    dayElement.style.opacity = '0.3';
                }
                
                // ËÆ°ÁÆóÂΩìÂ§©‰π†ÊÉØÂÆåÊàêÊÉÖÂÜµ
                const dayStats = calculateDayStats(dateKey);
                if (dayStats.total > 0) {
                    if (dayStats.completed === dayStats.total) {
                        dayElement.classList.add('completed');
                    } else if (dayStats.completed > 0) {
                        dayElement.style.background = `linear-gradient(135deg, #4caf50 ${(dayStats.completed/dayStats.total)*100}%, #e0e0e0 ${(dayStats.completed/dayStats.total)*100}%)`;
                    }
                }

                // ‰ΩøÁî®Á´ãÂç≥ÊâßË°åÂáΩÊï∞ÈÅøÂÖçÈó≠ÂåÖÈóÆÈ¢ò - Êîπ‰∏∫ÁÇπÂáªËß¶Âèë
                (function(currentDateKey, currentDayStats) {
                    // ÁßªÈô§Èº†Ê†áÊÇ¨ÂÅú‰∫ã‰ª∂ÔºåÊîπ‰∏∫ÁÇπÂáª‰∫ã‰ª∂
                    dayElement.onclick = function(e) {
                        e.stopPropagation(); // Èò≤Ê≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                        console.log('=== Êó•ÊúüË¢´ÁÇπÂáª ===', currentDateKey, currentDayStats);
                        
                        // Ê£ÄÊü•Â∑•ÂÖ∑ÊèêÁ§∫ÊòØÂê¶Â∑≤ÁªèÊòæÁ§∫
                        const tooltip = document.getElementById('calendar-tooltip');
                        const isVisible = tooltip && tooltip.style.visibility === 'visible';
                        
                        if (isVisible) {
                            // Â¶ÇÊûúÂ∑≤ÁªèÊòæÁ§∫ÔºåÂàôÈöêËóè
                            hideDayTooltip();
                        } else {
                            // Â¶ÇÊûúÊú™ÊòæÁ§∫ÔºåÂàôÊòæÁ§∫
                            showDayTooltip(e, currentDateKey, currentDayStats);
                        }
                    };
                })(dateKey, dayStats);
                
                // Á°Æ‰øùÂÖÉÁ¥†ÂèØ‰ª•Êé•Êî∂Èº†Ê†á‰∫ã‰ª∂
                dayElement.style.pointerEvents = 'auto';
                dayElement.style.cursor = 'pointer';
                
                grid.appendChild(dayElement);
            }
        }

        function calculateDayStats(date) {
            let total = 0;
            let completed = 0;
            
            Object.values(habitsData).forEach(habit => {
                total++;
                const record = habit.records[date];
                if (record && record.completed) {
                    completed++;
                }
            });
            
            return { total, completed };
        }

        function navigateCalendar(months) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + months);
            renderCalendar();
        }

        function updateStats() {
            const habits = Object.values(habitsData);
            
            // ÊÄª‰π†ÊÉØÊï∞
            document.getElementById('total-habits').textContent = habits.length;
            
            // Ê¥ªË∑ÉËøûÁª≠
            const activeStreaks = habits.filter(h => calculateStreak(h) > 0).length;
            document.getElementById('active-streaks').textContent = activeStreaks;
            
            // ÊÄªÂÆåÊàêÁéá
            const totalRecords = habits.reduce((sum, h) => sum + Object.keys(h.records).length, 0);
            const totalCompleted = habits.reduce((sum, h) => 
                sum + Object.values(h.records).filter(r => r.completed).length, 0);
            const overallRate = totalRecords > 0 ? Math.round((totalCompleted / totalRecords) * 100) : 0;
            document.getElementById('completion-rate').textContent = `${overallRate}%`;
            
            // ÊúÄÈïøËøûÁª≠
            const longestStreak = Math.max(...habits.map(h => calculateStreak(h)), 0);
            document.getElementById('longest-streak').textContent = longestStreak;
        }

        function showAddHabitModal() {
            const content = `
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px;">‰π†ÊÉØÂêçÁß∞</label>
                    <input type="text" id="habit-name" placeholder="‰æãÂ¶ÇÔºöÊô®Èó¥ÈîªÁÇº" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px;">ÂõæÊ†á</label>
                    <input type="text" id="habit-icon" placeholder="‰æãÂ¶ÇÔºöüí™" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px;">ÁõÆÊ†áÊï∞Èáè</label>
                        <input type="number" id="habit-target" placeholder="30" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px;">Âçï‰Ωç</label>
                        <input type="text" id="habit-unit" placeholder="ÂàÜÈíü" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
            `;

            ModalUtils.show('Êñ∞Â¢û‰π†ÊÉØ', content, {
                buttons: [
                    { text: 'ÂèñÊ∂à', class: 'btn-main' },
                    { text: 'Ê∑ªÂä†', class: 'btn-main', handler: addNewHabit }
                ]
            });
        }

        function addNewHabit() {
            const name = document.getElementById('habit-name').value.trim();
            const icon = document.getElementById('habit-icon').value.trim();
            const target = parseInt(document.getElementById('habit-target').value) || 1;
            const unit = document.getElementById('habit-unit').value.trim() || 'Ê¨°';

            if (!name) {
                MessageUtils.error('ËØ∑ËæìÂÖ•‰π†ÊÉØÂêçÁß∞');
                return;
            }

            const habitId = `habit_${Date.now()}`;
            habitsData[habitId] = {
                id: habitId,
                name: name,
                icon: icon || 'üìã',
                target: target,
                unit: unit,
                createdAt: new Date().toISOString(),
                records: {}
            };

            saveHabitsData();
            renderHabits();
            updateStats();
            MessageUtils.success('‰π†ÊÉØÊ∑ªÂä†ÊàêÂäüÔºÅ');
        }

        function editHabit(habitId) {
            const habit = habitsData[habitId];
            if (!habit) {
                MessageUtils.error('‰π†ÊÉØ‰∏çÂ≠òÂú®');
                return;
            }

            const content = `
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px;">‰π†ÊÉØÂêçÁß∞</label>
                    <input type="text" id="edit-habit-name" value="${habit.name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px;">ÂõæÊ†á</label>
                    <input type="text" id="edit-habit-icon" value="${habit.icon}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px;">ÁõÆÊ†áÊï∞Èáè</label>
                        <input type="number" id="edit-habit-target" value="${habit.target}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px;">Âçï‰Ωç</label>
                        <input type="text" id="edit-habit-unit" value="${habit.unit}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>

                <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; color: #666; font-size: 0.9em;">‰π†ÊÉØÁªüËÆ°</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 0.85em;">
                        <div>ËøûÁª≠Â§©Êï∞: <strong>${calculateStreak(habit)}</strong></div>
                        <div>ÂÆåÊàêÁéá: <strong>${calculateCompletionRate(habit)}%</strong></div>
                        <div>ËÆ∞ÂΩïÂ§©Êï∞: <strong>${Object.keys(habit.records).length}</strong></div>
                        <div>ÂàõÂª∫Êó∂Èó¥: <strong>${new Date(habit.createdAt).toLocaleDateString()}</strong></div>
                    </div>
                </div>

                <div style="background: #fff3e0; border: 1px solid #ffcc02; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; color: #ef6c00; font-size: 0.9em;">‚ö†Ô∏è Âç±Èô©Êìç‰Ωú</h4>
                    <button type="button" id="delete-habit-btn" style="background: #f44336; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 0.9em;">
                        üóëÔ∏è Âà†Èô§Ê≠§‰π†ÊÉØ
                    </button>
                    <p style="margin: 8px 0 0 0; font-size: 0.8em; color: #666;">Âà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÊâÄÊúâËÆ∞ÂΩïÊï∞ÊçÆ</p>
                </div>
            `;

            ModalUtils.show(`ÁºñËæë‰π†ÊÉØ: ${habit.icon} ${habit.name}`, content, {
                buttons: [
                    { text: 'ÂèñÊ∂à', class: 'btn-main' },
                    { text: '‰øùÂ≠ò‰øÆÊîπ', class: 'btn-main', handler: () => saveHabitEdit(habitId) }
                ]
            });

            // ‰∏∫Âà†Èô§ÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
            setTimeout(() => {
                const deleteBtn = document.getElementById('delete-habit-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => deleteHabit(habitId));
                }
            }, 100);
        }

        function saveHabitEdit(habitId) {
            const name = document.getElementById('edit-habit-name').value.trim();
            const icon = document.getElementById('edit-habit-icon').value.trim();
            const target = parseInt(document.getElementById('edit-habit-target').value) || 1;
            const unit = document.getElementById('edit-habit-unit').value.trim() || 'Ê¨°';

            if (!name) {
                MessageUtils.error('ËØ∑ËæìÂÖ•‰π†ÊÉØÂêçÁß∞');
                return;
            }

            // Êõ¥Êñ∞‰π†ÊÉØÊï∞ÊçÆ
            habitsData[habitId].name = name;
            habitsData[habitId].icon = icon || 'üìã';
            habitsData[habitId].target = target;
            habitsData[habitId].unit = unit;
            habitsData[habitId].updatedAt = new Date().toISOString();

            saveHabitsData();
            renderHabits();
            updateStats();
            MessageUtils.success('‰π†ÊÉØ‰øÆÊîπÊàêÂäüÔºÅ');
        }

        function deleteHabit(habitId) {
            const habit = habitsData[habitId];
            if (!habit) return;

            const confirmMessage = `Á°ÆÂÆöË¶ÅÂà†Èô§‰π†ÊÉØ"${habit.icon} ${habit.name}"ÂêóÔºü\n\nËøôÂ∞ÜÂà†Èô§ÊâÄÊúâÁõ∏ÂÖ≥ÁöÑËÆ∞ÂΩïÊï∞ÊçÆÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ`;
            
            if (confirm(confirmMessage)) {
                delete habitsData[habitId];
                saveHabitsData();
                renderHabits();
                renderCalendar();
                updateStats();
                MessageUtils.success(`Â∑≤Âà†Èô§‰π†ÊÉØ: ${habit.name}`);
                
                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                if (typeof ModalUtils !== 'undefined' && ModalUtils.hide) {
                    ModalUtils.hide();
                }
            }
        }

        function generateHabitInsights() {
            console.log('=== generateHabitInsights ÂáΩÊï∞ÂºÄÂßãÊâßË°å ===');
            
            try {
                // Ê£ÄÊü•ÂÆπÂô®ÂÖÉÁ¥†
                const insights = document.getElementById('habit-insights');
                console.log('Êü•Êâæ habit-insights ÂÖÉÁ¥†:', insights);
                if (!insights) {
                    console.error('Êâæ‰∏çÂà∞ habit-insights ÂÖÉÁ¥†');
                    return;
                }
                
                // Ëé∑Âèñ‰π†ÊÉØÊï∞ÊçÆ
                const habits = Object.values(habitsData);
                console.log('‰π†ÊÉØÊï∞ÊçÆ:', habits);
                console.log('‰π†ÊÉØÊï∞Èáè:', habits.length);
                
                if (habits.length === 0) {
                    console.log('Ê≤°Êúâ‰π†ÊÉØÊï∞ÊçÆÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ');
                    insights.innerHTML = `
                        <div style="background: #fff3e0; padding: 30px; border-radius: 12px; text-align: center; border-left: 4px solid #ff9800;">
                            <h3 style="color: #ef6c00; margin: 0 0 16px 0;">üìã ÊöÇÊó†‰π†ÊÉØÊï∞ÊçÆ</h3>
                            <p style="color: #666; margin: 0 0 20px 0;">ËØ∑ÂÖàÊ∑ªÂä†‰∏Ä‰∫õ‰π†ÊÉØÔºåÁÑ∂ÂêéËøõË°åÊâìÂç°ËÆ∞ÂΩïÔºåÊâçËÉΩÁîüÊàêÂàÜÊûêÊä•Âëä„ÄÇ</p>
                            <button onclick="document.getElementById('add-habit-btn').click()" 
                                    style="background: #2196f3; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                                ‚ûï Á´ãÂç≥Ê∑ªÂä†‰π†ÊÉØ
                            </button>
                        </div>
                    `;
                    return;
                }
                
                console.log('ÂºÄÂßãÂàÜÊûê‰π†ÊÉØÊï∞ÊçÆ...');
                
                // ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
                let bestHabit = habits[0];
                let maxRate = 0;
                let totalRecords = 0;
                let totalCompleted = 0;
                
                habits.forEach(habit => {
                    const records = habit.records || {};
                    const recordCount = Object.keys(records).length;
                    const completedCount = Object.values(records).filter(r => r && r.completed).length;
                    const rate = recordCount > 0 ? Math.round((completedCount / recordCount) * 100) : 0;
                    
                    console.log(`‰π†ÊÉØ ${habit.name}: ${completedCount}/${recordCount} = ${rate}%`);
                    
                    if (rate > maxRate) {
                        maxRate = rate;
                        bestHabit = habit;
                    }
                    
                    totalRecords += recordCount;
                    totalCompleted += completedCount;
                });
                
                const overallRate = totalRecords > 0 ? Math.round((totalCompleted / totalRecords) * 100) : 0;
                console.log('ÁªüËÆ°ÁªìÊûú:', { totalRecords, totalCompleted, overallRate, maxRate });
                
                // ÁîüÊàêÂàÜÊûêÁªìÊûúHTML
                const resultHtml = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div style="background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(76,175,80,0.05)); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 12px 0; color: #2e7d32; font-size: 1.1em;">üèÜ Ë°®Áé∞ÊúÄ‰Ω≥‰π†ÊÉØ</h4>
                            <p style="margin: 0; font-size: 1.2em; font-weight: 600;"><strong>${sanitizeHabitText(bestHabit.icon || 'üìã')} ${sanitizeHabitText(bestHabit.name || '')}</strong></p>
                            <p style="margin: 8px 0 0 0; color: #666; font-size: 1em;">ÂÆåÊàêÁéá: <strong style="color: #2e7d32;">${maxRate}%</strong></p>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(25,118,210,0.1), rgba(25,118,210,0.05)); padding: 20px; border-radius: 12px; border-left: 4px solid #1976d2; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 12px 0; color: #1976d2; font-size: 1.1em;">üìä Êï¥‰ΩìÊï∞ÊçÆ</h4>
                            <p style="margin: 0; font-size: 1.1em;">ÊÄªËÆ∞ÂΩïÊï∞: <strong>${totalRecords}</strong> Ê¨°</p>
                            <p style="margin: 8px 0 0 0; color: #666; font-size: 1em;">ÊÄªÂÆåÊàêÁéá: <strong style="color: #1976d2;">${overallRate}%</strong></p>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(255,152,0,0.1), rgba(255,152,0,0.05)); padding: 20px; border-radius: 12px; border-left: 4px solid #ff9800; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 12px 0; color: #ef6c00; font-size: 1.1em;">üí° ÊîπËøõÂª∫ËÆÆ</h4>
                            <p style="margin: 0; font-size: 1em; line-height: 1.4;">
                                ${overallRate >= 80 ? 'üéâ Ë°®Áé∞‰ºòÁßÄÔºÅÁªßÁª≠‰øùÊåÅËøôÁßçËâØÂ•ΩÁöÑ‰π†ÊÉØÔºÅ' : 
                                  overallRate >= 60 ? 'üëç ‰∏çÈîôÁöÑÂºÄÂßãÔºÅÂèØ‰ª•Â∞ùËØïÊèêÈ´ò‰∏ÄËá¥ÊÄß„ÄÇ' :
                                  overallRate >= 30 ? 'üí™ ÁªßÁª≠Âä™ÂäõÔºÅÂª∫ËÆÆ‰∏ìÊ≥®‰∫é1-2‰∏™Ê†∏ÂøÉ‰π†ÊÉØ„ÄÇ' :
                                  'üå± ÂàöÂàöÂºÄÂßãÔºÅÂª∫ËÆÆÂÖà‰ªéÊúÄÂÆπÊòìÁöÑ‰π†ÊÉØÂºÄÂßãÂüπÂÖª„ÄÇ'}
                            </p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 16px; background: rgba(0,0,0,0.03); border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 0.9em; color: #666;">
                            üìÖ ÂàÜÊûêÂÆåÊàêÊó∂Èó¥: ${new Date().toLocaleString()} | 
                            üìà Âü∫‰∫é ${habits.length} ‰∏™‰π†ÊÉØÁöÑ ${totalRecords} Êù°ËÆ∞ÂΩï
                        </p>
                    </div>
                `;
                
                console.log('Êõ¥Êñ∞ÊòæÁ§∫ÂÜÖÂÆπ...');
                insights.innerHTML = resultHtml;
                console.log('=== ‰π†ÊÉØÂàÜÊûêÂÆåÊàê ===');
                
            } catch (error) {
                console.error('ÁîüÊàê‰π†ÊÉØÂàÜÊûêÊó∂Âá∫Èîô:', error);
                const insights = document.getElementById('habit-insights');
                if (insights) {
                    insights.innerHTML = `
                        <div style="background: rgba(244,67,54,0.1); padding: 25px; border-radius: 12px; border-left: 4px solid #f44336; text-align: center;">
                            <h3 style="margin: 0 0 16px 0; color: #d32f2f;">‚ö†Ô∏è ÂàÜÊûêÂ§±Ë¥•</h3>
                            <p style="margin: 0 0 12px 0; color: #666;">ÁîüÊàê‰π†ÊÉØÂàÜÊûêÊó∂Âá∫Áé∞ÈîôËØØÔºåËØ∑ÈáçËØïÊàñÂà∑Êñ∞È°µÈù¢„ÄÇ</p>
                            <p style="margin: 0 0 20px 0; font-size: 0.85em; color: #999; font-family: monospace;">ÈîôËØØ‰ø°ÊÅØ: ${error.message}</p>
                            <button onclick="generateHabitInsights()" 
                                    style="background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                                üîÑ ÈáçÊñ∞ÂàÜÊûê
                            </button>
                        </div>
                    `;
                }
            }
        }

        // ÊòæÁ§∫Êó•ÊúüÂ∑•ÂÖ∑ÊèêÁ§∫ - ÁÆÄÂåñÁâàÊú¨
        function showDayTooltip(event, dateKey, dayStats) {
            console.log('=== showDayTooltip Ë¢´Ë∞ÉÁî® ===', { dateKey, dayStats });
            
            const tooltip = document.getElementById('calendar-tooltip');
            const tooltipContent = document.getElementById('tooltip-content');
            
            if (!tooltip || !tooltipContent) {
                console.error('Êâæ‰∏çÂà∞Â∑•ÂÖ∑ÊèêÁ§∫ÂÖÉÁ¥†');
                return;
            }
            
            console.log('Â∑•ÂÖ∑ÊèêÁ§∫ÂÖÉÁ¥†ÊâæÂà∞ÔºåÂºÄÂßãÊòæÁ§∫...');

            // ÁÆÄÂåñÁöÑÂ∑•ÂÖ∑ÊèêÁ§∫ÂÜÖÂÆπ
            const date = new Date(dateKey);
            const formattedDate = date.toLocaleDateString('zh-CN', {
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });

            // Ëé∑ÂèñÂΩìÂ§©ÁöÑËØ¶ÁªÜ‰π†ÊÉØÊï∞ÊçÆ
            const dayDetails = getDayHabitDetails(dateKey);
            
            let tooltipHtml = `
                <h4 style="margin: 0 0 12px 0; color: #1976d2; font-size: 1.1em;">üìÖ ${formattedDate}</h4>
                <div style="margin-bottom: 12px; padding: 8px; background: rgba(33,150,243,0.1); border-radius: 8px; text-align: center;">
                    <span style="font-weight: 600; color: #1976d2; font-size: 1em;">ÂÆåÊàêËøõÂ∫¶: ${dayStats.completed}/${dayStats.total}</span>
                </div>
            `;

            if (dayDetails.habits.length === 0) {
                tooltipHtml += `
                    <div style="text-align: center; color: #666; padding: 16px;">
                        <div style="font-size: 2em; margin-bottom: 8px;">üìù</div>
                        <p style="margin: 0; font-size: 0.9em;">Ëøô‰∏ÄÂ§©ËøòÊ≤°Êúâ‰π†ÊÉØËÆ∞ÂΩï</p>
                    </div>
                `;
            } else {
                // ÂàÜÁ±ªÊòæÁ§∫‰π†ÊÉØ
                const completedHabits = dayDetails.habits.filter(h => h.record && h.record.completed);
                const skippedHabits = dayDetails.habits.filter(h => h.record && h.record.skipped);
                const missedHabits = dayDetails.habits.filter(h => !h.record || (!h.record.completed && !h.record.skipped));

                // ÊòæÁ§∫Â∑≤ÂÆåÊàêÁöÑ‰π†ÊÉØ
                if (completedHabits.length > 0) {
                    tooltipHtml += `
                        <div style="margin-bottom: 12px;">
                            <h5 style="margin: 0 0 6px 0; color: #2e7d32; font-size: 1em; display: flex; align-items: center;">
                                ‚úÖ Â∑≤ÂÆåÊàê (${completedHabits.length})
                            </h5>
                            <div style="max-height: 80px; overflow-y: auto;">
                    `;
                    completedHabits.forEach(habit => {
                        const safeIcon = sanitizeHabitText(habit.icon || 'üìã');
                        const safeName = sanitizeHabitText(habit.name || '');
                        tooltipHtml += `
                            <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 0.9em;">
                                <span style="font-size: 1.1em;">${safeIcon}</span>
                                <span style="color: #333; flex: 1;">${safeName}</span>
                                <span style="background: #4caf50; color: white; font-size: 0.8em; padding: 2px 8px; border-radius: 8px;">ÂÆåÊàê</span>
                            </div>
                        `;
                    });
                    tooltipHtml += `</div></div>`;
                }

                // ÊòæÁ§∫Â∑≤Ë∑≥ËøáÁöÑ‰π†ÊÉØ
                if (skippedHabits.length > 0) {
                    tooltipHtml += `
                        <div style="margin-bottom: 12px;">
                            <h5 style="margin: 0 0 6px 0; color: #ef6c00; font-size: 1em; display: flex; align-items: center;">
                                ‚è≠Ô∏è Â∑≤Ë∑≥Ëøá (${skippedHabits.length})
                            </h5>
                            <div style="max-height: 70px; overflow-y: auto;">
                    `;
                    skippedHabits.forEach(habit => {
                        const safeIcon = sanitizeHabitText(habit.icon || 'üìã');
                        const safeName = sanitizeHabitText(habit.name || '');
                        tooltipHtml += `
                            <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 0.9em;">
                                <span style="font-size: 1.1em;">${safeIcon}</span>
                                <span style="color: #333; flex: 1;">${safeName}</span>
                                <span style="background: #ff9800; color: white; font-size: 0.8em; padding: 2px 8px; border-radius: 8px;">Ë∑≥Ëøá</span>
                            </div>
                        `;
                    });
                    tooltipHtml += `</div></div>`;
                }

                // ÊòæÁ§∫Êú™ÂÆåÊàêÁöÑ‰π†ÊÉØ
                if (missedHabits.length > 0) {
                    tooltipHtml += `
                        <div style="margin-bottom: 8px;">
                            <h5 style="margin: 0 0 6px 0; color: #d32f2f; font-size: 1em; display: flex; align-items: center;">
                                ‚ùå Êú™ÂÆåÊàê (${missedHabits.length})
                            </h5>
                            <div style="max-height: 70px; overflow-y: auto;">
                    `;
                    missedHabits.forEach(habit => {
                        const safeIcon = sanitizeHabitText(habit.icon || 'üìã');
                        const safeName = sanitizeHabitText(habit.name || '');
                        tooltipHtml += `
                            <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 0.9em;">
                                <span style="font-size: 1.1em;">${safeIcon}</span>
                                <span style="color: #333; flex: 1;">${safeName}</span>
                                <span style="background: #f44336; color: white; font-size: 0.8em; padding: 2px 8px; border-radius: 8px;">Êú™ÂÅö</span>
                            </div>
                        `;
                    });
                    tooltipHtml += `</div></div>`;
                }
            }

            // ËÆæÁΩÆÂÜÖÂÆπ
            tooltipContent.innerHTML = tooltipHtml;
            console.log('Â∑•ÂÖ∑ÊèêÁ§∫ÂÜÖÂÆπÂ∑≤ËÆæÁΩÆ');

            // Á≤æÁ°ÆÂÆö‰ΩçÂà∞Êó•ÊúüÊï∞Â≠óÊóÅËæπ - ‰ΩøÁî®fixedÂÆö‰Ωç
            const rect = event.target.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // ËÆæÁΩÆÂõ∫ÂÆöÂÆö‰ΩçÂπ∂Ëé∑ÂèñÂ∞∫ÂØ∏
            tooltip.style.position = 'fixed';
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '1';
            tooltip.style.display = 'block';
            
            // Á≠âÂæÖ‰∏ÄÂ∏ßÁ°Æ‰øùÂ∞∫ÂØ∏ËÆ°ÁÆóÊ≠£Á°Æ
            setTimeout(() => {
                const tooltipRect = tooltip.getBoundingClientRect();
                
                let left, top;
                const gap = 8; // ‰∏éÊó•ÊúüÁöÑÈó¥Ë∑ù
                
                // ÈªòËÆ§ÊòæÁ§∫Âú®Âè≥‰æß
                left = rect.right + gap;
                top = rect.top;
                
                // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖÂá∫Âè≥ËæπÁïå
                if (left + tooltipRect.width > viewportWidth - 20) {
                    // Êîπ‰∏∫Â∑¶‰æßÊòæÁ§∫
                    left = rect.left - tooltipRect.width - gap;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖÂá∫Â∑¶ËæπÁïå
                if (left < 20) {
                    // Âº∫Âà∂ÊòæÁ§∫Âú®Âè≥‰æßÔºå‰ΩÜÈôêÂà∂Âú®Â±èÂπïÂÜÖ
                    left = Math.min(rect.right + gap, viewportWidth - tooltipRect.width - 20);
                }
                
                // ÂûÇÁõ¥‰ΩçÁΩÆË∞ÉÊï¥
                if (top + tooltipRect.height > viewportHeight - 20) {
                    top = viewportHeight - tooltipRect.height - 20;
                }
                if (top < 20) {
                    top = 20;
                }
                
                // Â∫îÁî®ÊúÄÁªà‰ΩçÁΩÆ
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
                tooltip.style.transform = 'scale(1)';
                tooltip.className = `calendar-tooltip show`;
                
                console.log('=== FixedÂÆö‰ΩçË∞ÉËØï ===');
                console.log('Êó•Êúü‰ΩçÁΩÆ:', { left: rect.left, top: rect.top, right: rect.right, bottom: rect.bottom });
                console.log('Â∑•ÂÖ∑ÊèêÁ§∫‰ΩçÁΩÆ:', { left, top, width: tooltipRect.width, height: tooltipRect.height });
                
            }, 10);
        }

        // ÈöêËóèÊó•ÊúüÂ∑•ÂÖ∑ÊèêÁ§∫
        function hideDayTooltip() {
            console.log('=== hideDayTooltip Ë¢´Ë∞ÉÁî® ===');
            const tooltip = document.getElementById('calendar-tooltip');
            if (tooltip) {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
                tooltip.classList.remove('show');
                console.log('Â∑•ÂÖ∑ÊèêÁ§∫Â∑≤ÈöêËóè');
            }
        }

        // Ëé∑ÂèñÊåáÂÆöÊó•ÊúüÁöÑ‰π†ÊÉØËØ¶ÊÉÖ
        function getDayHabitDetails(dateKey) {
            const habits = Object.values(habitsData);
            const dayHabits = habits.map(habit => ({
                ...habit,
                record: habit.records[dateKey] || null
            }));

            return {
                habits: dayHabits,
                total: habits.length,
                completed: dayHabits.filter(h => h.record && h.record.completed).length,
                skipped: dayHabits.filter(h => h.record && h.record.skipped).length
            };
        }

        // Ê∏ÖÁêÜ‰π†ÊÉØÊï∞ÊçÆ‰∏≠ÁöÑÁºñÁ†ÅÈóÆÈ¢ò
        function cleanHabitData() {
            try {
                console.log('üßπ ÂºÄÂßãÊ∏ÖÁêÜ‰π†ÊÉØÊï∞ÊçÆ...');
                
                let foundCorruption = false;
                const cleanedData = {};
                
                // ÈÅçÂéÜÊâÄÊúâ‰π†ÊÉØ
                for (const [habitId, habit] of Object.entries(habitsData)) {
                    if (!habit || typeof habit !== 'object') {
                        console.warn('‚ö†Ô∏è Ë∑≥ËøáÊó†Êïà‰π†ÊÉØ:', habitId);
                        continue;
                    }
                    
                    const cleanedHabit = {
                        id: habitId,
                        name: sanitizeHabitText(habit.name || ''),
                        icon: sanitizeHabitText(habit.icon || 'üìã'),
                        target: parseInt(habit.target) || 1,
                        unit: sanitizeHabitText(habit.unit || 'Ê¨°'),
                        createdAt: habit.createdAt || new Date().toISOString(),
                        updatedAt: habit.updatedAt,
                        records: {}
                    };
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÁºñÁ†ÅÈóÆÈ¢ò
                    if (habit.name && hasEncodingIssues(habit.name)) {
                        console.log(`üóëÔ∏è ÂèëÁé∞ÊçüÂùè‰π†ÊÉØÂêçÁß∞: ${habit.name}`);
                        foundCorruption = true;
                        continue; // Ë∑≥ËøáÊçüÂùèÁöÑ‰π†ÊÉØ
                    }
                    
                    // Ê∏ÖÁêÜËÆ∞ÂΩïÊï∞ÊçÆ
                    if (habit.records && typeof habit.records === 'object') {
                        for (const [date, record] of Object.entries(habit.records)) {
                            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                                console.warn('‚ö†Ô∏è Ë∑≥ËøáÊó†ÊïàÊó•Êúü:', date);
                                continue;
                            }
                            
                            if (record && typeof record === 'object') {
                                cleanedHabit.records[date] = {
                                    completed: Boolean(record.completed),
                                    skipped: Boolean(record.skipped),
                                    timestamp: record.timestamp || new Date().toISOString()
                                };
                            }
                        }
                    }
                    
                    cleanedData[habitId] = cleanedHabit;
                }
                
                if (foundCorruption) {
                    console.log('‚úÖ ÂèëÁé∞Âπ∂Ê∏ÖÁêÜ‰∫ÜÊçüÂùèÁöÑ‰π†ÊÉØÊï∞ÊçÆ');
                    habitsData = cleanedData;
                    saveHabitsData();
                    
                    // ÈáçÊñ∞Ê∏≤ÊüìÁïåÈù¢
                    renderHabits();
                    renderCalendar();
                    updateStats();
                    
                    MessageUtils.success('Â∑≤Ê∏ÖÁêÜÊçüÂùèÁöÑ‰π†ÊÉØÊï∞ÊçÆÔºÅ');
                    return true;
                } else {
                    console.log('‚úÖ ‰π†ÊÉØÊï∞ÊçÆÂÆåÊï¥ÔºåÊó†ÈúÄÊ∏ÖÁêÜ');
                    MessageUtils.info('Êï∞ÊçÆÊ£ÄÊü•ÂÆåÊàêÔºåÊú™ÂèëÁé∞ÈóÆÈ¢ò');
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå Ê∏ÖÁêÜ‰π†ÊÉØÊï∞ÊçÆÂ§±Ë¥•:', error);
                MessageUtils.error('Êï∞ÊçÆÊ∏ÖÁêÜÂ§±Ë¥•: ' + error.message);
                return false;
            }
        }
        
        // Ê£ÄÊü•ÊñáÊú¨ÊòØÂê¶ÊúâÁºñÁ†ÅÈóÆÈ¢ò
        function hasEncodingIssues(text) {
            if (typeof text !== 'string') return false;
            
            // Ê£ÄÊü•Â∏∏ËßÅÁöÑÁºñÁ†ÅÈîôËØØÂ≠óÁ¨¶
            const encodingIssuePatterns = [
                /√Ç+/g,
                /\u00C2/g,
                /√É¬¢√¢‚Äö¬¨/g,
                /√¢‚Ç¨/g,
                /¬•‚Ç¨/g,
                /¬Æ¬Æ/g,
                /[^\x20-\x7E\u4e00-\u9fff]/g // ÈùûÊ≠£Â∏∏ÊòæÁ§∫Â≠óÁ¨¶
            ];
            
            return encodingIssuePatterns.some(pattern => pattern.test(text));
        }
        
        // Ê∏ÖÁêÜÊñáÊú¨‰∏≠ÁöÑÁºñÁ†ÅÈóÆÈ¢ò
        function sanitizeHabitText(text) {
            if (typeof text !== 'string') {
                return String(text || '');
            }
            
            let cleaned = text;
            
            // ÁßªÈô§ÊàñÊõøÊç¢ÁºñÁ†ÅÈîôËØØÂ≠óÁ¨¶
            cleaned = cleaned
                .replace(/√Ç+/g, '') // ÁßªÈô§√ÇÂ≠óÁ¨¶
                .replace(/\u00C2/g, '') // ÁßªÈô§C2Â≠óÁ¨¶
                .replace(/√É¬¢√¢‚Äö¬¨√¢‚Äû¬¢/g, "'") // ‰øÆÂ§çÊô∫ËÉΩÂºïÂè∑
                .replace(/√É¬¢√¢‚Äö¬¨√Ç/g, '‚Äì') // ‰øÆÂ§çÁ†¥ÊäòÂè∑
                .replace(/√É¬¢√¢‚Äö¬¨√Ö"/g, '"') // ‰øÆÂ§çÂ∑¶ÂèåÂºïÂè∑
                .replace(/√É¬¢√¢‚Äö¬¨/g, '')
                .replace(/√¢‚Ç¨‚Ñ¢/g, "'")
                .replace(/√¢‚Ç¨≈ì/g, '"')
                .replace(/√¢‚Ç¨/g, '"')
                .replace(/√¢‚Äû¬¢/g, '')
                .replace(/¬•‚Ç¨/g, '')
                .replace(/¬Æ¬Æ/g, '')
                .replace(/[\x00-\x1F\x7F-\x9F]/g, '') // ÁßªÈô§ÊéßÂà∂Â≠óÁ¨¶
                .replace(/\uFEFF/g, '') // ÁßªÈô§BOM
                .replace(/\u200B/g, '') // ÁßªÈô§Èõ∂ÂÆΩÁ©∫Ê†º
                .replace(/\u00A0/g, ' ') // ÊõøÊç¢‰∏çÈó¥Êñ≠Á©∫Ê†º
                .replace(/\s+/g, ' ') // ÂêàÂπ∂Â§ö‰∏™Á©∫Ê†º
                .trim();
            
            // Â¶ÇÊûúÊ∏ÖÁêÜÂêé‰∏∫Á©∫ÔºåËøîÂõûÈªòËÆ§ÂÄº
            if (!cleaned) {
                return '';
            }
            
            return cleaned;
        }
        
        // Âº∫Âà∂‰øùÂ≠ò‰π†ÊÉØÊï∞ÊçÆ
        async function forceSaveHabitData() {
            try {
                console.log('üíæ ÂºÄÂßãÂº∫Âà∂‰øùÂ≠ò‰π†ÊÉØÊï∞ÊçÆ...');
                
                const confirmed = confirm(
                    'Â∞ÜÂº∫Âà∂‰øùÂ≠òÂΩìÂâç‰π†ÊÉØÊï∞ÊçÆÔºåÂπ∂Ê∏ÖÁêÜ‰ªª‰ΩïÊçüÂùèÁöÑÊï∞ÊçÆ„ÄÇ\n\n' +
                    'ËøôÂ∞ÜÁ°Æ‰øùÊï∞ÊçÆÁöÑÂÆåÊï¥ÊÄßÂíåÊ≠£Á°ÆÊÄß„ÄÇ\n\n' +
                    'ÊòØÂê¶ÁªßÁª≠Ôºü'
                );
                
                if (!confirmed) {
                    return;
                }
                
                // 1. ÂÖàÊ∏ÖÁêÜÊï∞ÊçÆ
                console.log('üßπ Ê≠•È™§1ÔºöÊ∏ÖÁêÜÊçüÂùèÊï∞ÊçÆ');
                cleanHabitData();
                
                // 2. È™åËØÅÊï∞ÊçÆÊ†ºÂºè
                console.log('‚úÖ Ê≠•È™§2ÔºöÈ™åËØÅÊï∞ÊçÆÊ†ºÂºè');
                const validatedData = validateHabitData(habitsData);
                habitsData = validatedData;
                
                // 3. Âº∫Âà∂‰øùÂ≠òÂà∞localStorage
                console.log('üíæ Ê≠•È™§3Ôºö‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®');
                const jsonString = JSON.stringify(habitsData, null, 0);
                localStorage.setItem('habitTrackerData', jsonString);
                
                // 4. Â¶ÇÊûúÊúâÂêåÊ≠•ÊúçÂä°ÔºåÊé®ÈÄÅÂà∞‰∫ëÁ´Ø
                if (window.syncService) {
                    const status = window.syncService.getSyncStatus();
                    
                    if (status.enabled) {
                        try {
                            console.log('‚òÅÔ∏è Ê≠•È™§4ÔºöÂêåÊ≠•Âà∞‰∫ëÁ´Ø');
                            MessageUtils.info('Ê≠£Âú®ÂêåÊ≠•Âà∞‰∫ëÁ´Ø...');
                            await window.syncService.manualSync();
                            MessageUtils.success('‚úÖ ‰π†ÊÉØÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂπ∂ÂêåÊ≠•Âà∞‰∫ëÁ´ØÔºÅ');
                        } catch (syncError) {
                            console.error('‚ùå ‰∫ëÁ´ØÂêåÊ≠•Â§±Ë¥•:', syncError);
                            MessageUtils.warning('Êú¨Âú∞‰øùÂ≠òÊàêÂäüÔºå‰ΩÜ‰∫ëÁ´ØÂêåÊ≠•Â§±Ë¥•: ' + syncError.message);
                        }
                    } else {
                        MessageUtils.success('‚úÖ ‰π†ÊÉØÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞ÔºÅ');
                    }
                } else {
                    MessageUtils.success('‚úÖ ‰π†ÊÉØÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞ÔºÅ');
                }
                
                // 5. ÈáçÊñ∞Ê∏≤ÊüìÁïåÈù¢Á°Æ‰øùÊï∞ÊçÆ‰∏ÄËá¥ÊÄß
                console.log('üé® Ê≠•È™§5ÔºöÈáçÊñ∞Ê∏≤ÊüìÁïåÈù¢');
                renderHabits();
                renderCalendar();
                updateStats();
                
                console.log('‚úÖ Âº∫Âà∂‰øùÂ≠òÂÆåÊàê');
                
            } catch (error) {
                console.error('‚ùå Âº∫Âà∂‰øùÂ≠òÂ§±Ë¥•:', error);
                MessageUtils.error('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
            }
        }
        
        // È™åËØÅ‰π†ÊÉØÊï∞ÊçÆÊ†ºÂºè
        function validateHabitData(data) {
            const validatedData = {};
            
            if (!data || typeof data !== 'object') {
                console.warn('‚ö†Ô∏è ‰π†ÊÉØÊï∞ÊçÆÊ†ºÂºèÊó†ÊïàÔºåËøîÂõûÁ©∫ÂØπË±°');
                return {};
            }
            
            for (const [habitId, habit] of Object.entries(data)) {
                if (!habit || typeof habit !== 'object') {
                    console.warn('‚ö†Ô∏è Ë∑≥ËøáÊó†Êïà‰π†ÊÉØ:', habitId);
                    continue;
                }
                
                // È™åËØÅÂøÖÈúÄÂ≠óÊÆµ
                if (!habit.name || !habit.id) {
                    console.warn('‚ö†Ô∏è Ë∑≥ËøáÁº∫Â∞ëÂøÖÈúÄÂ≠óÊÆµÁöÑ‰π†ÊÉØ:', habitId);
                    continue;
                }
                
                validatedData[habitId] = {
                    id: habit.id,
                    name: sanitizeHabitText(habit.name),
                    icon: sanitizeHabitText(habit.icon || 'üìã'),
                    target: Math.max(1, parseInt(habit.target) || 1),
                    unit: sanitizeHabitText(habit.unit || 'Ê¨°'),
                    createdAt: habit.createdAt || new Date().toISOString(),
                    updatedAt: habit.updatedAt,
                    records: habit.records || {}
                };
            }
            
            console.log(`‚úÖ È™åËØÅÂÆåÊàêÔºåÊúâÊïà‰π†ÊÉØ: ${Object.keys(validatedData).length} ‰∏™`);
            return validatedData;
        }

        function saveHabitsData() {
            try {
                // Âú®‰øùÂ≠òÂâçÂÖàÊ∏ÖÁêÜÊï∞ÊçÆ
                const cleanedData = validateHabitData(habitsData);
                const jsonString = JSON.stringify(cleanedData, null, 0);
                localStorage.setItem('habitTrackerData', jsonString);
                habitsData = cleanedData;
            } catch (error) {
                console.error('‚ùå ‰øùÂ≠ò‰π†ÊÉØÊï∞ÊçÆÂ§±Ë¥•:', error);
                MessageUtils.error('Êï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
    </script>
    
    <!-- ÂêåÊ≠•ÊúçÂä° -->
    <script src="sync-service.js"></script>
    <script src="sync-providers.js"></script>
    <!-- ÈÄöÁî®Ëá™Âä®ÂêåÊ≠•ÂäüËÉΩ -->
    <script src="universal-auto-sync.js"></script>
    <!-- ÂÖ®Ëá™Âä®ÂêéÂè∞ÂêåÊ≠• -->
    <script src="auto-background-sync.js"></script>
    <script src="add-ai-to-all-pages.js"></script>
    <script src="ai-fix-universal.js"></script>  <!-- AIÂàÜÊûêÂäüËÉΩ‰øÆÂ§ç -->
</body>

</html>

