<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script src="config.js"></script>
    
    <!-- Firebaseé…ç½® -->
    <script src="firebase-config.js"></script>
    
    <!-- åŒæ­¥ä¿®å¤å·¥å…· -->
    <script src="sync-fix.js"></script>
    
    <!-- WebSocket å®æ—¶åŒæ­¥ -->
    <script src="websocket-sync.js"></script>
    
    <!-- Firebaseæ•°æ®åº“åŒæ­¥ -->
    <script src="firebase-database-sync.js"></script>
    <script src="gemini-ai-assistant.js"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½ä¹ æƒ¯è¿½è¸ª - æ™ºèƒ½è®¡åˆ’ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ai-assistant-styles.css">
    <style>
        .habit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .habit-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .habit-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .habit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .habit-name {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--theme-color);
        }

        .habit-streak {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .habit-progress {
            margin-bottom: 16px;
        }

        .habit-progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .habit-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--theme-color), #1565c0);
            transition: width 0.6s ease;
            border-radius: 4px;
        }

        .habit-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }

        .habit-actions {
            display: flex;
            gap: 8px;
        }

        .habit-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .habit-btn.check {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }

        .habit-btn.check:hover {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
        }

        .habit-btn.skip {
            background: linear-gradient(135deg, #ff9800, #ef6c00);
            color: white;
        }

        .habit-btn.edit {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
        }

        .calendar-view {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 12px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 24px;
            max-height: 32px;
        }

        .calendar-day.completed {
            background: #4caf50;
            color: white;
        }

        .calendar-day.skipped {
            background: #ff9800;
            color: white;
        }

        .calendar-day.missed {
            background: #f44336;
            color: white;
        }

        .calendar-day.today {
            border: 2px solid var(--theme-color);
            background: var(--theme-color-light);
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .stat-value {
            font-size: 1.6em;
            font-weight: bold;
            color: var(--theme-color);
            margin-bottom: 2px;
        }

        .stat-label {
            color: #666;
            font-size: 0.8em;
        }

        /* æ—¥å†å·¥å…·æç¤ºæ ·å¼ */
        .calendar-tooltip {
            position: fixed;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 260px;
            max-width: 340px;
            max-height: 380px;
            overflow-y: auto;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.25s ease;
            pointer-events: auto;
            visibility: hidden;
            transform-origin: left center;
        }

        .calendar-tooltip.show {
            opacity: 1;
            transform: scale(1) !important;
        }

        /* ä¸åŒä½ç½®çš„å·¥å…·æç¤ºæ ·å¼ */
        .calendar-tooltip.position-right {
            transform-origin: left center;
        }

        .calendar-tooltip.position-left {
            transform-origin: right center;
        }

        .calendar-tooltip.position-bottom {
            transform-origin: center top;
        }

        .calendar-tooltip.position-top {
            transform-origin: center bottom;
        }

        /* ç§»é™¤ç®­å¤´ - å› ä¸ºå·¥å…·æç¤ºå·²ç»ç´§è´´æ˜¾ç¤º */

        .calendar-tooltip h4 {
            margin: 0 0 12px 0;
            color: var(--theme-color);
            font-size: 1em;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tooltip-habit-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .tooltip-habit-item:last-child {
            border-bottom: none;
        }

        .tooltip-habit-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        .tooltip-habit-name {
            flex: 1;
            color: #333;
            font-weight: 500;
        }

        .tooltip-habit-status {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .tooltip-habit-status.completed {
            background: #4caf50;
            color: white;
        }

        .tooltip-habit-status.skipped {
            background: #ff9800;
            color: white;
        }

        .tooltip-habit-status.missed {
            background: #f44336;
            color: white;
        }

        .tooltip-stats {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 0.85em;
        }

        .tooltip-stat {
            text-align: center;
            padding: 6px;
            background: rgba(33, 150, 243, 0.05);
            border-radius: 6px;
        }

        .tooltip-stat-value {
            font-weight: bold;
            color: var(--theme-color);
            font-size: 1.1em;
        }

        .tooltip-stat-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="page-header">
            <a href="index.html" class="back-to-home">â† è¿”å›ä¸»é¡µ</a>
            <h1 class="page-title">ğŸ“ˆ æ™ºèƒ½ä¹ æƒ¯è¿½è¸ª</h1>
            <div style="display: flex; gap: 8px;">
                <a href="day_plan.html" class="btn-main" style="font-size: 0.9em;">æ—¥è®¡åˆ’</a>
                <button type="button" id="clean-habit-data-btn" class="btn-main" style="background: #ff9800; color: white;">ğŸ§¹ æ¸…ç†æ•°æ®</button>
                <button type="button" id="force-save-habit-btn" class="btn-main" style="background: #4caf50; color: white;">ğŸ’¾ ä¿å­˜</button>
                <button type="button" id="add-habit-btn" class="btn-main">â• æ–°å¢ä¹ æƒ¯</button>
            </div>
        </div>

        <!-- AIæ™ºèƒ½åˆ†æåŒºåŸŸ - æ”¾åœ¨æœ€é¡¶éƒ¨ -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">
                <div style="flex: 1;">
                    <h3 style="color: white; margin: 0 0 8px 0; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                        ğŸ¤– AI æ™ºèƒ½åˆ†æ
                        <span style="font-size: 0.5em; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px;">Gemini 2.5 Pro</span>
                    </h3>
                    <p style="color: rgba(255,255,255,0.95); margin: 0; font-size: 1em; line-height: 1.6;">
                        è®© AI åˆ†ææ‚¨çš„ä¹ æƒ¯è¿½è¸ªæ•°æ®ï¼Œæä¾›ä¸“ä¸šå»ºè®®å’Œä¼˜åŒ–æ–¹æ¡ˆ
                    </p>
                </div>
                <button type="button" onclick="startAIAnalysis()" style="background: white; color: #667eea; border: none; padding: 16px 40px; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; white-space: nowrap;">
                    ğŸš€ å¼€å§‹åˆ†æ
                </button>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-value" id="total-habits">0</div>
                <div class="stat-label">æ€»ä¹ æƒ¯æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="active-streaks">0</div>
                <div class="stat-label">æ´»è·ƒè¿ç»­</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completion-rate">0%</div>
                <div class="stat-label">å®Œæˆç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="longest-streak">0</div>
                <div class="stat-label">æœ€é•¿è¿ç»­</div>
            </div>
        </div>

        <!-- ä»Šæ—¥ä¹ æƒ¯ -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                ğŸ¯ ä»Šæ—¥ä¹ æƒ¯æ‰“å¡
                <span id="today-progress" style="background: #4caf50; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">0/0</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" id="add-habit-btn-2" class="btn-main">â• æ–°å¢ä¹ æƒ¯</button>
                <button type="button" id="habits-analytics-btn" onclick="showHabitAnalytics()" style="background: #e3f2fd; color: #1976d2; cursor: pointer; border: 1px solid #1976d2; border-radius: 6px; padding: 8px 12px; font-size: 0.9em; transition: all 0.3s ease;">ğŸ“Š ä¹ æƒ¯åˆ†æ</button>
            </div>
        </div>

        <!-- ä¹ æƒ¯å¡ç‰‡ç½‘æ ¼ -->
        <div id="habits-grid" class="habit-grid">
            <!-- ä¹ æƒ¯å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- æœˆåº¦æ—¥å†è§†å›¾ -->
        <div class="calendar-view" style="background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; color: var(--theme-color); font-size: 1.1em;">ğŸ“… æœˆåº¦æ—¥å†</h3>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <button type="button" id="cal-prev" style="padding: 3px 6px; border: 1px solid #ddd; background: white; border-radius: 3px; font-size: 0.9em; cursor: pointer;">â†</button>
                    <span id="calendar-month" style="font-weight: 600; min-width: 80px; text-align: center; font-size: 0.9em;"></span>
                    <button type="button" id="cal-next" style="padding: 3px 6px; border: 1px solid #ddd; background: white; border-radius: 3px; font-size: 0.9em; cursor: pointer;">â†’</button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 6px;">
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">æ—¥</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">ä¸€</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">äºŒ</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">ä¸‰</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">å››</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">äº”</div>
                <div style="text-align: center; font-weight: 600; color: #666; padding: 4px; font-size: 0.8em;">å…­</div>
            </div>
            
            <div id="calendar-grid" class="calendar-grid">
                <!-- æ—¥å†å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- å›¾ä¾‹ -->
            <div style="display: flex; justify-content: center; gap: 16px; margin-top: 12px; font-size: 0.8em;">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 10px; height: 10px; background: #4caf50; border-radius: 50%;"></div>
                    <span>å·²å®Œæˆ</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 10px; height: 10px; background: #ff9800; border-radius: 50%;"></div>
                    <span>å·²è·³è¿‡</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 10px; height: 10px; background: #f44336; border-radius: 50%;"></div>
                    <span>æœªå®Œæˆ</span>
                </div>
            </div>
        </div>

        <!-- ä¹ æƒ¯æ´å¯Ÿ -->
        <div class="plan-item-header">
            <label>ğŸ§  æ™ºèƒ½ä¹ æƒ¯æ´å¯Ÿ</label>
            <button type="button" id="generate-insights-btn" class="btn-main">ğŸ”„ ç”Ÿæˆæ´å¯Ÿ</button>
        </div>
        <div id="habit-insights" style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 16px; min-height: 80px; border: 1px solid rgba(0,0,0,0.1);">
            <p style="text-align: center; color: #666; margin: 20px 0; font-size: 0.9em;">ç‚¹å‡»"ğŸ“Š ä¹ æƒ¯åˆ†æ"æŸ¥çœ‹æ‚¨çš„ä¹ æƒ¯åˆ†ææŠ¥å‘Š</p>
        </div>

        <!-- æ—¥å†å·¥å…·æç¤º -->
        <div id="calendar-tooltip" class="calendar-tooltip">
            <div id="tooltip-content"></div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // å…¨å±€é”™è¯¯æ•è·
        window.addEventListener('error', function(e) {
            console.error('JavaScript é”™è¯¯:', e.error);
            console.error('é”™è¯¯ä¿¡æ¯:', e.message);
            console.error('é”™è¯¯ä½ç½®:', e.filename, e.lineno, e.colno);
        });

        // ä¹ æƒ¯è¿½è¸ªæ•°æ®
        let habitsData = JSON.parse(localStorage.getItem('habitTrackerData') || '{}');
        console.log('åŠ è½½çš„ä¹ æƒ¯æ•°æ®:', habitsData);
        let currentCalendarMonth = new Date();

        // é»˜è®¤ä¹ æƒ¯æ¨¡æ¿
        const defaultHabits = [
            { name: 'æ™¨é—´é”»ç‚¼', icon: 'ğŸ’ª', target: 30, unit: 'åˆ†é’Ÿ' },
            { name: 'é˜…è¯»å­¦ä¹ ', icon: 'ğŸ“š', target: 1, unit: 'å°æ—¶' },
            { name: 'å†¥æƒ³æ”¾æ¾', icon: 'ğŸ§˜', target: 15, unit: 'åˆ†é’Ÿ' },
            { name: 'å–æ°´', icon: 'ğŸ’§', target: 8, unit: 'æ¯' },
            { name: 'æ—©ç¡', icon: 'ğŸ˜´', target: 1, unit: 'æ¬¡' }
        ];

        // ä¹ æƒ¯åˆ†æä¸»å‡½æ•°
        function showHabitAnalytics() {
            console.log('å¼€å§‹ç”Ÿæˆä¹ æƒ¯åˆ†æ');
            
            const insights = document.getElementById('habit-insights');
            if (!insights) {
                console.error('æ‰¾ä¸åˆ°ä¹ æƒ¯æ´å¯Ÿå®¹å™¨');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            insights.innerHTML = `
                <div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); padding: 25px; border-radius: 12px; text-align: center; border-left: 4px solid #2196f3; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: inline-block; animation: spin 1s linear infinite; font-size: 2em; margin-bottom: 10px;">ğŸ”„</div>
                    <h3 style="color: #1976d2; margin: 0 0 8px 0;">æ­£åœ¨åˆ†ææ‚¨çš„ä¹ æƒ¯æ•°æ®...</h3>
                    <p style="color: #666; margin: 0; font-size: 0.9em;">è¯·ç¨å€™ï¼Œæ­£åœ¨ç”Ÿæˆä¸ªæ€§åŒ–åˆ†ææŠ¥å‘Š</p>
                </div>
                <style>
                    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                </style>
            `;
            
            // å»¶è¿Ÿæ‰§è¡Œåˆ†æ
            setTimeout(() => {
                generateAnalysisReport();
            }, 800);
        }

        // ç”Ÿæˆåˆ†ææŠ¥å‘Š
        function generateAnalysisReport() {
            const insights = document.getElementById('habit-insights');
            const habits = Object.values(habitsData);
            
            if (habits.length === 0) {
                insights.innerHTML = `
                    <div style="background: linear-gradient(135deg, #fff3e0, #fce4ec); padding: 30px; border-radius: 12px; text-align: center; border-left: 4px solid #ff9800; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“‹</div>
                        <h3 style="color: #ef6c00; margin: 0 0 12px 0;">æš‚æ— ä¹ æƒ¯æ•°æ®</h3>
                        <p style="color: #666; margin: 0 0 20px 0; line-height: 1.5;">
                            å¼€å§‹æ‚¨çš„ä¹ æƒ¯å…»æˆä¹‹æ—…ï¼<br>
                            æ·»åŠ ä¹ æƒ¯å¹¶åšæŒæ‰“å¡ï¼Œå³å¯è·å¾—è¯¦ç»†çš„åˆ†ææŠ¥å‘Šã€‚
                        </p>
                        <button onclick="document.getElementById('add-habit-btn').click()" 
                                style="background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            â• ç«‹å³æ·»åŠ ä¹ æƒ¯
                        </button>
                    </div>
                `;
                return;
            }
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const stats = calculateHabitStatistics(habits);
            
            // ç”Ÿæˆå¹¶æ˜¾ç¤ºæŠ¥å‘Š
            insights.innerHTML = generateReportHTML(stats);
            
            console.log('ä¹ æƒ¯åˆ†ææŠ¥å‘Šç”Ÿæˆå®Œæˆ');
        }
        
        // è®¡ç®—ä¹ æƒ¯ç»Ÿè®¡æ•°æ®
        function calculateHabitStatistics(habits) {
            let totalRecords = 0;
            let totalCompleted = 0;
            let bestHabit = null;
            let bestRate = 0;
            let activeStreaks = 0;
            let longestStreak = 0;
            
            habits.forEach(habit => {
                const records = habit.records || {};
                const recordDates = Object.keys(records);
                const completedRecords = Object.values(records).filter(r => r && r.completed);
                
                const recordCount = recordDates.length;
                const completedCount = completedRecords.length;
                const rate = recordCount > 0 ? Math.round((completedCount / recordCount) * 100) : 0;
                
                totalRecords += recordCount;
                totalCompleted += completedCount;
                
                if (rate > bestRate && recordCount > 0) {
                    bestRate = rate;
                    bestHabit = habit;
                }
                
                const streak = calculateStreakForHabit(habit);
                if (streak > 0) activeStreaks++;
                if (streak > longestStreak) longestStreak = streak;
            });
            
            const overallRate = totalRecords > 0 ? Math.round((totalCompleted / totalRecords) * 100) : 0;
            
            return {
                totalHabits: habits.length,
                totalRecords,
                totalCompleted,
                overallRate,
                bestHabit,
                bestRate,
                activeStreaks,
                longestStreak
            };
        }
        
        // è®¡ç®—å•ä¸ªä¹ æƒ¯çš„è¿ç»­å¤©æ•°
        function calculateStreakForHabit(habit) {
            const records = habit.records || {};
            const today = new Date();
            let streak = 0;
            
            for (let i = 0; i < 100; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateKey = DateUtils.formatDate(date);
                
                const record = records[dateKey];
                if (record && record.completed) {
                    streak++;
                } else if (i === 0) {
                    continue;
                } else {
                    break;
                }
            }
            
            return streak;
        }
        
        // ç”ŸæˆæŠ¥å‘ŠHTML
        function generateReportHTML(stats) {
            const currentDate = new Date().toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            
            return `
                <div style="background: linear-gradient(135deg, #f5f5f5, #fafafa); border-radius: 12px; padding: 18px; box-shadow: 0 2px 12px rgba(0,0,0,0.1);">
                    <div style="text-align: center; margin-bottom: 18px; padding-bottom: 16px; border-bottom: 1px solid #e0e0e0;">
                        <h2 style="margin: 0 0 6px 0; color: #1976d2; font-size: 1.3em;">ğŸ“Š ä¹ æƒ¯åˆ†ææŠ¥å‘Š</h2>
                        <p style="margin: 0; color: #666; font-size: 0.85em;">${currentDate}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(76,175,80,0.05)); padding: 14px; border-radius: 8px; border-left: 3px solid #4caf50; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #2e7d32; margin-bottom: 3px;">${stats.totalHabits}</div>
                            <div style="color: #666; font-size: 0.8em;">æ€»ä¹ æƒ¯æ•°</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(25,118,210,0.1), rgba(25,118,210,0.05)); padding: 14px; border-radius: 8px; border-left: 3px solid #1976d2; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #1976d2; margin-bottom: 3px;">${stats.overallRate}%</div>
                            <div style="color: #666; font-size: 0.8em;">æ€»å®Œæˆç‡</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(255,152,0,0.1), rgba(255,152,0,0.05)); padding: 14px; border-radius: 8px; border-left: 3px solid #ff9800; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #ef6c00; margin-bottom: 3px;">${stats.activeStreaks}</div>
                            <div style="color: #666; font-size: 0.8em;">æ´»è·ƒè¿ç»­</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(156,39,176,0.1), rgba(156,39,176,0.05)); padding: 14px; border-radius: 8px; border-left: 3px solid #9c27b0; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #7b1fa2; margin-bottom: 3px;">${stats.longestStreak}</div>
                            <div style="color: #666; font-size: 0.8em;">æœ€é•¿è¿ç»­</div>
                        </div>
                    </div>
                    
                    ${stats.bestHabit ? `
                    <div style="background: linear-gradient(135deg, rgba(76,175,80,0.08), rgba(139,195,74,0.08)); padding: 18px; border-radius: 10px; margin-bottom: 16px;">
                        <h3 style="margin: 0 0 12px 0; color: #2e7d32; font-size: 1.1em;">ğŸ† è¡¨ç°æœ€ä½³ä¹ æƒ¯</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 2em;">${stats.bestHabit.icon || 'ğŸ“‹'}</div>
                            <div>
                                <h4 style="margin: 0 0 4px 0; color: #1b5e20; font-size: 1.1em;">${stats.bestHabit.name}</h4>
                                <div style="background: #4caf50; color: white; display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">
                                    å®Œæˆç‡: ${stats.bestRate}%
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="background: linear-gradient(135deg, rgba(63,81,181,0.08), rgba(48,63,159,0.08)); padding: 18px; border-radius: 10px;">
                        <h3 style="margin: 0 0 12px 0; color: #3f51b5; font-size: 1.1em;">ğŸ’¡ ä¸ªæ€§åŒ–å»ºè®®</h3>
                        <p style="margin: 0; color: #444; line-height: 1.5; font-size: 0.95em;">${generatePersonalizedAdvice(stats)}</p>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 6px; text-align: center;">
                        <p style="margin: 0; font-size: 0.8em; color: #888;">
                            ğŸ“ˆ åŸºäº ${stats.totalHabits} ä¸ªä¹ æƒ¯çš„ ${stats.totalRecords} æ¡è®°å½• | â° ${new Date().toLocaleTimeString()}
                        </p>
                    </div>
                </div>
            `;
        }
        
        // ç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®
        function generatePersonalizedAdvice(stats) {
            const rate = stats.overallRate;
            if (rate >= 90) return `ğŸ‰ æ‚¨çš„ä¹ æƒ¯å…»æˆèƒ½åŠ›éå¸¸å‡ºè‰²ï¼å»ºè®®æŒ‘æˆ˜æ›´é«˜éš¾åº¦çš„ä¹ æƒ¯ã€‚`;
            if (rate >= 80) return `ğŸ‘ è¡¨ç°ä¼˜ç§€ï¼å»ºè®®ä¸“æ³¨äºä¿æŒç°æœ‰ä¹ æƒ¯çš„ç¨³å®šæ€§ã€‚`;
            if (rate >= 60) return `ğŸ‘ ä¸é”™çš„å¼€å§‹ï¼å»ºè®®ä¸“æ³¨äº2-3ä¸ªæœ€é‡è¦çš„ä¹ æƒ¯ã€‚`;
            if (rate >= 40) return `ğŸ’ª ç»§ç»­åŠªåŠ›ï¼å»ºè®®ä»æœ€å®¹æ˜“çš„1ä¸ªä¹ æƒ¯å¼€å§‹ã€‚`;
            return `ğŸŒ± ä¸‡äº‹å¼€å¤´éš¾ï¼å»ºè®®é€‰æ‹©ä¸€ä¸ªéå¸¸ç®€å•çš„ä¹ æƒ¯å¼€å§‹ã€‚`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM åŠ è½½å®Œæˆ ===');
            
            // åŸºç¡€DOMæ£€æŸ¥
            const calendarGrid = document.getElementById('calendar-grid');
            const tooltip = document.getElementById('calendar-tooltip');
            const tooltipContent = document.getElementById('tooltip-content');
            
            console.log('DOMå…ƒç´ æ£€æŸ¥:', {
                calendarGrid: !!calendarGrid,
                tooltip: !!tooltip,
                tooltipContent: !!tooltipContent
            });
            
            // æ£€æŸ¥common.js
            console.log('æ£€æŸ¥ DateUtils:', typeof DateUtils);
            console.log('æ£€æŸ¥ common.js æ¨¡å—:', {
                DateUtils: typeof DateUtils,
                MessageUtils: typeof MessageUtils,
                ModalUtils: typeof ModalUtils
            });
            
            if (typeof DateUtils === 'undefined') {
                console.error('DateUtils æœªå®šä¹‰ï¼common.js å¯èƒ½æ²¡æœ‰æ­£ç¡®åŠ è½½');
                alert('é”™è¯¯ï¼šcommon.js æ²¡æœ‰æ­£ç¡®åŠ è½½ï¼');
                return;
            }
            
            // æ‰§è¡Œæ•°æ®æ¸…ç†æ£€æŸ¥
            setTimeout(() => {
                try {
                    console.log('ğŸ§¹ æ‰§è¡Œå¯åŠ¨æ—¶æ•°æ®æ¸…ç†æ£€æŸ¥...');
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç¼–ç é—®é¢˜
                    let needsCleaning = false;
                    for (const [habitId, habit] of Object.entries(habitsData)) {
                        if (habit && habit.name && hasEncodingIssues(habit.name)) {
                            needsCleaning = true;
                            break;
                        }
                    }
                    
                    if (needsCleaning) {
                        console.log('âš ï¸ æ£€æµ‹åˆ°ä¹ æƒ¯æ•°æ®ç¼–ç é—®é¢˜ï¼Œè‡ªåŠ¨æ¸…ç†...');
                        cleanHabitData();
                    } else {
                        console.log('âœ… ä¹ æƒ¯æ•°æ®æ£€æŸ¥é€šè¿‡');
                    }
                } catch (error) {
                    console.warn('âš ï¸ å¯åŠ¨æ—¶æ•°æ®æ¸…ç†å¤±è´¥:', error);
                }
            }, 500);
            
            // åˆå§‹åŒ–
            try {
                initHabitTracker();
                
                // é¡µé¢åˆå§‹åŒ–å®Œæˆ
                console.log('âœ… ä¹ æƒ¯è¿½è¸ªå™¨åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
            
            // å…¨å±€ç‚¹å‡»æ£€æµ‹ - è°ƒè¯•ç”¨
            document.addEventListener('click', function(event) {
                console.log('å…¨å±€ç‚¹å‡»æ£€æµ‹:', {
                    target: event.target,
                    id: event.target.id,
                    className: event.target.className,
                    tagName: event.target.tagName
                });
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯ä¹ æƒ¯åˆ†ææŒ‰é’®
                if (event.target.id === 'habits-analytics-btn') {
                    console.log('æ£€æµ‹åˆ°ä¹ æƒ¯åˆ†ææŒ‰é’®è¢«ç‚¹å‡»ï¼');
                }
            });
        });

        // æµ‹è¯•åŸºç¡€äº¤äº’åŠŸèƒ½
        function testBasicInteraction() {
            console.log('=== æµ‹è¯•åŸºç¡€äº¤äº’åŠŸèƒ½ ===');
            
            const calendarGrid = document.getElementById('calendar-grid');
            if (!calendarGrid) {
                console.error('æ‰¾ä¸åˆ°æ—¥å†ç½‘æ ¼');
                return;
            }
            
            const dayElements = calendarGrid.children;
            console.log('æ—¥å†ä¸­çš„æ—¥æœŸå…ƒç´ æ•°é‡:', dayElements.length);
            
            if (dayElements.length === 0) {
                console.error('æ—¥å†ä¸­æ²¡æœ‰æ—¥æœŸå…ƒç´ ï¼');
                return;
            }
            
            // æµ‹è¯•ç¬¬ä¸€ä¸ªæ—¥æœŸå…ƒç´ 
            const firstDay = dayElements[0];
            console.log('ç¬¬ä¸€ä¸ªæ—¥æœŸå…ƒç´ :', firstDay);
            console.log('ç¬¬ä¸€ä¸ªæ—¥æœŸå…ƒç´ çš„äº‹ä»¶å¤„ç†å™¨:', {
                onmouseenter: typeof firstDay.onmouseenter,
                onmouseleave: typeof firstDay.onmouseleave,
                onclick: typeof firstDay.onclick
            });
            
            // æ‰‹åŠ¨æµ‹è¯•å·¥å…·æç¤º
            testTooltipManually();
        }

        // æ‰‹åŠ¨æµ‹è¯•å·¥å…·æç¤º
        function testTooltipManually() {
            console.log('=== æ‰‹åŠ¨æµ‹è¯•å·¥å…·æç¤º ===');
            const tooltip = document.getElementById('calendar-tooltip');
            const tooltipContent = document.getElementById('tooltip-content');
            
            if (!tooltip || !tooltipContent) {
                console.error('å·¥å…·æç¤ºå…ƒç´ ä¸å­˜åœ¨');
                return false;
            }
            
            tooltipContent.innerHTML = '<h4>æ‰‹åŠ¨æµ‹è¯•å·¥å…·æç¤º</h4><p>è¿™æ˜¯ä¸€ä¸ªæ‰‹åŠ¨æµ‹è¯•æ¶ˆæ¯</p>';
            tooltip.style.left = '200px';
            tooltip.style.top = '200px';
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
            tooltip.style.transform = 'none';
            tooltip.className = 'calendar-tooltip show';
            
            console.log('æ‰‹åŠ¨å·¥å…·æç¤ºåº”è¯¥æ˜¾ç¤ºäº†');
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
                console.log('æ‰‹åŠ¨å·¥å…·æç¤ºå·²éšè—');
            }, 3000);
            
            return true;
        }

        // å…¨å±€æµ‹è¯•å‡½æ•° - å¯ä»¥åœ¨æ§åˆ¶å°ç›´æ¥è°ƒç”¨
        window.testHoverTooltip = function() {
            console.log('=== ç”¨æˆ·æ‰‹åŠ¨æµ‹è¯•å·¥å…·æç¤º ===');
            const calendarGrid = document.getElementById('calendar-grid');
            const firstDay = calendarGrid.children[0];
            
            if (firstDay && firstDay.onmouseenter) {
                console.log('æ¨¡æ‹Ÿé¼ æ ‡è¿›å…¥ç¬¬ä¸€ä¸ªæ—¥æœŸ');
                const fakeEvent = { target: firstDay };
                firstDay.onmouseenter(fakeEvent);
            } else {
                console.error('ç¬¬ä¸€ä¸ªæ—¥æœŸå…ƒç´ æˆ–å…¶äº‹ä»¶å¤„ç†å™¨ä¸å­˜åœ¨');
            }
        };

        function initHabitTracker() {
            console.log('=== åˆå§‹åŒ–ä¹ æƒ¯è¿½è¸ªå™¨ ===');
            
            // å¦‚æœæ²¡æœ‰ä¹ æƒ¯æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤ä¹ æƒ¯
            if (Object.keys(habitsData).length === 0) {
                initDefaultHabits();
            }

            renderHabits();
            renderCalendar();
            updateStats();
            setupEventListeners();
            
            // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å·¥å…·æç¤º
            document.addEventListener('click', function(e) {
                const tooltip = document.getElementById('calendar-tooltip');
                const calendarGrid = document.getElementById('calendar-grid');
                
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æ—¥å†æ—¥æœŸï¼Œä¸”å·¥å…·æç¤ºæ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
                if (tooltip && tooltip.style.visibility === 'visible') {
                    const isClickOnCalendar = calendarGrid && calendarGrid.contains(e.target);
                    const isClickOnTooltip = tooltip.contains(e.target);
                    
                    if (!isClickOnCalendar && !isClickOnTooltip) {
                        hideDayTooltip();
                    }
                }
            });
        }

        function setupEventListeners() {
            document.getElementById('add-habit-btn').addEventListener('click', showAddHabitModal);
            document.getElementById('add-habit-btn-2').addEventListener('click', showAddHabitModal);
            document.getElementById('cal-prev').addEventListener('click', () => navigateCalendar(-1));
            document.getElementById('cal-next').addEventListener('click', () => navigateCalendar(1));
            document.getElementById('generate-insights-btn').addEventListener('click', generateHabitInsights);
            
            // æ–°å¢çš„åŠŸèƒ½æŒ‰é’®
            document.getElementById('clean-habit-data-btn')?.addEventListener('click', cleanHabitData);
            document.getElementById('force-save-habit-btn')?.addEventListener('click', forceSaveHabitData);
            
            // ä¹ æƒ¯åˆ†ææŒ‰é’®äº‹ä»¶ç»‘å®š - ä½¿ç”¨å¤šç§æ–¹å¼ç¡®ä¿ç»‘å®šæˆåŠŸ
            const analyticsBtn = document.getElementById('habits-analytics-btn');
            console.log('æŸ¥æ‰¾ä¹ æƒ¯åˆ†ææŒ‰é’®:', analyticsBtn);
            
            if (analyticsBtn) {
                // æ–¹æ³•1: addEventListener
                analyticsBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('ä¹ æƒ¯åˆ†ææŒ‰é’®è¢«ç‚¹å‡» - addEventListener');
                    
                    // ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    const insights = document.getElementById('habit-insights');
                    if (insights) {
                        insights.innerHTML = '<div style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #2196f3;"><h3 style="color: #1976d2;">ğŸ”„ æ­£åœ¨åˆ†æ...</h3><p style="color: #666;">è¯·ç¨å€™ï¼Œæ­£åœ¨ç”Ÿæˆæ‚¨çš„ä¹ æƒ¯åˆ†ææŠ¥å‘Š</p></div>';
                    }
                    
                    // å»¶è¿Ÿæ‰§è¡Œåˆ†æ
                    setTimeout(() => {
                        generateHabitInsights();
                    }, 100);
                });
                
                // æ–¹æ³•2: onclick ä½œä¸ºå¤‡ç”¨
                analyticsBtn.onclick = function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('ä¹ æƒ¯åˆ†ææŒ‰é’®è¢«ç‚¹å‡» - onclick');
                    
                    // ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    const insights = document.getElementById('habit-insights');
                    if (insights) {
                        insights.innerHTML = '<div style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #2196f3;"><h3 style="color: #1976d2;">ğŸ”„ æ­£åœ¨åˆ†æ...</h3><p style="color: #666;">è¯·ç¨å€™ï¼Œæ­£åœ¨ç”Ÿæˆæ‚¨çš„ä¹ æƒ¯åˆ†ææŠ¥å‘Š</p></div>';
                    }
                    
                    setTimeout(() => {
                        generateHabitInsights();
                    }, 100);
                };
                
                console.log('ä¹ æƒ¯åˆ†ææŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
                
                // æµ‹è¯•æŒ‰é’®æ˜¯å¦å¯è§å’Œå¯ç‚¹å‡»
                const style = window.getComputedStyle(analyticsBtn);
                console.log('æŒ‰é’®æ ·å¼æ£€æŸ¥:', {
                    display: style.display,
                    visibility: style.visibility,
                    pointerEvents: style.pointerEvents,
                    disabled: analyticsBtn.disabled
                });
            } else {
                console.error('æ‰¾ä¸åˆ°ä¹ æƒ¯åˆ†ææŒ‰é’®: habits-analytics-btn');
                
                // å°è¯•å»¶è¿ŸæŸ¥æ‰¾
                setTimeout(() => {
                    const delayedBtn = document.getElementById('habits-analytics-btn');
                    if (delayedBtn) {
                        console.log('å»¶è¿Ÿæ‰¾åˆ°æŒ‰é’®ï¼Œé‡æ–°ç»‘å®šäº‹ä»¶');
                        delayedBtn.addEventListener('click', function(event) {
                            event.preventDefault();
                            console.log('å»¶è¿Ÿç»‘å®šçš„æŒ‰é’®è¢«ç‚¹å‡»');
                            alert('æŒ‰é’®ç‚¹å‡»æˆåŠŸï¼æ­£åœ¨ç”Ÿæˆåˆ†æ...');
                            generateHabitInsights();
                        });
                    }
                }, 1000);
            }
        }

        function initDefaultHabits() {
            defaultHabits.forEach((habit, index) => {
                const habitId = `habit_${Date.now()}_${index}`;
                habitsData[habitId] = {
                    ...habit,
                    id: habitId,
                    createdAt: new Date().toISOString(),
                    records: {}
                };
            });
            saveHabitsData();
        }

        function renderHabits() {
            const grid = document.getElementById('habits-grid');
            grid.innerHTML = '';

            const today = DateUtils.getToday();
            let todayCompleted = 0;
            let todayTotal = 0;

            Object.values(habitsData).forEach(habit => {
                todayTotal++;
                const todayRecord = habit.records[today];
                if (todayRecord && todayRecord.completed) {
                    todayCompleted++;
                }

                const card = createHabitCard(habit, today);
                grid.appendChild(card);
            });

            // æ›´æ–°ä»Šæ—¥è¿›åº¦
            document.getElementById('today-progress').textContent = `${todayCompleted}/${todayTotal}`;
        }

        function createHabitCard(habit, today) {
            const card = document.createElement('div');
            card.className = 'habit-card';

            const todayRecord = habit.records[today];
            const isCompleted = todayRecord && todayRecord.completed;
            const streak = calculateStreak(habit);
            const completionRate = calculateCompletionRate(habit);

            // å®‰å…¨çš„æ–‡æœ¬å¤„ç†ï¼Œé˜²æ­¢ç¼–ç é—®é¢˜æ˜¾ç¤º
            const safeIcon = sanitizeHabitText(habit.icon || 'ğŸ“‹');
            const safeName = sanitizeHabitText(habit.name || '');
            const safeUnit = sanitizeHabitText(habit.unit || 'æ¬¡');
            
            card.innerHTML = `
                <div class="habit-header">
                    <div class="habit-name">${safeIcon} ${safeName}</div>
                    <div class="habit-streak">è¿ç»­ ${streak} å¤©</div>
                </div>
                
                <div class="habit-progress">
                    <div class="habit-progress-bar">
                        <div class="habit-progress-fill" style="width: ${completionRate}%"></div>
                    </div>
                    <div class="habit-stats">
                        <span>å®Œæˆç‡: ${completionRate}%</span>
                        <span>ç›®æ ‡: ${habit.target}${safeUnit}</span>
                    </div>
                </div>
                
                <div class="habit-actions">
                    <button class="habit-btn check ${isCompleted ? 'completed' : ''}" 
                            onclick="toggleHabit('${habit.id}', '${today}')" 
                            ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? 'âœ… å·²å®Œæˆ' : 'âœ“ å®Œæˆ'}
                    </button>
                    <button class="habit-btn skip" onclick="skipHabit('${habit.id}', '${today}')">è·³è¿‡</button>
                    <button class="habit-btn edit" onclick="editHabit('${habit.id}')">ç¼–è¾‘</button>
                </div>
            `;

            return card;
        }

        function toggleHabit(habitId, date) {
            if (!habitsData[habitId].records[date]) {
                habitsData[habitId].records[date] = {};
            }
            
            habitsData[habitId].records[date].completed = true;
            habitsData[habitId].records[date].timestamp = new Date().toISOString();
            
            saveHabitsData();
            renderHabits();
            renderCalendar();
            updateStats();
            
            MessageUtils.success('ä¹ æƒ¯å·²æ‰“å¡å®Œæˆï¼');
        }

        function skipHabit(habitId, date) {
            if (!habitsData[habitId].records[date]) {
                habitsData[habitId].records[date] = {};
            }
            
            habitsData[habitId].records[date].skipped = true;
            habitsData[habitId].records[date].timestamp = new Date().toISOString();
            
            saveHabitsData();
            renderHabits();
            renderCalendar();
            updateStats();
            
            MessageUtils.info('å·²è·³è¿‡ä»Šæ—¥ä¹ æƒ¯');
        }

        function calculateStreak(habit) {
            const today = new Date();
            let streak = 0;
            
            for (let i = 0; i < 100; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateKey = DateUtils.formatDate(date);
                
                const record = habit.records[dateKey];
                if (record && record.completed) {
                    streak++;
                } else if (i === 0) {
                    // å¦‚æœä»Šå¤©æ²¡å®Œæˆï¼Œä»æ˜¨å¤©å¼€å§‹ç®—
                    continue;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function calculateCompletionRate(habit) {
            const records = Object.values(habit.records);
            if (records.length === 0) return 0;
            
            const completed = records.filter(r => r.completed).length;
            return Math.round((completed / records.length) * 100);
        }

        function renderCalendar() {
            console.log('=== å¼€å§‹æ¸²æŸ“æ—¥å† ===');
            const grid = document.getElementById('calendar-grid');
            if (!grid) {
                console.error('æ‰¾ä¸åˆ°æ—¥å†ç½‘æ ¼å…ƒç´ !');
                return;
            }
            
            grid.innerHTML = '';
            
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            console.log('æ¸²æŸ“æœˆä»½:', year, month + 1);
            
            // æ›´æ–°æœˆä»½æ ‡é¢˜
            document.getElementById('calendar-month').textContent = 
                `${year}å¹´${month + 1}æœˆ`;
            
            // è·å–æœˆä»½ç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ç”Ÿæˆæ—¥å†æ ¼å­
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = date.getDate();
                
                const dateKey = DateUtils.formatDate(date);
                console.log('åˆ›å»ºæ—¥æœŸå…ƒç´ :', date.getDate(), dateKey);
                const isToday = dateKey === DateUtils.getToday();
                const isCurrentMonth = date.getMonth() === month;
                
                if (isToday) {
                    dayElement.classList.add('today');
                }
                
                if (!isCurrentMonth) {
                    dayElement.style.opacity = '0.3';
                }
                
                // è®¡ç®—å½“å¤©ä¹ æƒ¯å®Œæˆæƒ…å†µ
                const dayStats = calculateDayStats(dateKey);
                if (dayStats.total > 0) {
                    if (dayStats.completed === dayStats.total) {
                        dayElement.classList.add('completed');
                    } else if (dayStats.completed > 0) {
                        dayElement.style.background = `linear-gradient(135deg, #4caf50 ${(dayStats.completed/dayStats.total)*100}%, #e0e0e0 ${(dayStats.completed/dayStats.total)*100}%)`;
                    }
                }

                // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°é¿å…é—­åŒ…é—®é¢˜ - æ”¹ä¸ºç‚¹å‡»è§¦å‘
                (function(currentDateKey, currentDayStats) {
                    // ç§»é™¤é¼ æ ‡æ‚¬åœäº‹ä»¶ï¼Œæ”¹ä¸ºç‚¹å‡»äº‹ä»¶
                    dayElement.onclick = function(e) {
                        e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
                        console.log('=== æ—¥æœŸè¢«ç‚¹å‡» ===', currentDateKey, currentDayStats);
                        
                        // æ£€æŸ¥å·¥å…·æç¤ºæ˜¯å¦å·²ç»æ˜¾ç¤º
                        const tooltip = document.getElementById('calendar-tooltip');
                        const isVisible = tooltip && tooltip.style.visibility === 'visible';
                        
                        if (isVisible) {
                            // å¦‚æœå·²ç»æ˜¾ç¤ºï¼Œåˆ™éšè—
                            hideDayTooltip();
                        } else {
                            // å¦‚æœæœªæ˜¾ç¤ºï¼Œåˆ™æ˜¾ç¤º
                            showDayTooltip(e, currentDateKey, currentDayStats);
                        }
                    };
                })(dateKey, dayStats);
                
                // ç¡®ä¿å…ƒç´ å¯ä»¥æ¥æ”¶é¼ æ ‡äº‹ä»¶
                dayElement.style.pointerEvents = 'auto';
                dayElement.style.cursor = 'pointer';
                
                grid.appendChild(dayElement);
            }
        }

        function calculateDayStats(date) {
            let total = 0;
            let completed = 0;
            
            Object.values(habitsData).forEach(habit => {
                total++;
                const record = habit.records[date];
                if (record && record.completed) {
                    completed++;
                }
            });
            
            return { total, completed };
        }

        function navigateCalendar(months) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + months);
            renderCalendar();
        }

        function updateStats() {
            const habits = Object.values(habitsData);
            
            // æ€»ä¹ æƒ¯æ•°
            document.getElementById('total-habits').textContent = habits.length;
            
            // æ´»è·ƒè¿ç»­
            const activeStreaks = habits.filter(h => calculateStreak(h) > 0).length;
            document.getElementById('active-streaks').textContent = activeStreaks;
            
            // æ€»å®Œæˆç‡
            const totalRecords = habits.reduce((sum, h) => sum + Object.keys(h.records).length, 0);
            const totalCompleted = habits.reduce((sum, h) => 
                sum + Object.values(h.records).filter(r => r.completed).length, 0);
            const overallRate = totalRecords > 0 ? Math.round((totalCompleted / totalRecords) * 100) : 0;
            document.getElementById('completion-rate').textContent = `${overallRate}%`;
            
            // æœ€é•¿è¿ç»­
            const longestStreak = Math.max(...habits.map(h => calculateStreak(h)), 0);
            document.getElementById('longest-streak').textContent = longestStreak;
        }

        function showAddHabitModal() {
            const content = `
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px;">ä¹ æƒ¯åç§°</label>
                    <input type="text" id="habit-name" placeholder="ä¾‹å¦‚ï¼šæ™¨é—´é”»ç‚¼" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px;">å›¾æ ‡</label>
                    <input type="text" id="habit-icon" placeholder="ä¾‹å¦‚ï¼šğŸ’ª" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px;">ç›®æ ‡æ•°é‡</label>
                        <input type="number" id="habit-target" placeholder="30" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px;">å•ä½</label>
                        <input type="text" id="habit-unit" placeholder="åˆ†é’Ÿ" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
            `;

            ModalUtils.show('æ–°å¢ä¹ æƒ¯', content, {
                buttons: [
                    { text: 'å–æ¶ˆ', class: 'btn-main' },
                    { text: 'æ·»åŠ ', class: 'btn-main', handler: addNewHabit }
                ]
            });
        }

        function addNewHabit() {
            const name = document.getElementById('habit-name').value.trim();
            const icon = document.getElementById('habit-icon').value.trim();
            const target = parseInt(document.getElementById('habit-target').value) || 1;
            const unit = document.getElementById('habit-unit').value.trim() || 'æ¬¡';

            if (!name) {
                MessageUtils.error('è¯·è¾“å…¥ä¹ æƒ¯åç§°');
                return;
            }

            const habitId = `habit_${Date.now()}`;
            habitsData[habitId] = {
                id: habitId,
                name: name,
                icon: icon || 'ğŸ“‹',
                target: target,
                unit: unit,
                createdAt: new Date().toISOString(),
                records: {}
            };

            saveHabitsData();
            renderHabits();
            updateStats();
            MessageUtils.success('ä¹ æƒ¯æ·»åŠ æˆåŠŸï¼');
        }

        function editHabit(habitId) {
            const habit = habitsData[habitId];
            if (!habit) {
                MessageUtils.error('ä¹ æƒ¯ä¸å­˜åœ¨');
                return;
            }

            const content = `
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px;">ä¹ æƒ¯åç§°</label>
                    <input type="text" id="edit-habit-name" value="${habit.name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px;">å›¾æ ‡</label>
                    <input type="text" id="edit-habit-icon" value="${habit.icon}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px;">ç›®æ ‡æ•°é‡</label>
                        <input type="number" id="edit-habit-target" value="${habit.target}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 8px;">å•ä½</label>
                        <input type="text" id="edit-habit-unit" value="${habit.unit}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>

                <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; color: #666; font-size: 0.9em;">ä¹ æƒ¯ç»Ÿè®¡</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 0.85em;">
                        <div>è¿ç»­å¤©æ•°: <strong>${calculateStreak(habit)}</strong></div>
                        <div>å®Œæˆç‡: <strong>${calculateCompletionRate(habit)}%</strong></div>
                        <div>è®°å½•å¤©æ•°: <strong>${Object.keys(habit.records).length}</strong></div>
                        <div>åˆ›å»ºæ—¶é—´: <strong>${new Date(habit.createdAt).toLocaleDateString()}</strong></div>
                    </div>
                </div>

                <div style="background: #fff3e0; border: 1px solid #ffcc02; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; color: #ef6c00; font-size: 0.9em;">âš ï¸ å±é™©æ“ä½œ</h4>
                    <button type="button" id="delete-habit-btn" style="background: #f44336; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 0.9em;">
                        ğŸ—‘ï¸ åˆ é™¤æ­¤ä¹ æƒ¯
                    </button>
                    <p style="margin: 8px 0 0 0; font-size: 0.8em; color: #666;">åˆ é™¤åå°†æ— æ³•æ¢å¤æ‰€æœ‰è®°å½•æ•°æ®</p>
                </div>
            `;

            ModalUtils.show(`ç¼–è¾‘ä¹ æƒ¯: ${habit.icon} ${habit.name}`, content, {
                buttons: [
                    { text: 'å–æ¶ˆ', class: 'btn-main' },
                    { text: 'ä¿å­˜ä¿®æ”¹', class: 'btn-main', handler: () => saveHabitEdit(habitId) }
                ]
            });

            // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            setTimeout(() => {
                const deleteBtn = document.getElementById('delete-habit-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => deleteHabit(habitId));
                }
            }, 100);
        }

        function saveHabitEdit(habitId) {
            const name = document.getElementById('edit-habit-name').value.trim();
            const icon = document.getElementById('edit-habit-icon').value.trim();
            const target = parseInt(document.getElementById('edit-habit-target').value) || 1;
            const unit = document.getElementById('edit-habit-unit').value.trim() || 'æ¬¡';

            if (!name) {
                MessageUtils.error('è¯·è¾“å…¥ä¹ æƒ¯åç§°');
                return;
            }

            // æ›´æ–°ä¹ æƒ¯æ•°æ®
            habitsData[habitId].name = name;
            habitsData[habitId].icon = icon || 'ğŸ“‹';
            habitsData[habitId].target = target;
            habitsData[habitId].unit = unit;
            habitsData[habitId].updatedAt = new Date().toISOString();

            saveHabitsData();
            renderHabits();
            updateStats();
            MessageUtils.success('ä¹ æƒ¯ä¿®æ”¹æˆåŠŸï¼');
        }

        function deleteHabit(habitId) {
            const habit = habitsData[habitId];
            if (!habit) return;

            const confirmMessage = `ç¡®å®šè¦åˆ é™¤ä¹ æƒ¯"${habit.icon} ${habit.name}"å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤æ‰€æœ‰ç›¸å…³çš„è®°å½•æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼`;
            
            if (confirm(confirmMessage)) {
                delete habitsData[habitId];
                saveHabitsData();
                renderHabits();
                renderCalendar();
                updateStats();
                MessageUtils.success(`å·²åˆ é™¤ä¹ æƒ¯: ${habit.name}`);
                
                // å…³é—­æ¨¡æ€æ¡†
                if (typeof ModalUtils !== 'undefined' && ModalUtils.hide) {
                    ModalUtils.hide();
                }
            }
        }

        function generateHabitInsights() {
            console.log('=== generateHabitInsights å‡½æ•°å¼€å§‹æ‰§è¡Œ ===');
            
            try {
                // æ£€æŸ¥å®¹å™¨å…ƒç´ 
                const insights = document.getElementById('habit-insights');
                console.log('æŸ¥æ‰¾ habit-insights å…ƒç´ :', insights);
                if (!insights) {
                    console.error('æ‰¾ä¸åˆ° habit-insights å…ƒç´ ');
                    return;
                }
                
                // è·å–ä¹ æƒ¯æ•°æ®
                const habits = Object.values(habitsData);
                console.log('ä¹ æƒ¯æ•°æ®:', habits);
                console.log('ä¹ æƒ¯æ•°é‡:', habits.length);
                
                if (habits.length === 0) {
                    console.log('æ²¡æœ‰ä¹ æƒ¯æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                    insights.innerHTML = `
                        <div style="background: #fff3e0; padding: 30px; border-radius: 12px; text-align: center; border-left: 4px solid #ff9800;">
                            <h3 style="color: #ef6c00; margin: 0 0 16px 0;">ğŸ“‹ æš‚æ— ä¹ æƒ¯æ•°æ®</h3>
                            <p style="color: #666; margin: 0 0 20px 0;">è¯·å…ˆæ·»åŠ ä¸€äº›ä¹ æƒ¯ï¼Œç„¶åè¿›è¡Œæ‰“å¡è®°å½•ï¼Œæ‰èƒ½ç”Ÿæˆåˆ†ææŠ¥å‘Šã€‚</p>
                            <button onclick="document.getElementById('add-habit-btn').click()" 
                                    style="background: #2196f3; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                                â• ç«‹å³æ·»åŠ ä¹ æƒ¯
                            </button>
                        </div>
                    `;
                    return;
                }
                
                console.log('å¼€å§‹åˆ†æä¹ æƒ¯æ•°æ®...');
                
                // è®¡ç®—ç»Ÿè®¡æ•°æ®
                let bestHabit = habits[0];
                let maxRate = 0;
                let totalRecords = 0;
                let totalCompleted = 0;
                
                habits.forEach(habit => {
                    const records = habit.records || {};
                    const recordCount = Object.keys(records).length;
                    const completedCount = Object.values(records).filter(r => r && r.completed).length;
                    const rate = recordCount > 0 ? Math.round((completedCount / recordCount) * 100) : 0;
                    
                    console.log(`ä¹ æƒ¯ ${habit.name}: ${completedCount}/${recordCount} = ${rate}%`);
                    
                    if (rate > maxRate) {
                        maxRate = rate;
                        bestHabit = habit;
                    }
                    
                    totalRecords += recordCount;
                    totalCompleted += completedCount;
                });
                
                const overallRate = totalRecords > 0 ? Math.round((totalCompleted / totalRecords) * 100) : 0;
                console.log('ç»Ÿè®¡ç»“æœ:', { totalRecords, totalCompleted, overallRate, maxRate });
                
                // ç”Ÿæˆåˆ†æç»“æœHTML
                const resultHtml = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div style="background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(76,175,80,0.05)); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 12px 0; color: #2e7d32; font-size: 1.1em;">ğŸ† è¡¨ç°æœ€ä½³ä¹ æƒ¯</h4>
                            <p style="margin: 0; font-size: 1.2em; font-weight: 600;"><strong>${sanitizeHabitText(bestHabit.icon || 'ğŸ“‹')} ${sanitizeHabitText(bestHabit.name || '')}</strong></p>
                            <p style="margin: 8px 0 0 0; color: #666; font-size: 1em;">å®Œæˆç‡: <strong style="color: #2e7d32;">${maxRate}%</strong></p>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(25,118,210,0.1), rgba(25,118,210,0.05)); padding: 20px; border-radius: 12px; border-left: 4px solid #1976d2; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 12px 0; color: #1976d2; font-size: 1.1em;">ğŸ“Š æ•´ä½“æ•°æ®</h4>
                            <p style="margin: 0; font-size: 1.1em;">æ€»è®°å½•æ•°: <strong>${totalRecords}</strong> æ¬¡</p>
                            <p style="margin: 8px 0 0 0; color: #666; font-size: 1em;">æ€»å®Œæˆç‡: <strong style="color: #1976d2;">${overallRate}%</strong></p>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(255,152,0,0.1), rgba(255,152,0,0.05)); padding: 20px; border-radius: 12px; border-left: 4px solid #ff9800; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 12px 0; color: #ef6c00; font-size: 1.1em;">ğŸ’¡ æ”¹è¿›å»ºè®®</h4>
                            <p style="margin: 0; font-size: 1em; line-height: 1.4;">
                                ${overallRate >= 80 ? 'ğŸ‰ è¡¨ç°ä¼˜ç§€ï¼ç»§ç»­ä¿æŒè¿™ç§è‰¯å¥½çš„ä¹ æƒ¯ï¼' : 
                                  overallRate >= 60 ? 'ğŸ‘ ä¸é”™çš„å¼€å§‹ï¼å¯ä»¥å°è¯•æé«˜ä¸€è‡´æ€§ã€‚' :
                                  overallRate >= 30 ? 'ğŸ’ª ç»§ç»­åŠªåŠ›ï¼å»ºè®®ä¸“æ³¨äº1-2ä¸ªæ ¸å¿ƒä¹ æƒ¯ã€‚' :
                                  'ğŸŒ± åˆšåˆšå¼€å§‹ï¼å»ºè®®å…ˆä»æœ€å®¹æ˜“çš„ä¹ æƒ¯å¼€å§‹åŸ¹å…»ã€‚'}
                            </p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 16px; background: rgba(0,0,0,0.03); border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 0.9em; color: #666;">
                            ğŸ“… åˆ†æå®Œæˆæ—¶é—´: ${new Date().toLocaleString()} | 
                            ğŸ“ˆ åŸºäº ${habits.length} ä¸ªä¹ æƒ¯çš„ ${totalRecords} æ¡è®°å½•
                        </p>
                    </div>
                `;
                
                console.log('æ›´æ–°æ˜¾ç¤ºå†…å®¹...');
                insights.innerHTML = resultHtml;
                console.log('=== ä¹ æƒ¯åˆ†æå®Œæˆ ===');
                
            } catch (error) {
                console.error('ç”Ÿæˆä¹ æƒ¯åˆ†ææ—¶å‡ºé”™:', error);
                const insights = document.getElementById('habit-insights');
                if (insights) {
                    insights.innerHTML = `
                        <div style="background: rgba(244,67,54,0.1); padding: 25px; border-radius: 12px; border-left: 4px solid #f44336; text-align: center;">
                            <h3 style="margin: 0 0 16px 0; color: #d32f2f;">âš ï¸ åˆ†æå¤±è´¥</h3>
                            <p style="margin: 0 0 12px 0; color: #666;">ç”Ÿæˆä¹ æƒ¯åˆ†ææ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•æˆ–åˆ·æ–°é¡µé¢ã€‚</p>
                            <p style="margin: 0 0 20px 0; font-size: 0.85em; color: #999; font-family: monospace;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                            <button onclick="generateHabitInsights()" 
                                    style="background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                                ğŸ”„ é‡æ–°åˆ†æ
                            </button>
                        </div>
                    `;
                }
            }
        }

        // æ˜¾ç¤ºæ—¥æœŸå·¥å…·æç¤º - ç®€åŒ–ç‰ˆæœ¬
        function showDayTooltip(event, dateKey, dayStats) {
            console.log('=== showDayTooltip è¢«è°ƒç”¨ ===', { dateKey, dayStats });
            
            const tooltip = document.getElementById('calendar-tooltip');
            const tooltipContent = document.getElementById('tooltip-content');
            
            if (!tooltip || !tooltipContent) {
                console.error('æ‰¾ä¸åˆ°å·¥å…·æç¤ºå…ƒç´ ');
                return;
            }
            
            console.log('å·¥å…·æç¤ºå…ƒç´ æ‰¾åˆ°ï¼Œå¼€å§‹æ˜¾ç¤º...');

            // ç®€åŒ–çš„å·¥å…·æç¤ºå†…å®¹
            const date = new Date(dateKey);
            const formattedDate = date.toLocaleDateString('zh-CN', {
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });

            // è·å–å½“å¤©çš„è¯¦ç»†ä¹ æƒ¯æ•°æ®
            const dayDetails = getDayHabitDetails(dateKey);
            
            let tooltipHtml = `
                <h4 style="margin: 0 0 12px 0; color: #1976d2; font-size: 1.1em;">ğŸ“… ${formattedDate}</h4>
                <div style="margin-bottom: 12px; padding: 8px; background: rgba(33,150,243,0.1); border-radius: 8px; text-align: center;">
                    <span style="font-weight: 600; color: #1976d2; font-size: 1em;">å®Œæˆè¿›åº¦: ${dayStats.completed}/${dayStats.total}</span>
                </div>
            `;

            if (dayDetails.habits.length === 0) {
                tooltipHtml += `
                    <div style="text-align: center; color: #666; padding: 16px;">
                        <div style="font-size: 2em; margin-bottom: 8px;">ğŸ“</div>
                        <p style="margin: 0; font-size: 0.9em;">è¿™ä¸€å¤©è¿˜æ²¡æœ‰ä¹ æƒ¯è®°å½•</p>
                    </div>
                `;
            } else {
                // åˆ†ç±»æ˜¾ç¤ºä¹ æƒ¯
                const completedHabits = dayDetails.habits.filter(h => h.record && h.record.completed);
                const skippedHabits = dayDetails.habits.filter(h => h.record && h.record.skipped);
                const missedHabits = dayDetails.habits.filter(h => !h.record || (!h.record.completed && !h.record.skipped));

                // æ˜¾ç¤ºå·²å®Œæˆçš„ä¹ æƒ¯
                if (completedHabits.length > 0) {
                    tooltipHtml += `
                        <div style="margin-bottom: 12px;">
                            <h5 style="margin: 0 0 6px 0; color: #2e7d32; font-size: 1em; display: flex; align-items: center;">
                                âœ… å·²å®Œæˆ (${completedHabits.length})
                            </h5>
                            <div style="max-height: 80px; overflow-y: auto;">
                    `;
                    completedHabits.forEach(habit => {
                        const safeIcon = sanitizeHabitText(habit.icon || 'ğŸ“‹');
                        const safeName = sanitizeHabitText(habit.name || '');
                        tooltipHtml += `
                            <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 0.9em;">
                                <span style="font-size: 1.1em;">${safeIcon}</span>
                                <span style="color: #333; flex: 1;">${safeName}</span>
                                <span style="background: #4caf50; color: white; font-size: 0.8em; padding: 2px 8px; border-radius: 8px;">å®Œæˆ</span>
                            </div>
                        `;
                    });
                    tooltipHtml += `</div></div>`;
                }

                // æ˜¾ç¤ºå·²è·³è¿‡çš„ä¹ æƒ¯
                if (skippedHabits.length > 0) {
                    tooltipHtml += `
                        <div style="margin-bottom: 12px;">
                            <h5 style="margin: 0 0 6px 0; color: #ef6c00; font-size: 1em; display: flex; align-items: center;">
                                â­ï¸ å·²è·³è¿‡ (${skippedHabits.length})
                            </h5>
                            <div style="max-height: 70px; overflow-y: auto;">
                    `;
                    skippedHabits.forEach(habit => {
                        const safeIcon = sanitizeHabitText(habit.icon || 'ğŸ“‹');
                        const safeName = sanitizeHabitText(habit.name || '');
                        tooltipHtml += `
                            <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 0.9em;">
                                <span style="font-size: 1.1em;">${safeIcon}</span>
                                <span style="color: #333; flex: 1;">${safeName}</span>
                                <span style="background: #ff9800; color: white; font-size: 0.8em; padding: 2px 8px; border-radius: 8px;">è·³è¿‡</span>
                            </div>
                        `;
                    });
                    tooltipHtml += `</div></div>`;
                }

                // æ˜¾ç¤ºæœªå®Œæˆçš„ä¹ æƒ¯
                if (missedHabits.length > 0) {
                    tooltipHtml += `
                        <div style="margin-bottom: 8px;">
                            <h5 style="margin: 0 0 6px 0; color: #d32f2f; font-size: 1em; display: flex; align-items: center;">
                                âŒ æœªå®Œæˆ (${missedHabits.length})
                            </h5>
                            <div style="max-height: 70px; overflow-y: auto;">
                    `;
                    missedHabits.forEach(habit => {
                        const safeIcon = sanitizeHabitText(habit.icon || 'ğŸ“‹');
                        const safeName = sanitizeHabitText(habit.name || '');
                        tooltipHtml += `
                            <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 0.9em;">
                                <span style="font-size: 1.1em;">${safeIcon}</span>
                                <span style="color: #333; flex: 1;">${safeName}</span>
                                <span style="background: #f44336; color: white; font-size: 0.8em; padding: 2px 8px; border-radius: 8px;">æœªåš</span>
                            </div>
                        `;
                    });
                    tooltipHtml += `</div></div>`;
                }
            }

            // è®¾ç½®å†…å®¹
            tooltipContent.innerHTML = tooltipHtml;
            console.log('å·¥å…·æç¤ºå†…å®¹å·²è®¾ç½®');

            // ç²¾ç¡®å®šä½åˆ°æ—¥æœŸæ•°å­—æ—è¾¹ - ä½¿ç”¨fixedå®šä½
            const rect = event.target.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // è®¾ç½®å›ºå®šå®šä½å¹¶è·å–å°ºå¯¸
            tooltip.style.position = 'fixed';
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '1';
            tooltip.style.display = 'block';
            
            // ç­‰å¾…ä¸€å¸§ç¡®ä¿å°ºå¯¸è®¡ç®—æ­£ç¡®
            setTimeout(() => {
                const tooltipRect = tooltip.getBoundingClientRect();
                
                let left, top;
                const gap = 8; // ä¸æ—¥æœŸçš„é—´è·
                
                // é»˜è®¤æ˜¾ç¤ºåœ¨å³ä¾§
                left = rect.right + gap;
                top = rect.top;
                
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå³è¾¹ç•Œ
                if (left + tooltipRect.width > viewportWidth - 20) {
                    // æ”¹ä¸ºå·¦ä¾§æ˜¾ç¤º
                    left = rect.left - tooltipRect.width - gap;
                }
                
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå·¦è¾¹ç•Œ
                if (left < 20) {
                    // å¼ºåˆ¶æ˜¾ç¤ºåœ¨å³ä¾§ï¼Œä½†é™åˆ¶åœ¨å±å¹•å†…
                    left = Math.min(rect.right + gap, viewportWidth - tooltipRect.width - 20);
                }
                
                // å‚ç›´ä½ç½®è°ƒæ•´
                if (top + tooltipRect.height > viewportHeight - 20) {
                    top = viewportHeight - tooltipRect.height - 20;
                }
                if (top < 20) {
                    top = 20;
                }
                
                // åº”ç”¨æœ€ç»ˆä½ç½®
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
                tooltip.style.transform = 'scale(1)';
                tooltip.className = `calendar-tooltip show`;
                
                console.log('=== Fixedå®šä½è°ƒè¯• ===');
                console.log('æ—¥æœŸä½ç½®:', { left: rect.left, top: rect.top, right: rect.right, bottom: rect.bottom });
                console.log('å·¥å…·æç¤ºä½ç½®:', { left, top, width: tooltipRect.width, height: tooltipRect.height });
                
            }, 10);
        }

        // éšè—æ—¥æœŸå·¥å…·æç¤º
        function hideDayTooltip() {
            console.log('=== hideDayTooltip è¢«è°ƒç”¨ ===');
            const tooltip = document.getElementById('calendar-tooltip');
            if (tooltip) {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
                tooltip.classList.remove('show');
                console.log('å·¥å…·æç¤ºå·²éšè—');
            }
        }

        // è·å–æŒ‡å®šæ—¥æœŸçš„ä¹ æƒ¯è¯¦æƒ…
        function getDayHabitDetails(dateKey) {
            const habits = Object.values(habitsData);
            const dayHabits = habits.map(habit => ({
                ...habit,
                record: habit.records[dateKey] || null
            }));

            return {
                habits: dayHabits,
                total: habits.length,
                completed: dayHabits.filter(h => h.record && h.record.completed).length,
                skipped: dayHabits.filter(h => h.record && h.record.skipped).length
            };
        }

        // æ¸…ç†ä¹ æƒ¯æ•°æ®ä¸­çš„ç¼–ç é—®é¢˜
        function cleanHabitData() {
            try {
                console.log('ğŸ§¹ å¼€å§‹æ¸…ç†ä¹ æƒ¯æ•°æ®...');
                
                let foundCorruption = false;
                const cleanedData = {};
                
                // éå†æ‰€æœ‰ä¹ æƒ¯
                for (const [habitId, habit] of Object.entries(habitsData)) {
                    if (!habit || typeof habit !== 'object') {
                        console.warn('âš ï¸ è·³è¿‡æ— æ•ˆä¹ æƒ¯:', habitId);
                        continue;
                    }
                    
                    const cleanedHabit = {
                        id: habitId,
                        name: sanitizeHabitText(habit.name || ''),
                        icon: sanitizeHabitText(habit.icon || 'ğŸ“‹'),
                        target: parseInt(habit.target) || 1,
                        unit: sanitizeHabitText(habit.unit || 'æ¬¡'),
                        createdAt: habit.createdAt || new Date().toISOString(),
                        updatedAt: habit.updatedAt,
                        records: {}
                    };
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç¼–ç é—®é¢˜
                    if (habit.name && hasEncodingIssues(habit.name)) {
                        console.log(`ğŸ—‘ï¸ å‘ç°æŸåä¹ æƒ¯åç§°: ${habit.name}`);
                        foundCorruption = true;
                        continue; // è·³è¿‡æŸåçš„ä¹ æƒ¯
                    }
                    
                    // æ¸…ç†è®°å½•æ•°æ®
                    if (habit.records && typeof habit.records === 'object') {
                        for (const [date, record] of Object.entries(habit.records)) {
                            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                                console.warn('âš ï¸ è·³è¿‡æ— æ•ˆæ—¥æœŸ:', date);
                                continue;
                            }
                            
                            if (record && typeof record === 'object') {
                                cleanedHabit.records[date] = {
                                    completed: Boolean(record.completed),
                                    skipped: Boolean(record.skipped),
                                    timestamp: record.timestamp || new Date().toISOString()
                                };
                            }
                        }
                    }
                    
                    cleanedData[habitId] = cleanedHabit;
                }
                
                if (foundCorruption) {
                    console.log('âœ… å‘ç°å¹¶æ¸…ç†äº†æŸåçš„ä¹ æƒ¯æ•°æ®');
                    habitsData = cleanedData;
                    saveHabitsData();
                    
                    // é‡æ–°æ¸²æŸ“ç•Œé¢
                    renderHabits();
                    renderCalendar();
                    updateStats();
                    
                    MessageUtils.success('å·²æ¸…ç†æŸåçš„ä¹ æƒ¯æ•°æ®ï¼');
                    return true;
                } else {
                    console.log('âœ… ä¹ æƒ¯æ•°æ®å®Œæ•´ï¼Œæ— éœ€æ¸…ç†');
                    MessageUtils.info('æ•°æ®æ£€æŸ¥å®Œæˆï¼Œæœªå‘ç°é—®é¢˜');
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ æ¸…ç†ä¹ æƒ¯æ•°æ®å¤±è´¥:', error);
                MessageUtils.error('æ•°æ®æ¸…ç†å¤±è´¥: ' + error.message);
                return false;
            }
        }
        
        // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦æœ‰ç¼–ç é—®é¢˜
        function hasEncodingIssues(text) {
            if (typeof text !== 'string') return false;
            
            // æ£€æŸ¥å¸¸è§çš„ç¼–ç é”™è¯¯å­—ç¬¦
            const encodingIssuePatterns = [
                /Ã‚+/g,
                /\u00C2/g,
                /ÃƒÂ¢Ã¢â€šÂ¬/g,
                /Ã¢â‚¬/g,
                /Â¥â‚¬/g,
                /Â®Â®/g,
                /[^\x20-\x7E\u4e00-\u9fff]/g // éæ­£å¸¸æ˜¾ç¤ºå­—ç¬¦
            ];
            
            return encodingIssuePatterns.some(pattern => pattern.test(text));
        }
        
        // æ¸…ç†æ–‡æœ¬ä¸­çš„ç¼–ç é—®é¢˜
        function sanitizeHabitText(text) {
            if (typeof text !== 'string') {
                return String(text || '');
            }
            
            let cleaned = text;
            
            // ç§»é™¤æˆ–æ›¿æ¢ç¼–ç é”™è¯¯å­—ç¬¦
            cleaned = cleaned
                .replace(/Ã‚+/g, '') // ç§»é™¤Ã‚å­—ç¬¦
                .replace(/\u00C2/g, '') // ç§»é™¤C2å­—ç¬¦
                .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€Â¢/g, "'") // ä¿®å¤æ™ºèƒ½å¼•å·
                .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã‚/g, 'â€“') // ä¿®å¤ç ´æŠ˜å·
                .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã…"/g, '"') // ä¿®å¤å·¦åŒå¼•å·
                .replace(/ÃƒÂ¢Ã¢â€šÂ¬/g, '')
                .replace(/Ã¢â‚¬â„¢/g, "'")
                .replace(/Ã¢â‚¬Å“/g, '"')
                .replace(/Ã¢â‚¬/g, '"')
                .replace(/Ã¢â€Â¢/g, '')
                .replace(/Â¥â‚¬/g, '')
                .replace(/Â®Â®/g, '')
                .replace(/[\x00-\x1F\x7F-\x9F]/g, '') // ç§»é™¤æ§åˆ¶å­—ç¬¦
                .replace(/\uFEFF/g, '') // ç§»é™¤BOM
                .replace(/\u200B/g, '') // ç§»é™¤é›¶å®½ç©ºæ ¼
                .replace(/\u00A0/g, ' ') // æ›¿æ¢ä¸é—´æ–­ç©ºæ ¼
                .replace(/\s+/g, ' ') // åˆå¹¶å¤šä¸ªç©ºæ ¼
                .trim();
            
            // å¦‚æœæ¸…ç†åä¸ºç©ºï¼Œè¿”å›é»˜è®¤å€¼
            if (!cleaned) {
                return '';
            }
            
            return cleaned;
        }
        
        // å¼ºåˆ¶ä¿å­˜ä¹ æƒ¯æ•°æ®
        async function forceSaveHabitData() {
            try {
                console.log('ğŸ’¾ å¼€å§‹å¼ºåˆ¶ä¿å­˜ä¹ æƒ¯æ•°æ®...');
                
                const confirmed = confirm(
                    'å°†å¼ºåˆ¶ä¿å­˜å½“å‰ä¹ æƒ¯æ•°æ®ï¼Œå¹¶æ¸…ç†ä»»ä½•æŸåçš„æ•°æ®ã€‚\n\n' +
                    'è¿™å°†ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ã€‚\n\n' +
                    'æ˜¯å¦ç»§ç»­ï¼Ÿ'
                );
                
                if (!confirmed) {
                    return;
                }
                
                // 1. å…ˆæ¸…ç†æ•°æ®
                console.log('ğŸ§¹ æ­¥éª¤1ï¼šæ¸…ç†æŸåæ•°æ®');
                cleanHabitData();
                
                // 2. éªŒè¯æ•°æ®æ ¼å¼
                console.log('âœ… æ­¥éª¤2ï¼šéªŒè¯æ•°æ®æ ¼å¼');
                const validatedData = validateHabitData(habitsData);
                habitsData = validatedData;
                
                // 3. å¼ºåˆ¶ä¿å­˜åˆ°localStorage
                console.log('ğŸ’¾ æ­¥éª¤3ï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                const jsonString = JSON.stringify(habitsData, null, 0);
                localStorage.setItem('habitTrackerData', jsonString);
                
                // 4. å¦‚æœæœ‰åŒæ­¥æœåŠ¡ï¼Œæ¨é€åˆ°äº‘ç«¯
                if (window.syncService) {
                    const status = window.syncService.getSyncStatus();
                    
                    if (status.enabled) {
                        try {
                            console.log('â˜ï¸ æ­¥éª¤4ï¼šåŒæ­¥åˆ°äº‘ç«¯');
                            MessageUtils.info('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...');
                            await window.syncService.manualSync();
                            MessageUtils.success('âœ… ä¹ æƒ¯æ•°æ®å·²ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯ï¼');
                        } catch (syncError) {
                            console.error('âŒ äº‘ç«¯åŒæ­¥å¤±è´¥:', syncError);
                            MessageUtils.warning('æœ¬åœ°ä¿å­˜æˆåŠŸï¼Œä½†äº‘ç«¯åŒæ­¥å¤±è´¥: ' + syncError.message);
                        }
                    } else {
                        MessageUtils.success('âœ… ä¹ æƒ¯æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼');
                    }
                } else {
                    MessageUtils.success('âœ… ä¹ æƒ¯æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼');
                }
                
                // 5. é‡æ–°æ¸²æŸ“ç•Œé¢ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                console.log('ğŸ¨ æ­¥éª¤5ï¼šé‡æ–°æ¸²æŸ“ç•Œé¢');
                renderHabits();
                renderCalendar();
                updateStats();
                
                console.log('âœ… å¼ºåˆ¶ä¿å­˜å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ å¼ºåˆ¶ä¿å­˜å¤±è´¥:', error);
                MessageUtils.error('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // éªŒè¯ä¹ æƒ¯æ•°æ®æ ¼å¼
        function validateHabitData(data) {
            const validatedData = {};
            
            if (!data || typeof data !== 'object') {
                console.warn('âš ï¸ ä¹ æƒ¯æ•°æ®æ ¼å¼æ— æ•ˆï¼Œè¿”å›ç©ºå¯¹è±¡');
                return {};
            }
            
            for (const [habitId, habit] of Object.entries(data)) {
                if (!habit || typeof habit !== 'object') {
                    console.warn('âš ï¸ è·³è¿‡æ— æ•ˆä¹ æƒ¯:', habitId);
                    continue;
                }
                
                // éªŒè¯å¿…éœ€å­—æ®µ
                if (!habit.name || !habit.id) {
                    console.warn('âš ï¸ è·³è¿‡ç¼ºå°‘å¿…éœ€å­—æ®µçš„ä¹ æƒ¯:', habitId);
                    continue;
                }
                
                validatedData[habitId] = {
                    id: habit.id,
                    name: sanitizeHabitText(habit.name),
                    icon: sanitizeHabitText(habit.icon || 'ğŸ“‹'),
                    target: Math.max(1, parseInt(habit.target) || 1),
                    unit: sanitizeHabitText(habit.unit || 'æ¬¡'),
                    createdAt: habit.createdAt || new Date().toISOString(),
                    updatedAt: habit.updatedAt,
                    records: habit.records || {}
                };
            }
            
            console.log(`âœ… éªŒè¯å®Œæˆï¼Œæœ‰æ•ˆä¹ æƒ¯: ${Object.keys(validatedData).length} ä¸ª`);
            return validatedData;
        }

        function saveHabitsData() {
            try {
                // åœ¨ä¿å­˜å‰å…ˆæ¸…ç†æ•°æ®
                const cleanedData = validateHabitData(habitsData);
                const jsonString = JSON.stringify(cleanedData, null, 0);
                localStorage.setItem('habitTrackerData', jsonString);
                habitsData = cleanedData;
            } catch (error) {
                console.error('âŒ ä¿å­˜ä¹ æƒ¯æ•°æ®å¤±è´¥:', error);
                MessageUtils.error('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
    </script>
    
    <!-- åŒæ­¥æœåŠ¡ -->
    <script src="sync-service.js"></script>
    <script src="sync-providers.js"></script>
    <!-- é€šç”¨è‡ªåŠ¨åŒæ­¥åŠŸèƒ½ -->
    <script src="universal-auto-sync.js"></script>
    <!-- å…¨è‡ªåŠ¨åå°åŒæ­¥ -->
    <script src="auto-background-sync.js"></script>
    <script src="add-ai-to-all-pages.js"></script>
    <script src="ai-fix-universal.js"></script>  <!-- AIåˆ†æåŠŸèƒ½ä¿®å¤ -->
</body>

</html>

