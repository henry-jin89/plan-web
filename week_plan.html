<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script src="config.js"></script>
    
    <!-- Firebase配置 -->
    <script src="firebase-config.js"></script>
    
    <!-- 同步修复工具 -->
    <script src="sync-fix.js"></script>
    
    <!-- Firebase数据库同步 -->
    <script src="firebase-database-sync.js"></script>
    <script src="gemini-ai-assistant.js"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>周计划 - 智能计划管理系统</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ai-assistant-styles.css">
</head>

<body>
    <div class="container">
        <!-- 页面头部 -->
        <div class="page-header">
            <a href="index.html" class="back-to-home">← 返回主页</a>
            <h1 class="page-title">📊 周计划管理</h1>
            <div style="display: flex; gap: 8px;">
                <a href="day_plan.html" class="btn-main" style="font-size: 0.9em;">日计划</a>
                <a href="month_plan.html" class="btn-main" style="font-size: 0.9em;">月计划</a>
                <button type="button" onclick="showHelpModal()" class="btn-main" style="font-size: 0.9em; background: #f3e5f5; color: #7b1fa2;" title="快捷键帮助 (F1)">❓ 帮助</button>
            </div>
        </div>

        <!-- AI智能分析区域 - 放在最顶部 -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">
                <div style="flex: 1;">
                    <h3 style="color: white; margin: 0 0 8px 0; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                        🤖 AI 智能分析
                        <span style="font-size: 0.5em; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px;">Gemini 2.5 Pro</span>
                    </h3>
                    <p style="color: rgba(255,255,255,0.95); margin: 0; font-size: 1em; line-height: 1.6;">
                        让 AI 分析您的周计划，提供专业建议和优化方案
                    </p>
                </div>
                <button type="button" onclick="startAIAnalysis()" style="background: white; color: #667eea; border: none; padding: 16px 40px; border-radius: 12px; font-size: 1.1em; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; white-space: nowrap;">
                    🚀 开始分析
                </button>
            </div>
        </div>

        <!-- 智能控制栏 -->
        <div class="plan-smartbar">
            <!-- 进度条 -->
            <div class="progress-bar" id="week-progress-bar" style="flex: 1;">
                <div style="background:#eee;border-radius:8px;height:18px;overflow:hidden;box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                    <div id="week-progress-inner" class="progress-inner" style="width: 0%;">
                        <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite;"></div>
                    </div>
                </div>
                <div id="week-progress-text" style="font-size:0.9em;color:#666;margin-top:3px;display:flex;justify-content:space-between;">
                    <span id="progress-main">本周进度 0%</span>
                    <span id="progress-stats" style="color:#999;font-size:0.85em;"></span>
                </div>
            </div>
            
            <!-- 周导航 -->
            <button type="button" id="week-prev" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer; transition: all 0.2s;" title="切换到上周（如有未完成任务会提示结转）">←</button>
            <input type="week" id="week_date" style="width:150px;border-radius:6px;border:1px solid #ddd;padding:4px;" title="选择周次（切换时自动检测未完成任务）">
            <span id="week_range" style="width: 120px; text-align: center; font-weight: 600; color: var(--theme-color); padding: 4px 8px; background: rgba(25,118,210,0.1); border-radius: 6px; font-size: 0.9em;"></span>
            <button type="button" id="week-next" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer; transition: all 0.2s;" title="切换到下周（如有未完成任务会提示结转）">→</button>
            
            <!-- 快捷操作 -->
            <div style="display: flex; gap: 4px;">
                <button type="button" id="week-analysis-btn" style="background: var(--theme-color-light); color: var(--theme-color); border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 0.9em;" title="周分析">📈</button>
                <button type="button" id="week-review-btn" style="background: #fff3e0; color: #ef6c00; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 0.9em;" title="周回顾">🔍</button>
            </div>
        </div>

        <!-- 操作栏 -->
        <div class="save-bar">
            <button type="button" id="week-template-btn" class="btn-main" style="background: #ff9800;">📋 使用模板</button>
            <button type="button" class="save-btn" data-type="week">💾 保存计划</button>
            <button type="button" class="save-view-btn" data-type="week">📚 历史记录</button>
            <button type="button" id="week-insights-btn" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1976d2;">🧠 智能洞察</button>
            <button type="button" id="week-optimization-btn" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); color: #2e7d32;">⚡ 效率优化</button>
            <button type="button" id="generate-review-btn" style="background: linear-gradient(135deg, #fff3e0, #ffcc02); color: #ef6c00;">📋 生成周报</button>
        </div>

        <!-- 周目标设定 -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                🎯 本周核心目标
                <span style="background: #e3f2fd; color: #1976d2; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">Focus</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" class="quick-insert" data-target="week_goals">快捷插入</button>
                <button type="button" id="ai-suggest-goals-btn" style="background: #f3e5f5; color: #7b1fa2; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    🤖 AI建议
                </button>
                <button type="button" id="goal-tracker-btn" style="background: #e8f5e9; color: #2e7d32; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    📊 目标追踪
                </button>
            </div>
        </div>
        <textarea id="week_goals" placeholder="设定本周要达成的3-5个核心目标...

例如：
• 完成项目第一阶段开发
• 学习新技能并实践
• 改善工作流程效率
• 加强团队沟通协作" style="min-height: 100px;"></textarea>

        <!-- 每日重点安排 -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                📅 每日重点安排
                <span id="daily-completion-rate" style="background: #4caf50; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">完成率 0%</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" id="auto-schedule-btn" style="background: #e3f2fd; color: #1976d2; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    🤖 智能排程
                </button>
                <button type="button" id="workload-balance-btn" style="background: #fff3e0; color: #ef6c00; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    ⚖️ 负载均衡
                </button>
            </div>
        </div>

        <!-- 每日计划网格 -->
        <div id="daily-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
            <!-- 周一 -->
            <div class="daily-card">
                <div class="daily-header">
                    <h4 style="margin: 0; color: var(--theme-color); display: flex; align-items: center; gap: 8px;">
                        📅 周一
                        <span class="daily-date" id="monday-date"></span>
                    </h4>
                    <div class="daily-progress-mini" style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 40px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                            <div class="daily-progress-fill" data-day="monday" style="height: 100%; background: var(--theme-color); width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <span class="daily-percent" data-day="monday" style="font-size: 0.8em; color: #666;">0%</span>
                    </div>
                </div>
                <div id="monday_tasks" class="todo-list-container" data-placeholder="[ ] 周一的重点任务..." style="min-height: 120px;"></div>
            </div>

            <!-- 周二 -->
            <div class="daily-card">
                <div class="daily-header">
                    <h4 style="margin: 0; color: var(--theme-color); display: flex; align-items: center; gap: 8px;">
                        📅 周二
                        <span class="daily-date" id="tuesday-date"></span>
                    </h4>
                    <div class="daily-progress-mini" style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 40px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                            <div class="daily-progress-fill" data-day="tuesday" style="height: 100%; background: var(--theme-color); width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <span class="daily-percent" data-day="tuesday" style="font-size: 0.8em; color: #666;">0%</span>
                    </div>
                </div>
                <div id="tuesday_tasks" class="todo-list-container" data-placeholder="[ ] 周二的重点任务..." style="min-height: 120px;"></div>
            </div>

            <!-- 周三 -->
            <div class="daily-card">
                <div class="daily-header">
                    <h4 style="margin: 0; color: var(--theme-color); display: flex; align-items: center; gap: 8px;">
                        📅 周三
                        <span class="daily-date" id="wednesday-date"></span>
                    </h4>
                    <div class="daily-progress-mini" style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 40px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                            <div class="daily-progress-fill" data-day="wednesday" style="height: 100%; background: var(--theme-color); width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <span class="daily-percent" data-day="wednesday" style="font-size: 0.8em; color: #666;">0%</span>
                    </div>
                </div>
                <div id="wednesday_tasks" class="todo-list-container" data-placeholder="[ ] 周三的重点任务..." style="min-height: 120px;"></div>
            </div>

            <!-- 周四 -->
            <div class="daily-card">
                <div class="daily-header">
                    <h4 style="margin: 0; color: var(--theme-color); display: flex; align-items: center; gap: 8px;">
                        📅 周四
                        <span class="daily-date" id="thursday-date"></span>
                    </h4>
                    <div class="daily-progress-mini" style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 40px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                            <div class="daily-progress-fill" data-day="thursday" style="height: 100%; background: var(--theme-color); width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <span class="daily-percent" data-day="thursday" style="font-size: 0.8em; color: #666;">0%</span>
                    </div>
                </div>
                <div id="thursday_tasks" class="todo-list-container" data-placeholder="[ ] 周四的重点任务..." style="min-height: 120px;"></div>
            </div>

            <!-- 周五 -->
            <div class="daily-card">
                <div class="daily-header">
                    <h4 style="margin: 0; color: var(--theme-color); display: flex; align-items: center; gap: 8px;">
                        📅 周五
                        <span class="daily-date" id="friday-date"></span>
                    </h4>
                    <div class="daily-progress-mini" style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 40px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                            <div class="daily-progress-fill" data-day="friday" style="height: 100%; background: var(--theme-color); width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <span class="daily-percent" data-day="friday" style="font-size: 0.8em; color: #666;">0%</span>
                    </div>
                </div>
                <div id="friday_tasks" class="todo-list-container" data-placeholder="[ ] 周五的重点任务..." style="min-height: 120px;"></div>
            </div>

            <!-- 周末计划 -->
            <div class="daily-card" style="grid-column: span 2;">
                <div class="daily-header">
                    <h4 style="margin: 0; color: #ff9800; display: flex; align-items: center; gap: 8px;">
                        🏖️ 周末安排
                        <span style="background: #fff3e0; color: #ef6c00; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">休息&充电</span>
                    </h4>
                    <div class="daily-progress-mini" style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 40px; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                            <div class="daily-progress-fill" data-day="weekend" style="height: 100%; background: #ff9800; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <span class="daily-percent" data-day="weekend" style="font-size: 0.8em; color: #666;">0%</span>
                    </div>
                </div>
                <div id="weekend_plan" class="todo-list-container" data-placeholder="[ ] 周末的休闲安排和个人时间..." style="min-height: 120px;"></div>
            </div>
        </div>

        <!-- 周回顾与总结 -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                📝 周回顾与总结
                <span style="background: #9c27b0; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">复盘成长</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" id="review-template-btn" style="background: #f3e5f5; color: #7b1fa2; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    📋 回顾模板
                </button>
                <button type="button" id="achievement-tracker-btn" style="background: #e8f5e9; color: #2e7d32; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em;">
                    🏆 成就记录
                </button>
            </div>
        </div>
        <textarea id="week_review" placeholder="本周总结与反思...

建议回顾内容：
• 本周完成了哪些重要目标？
• 遇到了什么挑战，如何解决的？
• 学到了什么新知识或技能？
• 有哪些工作方法可以改进？
• 下周需要重点关注什么？
• 值得庆祝的成就有哪些？" style="min-height: 150px;"></textarea>

        <!-- 下周预览 -->
        <div class="plan-item-header">
            <label style="display: flex; align-items: center; gap: 8px;">
                🚀 下周预览
                <span style="background: #00796b; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; font-weight: normal;">前瞻规划</span>
            </label>
            <div style="display: flex; gap: 6px;">
                <button type="button" id="next-week-ai-btn" style="background: #e0f2f1; color: #00796b; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em; transition: all 0.2s ease;" title="基于本周表现智能生成下周计划建议">
                    🤖 AI规划
                </button>
                <button type="button" id="carry-over-btn" style="background: #fff3e0; color: #ef6c00; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.85em; transition: all 0.2s ease;" title="将本周未完成的任务结转到下周预览" onclick="console.log('结转按钮被点击了!'); carryOverTasks();">
                    📋 结转任务
                </button>
            </div>
        </div>
        <textarea id="next_week_preview" placeholder="下周重点规划...

可以包括：
• 延续本周未完成的重要任务
• 新的目标和挑战
• 需要准备的重要事项
• 预期的会议和约会
• 学习和成长计划" style="min-height: 100px;"></textarea>
    </div>

    <style>
        .daily-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .daily-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .daily-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .daily-date {
            font-size: 0.8em;
            font-weight: normal;
            color: #666;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            #daily-grid {
                grid-template-columns: 1fr;
            }
            
            .daily-card[style*="grid-column: span 2"] {
                grid-column: span 1 !important;
            }
        }
    </style>

    <script src="common.js"></script>
    <script src="week_plan.js"></script>

    <!-- 集成的任务编辑和删除功能修复 -->
    <script>
        // 修复后的待办事项工具类 - 直接集成在week_plan.html中
        const WeekPlanTodoUtils = {
            /**
             * 初始化待办事项容器
             * @param {HTMLElement} container - 容器元素
             */
            init: function(container) {
                if (!container) return;

                // 不要设置容器本身为contentEditable，只有任务文本才是可编辑的
                container.contentEditable = false;
                
                // 监听输入事件（来自任务文本）
                container.addEventListener('input', (e) => {
                    // 只处理来自任务文本的输入事件
                    if (e.target.classList && e.target.classList.contains('task-text')) {
                        this.handleTodoInput(e);
                    }
                });

                // 监听回车键 - 与日计划保持一致：Enter创建新任务
                container.addEventListener('keydown', (e) => {
                    // 只处理来自任务文本的回车键
                    if (e.target.classList && e.target.classList.contains('task-text') && e.key === 'Enter') {
                        e.preventDefault();
                        this.addNewTodoItem(container);
                    }
                });

                // 监听点击事件（用于复选框、删除按钮和空容器点击）
                container.addEventListener('click', (e) => {
                    this.handleTodoClick(e);
                });

                // 初始化现有内容
                this.initExistingTodos(container);
                
                // 如果容器为空，显示占位符并处理点击
                this.updatePlaceholder(container);
            },

            /**
             * 处理待办事项输入（优化版本 - 避免频繁重新渲染）
             * @param {Event} e - 输入事件
             */
            handleTodoInput: function(e) {
                // 如果是输入法组合中，不做任何处理
                if (e.isComposing) {
                    return;
                }
                
                // 只在blur事件时保存数据，不在input事件时重新渲染
                // 这样可以避免用户输入时频繁丢失焦点
                const taskElement = e.target;
                const container = taskElement.closest('.todo-list-container');
                
                if (container) {
                    // 只更新数据属性，不重新渲染HTML
                    this.updateContainerDataOnly(container);
                }
            },

            /**
             * 添加新的待办事项
             * @param {HTMLElement} container - 容器元素
             */
            addNewTodoItem: function(container) {
                // 首先移除占位符
                const placeholder = container.querySelector('.todo-placeholder');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // 创建一个新的任务项
                const newTaskItem = this.createTodoElement('[ ] ');
                if (newTaskItem) {
                    container.appendChild(newTaskItem);
                    
                    // 聚焦到新任务的文本框
                    const textElement = newTaskItem.querySelector('.task-text');
                    if (textElement) {
                        textElement.focus();
                        // 将光标移到文本末尾
                        if (textElement.tagName === 'TEXTAREA' || textElement.tagName === 'INPUT') {
                            textElement.setSelectionRange(textElement.value.length, textElement.value.length);
                        }
                    }
                    
                    // 只更新数据，不重新渲染（避免失去焦点）
                    this.updateContainerDataOnly(container);
                }
            },

            /**
             * 处理待办事项点击
             * @param {Event} e - 点击事件
             */
            handleTodoClick: function(e) {
                if (e.target.classList.contains('custom-checkbox')) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.toggleTodoItem(e.target);
                } else if (e.target.classList.contains('task-delete-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.deleteTodoItem(e.target);
                } else if (e.target.classList.contains('todo-list-container')) {
                    // 点击空容器时创建新任务
                    const tasks = e.target.querySelectorAll('.task-item');
                    if (tasks.length === 0) {
                        this.addNewTodoItem(e.target);
                    }
                }
            },

            /**
             * 切换待办事项状态
             * @param {HTMLElement} checkbox - 复选框元素
             */
            toggleTodoItem: function(checkbox) {
                const taskItem = checkbox.closest('.task-item');
                const taskText = taskItem.querySelector('.task-text');
                const container = taskItem.closest('.todo-list-container');
                
                const isChecked = checkbox.classList.contains('checked');
                
                if (isChecked) {
                    checkbox.classList.remove('checked');
                    taskText.style.textDecoration = 'none';
                    taskText.style.opacity = '1';
                } else {
                    checkbox.classList.add('checked');
                    taskText.style.textDecoration = 'line-through';
                    taskText.style.opacity = '0.6';
                }
                
                this.updateContainerContent(container);
                
                // 触发进度更新
                if (typeof updateDailyProgress === 'function') {
                    setTimeout(() => {
                        updateDailyProgress();
                        if (typeof updateWeekProgress === 'function') {
                            updateWeekProgress();
                        }
                    }, 100);
                }
            },

            /**
             * 删除待办事项（修复版本）
             * @param {HTMLElement} deleteBtn - 删除按钮
             */
            deleteTodoItem: function(deleteBtn) {
                const taskItem = deleteBtn.closest('.task-item');
                const container = taskItem.closest('.todo-list-container');
                const taskText = taskItem.querySelector('.task-text').textContent;
                
                console.log(`🗑️ 删除任务: "${taskText}"`);
                
                // 添加删除动画
                taskItem.style.transition = 'all 0.3s ease';
                taskItem.style.opacity = '0';
                taskItem.style.transform = 'translateX(-20px)';
                
                // 延迟删除以显示动画
                setTimeout(() => {
                    taskItem.remove();
                    this.updateContainerContent(container);
                    
                    console.log('✅ 任务删除完成，容器内容已更新');
                    
                    // 显示删除成功提示
                    if (typeof MessageUtils !== 'undefined' && MessageUtils.success) {
                        MessageUtils.success(`已删除任务: ${taskText.length > 20 ? taskText.substring(0, 20) + '...' : taskText}`);
                    }
                    
                    // 触发进度更新
                    if (typeof updateDailyProgress === 'function') {
                        setTimeout(() => {
                            updateDailyProgress();
                            if (typeof updateWeekProgress === 'function') {
                                updateWeekProgress();
                            }
                        }, 100);
                    }
                }, 300);
            },

            /**
             * 渲染待办事项
             * @param {HTMLElement} container - 容器元素
             */
            renderTodos: function(container) {
                const content = container.textContent;
                const lines = content.split('\n').filter(line => line.trim());
                
                // 清空容器并重新渲染
                container.innerHTML = '';
                
                lines.forEach((line, index) => {
                    if (line.match(/^\[.\]/)) {
                        try {
                            const taskItem = this.createTodoElement(line);
                            if (taskItem && taskItem.nodeType === Node.ELEMENT_NODE) {
                                container.appendChild(taskItem);
                            } else {
                                console.error('❌ createTodoElement 返回了无效的DOM节点:', taskItem, '对于行:', line);
                            }
                        } catch (error) {
                            console.error('❌ 创建待办事项元素时出错:', error, '行内容:', line, '行索引:', index);
                        }
                    }
                });
                
                // 渲染完成后调整所有textarea的高度
                setTimeout(() => {
                    const textareas = container.querySelectorAll('.task-text');
                    textareas.forEach(textarea => {
                        if (textarea.tagName === 'TEXTAREA') {
                            textarea.style.height = 'auto';
                            const scrollHeight = textarea.scrollHeight;
                            textarea.style.height = Math.max(scrollHeight, 22) + 'px';
                        }
                    });
                }, 10);
                
                // 渲染完成后更新占位符
                this.updatePlaceholder(container);
            },

            /**
             * 创建待办事项元素（修复版本）
             * @param {string} line - 待办事项文本
             * @returns {HTMLElement} 任务元素
             */
            createTodoElement: function(line) {
                const match = line.match(/^\[(.)\]\s*(.*)$/);
                if (!match) return null;
                
                const isChecked = match[1] === 'x';
                const text = match[2];
                
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                
                const taskContent = document.createElement('div');
                taskContent.className = 'task-content';
                taskContent.style.cssText = 'display: flex; align-items: flex-start; width: 100%; gap: 8px;';
                
                const checkbox = document.createElement('div');
                checkbox.className = 'custom-checkbox';
                if (isChecked) checkbox.classList.add('checked');
                
                // 使用textarea元素支持多行文本和自动换行
                const taskTextEl = document.createElement('textarea');
                taskTextEl.className = 'task-text';
                taskTextEl.value = text;
                taskTextEl.rows = 1; // 初始只显示一行
                taskTextEl.title = 'Enter键创建新任务';
                
                // 设置基本属性，确保输入法正常工作
                taskTextEl.spellcheck = false;
                taskTextEl.setAttribute('inputmode', 'text');
                taskTextEl.setAttribute('lang', 'zh-CN');
                
                // 设置样式 - 确保自动换行
                taskTextEl.style.border = 'none';
                taskTextEl.style.outline = 'none';
                taskTextEl.style.background = 'transparent';
                taskTextEl.style.width = '100%';
                taskTextEl.style.maxWidth = '100%';
                taskTextEl.style.font = 'inherit';
                taskTextEl.style.color = 'inherit';
                taskTextEl.style.resize = 'none'; // 禁止手动调整大小
                taskTextEl.style.overflowY = 'hidden'; // 隐藏垂直滚动条
                taskTextEl.style.overflowX = 'hidden'; // 隐藏水平滚动条
                taskTextEl.style.minHeight = '1.4em'; // 最小高度
                taskTextEl.style.boxSizing = 'border-box'; // 正确的盒模型
                taskTextEl.style.wordWrap = 'break-word'; // 自动换行
                taskTextEl.style.wordBreak = 'break-all'; // 强制换行
                taskTextEl.style.whiteSpace = 'pre-wrap'; // 保持换行
                taskTextEl.style.overflowWrap = 'break-word'; // 现代浏览器换行
                
                // 处理键盘事件 - 重新修复版本：Enter创建新任务
                taskTextEl.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        if (e.shiftKey) {
                            // Shift+Enter: 允许换行
                            return true;
                        } else {
                            // 普通Enter: 创建新任务
                            e.preventDefault();
                            const container = this.closest('.todo-list-container');
                            if (container && WeekPlanTodoUtils) {
                                WeekPlanTodoUtils.addNewTodoItem(container);
                            }
                        }
                    }
                });
                
                // 自动调整高度的增强版本
                function adjustHeight() {
                    taskTextEl.style.height = 'auto';
                    const scrollHeight = taskTextEl.scrollHeight;
                    taskTextEl.style.height = Math.max(scrollHeight, 22) + 'px'; // 最小高度22px
                }
                
                // 监听多个事件以确保高度调整
                taskTextEl.addEventListener('input', adjustHeight);
                taskTextEl.addEventListener('paste', function() {
                    // 粘贴后延迟调整高度
                    setTimeout(adjustHeight, 10);
                });
                taskTextEl.addEventListener('keyup', adjustHeight);
                
                // 初始化时也调整高度
                setTimeout(adjustHeight, 10);
                
                // 失去焦点时进行完整更新（包括重新渲染）
                taskTextEl.addEventListener('blur', function() {
                    const container = this.closest('.todo-list-container');
                    if (container && WeekPlanTodoUtils) {
                        // 使用完整更新，因为blur时不会干扰用户输入
                        WeekPlanTodoUtils.updateContainerContent(container);
                    }
                });
                
                if (isChecked) {
                    taskTextEl.style.textDecoration = 'line-through';
                    taskTextEl.style.opacity = '0.6';
                }
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'task-delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.title = '删除此项';
                
                taskContent.appendChild(checkbox);
                taskContent.appendChild(taskTextEl);
                taskContent.appendChild(deleteBtn);
                taskItem.appendChild(taskContent);
                
                return taskItem;
            },

            /**
             * 只更新容器数据，不重新渲染HTML（避免输入时丢失焦点）
             * @param {HTMLElement} container - 容器元素
             */
            updateContainerDataOnly: function(container) {
                const tasks = container.querySelectorAll('.task-item');
                const lines = [];
                
                tasks.forEach(task => {
                    const checkbox = task.querySelector('.custom-checkbox');
                    const textElement = task.querySelector('.task-text');
                    
                    // 适配textarea、input元素和div元素
                    let text = '';
                    if (textElement) {
                        if (textElement.tagName === 'TEXTAREA' || textElement.tagName === 'INPUT') {
                            text = textElement.value || '';
                        } else {
                            text = textElement.textContent || '';
                        }
                        text = text.trim();
                    }
                    
                    const isChecked = checkbox && checkbox.classList.contains('checked');
                    if (text) {
                        lines.push(`[${isChecked ? 'x' : ' '}] ${text}`);
                    }
                });
                
                const newContent = lines.join('\n');
                container.setAttribute('data-content', newContent);
                // 注意：这里不设置textContent和不调用renderTodos，保持HTML结构不变
                
                // 触发保存事件
                const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                container.dispatchEvent(inputEvent);
            },

            /**
             * 更新容器内容（完整版本 - 包含HTML重新渲染）
             * @param {HTMLElement} container - 容器元素
             */
            updateContainerContent: function(container) {
                const tasks = container.querySelectorAll('.task-item');
                const lines = [];
                
                tasks.forEach(task => {
                    const checkbox = task.querySelector('.custom-checkbox');
                    const textElement = task.querySelector('.task-text');
                    
                    // 适配textarea、input元素和div元素
                    let text = '';
                    if (textElement) {
                        if (textElement.tagName === 'TEXTAREA' || textElement.tagName === 'INPUT') {
                            text = textElement.value || '';
                        } else {
                            text = textElement.textContent || '';
                        }
                        text = text.trim();
                    }
                    
                    const isChecked = checkbox && checkbox.classList.contains('checked');
                    if (text) {
                        lines.push(`[${isChecked ? 'x' : ' '}] ${text}`);
                    }
                });
                
                const newContent = lines.join('\n');
                container.setAttribute('data-content', newContent);
                container.textContent = newContent;
                
                // 关键修复：重新渲染HTML结构以保持交互功能
                this.renderTodos(container);
                
                // 触发保存事件
                const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                container.dispatchEvent(inputEvent);
            },

            /**
             * 初始化现有待办事项
             * @param {HTMLElement} container - 容器元素
             */
            initExistingTodos: function(container) {
                const content = container.textContent;
                if (content && content.includes('[')) {
                    // 延迟渲染，确保DOM完全初始化
                    setTimeout(() => {
                        this.renderTodos(container);
                        
                        // 额外调整一次高度，确保加载的数据正确显示
                        setTimeout(() => {
                            const textareas = container.querySelectorAll('.task-text');
                            textareas.forEach(textarea => {
                                if (textarea.tagName === 'TEXTAREA') {
                                    textarea.style.height = 'auto';
                                    const scrollHeight = textarea.scrollHeight;
                                    textarea.style.height = Math.max(scrollHeight, 22) + 'px';
                                }
                            });
                        }, 200);
                    }, 100);
                }
            },

            /**
             * 更新占位符显示
             * @param {HTMLElement} container - 容器元素
             */
            updatePlaceholder: function(container) {
                const tasks = container.querySelectorAll('.task-item');
                const placeholder = container.querySelector('.todo-placeholder');
                
                if (tasks.length === 0) {
                    // 没有任务时显示占位符
                    if (!placeholder) {
                        const placeholderEl = document.createElement('div');
                        placeholderEl.className = 'todo-placeholder';
                        placeholderEl.textContent = container.getAttribute('data-placeholder') || '点击添加新任务...';
                        // 样式由CSS类控制，无需内联样式
                        
                        placeholderEl.addEventListener('click', () => {
                            this.addNewTodoItem(container);
                        });
                        
                        container.appendChild(placeholderEl);
                    }
                } else {
                    // 有任务时移除占位符
                    if (placeholder) {
                        placeholder.remove();
                    }
                }
            },

            /**
             * 设置光标到容器末尾
             * @param {HTMLElement} container - 容器元素
             */
            setCursorToEnd: function(container) {
                const range = document.createRange();
                const selection = window.getSelection();
                range.selectNodeContents(container);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        };

        // 修复全局键盘事件冲突 - 完全避免干扰输入法
        const WeekPlanKeyboardUtils = {
            init: function() {
                // 只在冒泡阶段监听，降低干扰可能性
                document.addEventListener('keydown', (e) => {
                    // 如果是任务文本或任何可编辑元素，完全不处理
                    if (e.target.classList && e.target.classList.contains('task-text')) {
                        return; // 任务文本编辑时完全不干预
                    }
                    
                    // 检查其他可编辑元素
                    if (e.target.contentEditable === 'true' || 
                        e.target.tagName === 'INPUT' || 
                        e.target.tagName === 'TEXTAREA') {
                        return; // 所有编辑元素都不干预
                    }
                    
                    // 检查是否正在使用输入法
                    if (e.isComposing) {
                        return; // 输入法组合期间不处理任何快捷键
                    }
                    
                    // 只在确定不是编辑状态时处理快捷键
                    if (e.ctrlKey && e.key === 'q') {
                        e.preventDefault();
                        console.log('Ctrl+Q pressed - emergency modal close');
                    }
                }, false); // 使用冒泡阶段，优先级更低
            }
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 初始化周计划页面的任务编辑功能');
            
            // 先初始化键盘事件处理（优先级更高）
            WeekPlanKeyboardUtils.init();
            
            // 延迟初始化待办事项容器，确保其他脚本加载完成
            setTimeout(() => {
                const todoContainers = document.querySelectorAll('.todo-list-container');
                console.log('找到待办事项容器数量:', todoContainers.length);
                
                todoContainers.forEach(container => {
                    console.log('初始化容器:', container.id);
                    WeekPlanTodoUtils.init(container);
                });
                
                console.log('✅ 周计划页面任务编辑功能初始化完成');
                
                // 初始化模板功能
                const templateBtn = document.getElementById('week-template-btn');
                if (templateBtn) {
                    templateBtn.addEventListener('click', showWeekTemplateSelector);
                }
                
                // 初始化AI建议功能
                const aiSuggestBtn = document.getElementById('ai-suggest-goals-btn');
                if (aiSuggestBtn) {
                    aiSuggestBtn.addEventListener('click', function() {
                        console.log('🤖 AI建议按钮被点击');
                        if (window.WeekPlanAISuggestions) {
                            WeekPlanAISuggestions.showAISuggestionSelector();
                        } else {
                            console.error('WeekPlanAISuggestions 未找到');
                        }
                    });
                }
                
                // 检查是否需要显示调试按钮（按两次Ctrl+D显示）
                let ctrlDCount = 0;
                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'd') {
                        e.preventDefault();
                        ctrlDCount++;
                        if (ctrlDCount >= 2) {
                            const debugBtn = document.getElementById('debug-tasks-btn');
                            if (debugBtn) {
                                debugBtn.style.display = 'inline-block';
                                console.log('🔍 调试按钮已激活');
                            }
                            ctrlDCount = 0; // 重置计数
                        }
                        // 2秒后重置计数
                        setTimeout(() => {
                            ctrlDCount = 0;
                        }, 2000);
                    }
                });
                
            }, 500); // 延迟500ms确保其他脚本加载完成
        });

        // 周计划模板数据
        const weekTemplates = {
            productive: {
                name: "💼 高效工作周",
                description: "专注于工作效率和任务完成的模板",
                data: {
                    goals: `本周核心目标：
• 完成重要项目的关键里程碑
• 提升工作效率和质量
• 优化工作流程和方法
• 加强团队协作和沟通`,
                    monday: `[ ] 制定本周详细计划
[ ] 处理优先级最高的任务
[ ] 团队会议和工作同步`,
                    tuesday: `[ ] 推进核心项目开发
[ ] 完成重要文档整理
[ ] 客户沟通和需求确认`,
                    wednesday: `[ ] 项目中期检查和调整
[ ] 技能学习和知识更新
[ ] 工作流程优化`,
                    thursday: `[ ] 完成项目关键节点
[ ] 质量检查和测试
[ ] 团队协作和反馈`,
                    friday: `[ ] 项目收尾和总结
[ ] 下周计划准备
[ ] 工作成果整理`,
                    saturday: `[ ] 个人技能提升
[ ] 工作经验总结
[ ] 放松和充电`,
                    sunday: `[ ] 周回顾和反思
[ ] 下周规划和准备
[ ] 家庭时间和休息`,
                    reflection: `本周工作反思：
• 完成的重要任务和成果
• 遇到的挑战和解决方案
• 工作效率和质量评估
• 下周需要改进的方向`
                }
            },
            balanced: {
                name: "⚖️ 工作生活平衡",
                description: "平衡工作、学习、健康和生活的综合模板",
                data: {
                    goals: `本周平衡目标：
• 高质量完成工作任务
• 保持身心健康状态
• 维护重要人际关系
• 培养个人兴趣爱好`,
                    monday: `[ ] 制定本周平衡计划
[ ] 开始重要工作项目
[ ] 30分钟运动或锻炼`,
                    tuesday: `[ ] 推进工作核心任务
[ ] 学习新知识或技能
[ ] 与朋友或家人交流`,
                    wednesday: `[ ] 工作项目中期检查
[ ] 健康饮食和作息调整
[ ] 个人兴趣时间`,
                    thursday: `[ ] 完成工作重点任务
[ ] 阅读或学习充电
[ ] 社交活动或聚会`,
                    friday: `[ ] 工作周总结和整理
[ ] 周末计划安排
[ ] 放松和娱乐时间`,
                    saturday: `[ ] 个人兴趣和爱好
[ ] 家庭聚会或朋友聚会
[ ] 户外活动或运动`,
                    sunday: `[ ] 周回顾和反思
[ ] 下周准备和规划
[ ] 休息和恢复精力`,
                    reflection: `工作生活平衡反思：
• 工作与生活的平衡程度
• 身心健康状况评估
• 人际关系维护情况
• 个人成长和满足感`
                }
            },
            learning: {
                name: "📚 学习成长周",
                description: "专注于知识学习和技能提升的模板",
                data: {
                    goals: `本周学习目标：
• 掌握新的知识和技能
• 完成重要学习项目
• 提升学习效率和方法
• 应用所学知识到实践`,
                    monday: `[ ] 制定本周学习计划
[ ] 开始新课程或教材
[ ] 整理学习资料和工具`,
                    tuesday: `[ ] 深入学习核心概念
[ ] 完成练习和作业
[ ] 记录学习笔记和心得`,
                    wednesday: `[ ] 学习进度中期检查
[ ] 难点问题研究和解决
[ ] 与同学或老师交流`,
                    thursday: `[ ] 实践应用所学知识
[ ] 完成项目或作业
[ ] 参加学习讨论或分享`,
                    friday: `[ ] 本周学习成果总结
[ ] 知识点复习和巩固
[ ] 下周学习计划制定`,
                    saturday: `[ ] 拓展阅读和研究
[ ] 学习方法优化
[ ] 学习成果整理`,
                    sunday: `[ ] 学习周回顾反思
[ ] 知识体系梳理
[ ] 学习计划调整`,
                    reflection: `学习成长反思：
• 本周学习的新知识和技能
• 学习方法和效率改进
• 知识应用和实践效果
• 下周学习重点和方向`
                }
            },
            health: {
                name: "🏃‍♂️ 健康生活周",
                description: "注重身心健康和生活品质的模板",
                data: {
                    goals: `本周健康目标：
• 建立规律的运动习惯
• 保持健康的饮食作息
• 管理压力和情绪健康
• 提升整体生活质量`,
                    monday: `[ ] 制定本周健康计划
[ ] 晨练或运动30分钟
[ ] 健康饮食和充足睡眠`,
                    tuesday: `[ ] 继续运动锻炼
[ ] 营养均衡的三餐
[ ] 压力管理和放松`,
                    wednesday: `[ ] 运动计划中期调整
[ ] 健康体检或咨询
[ ] 冥想或瑜伽练习`,
                    thursday: `[ ] 坚持运动锻炼
[ ] 健康知识学习
[ ] 社交活动和交流`,
                    friday: `[ ] 本周健康总结
[ ] 周末活动计划
[ ] 身心状态评估`,
                    saturday: `[ ] 户外运动或活动
[ ] 健康美食制作
[ ] 放松和娱乐时间`,
                    sunday: `[ ] 健康周回顾
[ ] 下周健康计划
[ ] 充分休息和恢复`,
                    reflection: `健康生活反思：
• 本周运动和饮食情况
• 身体状况和体能变化
• 心理健康和压力管理
• 生活质量和满意度`
                }
            },
            creative: {
                name: "🎨 创意灵感周",
                description: "激发创造力和艺术灵感的模板",
                data: {
                    goals: `本周创意目标：
• 完成重要创意作品
• 探索新的创作形式
• 提升艺术技能和表达
• 寻找灵感和创作素材`,
                    monday: `[ ] 制定本周创作计划
[ ] 收集创作灵感和素材
[ ] 开始新的创意项目`,
                    tuesday: `[ ] 深入创作和实践
[ ] 学习新的技法或工具
[ ] 创意思维训练`,
                    wednesday: `[ ] 创作进度检查
[ ] 作品修改和完善
[ ] 与其他创作者交流`,
                    thursday: `[ ] 创意作品完善
[ ] 技能练习和提升
[ ] 创意分享和展示`,
                    friday: `[ ] 本周创作成果整理
[ ] 创意经验总结
[ ] 下周创作规划`,
                    saturday: `[ ] 艺术欣赏和学习
[ ] 创意工作坊或活动
[ ] 灵感收集和整理`,
                    sunday: `[ ] 创意周回顾
[ ] 作品集整理
[ ] 创作方向思考`,
                    reflection: `创意生活反思：
• 本周创作成果和进步
• 创意灵感的来源和激发
• 技能提升和表达改进
• 创作方向和目标调整`
                }
            },
            minimal: {
                name: "✨ 简约高效周",
                description: "简洁专注，适合忙碌节奏的模板",
                data: {
                    goals: `本周重点目标：
• 专注完成最重要的任务
• 保持简洁高效的节奏
• 避免过度复杂的安排`,
                    monday: `[ ] 确定本周最重要任务
[ ] 简化工作流程`,
                    tuesday: `[ ] 专注核心工作
[ ] 保持高效节奏`,
                    wednesday: `[ ] 检查进度和调整
[ ] 继续重点任务`,
                    thursday: `[ ] 推进关键项目
[ ] 处理重要事务`,
                    friday: `[ ] 完成本周目标
[ ] 简要总结和规划`,
                    saturday: `[ ] 个人时间和休息
[ ] 简单的放松活动`,
                    sunday: `[ ] 周回顾和下周准备
[ ] 保持简洁的计划`,
                    reflection: `简约周反思：
• 重要任务完成情况
• 效率和专注度评估
• 简化的效果和体验`
                }
            }
        };

        // 显示周计划模板选择器
        function showWeekTemplateSelector() {
            const templateList = Object.keys(weekTemplates).map(key => {
                const template = weekTemplates[key];
                return `
                    <div class="template-card" onclick="selectWeekTemplate('${key}')" style="
                        border: 2px solid #e0e0e0;
                        border-radius: 12px;
                        padding: 16px;
                        margin-bottom: 12px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        background: white;
                    " onmouseover="this.style.borderColor='var(--theme-color)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                        <h4 style="margin: 0 0 8px 0; color: var(--theme-color); font-size: 1.1em;">${template.name}</h4>
                        <p style="margin: 0; color: #666; font-size: 0.9em; line-height: 1.4;">${template.description}</p>
                    </div>
                `;
            }).join('');

            const content = `
                <div style="max-height: 500px; overflow-y: auto;">
                    <p style="margin-bottom: 20px; color: #666; text-align: center;">选择一个适合您的周计划模板，快速开始制定计划</p>
                    ${templateList}
                    <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <button class="btn-main" onclick="ModalUtils.hide(document.querySelector('.modal-mask'))" style="background: #666;">取消</button>
                    </div>
                </div>
            `;

            ModalUtils.show('选择周计划模板', content, 'large');
        }

        // 选择并应用周计划模板
        function selectWeekTemplate(templateKey) {
            const template = weekTemplates[templateKey];
            if (!template) {
                MessageUtils.error('模板不存在！');
                return;
            }

            // 确认对话框
            const confirmContent = `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 3em; margin-bottom: 16px;">⚠️</div>
                    <h3 style="margin: 0 0 16px 0; color: #f44336;">确认应用模板</h3>
                    <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">
                        应用模板 <strong style="color: var(--theme-color);">${template.name}</strong> 将会覆盖当前页面的所有内容。
                        <br>请确保您已经保存了重要的内容。
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="btn-main" onclick="applyWeekTemplate('${templateKey}')" style="background: #f44336;">确认应用</button>
                        <button class="btn-main" onclick="ModalUtils.hide(document.querySelector('.modal-mask'))" style="background: #666;">取消</button>
                    </div>
                </div>
            `;

            ModalUtils.show('确认应用模板', confirmContent, 'medium');
        }

        // 应用周计划模板到页面
        function applyWeekTemplate(templateKey) {
            const template = weekTemplates[templateKey];
            if (!template) return;

            // 关闭模态框
            const modal = document.querySelector('.modal-mask');
            if (modal) ModalUtils.hide(modal);

            // 应用模板内容
            const goalsTextarea = document.getElementById('week_goals');
            const reflectionTextarea = document.getElementById('week_reflection');
            
            if (goalsTextarea) goalsTextarea.value = template.data.goals;
            if (reflectionTextarea) reflectionTextarea.value = template.data.reflection;

            // 应用每日任务模板
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            days.forEach(day => {
                if (template.data[day]) {
                    applyWeekTemplateToTodoContainer(`${day}_tasks`, template.data[day]);
                }
            });

            // 显示成功消息
            MessageUtils.success(`已成功应用模板：${template.name}`);

            // 自动保存（如果有保存功能）
            setTimeout(() => {
                const saveBtn = document.querySelector('.save-btn[data-type="week"]');
                if (saveBtn) saveBtn.click();
            }, 500);
        }

        // 将模板内容应用到待办事项容器
        function applyWeekTemplateToTodoContainer(containerId, content) {
            const container = document.getElementById(containerId);
            if (container && content) {
                container.textContent = content;
                // 使用周计划特定的待办事项工具
                if (window.WeekPlanTodoUtils) {
                    WeekPlanTodoUtils.renderTodos(container);
                } else if (window.TodoUtils) {
                    TodoUtils.renderTodos(container);
                }
            }
        }

        // 周计划AI建议系统
        const WeekPlanAISuggestions = {
            // 不同类型的建议模板
            suggestionTemplates: {
                work: {
                    name: "💼 工作聚焦",
                    goals: [
                        "完成当前项目的关键里程碑",
                        "提升工作效率和质量标准", 
                        "优化团队协作和沟通流程",
                        "学习新技能增强核心竞争力",
                        "建立更好的工作与生活平衡"
                    ],
                    dailyTasks: {
                        monday: ["制定本周详细工作计划", "处理优先级最高的任务", "团队会议和项目同步"],
                        tuesday: ["推进核心项目开发", "完成重要文档整理", "客户沟通和需求确认"],
                        wednesday: ["项目中期检查和调整", "技能学习和知识更新", "工作流程优化"],
                        thursday: ["完成项目关键节点", "质量检查和测试", "团队协作和反馈"],
                        friday: ["项目收尾和总结", "下周计划准备", "工作成果整理"],
                        weekend: ["工作技能提升", "行业趋势学习", "适度放松充电"]
                    }
                },
                study: {
                    name: "📚 学习成长",
                    goals: [
                        "掌握一项新的核心技能",
                        "完成重要的学习项目或课程",
                        "建立系统化的知识体系",
                        "提升学习效率和方法",
                        "将理论知识转化为实践能力"
                    ],
                    dailyTasks: {
                        monday: ["制定本周学习计划", "开始新课程学习", "整理学习资料"],
                        tuesday: ["深入学习核心概念", "完成练习和作业", "记录学习笔记"],
                        wednesday: ["难点问题研究", "与同学老师交流", "学习进度检查"],
                        thursday: ["实践应用所学知识", "完成项目作业", "参加学习讨论"],
                        friday: ["学习成果总结", "知识点复习巩固", "下周学习规划"],
                        weekend: ["拓展阅读研究", "学习方法优化", "知识体系梳理"]
                    }
                },
                health: {
                    name: "🏃‍♂️ 健康生活", 
                    goals: [
                        "建立规律的运动锻炼习惯",
                        "保持健康的饮食和作息",
                        "有效管理压力和情绪",
                        "提升整体身心健康水平",
                        "创造积极向上的生活方式"
                    ],
                    dailyTasks: {
                        monday: ["制定健康生活计划", "晨练或运动30分钟", "健康饮食准备"],
                        tuesday: ["继续运动锻炼", "营养均衡搭配", "压力管理练习"],
                        wednesday: ["运动计划调整", "健康体检咨询", "冥想或瑜伽"],
                        thursday: ["坚持运动习惯", "健康知识学习", "社交活动参与"],
                        friday: ["健康周总结", "周末活动计划", "身心状态评估"],
                        weekend: ["户外运动活动", "健康美食制作", "充分休息恢复"]
                    }
                },
                balanced: {
                    name: "⚖️ 平衡发展",
                    goals: [
                        "在工作和生活之间找到平衡",
                        "培养多元化的兴趣爱好",
                        "维护重要的人际关系",
                        "持续个人成长和学习",
                        "保持身心健康和活力"
                    ],
                    dailyTasks: {
                        monday: ["制定平衡发展计划", "工作任务规划", "个人时间安排"],
                        tuesday: ["专注工作执行", "技能学习充电", "朋友家人联系"],
                        wednesday: ["工作进度检查", "兴趣爱好时间", "健康运动安排"],
                        thursday: ["任务完成冲刺", "社交活动参与", "个人反思时间"],
                        friday: ["工作总结整理", "周末计划安排", "放松娱乐时间"],
                        weekend: ["兴趣爱好发展", "家庭朋友聚会", "休息充电恢复"]
                    }
                },
                creative: {
                    name: "🎨 创意灵感",
                    goals: [
                        "完成一个有意义的创意作品",
                        "探索新的创作形式和技法",
                        "培养敏锐的创意思维",
                        "建立创作灵感收集系统",
                        "与创意社群建立连接"
                    ],
                    dailyTasks: {
                        monday: ["创意项目规划", "灵感素材收集", "创作工具准备"],
                        tuesday: ["深度创作时间", "技法练习提升", "创意思维训练"],
                        wednesday: ["作品修改完善", "创作经验总结", "同行交流学习"],
                        thursday: ["创意实验尝试", "作品展示分享", "反馈收集整理"],
                        friday: ["本周创作总结", "下周创意规划", "成果整理展示"],
                        weekend: ["艺术欣赏学习", "创意工作坊", "灵感放松时间"]
                    }
                }
            },

            /**
             * 显示AI建议选择器
             */
            showAISuggestionSelector: function() {
                const suggestions = Object.keys(this.suggestionTemplates).map(key => {
                    const template = this.suggestionTemplates[key];
                    return `
                        <div class="suggestion-card" onclick="WeekPlanAISuggestions.applySuggestion('${key}')" style="
                            border: 2px solid #e0e0e0;
                            border-radius: 12px;
                            padding: 16px;
                            margin-bottom: 12px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,249,250,1));
                        " onmouseover="this.style.borderColor='#7b1fa2'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(123,31,162,0.15)';" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <h4 style="margin: 0 0 8px 0; color: #7b1fa2; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                                ${template.name}
                            </h4>
                            <div style="display: grid; gap: 4px; font-size: 0.85em; color: #666;">
                                ${template.goals.slice(0, 3).map(goal => `<div style="display: flex; align-items: center; gap: 6px;"><span style="color: #7b1fa2;">•</span>${goal}</div>`).join('')}
                                ${template.goals.length > 3 ? `<div style="color: #999; font-style: italic;">还有 ${template.goals.length - 3} 个建议...</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                const content = `
                    <div style="max-height: 500px; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 2em; margin-bottom: 8px;">🤖</div>
                            <h3 style="margin: 0 0 8px 0; color: #7b1fa2;">AI 智能建议</h3>
                            <p style="margin: 0; color: #666; font-size: 0.9em;">根据不同的生活重点为您推荐本周目标和日程安排</p>
                        </div>
                        ${suggestions}
                        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                            <button class="btn-main" onclick="WeekPlanAISuggestions.generateCustomSuggestion()" style="background: linear-gradient(135deg, #7b1fa2, #9c27b0); margin-right: 12px;">🎯 个性化建议</button>
                            <button class="btn-main" onclick="ModalUtils.hide(document.querySelector('.modal-mask'))" style="background: #666;">取消</button>
                        </div>
                    </div>
                `;

                if (typeof ModalUtils !== 'undefined') {
                    ModalUtils.show('AI 智能建议系统', content, 'large');
                } else {
                    alert('AI建议功能需要模态框组件支持，请确保相关脚本已加载。');
                }
            },

            /**
             * 应用AI建议
             */
            applySuggestion: function(templateKey) {
                const template = this.suggestionTemplates[templateKey];
                if (!template) {
                    if (typeof MessageUtils !== 'undefined') {
                        MessageUtils.error('建议模板不存在！');
                    }
                    return;
                }

                // 确认对话框
                const confirmContent = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 3em; margin-bottom: 16px;">🤖</div>
                        <h3 style="margin: 0 0 16px 0; color: #7b1fa2;">应用 AI 建议</h3>
                        <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #7b1fa2;">${template.name}</h4>
                            <div style="text-align: left; font-size: 0.9em; color: #666;">
                                <strong>本周目标预览：</strong>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    ${template.goals.slice(0, 3).map(goal => `<li>${goal}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">
                            此操作将会：<br>
                            • 设置本周核心目标<br>
                            • 为每天安排相应的重点任务<br>
                            • 覆盖当前的计划内容
                        </p>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button class="btn-main" onclick="WeekPlanAISuggestions.confirmApplySuggestion('${templateKey}')" style="background: #7b1fa2;">✨ 应用建议</button>
                            <button class="btn-main" onclick="ModalUtils.hide(document.querySelector('.modal-mask'))" style="background: #666;">取消</button>
                        </div>
                    </div>
                `;

                if (typeof ModalUtils !== 'undefined') {
                    ModalUtils.show('确认应用 AI 建议', confirmContent, 'medium');
                }
            },

            /**
             * 确认应用建议
             */
            confirmApplySuggestion: function(templateKey) {
                const template = this.suggestionTemplates[templateKey];
                if (!template) return;

                // 关闭模态框
                const modal = document.querySelector('.modal-mask');
                if (modal && typeof ModalUtils !== 'undefined') {
                    ModalUtils.hide(modal);
                }

                // 应用目标建议
                const goalsTextarea = document.getElementById('week_goals');
                if (goalsTextarea) {
                    const goalsText = template.goals.map(goal => `• ${goal}`).join('\n');
                    goalsTextarea.value = `本周核心目标：\n${goalsText}`;
                }

                // 应用每日任务建议
                const dayMapping = {
                    monday: 'monday_tasks',
                    tuesday: 'tuesday_tasks', 
                    wednesday: 'wednesday_tasks',
                    thursday: 'thursday_tasks',
                    friday: 'friday_tasks',
                    weekend: 'weekend_plan'
                };

                Object.keys(dayMapping).forEach(day => {
                    const containerId = dayMapping[day];
                    const container = document.getElementById(containerId);
                    if (container && template.dailyTasks[day]) {
                        const tasksText = template.dailyTasks[day].map(task => `[ ] ${task}`).join('\n');
                        container.textContent = tasksText;
                        
                        // 重新渲染任务
                        if (window.WeekPlanTodoUtils) {
                            WeekPlanTodoUtils.renderTodos(container);
                        }
                    }
                });

                // 显示成功消息
                if (typeof MessageUtils !== 'undefined') {
                    MessageUtils.success(`✨ 已成功应用 ${template.name} 建议！`, 'success', 3000);
                }

                // 自动保存
                setTimeout(() => {
                    const saveBtn = document.querySelector('.save-btn[data-type="week"]');
                    if (saveBtn) {
                        saveBtn.click();
                    }
                }, 1000);
            },

            /**
             * 生成个性化建议
             */
            generateCustomSuggestion: function() {
                const customContent = `
                    <div style="max-height: 500px; overflow-y: auto; padding: 0 20px;">
                        <div style="text-align: center; margin-bottom: 24px;">
                            <div style="font-size: 2.5em; margin-bottom: 8px;">🎯</div>
                            <h3 style="margin: 0 0 8px 0; color: #7b1fa2;">个性化 AI 建议</h3>
                            <p style="margin: 0; color: #666; font-size: 0.9em;">告诉我您的情况，为您量身定制本周计划</p>
                        </div>
                        
                        <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #333;">请选择您本周的主要关注点：</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" name="focus" value="work" style="margin: 0;">
                                    <span>💼 工作项目</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" name="focus" value="study" style="margin: 0;">
                                    <span>📚 学习成长</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" name="focus" value="health" style="margin: 0;">
                                    <span>🏃‍♂️ 健康管理</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" name="focus" value="social" style="margin: 0;">
                                    <span>👥 人际社交</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" name="focus" value="creative" style="margin: 0;">
                                    <span>🎨 创意创作</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" name="focus" value="finance" style="margin: 0;">
                                    <span>💰 财务规划</span>
                                </label>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #333;">您的时间投入偏好：</h4>
                            <div style="display: grid; gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="timeStyle" value="intensive" style="margin: 0;">
                                    <span>🔥 高强度集中式（每天2-3个重点任务）</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="timeStyle" value="balanced" style="margin: 0;" checked>
                                    <span>⚖️ 平衡分配式（工作、生活、个人均衡）</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="timeStyle" value="flexible" style="margin: 0;">
                                    <span>🌊 灵活适应式（根据每天情况调整）</span>
                                </label>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #333;">补充说明（可选）：</h4>
                            <textarea id="customRequirements" placeholder="例如：这周有重要考试、需要完成项目交付、想要开始新的锻炼计划等..." style="width: 100%; min-height: 80px; border: 1px solid #ddd; border-radius: 6px; padding: 8px; font-size: 0.9em; resize: vertical;"></textarea>
                        </div>

                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn-main" onclick="WeekPlanAISuggestions.generatePersonalizedPlan()" style="background: linear-gradient(135deg, #7b1fa2, #9c27b0); margin-right: 12px;">🎯 生成个性化计划</button>
                            <button class="btn-main" onclick="ModalUtils.hide(document.querySelector('.modal-mask'))" style="background: #666;">取消</button>
                        </div>
                    </div>
                `;

                if (typeof ModalUtils !== 'undefined') {
                    ModalUtils.show('个性化 AI 建议', customContent, 'large');
                }
            },

            /**
             * 生成个性化计划
             */
            generatePersonalizedPlan: function() {
                // 获取用户选择
                const focusAreas = Array.from(document.querySelectorAll('input[name="focus"]:checked')).map(cb => cb.value);
                const timeStyle = document.querySelector('input[name="timeStyle"]:checked')?.value || 'balanced';
                const customRequirements = document.getElementById('customRequirements')?.value || '';

                if (focusAreas.length === 0) {
                    if (typeof MessageUtils !== 'undefined') {
                        MessageUtils.warning('请至少选择一个关注点！');
                    }
                    return;
                }

                // 生成个性化建议
                const personalizedPlan = this.createPersonalizedPlan(focusAreas, timeStyle, customRequirements);
                
                // 关闭当前模态框
                const modal = document.querySelector('.modal-mask');
                if (modal && typeof ModalUtils !== 'undefined') {
                    ModalUtils.hide(modal);
                }

                // 应用个性化计划
                this.applyPersonalizedPlan(personalizedPlan);
            },

            /**
             * 创建个性化计划
             */
            createPersonalizedPlan: function(focusAreas, timeStyle, customRequirements) {
                const focusAreaGoals = {
                    work: ["完成重要工作项目节点", "提升工作效率和质量", "优化工作流程"],
                    study: ["掌握新知识或技能", "完成学习目标", "总结学习成果"],
                    health: ["建立健康生活习惯", "保持规律运动", "改善饮食和作息"],
                    social: ["维护重要人际关系", "参与社交活动", "扩展社交圈"],
                    creative: ["完成创意作品", "探索新的表达方式", "激发创意灵感"],
                    finance: ["制定财务计划", "优化支出结构", "增加收入来源"]
                };

                const focusAreaTasks = {
                    work: ["处理优先级任务", "团队协作会议", "项目进度检查", "技能提升学习"],
                    study: ["专注学习时间", "练习和复习", "知识整理总结", "学习成果分享"],
                    health: ["晨练或运动", "健康饮食准备", "充足睡眠", "压力管理"],
                    social: ["朋友聚会", "家人时间", "社区活动", "网络社交"],
                    creative: ["创作时间", "灵感收集", "作品修改", "创意分享"],
                    finance: ["账目整理", "投资研究", "预算规划", "理财学习"]
                };

                // 生成个性化目标
                const goals = [];
                focusAreas.forEach(area => {
                    const areaGoals = focusAreaGoals[area] || [];
                    goals.push(...areaGoals.slice(0, Math.ceil(5 / focusAreas.length)));
                });

                // 根据时间风格调整任务强度
                const taskIntensity = {
                    intensive: 3,
                    balanced: 4,
                    flexible: 5
                };

                const dailyTaskCount = taskIntensity[timeStyle] || 4;

                // 生成每日任务
                const dailyTasks = {};
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'weekend'];
                
                days.forEach(day => {
                    dailyTasks[day] = [];
                    const isWeekend = day === 'weekend';
                    
                    focusAreas.forEach(area => {
                        const areaTasks = focusAreaTasks[area] || [];
                        const taskCount = Math.max(1, Math.floor(dailyTaskCount / focusAreas.length));
                        
                        if (isWeekend && (area === 'work')) {
                            // 周末减少工作任务，增加个人时间
                            dailyTasks[day].push(...areaTasks.slice(0, Math.max(1, taskCount - 1)));
                        } else {
                            dailyTasks[day].push(...areaTasks.slice(0, taskCount));
                        }
                    });
                });

                return {
                    name: `🎯 个性化计划 (${focusAreas.length}个重点领域)`,
                    goals: goals,
                    dailyTasks: dailyTasks,
                    focusAreas: focusAreas,
                    timeStyle: timeStyle,
                    customRequirements: customRequirements
                };
            },

            /**
             * 应用个性化计划
             */
            applyPersonalizedPlan: function(plan) {
                // 应用目标
                const goalsTextarea = document.getElementById('week_goals');
                if (goalsTextarea) {
                    let goalsText = '个性化本周目标：\n';
                    goalsText += plan.goals.map(goal => `• ${goal}`).join('\n');
                    
                    if (plan.customRequirements) {
                        goalsText += '\n\n特别关注：\n• ' + plan.customRequirements;
                    }
                    
                    goalsTextarea.value = goalsText;
                }

                // 应用每日任务
                const dayMapping = {
                    monday: 'monday_tasks',
                    tuesday: 'tuesday_tasks',
                    wednesday: 'wednesday_tasks', 
                    thursday: 'thursday_tasks',
                    friday: 'friday_tasks',
                    weekend: 'weekend_plan'
                };

                Object.keys(dayMapping).forEach(day => {
                    const containerId = dayMapping[day];
                    const container = document.getElementById(containerId);
                    if (container && plan.dailyTasks[day]) {
                        const tasksText = plan.dailyTasks[day].map(task => `[ ] ${task}`).join('\n');
                        container.textContent = tasksText;
                        
                        // 重新渲染任务
                        if (window.WeekPlanTodoUtils) {
                            WeekPlanTodoUtils.renderTodos(container);
                        }
                    }
                });

                // 显示成功消息
                if (typeof MessageUtils !== 'undefined') {
                    MessageUtils.success(`🎯 个性化计划已生成！专注于 ${plan.focusAreas.length} 个核心领域`, 'success', 3000);
                }

                // 自动保存
                setTimeout(() => {
                    const saveBtn = document.querySelector('.save-btn[data-type="week"]');
                    if (saveBtn) {
                        saveBtn.click();
                    }
                }, 1000);
            }
        };

        // 暴露到全局作用域以便其他脚本使用
        window.WeekPlanTodoUtils = WeekPlanTodoUtils;
        window.WeekPlanKeyboardUtils = WeekPlanKeyboardUtils;
        window.WeekPlanAISuggestions = WeekPlanAISuggestions;
    </script>

    <!-- 任务编辑相关的CSS样式增强 -->
    <style>
        .task-text {
            /* 基本样式 */
            border: none !important;
            outline: none !important;
            background: transparent !important;
            width: 100% !important;
            max-width: 100% !important; /* 确保不超出容器 */
            resize: none !important; /* 禁止手动调整大小 */
            overflow-y: hidden !important; /* 只隐藏垂直滚动条 */
            overflow-x: hidden !important; /* 隐藏水平滚动条 */
            box-sizing: border-box !important; /* 包含padding和border在内的宽度计算 */
            
            /* 字体和布局 */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Microsoft YaHei', 'SimSun', sans-serif !important;
            font-size: inherit !important;
            color: inherit !important;
            line-height: 1.4 !important;
            padding: 4px 0 !important;
            margin: 0 !important;
            min-height: 1.4em !important;
            
            /* 强制换行设置 */
            word-wrap: break-word !important;
            word-break: break-all !important; /* 强制在任何字符处换行 */
            white-space: pre-wrap !important;
            overflow-wrap: break-word !important; /* 现代浏览器的换行属性 */
            
            /* 确保输入法正常工作 */
            ime-mode: auto !important;
            -webkit-ime-mode: auto !important;
            -ms-ime-mode: auto !important;
        }
        
        .task-text:focus {
            outline: 2px solid var(--theme-color) !important;
            background: rgba(25, 118, 210, 0.05) !important;
        }
        
        .task-delete-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            border-radius: 6px;
            padding: 6px 8px;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            color: #ff6b6b;
        }
        
        .task-delete-btn:hover {
            background: rgba(255, 107, 107, 0.1) !important;
            transform: scale(1.1) !important;
            opacity: 1 !important;
            color: #ff4757 !important;
        }
        
        .task-item:hover .task-delete-btn {
            opacity: 0.7;
        }
        
        /* 任务容器布局优化 */
        .task-item {
            width: 100% !important;
            margin-bottom: 8px !important;
        }
        
        .task-content {
            width: 100% !important;
            display: flex !important;
            align-items: flex-start !important;
            gap: 8px !important;
            flex-wrap: nowrap !important;
        }
        
        /* 确保checkbox固定宽度 */
        .custom-checkbox {
            flex-shrink: 0 !important;
            margin-top: 2px !important; /* 与文本第一行对齐 */
        }
        
        /* 确保删除按钮固定宽度 */
        .task-delete-btn {
            flex-shrink: 0 !important;
            margin-top: 2px !important; /* 与文本第一行对齐 */
        }
        
        /* 结转任务按钮增强 */
        #carry-over-btn:hover {
            background: #ffcc02 !important;
            color: #d84315 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(239, 108, 0, 0.2) !important;
        }
        
        #carry-over-btn:active {
            transform: translateY(0) !important;
            box-shadow: 0 2px 4px rgba(239, 108, 0, 0.2) !important;
        }
        
        /* AI规划按钮增强 */
        #next-week-ai-btn:hover {
            background: #4caf50 !important;
            color: #fff !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(0, 121, 107, 0.2) !important;
        }
        
        #next-week-ai-btn:active {
            transform: translateY(0) !important;
            box-shadow: 0 2px 4px rgba(0, 121, 107, 0.2) !important;
        }
        
        /* 占位符样式增强 - 与日计划保持一致 */
        .todo-list-container:empty,
        .todo-list-container:has(.todo-placeholder) {
            min-height: 80px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .todo-placeholder {
            width: 100% !important;
            text-align: center !important;
            font-size: 0.9em !important;
            color: #666 !important;
            background: rgba(255, 255, 255, 0.9) !important;
            padding: 20px !important;
            border-radius: 8px !important;
            border: 2px dashed #ddd !important;
            transition: all 0.3s ease !important;
            margin: 4px 0 !important;
        }
        
        .todo-placeholder:hover {
            background: rgba(25, 118, 210, 0.05) !important;
            border-color: var(--theme-color) !important;
            color: var(--theme-color) !important;
            transform: scale(1.02) !important;
            cursor: pointer !important;
        }
        
        /* 键盘导航样式 */
        .todo-placeholder:focus {
            outline: 2px solid var(--theme-color) !important;
            background: rgba(25, 118, 210, 0.1) !important;
            color: var(--theme-color) !important;
        }
        
        /* 改善todo容器的焦点样式 */
        .todo-list-container:focus-within {
            border-color: var(--theme-color) !important;
            box-shadow: 0 0 0 3px var(--theme-color-shadow), 0 4px 12px rgba(0, 0, 0, 0.1) !important;
            transform: translateY(-2px) !important;
        }
    </style>
    
    <!-- 同步服务 -->
    <script src="sync-service.js"></script>
    <script src="sync-providers.js"></script>
    <!-- 通用自动同步功能 -->
    <script src="universal-auto-sync.js"></script>
    <!-- 全自动后台同步 -->
    <script src="auto-background-sync.js"></script>
    <script src="add-ai-to-all-pages.js"></script>
    <script src="ai-fix-universal.js"></script>  <!-- AI分析功能修复 -->
</body>

</html>
