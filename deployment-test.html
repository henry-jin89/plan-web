<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨ç½²æµ‹è¯• - è®¡åˆ’ç®¡ç†å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #ccc;
        }

        .status-item.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .status-item.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .status-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .status-item.loading {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .status-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .status-content {
            flex: 1;
        }

        .status-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-detail {
            font-size: 14px;
            color: #666;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-group {
            margin-top: 20px;
        }

        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .info-box strong {
            color: #004085;
        }

        .code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ§ª éƒ¨ç½²æµ‹è¯•é¢æ¿</h1>
            <p style="color: #666; margin-bottom: 20px;">æ£€æŸ¥ WebSocket æœåŠ¡å™¨å’Œå‰ç«¯é…ç½®æ˜¯å¦æ­£ç¡®</p>

            <div class="info-box">
                <strong>ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                1. ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®<br>
                2. ç­‰å¾…æ‰€æœ‰æµ‹è¯•å®Œæˆ<br>
                3. æ£€æŸ¥æ˜¯å¦æœ‰çº¢è‰²é”™è¯¯é¡¹<br>
                4. å¦‚æœå…¨éƒ¨é€šè¿‡ï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼
            </div>
        </div>

        <div class="card">
            <h2>ğŸ” é…ç½®ä¿¡æ¯</h2>
            <div id="config-info"></div>
        </div>

        <div class="card">
            <h2>âœ… æµ‹è¯•ç»“æœ</h2>
            <div id="test-results"></div>
            
            <div class="btn-group">
                <button class="btn" onclick="runTests()">ğŸš€ å¼€å§‹æµ‹è¯•</button>
                <button class="btn" onclick="location.reload()">ğŸ”„ åˆ·æ–°é¡µé¢</button>
                <button class="btn" onclick="clearStorage()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“Š å®æ—¶æ—¥å¿—</h2>
            <div id="console-log" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px;"></div>
        </div>

        <div class="timestamp">
            æœ€åæ›´æ–°: <span id="timestamp"></span>
        </div>
    </div>

    <!-- Socket.IO å®¢æˆ·ç«¯ -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    
    <!-- WebSocket é…ç½® -->
    <script src="websocket-config.js"></script>

    <script>
        let testResults = [];
        let consoleLog = [];

        // æ‹¦æˆª console.log
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ');
            consoleLog.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            updateConsoleLog();
        };

        function updateTimestamp() {
            document.getElementById('timestamp').textContent = new Date().toLocaleString('zh-CN');
        }

        function updateConsoleLog() {
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML = consoleLog.slice(-50).join('<br>');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showConfigInfo() {
            const serverUrl = localStorage.getItem('websocket_server_url') || 'http://localhost:3000';
            const userId = localStorage.getItem('websocket_userId') || 'æœªç”Ÿæˆ';
            const sharedUserId = localStorage.getItem('sharedUserId') || 'æœªè®¾ç½®';
            
            const html = `
                <div class="status-item">
                    <span class="status-icon">ğŸ”§</span>
                    <div class="status-content">
                        <div class="status-title">WebSocket æœåŠ¡å™¨åœ°å€</div>
                        <div class="status-detail"><span class="code">${serverUrl}</span></div>
                    </div>
                </div>
                <div class="status-item">
                    <span class="status-icon">ğŸ‘¤</span>
                    <div class="status-content">
                        <div class="status-title">ç”¨æˆ· ID</div>
                        <div class="status-detail"><span class="code">${userId}</span></div>
                    </div>
                </div>
                <div class="status-item">
                    <span class="status-icon">ğŸ”—</span>
                    <div class="status-content">
                        <div class="status-title">å…±äº«ç”¨æˆ· ID</div>
                        <div class="status-detail"><span class="code">${sharedUserId}</span></div>
                    </div>
                </div>
            `;
            
            document.getElementById('config-info').innerHTML = html;
        }

        function addResult(icon, title, detail, status) {
            testResults.push({ icon, title, detail, status });
            updateResults();
        }

        function updateResults() {
            const html = testResults.map(r => `
                <div class="status-item ${r.status}">
                    <span class="status-icon">${r.icon}</span>
                    <div class="status-content">
                        <div class="status-title">${r.title}</div>
                        <div class="status-detail">${r.detail}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('test-results').innerHTML = html || '<p style="color: #999;">ç‚¹å‡»"å¼€å§‹æµ‹è¯•"è¿è¡Œæ£€æŸ¥</p>';
        }

        async function runTests() {
            testResults = [];
            consoleLog = [];
            updateResults();
            
            console.log('ğŸš€ å¼€å§‹è¿è¡Œéƒ¨ç½²æµ‹è¯•...');
            
            // æµ‹è¯• 1: æ£€æŸ¥é…ç½®æ–‡ä»¶
            addResult('ğŸ”„', 'æ£€æŸ¥é…ç½®æ–‡ä»¶', 'æ­£åœ¨æ£€æŸ¥...', 'loading');
            await sleep(500);
            
            const serverUrl = localStorage.getItem('websocket_server_url') || window.WEBSOCKET_CONFIG?.serverUrl || 'http://localhost:3000';
            
            if (serverUrl === 'http://localhost:3000') {
                testResults[testResults.length - 1] = {
                    icon: 'âš ï¸',
                    title: 'é…ç½®æ–‡ä»¶æ£€æŸ¥',
                    detail: 'å½“å‰ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨åœ°å€ï¼Œå»ºè®®é…ç½® Render æœåŠ¡å™¨åœ°å€',
                    status: 'warning'
                };
            } else if (serverUrl.includes('.onrender.com')) {
                testResults[testResults.length - 1] = {
                    icon: 'âœ…',
                    title: 'é…ç½®æ–‡ä»¶æ£€æŸ¥',
                    detail: `å·²é…ç½® Render æœåŠ¡å™¨: ${serverUrl}`,
                    status: 'success'
                };
            } else {
                testResults[testResults.length - 1] = {
                    icon: 'âœ…',
                    title: 'é…ç½®æ–‡ä»¶æ£€æŸ¥',
                    detail: `å·²é…ç½®æœåŠ¡å™¨: ${serverUrl}`,
                    status: 'success'
                };
            }
            updateResults();
            
            // æµ‹è¯• 2: æ£€æŸ¥ Socket.IO åº“
            addResult('ğŸ”„', 'æ£€æŸ¥ Socket.IO åº“', 'æ­£åœ¨æ£€æŸ¥...', 'loading');
            await sleep(500);
            
            if (window.io) {
                testResults[testResults.length - 1] = {
                    icon: 'âœ…',
                    title: 'Socket.IO åº“',
                    detail: 'Socket.IO å®¢æˆ·ç«¯å·²åŠ è½½',
                    status: 'success'
                };
            } else {
                testResults[testResults.length - 1] = {
                    icon: 'âŒ',
                    title: 'Socket.IO åº“',
                    detail: 'Socket.IO å®¢æˆ·ç«¯æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
                    status: 'error'
                };
            }
            updateResults();
            
            // æµ‹è¯• 3: æµ‹è¯•æœåŠ¡å™¨è¿æ¥ï¼ˆHTTPï¼‰
            addResult('ğŸ”„', 'æµ‹è¯•æœåŠ¡å™¨ HTTP ç«¯ç‚¹', 'æ­£åœ¨è¿æ¥...', 'loading');
            
            try {
                const response = await fetch(`${serverUrl}/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    testResults[testResults.length - 1] = {
                        icon: 'âœ…',
                        title: 'æœåŠ¡å™¨å¥åº·æ£€æŸ¥',
                        detail: `æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ | è¿æ¥æ•°: ${data.connections} | ç”¨æˆ·æ•°: ${data.users}`,
                        status: 'success'
                    };
                } else {
                    testResults[testResults.length - 1] = {
                        icon: 'âš ï¸',
                        title: 'æœåŠ¡å™¨å¥åº·æ£€æŸ¥',
                        detail: 'æœåŠ¡å™¨å“åº”å¼‚å¸¸',
                        status: 'warning'
                    };
                }
            } catch (error) {
                testResults[testResults.length - 1] = {
                    icon: 'âŒ',
                    title: 'æœåŠ¡å™¨å¥åº·æ£€æŸ¥',
                    detail: `æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ${error.message}`,
                    status: 'error'
                };
            }
            updateResults();
            
            // æµ‹è¯• 4: æµ‹è¯• WebSocket è¿æ¥
            addResult('ğŸ”„', 'æµ‹è¯• WebSocket è¿æ¥', 'æ­£åœ¨è¿æ¥...', 'loading');
            
            try {
                const socket = io(serverUrl, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000
                });
                
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        socket.disconnect();
                        reject(new Error('è¿æ¥è¶…æ—¶'));
                    }, 10000);
                    
                    socket.on('connect', () => {
                        clearTimeout(timeout);
                        testResults[testResults.length - 1] = {
                            icon: 'âœ…',
                            title: 'WebSocket è¿æ¥',
                            detail: `è¿æ¥æˆåŠŸ | Socket ID: ${socket.id}`,
                            status: 'success'
                        };
                        updateResults();
                        
                        // æµ‹è¯•è®¾å¤‡æ³¨å†Œ
                        addResult('ğŸ”„', 'æµ‹è¯•è®¾å¤‡æ³¨å†Œ', 'æ­£åœ¨æ³¨å†Œ...', 'loading');
                        
                        socket.on('registered', (response) => {
                            if (response.success) {
                                testResults[testResults.length - 1] = {
                                    icon: 'âœ…',
                                    title: 'è®¾å¤‡æ³¨å†Œ',
                                    detail: `æ³¨å†ŒæˆåŠŸ | ç”¨æˆ·: ${response.userId}`,
                                    status: 'success'
                                };
                            } else {
                                testResults[testResults.length - 1] = {
                                    icon: 'âŒ',
                                    title: 'è®¾å¤‡æ³¨å†Œ',
                                    detail: 'æ³¨å†Œå¤±è´¥',
                                    status: 'error'
                                };
                            }
                            updateResults();
                            socket.disconnect();
                            resolve();
                        });
                        
                        const userId = 'test_' + Date.now();
                        socket.emit('register', {
                            userId: userId,
                            deviceInfo: { type: 'test', userAgent: navigator.userAgent }
                        });
                    });
                    
                    socket.on('connect_error', (error) => {
                        clearTimeout(timeout);
                        testResults[testResults.length - 1] = {
                            icon: 'âŒ',
                            title: 'WebSocket è¿æ¥',
                            detail: `è¿æ¥å¤±è´¥: ${error.message}`,
                            status: 'error'
                        };
                        updateResults();
                        reject(error);
                    });
                });
            } catch (error) {
                console.error('WebSocket æµ‹è¯•å¤±è´¥:', error);
            }
            
            // æµ‹è¯•å®Œæˆ
            console.log('âœ… æµ‹è¯•å®Œæˆï¼');
            
            const successCount = testResults.filter(r => r.status === 'success').length;
            const totalCount = testResults.length;
            
            if (successCount === totalCount) {
                addResult('ğŸ‰', 'éƒ¨ç½²æµ‹è¯•å®Œæˆ', `æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼(${successCount}/${totalCount})`, 'success');
            } else {
                addResult('âš ï¸', 'éƒ¨ç½²æµ‹è¯•å®Œæˆ', `é€šè¿‡ ${successCount}/${totalCount} é¡¹æµ‹è¯•ï¼Œè¯·æ£€æŸ¥å¤±è´¥é¡¹`, 'warning');
            }
        }

        function clearStorage() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿè¿™ä¼šæ¸…é™¤ç”¨æˆ·IDå’Œæ‰€æœ‰é…ç½®ã€‚')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('âœ… å·²æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®');
                location.reload();
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // åˆå§‹åŒ–
        updateTimestamp();
        showConfigInfo();
        setInterval(updateTimestamp, 1000);
    </script>
</body>
</html>

