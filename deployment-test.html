<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部署测试 - 计划管理器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #ccc;
        }

        .status-item.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .status-item.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .status-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .status-item.loading {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .status-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .status-content {
            flex: 1;
        }

        .status-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-detail {
            font-size: 14px;
            color: #666;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-group {
            margin-top: 20px;
        }

        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .info-box strong {
            color: #004085;
        }

        .code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>🧪 部署测试面板</h1>
            <p style="color: #666; margin-bottom: 20px;">检查 WebSocket 服务器和前端配置是否正确</p>

            <div class="info-box">
                <strong>📋 使用说明：</strong><br>
                1. 点击"开始测试"按钮<br>
                2. 等待所有测试完成<br>
                3. 检查是否有红色错误项<br>
                4. 如果全部通过，说明部署成功！
            </div>
        </div>

        <div class="card">
            <h2>🔍 配置信息</h2>
            <div id="config-info"></div>
        </div>

        <div class="card">
            <h2>✅ 测试结果</h2>
            <div id="test-results"></div>
            
            <div class="btn-group">
                <button class="btn" onclick="runTests()">🚀 开始测试</button>
                <button class="btn" onclick="location.reload()">🔄 刷新页面</button>
                <button class="btn" onclick="clearStorage()">🗑️ 清除缓存</button>
            </div>
        </div>

        <div class="card">
            <h2>📊 实时日志</h2>
            <div id="console-log" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px;"></div>
        </div>

        <div class="timestamp">
            最后更新: <span id="timestamp"></span>
        </div>
    </div>

    <!-- Socket.IO 客户端 -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    
    <!-- WebSocket 配置 -->
    <script src="websocket-config.js"></script>

    <script>
        let testResults = [];
        let consoleLog = [];

        // 拦截 console.log
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ');
            consoleLog.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            updateConsoleLog();
        };

        function updateTimestamp() {
            document.getElementById('timestamp').textContent = new Date().toLocaleString('zh-CN');
        }

        function updateConsoleLog() {
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML = consoleLog.slice(-50).join('<br>');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showConfigInfo() {
            const serverUrl = localStorage.getItem('websocket_server_url') || 'http://localhost:3000';
            const userId = localStorage.getItem('websocket_userId') || '未生成';
            const sharedUserId = localStorage.getItem('sharedUserId') || '未设置';
            
            const html = `
                <div class="status-item">
                    <span class="status-icon">🔧</span>
                    <div class="status-content">
                        <div class="status-title">WebSocket 服务器地址</div>
                        <div class="status-detail"><span class="code">${serverUrl}</span></div>
                    </div>
                </div>
                <div class="status-item">
                    <span class="status-icon">👤</span>
                    <div class="status-content">
                        <div class="status-title">用户 ID</div>
                        <div class="status-detail"><span class="code">${userId}</span></div>
                    </div>
                </div>
                <div class="status-item">
                    <span class="status-icon">🔗</span>
                    <div class="status-content">
                        <div class="status-title">共享用户 ID</div>
                        <div class="status-detail"><span class="code">${sharedUserId}</span></div>
                    </div>
                </div>
            `;
            
            document.getElementById('config-info').innerHTML = html;
        }

        function addResult(icon, title, detail, status) {
            testResults.push({ icon, title, detail, status });
            updateResults();
        }

        function updateResults() {
            const html = testResults.map(r => `
                <div class="status-item ${r.status}">
                    <span class="status-icon">${r.icon}</span>
                    <div class="status-content">
                        <div class="status-title">${r.title}</div>
                        <div class="status-detail">${r.detail}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('test-results').innerHTML = html || '<p style="color: #999;">点击"开始测试"运行检查</p>';
        }

        async function runTests() {
            testResults = [];
            consoleLog = [];
            updateResults();
            
            console.log('🚀 开始运行部署测试...');
            
            // 测试 1: 检查配置文件
            addResult('🔄', '检查配置文件', '正在检查...', 'loading');
            await sleep(500);
            
            const serverUrl = localStorage.getItem('websocket_server_url') || window.WEBSOCKET_CONFIG?.serverUrl || 'http://localhost:3000';
            
            if (serverUrl === 'http://localhost:3000') {
                testResults[testResults.length - 1] = {
                    icon: '⚠️',
                    title: '配置文件检查',
                    detail: '当前使用本地服务器地址，建议配置 Render 服务器地址',
                    status: 'warning'
                };
            } else if (serverUrl.includes('.onrender.com')) {
                testResults[testResults.length - 1] = {
                    icon: '✅',
                    title: '配置文件检查',
                    detail: `已配置 Render 服务器: ${serverUrl}`,
                    status: 'success'
                };
            } else {
                testResults[testResults.length - 1] = {
                    icon: '✅',
                    title: '配置文件检查',
                    detail: `已配置服务器: ${serverUrl}`,
                    status: 'success'
                };
            }
            updateResults();
            
            // 测试 2: 检查 Socket.IO 库
            addResult('🔄', '检查 Socket.IO 库', '正在检查...', 'loading');
            await sleep(500);
            
            if (window.io) {
                testResults[testResults.length - 1] = {
                    icon: '✅',
                    title: 'Socket.IO 库',
                    detail: 'Socket.IO 客户端已加载',
                    status: 'success'
                };
            } else {
                testResults[testResults.length - 1] = {
                    icon: '❌',
                    title: 'Socket.IO 库',
                    detail: 'Socket.IO 客户端未找到，请检查网络连接',
                    status: 'error'
                };
            }
            updateResults();
            
            // 测试 3: 测试服务器连接（HTTP）
            addResult('🔄', '测试服务器 HTTP 端点', '正在连接...', 'loading');
            
            try {
                const response = await fetch(`${serverUrl}/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    testResults[testResults.length - 1] = {
                        icon: '✅',
                        title: '服务器健康检查',
                        detail: `服务器正常运行 | 连接数: ${data.connections} | 用户数: ${data.users}`,
                        status: 'success'
                    };
                } else {
                    testResults[testResults.length - 1] = {
                        icon: '⚠️',
                        title: '服务器健康检查',
                        detail: '服务器响应异常',
                        status: 'warning'
                    };
                }
            } catch (error) {
                testResults[testResults.length - 1] = {
                    icon: '❌',
                    title: '服务器健康检查',
                    detail: `无法连接到服务器: ${error.message}`,
                    status: 'error'
                };
            }
            updateResults();
            
            // 测试 4: 测试 WebSocket 连接
            addResult('🔄', '测试 WebSocket 连接', '正在连接...', 'loading');
            
            try {
                const socket = io(serverUrl, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000
                });
                
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        socket.disconnect();
                        reject(new Error('连接超时'));
                    }, 10000);
                    
                    socket.on('connect', () => {
                        clearTimeout(timeout);
                        testResults[testResults.length - 1] = {
                            icon: '✅',
                            title: 'WebSocket 连接',
                            detail: `连接成功 | Socket ID: ${socket.id}`,
                            status: 'success'
                        };
                        updateResults();
                        
                        // 测试设备注册
                        addResult('🔄', '测试设备注册', '正在注册...', 'loading');
                        
                        socket.on('registered', (response) => {
                            if (response.success) {
                                testResults[testResults.length - 1] = {
                                    icon: '✅',
                                    title: '设备注册',
                                    detail: `注册成功 | 用户: ${response.userId}`,
                                    status: 'success'
                                };
                            } else {
                                testResults[testResults.length - 1] = {
                                    icon: '❌',
                                    title: '设备注册',
                                    detail: '注册失败',
                                    status: 'error'
                                };
                            }
                            updateResults();
                            socket.disconnect();
                            resolve();
                        });
                        
                        const userId = 'test_' + Date.now();
                        socket.emit('register', {
                            userId: userId,
                            deviceInfo: { type: 'test', userAgent: navigator.userAgent }
                        });
                    });
                    
                    socket.on('connect_error', (error) => {
                        clearTimeout(timeout);
                        testResults[testResults.length - 1] = {
                            icon: '❌',
                            title: 'WebSocket 连接',
                            detail: `连接失败: ${error.message}`,
                            status: 'error'
                        };
                        updateResults();
                        reject(error);
                    });
                });
            } catch (error) {
                console.error('WebSocket 测试失败:', error);
            }
            
            // 测试完成
            console.log('✅ 测试完成！');
            
            const successCount = testResults.filter(r => r.status === 'success').length;
            const totalCount = testResults.length;
            
            if (successCount === totalCount) {
                addResult('🎉', '部署测试完成', `所有测试通过！(${successCount}/${totalCount})`, 'success');
            } else {
                addResult('⚠️', '部署测试完成', `通过 ${successCount}/${totalCount} 项测试，请检查失败项`, 'warning');
            }
        }

        function clearStorage() {
            if (confirm('确定要清除所有本地数据吗？这会清除用户ID和所有配置。')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('✅ 已清除所有缓存数据');
                location.reload();
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // 初始化
        updateTimestamp();
        showConfigInfo();
        setInterval(updateTimestamp, 1000);
    </script>
</body>
</html>

