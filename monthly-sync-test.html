<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆåº¦æ—¥ç¨‹åŒæ­¥æµ‹è¯•</title>
    
    <!-- å¿…éœ€çš„è„šæœ¬ - æŒ‰æ­£ç¡®é¡ºåºåŠ è½½ -->
    <script src="config.js"></script>
    <script src="firebase-config.js"></script>
    <script src="sync-fix.js"></script>
    <script src="leancloud-config.js"></script>
    <script src="leancloud-sync.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #e8f5e8; color: #2e7d32; border: 2px solid #4caf50; }
        .error { background: #ffebee; color: #c62828; border: 2px solid #f44336; }
        .warning { background: #fff3e0; color: #ef6c00; border: 2px solid #ff9800; }
        .info { background: #e3f2fd; color: #1976d2; border: 2px solid #2196f3; }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
        }
        
        .sync-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“±ğŸ’» æœˆåº¦æ—¥ç¨‹è·¨è®¾å¤‡åŒæ­¥æµ‹è¯•</h1>
        
        <div id="sync-status" class="status info">
            ğŸ”„ æ­£åœ¨æ£€æŸ¥åŒæ­¥æœåŠ¡çŠ¶æ€...
        </div>
        
        <div class="test-section">
            <h2>ğŸ” ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h2>
            <button class="btn-primary" onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
            <button class="btn-primary" onclick="checkSyncService()">æ£€æŸ¥åŒæ­¥æœåŠ¡</button>
            <button class="btn-primary" onclick="checkDataKeys()">æ£€æŸ¥æ•°æ®é”®</button>
            
            <div id="system-status"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ’¾ æ•°æ®æ“ä½œæµ‹è¯•</h2>
            <button class="btn-success" onclick="saveTestData()">ä¿å­˜æµ‹è¯•æ•°æ®</button>
            <button class="btn-success" onclick="triggerSync()">æ‰‹åŠ¨åŒæ­¥</button>
            <button class="btn-danger" onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
            
            <div class="sync-stats">
                <div class="stat-card">
                    <div class="stat-number" id="local-events">0</div>
                    <div class="stat-label">æœ¬åœ°äº‹ä»¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="cloud-events">0</div>
                    <div class="stat-label">äº‘ç«¯äº‹ä»¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="last-sync">æœªåŒæ­¥</div>
                    <div class="stat-label">æœ€ååŒæ­¥</div>
                </div>
            </div>
            
            <h3>ğŸ“‹ å½“å‰æ•°æ®çŠ¶æ€</h3>
            <div id="data-display" class="data-display">ç‚¹å‡»"æ£€æŸ¥æ•°æ®é”®"æŸ¥çœ‹æ•°æ®çŠ¶æ€</div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”§ é—®é¢˜ä¿®å¤å·¥å…·</h2>
            <button class="btn-primary" onclick="autoFix()">ä¸€é”®è‡ªåŠ¨ä¿®å¤</button>
            <button class="btn-primary" onclick="reinitSync()">é‡æ–°åˆå§‹åŒ–åŒæ­¥</button>
            <button class="btn-success" onclick="forceRestore()">å¼ºåˆ¶äº‘ç«¯æ¢å¤</button>
            
            <div id="fix-results"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“± æµ‹è¯•è¯´æ˜</h2>
            <p><strong>æµ‹è¯•æ­¥éª¤ï¼š</strong></p>
            <ol>
                <li><strong>æ£€æŸ¥çŠ¶æ€</strong>ï¼šç‚¹å‡»"æ£€æŸ¥ç³»ç»ŸçŠ¶æ€"ç¡®è®¤æ‰€æœ‰æœåŠ¡æ­£å¸¸</li>
                <li><strong>ä¿å­˜æ•°æ®</strong>ï¼šç‚¹å‡»"ä¿å­˜æµ‹è¯•æ•°æ®"æ·»åŠ æµ‹è¯•äº‹ä»¶</li>
                <li><strong>è·¨è®¾å¤‡éªŒè¯</strong>ï¼šåœ¨å¦ä¸€è®¾å¤‡æ‰“å¼€æ­¤é¡µé¢ï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦åŒæ­¥</li>
                <li><strong>åŒå‘æµ‹è¯•</strong>ï¼šåœ¨ä¸¤ä¸ªè®¾å¤‡åˆ†åˆ«ä¿å­˜æ•°æ®ï¼ŒéªŒè¯åŒå‘åŒæ­¥</li>
            </ol>
            
            <p><strong>é¢„æœŸç»“æœï¼š</strong></p>
            <ul>
                <li>âœ… åŒæ­¥æœåŠ¡çŠ¶æ€ï¼šå·²å¯ç”¨</li>
                <li>âœ… ä¿å­˜åç«‹å³åŒæ­¥åˆ°äº‘ç«¯</li>
                <li>âœ… å…¶ä»–è®¾å¤‡èƒ½çœ‹åˆ°æœ€æ–°æ•°æ®</li>
                <li>âœ… æ•°æ®ä¿®æ”¹æ—¶é—´æˆ³æ­£ç¡®æ›´æ–°</li>
            </ul>
        </div>
    </div>
    
    <script>
        let testData = {};
        
        // ç­‰å¾…åŒæ­¥æœåŠ¡åŠ è½½
        function waitForSyncService(callback) {
            let attempts = 0;
            const maxAttempts = 20;
            
            function check() {
                attempts++;
                if (window.syncService) {
                    callback(true);
                } else if (attempts < maxAttempts) {
                    setTimeout(check, 500);
                } else {
                    callback(false);
                }
            }
            check();
        }
        
        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus() {
            const statusDiv = document.getElementById('sync-status');
            
            if (!window.syncService) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ åŒæ­¥æœåŠ¡æœªåŠ è½½';
                return;
            }
            
            const status = window.syncService.getSyncStatus();
            if (status.enabled && status.online) {
                statusDiv.className = 'status success';
                statusDiv.textContent = 'âœ… åŒæ­¥æœåŠ¡æ­£å¸¸ - å·²å¯ç”¨å¹¶åœ¨çº¿';
            } else if (status.enabled) {
                statusDiv.className = 'status warning';
                statusDiv.textContent = 'âš ï¸ åŒæ­¥æœåŠ¡å·²å¯ç”¨ä½†ç¦»çº¿';
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ åŒæ­¥æœåŠ¡æœªå¯ç”¨';
            }
        }
        
        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        function checkSystemStatus() {
            const resultDiv = document.getElementById('system-status');
            let report = [];
            
            // æ£€æŸ¥ localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                report.push('âœ… localStorage å¯ç”¨');
            } catch (e) {
                report.push('âŒ localStorage ä¸å¯ç”¨: ' + e.message);
            }
            
            // æ£€æŸ¥ç½‘ç»œ
            report.push(navigator.onLine ? 'âœ… ç½‘ç»œè¿æ¥æ­£å¸¸' : 'âŒ ç½‘ç»œè¿æ¥å¼‚å¸¸');
            
            // æ£€æŸ¥åŒæ­¥æœåŠ¡
            if (window.syncService) {
                const status = window.syncService.getSyncStatus();
                report.push('âœ… åŒæ­¥æœåŠ¡å·²åŠ è½½');
                report.push(`ğŸ“Š åŒæ­¥çŠ¶æ€: ${status.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}`);
                report.push(`ğŸŒ åœ¨çº¿çŠ¶æ€: ${status.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}`);
            } else {
                report.push('âŒ åŒæ­¥æœåŠ¡æœªåŠ è½½');
            }
            
            // æ£€æŸ¥ LeanCloud é…ç½®
            report.push(window.leancloudConfig ? 'âœ… LeanCloud é…ç½®å·²åŠ è½½' : 'âŒ LeanCloud é…ç½®ç¼ºå¤±');
            
            resultDiv.innerHTML = `<div class="data-display">${report.join('\n')}</div>`;
        }
        
        // æ£€æŸ¥åŒæ­¥æœåŠ¡
        function checkSyncService() {
            if (!window.syncService) {
                alert('âŒ åŒæ­¥æœåŠ¡æœªåŠ è½½');
                return;
            }
            
            try {
                const status = window.syncService.getSyncStatus();
                const info = [
                    `å¯ç”¨çŠ¶æ€: ${status.enabled}`,
                    `åœ¨çº¿çŠ¶æ€: ${status.online}`,
                    `æœ€ååŒæ­¥: ${status.lastSync || 'ä»æœªåŒæ­¥'}`,
                    `é”™è¯¯ä¿¡æ¯: ${status.error || 'æ— '}`
                ];
                
                alert('ğŸ“Š åŒæ­¥æœåŠ¡çŠ¶æ€:\n\n' + info.join('\n'));
            } catch (error) {
                alert('âŒ æ£€æŸ¥åŒæ­¥æœåŠ¡å¤±è´¥: ' + error.message);
            }
        }
        
        // æ£€æŸ¥æ•°æ®é”®
        function checkDataKeys() {
            const keys = ['monthlyEvents', 'planData_monthlyEvents'];
            let report = [];
            
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        const eventCount = Object.keys(parsed).length;
                        report.push(`ğŸ“‹ ${key}: ${eventCount} ä¸ªæ—¥æœŸçš„æ•°æ®`);
                    } catch (e) {
                        report.push(`âŒ ${key}: æ•°æ®æ ¼å¼é”™è¯¯`);
                    }
                } else {
                    report.push(`ğŸ’¡ ${key}: æ— æ•°æ®`);
                }
            });
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            
            document.getElementById('data-display').textContent = report.join('\n');
        }
        
        // ä¿å­˜æµ‹è¯•æ•°æ®
        function saveTestData() {
            const today = new Date().toISOString().split('T')[0];
            const testEvent = {
                title: `æµ‹è¯•äº‹ä»¶ ${new Date().toLocaleTimeString()}`,
                time: new Date().toTimeString().split(' ')[0].substring(0, 5),
                category: 'work',
                description: 'è·¨è®¾å¤‡åŒæ­¥æµ‹è¯•äº‹ä»¶',
                createdAt: new Date().toISOString()
            };
            
            // è·å–ç°æœ‰æ•°æ®
            const existing = JSON.parse(localStorage.getItem('monthlyEvents') || '{}');
            if (!existing[today]) {
                existing[today] = [];
            }
            existing[today].push(testEvent);
            
            // ä¿å­˜åˆ°æœ¬åœ°å’Œäº‘åŒæ­¥é”®
            const jsonString = JSON.stringify(existing);
            localStorage.setItem('monthlyEvents', jsonString);
            localStorage.setItem('planData_monthlyEvents', jsonString);
            
            alert('âœ… æµ‹è¯•æ•°æ®å·²ä¿å­˜ï¼\n\näº‹ä»¶: ' + testEvent.title + '\næ—¶é—´: ' + testEvent.time);
            updateStats();
        }
        
        // æ‰‹åŠ¨è§¦å‘åŒæ­¥
        async function triggerSync() {
            if (!window.syncService) {
                alert('âŒ åŒæ­¥æœåŠ¡æœªåŠ è½½');
                return;
            }
            
            try {
                await window.syncService.manualSync();
                alert('âœ… æ‰‹åŠ¨åŒæ­¥å®Œæˆï¼');
                updateStats();
            } catch (error) {
                alert('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¸…é™¤æµ‹è¯•æ•°æ®
        function clearTestData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) {
                localStorage.removeItem('monthlyEvents');
                localStorage.removeItem('planData_monthlyEvents');
                alert('âœ… æµ‹è¯•æ•°æ®å·²æ¸…é™¤');
                updateStats();
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const localData = localStorage.getItem('monthlyEvents');
            const cloudData = localStorage.getItem('planData_monthlyEvents');
            
            let localCount = 0, cloudCount = 0;
            
            if (localData) {
                try {
                    const parsed = JSON.parse(localData);
                    localCount = Object.values(parsed).reduce((sum, events) => sum + events.length, 0);
                } catch (e) {
                    localCount = 'é”™è¯¯';
                }
            }
            
            if (cloudData) {
                try {
                    const parsed = JSON.parse(cloudData);
                    cloudCount = Object.values(parsed).reduce((sum, events) => sum + events.length, 0);
                } catch (e) {
                    cloudCount = 'é”™è¯¯';
                }
            }
            
            document.getElementById('local-events').textContent = localCount;
            document.getElementById('cloud-events').textContent = cloudCount;
            
            const lastSync = localStorage.getItem('leancloud_last_sync');
            if (lastSync) {
                const date = new Date(lastSync);
                document.getElementById('last-sync').textContent = date.toLocaleTimeString();
            }
        }
        
        // è‡ªåŠ¨ä¿®å¤
        function autoFix() {
            if (window.SyncFixer) {
                const success = window.SyncFixer.diagnosSync();
                document.getElementById('fix-results').innerHTML = 
                    `<div class="status ${success ? 'success' : 'error'}">
                        ${success ? 'âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆ' : 'âŒ ä¿®å¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°'}
                    </div>`;
            } else {
                document.getElementById('fix-results').innerHTML = 
                    '<div class="status error">âŒ ä¿®å¤å·¥å…·æœªåŠ è½½</div>';
            }
        }
        
        // é‡æ–°åˆå§‹åŒ–åŒæ­¥
        function reinitSync() {
            if (window.SyncFixer) {
                window.SyncFixer.reinitializeSync();
                setTimeout(updateSyncStatus, 1000);
            }
        }
        
        // å¼ºåˆ¶äº‘ç«¯æ¢å¤
        async function forceRestore() {
            if (!window.syncService) {
                alert('âŒ åŒæ­¥æœåŠ¡æœªåŠ è½½');
                return;
            }
            
            if (confirm('ç¡®å®šè¦ä»äº‘ç«¯å¼ºåˆ¶æ¢å¤æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–æœ¬åœ°æ•°æ®ã€‚')) {
                try {
                    if (window.syncService.restoreFromCloud) {
                        await window.syncService.restoreFromCloud(true);
                    } else {
                        await window.syncService.manualSync();
                    }
                    alert('âœ… äº‘ç«¯æ¢å¤å®Œæˆï¼');
                    updateStats();
                } catch (error) {
                    alert('âŒ äº‘ç«¯æ¢å¤å¤±è´¥: ' + error.message);
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            waitForSyncService((loaded) => {
                if (loaded) {
                    console.log('âœ… åŒæ­¥æœåŠ¡å·²åŠ è½½');
                    updateSyncStatus();
                    updateStats();
                } else {
                    console.warn('âš ï¸ åŒæ­¥æœåŠ¡åŠ è½½è¶…æ—¶');
                    updateSyncStatus();
                }
            });
        });
        
        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(updateStats, 5000);
    </script>
</body>
</html>
