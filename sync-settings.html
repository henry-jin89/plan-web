<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script src="config.js"></script>
    <script src="backup-helper.js"></script>
    
    <!-- Firebaseé…ç½® -->
    <script src="firebase-config.js"></script>
    
    <!-- åŒæ­¥ä¿®å¤å·¥å…· -->
    <script src="sync-fix.js"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°æ®åŒæ­¥è®¾ç½® - è®¡åˆ’ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .sync-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .sync-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e3f2fd;
        }

        .sync-header h1 {
            color: #1976d2;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .sync-status.connected {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        .sync-status.disconnected {
            background: #ffeaa7;
            color: #d68910;
            border: 1px solid #f39c12;
        }

        .sync-status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: currentColor;
        }

        .provider-selection {
            margin-bottom: 30px;
        }

        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .provider-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .provider-card:hover {
            border-color: #1976d2;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.15);
        }

        .provider-card.selected {
            border-color: #1976d2;
            background: #e3f2fd;
        }

        .provider-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .provider-icon.github { background: #333; }
        .provider-icon.drive { background: #4285f4; }
        .provider-icon.server { background: #ff9800; }
        .provider-icon.webrtc { background: #9c27b0; }

        .provider-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1rem;
        }

        .provider-card p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .provider-pros {
            margin-top: 10px;
        }

        .provider-pros span {
            display: inline-block;
            background: #e8f5e8;
            color: #2e7d32;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin: 2px 4px 2px 0;
        }

        .sync-config {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }

        .sync-config.active {
            display: block;
        }

        .config-field {
            margin-bottom: 20px;
        }

        .config-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .config-field input,
        .config-field select,
        .config-field textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .config-field input:focus,
        .config-field select:focus,
        .config-field textarea:focus {
            outline: none;
            border-color: #1976d2;
        }

        .config-help {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }

        .config-help a {
            color: #1976d2;
            text-decoration: none;
        }

        .config-help a:hover {
            text-decoration: underline;
        }

        .sync-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .sync-log {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.success { color: #2e7d32; }
        .log-entry.error { color: #c62828; }
        .log-entry.warning { color: #f57c00; }
        .log-entry.info { color: #1976d2; }

        .advanced-settings {
            margin-top: 20px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .advanced-toggle {
            cursor: pointer;
            color: #1976d2;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .advanced-content {
            display: none;
        }

        .advanced-content.open {
            display: block;
        }

        @media (max-width: 768px) {
            .sync-container {
                margin: 10px;
                padding: 15px;
            }
            
            .provider-grid {
                grid-template-columns: 1fr;
            }
            
            .sync-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="sync-container">
        <div class="sync-header">
            <h1>ğŸ“±ğŸ’» æ•°æ®åŒæ­¥è®¾ç½®</h1>
            <p>è®©æ‚¨çš„è®¡åˆ’åœ¨æ‰€æœ‰è®¾å¤‡ä¹‹é—´ä¿æŒåŒæ­¥</p>
        </div>

        <div id="sync-status" class="sync-status disconnected">
            <div class="status-indicator"></div>
            <span>åŒæ­¥æœªå¯ç”¨</span>
        </div>

        <div class="provider-selection">
            <h2>é€‰æ‹©åŒæ­¥æ–¹å¼</h2>
            <p>é€‰æ‹©æœ€é€‚åˆæ‚¨éœ€æ±‚çš„æ•°æ®åŒæ­¥æ–¹å¼ï¼š</p>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“±ğŸ’» è·¨è®¾å¤‡åŒæ­¥è¯´æ˜</h4>
                <p style="margin: 0; font-size: 14px; color: #333; line-height: 1.5;">
                    <strong>é‡è¦ï¼š</strong>æ‰€æœ‰è®¾å¤‡ï¼ˆç”µè„‘ã€æ‰‹æœºã€å¹³æ¿ï¼‰å¿…é¡»ä½¿ç”¨ç›¸åŒçš„åŒæ­¥é…ç½®æ‰èƒ½ä¿æŒæ•°æ®åŒæ­¥ã€‚
                    é…ç½®å®Œæˆåï¼Œæ‰‹æœºç«¯å°†è‡ªåŠ¨åœ¨é¡µé¢åˆ‡æ¢ã€ç½‘ç»œæ¢å¤æ—¶åŒæ­¥æœ€æ–°æ•°æ®ã€‚
                    <br><br>
                    <strong>æ¨èï¼š</strong>GitHubåŒæ­¥å…è´¹å¯é ï¼ŒGoogle Driveç®€å•æ˜“ç”¨ï¼Œè”æƒ³ä¸ªäººäº‘ç§æœ‰å®‰å…¨ã€‚
                </p>
            </div>
            
            <div class="provider-grid">
                <div class="provider-card" data-provider="github">
                    <div class="provider-icon github">ğŸ“±</div>
                    <h3>GitHub åŒæ­¥</h3>
                    <p>ä½¿ç”¨GitHubä»“åº“å­˜å‚¨æ•°æ®ï¼Œå…è´¹ä¸”å¯é ã€‚</p>
                    <div class="provider-pros">
                        <span>å…è´¹</span>
                        <span>å¯é </span>
                        <span>ç‰ˆæœ¬æ§åˆ¶</span>
                    </div>
                </div>

                <div class="provider-card" data-provider="drive">
                    <div class="provider-icon drive">â˜ï¸</div>
                    <h3>Google Drive</h3>
                    <p>ä½¿ç”¨Google Driveäº‘å­˜å‚¨ï¼Œç®€å•æ˜“ç”¨ã€‚</p>
                    <div class="provider-pros">
                        <span>ç®€å•</span>
                        <span>15GBå…è´¹</span>
                        <span>å¿«é€Ÿ</span>
                    </div>
                </div>

                <div class="provider-card" data-provider="server">
                    <div class="provider-icon server">ğŸ–¥ï¸</div>
                    <h3>è‡ªå»ºæœåŠ¡å™¨</h3>
                    <p>ä½¿ç”¨æ‚¨è‡ªå·±çš„æœåŠ¡å™¨ï¼Œå®Œå…¨æ§åˆ¶æ•°æ®ã€‚</p>
                    <div class="provider-pros">
                        <span>ç§æœ‰</span>
                        <span>å¯æ§</span>
                        <span>å®‰å…¨</span>
                    </div>
                </div>

                <div class="provider-card" data-provider="webrtc">
                    <div class="provider-icon webrtc">ğŸ”—</div>
                    <h3>è®¾å¤‡ç›´è¿</h3>
                    <p>è®¾å¤‡é—´ç›´æ¥åŒæ­¥ï¼Œæ— éœ€æœåŠ¡å™¨ã€‚</p>
                    <div class="provider-pros">
                        <span>å®æ—¶</span>
                        <span>æ— æœåŠ¡å™¨</span>
                        <span>å±€åŸŸç½‘</span>
                    </div>
                </div>

                <div class="provider-card" data-provider="lenovo">
                    <div class="provider-icon lenovo" style="background: #e60012;">ğŸ </div>
                    <h3>è”æƒ³ä¸ªäººäº‘</h3>
                    <p>ä½¿ç”¨æ‚¨çš„è”æƒ³å®¶åº­å­˜å‚¨ä½œä¸ºç§æœ‰åŒæ­¥æœåŠ¡å™¨ã€‚</p>
                    <div class="provider-pros">
                        <span>ç§æœ‰å®‰å…¨</span>
                        <span>é«˜é€Ÿç¨³å®š</span>
                        <span>æ— é™å®¹é‡</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- GitHub é…ç½® -->
        <div id="github-config" class="sync-config">
            <h3>GitHub åŒæ­¥é…ç½®</h3>
            <div class="config-field">
                <label for="github-token">Personal Access Token</label>
                <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <div class="config-help">
                    åœ¨ <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings â†’ Developer settings â†’ Personal access tokens</a> åˆ›å»ºï¼Œéœ€è¦ "repo" æƒé™ã€‚
                </div>
            </div>
            <div class="config-field">
                <label for="github-owner">ä»“åº“æ‰€æœ‰è€…</label>
                <input type="text" id="github-owner" placeholder="your-username">
                <div class="config-help">æ‚¨çš„GitHubç”¨æˆ·åæˆ–ç»„ç»‡å</div>
            </div>
            <div class="config-field">
                <label for="github-repo">ä»“åº“åç§°</label>
                <input type="text" id="github-repo" placeholder="plan-data">
                <div class="config-help">ç”¨äºå­˜å‚¨æ•°æ®çš„ä»“åº“åç§°ï¼ˆå»ºè®®åˆ›å»ºç§æœ‰ä»“åº“ï¼‰</div>
            </div>
            <div class="config-field">
                <label for="github-branch">åˆ†æ”¯åç§°</label>
                <input type="text" id="github-branch" value="main" placeholder="main">
                <div class="config-help">ç”¨äºå­˜å‚¨æ•°æ®çš„åˆ†æ”¯ï¼Œé»˜è®¤ä¸º main</div>
            </div>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">âš ï¸ å¸¸è§é—®é¢˜æ’æŸ¥</h4>
                <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #333;">
                    <li><strong>Tokenæƒé™</strong>ï¼šéœ€è¦é€‰æ‹©"repo"æƒé™ï¼ˆç§æœ‰ä»“åº“ï¼‰æˆ–"public_repo"æƒé™ï¼ˆå…¬å¼€ä»“åº“ï¼‰</li>
                    <li><strong>ä»“åº“å­˜åœ¨</strong>ï¼šè¯·ç¡®ä¿ä»“åº“å·²åˆ›å»ºå¹¶ä¸”è´¦å·æœ‰è®¿é—®æƒé™</li>
                    <li><strong>ç½‘ç»œè®¿é—®</strong>ï¼šç¡®ä¿èƒ½æ­£å¸¸è®¿é—®GitHub.com</li>
                    <li><strong>HTTPSåè®®</strong>ï¼šå»ºè®®ä½¿ç”¨HTTPSè®¿é—®æœ¬åº”ç”¨ä»¥é¿å…CORSé—®é¢˜</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="button" class="btn btn-secondary" onclick="checkGitHubRepo()">
                    ğŸ” æ£€æŸ¥ä»“åº“
                </button>
                <button type="button" class="btn btn-secondary" onclick="createGitHubRepo()">
                    â• åˆ›å»ºä»“åº“
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetGitHubData()">
                    ğŸ”„ é‡ç½®æ•°æ®
                </button>
                <button type="button" class="btn btn-secondary" onclick="showGitHubHelp()">
                    ğŸ“š è®¾ç½®æ•™ç¨‹
                </button>
            </div>
        </div>

        <!-- Google Drive é…ç½® -->
        <div id="drive-config" class="sync-config">
            <h3>Google Drive åŒæ­¥é…ç½®</h3>
            <div class="config-field">
                <label for="drive-access-token">è®¿é—®ä»¤ç‰Œ</label>
                <input type="password" id="drive-access-token" placeholder="å°†é€šè¿‡OAuthè·å–">
                <div class="config-help">ç‚¹å‡»"è·å–æˆæƒ"æŒ‰é’®é€šè¿‡Google OAuthè·å–è®¿é—®ä»¤ç‰Œ</div>
            </div>
            <div class="config-field">
                <label for="drive-folder-id">æ–‡ä»¶å¤¹IDï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="drive-folder-id" placeholder="ç•™ç©ºå°†ä¿å­˜åˆ°æ ¹ç›®å½•">
                <div class="config-help">æŒ‡å®šGoogle Driveä¸­çš„æ–‡ä»¶å¤¹IDï¼Œç•™ç©ºå°†ä¿å­˜åˆ°æ ¹ç›®å½•</div>
            </div>
            <button type="button" class="btn btn-secondary" onclick="authenticateGoogleDrive()">
                è·å–Google Driveæˆæƒ
            </button>
        </div>

        <!-- è‡ªå»ºæœåŠ¡å™¨é…ç½® -->
        <div id="server-config" class="sync-config">
            <h3>è‡ªå»ºæœåŠ¡å™¨é…ç½®</h3>
            <div class="config-field">
                <label for="server-url">æœåŠ¡å™¨åœ°å€</label>
                <input type="url" id="server-url" placeholder="https://your-server.com/api/">
                <div class="config-help">æ‚¨çš„åŒæ­¥æœåŠ¡å™¨APIåœ°å€</div>
            </div>
            <div class="config-field">
                <label for="server-api-key">APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰</label>
                <input type="password" id="server-api-key" placeholder="your-api-key">
                <div class="config-help">æœåŠ¡å™¨è¦æ±‚çš„APIå¯†é’¥</div>
            </div>
            <div class="config-field">
                <label for="server-user-id">ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="server-user-id" placeholder="your-user-id">
                <div class="config-help">å¤šç”¨æˆ·ç¯å¢ƒä¸‹çš„ç”¨æˆ·æ ‡è¯†</div>
            </div>
        </div>

        <!-- WebRTC é…ç½® -->
        <div id="webrtc-config" class="sync-config">
            <h3>è®¾å¤‡ç›´è¿é…ç½®</h3>
            <div class="config-field">
                <label for="webrtc-room-id">æˆ¿é—´ID</label>
                <input type="text" id="webrtc-room-id" placeholder="my-sync-room">
                <div class="config-help">ç”¨äºè¿æ¥è®¾å¤‡çš„æˆ¿é—´æ ‡è¯†ï¼Œåœ¨æ‰€æœ‰è®¾å¤‡ä¸Šä½¿ç”¨ç›¸åŒçš„æˆ¿é—´ID</div>
            </div>
            <div class="config-field">
                <label for="webrtc-role">è®¾å¤‡è§’è‰²</label>
                <select id="webrtc-role">
                    <option value="initiator">å‘èµ·è€…ï¼ˆç”µè„‘ï¼‰</option>
                    <option value="joiner">åŠ å…¥è€…ï¼ˆæ‰‹æœºï¼‰</option>
                </select>
                <div class="config-help">é€‰æ‹©è¿™å°è®¾å¤‡çš„è§’è‰²ï¼Œé€šå¸¸ç”µè„‘ä½œä¸ºå‘èµ·è€…ï¼Œæ‰‹æœºä½œä¸ºåŠ å…¥è€…</div>
            </div>
            <div class="config-field">
                <label for="webrtc-signal-url">ä¿¡ä»¤æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰</label>
                <input type="url" id="webrtc-signal-url" placeholder="wss://signal-server.com">
                <div class="config-help">è‡ªå®šä¹‰ä¿¡ä»¤æœåŠ¡å™¨åœ°å€ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤æœåŠ¡å™¨</div>
            </div>
        </div>

        <!-- è”æƒ³ä¸ªäººäº‘é…ç½® -->
        <div id="lenovo-config" class="sync-config">
            <h3>è”æƒ³ä¸ªäººäº‘é…ç½®</h3>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ  ä½¿ç”¨æ‚¨çš„è”æƒ³å®¶åº­å­˜å‚¨</h4>
                <p style="margin: 0; font-size: 14px; color: #333;">
                    å°†æ‚¨çš„è”æƒ³ä¸ªäººäº‘è®¾å¤‡ä½œä¸ºç§æœ‰åŒæ­¥æœåŠ¡å™¨ï¼Œäº«å—é«˜é€Ÿç¨³å®šçš„æ•°æ®åŒæ­¥ä½“éªŒã€‚
                    æ•°æ®å®Œå…¨æŒæ§åœ¨æ‚¨æ‰‹ä¸­ï¼Œæ— éœ€æ‹…å¿ƒéšç§æ³„éœ²ã€‚
                </p>
            </div>
            
            <div class="config-field">
                <label for="lenovo-url">WebDAVåœ°å€</label>
                <input type="url" id="lenovo-url" placeholder="http://192.168.1.100:5005" value="http://192.168.1.100:5005">
                <div class="config-help">
                    è”æƒ³ä¸ªäººäº‘çš„WebDAVè®¿é—®åœ°å€ã€‚é€šå¸¸æ˜¯è®¾å¤‡IP + ç«¯å£5005ã€‚
                    <br>ğŸ“ æŸ¥æ‰¾æ–¹æ³•ï¼šåœ¨è”æƒ³äº‘ç®¡ç†ç•Œé¢æŸ¥çœ‹è®¾å¤‡IPï¼Œç„¶ååŠ ä¸Š":5005"
                </div>
            </div>
            
            <div class="config-field">
                <label for="lenovo-username">ç”¨æˆ·å</label>
                <input type="text" id="lenovo-username" placeholder="planSync">
                <div class="config-help">
                    åœ¨è”æƒ³äº‘ä¸Šåˆ›å»ºçš„ä¸“ç”¨ç”¨æˆ·è´¦å·ã€‚å»ºè®®åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºåŒæ­¥çš„ç”¨æˆ·ã€‚
                    <br>ğŸ“ åˆ›å»ºæ–¹æ³•ï¼šè”æƒ³äº‘ç®¡ç†ç•Œé¢ â†’ ç”¨æˆ·ç®¡ç† â†’ æ·»åŠ ç”¨æˆ·
                </div>
            </div>
            
            <div class="config-field">
                <label for="lenovo-password">å¯†ç </label>
                <input type="password" id="lenovo-password" placeholder="ç”¨æˆ·å¯†ç ">
                <div class="config-help">å¯¹åº”ç”¨æˆ·çš„å¯†ç </div>
            </div>
            
            <div class="config-field">
                <label for="lenovo-timeout">è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰</label>
                <input type="number" id="lenovo-timeout" value="30" min="5" max="120">
                <div class="config-help">ç½‘ç»œè¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå»ºè®®ä¿æŒé»˜è®¤å€¼30ç§’</div>
            </div>
            
            <div class="config-field">
                <label>
                    <input type="checkbox" id="lenovo-backup" checked>
                    å¯ç”¨è‡ªåŠ¨å¤‡ä»½
                </label>
                <div class="config-help">ä¸Šä¼ æ–°æ•°æ®å‰è‡ªåŠ¨å¤‡ä»½ç°æœ‰æ•°æ®ï¼Œæä¾›é¢å¤–çš„æ•°æ®ä¿æŠ¤</div>
            </div>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">âš ï¸ è®¾ç½®å‰çš„å‡†å¤‡å·¥ä½œ</h4>
                <ol style="margin: 0; padding-left: 20px; font-size: 14px; color: #333;">
                    <li>ç¡®ä¿è”æƒ³ä¸ªäººäº‘è®¾å¤‡å·²å¼€æœºå¹¶è¿æ¥åˆ°ç½‘ç»œ</li>
                    <li>åœ¨è”æƒ³äº‘ç®¡ç†ç•Œé¢å¯ç”¨WebDAVæœåŠ¡</li>
                    <li>åˆ›å»ºä¸“ç”¨ç”¨æˆ·è´¦å·å¹¶è®¾ç½®å¯†ç </li>
                    <li>ç¡®è®¤è®¾å¤‡IPåœ°å€ï¼ˆé€šå¸¸åœ¨192.168.1.xç½‘æ®µï¼‰</li>
                    <li>æµ‹è¯•ç½‘ç»œè¿é€šæ€§ï¼ˆpingè®¾å¤‡IPåœ°å€ï¼‰</li>
                </ol>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="button" class="btn btn-secondary" onclick="detectLenovoCloud()">
                    ğŸ” è‡ªåŠ¨æ£€æµ‹è®¾å¤‡
                </button>
                <button type="button" class="btn btn-secondary" onclick="testLenovoConnection()">
                    ğŸ§ª æµ‹è¯•WebDAVè¿æ¥
                </button>
                <button type="button" class="btn btn-secondary" onclick="openLenovoHelp()">
                    ğŸ“š æŸ¥çœ‹è¯¦ç»†æ•™ç¨‹
                </button>
            </div>
        </div>

        <div class="advanced-settings">
            <div class="advanced-toggle" onclick="toggleAdvanced()">
                âš™ï¸ é«˜çº§è®¾ç½® <span id="advanced-arrow">â–¼</span>
            </div>
            <div class="advanced-content" id="advanced-content">
                <div class="config-field">
                    <label for="sync-interval">è‡ªåŠ¨åŒæ­¥é—´éš”ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="sync-interval" value="30" min="10" max="3600">
                    <div class="config-help">è‡ªåŠ¨åŒæ­¥çš„æ—¶é—´é—´éš”ï¼Œå»ºè®®30-300ç§’</div>
                </div>
                <div class="config-field">
                    <label>
                        <input type="checkbox" id="sync-on-change" checked>
                        æ•°æ®å˜æ›´æ—¶ç«‹å³åŒæ­¥
                    </label>
                    <div class="config-help">å½“æœ¬åœ°æ•°æ®å‘ç”Ÿå˜æ›´æ—¶è‡ªåŠ¨è§¦å‘åŒæ­¥</div>
                </div>
                <div class="config-field">
                    <label>
                        <input type="checkbox" id="conflict-manual" checked>
                        å†²çªæ—¶æ‰‹åŠ¨å¤„ç†
                    </label>
                    <div class="config-help">å½“å‘ç”Ÿæ•°æ®å†²çªæ—¶å¼¹çª—è®©ç”¨æˆ·é€‰æ‹©ï¼Œå¦åˆ™è‡ªåŠ¨ä½¿ç”¨æœ€æ–°æ•°æ®</div>
                </div>
            </div>
        </div>

        <div class="sync-actions">
            <button type="button" class="btn btn-secondary" onclick="testConnection()">
                æµ‹è¯•è¿æ¥
            </button>
            <button type="button" class="btn btn-primary" onclick="enableSync()">
                å¯ç”¨åŒæ­¥
            </button>
            <button type="button" class="btn btn-success" onclick="manualSync()" disabled>
                ç«‹å³åŒæ­¥
            </button>
            <button type="button" class="btn btn-danger" onclick="disableSync()" disabled>
                ç¦ç”¨åŒæ­¥
            </button>
            <button type="button" class="btn btn-secondary" onclick="forceReinitializeSync()">
                ğŸ”„ é‡æ–°åˆå§‹åŒ–
            </button>
            <button type="button" class="btn btn-secondary" onclick="forceEnableSync()">
                âš¡ å¼ºåˆ¶å¯ç”¨
            </button>
            <button type="button" class="btn btn-secondary" onclick="showCrossDeviceHelp()">
                ğŸ“±ğŸ’» è·¨è®¾å¤‡æŒ‡å—
            </button>
        </div>

        <div class="sync-log" id="sync-log">
            <div class="log-entry info">ç­‰å¾…é…ç½®åŒæ­¥è®¾ç½®...</div>
        </div>
    </div>

    
    <!-- é€šç”¨è‡ªåŠ¨åŒæ­¥åŠŸèƒ½ -->
    <script src="universal-auto-sync.js"></script>
    <!-- åŒæ­¥åˆå§‹åŒ–ä¿®å¤è„šæœ¬ -->
    <script src="fix-sync-initialization.js"></script>
    <!-- è·¨æµè§ˆå™¨æ•°æ®æ¢å¤è„šæœ¬ -->
    <script src="cross-browser-sync-recovery.js"></script>
    <script>
        let selectedProvider = null;
        let syncEnabled = false;
        let isInitialLoad = true;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            loadExistingConfig();
            setupDataChangeDetection();
            setupNetworkHandlers();
        });

        function initializePage() {
            // ç»‘å®šæä¾›å•†é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.provider-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectProvider(this.dataset.provider);
                });
            });

            // ç›‘å¬åŒæ­¥äº‹ä»¶
            window.addEventListener('sync-complete', function(event) {
                addLogEntry('åŒæ­¥å®Œæˆ: ' + event.detail.timestamp, 'success');
                updateSyncStatus();
            });

            window.addEventListener('data-updated', function(event) {
                addLogEntry('æ•°æ®å·²æ›´æ–°: ' + event.detail.timestamp, 'info');
                // æ•°æ®æ›´æ–°æ—¶ä½¿ç”¨é˜²æŠ–åŒæ­¥
                if (syncEnabled && document.getElementById('sync-on-change').checked) {
                    debounceSync();
                }
            });

            // ç›‘å¬å­˜å‚¨å˜åŒ–ï¼ˆå…¶ä»–æ ‡ç­¾é¡µçš„ä¿®æ”¹ï¼‰
            window.addEventListener('storage', function(event) {
                if (syncEnabled && event.key && event.key.startsWith('planData_')) {
                    addLogEntry('æ£€æµ‹åˆ°å…¶ä»–è®¾å¤‡æ•°æ®å˜åŒ–', 'info');
                    if (document.getElementById('sync-on-change').checked) {
                        debounceSync();
                    }
                }
            });
        }

        // è®¾ç½®æ•°æ®å˜åŒ–æ£€æµ‹
        function setupDataChangeDetection() {
            // ç›‘å¬localStorageå˜åŒ–çš„polyfill
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                const event = new CustomEvent('localStorageChange', {
                    detail: { key, value, oldValue: localStorage.getItem(key) }
                });
                window.dispatchEvent(event);
                originalSetItem.apply(this, arguments);
            };

            // ç›‘å¬æœ¬åœ°æ•°æ®å˜åŒ–
            window.addEventListener('localStorageChange', function(event) {
                if (syncEnabled && event.detail.key && event.detail.key.startsWith('planData_')) {
                    addLogEntry('æœ¬åœ°æ•°æ®å·²ä¿®æ”¹: ' + event.detail.key, 'info');
                    if (document.getElementById('sync-on-change').checked && !syncInProgress) {
                        debounceSync();
                    }
                }
            });
        }

        // è®¾ç½®ç½‘ç»œçŠ¶æ€å¤„ç†
        function setupNetworkHandlers() {
            let wasOffline = false;
            
            window.addEventListener('online', function() {
                if (wasOffline && syncEnabled && !syncInProgress) {
                    addLogEntry('ç½‘ç»œå·²æ¢å¤ï¼Œæ­£åœ¨åŒæ­¥æ•°æ®...', 'info');
                    setTimeout(() => {
                        if (!syncInProgress) {
                            manualSync();
                        }
                    }, 3000);
                }
                wasOffline = false;
            });

            window.addEventListener('offline', function() {
                wasOffline = true;
                addLogEntry('ç½‘ç»œå·²æ–­å¼€ï¼Œå°†åœ¨æ¢å¤åè‡ªåŠ¨åŒæ­¥', 'warning');
            });
        }

        // é˜²æŠ–åŒæ­¥å‡½æ•°å’ŒåŒæ­¥é”
        let syncTimer = null;
        let syncInProgress = false;
        let lastSyncAttempt = 0;
        
        function debounceSync() {
            if (syncTimer) clearTimeout(syncTimer);
            if (syncInProgress) {
                addLogEntry('åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡æœ¬æ¬¡è¯·æ±‚', 'info');
                return;
            }
            
            const now = Date.now();
            const minInterval = 10000; // æœ€å°åŒæ­¥é—´éš”10ç§’
            
            if (now - lastSyncAttempt < minInterval) {
                addLogEntry(`åŒæ­¥é—´éš”è¿‡çŸ­ï¼Œå»¶è¿Ÿåˆ°${Math.ceil((minInterval - (now - lastSyncAttempt))/1000)}ç§’åæ‰§è¡Œ`, 'info');
                syncTimer = setTimeout(() => {
                    if (syncEnabled && !syncInProgress) {
                        manualSync();
                    }
                }, minInterval - (now - lastSyncAttempt));
                return;
            }
            
            syncTimer = setTimeout(() => {
                if (syncEnabled && !syncInProgress) {
                    manualSync();
                }
            }, 5000); // 5ç§’ååŒæ­¥
        }

        function loadExistingConfig() {
            const config = window.syncService.getSyncConfig();
            if (config && config.enabled) {
                selectProvider(config.provider);
                loadProviderSettings(config.provider, config.settings);
                syncEnabled = true;
                updateSyncStatus();
                updateButtons();
            }
        }

        function selectProvider(provider) {
            selectedProvider = provider;
            
            // æ›´æ–°UI
            document.querySelectorAll('.provider-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-provider="${provider}"]`).classList.add('selected');

            // æ˜¾ç¤ºå¯¹åº”çš„é…ç½®
            document.querySelectorAll('.sync-config').forEach(config => {
                config.classList.remove('active');
            });
            document.getElementById(`${provider}-config`).classList.add('active');

            addLogEntry(`å·²é€‰æ‹© ${getProviderName(provider)} åŒæ­¥æ–¹å¼`, 'info');
        }

        function loadProviderSettings(provider, settings) {
            switch(provider) {
                case 'github':
                    document.getElementById('github-token').value = settings.token || '';
                    document.getElementById('github-owner').value = settings.owner || '';
                    document.getElementById('github-repo').value = settings.repo || '';
                    document.getElementById('github-branch').value = settings.branch || 'main';
                    break;
                case 'drive':
                    document.getElementById('drive-access-token').value = settings.accessToken || '';
                    document.getElementById('drive-folder-id').value = settings.folderId || '';
                    break;
                case 'server':
                    document.getElementById('server-url').value = settings.serverUrl || '';
                    document.getElementById('server-api-key').value = settings.apiKey || '';
                    document.getElementById('server-user-id').value = settings.userId || '';
                    break;
                case 'webrtc':
                    document.getElementById('webrtc-room-id').value = settings.roomId || '';
                    document.getElementById('webrtc-role').value = settings.isInitiator ? 'initiator' : 'joiner';
                    document.getElementById('webrtc-signal-url').value = settings.signalUrl || '';
                    break;
                case 'lenovo':
                    document.getElementById('lenovo-url').value = settings.url || 'http://192.168.1.100:5005';
                    document.getElementById('lenovo-username').value = settings.username || '';
                    document.getElementById('lenovo-password').value = settings.password || '';
                    document.getElementById('lenovo-timeout').value = settings.timeout || 30;
                    document.getElementById('lenovo-backup').checked = settings.enableBackup !== false;
                    break;
            }
        }

        function getProviderName(provider) {
            const names = {
                'github': 'GitHub',
                'drive': 'Google Drive',
                'server': 'è‡ªå»ºæœåŠ¡å™¨',
                'webrtc': 'è®¾å¤‡ç›´è¿',
                'lenovo': 'è”æƒ³ä¸ªäººäº‘'
            };
            return names[provider] || provider;
        }

        function getProviderSettings(provider) {
            switch(provider) {
                case 'github':
                    return {
                        token: document.getElementById('github-token').value.trim(),
                        owner: document.getElementById('github-owner').value.trim(),
                        repo: document.getElementById('github-repo').value.trim(),
                        branch: document.getElementById('github-branch').value.trim() || 'main'
                    };
                case 'drive':
                    return {
                        accessToken: document.getElementById('drive-access-token').value.trim(),
                        folderId: document.getElementById('drive-folder-id').value.trim()
                    };
                case 'server':
                    return {
                        serverUrl: document.getElementById('server-url').value.trim(),
                        apiKey: document.getElementById('server-api-key').value.trim(),
                        userId: document.getElementById('server-user-id').value.trim()
                    };
                case 'webrtc':
                    return {
                        roomId: document.getElementById('webrtc-room-id').value.trim(),
                        isInitiator: document.getElementById('webrtc-role').value === 'initiator',
                        signalUrl: document.getElementById('webrtc-signal-url').value.trim()
                    };
                case 'lenovo':
                    return {
                        url: document.getElementById('lenovo-url').value.trim(),
                        username: document.getElementById('lenovo-username').value.trim(),
                        password: document.getElementById('lenovo-password').value.trim(),
                        timeout: parseInt(document.getElementById('lenovo-timeout').value) * 1000,
                        enableBackup: document.getElementById('lenovo-backup').checked
                    };
                default:
                    return {};
            }
        }

        async function testConnection() {
            if (!selectedProvider) {
                alert('è¯·å…ˆé€‰æ‹©åŒæ­¥æ–¹å¼');
                return;
            }

            const settings = getProviderSettings(selectedProvider);
            addLogEntry(`æ­£åœ¨æµ‹è¯• ${getProviderName(selectedProvider)} è¿æ¥...`, 'info');

            try {
                let provider;
                switch(selectedProvider) {
                    case 'github':
                        provider = new GitHubSyncProvider(settings);
                        break;
                    case 'drive':
                        provider = new GoogleDriveSyncProvider(settings);
                        break;
                    case 'server':
                        provider = new ServerSyncProvider(settings);
                        break;
                    case 'webrtc':
                        provider = new WebRTCSyncProvider(settings);
                        break;
                    case 'lenovo':
                        provider = new LenovoCloudSyncProvider(settings);
                        break;
                }

                const success = await provider.testConnection();
                if (success) {
                    addLogEntry('âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                    
                    // é¢å¤–æµ‹è¯•æ•°æ®æ“ä½œ
                    if (selectedProvider === 'github') {
                        addLogEntry('æ­£åœ¨æµ‹è¯•æ•°æ®è¯»å†™æƒé™...', 'info');
                        await testGitHubDataOperations(provider);
                    }
                } else {
                    addLogEntry('âŒ è¿æ¥æµ‹è¯•å¤±è´¥', 'error');
                }
            } catch (error) {
                addLogEntry(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                diagnoseConnectionError(error, selectedProvider);
            }
        }

        // GitHubæ•°æ®æ“ä½œæµ‹è¯•
        async function testGitHubDataOperations(provider) {
            try {
                // æµ‹è¯•è¯»å–æ“ä½œ
                addLogEntry('æµ‹è¯•æ•°æ®ä¸‹è½½...', 'info');
                const data = await provider.downloadData();
                addLogEntry('âœ… æ•°æ®ä¸‹è½½æµ‹è¯•æˆåŠŸ', 'success');
                
                // æµ‹è¯•å†™å…¥æ“ä½œ
                addLogEntry('æµ‹è¯•æ•°æ®ä¸Šä¼ ...', 'info');
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'è¿æ¥æµ‹è¯•æ•°æ®'
                };
                await provider.uploadData(testData);
                addLogEntry('âœ… æ•°æ®ä¸Šä¼ æµ‹è¯•æˆåŠŸ', 'success');
                addLogEntry('ğŸ‰ GitHubåŒæ­¥åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼', 'success');
                
            } catch (error) {
                addLogEntry(`âŒ æ•°æ®æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // è¿æ¥é”™è¯¯è¯Šæ–­
        function diagnoseConnectionError(error, provider) {
            const errorMsg = error.message.toLowerCase();
            
            if (provider === 'github') {
                if (errorMsg.includes('401') || errorMsg.includes('unauthorized')) {
                    addLogEntry('ğŸ” è¯Šæ–­ï¼šGitHub Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ', 'warning');
                    addLogEntry('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šè¯·æ£€æŸ¥Personal Access Tokenæ˜¯å¦æ­£ç¡®', 'info');
                } else if (errorMsg.includes('403') || errorMsg.includes('forbidden')) {
                    addLogEntry('ğŸ” è¯Šæ–­ï¼šGitHub Tokenæƒé™ä¸è¶³', 'warning');
                    addLogEntry('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šTokenéœ€è¦"repo"æƒé™ï¼ˆå¦‚æœæ˜¯ç§æœ‰ä»“åº“ï¼‰', 'info');
                } else if (errorMsg.includes('404') || errorMsg.includes('not found')) {
                    addLogEntry('ğŸ” è¯Šæ–­ï¼šä»“åº“ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®', 'warning');
                    addLogEntry('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ä»“åº“æ‰€æœ‰è€…å’Œä»“åº“åç§°æ˜¯å¦æ­£ç¡®', 'info');
                } else if (errorMsg.includes('cors') || errorMsg.includes('blocked')) {
                    addLogEntry('ğŸ” è¯Šæ–­ï¼šæµè§ˆå™¨CORSé™åˆ¶', 'warning');
                    addLogEntry('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šè¯·ä½¿ç”¨HTTPSè®¿é—®ï¼Œæˆ–å°è¯•ä¸åŒæµè§ˆå™¨', 'info');
                } else if (errorMsg.includes('network') || errorMsg.includes('fetch')) {
                    addLogEntry('ğŸ” è¯Šæ–­ï¼šç½‘ç»œè¿æ¥é—®é¢˜', 'warning');
                    addLogEntry('ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒGitHubæœåŠ¡çŠ¶æ€', 'info');
                }
            }
        }

        async function enableSync() {
            if (!selectedProvider) {
                alert('è¯·å…ˆé€‰æ‹©åŒæ­¥æ–¹å¼');
                return;
            }

            const settings = getProviderSettings(selectedProvider);
            addLogEntry(`æ­£åœ¨å¯ç”¨ ${getProviderName(selectedProvider)} åŒæ­¥...`, 'info');

            try {
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!validateProviderSettings(selectedProvider, settings)) {
                    return;
                }

                // åº”ç”¨é«˜çº§è®¾ç½®
                const interval = parseInt(document.getElementById('sync-interval').value) * 1000;
                window.syncService.syncInterval = interval;

                await window.syncService.enableSync(selectedProvider, settings);
                syncEnabled = true;
                updateSyncStatus();
                updateButtons();
                addLogEntry('åŒæ­¥å·²æˆåŠŸå¯ç”¨ï¼', 'success');
                
                // å¯åŠ¨å®šæœŸçŠ¶æ€æ£€æŸ¥
                startStatusMonitor();
                
                // ç«‹å³æ‰§è¡Œä¸€æ¬¡åŒæ­¥æµ‹è¯•
                setTimeout(() => {
                    addLogEntry('æ­£åœ¨æ‰§è¡Œåˆå§‹åŒæ­¥...', 'info');
                    manualSync().then(() => {
                        addLogEntry('åˆå§‹åŒæ­¥å®Œæˆï¼Œæ‰€æœ‰è®¾å¤‡ç°åœ¨å¯ä»¥ä¿æŒæ•°æ®åŒæ­¥', 'success');
                    }).catch(err => {
                        addLogEntry(`åˆå§‹åŒæ­¥å¤±è´¥: ${err.message}`, 'warning');
                    });
                }, 2000);
                
            } catch (error) {
                addLogEntry(`å¯ç”¨åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // éªŒè¯æä¾›å•†è®¾ç½®
        function validateProviderSettings(provider, settings) {
            switch(provider) {
                case 'github':
                    if (!settings.token) {
                        addLogEntry('âŒ è¯·è¾“å…¥GitHub Personal Access Token', 'error');
                        return false;
                    }
                    if (!settings.owner) {
                        addLogEntry('âŒ è¯·è¾“å…¥ä»“åº“æ‰€æœ‰è€…', 'error');
                        return false;
                    }
                    if (!settings.repo) {
                        addLogEntry('âŒ è¯·è¾“å…¥ä»“åº“åç§°', 'error');
                        return false;
                    }
                    break;
                case 'drive':
                    if (!settings.accessToken) {
                        addLogEntry('âŒ è¯·è·å–Google Driveè®¿é—®ä»¤ç‰Œ', 'error');
                        return false;
                    }
                    break;
                case 'server':
                    if (!settings.serverUrl) {
                        addLogEntry('âŒ è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€', 'error');
                        return false;
                    }
                    break;
                case 'lenovo':
                    if (!settings.url || !settings.username || !settings.password) {
                        addLogEntry('âŒ è¯·å¡«å†™å®Œæ•´çš„è”æƒ³äº‘è¿æ¥ä¿¡æ¯', 'error');
                        return false;
                    }
                    break;
            }
            return true;
        }

        // çŠ¶æ€ç›‘æ§å™¨
        let statusMonitor = null;
        function startStatusMonitor() {
            if (statusMonitor) clearInterval(statusMonitor);
            statusMonitor = setInterval(() => {
                if (syncEnabled) {
                    updateSyncStatus();
                    checkSyncHealth();
                }
            }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        function stopStatusMonitor() {
            if (statusMonitor) {
                clearInterval(statusMonitor);
                statusMonitor = null;
            }
        }

        // åŒæ­¥å¥åº·æ£€æŸ¥
        function checkSyncHealth() {
            const status = window.syncService.getSyncStatus();
            const lastSync = status.lastSync ? new Date(status.lastSync) : null;
            const now = new Date();
            
            if (lastSync && (now - lastSync) > 300000) { // 5åˆ†é’Ÿæ²¡æœ‰åŒæ­¥
                addLogEntry('âš ï¸ åŒæ­¥é—´éš”è¾ƒé•¿ï¼Œå¯èƒ½å­˜åœ¨ç½‘ç»œé—®é¢˜', 'warning');
            }
        }

        async function disableSync() {
            if (confirm('ç¡®å®šè¦ç¦ç”¨æ•°æ®åŒæ­¥å—ï¼Ÿ')) {
                window.syncService.disableSync();
                syncEnabled = false;
                stopStatusMonitor();
                updateSyncStatus();
                updateButtons();
                addLogEntry('åŒæ­¥å·²ç¦ç”¨', 'warning');
            }
        }

        async function manualSync(retryCount = 0) {
            if (!syncEnabled) {
                if (retryCount === 0) { // åªåœ¨ç”¨æˆ·æ‰‹åŠ¨è§¦å‘æ—¶æç¤º
                    alert('è¯·å…ˆå¯ç”¨åŒæ­¥');
                }
                return;
            }

            // æ£€æŸ¥åŒæ­¥é”
            if (syncInProgress) {
                addLogEntry('åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...', 'warning');
                return;
            }

            const maxRetries = 3;
            const retryDelay = 3000; // 3ç§’
            const now = Date.now();

            // æ£€æŸ¥æœ€å°åŒæ­¥é—´éš”
            if (retryCount === 0 && now - lastSyncAttempt < 10000) {
                addLogEntry('åŒæ­¥é—´éš”è¿‡çŸ­ï¼Œè¯·ç¨åå†è¯•', 'warning');
                return;
            }

            try {
                syncInProgress = true;
                lastSyncAttempt = now;
                
                addLogEntry('å¼€å§‹æ‰‹åŠ¨åŒæ­¥...', 'info');
                await window.syncService.manualSync();
                addLogEntry('æ‰‹åŠ¨åŒæ­¥å®Œæˆï¼', 'success');
                
                // é‡ç½®é‡è¯•è®¡æ•°
                if (retryCount > 0) {
                    addLogEntry(`é‡è¯•æˆåŠŸï¼Œæ•°æ®å·²åŒæ­¥`, 'success');
                }
                
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                
                if (retryCount < maxRetries) {
                    addLogEntry(`åŒæ­¥å¤±è´¥ï¼Œ${retryDelay/1000}ç§’åé‡è¯•... (${retryCount + 1}/${maxRetries})`, 'warning');
                    setTimeout(() => {
                        syncInProgress = false; // é‡Šæ”¾é”
                        manualSync(retryCount + 1);
                    }, retryDelay);
                    return; // ä¸é‡Šæ”¾é”ï¼Œç­‰å¾…é‡è¯•
                } else {
                    addLogEntry(`åŒæ­¥å¤±è´¥ï¼Œå·²é‡è¯•${maxRetries}æ¬¡: ${error.message}`, 'error');
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé—®é¢˜
                    if (!navigator.onLine) {
                        addLogEntry('æ£€æµ‹åˆ°ç½‘ç»œç¦»çº¿ï¼Œå°†åœ¨ç½‘ç»œæ¢å¤åè‡ªåŠ¨é‡è¯•', 'warning');
                    } else {
                        // æä¾›æ›´å¤šå¸®åŠ©ä¿¡æ¯
                        suggestSyncSolution(error);
                        diagnoseConnectionError(error, selectedProvider);
                    }
                }
            } finally {
                if (retryCount >= maxRetries || retryCount === 0) {
                    syncInProgress = false; // é‡Šæ”¾åŒæ­¥é”
                }
            }
        }

        // æ ¹æ®é”™è¯¯ç±»å‹æä¾›è§£å†³æ–¹æ¡ˆå»ºè®®
        function suggestSyncSolution(error) {
            const errorMsg = error.message.toLowerCase();
            
            if (errorMsg.includes('401') || errorMsg.includes('unauthorized')) {
                addLogEntry('ğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥è®¿é—®ä»¤ç‰Œæˆ–å¯†ç æ˜¯å¦æ­£ç¡®', 'info');
            } else if (errorMsg.includes('403') || errorMsg.includes('forbidden')) {
                addLogEntry('ğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥ä»“åº“æƒé™æˆ–APIå¯†é’¥æƒé™', 'info');
            } else if (errorMsg.includes('404') || errorMsg.includes('not found')) {
                addLogEntry('ğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥ä»“åº“åç§°æˆ–æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®', 'info');
            } else if (errorMsg.includes('timeout') || errorMsg.includes('network')) {
                addLogEntry('ğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•', 'info');
            } else if (errorMsg.includes('quota') || errorMsg.includes('limit')) {
                addLogEntry('ğŸ’¡ å»ºè®®ï¼šAPIé…é¢å·²ç”¨å®Œï¼Œè¯·ç¨åé‡è¯•', 'info');
            } else {
                addLogEntry('ğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥åŒæ­¥è®¾ç½®æˆ–é‡æ–°é…ç½®åŒæ­¥æœåŠ¡', 'info');
            }
        }

        function updateSyncStatus() {
            const statusElement = document.getElementById('sync-status');
            const status = window.syncService.getSyncStatus();

            statusElement.className = 'sync-status';
            
            if (status.enabled && status.online) {
                statusElement.classList.add('connected');
                statusElement.innerHTML = `
                    <div class="status-indicator"></div>
                    <span>å·²è¿æ¥ - ${getProviderName(selectedProvider)} | æœ€ååŒæ­¥: ${status.lastSync ? new Date(status.lastSync).toLocaleString() : 'ä»æœª'}</span>
                `;
            } else if (status.enabled && !status.online) {
                statusElement.classList.add('error');
                statusElement.innerHTML = `
                    <div class="status-indicator"></div>
                    <span>ç¦»çº¿çŠ¶æ€ - å°†åœ¨ç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥</span>
                `;
            } else {
                statusElement.classList.add('disconnected');
                statusElement.innerHTML = `
                    <div class="status-indicator"></div>
                    <span>åŒæ­¥æœªå¯ç”¨</span>
                `;
            }
        }

        function updateButtons() {
            const testBtn = document.querySelector('button[onclick="testConnection()"]');
            const enableBtn = document.querySelector('button[onclick="enableSync()"]');
            const syncBtn = document.querySelector('button[onclick="manualSync()"]');
            const disableBtn = document.querySelector('button[onclick="disableSync()"]');

            if (syncEnabled) {
                enableBtn.disabled = true;
                syncBtn.disabled = false;
                disableBtn.disabled = false;
                enableBtn.textContent = 'åŒæ­¥å·²å¯ç”¨';
            } else {
                enableBtn.disabled = false;
                syncBtn.disabled = true;
                disableBtn.disabled = true;
                enableBtn.textContent = 'å¯ç”¨åŒæ­¥';
            }
        }

        function addLogEntry(message, type = 'info') {
            const logElement = document.getElementById('sync-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;

            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
            while (logElement.children.length > 50) {
                logElement.removeChild(logElement.firstChild);
            }
        }

        // åŒæ­¥çŠ¶æ€é‡ç½®ï¼ˆé˜²æ­¢é”å¡æ­»ï¼‰
        function resetSyncStatus() {
            if (syncInProgress) {
                const lockTime = Date.now() - lastSyncAttempt;
                if (lockTime > 60000) { // å¦‚æœé”å®šè¶…è¿‡1åˆ†é’Ÿï¼Œå¼ºåˆ¶é‡ç½®
                    addLogEntry('æ£€æµ‹åˆ°åŒæ­¥é”å¼‚å¸¸ï¼Œæ­£åœ¨é‡ç½®...', 'warning');
                    syncInProgress = false;
                    if (syncTimer) {
                        clearTimeout(syncTimer);
                        syncTimer = null;
                    }
                    addLogEntry('åŒæ­¥çŠ¶æ€å·²é‡ç½®', 'info');
                }
            }
        }

        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡åŒæ­¥çŠ¶æ€
        setInterval(resetSyncStatus, 30000);

        // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–åŒæ­¥æœåŠ¡
        function forceReinitializeSync() {
            addLogEntry('ğŸ”„ æ­£åœ¨å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–åŒæ­¥æœåŠ¡...', 'info');
            
            try {
                // é‡æ–°åˆå§‹åŒ–åŒæ­¥æœåŠ¡
                if (window.syncService) {
                    console.log('é‡æ–°åˆå§‹åŒ–åŒæ­¥é…ç½®...');
                    window.syncService.initSyncConfig();
                    
                    // æ£€æŸ¥çŠ¶æ€
                    const status = window.syncService.getSyncStatus();
                    console.log('åŒæ­¥æœåŠ¡çŠ¶æ€:', status);
                    
                    if (status.enabled) {
                        addLogEntry('âœ… åŒæ­¥æœåŠ¡é‡æ–°åˆå§‹åŒ–æˆåŠŸ', 'success');
                        updateSyncStatus();
                        updateButtons();
                    } else {
                        addLogEntry('âš ï¸ åŒæ­¥æœåŠ¡æœªå¯ç”¨ï¼Œè¯·æ£€æŸ¥é…ç½®', 'warning');
                    }
                } else {
                    addLogEntry('âŒ åŒæ­¥æœåŠ¡æœªåŠ è½½', 'error');
                }
                
                // é‡æ–°åˆå§‹åŒ–é€šç”¨è‡ªåŠ¨åŒæ­¥
                if (window.universalAutoSync) {
                    console.log('åˆ·æ–°é€šç”¨è‡ªåŠ¨åŒæ­¥çŠ¶æ€...');
                    window.universalAutoSync.forceRefreshStatus();
                }
                
            } catch (error) {
                console.error('é‡æ–°åˆå§‹åŒ–å¤±è´¥:', error);
                addLogEntry(`âŒ é‡æ–°åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¼ºåˆ¶å¯ç”¨åŒæ­¥åŠŸèƒ½
        async function forceEnableSync() {
            if (!selectedProvider) {
                alert('è¯·å…ˆé€‰æ‹©åŒæ­¥æ–¹å¼');
                return;
            }

            const settings = getProviderSettings(selectedProvider);
            addLogEntry('âš¡ æ­£åœ¨å¼ºåˆ¶å¯ç”¨åŒæ­¥åŠŸèƒ½...', 'info');

            try {
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!validateProviderSettings(selectedProvider, settings)) {
                    return;
                }

                // å¼ºåˆ¶è®¾ç½®åŒæ­¥çŠ¶æ€
                window.syncService.syncEnabled = true;
                
                // åˆ›å»ºåŒæ­¥æä¾›å•†
                let provider;
                switch(selectedProvider) {
                    case 'github':
                        provider = new GitHubSyncProvider(settings);
                        break;
                    case 'drive':
                        provider = new GoogleDriveSyncProvider(settings);
                        break;
                    case 'server':
                        provider = new ServerSyncProvider(settings);
                        break;
                    case 'webrtc':
                        provider = new WebRTCSyncProvider(settings);
                        break;
                    case 'lenovo':
                        provider = new LenovoCloudSyncProvider(settings);
                        break;
                }
                
                window.syncService.syncProvider = provider;
                
                // ä¿å­˜é…ç½®
                window.syncService.setSyncConfig({
                    enabled: true,
                    provider: selectedProvider,
                    settings: settings,
                    lastSync: new Date().toISOString()
                });
                
                syncEnabled = true;
                updateSyncStatus();
                updateButtons();
                addLogEntry('âœ… åŒæ­¥åŠŸèƒ½å·²å¼ºåˆ¶å¯ç”¨ï¼', 'success');
                
                // å¯åŠ¨è‡ªåŠ¨åŒæ­¥
                window.syncService.startAutoSync();
                
            } catch (error) {
                addLogEntry(`âŒ å¼ºåˆ¶å¯ç”¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // GitHubè¾…åŠ©åŠŸèƒ½
        async function checkGitHubRepo() {
            const token = document.getElementById('github-token').value.trim();
            const owner = document.getElementById('github-owner').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            
            if (!token || !owner || !repo) {
                addLogEntry('âŒ è¯·å…ˆå¡«å†™å®Œæ•´çš„GitHubé…ç½®ä¿¡æ¯', 'error');
                return;
            }
            
            try {
                addLogEntry('ğŸ” æ­£åœ¨æ£€æŸ¥GitHubä»“åº“...', 'info');
                
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const repoInfo = await response.json();
                    addLogEntry('âœ… ä»“åº“æ£€æŸ¥é€šè¿‡ï¼', 'success');
                    addLogEntry(`ğŸ“‹ ä»“åº“ä¿¡æ¯ï¼š${repoInfo.private ? 'ç§æœ‰' : 'å…¬å¼€'}ä»“åº“ï¼Œ${repoInfo.default_branch}åˆ†æ”¯`, 'info');
                    
                    // æ›´æ–°åˆ†æ”¯åç§°
                    document.getElementById('github-branch').value = repoInfo.default_branch;
                } else if (response.status === 404) {
                    addLogEntry('âŒ ä»“åº“ä¸å­˜åœ¨ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»"åˆ›å»ºä»“åº“"æŒ‰é’®', 'warning');
                } else if (response.status === 401) {
                    addLogEntry('âŒ Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ', 'error');
                } else if (response.status === 403) {
                    addLogEntry('âŒ Tokenæƒé™ä¸è¶³æˆ–è®¿é—®è¢«æ‹’ç»', 'error');
                } else {
                    addLogEntry(`âŒ æ£€æŸ¥å¤±è´¥ï¼š${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                addLogEntry(`âŒ æ£€æŸ¥å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        async function createGitHubRepo() {
            const token = document.getElementById('github-token').value.trim();
            const owner = document.getElementById('github-owner').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            
            if (!token || !owner || !repo) {
                addLogEntry('âŒ è¯·å…ˆå¡«å†™å®Œæ•´çš„GitHubé…ç½®ä¿¡æ¯', 'error');
                return;
            }
            
            const isPrivate = confirm('åˆ›å»ºç§æœ‰ä»“åº“ï¼Ÿ\né€‰æ‹©"ç¡®å®š"åˆ›å»ºç§æœ‰ä»“åº“ï¼ˆæ¨èï¼‰ï¼Œ"å–æ¶ˆ"åˆ›å»ºå…¬å¼€ä»“åº“');
            
            try {
                addLogEntry('ğŸš€ æ­£åœ¨åˆ›å»ºGitHubä»“åº“...', 'info');
                
                const response = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: repo,
                        description: 'è®¡åˆ’ç®¡ç†å™¨æ•°æ®åŒæ­¥ä»“åº“',
                        private: isPrivate,
                        auto_init: true,
                        gitignore_template: null
                    })
                });
                
                if (response.status === 201) {
                    const repoInfo = await response.json();
                    addLogEntry('âœ… ä»“åº“åˆ›å»ºæˆåŠŸï¼', 'success');
                    addLogEntry(`ğŸ“‹ ä»“åº“åœ°å€ï¼š${repoInfo.html_url}`, 'info');
                } else if (response.status === 422) {
                    addLogEntry('âŒ ä»“åº“åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„åç§°', 'error');
                } else {
                    const error = await response.json();
                    addLogEntry(`âŒ åˆ›å»ºå¤±è´¥ï¼š${error.message}`, 'error');
                }
            } catch (error) {
                addLogEntry(`âŒ åˆ›å»ºå¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        function showGitHubHelp() {
            const helpModal = document.createElement('div');
            helpModal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            helpModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-top: 0;">ğŸ“š GitHubåŒæ­¥è®¾ç½®æ•™ç¨‹</h3>
                    
                    <h4>1. åˆ›å»ºPersonal Access Token</h4>
                    <ol>
                        <li>è®¿é—® <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings â†’ Developer settings â†’ Personal access tokens</a></li>
                        <li>ç‚¹å‡»"Generate new token"</li>
                        <li>è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå»ºè®®90å¤©æˆ–No expirationï¼‰</li>
                        <li>é€‰æ‹©æƒé™ï¼š
                            <ul>
                                <li><strong>repo</strong> - å®Œæ•´ä»“åº“æƒé™ï¼ˆç§æœ‰ä»“åº“å¿…éœ€ï¼‰</li>
                                <li><strong>public_repo</strong> - å…¬å¼€ä»“åº“æƒé™ï¼ˆä»…å…¬å¼€ä»“åº“æ—¶å¯é€‰ï¼‰</li>
                            </ul>
                        </li>
                        <li>ç‚¹å‡»"Generate token"å¹¶å¤åˆ¶Token</li>
                    </ol>
                    
                    <h4>2. ä»“åº“è®¾ç½®</h4>
                    <ul>
                        <li><strong>ä»“åº“æ‰€æœ‰è€…</strong>ï¼šæ‚¨çš„GitHubç”¨æˆ·å</li>
                        <li><strong>ä»“åº“åç§°</strong>ï¼šå»ºè®®ä½¿ç”¨"plan-data"æˆ–ç±»ä¼¼åç§°</li>
                        <li><strong>ç§æœ‰æ€§</strong>ï¼šæ¨èåˆ›å»ºç§æœ‰ä»“åº“ä¿æŠ¤æ•°æ®éšç§</li>
                    </ul>
                    
                    <h4>3. å¸¸è§é—®é¢˜</h4>
                    <ul>
                        <li><strong>401é”™è¯¯</strong>ï¼šTokenæ— æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆ</li>
                        <li><strong>403é”™è¯¯</strong>ï¼šæƒé™ä¸è¶³ï¼Œæ£€æŸ¥Tokenæƒé™è®¾ç½®</li>
                        <li><strong>404é”™è¯¯</strong>ï¼šä»“åº“ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºä»“åº“</li>
                        <li><strong>CORSé”™è¯¯</strong>ï¼šè¯·ä½¿ç”¨HTTPSè®¿é—®æœ¬åº”ç”¨</li>
                    </ul>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            æˆ‘çŸ¥é“äº†
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
        }

        async function resetGitHubData() {
            if (!confirm('ç¡®å®šè¦é‡ç½®GitHubæ•°æ®å—ï¼Ÿè¿™å°†æ¸…ç©ºè¿œç¨‹ä»“åº“ä¸­çš„æ•°æ®æ–‡ä»¶å¹¶é‡æ–°ä¸Šä¼ å½“å‰æœ¬åœ°æ•°æ®ã€‚')) {
                return;
            }
            
            const token = document.getElementById('github-token').value.trim();
            const owner = document.getElementById('github-owner').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            
            if (!token || !owner || !repo) {
                addLogEntry('âŒ è¯·å…ˆå¡«å†™å®Œæ•´çš„GitHubé…ç½®ä¿¡æ¯', 'error');
                return;
            }
            
            try {
                addLogEntry('ğŸ”„ æ­£åœ¨é‡ç½®GitHubæ•°æ®...', 'info');
                
                // åˆ›å»ºGitHubæä¾›å•†å®ä¾‹
                const provider = new GitHubSyncProvider({
                    token: token,
                    owner: owner,
                    repo: repo,
                    branch: document.getElementById('github-branch').value.trim() || 'main'
                });
                
                // è·å–å½“å‰æœ¬åœ°æ•°æ®
                const localData = window.syncService.getLocalData();
                
                // å¼ºåˆ¶ä¸Šä¼ æœ¬åœ°æ•°æ®åˆ°GitHubï¼ˆè¦†ç›–è¿œç¨‹æ•°æ®ï¼‰
                await provider.uploadData(localData);
                
                addLogEntry('âœ… GitHubæ•°æ®é‡ç½®æˆåŠŸï¼', 'success');
                addLogEntry('ğŸ’¾ å·²å°†å½“å‰æœ¬åœ°æ•°æ®ä¸Šä¼ åˆ°GitHub', 'success');
                
            } catch (error) {
                addLogEntry(`âŒ é‡ç½®å¤±è´¥ï¼š${error.message}`, 'error');
                console.error('é‡ç½®GitHubæ•°æ®å¤±è´¥:', error);
            }
        }

        function toggleAdvanced() {
            const content = document.getElementById('advanced-content');
            const arrow = document.getElementById('advanced-arrow');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                arrow.textContent = 'â–¼';
            } else {
                content.classList.add('open');
                arrow.textContent = 'â–²';
            }
        }

        async function authenticateGoogleDrive() {
            // ç®€åŒ–çš„Google OAuthæµç¨‹æç¤º
            const clientId = prompt('è¯·è¾“å…¥æ‚¨çš„Google Drive APIå®¢æˆ·ç«¯ID\nï¼ˆåœ¨Google Cloud Consoleä¸­åˆ›å»ºï¼‰:');
            if (!clientId) return;

            const redirectUri = window.location.origin + window.location.pathname;
            const scope = 'https://www.googleapis.com/auth/drive.file';
            
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${encodeURIComponent(clientId)}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `scope=${encodeURIComponent(scope)}&` +
                `response_type=token&` +
                `state=google_drive_auth`;

            // åœ¨æ–°çª—å£ä¸­æ‰“å¼€æˆæƒé¡µé¢
            const authWindow = window.open(authUrl, 'google_auth', 'width=500,height=600');
            
            // ç›‘å¬æˆæƒå®Œæˆ
            const checkAuth = setInterval(() => {
                try {
                    if (authWindow.closed) {
                        clearInterval(checkAuth);
                        return;
                    }
                    
                    const url = authWindow.location.href;
                    if (url.includes('access_token=')) {
                        const token = url.match(/access_token=([^&]+)/)[1];
                        document.getElementById('drive-access-token').value = token;
                        authWindow.close();
                        clearInterval(checkAuth);
                        addLogEntry('Google DriveæˆæƒæˆåŠŸ', 'success');
                    }
                } catch (e) {
                    // è·¨åŸŸé™åˆ¶ï¼Œå¿½ç•¥é”™è¯¯
                }
            }, 1000);
        }

        // è”æƒ³ä¸ªäººäº‘è¾…åŠ©åŠŸèƒ½
        async function detectLenovoCloud() {
            addLogEntry('æ­£åœ¨è‡ªåŠ¨æ£€æµ‹è”æƒ³ä¸ªäººäº‘è®¾å¤‡...', 'info');
            
            const commonIPs = [
                '192.168.1.100', '192.168.1.101', '192.168.1.102',
                '192.168.0.100', '192.168.0.101', '192.168.0.102',
                '192.168.31.100', '192.168.31.101'
            ];
            
            for (const ip of commonIPs) {
                try {
                    const testUrl = `http://${ip}:5005`;
                    addLogEntry(`æ£€æµ‹: ${testUrl}`, 'info');
                    
                    const response = await fetch(testUrl, {
                        method: 'OPTIONS',
                        timeout: 5000
                    });
                    
                    if (response.ok || response.status === 401) {
                        document.getElementById('lenovo-url').value = testUrl;
                        addLogEntry(`âœ… å‘ç°è”æƒ³ä¸ªäººäº‘è®¾å¤‡: ${testUrl}`, 'success');
                        return;
                    }
                } catch (error) {
                    // ç»§ç»­æ£€æµ‹ä¸‹ä¸€ä¸ªIP
                }
            }
            
            addLogEntry('âŒ æœªè‡ªåŠ¨æ£€æµ‹åˆ°è”æƒ³ä¸ªäººäº‘è®¾å¤‡ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥IPåœ°å€', 'warning');
        }

        async function testLenovoConnection() {
            const url = document.getElementById('lenovo-url').value.trim();
            const username = document.getElementById('lenovo-username').value.trim();
            const password = document.getElementById('lenovo-password').value.trim();
            
            if (!url || !username || !password) {
                addLogEntry('âŒ è¯·å¡«å†™å®Œæ•´çš„è¿æ¥ä¿¡æ¯', 'error');
                return;
            }
            
            try {
                addLogEntry('æ­£åœ¨æµ‹è¯•WebDAVè¿æ¥...', 'info');
                
                const response = await fetch(url, {
                    method: 'PROPFIND',
                    headers: {
                        'Authorization': `Basic ${btoa(username + ':' + password)}`,
                        'Depth': '1'
                    }
                });
                
                if (response.status === 401) {
                    addLogEntry('âŒ ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
                } else if (response.ok) {
                    addLogEntry('âœ… WebDAVè¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                } else {
                    addLogEntry(`âŒ è¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                addLogEntry(`âŒ è¿æ¥é”™è¯¯: ${error.message}`, 'error');
            }
        }

        function openLenovoHelp() {
            const helpContent = `
# è”æƒ³ä¸ªäººäº‘è®¾ç½®æ•™ç¨‹

## 1. å¯ç”¨WebDAVæœåŠ¡
1. æ‰“å¼€è”æƒ³ä¸ªäººäº‘ç®¡ç†ç•Œé¢ï¼ˆé€šå¸¸æ˜¯ http://è®¾å¤‡IPï¼‰
2. ç™»å½•ç®¡ç†å‘˜è´¦å·
3. è¿›å…¥"åº”ç”¨ä¸­å¿ƒ"æˆ–"æœåŠ¡"
4. æ‰¾åˆ°å¹¶å¯ç”¨"WebDAV"æœåŠ¡
5. è®¾ç½®ç«¯å£ä¸º5005ï¼ˆé»˜è®¤ï¼‰

## 2. åˆ›å»ºç”¨æˆ·è´¦å·
1. è¿›å…¥"ç”¨æˆ·ç®¡ç†"
2. ç‚¹å‡»"æ·»åŠ ç”¨æˆ·"
3. è®¾ç½®ç”¨æˆ·åï¼šplanSync
4. è®¾ç½®å¯†ç å¹¶ç¡®è®¤
5. åˆ†é…é€‚å½“çš„æƒé™

## 3. è·å–è®¾å¤‡IP
- åœ¨ç®¡ç†ç•Œé¢çš„"ç³»ç»Ÿä¿¡æ¯"ä¸­æŸ¥çœ‹
- æˆ–åœ¨è·¯ç”±å™¨ç®¡ç†ç•Œé¢æŸ¥çœ‹è¿æ¥è®¾å¤‡
- é€šå¸¸æ ¼å¼ï¼š192.168.1.x æˆ– 192.168.0.x

## 4. æµ‹è¯•è¿æ¥
ä½¿ç”¨æœ¬é¡µé¢çš„"æµ‹è¯•WebDAVè¿æ¥"åŠŸèƒ½éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®ã€‚

å¦‚éœ€æ›´å¤šå¸®åŠ©ï¼Œè¯·æŸ¥çœ‹è”æƒ³ä¸ªäººäº‘ç”¨æˆ·æ‰‹å†Œã€‚
            `;
            
            const helpWindow = window.open('', 'lenovo-help', 'width=600,height=500');
            helpWindow.document.write(`
                <html>
                <head><title>è”æƒ³ä¸ªäººäº‘è®¾ç½®æ•™ç¨‹</title></head>
                <body style="font-family: Arial, sans-serif; padding: 20px; line-height: 1.6;">
                    <pre style="white-space: pre-wrap;">${helpContent}</pre>
                    <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px;">å…³é—­</button>
                </body>
                </html>
            `);
        }

        // ç½‘ç»œçŠ¶æ€ç›‘å¬
        window.addEventListener('online', function() {
            updateSyncStatus();
            addLogEntry('ç½‘ç»œå·²è¿æ¥', 'success');
        });

        window.addEventListener('offline', function() {
            updateSyncStatus();
            addLogEntry('ç½‘ç»œå·²æ–­å¼€', 'warning');
        });

        // é¡µé¢å¯è§æ€§æ£€æµ‹ï¼ˆé‡è¦ï¼šå¤„ç†æ‰‹æœºåˆ‡æ¢åº”ç”¨çš„æƒ…å†µï¼‰
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && syncEnabled && !syncInProgress) {
                addLogEntry('é¡µé¢é‡æ–°å¯è§ï¼Œæ£€æŸ¥åŒæ­¥çŠ¶æ€...', 'info');
                setTimeout(() => {
                    if (navigator.onLine && syncEnabled && !syncInProgress) {
                        addLogEntry('æ‰§è¡Œåå°åŒæ­¥æ£€æŸ¥...', 'info');
                        manualSync();
                    }
                }, 2000);
            }
        });

        // PWAåº”ç”¨æ¢å¤æ£€æµ‹
        window.addEventListener('focus', function() {
            if (syncEnabled && navigator.onLine && !syncInProgress) {
                const timeSinceLastSync = Date.now() - lastSyncAttempt;
                if (timeSinceLastSync > 30000) { // 30ç§’åæ‰è‡ªåŠ¨åŒæ­¥
                    addLogEntry('åº”ç”¨è·å¾—ç„¦ç‚¹ï¼Œæ­£åœ¨åŒæ­¥æœ€æ–°æ•°æ®...', 'info');
                    setTimeout(() => {
                        if (!syncInProgress) {
                            manualSync();
                        }
                    }, 1000);
                }
            }
        });

        // ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç†
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            // ç§»åŠ¨ç«¯è‡ªåŠ¨åŒæ­¥é—´éš”ç¨é•¿ä¸€äº›ä»¥èŠ‚çœç”µé‡
            document.getElementById('sync-interval').value = '60'; // 60ç§’
            
            // æ·»åŠ ç§»åŠ¨ç«¯ç‰¹æœ‰çš„äº‹ä»¶ç›‘å¬
            window.addEventListener('pagehide', function() {
                if (syncEnabled && navigator.onLine && !syncInProgress) {
                    const timeSinceLastSync = Date.now() - lastSyncAttempt;
                    if (timeSinceLastSync > 15000) { // 15ç§’åæ‰æ‰§è¡Œåå°åŒæ­¥
                        addLogEntry('åº”ç”¨è¿›å…¥åå°ï¼Œæ‰§è¡Œæœ€ååŒæ­¥...', 'info');
                        // å¿«é€ŸåŒæ­¥ï¼ˆä¸é‡è¯•ï¼‰
                        syncInProgress = true;
                        lastSyncAttempt = Date.now();
                        window.syncService.manualSync().finally(() => {
                            syncInProgress = false;
                        });
                    }
                }
            });
            
            addLogEntry('ğŸ”” ç§»åŠ¨è®¾å¤‡æ£€æµ‹ï¼šå·²ä¼˜åŒ–åŒæ­¥ç­–ç•¥', 'info');
        }

        // æ·»åŠ è·¨è®¾å¤‡åŒæ­¥æç¤ºåŠŸèƒ½
        function showCrossDeviceHelp() {
            const helpModal = document.createElement('div');
            helpModal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            helpModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-top: 0;">ğŸ“±ğŸ’» è·¨è®¾å¤‡åŒæ­¥æŒ‡å—</h3>
                    
                    <h4>1. è®¾ç½®è¦æ±‚</h4>
                    <ul>
                        <li>æ‰€æœ‰è®¾å¤‡å¿…é¡»ä½¿ç”¨ç›¸åŒçš„åŒæ­¥é…ç½®</li>
                        <li>ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸</li>
                        <li>GitHubä»“åº“æˆ–äº‘å­˜å‚¨æƒé™æ­£ç¡®</li>
                    </ul>
                    
                    <h4>2. ç§»åŠ¨ç«¯ä½¿ç”¨æŠ€å·§</h4>
                    <ul>
                        <li>æ·»åŠ åˆ°ä¸»å±å¹•ä»¥è·å¾—æœ€ä½³ä½“éªŒ</li>
                        <li>ä¿æŒåº”ç”¨åœ¨åå°è¿è¡Œ</li>
                        <li>åˆ‡æ¢å›åº”ç”¨æ—¶ä¼šè‡ªåŠ¨åŒæ­¥</li>
                        <li>ç½‘ç»œæ¢å¤æ—¶ä¼šè‡ªåŠ¨é‡è¯•</li>
                    </ul>
                    
                    <h4>3. å¸¸è§é—®é¢˜è§£å†³</h4>
                    <ul>
                        <li>æ•°æ®ä¸åŒæ­¥ï¼šæ£€æŸ¥ç½‘ç»œå’Œé…ç½®</li>
                        <li>åŒæ­¥å†²çªï¼šç³»ç»Ÿä¼šè‡ªåŠ¨åˆå¹¶</li>
                        <li>è¿æ¥è¶…æ—¶ï¼šä¼šè‡ªåŠ¨é‡è¯•3æ¬¡</li>
                    </ul>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            æˆ‘çŸ¥é“äº†
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
        }
    </script>
</body>
</html>

