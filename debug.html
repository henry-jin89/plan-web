<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” LeanCloud è°ƒè¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #667eea;
            margin-bottom: 20px;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid;
        }
        .alert-info {
            background: #e7f3ff;
            border-color: #2196F3;
            color: #0c5280;
        }
        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .code {
            background: #282c34;
            color: #61dafb;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin: 5px 0;
        }
        .badge-success {
            background: #28a745;
            color: white;
        }
        .badge-error {
            background: #dc3545;
            color: white;
        }
        .badge-warning {
            background: #ffc107;
            color: #333;
        }
        .badge-info {
            background: #2196F3;
            color: white;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #5568d3;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” LeanCloud è°ƒè¯•å·¥å…·</h1>
        <p style="color: #666; margin-bottom: 20px;">æ­¤é¡µé¢ä¼šæ˜¾ç¤ºæ‰€æœ‰è°ƒè¯•ä¿¡æ¯ï¼Œæ— éœ€æ‰“å¼€å¼€å‘è€…å·¥å…·</p>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½è°ƒè¯•ä¿¡æ¯...</p>
        </div>

        <div id="results" style="display: none;">
            <!-- æ€»ä½“çŠ¶æ€ -->
            <div class="section">
                <h3>ğŸ“Š æ€»ä½“çŠ¶æ€</h3>
                <div id="overall-status"></div>
            </div>

            <!-- è¯¦ç»†æ£€æŸ¥ -->
            <div class="section">
                <h3>ğŸ” è¯¦ç»†æ£€æŸ¥</h3>
                <div id="detailed-checks"></div>
            </div>

            <!-- å¯¹è±¡çŠ¶æ€ -->
            <div class="section">
                <h3>ğŸ¯ å¯¹è±¡çŠ¶æ€</h3>
                <div id="object-status"></div>
            </div>

            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div id="error-section" style="display: none;" class="section">
                <h3>âŒ é”™è¯¯ä¿¡æ¯</h3>
                <div id="error-details"></div>
            </div>

            <!-- åŸå§‹æ•°æ® -->
            <div class="section">
                <h3>ğŸ’¾ åŸå§‹æ•°æ®ï¼ˆä¾›å¼€å‘è€…æŸ¥çœ‹ï¼‰</h3>
                <div class="code" id="raw-data"></div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="runDiagnostics()">ğŸ”„ é‡æ–°æ£€æŸ¥</button>
                <button class="btn" onclick="copyResults()">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
                <a href="leancloud-status.html" class="btn" style="text-decoration: none;">ğŸ  è¿”å›çŠ¶æ€é¡µ</a>
            </div>
        </div>
    </div>

    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <!-- LeanCloud é…ç½® -->
    <script src="leancloud-config.js"></script>
    
    <!-- LeanCloud åŒæ­¥è„šæœ¬ -->
    <script src="leancloud-sync.js"></script>

    <script>
        let diagnosticResults = {};

        function addResult(category, item, status, details = '') {
            if (!diagnosticResults[category]) {
                diagnosticResults[category] = [];
            }
            diagnosticResults[category].push({ item, status, details });
        }

        function getBadgeClass(status) {
            switch(status) {
                case 'success': return 'badge-success';
                case 'error': return 'badge-error';
                case 'warning': return 'badge-warning';
                default: return 'badge-info';
            }
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'success': return 'âœ…';
                case 'error': return 'âŒ';
                case 'warning': return 'âš ï¸';
                default: return 'â„¹ï¸';
            }
        }

        async function runDiagnostics() {
            diagnosticResults = {};
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            // ç­‰å¾…2ç§’è®©æ‰€æœ‰è„šæœ¬åŠ è½½
            await new Promise(resolve => setTimeout(resolve, 2000));

            // æ£€æŸ¥1: ç½‘ç»œè¿æ¥
            if (navigator.onLine) {
                addResult('åŸºç¡€æ£€æŸ¥', 'ç½‘ç»œè¿æ¥', 'success', 'è®¾å¤‡å·²è¿æ¥åˆ°ç½‘ç»œ');
            } else {
                addResult('åŸºç¡€æ£€æŸ¥', 'ç½‘ç»œè¿æ¥', 'error', 'è®¾å¤‡å¤„äºç¦»çº¿çŠ¶æ€');
            }

            // æ£€æŸ¥2: LeanCloud SDK
            if (typeof AV !== 'undefined') {
                addResult('åŸºç¡€æ£€æŸ¥', 'LeanCloud SDK', 'success', `SDK å·²åŠ è½½ (ç‰ˆæœ¬: ${AV.version || 'æœªçŸ¥'})`);
            } else {
                addResult('åŸºç¡€æ£€æŸ¥', 'LeanCloud SDK', 'error', 'SDK æœªåŠ è½½ï¼Œå¯èƒ½æ˜¯CDNæ— æ³•è®¿é—®');
            }

            // æ£€æŸ¥3: é…ç½®æ–‡ä»¶
            if (typeof window.leancloudConfig !== 'undefined') {
                addResult('åŸºç¡€æ£€æŸ¥', 'é…ç½®æ–‡ä»¶', 'success', 'é…ç½®æ–‡ä»¶å·²åŠ è½½');
                addResult('é…ç½®è¯¦æƒ…', 'App ID', 'info', window.leancloudConfig.appId?.substring(0, 10) + '...');
                addResult('é…ç½®è¯¦æƒ…', 'Server URL', 'info', window.leancloudConfig.serverURL);
            } else {
                addResult('åŸºç¡€æ£€æŸ¥', 'é…ç½®æ–‡ä»¶', 'error', 'leancloud-config.js æœªåŠ è½½');
            }

            // æ£€æŸ¥4: åŒæ­¥å¯¹è±¡
            if (typeof window.leanCloudSync !== 'undefined') {
                addResult('åŸºç¡€æ£€æŸ¥', 'åŒæ­¥å¯¹è±¡', 'success', 'leanCloudSync å¯¹è±¡å·²åˆ›å»º');
                
                // è¯¦ç»†æ£€æŸ¥å¯¹è±¡å±æ€§
                const sync = window.leanCloudSync;
                
                if (sync.isInitialized) {
                    addResult('åŒæ­¥çŠ¶æ€', 'åˆå§‹åŒ–çŠ¶æ€', 'success', 'LeanCloud å·²æˆåŠŸåˆå§‹åŒ–');
                } else {
                    if (sync.initError) {
                        addResult('åŒæ­¥çŠ¶æ€', 'åˆå§‹åŒ–çŠ¶æ€', 'error', `åˆå§‹åŒ–å¤±è´¥: ${sync.initError}`);
                    } else {
                        addResult('åŒæ­¥çŠ¶æ€', 'åˆå§‹åŒ–çŠ¶æ€', 'warning', 'æ­£åœ¨åˆå§‹åŒ–ä¸­...');
                    }
                }

                addResult('åŒæ­¥çŠ¶æ€', 'åŒæ­¥åŠŸèƒ½', sync.isEnabled ? 'success' : 'warning', 
                    sync.isEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨');
                
                addResult('åŒæ­¥çŠ¶æ€', 'å…±äº«ID', 'info', sync.sharedUserId || 'æœªè®¾ç½®');
                
                if (sync.lastSync) {
                    const timeAgo = Math.floor((new Date() - sync.lastSync) / 1000);
                    addResult('åŒæ­¥çŠ¶æ€', 'æœ€ååŒæ­¥', 'success', `${timeAgo} ç§’å‰`);
                } else {
                    addResult('åŒæ­¥çŠ¶æ€', 'æœ€ååŒæ­¥', 'info', 'ä»æœªåŒæ­¥');
                }

            } else {
                addResult('åŸºç¡€æ£€æŸ¥', 'åŒæ­¥å¯¹è±¡', 'error', 'leancloud-sync.js æœªåŠ è½½æˆ–æ‰§è¡Œå¤±è´¥');
            }

            // æ£€æŸ¥5: LocalStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                addResult('åŸºç¡€æ£€æŸ¥', 'LocalStorage', 'success', 'æœ¬åœ°å­˜å‚¨å¯ç”¨');
            } catch(e) {
                addResult('åŸºç¡€æ£€æŸ¥', 'LocalStorage', 'error', `æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨: ${e.message}`);
            }

            // æ˜¾ç¤ºç»“æœ
            displayResults();
        }

        function displayResults() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            // æ€»ä½“çŠ¶æ€
            let hasErrors = Object.values(diagnosticResults).some(items => 
                items.some(item => item.status === 'error')
            );
            
            const overallDiv = document.getElementById('overall-status');
            if (hasErrors) {
                overallDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>âŒ å‘ç°é—®é¢˜ï¼</strong><br>
                        LeanCloud åˆå§‹åŒ–å­˜åœ¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸‹é¢çš„è¯¦ç»†ä¿¡æ¯ã€‚
                    </div>
                `;
            } else {
                overallDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ… ä¸€åˆ‡æ­£å¸¸ï¼</strong><br>
                        æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼ŒLeanCloud åŒæ­¥ç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚
                    </div>
                `;
            }

            // è¯¦ç»†æ£€æŸ¥
            const detailedDiv = document.getElementById('detailed-checks');
            let detailedHTML = '';
            for (const [category, items] of Object.entries(diagnosticResults)) {
                detailedHTML += `<h4 style="color: #667eea; margin-top: 15px;">${category}</h4>`;
                items.forEach(item => {
                    detailedHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                            ${getStatusIcon(item.status)} 
                            <strong>${item.item}</strong>: 
                            <span class="status-badge ${getBadgeClass(item.status)}">${item.status}</span>
                            ${item.details ? `<br><small style="color: #666;">${item.details}</small>` : ''}
                        </div>
                    `;
                });
            }
            detailedDiv.innerHTML = detailedHTML;

            // å¯¹è±¡çŠ¶æ€
            const objectDiv = document.getElementById('object-status');
            if (window.leanCloudSync) {
                const status = window.leanCloudSync.getStatus ? 
                    window.leanCloudSync.getStatus() : 
                    {
                        isInitialized: window.leanCloudSync.isInitialized,
                        isEnabled: window.leanCloudSync.isEnabled,
                        lastSync: window.leanCloudSync.lastSync
                    };
                
                objectDiv.innerHTML = `<div class="code">${JSON.stringify(status, null, 2)}</div>`;
            } else {
                objectDiv.innerHTML = `<div class="alert alert-error">window.leanCloudSync å¯¹è±¡ä¸å­˜åœ¨</div>`;
            }

            // é”™è¯¯è¯¦æƒ…
            if (hasErrors) {
                document.getElementById('error-section').style.display = 'block';
                const errorDiv = document.getElementById('error-details');
                let errorHTML = '';
                
                Object.values(diagnosticResults).forEach(items => {
                    items.filter(item => item.status === 'error').forEach(item => {
                        errorHTML += `
                            <div class="alert alert-error">
                                <strong>${item.item}</strong><br>
                                ${item.details}
                            </div>
                        `;
                    });
                });
                
                errorDiv.innerHTML = errorHTML;
            }

            // åŸå§‹æ•°æ®
            const rawData = {
                diagnosticResults,
                navigator: {
                    onLine: navigator.onLine,
                    userAgent: navigator.userAgent
                },
                AV: typeof AV !== 'undefined' ? {
                    version: AV.version,
                    applicationId: AV.applicationId
                } : undefined,
                leancloudConfig: window.leancloudConfig,
                leanCloudSync: window.leanCloudSync ? {
                    isInitialized: window.leanCloudSync.isInitialized,
                    isEnabled: window.leanCloudSync.isEnabled,
                    initError: window.leanCloudSync.initError,
                    sharedUserId: window.leanCloudSync.sharedUserId
                } : undefined
            };
            
            document.getElementById('raw-data').textContent = JSON.stringify(rawData, null, 2);
        }

        function copyResults() {
            const rawData = document.getElementById('raw-data').textContent;
            navigator.clipboard.writeText(rawData).then(() => {
                alert('âœ… ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\næ‚¨å¯ä»¥å°†è¿™äº›ä¿¡æ¯å‘é€ç»™å¼€å‘è€…ä»¥è·å–å¸®åŠ©ã€‚');
            }).catch(err => {
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ–‡æœ¬');
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', () => {
            setTimeout(runDiagnostics, 500);
        });
    </script>
</body>
</html>

