<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§»åŠ¨ç«¯Firebaseè°ƒè¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            font-size: 20px;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            text-align: center;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .debug-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .log-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 12px;
            word-break: break-all;
            border-left: 3px solid #ccc;
        }

        .log-info {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }

        .log-success {
            background: #e8f5e9;
            border-left-color: #4CAF50;
        }

        .log-error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .log-warn {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .status-item {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 12px;
        }

        .status-item strong {
            display: block;
            color: #666;
            margin-bottom: 3px;
        }

        .status-item span {
            color: #333;
            font-weight: 500;
        }

        .test-button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-test {
            background: #2196F3;
            color: white;
        }

        .btn-clear {
            background: #ff9800;
            color: white;
        }

        .btn-test:active {
            transform: scale(0.98);
        }

        #logContainer {
            max-height: 400px;
            overflow-y: auto;
        }

        .timestamp {
            color: #999;
            font-size: 11px;
            margin-right: 5px;
        }

        .progress {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç§»åŠ¨ç«¯Firebaseè°ƒè¯•</h1>
        <p class="subtitle">ä¸“ä¸ºç§»åŠ¨è®¾å¤‡è®¾è®¡çš„è¯Šæ–­å·¥å…·</p>

        <!-- è®¾å¤‡ä¿¡æ¯ -->
        <div class="debug-section">
            <div class="section-title">ğŸ“± è®¾å¤‡ä¿¡æ¯</div>
            <div class="status-grid" id="deviceInfo">
                <div class="status-item">
                    <strong>åŠ è½½ä¸­...</strong>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•è¿›åº¦ -->
        <div class="debug-section" id="progressSection" style="display: none;">
            <div class="section-title">â³ æµ‹è¯•è¿›åº¦</div>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div id="progressText" style="text-align: center; font-size: 12px; color: #666; margin-top: 5px;">
                å‡†å¤‡å¼€å§‹...
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="debug-section">
            <button class="test-button btn-test" onclick="runDiagnostics()">
                ğŸš€ å¼€å§‹Firebaseè¯Šæ–­æµ‹è¯•
            </button>
            <button class="test-button btn-clear" onclick="clearLogs()">
                ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—
            </button>
        </div>

        <!-- å®æ—¶æ—¥å¿— -->
        <div class="debug-section">
            <div class="section-title">ğŸ“‹ å®æ—¶æ—¥å¿—</div>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        // æ—¥å¿—ç³»ç»Ÿ
        const logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const log = { message, type, timestamp };
            logs.push(log);
            
            const container = document.getElementById('logContainer');
            const logDiv = document.createElement('div');
            logDiv.className = `log-item log-${type}`;
            logDiv.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            container.appendChild(logDiv);
            container.scrollTop = container.scrollHeight;
            
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLogs() {
            logs.length = 0;
            document.getElementById('logContainer').innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        function updateProgress(percent, text) {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // æ”¶é›†è®¾å¤‡ä¿¡æ¯
        function collectDeviceInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'å¹³å°': navigator.platform,
                'åœ¨çº¿çŠ¶æ€': navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿',
                'è¯­è¨€': navigator.language,
                'å±å¹•å°ºå¯¸': `${window.screen.width}Ã—${window.screen.height}`,
                'è§†å£å°ºå¯¸': `${window.innerWidth}Ã—${window.innerHeight}`,
                'Cookieå¯ç”¨': navigator.cookieEnabled ? 'âœ… æ˜¯' : 'âŒ å¦',
                'LocalStorage': typeof(Storage) !== 'undefined' ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ',
                'è¿æ¥ç±»å‹': navigator.connection?.effectiveType || 'æœªçŸ¥',
                'æ—¶åŒº': Intl.DateTimeFormat().resolvedOptions().timeZone
            };

            const container = document.getElementById('deviceInfo');
            container.innerHTML = '';
            
            for (const [key, value] of Object.entries(info)) {
                const div = document.createElement('div');
                div.className = 'status-item';
                div.innerHTML = `<strong>${key}:</strong><span>${value}</span>`;
                container.appendChild(div);
            }

            return info;
        }

        // Firebaseè¯Šæ–­æµ‹è¯•
        async function runDiagnostics() {
            addLog('ğŸš€ å¼€å§‹Firebaseè¯Šæ–­æµ‹è¯•...', 'info');
            updateProgress(0, 'å‡†å¤‡å¼€å§‹...');

            try {
                // 1. æ£€æŸ¥ç½‘ç»œ
                updateProgress(10, 'æ£€æŸ¥ç½‘ç»œè¿æ¥...');
                addLog('1ï¸âƒ£ æ£€æŸ¥ç½‘ç»œè¿æ¥...', 'info');
                if (!navigator.onLine) {
                    throw new Error('è®¾å¤‡å¤„äºç¦»çº¿çŠ¶æ€');
                }
                addLog('âœ… ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');

                // 2. æµ‹è¯•Google CDNè¿æ¥
                updateProgress(20, 'æµ‹è¯•Google CDNè¿æ¥...');
                addLog('2ï¸âƒ£ æµ‹è¯•Google CDNè¿æ¥...', 'info');
                const cdnTest = await fetch('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js', {
                    method: 'HEAD',
                    mode: 'no-cors'
                }).catch(e => {
                    addLog('âš ï¸ CDNè¿æ¥æµ‹è¯•å¤±è´¥: ' + e.message, 'warn');
                    return null;
                });
                if (cdnTest) {
                    addLog('âœ… Google CDNå¯è®¿é—®', 'success');
                } else {
                    addLog('âš ï¸ æ— æ³•éªŒè¯CDNè¿æ¥ï¼ˆè¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼‰', 'warn');
                }

                // 3. åŠ è½½Firebase SDK
                updateProgress(30, 'åŠ è½½Firebase App SDK...');
                addLog('3ï¸âƒ£ åŠ è½½Firebase SDK...', 'info');
                
                if (window.firebase) {
                    addLog('âœ… Firebase SDKå·²å­˜åœ¨', 'success');
                } else {
                    addLog('ğŸ“¦ å¼€å§‹åŠ è½½Firebase App...', 'info');
                    await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js');
                    addLog('âœ… Firebase AppåŠ è½½æˆåŠŸ', 'success');

                    updateProgress(50, 'åŠ è½½Firestore SDK...');
                    addLog('ğŸ“¦ å¼€å§‹åŠ è½½Firestore...', 'info');
                    await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js');
                    addLog('âœ… FirestoreåŠ è½½æˆåŠŸ', 'success');

                    updateProgress(70, 'åŠ è½½Auth SDK...');
                    addLog('ğŸ“¦ å¼€å§‹åŠ è½½Auth...', 'info');
                    await loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js');
                    addLog('âœ… AuthåŠ è½½æˆåŠŸ', 'success');
                }

                // 4. åˆå§‹åŒ–Firebase
                updateProgress(80, 'åˆå§‹åŒ–Firebaseåº”ç”¨...');
                addLog('4ï¸âƒ£ åˆå§‹åŒ–Firebaseåº”ç”¨...', 'info');
                
                const firebaseConfig = {
                    apiKey: "AIzaSyCDJRRK83dXaGsUiBtpgN5M0REJtV-3Uc0",
                    authDomain: "plan-web-b0c39.firebaseapp.com",
                    projectId: "plan-web-b0c39",
                    storageBucket: "plan-web-b0c39.firebasestorage.app",
                    messagingSenderId: "1087929904929",
                    appId: "1:1087929904929:web:aa8790a7ee424fce3b1860"
                };

                let app;
                try {
                    app = firebase.app();
                    addLog('âœ… Firebaseåº”ç”¨å·²å­˜åœ¨', 'success');
                } catch (e) {
                    app = firebase.initializeApp(firebaseConfig);
                    addLog('âœ… Firebaseåº”ç”¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                }

                // 5. æµ‹è¯•Firestoreè¿æ¥
                updateProgress(85, 'æµ‹è¯•Firestoreè¿æ¥...');
                addLog('5ï¸âƒ£ æµ‹è¯•Firestoreè¿æ¥...', 'info');
                const db = firebase.firestore();
                addLog('âœ… Firestoreå®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');

                // 6. æµ‹è¯•è®¤è¯
                updateProgress(90, 'æµ‹è¯•åŒ¿åè®¤è¯...');
                addLog('6ï¸âƒ£ æµ‹è¯•åŒ¿åè®¤è¯...', 'info');
                const auth = firebase.auth();
                
                addLog('ğŸ” æ‰§è¡ŒåŒ¿åç™»å½•...', 'info');
                const userCredential = await auth.signInAnonymously();
                addLog('âœ… åŒ¿åç™»å½•æˆåŠŸï¼', 'success');
                addLog(`ğŸ‘¤ ç”¨æˆ·ID: ${userCredential.user.uid.substring(0, 16)}...`, 'info');

                // 7. æµ‹è¯•æ•°æ®åº“å†™å…¥
                updateProgress(95, 'æµ‹è¯•æ•°æ®åº“å†™å…¥...');
                addLog('7ï¸âƒ£ æµ‹è¯•æ•°æ®åº“å†™å…¥...', 'info');
                const testDoc = db.collection('debug_test').doc('mobile_test_' + Date.now());
                await testDoc.set({
                    timestamp: new Date().toISOString(),
                    device: navigator.userAgent.substring(0, 50),
                    test: 'mobile-debug'
                });
                addLog('âœ… æ•°æ®å†™å…¥æˆåŠŸ', 'success');

                // å®Œæˆ
                updateProgress(100, 'âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');
                addLog('ğŸ‰ Firebaseå®Œå…¨æ­£å¸¸å·¥ä½œï¼', 'success');
                addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                addLog('ç»“è®º: Firebaseåœ¨æ‚¨çš„è®¾å¤‡ä¸Šå¯ä»¥æ­£å¸¸ä½¿ç”¨', 'success');

            } catch (error) {
                updateProgress(100, 'âŒ æµ‹è¯•å¤±è´¥');
                addLog('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                addLog('é”™è¯¯è¯¦æƒ…: ' + JSON.stringify(error, null, 2), 'error');
                addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                addLog('ç»“è®º: Firebaseåœ¨æ‚¨çš„è®¾å¤‡ä¸Šæ— æ³•æ­£å¸¸å·¥ä½œ', 'error');
                addLog('å¯èƒ½åŸå› :', 'warn');
                addLog('â€¢ ç½‘ç»œé˜²ç«å¢™æˆ–ä»£ç†æ‹¦æˆª', 'warn');
                addLog('â€¢ ç§»åŠ¨è¿è¥å•†é™åˆ¶è®¿é—®GoogleæœåŠ¡', 'warn');
                addLog('â€¢ æµè§ˆå™¨å®‰å…¨è®¾ç½®é˜»æ­¢', 'warn');
                addLog('â€¢ DNSè§£æé—®é¢˜', 'warn');
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.crossOrigin = 'anonymous';
                
                const timeout = setTimeout(() => {
                    reject(new Error(`è„šæœ¬åŠ è½½è¶…æ—¶: ${src}`));
                }, 30000);
                
                script.onload = () => {
                    clearTimeout(timeout);
                    resolve();
                };
                
                script.onerror = (error) => {
                    clearTimeout(timeout);
                    reject(new Error(`è„šæœ¬åŠ è½½å¤±è´¥: ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ”¶é›†è®¾å¤‡ä¿¡æ¯
        window.addEventListener('DOMContentLoaded', () => {
            addLog('ğŸ“± ç§»åŠ¨ç«¯Firebaseè°ƒè¯•å·¥å…·å·²åŠ è½½', 'info');
            collectDeviceInfo();
            addLog('è®¾å¤‡ä¿¡æ¯æ”¶é›†å®Œæˆ', 'success');
            addLog('ç‚¹å‡»"å¼€å§‹Firebaseè¯Šæ–­æµ‹è¯•"æŒ‰é’®è¿›è¡Œæµ‹è¯•', 'info');
        });
    </script>
</body>
</html>

